<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leadership OS | ActionHub & PulseCheck</title>
    <link rel="icon" type="image/svg+xml" sizes="any"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' fill='%230e1015'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='4' y1='4' x2='20' y2='12'%3E%3Cstop stop-color='%2306b6d4'/%3E%3Cstop offset='1' stop-color='%238b5cf6'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M4 11l7.5 4v7L4 18v-7z' fill='%231e1b4b' fill-opacity='0.4' stroke='%238b5cf6' stroke-width='0.5'/%3E%3Cpath d='M12.5 15l7.5-4v7l-7.5 4v-7z' fill='%231e1b4b' fill-opacity='0.4' stroke='%238b5cf6' stroke-width='0.5'/%3E%3Cpath d='M4 8.5L12 12.5L20 8.5V9.5L12 13.5L4 9.5V8.5z' fill='%234c1d95'/%3E%3Cpath d='M12 4l8 4-8 4-8-4 8-4z' fill='url(%23g)'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase Client
        const SUPABASE_URL = 'https://gesxrlyplcotlubhuvri.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdlc3hybHlwbGNvdGx1Ymh1dnJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MjIyMjQsImV4cCI6MjA4MzI5ODIyNH0.yNzfleskGUDBH4rGjBiR-9fY4VLDFYX-ru6zKQIRGxI';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
    
    <!-- MERGED TAILWIND CONFIGURATION -->
    <script>
        tailwind.config = {
            darkMode: ['class', '.dark-mode'],
            theme: {
                extend: {
                    fontFamily: {
                        sans: [
                            '-apple-system',
                            'BlinkMacSystemFont',
                            'Segoe UI',
                            'Roboto',
                            'Helvetica Neue',
                            'Arial',
                            'sans-serif'
                        ],
                    },
                    colors: {
                        // Tool 1 (ActionHub) Colors
                        hub: {
                            '50': '#f5f3ff',
                            '100': '#ede9fe',
                            '200': '#ddd6fe',
                            '300': '#c4b5fd',
                            '400': '#a78bfa',
                            '500': '#8b5cf6',
                            '600': '#7c3aed',
                            '700': '#6d28d9',
                            '800': '#5b21b6',
                            '900': '#4c1d95',
                            '950': '#2e1065',
                        },
                        // Tool 2 (PulseCheck) Colors
                        dcx: {
                            blue: '#00509D',
                            light: '#0077C8',
                        }
                    }
                }
            }
        }
    </script>

    <!-- ========================================== -->
    <!-- STYLES: Organized by Feature & Component  -->
    <!-- ========================================== -->
    <style>
        /* ==========================================
           BASE STYLES & BACKGROUND
           ========================================== */
        body {
            background-color: #f8fafc;
            /* The Mesh Gradient */
            background-image:
                radial-gradient(at 0% 0%, rgba(124, 58, 237, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(0, 80, 157, 0.08) 0px, transparent 50%);
            background-attachment: fixed;

            /* The Premium Noise Overlay - This is the magic sauce */
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Subtle noise texture */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 50;
            /* sits above background, below content */
        }

        /* ==========================================
           DARK MODE (Linear Style)
           ========================================== */
        body.dark-mode {
            background-color: #0e1015 !important;
            color: #ecedee !important;
            background-image: radial-gradient(at 0% 0%, rgba(124, 58, 237, 0.15) 0px, transparent 50%), radial-gradient(at 100% 0%, rgba(0, 80, 157, 0.15) 0px, transparent 50%) !important;
        }

        body.dark-mode .bg-white {
            background-color: #14161f !important;
            border-color: #2e3138 !important;
            color: #ecedee !important;
        }

        body.dark-mode .bg-slate-50,
        body.dark-mode .bg-slate-100,
        body.dark-mode .bg-gray-50 {
            background-color: #1c1e26 !important;
            border-color: #2e3138 !important;
            color: #ecedee !important;
        }

        body.dark-mode .bg-slate-200 {
            background-color: #2e3138 !important;
            color: #ecedee !important;
        }

        body.dark-mode .text-slate-900,
        body.dark-mode .text-slate-800,
        body.dark-mode .text-slate-700 {
            color: #ecedee !important;
        }

        body.dark-mode .text-slate-600,
        body.dark-mode .text-slate-500,
        body.dark-mode .text-slate-400 {
            color: #8a8f98 !important;
        }

        body.dark-mode .border-slate-100,
        body.dark-mode .border-slate-200,
        body.dark-mode .border-slate-300 {
            border-color: #2e3138 !important;
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: #0e1015 !important;
            border-color: #2e3138 !important;
            color: #ecedee !important;
        }

        body.dark-mode .sidebar-btn-active {
            background-color: #5b21b6 !important;
            color: #ffffff !important;
            box-shadow: 0 0 15px rgba(91, 33, 182, 0.5) !important;
        }

        body.dark-mode .sidebar-btn-inactive:hover {
            background-color: #1c1e26 !important;
            color: #ecedee !important;
        }

        body.dark-mode .modal-container {
            background-color: #14161f !important;
            border-color: #2e3138 !important;
        }

        /* ==========================================
           QUICK LINKS DRAG & DROP STYLES
           ========================================== */
        .quick-link-card {
            transition: all 0.2s ease;
        }

        .quick-link-card[draggable="true"]:hover {
            cursor: move;
        }

        .quick-link-card.opacity-50 {
            opacity: 0.5;
        }

        .quick-link-card:active {
            cursor: grabbing;
        }

        .cursor-context-menu {
            cursor: context-menu;
        }

        /* SHARED UTILS */
        .modal {
            transition: opacity 0.25s ease;
        }

        body.modal-active {
            overflow-x: hidden;
            overflow-y: hidden !important;
        }

        .modal:not(.opacity-0) {
            pointer-events: auto;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .skeleton {
            background-color: #e2e8f0;
            /* This is bg-slate-200 */
            border-radius: 0.25rem;
            /* This is rounded */
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            /* This is animate-pulse */
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        /* ==========================================
           ACTIONHUB STYLES (Tool 1)
           Scoped to #app-container-1 where necessary
           ========================================== */
        #app-container-1 .tab-active {
            border-bottom: 4px solid #6d28d9;
            color: #6d28d9;
            font-weight: 700;
        }

        #app-container-1 .tab-inactive {
            border-bottom: 4px solid transparent;
            color: #64748b;
            font-weight: 500;
        }

        #app-container-1 .tab-inactive:hover {
            color: #6d28d9;
            border-bottom: 4px solid #e2e8f0;
        }

        .eval-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }

        .eval-step-label {
            color: rgb(51 65 85);
        }

        .eval-step-label-checked {
            text-decoration-line: line-through;
            color: rgb(148 163 184);
        }

        .kanban-column {
            min-height: 400px;
            height: calc(100vh - 250px);
        }

        .sidebar-btn {
            width: 100%;
            text-align: left;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            padding-top: 0.625rem;
            padding-bottom: 0.625rem;
            border-radius: 0.5rem;
            font-weight: 500;
            color: rgb(51 65 85);
            transition-property: background-color, color;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .sidebar-btn-active {
            background-color: #6d28d9;
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .sidebar-btn-inactive:hover {
            background-color: #ede9fe;
        }

        .filter-select {
            flex: 1 1 0%;
            background-color: #ffffff;
            border-width: 1px;
            border-color: rgb(203 213 225);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: rgb(51 65 85);
            padding: 0.5rem;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .filter-select:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: #6d28d9;
            border-color: #6d28d9;
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }

        .vault-input {
            width: 100%;
            background-color: #ffffff;
            border: 1px solid rgb(203 213 225);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            color: rgb(51 65 85);
            font-weight: 500;
        }

        .vault-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: #6d28d9;
            border-color: #6d28d9;
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }

        .vault-input[multiple] {
            padding: 0.5rem;
        }

        .vault-input[multiple] option {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
        }

        .vault-input[multiple] option:checked {
            background-color: #6d28d9;
            color: white;
        }

        .desk-column {
            min-height: 400px;
            height: calc(100vh - 220px);
        }

        /* My Desk layout refinements */
        .desk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            align-items: start;
        }

        .desk-board {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.06);
            backdrop-filter: blur(6px);
        }

        .desk-board.at-hand {
            background: rgba(255, 241, 242, 0.9);
        }

        /* Rich Text Editor Styles */
        #myDeskNotesEditor {
            outline: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            color: #374151;
        }

        #myDeskNotesEditor:empty::before {
            content: attr(data-placeholder);
            color: #9ca3af;
            font-style: italic;
            pointer-events: none;
        }

        #myDeskNotesEditor.empty-editor::before {
            content: attr(placeholder);
            color: #9ca3af;
            font-style: italic;
            pointer-events: none;
        }

        #myDeskNotesEditor b,
        #myDeskNotesEditor strong {
            font-weight: 600;
            color: #1f2937;
        }

        #myDeskNotesEditor ul {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
            list-style-type: disc !important;
        }

        .action-btn-secondary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem;
            border-radius: 0.5rem;
            color: #94a3b8;
            transition: all 0.2s;
        }

        .action-btn-secondary:hover {
            background-color: #f1f5f9;
            color: #475569;
        }

        #myDeskNotesEditor ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
            list-style-type: decimal !important;
        }

        #myDeskNotesEditor li {
            margin: 0.25rem 0;
        }

        /* Note content display styles */
        .note-content b,
        .note-content strong {
            font-weight: 600;
            color: #1f2937;
        }

        .note-content ul {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
            list-style-type: disc !important;
        }

        .note-content ol {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
            list-style-type: decimal !important;
        }

        .note-content li {
            margin: 0.25rem 0;
        }

        /* Custom Range Slider */
        .custom-range-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            /* Fixed track height */
            border-radius: 9999px;
            background: transparent;
            /* Will be overridden by inline style for gradient */
            cursor: pointer;
            outline: none;
            margin: 0;
            padding: 0;
        }

        .custom-range-slider:focus {
            outline: none;
        }

        .custom-range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #4f46e5;
            /* indigo-600 */
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: -5px;
            /* (6px track - 16px thumb) / 2 = -5px */
            position: relative;
            z-index: 30;
            transition: transform 0.1s ease;
        }

        .custom-range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .custom-range-slider::-moz-range-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid #4f46e5;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 30;
            transition: transform 0.1s ease;
        }

        .custom-range-slider::-moz-range-thumb:hover {
            transform: scale(1.1);
        }

        .custom-range-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: transparent;
            /* Important so input background shows */
            border-radius: 9999px;
        }

        .custom-range-slider::-moz-range-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: transparent;
            border-radius: 9999px;
        }

        /* ==========================================
           PROJECTS MODULE - LINEAR/CRAFT UI STYLES
           ========================================== */

        /* Glass Panel Utility */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        body.dark-mode .glass-panel {
            background: rgba(15, 17, 23, 0.88);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Linear Gradient Text */
        .linear-gradient-text {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Status Pills - Linear Dot Style */
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            transition: all 0.2s ease-out;
            background: rgba(100, 116, 139, 0.1);
            color: #64748b;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .status-pill::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            flex-shrink: 0;
        }

        .status-pill.status-todo {
            color: #64748b;
            background: rgba(100, 116, 139, 0.08);
        }

        .status-pill.status-doing {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .status-pill.status-blocked {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .status-pill.status-done {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        body.dark-mode .status-pill.status-todo {
            color: #94a3b8;
            background: rgba(148, 163, 184, 0.1);
        }

        body.dark-mode .status-pill.status-doing {
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.15);
        }

        body.dark-mode .status-pill.status-blocked {
            color: #f87171;
            background: rgba(248, 113, 113, 0.15);
        }

        body.dark-mode .status-pill.status-done {
            color: #34d399;
            background: rgba(52, 211, 153, 0.15);
        }

        .status-pill:hover {
            transform: scale(1.02);
            border-color: currentColor;
        }

        .status-pill:active {
            transform: scale(0.95);
        }

        /* Button Micro-Interactions */
        .btn-squish {
            transition: all 0.2s ease-out;
        }

        .btn-squish:hover {
            transform: translateY(-1px);
        }

        .btn-squish:active {
            transform: scale(0.95);
        }

        /* Primary CTA Glow Effect */
        .btn-primary-glow {
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.25), 0 2px 6px rgba(99, 102, 241, 0.2);
            transition: all 0.2s ease-out;
        }

        .btn-primary-glow:hover {
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.35), 0 4px 10px rgba(99, 102, 241, 0.25);
            transform: translateY(-2px);
        }

        .btn-primary-glow:active {
            transform: scale(0.97);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
        }

        /* Project Card - Linear Style */
        .project-card-linear {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transition: all 0.2s ease-out;
            cursor: pointer;
        }

        .project-card-linear:hover {
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateY(-2px);
        }

        .project-card-linear:active {
            transform: scale(0.99);
        }

        body.dark-mode .project-card-linear {
            background: rgba(30, 32, 40, 0.8);
            border-color: rgba(255, 255, 255, 0.08);
        }

        body.dark-mode .project-card-linear:hover {
            border-color: rgba(129, 140, 248, 0.5);
        }

        /* Project Card Gradient Icon */
        .project-icon-gradient {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .project-icon-gradient.theme-indigo {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        .project-icon-gradient.theme-emerald {
            background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);
        }

        .project-icon-gradient.theme-amber {
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
        }

        .project-icon-gradient.theme-rose {
            background: linear-gradient(135deg, #f43f5e 0%, #ec4899 100%);
        }

        .project-icon-gradient.theme-slate {
            background: linear-gradient(135deg, #475569 0%, #1e293b 100%);
        }

        /* Ultra-Thin Progress Bar */
        .progress-bar-thin {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .progress-bar-thin {
            background: rgba(255, 255, 255, 0.05);
        }

        .progress-bar-thin .fill {
            height: 100%;
            border-radius: 0 2px 2px 0;
            transition: width 0.3s ease-out;
        }

        .progress-bar-thin .fill.indigo {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }

        .progress-bar-thin .fill.emerald {
            background: linear-gradient(90deg, #10b981, #14b8a6);
        }

        .progress-bar-thin .fill.amber {
            background: linear-gradient(90deg, #f59e0b, #ea580c);
        }

        .progress-bar-thin .fill.rose {
            background: linear-gradient(90deg, #f43f5e, #ec4899);
        }

        .progress-bar-thin .fill.slate {
            background: linear-gradient(90deg, #475569, #64748b);
        }

        .progress-bar-thin .fill.green {
            background: linear-gradient(90deg, #22c55e, #10b981);
        }

        .progress-bar-thin .fill.default {
            background: #6366f1;
        }

        /* Circular Progress Ring */
        .circular-progress {
            position: relative;
            width: 56px;
            height: 56px;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .circular-progress .progress-bg {
            stroke: rgba(100, 116, 139, 0.15);
        }

        .circular-progress .progress-fill {
            stroke: #6366f1;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease-out;
        }

        .circular-progress .progress-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #334155;
        }

        body.dark-mode .circular-progress .progress-text {
            color: #e2e8f0;
        }

        /* Task Row - Data Grid Style */
        .task-row {
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            transition: background-color 0.15s ease;
        }

        .task-row:last-child {
            border-bottom: none;
        }

        .task-row:hover {
            background: rgba(99, 102, 241, 0.03);
        }

        body.dark-mode .task-row {
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .task-row:hover {
            background: rgba(99, 102, 241, 0.08);
        }

        .task-row.expanded .task-details {
            display: block;
        }

        .task-details {
            display: none;
        }

        /* Modal Progress Track */
        .modal-progress-track {
            flex: 1;
            height: 4px;
            background: rgba(0, 0, 0, 0.06);
            border-radius: 999px;
            overflow: hidden;
        }

        body.dark-mode .modal-progress-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            border-radius: 999px;
            transition: width 0.3s ease-out;
        }

        /* Theme Picker Buttons */
        .theme-btn {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s ease;
        }

        .theme-btn:hover {
            transform: scale(1.1);
        }

        .theme-btn.selected {
            box-shadow: 0 0 0 2px white, 0 0 0 4px #6366f1;
        }

        /* Icon Picker Buttons */
        .icon-btn {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s ease;
        }

        .icon-btn:hover {
            transform: scale(1.05);
        }

        .icon-btn.selected {
            background: #6366f1 !important;
            color: white !important;
            border-color: #4f46e5;
        }

        body.dark-mode .icon-btn.selected {
            background: #6366f1 !important;
            color: white !important;
            border-color: #818cf8;
        }

        /* Command Palette Modal Style */
        .cmd-palette-modal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        body.dark-mode .cmd-palette-modal {
            background: rgba(20, 22, 28, 0.95);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Estimate block */

        .estimate-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 14px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        .estimate-chip {
            background: #ffffff;
            color: #0f172a;
            padding: 8px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
            transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease, background 120ms ease;
        }

        .estimate-chip:hover {
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
        }

        .estimate-chip:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        .estimate-chip-active {
            background: linear-gradient(135deg, #111827, #0f172a);
            color: #fff;
            border-color: #0f172a;
            box-shadow: 0 14px 30px rgba(17, 24, 39, 0.25);
        }

        .estimate-custom {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 8px 12px;
            cursor: text;
            min-width: 60px;
        }

        .estimate-custom input {
            width: 24px;
            background: transparent;
            border: none;
            outline: none;
            padding: 0;
            font-size: 12px;
            font-weight: 600;
            color: inherit;
            text-align: center;
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .estimate-custom input::-webkit-outer-spin-button,
        .estimate-custom input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .estimate-custom input::placeholder {
            color: #94a3b8;
        }

        .estimate-custom:focus-within {
            border-color: #cbd5e1;
            box-shadow: 0 0 0 2px rgba(226, 232, 240, 0.5);
        }

        .estimate-chip-active.estimate-custom input {
            color: #fff;
        }

        .estimate-chip-active.estimate-custom input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .estimate-chip-active.estimate-custom span {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Voice Quick Capture Styles */
        .qc-mic-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .qc-mic-btn:hover {
            background: #e2e8f0;
            color: #475569;
            transform: scale(1.05);
        }

        .qc-mic-btn.recording {
            background: #ef4444;
            color: #fff;
            border-color: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
            animation: mic-pulse 1.5s infinite;
        }

        @keyframes mic-pulse {
            0% {
                box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0px rgba(239, 68, 68, 0);
            }
        }

        .waveform-container {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 32px;
            padding: 0 12px;
            background: rgba(241, 245, 249, 0.8);
            border-radius: 999px;
            border: 1px solid #e2e8f0;
        }

        .waveform-container.active {
            display: flex;
        }

        .waveform-bar {
            width: 3px;
            height: 8px;
            background: #6366f1;
            border-radius: 999px;
            animation: waveform-bounce 1s ease-in-out infinite;
        }

        @keyframes waveform-bounce {

            0%,
            100% {
                height: 8px;
            }

            50% {
                height: 24px;
            }
        }

        /* Staggered animation for bars */
        .waveform-bar:nth-child(2) {
            animation-delay: 0.1s;
        }

        .waveform-bar:nth-child(3) {
            animation-delay: 0.2s;
        }

        .waveform-bar:nth-child(4) {
            animation-delay: 0.3s;
        }

        .waveform-bar:nth-child(5) {
            animation-delay: 0.4s;
        }

        .waveform-bar:nth-child(6) {
            animation-delay: 0.5s;
        }


        /* Focus pill - Premium Linear/macOS Style (High Contrast) */
        .focus-pill {
            position: fixed;
            top: 35vh;
            right: 24px;
            z-index: 9999;
            width: auto;
            min-width: 260px;
            max-width: 320px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            /* Dark background for Light Mode */
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f8fafc;
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            border-radius: 9999px;
            cursor: grab;
            user-select: none;
            transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1), box-shadow 0.2s ease;
            touch-action: none;
            display: flex;
            align-items: center;
            padding: 6px;
            gap: 12px;
            font-family: 'Inter', sans-serif;
        }

        .focus-pill:active {
            cursor: grabbing;
            transform: scale(0.98);
        }

        .focus-pill:hover {
            box-shadow:
                0 10px 30px -5px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        /* Dark Mode: Light Pill (Inverse) */
        body.dark-mode .focus-pill {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            color: #0f172a;
        }

        /* Remove the old .focus-pill.dark selector rules if they exist */

        /* Status Indicator Ring */
        .focus-status-ring {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: conic-gradient(#7c3aed var(--progress, 100%), #475569 0);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-shrink: 0;
        }

        .focus-status-ring::before {
            content: '';
            position: absolute;
            inset: 3px;
            /* Match pill bg (Dark) */
            background: #1e293b;
            border-radius: 50%;
            z-index: 1;
        }

        body.dark-mode .focus-status-ring {
            background: conic-gradient(#7c3aed var(--progress, 100%), #e2e8f0 0);
        }

        body.dark-mode .focus-status-ring::before {
            background: #f8fafc;
        }

        /* --- SIDEBAR FOCUS MODE (Clean & Minimal) --- */
        body.widget-mode {
            background-color: #0f172a !important;
            overflow-x: hidden;
        }

        /* 1. HIDE GLOBAL NAVIGATION & TOOLBARS */
        body.widget-mode aside,
        body.widget-mode .sidebar,
        body.widget-mode .sticky-tabs-container,
        body.widget-mode #sub-header-banner,
        body.widget-mode [class*="bg-hub-"],
        body.widget-mode #app-container-1>div:first-child,
        body.widget-mode #app-container-2>div:first-child {
            display: none !important;
        }

        /* 2. HIDE HEADER CLUTTER (But keep the Timer) */
        body.widget-mode header,
        body.widget-mode .header-bg,
        body.widget-mode .header-content h1,
        body.widget-mode .header-content p,
        body.widget-mode .header-extras {
            display: none !important;
        }

        /* Force the Focus Pill to stay visible and pin to top right */
        body.widget-mode #focusPillContainer,
        body.widget-mode .focus-pill-container {
            display: flex !important;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 99999;
        }

        /* 3. HIDE SPECIFIC BUTTONS & SECTIONS */
        body.widget-mode .desk-toolbar,
        body.widget-mode .desk-controls,
        body.widget-mode .desk-board-green,
        body.widget-mode #completed-board,
        body.widget-mode .desk-stats {
            display: none !important;
        }

        /* 4. ISOLATE "AT HAND" COLUMN */
        body.widget-mode #my-desk-grid,
        body.widget-mode .desk-grid {
            display: flex !important;
            flex-direction: column !important;
            margin-top: 60px;
            padding: 10px !important;
        }

        /* Hide Column 2, Column 3, and any subsequent columns */
        body.widget-mode .desk-board:not(:first-child),
        body.widget-mode .desk-column:not(:first-child) {
            display: none !important;
        }

        /* Expand Column 1 (At Hand) */
        body.widget-mode .desk-board:first-child,
        body.widget-mode .desk-column:first-child {
            width: 100% !important;
            min-width: 0 !important;
            background: transparent !important;
            border: none !important;
        }

        /* Hide the "Add Task" button and footer inside the widget mode */
        body.widget-mode .add-task-btn,
        body.widget-mode .column-footer,
        body.widget-mode .desk-pill,
        body.widget-mode h2.text-2xl {
            display: none !important;
        }

        /* 5. HIGH CONTRAST PULSE (Dark Mode Ready) */
        @keyframes nagPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(167, 139, 250, 0.8);
            }

            /* Bright Violet */
            70% {
                box-shadow: 0 0 0 15px rgba(167, 139, 250, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(167, 139, 250, 0);
            }
        }

        .focus-active-pulse {
            animation: nagPulse 2s infinite;
            border-color: #a78bfa !important;
        }

        body.dark-mode .focus-status-ring::before {
            background: #f8fafc;
        }

        .focus-icon {
            position: relative;
            z-index: 2;
            color: #a78bfa;
            /* Lighter purple for dark bg */
            width: 16px;
            height: 16px;
        }

        body.dark-mode .focus-icon {
            color: #7c3aed;
            /* Standard purple for light bg */
        }

        /* Content Area */
        .focus-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            margin-right: 4px;
        }

        .focus-task-title {
            font-size: 13px;
            font-weight: 600;
            color: #f1f5f9;
            /* Light text */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        body.dark-mode .focus-task-title {
            color: #0f172a;
            /* Dark text */
        }

        .focus-timer {
            font-size: 11px;
            font-weight: 500;
            color: #94a3b8;
            /* Muted light text */
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.02em;
        }

        body.dark-mode .focus-timer {
            color: #64748b;
            /* Muted dark text */
        }

        /* Actions (Hover Reveal) */
        .focus-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.2s ease;
            width: 0;
            overflow: hidden;
        }

        .focus-pill:hover .focus-actions {
            opacity: 1;
            transform: translateX(0);
            width: auto;
            padding-right: 6px;
        }

        .focus-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }

        .focus-action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .focus-action-btn.danger:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        body.dark-mode .focus-action-btn {
            color: #64748b;
        }

        body.dark-mode .focus-action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #0f172a;
        }

        body.dark-mode .focus-action-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .desk-board.on-table {
            background: rgba(239, 246, 255, 0.9);
        }

        .desk-board.completed {
            background: rgba(236, 253, 245, 0.9);
        }

        /* Dark mode visibility for boards */
        body.dark-mode .desk-board {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.55);
        }

        body.dark-mode .desk-board.at-hand {
            background: rgba(255, 187, 187, 0.18);
        }

        body.dark-mode .desk-board.on-table {
            background: rgba(166, 199, 255, 0.18);
        }

        body.dark-mode .desk-board.completed {
            background: rgba(183, 243, 210, 0.18);
        }

        body.dark-mode .desk-title {
            color: #e2e8f0;
        }

        body.dark-mode .desk-meta {
            color: #cbd5e1;
        }

        /* Dark mode task card contrast */
        body.dark-mode .desk-card {
            background: rgba(20, 22, 31, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #e8ecf3;
        }

        body.dark-mode .desk-card h3,
        body.dark-mode .desk-card .task-title {
            color: #f8fafc;
        }

        body.dark-mode .desk-card .text-slate-500,
        body.dark-mode .desk-card .text-slate-600 {
            color: #e8ecf3;
        }

        body.dark-mode .desk-card .text-slate-400 {
            color: #cbd5e1;
        }

        .desk-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .desk-title {
            font-weight: 800;
            font-size: 16px;
            letter-spacing: -0.01em;
        }

        .desk-meta {
            color: #475569;
            font-size: 12px;
            font-weight: 600;
            margin-top: 2px;
        }

        .desk-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            line-height: 1;
        }

        .desk-pill.red {
            background: rgba(248, 113, 113, 0.14);
            color: #b91c1c;
        }

        .desk-pill.blue {
            background: rgba(37, 99, 235, 0.12);
            color: #1d4ed8;
        }

        .desk-pill.green {
            background: rgba(16, 185, 129, 0.12);
            color: #15803d;
        }

        .desk-card {
            background: #ffffff;
            border: 1px solid rgba(15, 23, 42, 0.06);
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 8px 22px rgba(15, 23, 42, 0.06);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease, opacity 0.2s ease;
        }

        .desk-card:hover {
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
            transform: translateY(-4px);
        }

        /* Drawer Card Specifics: Slightly greyed out when not hovered */
        .desk-board-drawer .desk-card {
            opacity: 0.7;
        }

        .desk-board-drawer .desk-card:hover {
            opacity: 1;
        }

        .desk-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            border-top: 1px solid rgba(148, 163, 184, 0.35);
            padding-top: 10px;
            margin-top: 10px;
        }

        .desk-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .desk-filter {
            background: #ffffff;
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: 10px;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 13px;
            color: #475569;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.05);
        }

        .desk-filter:focus {
            outline: 2px solid #6c5ce7;
            outline-offset: 2px;
            border-color: #6c5ce7;
        }

        .desk-ghost-btn {
            background: #ffffff;
            border: 1px solid rgba(15, 23, 42, 0.08);
            color: #475569;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 13px;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.05);
            transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
        }

        .desk-ghost-btn:hover {
            background: #eef2ff;
            color: #4338ca;
            border-color: rgba(99, 102, 241, 0.6);
        }

        /* My Desk Note Animation */
        .note-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-top 0.3s ease-out;
        }

        .note-content.open {
            max-height: 500px;
            /* Arbitrary large height */
            opacity: 1;
            margin-top: 0.5rem;
        }

        /* ==========================================
           PULSECHECK STYLES (Tool 2)
           Scoped to #app-container-2 where necessary
           ========================================== */
        #app-container-2 .tab-active {
            border-bottom: 4px solid #00509D;
            color: #00509D;
            font-weight: 700;
        }

        #app-container-2 .tab-inactive {
            border-bottom: 4px solid transparent;
            color: #64748b;
            font-weight: 500;
        }

        #app-container-2 .tab-inactive:hover {
            color: #00509D;
            border-bottom: 4px solid #e2e8f0;
        }

        .sentiment-good {
            background-color: #dcfce7;
            color: #166534;
            border-color: #bbf7d0;
        }

        .sentiment-mid {
            background-color: #fef9c3;
            color: #854d0e;
            border-color: #fde047;
        }

        .sentiment-bad {
            background-color: #fee2e2;
            color: #991b1b;
            border-color: #fca5a5;
        }

        .sentiment-none {
            background-color: #f1f5f9;
            color: #94a3b8;
            border-color: #e2e8f0;
        }

        .ews-green {
            background-color: #22c55e;
            color: white;
        }

        .ews-amber {
            background-color: #f59e0b;
            color: white;
        }

        .ews-red {
            background-color: #ef4444;
            color: white;
        }

        .heatmap-ews-green {
            background-color: #dcfce7;
            color: #166534;
            border-color: #bbf7d0;
        }

        .heatmap-ews-amber {
            background-color: #fef9c3;
            color: #854d0e;
            border-color: #fde047;
        }

        .heatmap-ews-red {
            background-color: #fee2e2;
            color: #991b1b;
            border-color: #fca5a5;
        }

        /* DARK MODE OVERRIDES FOR SENTIMENT & HEATMAP */
        body.dark-mode .sentiment-good,
        body.dark-mode .heatmap-ews-green {
            background-color: rgba(22, 101, 52, 0.3) !important;
            color: #86efac !important;
            border-color: rgba(22, 101, 52, 0.5) !important;
        }

        body.dark-mode .sentiment-mid,
        body.dark-mode .heatmap-ews-amber {
            background-color: rgba(133, 77, 14, 0.3) !important;
            color: #fde047 !important;
            border-color: rgba(133, 77, 14, 0.5) !important;
        }

        body.dark-mode .sentiment-bad,
        body.dark-mode .heatmap-ews-red {
            background-color: rgba(153, 27, 27, 0.3) !important;
            color: #fca5a5 !important;
            border-color: rgba(153, 27, 27, 0.5) !important;
        }

        body.dark-mode .sentiment-none {
            background-color: #1e293b !important;
            color: #64748b !important;
            border-color: #334155 !important;
        }

        .ts-toggle {
            transition: all 0.2s ease-in-out;
        }

        .ts-toggle:hover {
            transform: scale(1.05);
        }

        .ts-checked {
            background-color: #00509D;
            border-color: #00509D;
        }

        .ts-unchecked {
            background-color: white;
            border-color: #cbd5e1;
        }

        .status-btn {
            transition: all 0.15s ease-in-out;
        }

        .status-btn:hover {
            transform: scale(1.05);
        }

        .status-btn:active {
            transform: scale(0.95);
        }

        .team-row {
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .team-row:hover {
            background-color: #f1f5f9;
            transform: translateX(2px);
            border-left-color: #00509D;
        }

        /* Sticky Header Logic for Tool 2 */
        #app-container-2 thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f1f5f9;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* Roll Call Specifics */
        .rc-status-btn {
            transition: all 0.15s;
        }

        .rc-status-btn:active {
            transform: scale(0.95);
        }

        /* Reliability Matrix - Ripple Effect */
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }

        .ripple-effect::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 50%;
            left: 50%;
            pointer-events: none;
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(255, 255, 255, 0.5);
            animation: ripple 0.6s ease-out;
        }

        @keyframes ripple {
            to {
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }

        /* Reliability Matrix - Refined Tile Styles */
        .reliability-tile {
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 6px !important;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3), 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }

        /* Hover effect: Smooth scale without layout shift */
        .reliability-tile:hover:not(.cursor-not-allowed) {
            transform: scale(1.15);
            z-index: 50;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* Specific Sizes for the Grid to fit full month */
        .matrix-cell-size {
            width: 26px !important;
            height: 26px !important;
            margin: 1px;
        }

        /* Gradient states for a "pill" or "tile" look */
        .tile-present {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            border-color: #34d399 !important;
        }

        .tile-late {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%) !important;
            border-color: #fcd34d !important;
        }

        .tile-unplanned {
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%) !important;
            border-color: #fb7185 !important;
        }

        .tile-pto {
            background: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%) !important;
            border-color: #93c5fd !important;
        }

        .tile-empty {
            background: #ffffff !important;
            border-color: #e2e8f0 !important;
        }

        /* Future/Stripe pattern refinement */
        .tile-future {
            background-color: #f8fafc !important;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(226, 232, 240, 0.6) 5px, rgba(226, 232, 240, 0.6) 10px) !important;
            border-color: #e2e8f0 !important;
            opacity: 0.8;
        }

        .dark .tile-empty {
            background: #1e293b !important;
            border-color: #334155 !important;
        }

        .dark .tile-future {
            background-color: #1e293b !important;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(51, 65, 85, 0.4) 5px, rgba(51, 65, 85, 0.4) 10px) !important;
        }

        /* Reliability Matrix - Selected Cell */
        .reliability-cell-selected {
            box-shadow: 0 0 0 3px #3b82f6, 0 0 15px rgba(59, 130, 246, 0.5) !important;
            transform: scale(1.05);
            z-index: 25;
            outline: none !important;
        }

        /* Reliability Matrix - Context Menu */
        #reliabilityContextMenu {
            position: fixed;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 180px;
            padding: 4px 0;
            display: none;
        }

        #reliabilityContextMenu button {
            width: 100%;
            text-align: left;
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #reliabilityContextMenu button:hover {
            background: #f1f5f9;
        }

        #reliabilityContextMenu button:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        #reliabilityContextMenu button:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        /* HEADER TRANSITIONS */
        #sub-header-banner {
            transition: background-color 0.3s ease;
        }

        .header-toggle-btn {
            transition: all 0.3s ease;
        }

        /* Toast Notifications - macOS Style Upgrade */
        #toast-container {
            position: fixed;
            bottom: 2rem;
            /* Moved to bottom */
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column-reverse;
            /* Stack upwards */
            gap: 0.75rem;
            pointer-events: none;
            /* Let clicks pass through container */
        }

        .toast {
            pointer-events: auto;
            /* Re-enable clicks on toasts */
            display: flex;
            align-items: center;
            padding: 0.75rem 1.25rem;
            border-radius: 14px;
            /* More rounded */
            box-shadow:
                0 10px 30px -5px rgba(0, 0, 0, 0.15),
                0 4px 10px -3px rgba(0, 0, 0, 0.1);
            border-width: 1px;
            font-weight: 500;
            font-size: 0.9rem;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            animation: toast-in 0.4s cubic-bezier(0.2, 0.9, 0.3, 1.2), toast-out 0.4s cubic-bezier(0.2, 0.9, 0.3, 1.2) 3s forwards;
            max-width: 90vw;
            width: max-content;
        }

        .toast-success {
            background-color: rgba(220, 252, 231, 0.85);
            /* Semi-transparent */
            color: #14532d;
            border-color: rgba(134, 239, 172, 0.6);
        }

        .toast-error {
            background-color: rgba(254, 226, 226, 0.85);
            color: #7f1d1d;
            border-color: rgba(252, 165, 165, 0.6);
        }

        .toast-info {
            background-color: rgba(224, 242, 254, 0.85);
            color: #0c4a6e;
            border-color: rgba(125, 211, 252, 0.6);
        }

        .toast-reminder {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.95), rgba(99, 102, 241, 0.95));
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 40px rgba(124, 58, 237, 0.4), 0 0 0 4px rgba(124, 58, 237, 0.2);
            animation: toast-in 0.5s ease-out, toast-shake 0.5s ease-in-out 0.5s, toast-pulse 2s ease-in-out 1s infinite;
            font-size: 15px;
            padding: 16px 24px;
        }

        @keyframes toast-shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-8px);
            }

            40% {
                transform: translateX(8px);
            }

            60% {
                transform: translateX(-6px);
            }

            80% {
                transform: translateX(6px);
            }
        }

        @keyframes toast-pulse {

            0%,
            100% {
                box-shadow: 0 10px 40px rgba(124, 58, 237, 0.4), 0 0 0 4px rgba(124, 58, 237, 0.2);
            }

            50% {
                box-shadow: 0 10px 40px rgba(124, 58, 237, 0.6), 0 0 0 8px rgba(124, 58, 237, 0.15);
            }
        }

        /* Dark Mode Toast Overrides */
        body.dark-mode .toast-success {
            background-color: rgba(20, 83, 45, 0.8);
            color: #dcfce7;
            border-color: rgba(34, 197, 94, 0.3);
        }

        body.dark-mode .toast-error {
            background-color: rgba(127, 29, 29, 0.8);
            color: #fee2e2;
            border-color: rgba(248, 113, 113, 0.3);
        }

        body.dark-mode .toast-info {
            background-color: rgba(12, 74, 110, 0.8);
            color: #e0f2fe;
            border-color: rgba(56, 189, 248, 0.3);
        }

        @keyframes toast-in {
            from {
                transform: translateY(100%) scale(0.9);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes toast-out {
            from {
                opacity: 1;
                transform: scale(1);
            }

            to {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }
        }


        /* ==========================================
           UI COMPONENTS & CONTROLS
           ========================================== */
        /* Mac OS Segmented Control - Premium Upgrade */
        .segmented-nav {
            background-color: #e2e8f0;
            /* Slightly darker (slate-200) for better contrast */
            padding: 0.25rem;
            border-radius: 0.5rem;
            display: inline-flex;
            position: relative;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.06);
            /* Deeper inset */
        }

        .tab-pill-active {
            background-color: #ffffff;
            color: #0f172a;
            /* Deepest Slate */
            font-weight: 700;
            /* Bolder */
            /* A sharper, multi-layered shadow for that "pop" */
            box-shadow:
                0 1px 1px rgb(0 0 0 / 0.05),
                0 2px 4px rgb(0 0 0 / 0.1),
                0 0 0 1px rgb(0 0 0 / 0.02);
            /* Subtle border ring */
            border-radius: 0.375rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            /* Smooth snap */
        }

        .tab-pill-inactive {
            color: #64748b;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }

        .tab-pill-inactive:hover {
            color: #334155;
            background-color: rgba(255, 255, 255, 0.4);
            /* Glassy hover effect */
        }

        /* Sticky Tabs Container - Floating Style */
        .sticky-tabs-container {
            position: sticky;
            top: 82px;
            /* Header (80px) + Banner (2px) */
            z-index: 40;
            /* Above content, below modals (z-50) */
            background-color: transparent;
            /* No background - floating effect */
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
            margin-top: -1.5rem;
            margin-left: -1rem;
            margin-right: -1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            transition: box-shadow 0.2s ease;
        }

        /* Responsive adjustments for main container padding */
        @media (min-width: 640px) {
            .sticky-tabs-container {
                margin-left: -1.5rem;
                margin-right: -1.5rem;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .sticky-tabs-container {
                margin-left: -2rem;
                margin-right: -2rem;
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }

        /* Add subtle shadow when scrolled for depth */
        .sticky-tabs-container.scrolled {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* Mac-style Frosted Table Headers */
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: rgba(248, 250, 252, 0.85) !important;
            /* Semi-transparent Slate-50 */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* ==========================================
           PREMIUM UI EFFECTS & POLISH
           ========================================== */
        /* Global Button Polish */
        button {
            /* Smooth spring-like transition */
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.2s ease;
        }

        button:active {
            /* The "Squish" - feels incredibly responsive */
            transform: scale(0.96);
        }

        /* OPTIMIZED PREMIUM SCROLLBAR */
        ::-webkit-scrollbar {
            width: 10px;
            /* Bumped from 8px to 10px for better grab-ability */
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            /* Made slightly darker (0.4) so it's easier to see */
            background: rgba(148, 163, 184, 0.4);
            border-radius: 10px;

            /* This border trick makes the bar LOOK thinner than it actually is.
       The physical click area is 10px, but the visual bar looks like 6px. */
            border: 2px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            /* Darker and distinct on hover */
            background: rgba(100, 116, 139, 0.7);
            border: 2px solid transparent;
            background-clip: content-box;
        }

        /* Hide scrollbar for clean modals but allow scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* THE SPOTLIGHT UPGRADE */
        .spotlight-card {
            position: relative;
            overflow: hidden;
            /* Keeps the light inside the box */
            background-color: white;
            /* Ensure card has a background */
        }

        /* The glow beam */
        .spotlight-card::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Increased circle size from 600px to 800px for better coverage on wide cards */
            background: radial-gradient(800px circle at var(--mouse-x) var(--mouse-y),
                    rgba(0, 80, 157, 0.10),
                    /* Slightly more subtle opacity (0.15 -> 0.10) looks cleaner on lists */
                    transparent 40%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 1;
        }

        /* Show the beam on hover */

        /* STAGGERED ANIMATION */
        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(10px);
                /* Start slightly lower */
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stagger-item {
            opacity: 0;
            /* Hidden by default */
            animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .spotlight-card:hover::after {
            opacity: 1;
        }



        /* Dark Mode Toggle Icons with Premium Glow */
        .icon-sun {
            display: none;
            color: #fde047;
            /* Yellow-300 */
            filter: drop-shadow(0 0 8px rgba(253, 224, 71, 0.5));
            transition: all 0.3s ease;
        }

        .icon-moon {
            display: block;
            color: #e2e8f0;
            /* Slate-200 */
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
            transition: all 0.3s ease;
        }

        body.dark-mode .icon-sun {
            display: block;
        }

        body.dark-mode .icon-moon {
            display: none;
        }

        /* --- UPGRADE: macOS Depth Visuals --- */
        .glass-active-ring {
            /* Multi-layer shadow for optical depth */
            box-shadow:
                inset 0 0 0 1px rgba(255, 255, 255, 0.4),
                /* Inner white rim (glass edge) */
                0 0 0 1px rgba(124, 58, 237, 0.5),
                /* Outer colored border ring */
                0 0 40px rgba(124, 58, 237, 0.15),
                /* Large ambient glow */
                0 10px 20px rgba(0, 0, 0, 0.1);
            /* Depth shadow to lift */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform: translateY(-2px) scale(1.005);
            /* Subtle lift and zoom */
            z-index: 10;
            /* Ensure it sits above siblings */
        }

        /* Dark Mode Overrides for Depth */
        body.dark-mode .glass-active-ring {
            box-shadow:
                inset 0 0 0 1px rgba(255, 255, 255, 0.1),
                /* Fainter inner rim */
                0 0 0 1px rgba(139, 92, 246, 0.6),
                /* Brighter outer ring for contrast */
                0 0 50px rgba(139, 92, 246, 0.2),
                /* Stronger ambient glow */
                0 20px 40px rgba(0, 0, 0, 0.4);
            /* Deeper shadow */
            background-color: rgba(30, 41, 59, 0.9);
            /* Slightly more opaque bg */
        }


        /* --- PROJECT PLANNER UPGRADES --- */

        /* 1. Header Progress Bar */
        .modal-progress-track {
            background-color: rgba(226, 232, 240, 0.5);
            border-radius: 999px;
            height: 6px;
            width: 100%;
            overflow: hidden;
        }

        .modal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            /* Indigo to Purple */
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode .modal-progress-track {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* 2. Task Row Layout */
        .task-row {
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .task-row:hover {
            background-color: #f8fafc;
            /* slate-50 */
        }

        body.dark-mode .task-row:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        /* 3. Status Pills (Linear Style) */
        .status-pill {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            border: 1px solid transparent;
        }

        .status-todo {
            background: #f1f5f9;
            color: #64748b;
            border-color: #e2e8f0;
        }

        /* Slate */
        .status-doing {
            background: #eff6ff;
            color: #2563eb;
            border-color: #dbeafe;
        }

        /* Blue */
        .status-blocked {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fee2e2;
        }

        /* Red */
        .status-done {
            background: #f0fdf4;
            color: #166534;
            border-color: #bbf7d0;
        }

        /* Green */

        /* Dark Mode Pills */
        body.dark-mode .status-todo {
            background: rgba(148, 163, 184, 0.1);
            color: #94a3b8;
            border-color: rgba(148, 163, 184, 0.2);
        }

        body.dark-mode .status-doing {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.2);
        }

        body.dark-mode .status-blocked {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border-color: rgba(239, 68, 68, 0.2);
        }

        body.dark-mode .status-done {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border-color: rgba(34, 197, 94, 0.2);
        }

        /* 4. Expanded Details Area */
        .task-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 0;
            background-color: #f8fafc;
            /* slate-50 */
            border-top: 1px solid transparent;
        }

        body.dark-mode .task-details {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .task-row.expanded .task-details {
            max-height: 500px;
            /* Arbitrary limit for CSS transition */
            opacity: 1;
            border-top-color: #e2e8f0;
            /* slate-200 */
        }

        body.dark-mode .task-row.expanded .task-details {
            border-top-color: #334155;
        }

        /* 5. Metadata Badges (Priority/Date) */
        .meta-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .meta-badge.high {
            color: #dc2626;
            background: #fef2f2;
        }

        .meta-badge.date {
            color: #64748b;
            background: #f1f5f9;
        }

        body.dark-mode .meta-badge.high {
            color: #f87171;
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
        }

        body.dark-mode .meta-badge.date {
            color: #94a3b8;
            background: rgba(148, 163, 184, 0.1);
            border-color: rgba(148, 163, 184, 0.2);
        }


        /* --- PROJECTS MODULE STYLES --- */
        .project-card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s ease;
        }

        .project-card:hover {
            transform: translateY(-2px);
        }

        /* Smooth Progress Bar */
        .prog-bar-container {
            background-color: rgba(226, 232, 240, 0.5);
            /* slate-200 with opacity */
            overflow: hidden;
        }

        body.dark-mode .prog-bar-container {
            background-color: rgba(30, 41, 59, 0.5);
            /* slate-800 */
        }

        .prog-bar-fill {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Task Checkbox Custom Style */
        .proj-check {
            appearance: none;
            background-color: transparent;
            border: 2px solid #cbd5e1;
            /* slate-300 */
            border-radius: 6px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        body.dark-mode .proj-check {
            border-color: #475569;
            /* slate-600 */
        }

        .proj-check:checked {
            background-color: #4f46e5;
            /* indigo-600 */
            border-color: #4f46e5;
        }

        .proj-check:checked::after {
            content: '';
            position: absolute;
            color: white;
            font-size: 12px;
            left: 4px;
            top: 0px;
            font-weight: bold;
        }

        /* --- MISSING STYLES FOR PROJECT UPGRADES --- */

        /* 1. Header Progress Bar */
        .modal-progress-track {
            background-color: rgba(226, 232, 240, 0.5);
            border-radius: 999px;
            height: 6px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .modal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark-mode .modal-progress-track {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* 2. Task Row & Status Pills */
        .task-row {
            transition: background-color 0.2s ease;
        }

        .task-row:hover {
            background-color: #f8fafc;
        }

        body.dark-mode .task-row:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        .status-pill {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            text-transform: uppercase;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            border: 1px solid transparent;
            min-width: 90px;
            /* Ensures clickable area */
            justify-content: center;
        }

        /* Status Colors */
        .status-todo {
            background: #f1f5f9;
            color: #64748b;
            border-color: #e2e8f0;
        }

        .status-doing {
            background: #eff6ff;
            color: #2563eb;
            border-color: #dbeafe;
        }

        .status-blocked {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fee2e2;
        }

        .status-done {
            background: #f0fdf4;
            color: #166534;
            border-color: #bbf7d0;
        }

        /* 3. Task Details (Expandable) */
        .task-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            background-color: #f8fafc;
        }

        .task-row.expanded .task-details {
            max-height: 500px;
            opacity: 1;
            border-top: 1px solid #e2e8f0;
        }

        body.dark-mode .task-details {
            background-color: rgba(0, 0, 0, 0.2);
            border-top-color: #334155;
        }

        /* 4. Project Card Identity (Icons & Gradients) */
        .proj-icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .theme-indigo {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #4338ca;
        }

        .theme-blue {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1d4ed8;
        }

        .theme-slate {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #475569;
        }

        /* 5. Health Badges */
        .health-badge {
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .health-track {
            background: #dcfce7;
            color: #166534;
        }

        .health-risk {
            background: #fef9c3;
            color: #854d0e;
        }

        .health-off {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Login Screen Animations */
        .shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* --- CALENDAR STYLES --- */
        .calendar-event {
            user-select: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 500;
            transition: all 0.15s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translate(-50%, 20px);
            }

            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        /* Brain Dump Panel Styles */
        #brain-dump-panel.open {
            transform: translateX(0);
        }

        /* Hide scrollbar for brain dump textarea container */
        .brain-dump-scroll {
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE/Edge */
        }

        .brain-dump-scroll::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        /* Saved indicator animation */
        #brain-dump-saved-indicator.show {
            opacity: 1;
        }
    </style>
    <style>
        /* Enhanced Status Color System */
        :root {
            /* DCX Brand Colors */
            --dcx-blue: #0077C8;

            /* Status Colors */
            --status-empty: #94a3b8;
            /* Slate gray */
            --status-pending: #f59e0b;
            /* Amber - attention needed */
            --status-complete: #10b981;
            /* Emerald - success */
            --status-excellent: #059669;
            /* Dark emerald */
            --status-needs-work: #dc2626;
            /* Red */

            /* Supporting Colors */
            --status-empty-light: #f1f5f9;
            --status-pending-light: #fef3c7;
            --status-complete-light: #d1fae5;
            --status-excellent-light: #a7f3d0;
            --status-needs-work-light: #fee2e2;
        }

        /* --- MODERN MACOS-STYLE PERFORMANCE CARDS --- */

        /* Clean card base */
        .card-premium {
            background-color: #ffffff;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.03);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            min-height: 320px;
            position: relative;
            overflow: hidden;
        }

        .card-premium:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.06);
            border-color: rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* 3. Typography Upgrades */
        .perf-header {
            letter-spacing: -0.025em;
        }

        .perf-score {
            letter-spacing: -0.05em;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        /* Modern Status Indicators */
        .card-established {
            border-left: 3px solid var(--status-empty);
        }

        .card-rated {
            border-left: 3px solid var(--status-complete);
        }

        .card-rated.outstanding {
            border-left-color: var(--status-excellent);
        }

        .card-rated.improvement {
            border-left-color: var(--status-needs-work);
        }


        /* 5. Metric Builder Cards */
        .metric-card {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
            height: 100%;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .metric-card {
            background: #1e293b;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .metric-card:hover {
            border-color: #bfdbfe;
            background-color: #f8fafc;
            transform: translateY(-2px);
        }

        body.dark-mode .metric-card:hover {
            background-color: #334155;
            border-color: #3b82f6;
        }

        .metric-card.selected {
            border-color: var(--dcx-blue);
            background-color: #eff6ff;
            box-shadow: 0 4px 12px -2px rgba(0, 119, 200, 0.15);
        }

        body.dark-mode .metric-card.selected {
            background-color: #1e293b;
            box-shadow: 0 4px 12px -2px rgba(59, 130, 246, 0.15);
        }

        /* 6. Animations */
        .fade-in-premium {
            animation: premiumFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes premiumFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* 7. Rubrics */
        .rubric-def-box {
            font-size: 0.75rem;
            color: #1e40af;
            background-color: #eff6ff;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 0.75rem;
            border-left: 3px solid #3b82f6;
        }

        /* Modern Inputs */
        .input-premium {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease-in-out;
        }

        .input-premium:focus {
            background-color: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        /* --- FIXED AI MODAL LAYOUT --- */

        /* 1. Ensure the modal body has a fixed height context */
        #aiAssistantModal .modal-container {
            display: flex;
            flex-direction: column;
            height: 85vh;
            /* Force fixed height */
            max-height: 85vh;
            /* Never exceed screen */
            overflow: hidden;
            /* contain all children */
        }

        /* 2. Generic Tab Content Wrapper - Fills remaining space */
        .ai-tab-content {
            flex: 1;
            /* Grow to fill space below header */
            min-height: 0;
            /* Critical for nested scrolling */
            overflow: hidden;
            /* Prevent outer spill */
            display: flex;
            /* Default to flex for structure */
            flex-direction: column;
        }

        /* 3. Hide non-active tabs (Tailwind 'hidden' override protection) */
        .ai-tab-content.hidden {
            display: none !important;
        }

        /* 4. Chat View Container */


        /* 5. Chat Message Scrollable Area */
        #aiChatContent {
            flex: 1;
            /* Take all available space */
            overflow-y: auto;
            /* Scroll internally */
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #f8fafc;
            /* REMOVED min-height: 100% which caused the bug */
        }

        /* 6. Insights & Settings Scrollable Areas */
        #aiTabInsights,
        #aiTabSettings {
            overflow-y: auto;
            flex: 1;
        }

        /* Drag & Drop Visuals */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #f1f5f9;
            /* slate-100 */
            border: 2px dashed #cbd5e1;
            /* slate-300 */
        }

        .sortable-drag {
            cursor: grabbing;
            opacity: 1;
            background: white;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            transform: scale(1.02);
        }

        /* Premium Calendar Z-Index Fix - Above Global Task Date Picker */
        #premiumCalendar {
            z-index: 100001 !important;
            /* Above global-task-date-popover */
        }

        /* --- DATE RANGE PICKER MODE TOGGLE STYLES --- */
        .premium-date-picker-mode-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }

        .dark .premium-date-picker-mode-toggle {
            background: #0f172a;
            border-color: #334155;
        }

        .premium-date-picker-mode-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dark .premium-date-picker-mode-label {
            color: #94a3b8;
        }

        .premium-date-picker-mode-switch {
            display: flex;
            gap: 0.25rem;
            margin-left: auto;
        }

        .premium-date-picker-mode-btn {
            padding: 0.375rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            background: white;
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dark .premium-date-picker-mode-btn {
            background: #1e293b;
            border-color: #334155;
            color: #94a3b8;
        }

        .premium-date-picker-mode-btn:hover {
            border-color: #7c3aed;
            /* hub-600 */
            color: #7c3aed;
            /* hub-600 */
        }

        .premium-date-picker-mode-btn.active {
            background: #7c3aed;
            /* hub-600 */
            border-color: #7c3aed;
            /* hub-600 */
            color: white;
            font-weight: 600;
        }

        .dark .premium-date-picker-mode-btn.active {
            background: #7c3aed;
            /* hub-600 */
            color: white;
        }

        .premium-date-range-display {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: #f1f5f9;
            border-radius: 0.375rem;
            text-align: center;
            min-height: 1.5rem;
        }

        .dark .premium-date-range-display {
            background: #1e293b;
            color: #94a3b8;
        }

        .premium-cal-day.range-start {
            background: #7c3aed;
            /* hub-600 */
            color: white;
            font-weight: 700;
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        .premium-cal-day.range-end {
            background: #7c3aed;
            /* hub-600 */
            color: white;
            font-weight: 700;
            border-top-right-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        .premium-cal-day.in-range {
            background: #ede9fe;
            /* hub-100 */
            color: #7c3aed;
            /* hub-600 */
        }

        .dark .premium-cal-day.in-range {
            background: #4c1d95;
            /* hub-900 */
            color: #c4b5fd;
            /* hub-300 */
        }

        /* ==========================================
           GANTT INTERACTION STYLES
        ========================================== */
        .timeline-bar {
            position: relative;
            cursor: grab;
            touch-action: none;
            /* Prevent scroll on mobile while dragging */
            transition: box-shadow 0.2s;
        }

        .timeline-bar:active,
        .timeline-bar.dragging {
            cursor: grabbing;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 50;
            opacity: 0.9;
        }

        .timeline-handle-left {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: e-resize !important;
            opacity: 0;
            transition: opacity 0.2s;
            border-top-left-radius: 9999px;
            border-bottom-left-radius: 9999px;
            z-index: 30;
            pointer-events: auto;
        }

        .timeline-handle-right {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: w-resize !important;
            opacity: 0;
            transition: opacity 0.2s;
            border-top-right-radius: 9999px;
            border-bottom-right-radius: 9999px;
            z-index: 30;
            pointer-events: auto;
        }

        .timeline-bar:hover .timeline-handle-left,
        .timeline-bar:hover .timeline-handle-right {
            opacity: 1;
            background: rgba(0, 0, 0, 0.1);
        }

        .timeline-bar:hover .timeline-handle-left:hover {
            cursor: e-resize !important;
        }

        .timeline-bar:hover .timeline-handle-right:hover {
            cursor: w-resize !important;
        }

        body.dark-mode .timeline-handle-left,
        body.dark-mode .timeline-handle-right {
            background: rgba(255, 255, 255, 0.15);
        }

        .timeline-bar {
            transition: transform 0.1s ease-out, box-shadow 0.2s ease-out;
        }

        .timeline-bar.dragging {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform-origin: center;
        }

        /* Snooze Feature Styles */
        #taskContextMenu {
            display: none;
            position: fixed;
            z-index: 100001;
        }

        .task-card-container.fade-out {
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.4s ease-out;
            pointer-events: none;
        }

        .returned-badge-glow {
            animation: pulse-yellow 2s infinite;
            border-color: #eab308 !important;
        }

        @keyframes pulse-yellow {
            0% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(234, 179, 8, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(234, 179, 8, 0);
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>

<body class="text-slate-800 flex flex-col min-h-screen">

    <!-- GLOBAL LEADERSHIP OS HEADER -->
    <header class="bg-slate-900/90 backdrop-blur-md border-b border-white/10 text-white shadow-2xl sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20 gap-4">
                <!-- Left Section: Logo, Title, and Subtitle -->
                <div class="flex items-center min-w-0 flex-shrink">
                    <div class="flex-shrink-0">
                        <svg class="h-9 w-9" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="logo-cube-grad" x1="4" y1="4" x2="20" y2="12"
                                    gradientUnits="userSpaceOnUse">
                                    <stop stop-color="#06b6d4" /> <!-- Cyan -->
                                    <stop offset="1" stop-color="#8b5cf6" /> <!-- Purple -->
                                </linearGradient>
                                <filter id="logo-cube-glow" x="-2" y="-2" width="28" height="28"
                                    filterUnits="userSpaceOnUse">
                                    <feGaussianBlur stdDeviation="1.2" result="blur" />
                                    <feComposite in="SourceGraphic" in2="blur" operator="over" />
                                </filter>
                            </defs>
                            <!-- Glass Base (Translucent Purple) -->
                            <g opacity="0.9">
                                <path d="M4 11L11.5 15V22L4 18V11Z" fill="#1e1b4b" fill-opacity="0.3" stroke="#8b5cf6"
                                    stroke-width="0.5" stroke-opacity="0.6" />
                                <path d="M12.5 15L20 11V18L12.5 22V15Z" fill="#1e1b4b" fill-opacity="0.3"
                                    stroke="#8b5cf6" stroke-width="0.5" stroke-opacity="0.6" />
                                <path d="M12 15V22" stroke="#a78bfa" stroke-width="0.5" stroke-opacity="0.3" />
                            </g>
                            <!-- Floating Top Slab (Vibrant Gradient + Glow) -->
                            <g filter="url(#logo-cube-glow)">
                                <path d="M4 8.5L12 12.5L20 8.5V9.5L12 13.5L4 9.5V8.5Z" fill="#4c1d95" />
                                <path d="M12 4L20 8L12 12L4 8L12 4Z" fill="url(#logo-cube-grad)" />
                            </g>
                        </svg>
                    </div>
                    <div class="ml-4 flex flex-col justify-center min-w-0">
                        <span class="text-xl font-bold tracking-tight text-white leading-tight">Leadership OS</span>
                        <p id="sub-header-text"
                            class="text-xs text-slate-400 font-medium tracking-wide transition-opacity duration-300 leading-tight mt-0.5">
                            Operational Command Center</p>
                    </div>
                </div>

                <!-- Center Section: Tool Toggle -->
                <div class="hidden lg:flex items-center flex-shrink-0">
                    <div class="flex items-center bg-slate-800 rounded-full p-1 border border-slate-700">
                        <button id="toggle-hub" onclick="switchTool('ActionHub')"
                            class="header-toggle-btn px-5 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap">
                            ActionHub
                        </button>
                        <button id="toggle-pulse" onclick="switchTool('PulseCheck')"
                            class="header-toggle-btn px-5 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap">
                            PulseCheck
                        </button>
                    </div>
                </div>

                <!-- Right Section: Actions -->
                <div class="flex items-center gap-4 flex-shrink-0">
                    <!-- Clock/Date Section -->
                    <div id="osClock" onclick="rotateTimezone()"
                        class="hidden md:flex items-center font-medium text-sm text-slate-200 bg-slate-800/50 backdrop-blur-sm px-4 py-1.5 rounded-full border border-white/10 shadow-sm select-none transition-all hover:bg-slate-700 cursor-pointer whitespace-nowrap"
                        title="Click to rotate timezone">
                        --:--
                    </div>
                    <div class="w-px h-6 bg-slate-700 hidden md:block"></div>

                    <!-- Icon Actions Group -->
                    <div class="flex items-center gap-3">
                        <button id="btnAIAssistant" onclick="openAIAssistant()"
                            class="text-slate-300 hover:text-white hover:bg-slate-800 p-2 rounded-lg transition-all relative"
                            title="Ask Garshu - Your AI Assistant">
                            <!-- Panda Icon -->
                            <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6">
                                <ellipse cx="120" cy="170" rx="70" ry="65" fill="#1e293b"
                                    transform="rotate(-20 120 170)" />
                                <ellipse cx="392" cy="170" rx="70" ry="65" fill="#1e293b"
                                    transform="rotate(20 392 170)" />
                                <ellipse cx="256" cy="280" rx="210" ry="180" fill="white" />
                                <ellipse cx="170" cy="280" rx="45" ry="60" fill="#1e293b"
                                    transform="rotate(-25 170 280)" />
                                <ellipse cx="342" cy="280" rx="45" ry="60" fill="#1e293b"
                                    transform="rotate(25 342 280)" />
                                <circle cx="185" cy="265" r="12" fill="white" />
                                <circle cx="327" cy="265" r="12" fill="white" />
                                <circle cx="130" cy="340" r="35" fill="#f472b6" opacity="0.8" />
                                <circle cx="382" cy="340" r="35" fill="#f472b6" opacity="0.8" />
                                <path d="M226 315 Q256 305 286 315 Q290 330 256 345 Q222 330 226 315 Z"
                                    fill="#1e293b" />
                                <path d="M256 345 Q230 380 200 355" fill="none" stroke="#1e293b" stroke-width="12"
                                    stroke-linecap="round" />
                                <path d="M256 345 Q280 380 312 355" fill="none" stroke="#1e293b" stroke-width="12"
                                    stroke-linecap="round" />
                            </svg>
                            <span id="aiInsightsBadge"
                                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                        </button>
                        <button onclick="toggleBrainDumpPanel()"
                            class="text-slate-400 hover:text-violet-500 hover:bg-slate-800 p-2 rounded-lg transition-all"
                            title="Brain Dump (Alt + N)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-brain-circuit">
                                <path
                                    d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z" />
                                <path d="M9 13a4.5 4.5 0 0 0 3-4" />
                                <path d="M6.003 5.125A3 3 0 0 0 6.401 6.5" />
                                <path d="M3.477 10.896a4 4 0 0 1 .585-.396" />
                                <path d="M6 18a4 4 0 0 1-1.967-.516" />
                                <path d="M12 13h4" />
                                <path d="M12 18h6a2 2 0 0 1 2 2v1" />
                                <path d="M12 8h8" />
                                <path d="M16 8V5a2 2 0 0 1 2-2" />
                                <circle cx="16" cy="13" r=".5" />
                                <circle cx="18" cy="3" r=".5" />
                                <circle cx="20" cy="21" r=".5" />
                                <circle cx="20" cy="8" r=".5" />
                            </svg>
                        </button>
                        <button onclick="toggleModal('helpModal')"
                            class="text-slate-400 hover:text-white hover:bg-slate-800 p-2 rounded-lg transition-all"
                            title="Help & Guide">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </button>
                        <button id="btnSettings" onclick="toggleModal('settingsModal')"
                            class="text-slate-400 hover:text-white hover:bg-slate-800 p-2 rounded-lg transition-all"
                            title="Settings & Data">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>

                    <!-- User Profile Pill - Rightmost -->
                    <div id="userProfileBadge" class="ml-6 pl-6 border-l border-white/10">
                        <button onclick="toggleModal('settingsModal')"
                            class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800/50 hover:bg-slate-700/70 transition-all cursor-pointer">
                            <!-- User Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-200" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <!-- Profile Name -->
                            <span class="text-sm font-medium text-slate-100" id="userProfileName">Admin</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Brain Dump Panel -->
    <div id="brain-dump-panel"
        class="fixed top-0 right-0 h-[calc(100vh-1rem)] w-[400px] my-2 mr-2 bg-slate-50/90 dark:bg-slate-900/90 backdrop-blur-xl border-l border-t border-b border-white/20 shadow-[-10px_0_30px_rgba(0,0,0,0.2)] rounded-l-3xl z-[9999] transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-white/10 dark:border-slate-700/50">
            <h2 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">BRAIN CACHE</h2>
            <button onclick="toggleBrainDumpPanel()"
                class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 rounded-full hover:bg-slate-200/50 dark:hover:bg-slate-700/50 p-2 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto overflow-x-hidden flex flex-col brain-dump-scroll">
            <textarea id="brain-dump-textarea" oninput="saveBrainDumpContent()"
                class="bg-transparent border-none resize-none focus:ring-0 w-full h-full p-6 text-slate-700 dark:text-slate-300 font-mono text-sm leading-loose outline-none"
                placeholder="Dump your thoughts, meeting notes, or rapid ideas here..."></textarea>
        </div>
        <!-- Footer -->
        <div class="px-6 py-4 border-t border-white/10 dark:border-slate-700/50 flex flex-col gap-3">
            <div class="flex items-center justify-between gap-2">
                <button onclick="clearBrainDump()"
                    class="bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 px-4 py-1.5 rounded-full text-xs font-medium transition-colors">
                    Clear
                </button>
                <div class="flex items-center gap-2">
                    <span id="brain-dump-saved-indicator"
                        class="text-[10px] text-green-500 opacity-0 transition-opacity duration-300 flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                        Saved
                    </span>
                </div>
                <button onclick="convertSelectionToTask()"
                    class="bg-violet-600 hover:bg-violet-700 text-white px-4 py-1.5 rounded-full text-xs font-medium transition-colors">
                    Convert
                </button>
            </div>
            <p id="brain-dump-tip" class="text-[10px] text-slate-400 dark:text-slate-500 text-center">Highlight text to
                convert.</p>
        </div>
    </div>

    <!-- SUB-HEADER BANNER (Dynamic) -->
    <div id="sub-header-banner" class="bg-hub-800 shadow-md transition-colors duration-300 h-2"></div>

    <!-- MAIN CONTENT CONTAINERS -->

    <!-- CONTAINER 1: ActionHub -->
    <div id="app-container-1" class="app-view">
        <!-- ActionHub Toolbar (Replaces Navigation Actions) -->
        <div class="bg-hub-800 py-2 px-4">
        </div>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

            <div class="sticky-tabs-container mb-8 overflow-x-auto pb-1">
                <div class="segmented-nav">
                    <button id="tabMailbox" onclick="switchTab('mailbox')"
                        class="tab-pill-active px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg> Mailbox
                    </button>
                    <button id="tabMyDesk" onclick="switchTab('myDesk')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                            <path d="m9 14 2 2 4-4" />
                        </svg> My Desk
                    </button>
                    <button id="tabProjects" onclick="switchTab('projects')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M10 22V7a1 1 0 0 0-1-1H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5a1 1 0 0 0-1-1H2" />
                            <rect x="14" y="2" width="8" height="8" rx="1" />
                        </svg> Projects
                    </button>
                    <button id="tabPipeline" onclick="switchTab('pipeline')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg> Evaluation Pipeline
                    </button>
                    <button id="tabLogbook" onclick="switchTab('logbook')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg> TM Logbook
                    </button>
                    <button id="tabBroadcast" onclick="switchTab('broadcast')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M11 6a13 13 0 0 0 8.4-2.8A1 1 0 0 1 21 4v12a1 1 0 0 1-1.6.8A13 13 0 0 0 11 14H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z" />
                            <path d="M6 14a12 12 0 0 0 2.4 7.2 2 2 0 0 0 3.2-2.4A8 8 0 0 1 10 14" />
                            <path d="M8 6v8" />
                        </svg>
                        Broadcast Tracker
                    </button>
                    <button id="tabPerformance"
                        onclick="switchTab('performance'); if(typeof renderPerformanceDashboard === 'function') renderPerformanceDashboard();"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2v20M2 12h20" />
                            <path d="M2 12l10-10 10 10-10 10-10-10" />
                        </svg>
                        Performance
                    </button>
                </div>
            </div>

            <!-- MAILBOX VIEW -->
            <div id="mailboxView">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Team Mailbox</h2>
                    <div class="flex items-center bg-white px-3 py-2 rounded-lg shadow-sm border border-slate-200">
                        <span class="text-sm text-slate-500 mr-2 font-medium">Sort by:</span>
                        <select id="mailboxSort" onchange="renderMailbox()"
                            class="bg-transparent font-semibold text-hub-700 focus:outline-none cursor-pointer">
                            <option value="account">Account</option>
                            <option value="name">Name (A-Z)</option>
                            <option value="role">Role</option>
                            <option value="custom">Custom (Drag)</option>
                        </select>
                    </div>
                </div>
                <div id="mailboxGrid" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-5 gap-4"></div>
            </div>

            <!-- MY DESK VIEW -->
            <div id="myDeskView" class="hidden">
                <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                    <div class="flex items-center gap-3">
                        <h2 class="text-2xl font-bold text-slate-800">My Task Desk</h2>
                        <span class="desk-pill blue">Today's focus</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- View Toggle (Board/Calendar) -->
                        <div class="flex items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                            <button id="myDeskViewBoard" onclick="toggleMyDeskView('board')"
                                class="px-3 py-1.5 text-xs font-bold rounded-md bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 shadow-sm transition-all">
                                Board
                            </button>
                            <button id="myDeskViewCalendar" onclick="toggleMyDeskView('calendar')"
                                class="px-3 py-1.5 text-xs font-bold rounded-md text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-all">
                                Calendar
                            </button>
                        </div>
                        <div class="desk-toolbar" id="myDeskBoardToolbar">
                            <select id="completedTaskFilter" onchange="renderMyDesk()" class="desk-filter"
                                aria-label="Filter completed tasks">
                                <option value="week">Completed: This Week</option>
                                <option value="month">Completed: This Month</option>
                                <option value="all">Completed: All Time</option>
                            </select>
                            <button onclick="toggleCompletedSelectionMode()" id="completedSelectBtn"
                                class="desk-ghost-btn flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Select / Archive
                            </button>
                            <button id="viewSnoozedBtn"
                                onclick="toggleModal('snoozedTasksModal'); renderSnoozedTasks();"
                                class="desk-ghost-btn flex items-center gap-2 relative">
                                <span class="text-base"></span>
                                Snoozed
                                <span id="snoozedCountBadge"
                                    class="hidden absolute -top-1 -right-1 bg-violet-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full ring-2 ring-white dark:ring-slate-800">0</span>
                            </button>
                            <button onclick="openMyDeskModal()"
                                class="bg-hub-600 hover:bg-hub-700 text-white px-4 py-2 rounded-lg font-bold flex items-center shadow-md transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Add Task
                            </button>
                        </div>
                    </div>
                </div>
                <div id="myDeskBoardView">
                    <div id="my-desk-grid"
                        class="flex flex-col lg:flex-row lg:overflow-x-auto pb-4 gap-6 custom-scrollbar snap-x px-1">

                        <!-- At Hand (Red) -->
                        <div
                            class="desk-board desk-board-red flex flex-col h-[calc(100vh-14rem)] bg-white dark:bg-slate-800 rounded-2xl border border-red-200/50 dark:border-red-900/30 shadow-sm relative overflow-hidden group w-full lg:w-[32%] lg:min-w-[350px] lg:flex-shrink-0 snap-center">
                            <div
                                class="absolute inset-0 bg-gradient-to-b from-red-50/50 to-transparent dark:from-red-900/10 pointer-events-none">
                            </div>
                            <div
                                class="desk-header p-6 border-b border-red-100 dark:border-slate-700 flex justify-between items-start relative z-10">
                                <div class="flex gap-4 items-center">
                                    <div
                                        class="p-3 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h2 class="text-lg font-bold text-slate-800 dark:text-white leading-tight">At
                                            Hand
                                        </h2>
                                        <div class="text-xs font-medium text-slate-400 uppercase tracking-wider mt-1">
                                            Focus
                                            on 3-5 items</div>
                                    </div>
                                </div>
                                <span
                                    class="px-3 py-1 bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300 text-xs font-bold rounded-full border border-red-200 dark:border-red-800">Urgent</span>
                            </div>
                            <div class="p-4 overflow-y-auto flex-1 space-y-3 custom-scrollbar" id="colAtHand"></div>
                        </div>

                        <!-- On The Table (Blue) -->
                        <div
                            class="desk-board desk-board-blue flex flex-col h-[calc(100vh-14rem)] bg-white dark:bg-slate-800 rounded-2xl border border-blue-200/50 dark:border-blue-900/30 shadow-sm relative overflow-hidden group w-full lg:w-[32%] lg:min-w-[350px] lg:flex-shrink-0 snap-center">
                            <div
                                class="absolute inset-0 bg-gradient-to-b from-blue-50/50 to-transparent dark:from-blue-900/10 pointer-events-none">
                            </div>
                            <div
                                class="desk-header p-6 border-b border-blue-100 dark:border-slate-700 flex justify-between items-start relative z-10">
                                <div class="flex gap-4 items-center">
                                    <div
                                        class="p-3 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h2 class="text-lg font-bold text-slate-800 dark:text-white leading-tight">On
                                            The
                                            Table</h2>
                                        <div class="text-xs font-medium text-slate-400 uppercase tracking-wider mt-1">
                                            Immediate execution</div>
                                    </div>
                                </div>
                                <span
                                    class="px-3 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300 text-xs font-bold rounded-full border border-blue-200 dark:border-blue-800">Active</span>
                            </div>
                            <div class="p-4 overflow-y-auto flex-1 space-y-3 custom-scrollbar" id="colOnTheTable"></div>
                        </div>

                        <!-- In The Drawer (Amber) -->
                        <div
                            class="desk-board desk-board-drawer flex flex-col h-[calc(100vh-14rem)] bg-white dark:bg-slate-800 rounded-2xl border border-amber-200/50 dark:border-amber-900/30 shadow-sm relative overflow-hidden group w-full lg:w-[32%] lg:min-w-[350px] lg:flex-shrink-0 snap-center">
                            <div
                                class="absolute inset-0 bg-gradient-to-b from-amber-50/50 to-transparent dark:from-amber-900/10 pointer-events-none">
                            </div>
                            <div
                                class="desk-header p-6 border-b border-amber-100 dark:border-slate-700 flex justify-between items-start relative z-10">
                                <div class="flex gap-4 items-center">
                                    <div
                                        class="p-3 bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 rounded-xl">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h2 class="text-lg font-bold text-slate-800 dark:text-white leading-tight">In
                                            the
                                            Drawer</h2>
                                        <div class="text-xs font-medium text-slate-400 uppercase tracking-wider mt-1">
                                            Scheduled for Later</div>
                                    </div>
                                </div>
                                <span
                                    class="px-3 py-1 bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300 text-xs font-bold rounded-full border border-amber-200 dark:border-amber-800">Queued</span>
                            </div>
                            <div class="p-4 overflow-y-auto flex-1 space-y-3 custom-scrollbar" id="colInDrawer"></div>
                        </div>

                        <!-- Completed (Green) -->
                        <div
                            class="desk-board desk-board-green flex flex-col h-[calc(100vh-14rem)] bg-white dark:bg-slate-800 rounded-2xl border border-green-200/50 dark:border-green-900/30 shadow-sm relative overflow-hidden group w-full lg:w-[32%] lg:min-w-[350px] lg:flex-shrink-0 snap-center">
                            <div
                                class="absolute inset-0 bg-gradient-to-b from-green-50/50 to-transparent dark:from-green-900/10 pointer-events-none">
                            </div>
                            <div
                                class="desk-header p-6 border-b border-green-100 dark:border-slate-700 flex justify-between items-start relative z-10">
                                <div class="flex gap-4 items-center">
                                    <div
                                        class="p-3 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-xl">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h2 class="text-lg font-bold text-slate-800 dark:text-white leading-tight">
                                            Completed
                                        </h2>
                                        <div class="text-xs font-medium text-slate-400 uppercase tracking-wider mt-1">
                                            Recently completed</div>
                                    </div>
                                </div>
                                <span
                                    class="px-3 py-1 bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300 text-xs font-bold rounded-full border border-green-200 dark:border-green-800"
                                    id="completedCountPill">Up to date</span>
                            </div>
                            <div class="p-4 overflow-y-auto flex-1 space-y-3 custom-scrollbar" id="colCompletedTasks">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Calendar View -->
                <div id="myDeskCalendarView" class="hidden">
                    <div
                        class="flex-1 overflow-hidden flex flex-col bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                        <div id="myDeskCalendarContainer" class="flex-1 overflow-auto custom-scrollbar"></div>
                    </div>
                </div>
            </div>

            <div id="projectsView" class="hidden fade-in">
                <!-- Header Section -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-extrabold tracking-tight flex items-center gap-3">
                            <span
                                class="p-2.5 bg-gradient-to-br from-indigo-500 to-violet-600 text-white rounded-xl shadow-lg shadow-indigo-500/25">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                                </svg>
                            </span>
                            <span class="linear-gradient-text">Projects</span>
                        </h2>
                        <p class="text-slate-500 dark:text-slate-400 text-sm mt-2 ml-1">Manage high-level goals and
                            track progress.</p>
                    </div>

                    <div class="flex items-center gap-3">
                        <!-- View Toggle (Segmented Control) -->
                        <div class="hidden lg:flex items-center bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                            <button id="projectViewGrid" onclick="showGridView()"
                                class="px-3 py-1.5 text-xs font-bold rounded-md bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 shadow-sm transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                </svg>
                            </button>
                            <button id="projectViewList"
                                class="px-3 py-1.5 text-xs font-bold rounded-md text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </button>
                            <button id="projectViewTimeline" onclick="toggleTimelineView()"
                                class="px-3 py-1.5 text-xs font-bold rounded-md text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                            </button>
                        </div>

                        <!-- Area Filter -->
                        <div class="relative">
                            <select id="projectAreaFilter" onchange="renderProjectsView()"
                                class="appearance-none bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 py-2 pl-4 pr-10 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer hover:border-indigo-300 dark:hover:border-indigo-500/50 transition-all">
                                <option value="all">All Areas</option>
                            </select>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>

                        <!-- New Project Button (Primary CTA with Glow) -->
                        <button onclick="openProjectModal()"
                            class="btn-squish btn-primary-glow bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                            New Project
                        </button>
                    </div>
                </div>

                <!-- Projects Grid (4 columns on xl) -->
                <div id="projectsGrid"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 mb-12">
                </div>

                <!-- Timeline View -->
                <div id="projectTimelineView"
                    class="hidden flex-col h-[calc(100vh-200px)] bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden relative mb-12">
                    <div
                        class="flex items-center justify-between px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shrink-0 z-40">
                        <div class="flex items-center gap-4">
                            <div class="flex items-center bg-slate-100 dark:bg-slate-700 rounded-md p-0.5">
                                <button onclick="changeTimelineMonth(-1)"
                                    class="p-1 hover:bg-white dark:hover:bg-slate-600 rounded text-slate-500 transition-shadow"><svg
                                        class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 19l-7-7 7-7" />
                                    </svg></button>
                                <span id="timelineMonthLabel"
                                    class="px-3 text-xs font-bold text-slate-700 dark:text-slate-200 w-32 text-center uppercase tracking-wider">Loading...</span>
                                <button onclick="changeTimelineMonth(1)"
                                    class="p-1 hover:bg-white dark:hover:bg-slate-600 rounded text-slate-500 transition-shadow"><svg
                                        class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7" />
                                    </svg></button>
                            </div>
                            <button onclick="renderTimeline()"
                                class="text-xs text-slate-500 hover:text-violet-600 flex items-center gap-1">Refresh</button>
                        </div>
                        <select id="timelineProjectFilter" onchange="renderTimeline()"
                            class="text-xs border-none bg-transparent font-semibold text-slate-600 dark:text-slate-300 focus:ring-0 cursor-pointer">
                            <option value="all">All Projects</option>
                        </select>
                    </div>
                    <div class="flex-1 overflow-auto relative custom-scrollbar flex flex-col">
                        <div id="timelineHeader"
                            class="sticky top-0 z-30 flex bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 text-xs font-medium text-slate-500">
                        </div>
                        <div id="timelineBody" class="flex-1 bg-white dark:bg-slate-900 relative">
                        </div>
                    </div>
                </div>

                <!-- Archived Projects Section -->
                <details class="group">
                    <summary
                        class="flex items-center gap-2 cursor-pointer text-slate-400 font-bold text-xs uppercase tracking-wider select-none hover:text-indigo-500 transition-colors mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-3.5 w-3.5 transition-transform group-open:rotate-90" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                        Archived Projects
                    </summary>
                    <div id="archivedProjectsGrid"
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 opacity-50 hover:opacity-70 transition-opacity">
                    </div>
                </details>
            </div>

            <div id="projectPlannerModal"
                class="modal opacity-0 pointer-events-none fixed inset-0 z-[70] flex items-center justify-center p-4">
                <div class="modal-overlay absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity"
                    onclick="closeProjectPlanner()"></div>
                <div
                    class="modal-container glass-panel w-full max-w-5xl max-h-[90vh] mx-auto rounded-2xl shadow-2xl z-50 flex flex-col overflow-hidden">

                    <!-- Navbar-Style Header with Breadcrumb -->
                    <div
                        class="px-6 py-4 border-b border-slate-200/50 dark:border-white/5 flex items-center justify-between bg-white/50 dark:bg-slate-900/50">
                        <!-- Left: Breadcrumb -->
                        <div class="flex items-center gap-2">
                            <span id="plannerAreaBadge"
                                class="text-xs font-semibold text-slate-500 dark:text-slate-400">Area</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-slate-300 dark:text-slate-600"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                            <input type="text" id="plannerTitle" onblur="savePlannerTitle()"
                                class="text-lg font-bold text-slate-800 dark:text-white bg-transparent border-none p-0 focus:ring-0 placeholder-slate-300 dark:placeholder-slate-600 min-w-[200px]"
                                placeholder="Project Title">
                        </div>

                        <!-- Right: Actions -->
                        <div class="flex items-center gap-2">
                            <div id="plannerStatusBadge" class="mr-2"></div>
                            <button onclick="toggleProjectStatus()" id="plannerToggleStatusBtn"
                                class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-400 dark:text-slate-500 transition-colors text-xs font-semibold"
                                title="Archive/Restore">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                </svg>
                            </button>
                            <button onclick="closeProjectPlanner()"
                                class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg text-slate-400 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Health Header with Circular Progress -->
                    <div
                        class="px-6 py-4 bg-slate-50/80 dark:bg-slate-800/30 border-b border-slate-200/50 dark:border-white/5">
                        <div class="flex items-center gap-6">
                            <!-- Circular Progress Ring -->
                            <div class="circular-progress" id="plannerCircularProgress">
                                <svg width="56" height="56" viewBox="0 0 56 56">
                                    <circle class="progress-bg" cx="28" cy="28" r="24" fill="none" stroke-width="4">
                                    </circle>
                                    <circle id="plannerProgressRing" class="progress-fill" cx="28" cy="28" r="24"
                                        fill="none" stroke-width="4" stroke-dasharray="150.8" stroke-dashoffset="150.8">
                                    </circle>
                                </svg>
                                <span id="plannerProgressText" class="progress-text">0%</span>
                            </div>

                            <!-- Stats -->
                            <div class="flex-1">
                                <div class="flex items-center gap-4 text-sm">
                                    <span id="plannerTaskStats" class="font-medium text-slate-600 dark:text-slate-300">0
                                        of 0 tasks</span>
                                    <span id="plannerDueDate" class="text-slate-400 dark:text-slate-500 hidden"></span>
                                </div>
                                <!-- Thin progress bar backup -->
                                <div class="modal-progress-track mt-2 hidden">
                                    <div id="plannerProgressBar" class="modal-progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Area -->
                    <div class="flex-1 overflow-y-auto p-6 bg-white/50 dark:bg-slate-900/30">
                        <!-- Appearance Section (Icon & Theme) -->
                        <div class="mb-6">
                            <button onclick="togglePlannerAppearance()"
                                class="flex items-center gap-2 text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-3 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 transition-transform"
                                    id="appearanceChevron" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7" />
                                </svg>
                                Appearance
                            </button>
                            <div id="plannerAppearanceSection"
                                class="hidden bg-slate-50/50 dark:bg-slate-800/20 rounded-xl p-4 border border-slate-200/50 dark:border-slate-700/30">
                                <div class="grid grid-cols-2 gap-6">
                                    <!-- Icon Picker -->
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Icon</label>
                                        <div class="flex flex-wrap gap-2" id="plannerIconPickerContainer">
                                            <button type="button" data-icon="clipboard"
                                                onclick="updatePlannerIcon('clipboard')"
                                                class="icon-btn w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                                title="Clipboard">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                                                </svg>
                                            </button>
                                            <button type="button" data-icon="folder"
                                                onclick="updatePlannerIcon('folder')"
                                                class="icon-btn w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                                title="Folder">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                                </svg>
                                            </button>
                                            <button type="button" data-icon="code" onclick="updatePlannerIcon('code')"
                                                class="icon-btn w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                                title="Code">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                                </svg>
                                            </button>
                                            <button type="button" data-icon="star" onclick="updatePlannerIcon('star')"
                                                class="icon-btn w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                                title="Star">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                                </svg>
                                            </button>
                                            <button type="button" data-icon="rocket"
                                                onclick="updatePlannerIcon('rocket')"
                                                class="icon-btn w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                                title="Rocket">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                                                </svg>
                                            </button>
                                            <button type="button" data-icon="briefcase"
                                                onclick="updatePlannerIcon('briefcase')"
                                                class="icon-btn w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                                title="Briefcase">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                                </svg>
                                            </button>
                                            <button type="button" data-icon="lightning"
                                                onclick="updatePlannerIcon('lightning')"
                                                class="icon-btn w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                                title="Lightning">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                                                </svg>
                                            </button>
                                            <button type="button" data-icon="heart" onclick="updatePlannerIcon('heart')"
                                                class="icon-btn w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                                title="Heart">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Theme Picker -->
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Theme</label>
                                        <div class="flex flex-wrap gap-2" id="plannerThemePickerContainer">
                                            <button type="button" data-theme="indigo"
                                                onclick="updatePlannerTheme('indigo')"
                                                class="theme-btn w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-violet-600 transition-all hover:scale-110"></button>
                                            <button type="button" data-theme="emerald"
                                                onclick="updatePlannerTheme('emerald')"
                                                class="theme-btn w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 transition-all hover:scale-110"></button>
                                            <button type="button" data-theme="amber"
                                                onclick="updatePlannerTheme('amber')"
                                                class="theme-btn w-8 h-8 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 transition-all hover:scale-110"></button>
                                            <button type="button" data-theme="rose" onclick="updatePlannerTheme('rose')"
                                                class="theme-btn w-8 h-8 rounded-lg bg-gradient-to-br from-rose-500 to-pink-600 transition-all hover:scale-110"></button>
                                            <button type="button" data-theme="slate"
                                                onclick="updatePlannerTheme('slate')"
                                                class="theme-btn w-8 h-8 rounded-lg bg-gradient-to-br from-slate-500 to-slate-800 transition-all hover:scale-110"></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="mb-6 px-1 group">
                            <textarea id="plannerNotes" onblur="savePlannerNotes()"
                                placeholder="Add project details, specs, or a brief description..."
                                class="w-full bg-transparent border-none p-0 text-base md:text-lg text-slate-600 dark:text-slate-300 placeholder-slate-400 focus:ring-0 focus:outline-none resize-y min-h-[80px] leading-relaxed transition-all"></textarea>
                            <div
                                class="h-0.5 w-10 bg-slate-200 dark:bg-slate-700 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            </div>
                        </div>

                        <!-- Tasks Section -->
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Tasks</h4>
                            <button onclick="addProjectTask()"
                                class="btn-squish text-xs font-bold text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300 flex items-center gap-1.5 bg-indigo-50 dark:bg-indigo-900/30 px-3 py-1.5 rounded-lg hover:bg-indigo-100 dark:hover:bg-indigo-900/50 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                </svg>
                                Add Task
                            </button>
                        </div>

                        <!-- Task List (Data Grid Style) -->
                        <div id="plannerTaskList"
                            class="bg-white/70 dark:bg-slate-800/30 rounded-xl border border-slate-200/80 dark:border-slate-700/30 overflow-hidden">
                        </div>

                        <!-- QUICK ADD ROW (NEW) -->
                        <div class="mt-2 px-1">
                            <div
                                class="flex items-center gap-3 p-3 rounded-lg border border-transparent hover:border-slate-200 dark:hover:border-slate-700 transition-colors bg-white/40 dark:bg-slate-800/40 backdrop-blur-sm group">
                                <div
                                    class="w-5 h-5 rounded-md border-2 border-slate-300 dark:border-slate-600 bg-transparent">
                                </div>

                                <input type="text" id="quickTaskInput" placeholder="Add a new task..."
                                    class="bg-transparent border-none text-sm font-semibold w-full focus:ring-0 p-0 text-slate-700 dark:text-slate-200 placeholder-slate-400"
                                    onkeydown="handleQuickTaskEnter(event)">

                                <span
                                    class="text-xs text-slate-400 font-medium opacity-0 group-hover:opacity-100 transition-opacity">Press
                                    Enter</span>
                            </div>
                        </div>

                        <!-- Completed Tasks Toggle -->
                        <div class="mt-4">
                            <button onclick="togglePlannerCompleted()"
                                class="text-xs font-semibold text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 flex items-center gap-2 transition-colors">
                                <span id="plannerCompletedCount">Show 0 Completed</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 transition-transform" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div id="plannerCompletedList"
                                class="hidden mt-3 opacity-60 bg-white/50 dark:bg-slate-800/20 rounded-xl border border-slate-200/50 dark:border-slate-700/20 overflow-hidden">
                            </div>
                        </div>
                    </div>

                    <!-- Footer Actions -->
                    <div
                        class="p-4 bg-white/80 dark:bg-slate-900/50 border-t border-slate-200/50 dark:border-white/5 flex justify-between items-center">
                        <button onclick="deleteProject()"
                            class="text-red-500 hover:text-red-600 dark:hover:text-red-400 text-xs font-semibold px-3 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete
                        </button>
                        <button onclick="closeProjectPlanner()"
                            class="btn-squish btn-primary-glow bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white px-6 py-2.5 rounded-xl text-sm font-bold">Done</button>
                    </div>
                </div>
            </div>

            <div id="projectModal"
                class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center p-4">
                <div class="modal-overlay absolute inset-0 bg-slate-900/50 backdrop-blur-md transition-opacity"
                    onclick="toggleModal('projectModal')"></div>
                <div class="cmd-palette-modal w-full max-w-lg mx-auto z-50 overflow-hidden">
                    <!-- Header -->
                    <div class="p-6 text-center border-b border-slate-200/50 dark:border-white/5">
                        <div
                            class="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-500/25">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white">Create New Project</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Start tracking a new goal or
                            initiative</p>
                    </div>

                    <!-- Form -->
                    <div class="p-6 space-y-5">
                        <!-- Project Name -->
                        <div>
                            <input type="text" id="newProjTitle"
                                class="w-full px-4 py-3.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 text-slate-900 dark:text-white text-center text-lg font-semibold focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none placeholder-slate-400 transition-all"
                                placeholder="Project Name">
                        </div>

                        <!-- Area & Due Date -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Area</label>
                                <input type="text" id="newProjArea" list="areaSuggestions"
                                    class="w-full px-4 py-2.5 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-sm focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all"
                                    placeholder="e.g. Work">
                                <datalist id="areaSuggestions">
                                    <option value="Work"></option>
                                    <option value="Personal"></option>
                                    <option value="Team"></option>
                                    <option value="Learning"></option>
                                </datalist>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Due
                                    Date</label>
                                <div class="relative group w-full">
                                    <input type="text" id="newProjDue" readonly
                                        class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                                        onclick="openPremiumCalendar(event, 'newProjDue')">

                                    <div id="projectDateEmpty"
                                        class="flex items-center justify-center w-full py-2.5 px-4 rounded-lg border border-dashed border-slate-300 text-slate-400 bg-slate-50 dark:bg-slate-800 group-hover:bg-white dark:group-hover:bg-slate-700 group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:hidden"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-5 w-5 hidden group-hover:block text-indigo-600" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 11v6m-3-3h6" />
                                            </svg>
                                            <span class="text-sm font-medium group-hover:text-indigo-600">Set Due
                                                Date</span>
                                        </div>
                                    </div>

                                    <div id="projectDateFilled"
                                        class="hidden flex items-center justify-between w-full py-2.5 px-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm">
                                        <div class="flex items-center gap-2 text-slate-700 dark:text-slate-300">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <span id="projectDateText" class="text-sm font-bold"></span>
                                        </div>
                                        <button type="button" onclick="clearProjectDate(event)"
                                            class="relative z-40 text-slate-400 hover:text-red-500 p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><svg
                                                xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                                fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                    clip-rule="evenodd" />
                                            </svg></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Icon & Theme Picker Row -->
                        <div class="grid grid-cols-2 gap-6">
                            <!-- Icon Picker -->
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">Icon</label>
                                <div class="flex flex-wrap gap-2" id="iconPickerContainer">
                                    <button type="button" data-icon="clipboard" onclick="selectProjectIcon('clipboard')"
                                        class="icon-btn selected w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                        title="Clipboard">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                                        </svg>
                                    </button>
                                    <button type="button" data-icon="folder" onclick="selectProjectIcon('folder')"
                                        class="icon-btn w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                        title="Folder">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                        </svg>
                                    </button>
                                    <button type="button" data-icon="code" onclick="selectProjectIcon('code')"
                                        class="icon-btn w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                        title="Code">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                        </svg>
                                    </button>
                                    <button type="button" data-icon="star" onclick="selectProjectIcon('star')"
                                        class="icon-btn w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                        title="Star">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                        </svg>
                                    </button>
                                    <button type="button" data-icon="rocket" onclick="selectProjectIcon('rocket')"
                                        class="icon-btn w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                        title="Rocket">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />
                                        </svg>
                                    </button>
                                    <button type="button" data-icon="briefcase" onclick="selectProjectIcon('briefcase')"
                                        class="icon-btn w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                        title="Briefcase">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                    <button type="button" data-icon="lightning" onclick="selectProjectIcon('lightning')"
                                        class="icon-btn w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                        title="Lightning">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                    </button>
                                    <button type="button" data-icon="heart" onclick="selectProjectIcon('heart')"
                                        class="icon-btn w-9 h-9 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 transition-all"
                                        title="Heart">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                        </svg>
                                    </button>
                                </div>
                                <input type="hidden" id="newProjIcon" value="clipboard">
                            </div>

                            <!-- Theme Picker -->
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-3">Theme</label>
                                <div class="flex flex-wrap gap-2" id="themePickerContainer">
                                    <button type="button" data-theme="indigo" onclick="selectProjectTheme('indigo')"
                                        class="theme-btn selected w-9 h-9 rounded-lg bg-gradient-to-br from-indigo-500 to-violet-600 transition-all hover:scale-110"></button>
                                    <button type="button" data-theme="emerald" onclick="selectProjectTheme('emerald')"
                                        class="theme-btn w-9 h-9 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 transition-all hover:scale-110"></button>
                                    <button type="button" data-theme="amber" onclick="selectProjectTheme('amber')"
                                        class="theme-btn w-9 h-9 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 transition-all hover:scale-110"></button>
                                    <button type="button" data-theme="rose" onclick="selectProjectTheme('rose')"
                                        class="theme-btn w-9 h-9 rounded-lg bg-gradient-to-br from-rose-500 to-pink-600 transition-all hover:scale-110"></button>
                                    <button type="button" data-theme="slate" onclick="selectProjectTheme('slate')"
                                        class="theme-btn w-9 h-9 rounded-lg bg-gradient-to-br from-slate-500 to-slate-800 transition-all hover:scale-110"></button>
                                </div>
                                <input type="hidden" id="newProjTheme" value="indigo">
                            </div>
                        </div>
                    </div>

                    <!-- Footer Actions -->
                    <div
                        class="p-4 bg-slate-50/80 dark:bg-slate-800/30 border-t border-slate-200/50 dark:border-white/5 flex justify-between items-center">
                        <button onclick="toggleModal('projectModal')"
                            class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 font-semibold text-sm px-4 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 transition-colors">Cancel</button>
                        <button onclick="saveNewProject()"
                            class="btn-squish btn-primary-glow bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold text-sm px-6 py-2.5 rounded-xl">Create
                            Project</button>
                    </div>
                </div>
            </div>

            <!-- PIPELINE VIEW -->
            <div id="pipelineView" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-slate-100 dark:bg-slate-800 rounded-xl p-4">
                        <div class="px-1">
                            <h2 class="text-lg font-bold text-slate-500 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Upcoming (45+ Days)
                            </h2>
                        </div>
                        <div class="p-1 space-y-4 min-h-[200px] kanban-column overflow-y-auto pr-2" id="colUpcoming">
                        </div>
                    </div>

                    <div class="bg-hub-50 dark:bg-slate-800 rounded-xl p-4">
                        <div class="px-1">
                            <h2 class="text-lg font-bold text-hub-700 dark:text-hub-400 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                                </svg>
                                In Progress (0-45 Days)
                            </h2>
                        </div>
                        <div class="p-1 space-y-4 min-h-[200px] kanban-column overflow-y-auto pr-2" id="colInProgress">
                        </div>
                    </div>

                    <div class="bg-green-50 dark:bg-slate-800 rounded-xl p-4">
                        <div class="px-1">
                            <h2 class="text-lg font-bold text-green-600 dark:text-green-400 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Completed (Last 45 Days)
                            </h2>
                        </div>
                        <div class="p-1 space-y-4 min-h-[200px] kanban-column overflow-y-auto pr-2" id="colCompleted">
                        </div>
                    </div>
                </div>
            </div>

            <!-- LOGBOOK VIEW -->
            <div id="logbookView" class="hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                Team Logbook
                                <span id="logbookCount"
                                    class="text-sm font-medium bg-slate-100 text-slate-500 px-2 py-1 rounded-full">0
                                    entries</span>
                            </h2>
                            <p class="text-sm text-slate-500 mt-1">Track issues, requests, kudos, and notes.</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="toggleLogbookSelectionMode()" id="logbookSelectBtn"
                                class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-4 py-2 rounded-lg font-bold flex items-center shadow-sm transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Manage
                            </button>
                            <button onclick="openLogbookModal()"
                                class="bg-hub-600 hover:bg-hub-700 text-white px-4 py-2 rounded-lg font-bold flex items-center shadow-md transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                New Entry
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">

                            <div class="md:col-span-4 relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input type="text" id="lbSearch" oninput="renderLogbook()"
                                    placeholder="Search content, titles, or names..."
                                    class="pl-10 w-full rounded-lg border border-slate-300 py-2 text-sm focus:ring-2 focus:ring-hub-500 focus:border-hub-500">
                            </div>

                            <div class="md:col-span-2">
                                <select id="lbFilterTm" onchange="renderLogbook()"
                                    class="w-full rounded-lg border border-slate-300 py-2 px-3 text-sm focus:ring-hub-500 bg-slate-50 text-slate-700 font-medium cursor-pointer">
                                    <option value="all">All Team Members</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <select id="lbFilterType" onchange="renderLogbook()"
                                    class="w-full rounded-lg border border-slate-300 py-2 px-3 text-sm focus:ring-hub-500 bg-slate-50 text-slate-700 font-medium cursor-pointer">
                                    <option value="all">All Types</option>
                                    <option value="actionable"> Issues & Requests</option>
                                    <option value="issue"> Issues</option>
                                    <option value="request"> Requests</option>
                                    <option value="kudos"> Kudos</option>
                                    <option value="note"> Notes</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <select id="lbFilterStatus" onchange="renderLogbook()"
                                    class="w-full rounded-lg border border-slate-300 py-2 px-3 text-sm focus:ring-hub-500 bg-slate-50 text-slate-700 font-medium cursor-pointer">
                                    <option value="all">All Statuses</option>
                                    <option value="Open">Open / Pending</option>
                                    <option value="Closed">Closed / Done</option>
                                </select>
                            </div>

                            <div class="md:col-span-2 text-right flex items-center justify-end gap-3">
                                <!-- NEW AI BUTTON -->
                                <button onclick="fixLogTitlesWithAI()"
                                    class="group flex items-center gap-2 bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 text-white text-xs font-bold py-1.5 px-3 rounded-full shadow-md transition-all hover:shadow-lg active:scale-95">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 animate-pulse"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 2v4" />
                                        <path d="M12 18v4" />
                                        <path d="M4.93 4.93l2.83 2.83" />
                                        <path d="M16.24 16.24l2.83 2.83" />
                                        <path d="M2 12h4" />
                                        <path d="M18 12h4" />
                                        <path d="M4.93 19.07l2.83-2.83" />
                                        <path d="M16.24 7.76l2.83-2.83" />
                                    </svg>
                                    AI FIX
                                </button>

                                <button onclick="resetLogFilters()"
                                    class="text-sm text-slate-500 hover:text-hub-600 font-bold underline decoration-slate-300 hover:decoration-hub-600">
                                    Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="logbookBulkDeleteControls"
                        class="bg-red-50 p-3 rounded-xl mb-4 hidden flex justify-between items-center border border-red-200">
                        <p id="logbookSelectedCount" class="text-red-700 font-bold ml-2">0 selected</p>
                        <button onclick="deleteSelectedLogEntries()"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center text-sm shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete Selected
                        </button>
                    </div>

                    <div class="space-y-4 overflow-y-auto" style="max-height: calc(100vh - 400px);"
                        id="logbookEntryList"></div>
                </div>
            </div>

            <!-- BROADCAST VIEW -->
            <div id="broadcastView" class="hidden">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-slate-800">Broadcast Tracker</h2>
                    <div class="flex space-x-2 self-start md:self-center">
                        <button onclick="toggleBroadcastSelectionMode()" id="broadcastSelectBtn"
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold flex items-center shadow-md transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Select for Archive
                        </button>
                        <button onclick="openBroadcastModal()"
                            class="bg-hub-600 hover:bg-hub-700 text-white px-4 py-2 rounded-lg font-bold flex items-center shadow-md transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            New Broadcast
                        </button>
                    </div>
                </div>

                <div
                    class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mb-4 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex-1 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input type="text" id="broadcastSearch" oninput="renderBroadcast()"
                            placeholder="Search broadcasts..."
                            class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-hub-500 focus:border-hub-500 text-sm">
                    </div>
                    <select id="broadcastStatusFilter" onchange="renderBroadcast()" class="filter-select">
                        <option value="all">All Statuses</option>
                        <option value="InProgress">In Progress</option>
                        <option value="Completed">Completed</option>
                    </select>
                    <select id="broadcastCategoryFilter" onchange="renderBroadcast()" class="filter-select">
                        <option value="all">All Categories</option>
                    </select>
                </div>

                <div id="broadcastBulkDeleteControls"
                    class="bg-red-100 p-3 rounded-xl mb-4 hidden justify-between items-center border border-red-200">
                    <p id="broadcastSelectedCount" class="text-red-700 font-bold">0 selected</p>
                    <button onclick="deleteSelectedBroadcasts()"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Delete Selected
                    </button>
                </div>

                <div class="space-y-4" id="broadcastList"></div>
            </div>

            <!-- PERFORMANCE VIEW -->
            <div id="performanceView" class="hidden">
                <!-- Performance Header -->
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-8 gap-4">
                    <div class="flex items-center gap-4">
                        <div
                            class="p-3 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl shadow-lg shadow-blue-200 dark:shadow-blue-900/20 text-white transform transition-transform hover:scale-105 duration-300">
                            <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-black text-slate-900 dark:text-white tracking-tight">Tailored
                                Success Metrics</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 font-medium flex items-center gap-2">
                                Manage team performance and reviews
                                <span id="view-indicator"
                                    class="hidden inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300 ml-2">
                                    <span id="current-view-icon" class="mr-1"></span>
                                    <span id="current-view-text">Dashboard</span>
                                </span>
                            </p>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button id="nav-dashboard" onclick="switchPerformanceView('dashboard')"
                            class="px-4 py-2 text-sm font-bold rounded-lg transition hidden
                                       bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:text-slate-900 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-700">
                             Dashboard
                        </button>
                        <button id="nav-insights" onclick="switchPerformanceView('insights')"
                            class="px-4 py-2 text-sm font-bold rounded-lg transition bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:text-slate-900 dark:bg-slate-800 dark:text-slate-300 dark:border-slate-700 dark:hover:bg-slate-700 shadow-sm">
                             Team Insights
                        </button>
                        <button id="nav-studio"
                            class="hidden px-4 py-2 text-sm font-bold rounded-lg transition
                                       bg-blue-600 text-white hover:bg-blue-700 shadow-md shadow-blue-200 dark:shadow-none">
                             Actions
                        </button>
                    </div>
                </div>

                <!-- Breadcrumb Navigation -->
                <div id="performance-breadcrumbs" class="hidden mb-4">
                    <nav class="flex items-center space-x-2 text-sm">
                        <button onclick="switchPerformanceView('dashboard')"
                            class="text-blue-600 hover:text-blue-800 font-medium transition">
                            Performance Dashboard
                        </button>
                        <span class="text-slate-400">></span>
                        <span id="breadcrumb-current" class="text-slate-600 font-medium">Current View</span>
                    </nav>
                </div>

                <!-- DASHBOARD VIEW -->
                <div id="perf-dashboard" class="space-y-8 fade-in-premium">
                    <!-- Modern Filters Bar -->
                    <div
                        class="filters-bar bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl px-6 py-4 rounded-2xl shadow-sm border border-slate-200/60 dark:border-slate-700/60 mb-8 sticky top-0 z-20">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:flex lg:items-center gap-4">
                            <!-- Primary Controls -->
                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-2">
                                    <span
                                        class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Month</span>
                                    <div
                                        class="flex items-center bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-1 shadow-sm">
                                        <button onclick="changePerformanceMonth(-1)"
                                            class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-slate-50 dark:hover:bg-slate-600 rounded-md transition-all">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                                    d="M15 19l-7-7 7-7" />
                                            </svg>
                                        </button>
                                        <div id="perf-month-navigator-text"
                                            class="px-3 text-sm font-bold text-slate-700 dark:text-slate-200 min-w-[90px] text-center select-none">
                                            Oct '25
                                        </div>
                                        <button onclick="changePerformanceMonth(1)"
                                            class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-slate-50 dark:hover:bg-slate-600 rounded-md transition-all">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                                    d="M9 5l7 7-7 7" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Secondary Controls -->
                            <div class="flex items-center gap-3 flex-wrap">
                                <select id="account-filter" onchange="filterPerformanceDashboard()"
                                    class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2 cursor-pointer shadow-sm hover:border-blue-400 transition-colors">
                                    <option value="all">All Accounts</option>
                                </select>

                                <select id="status-filter" onchange="filterPerformanceDashboard()"
                                    class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2 cursor-pointer shadow-sm hover:border-blue-400 transition-colors">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending Review</option>
                                    <option value="completed">Completed</option>
                                </select>

                                <select id="perf-sort-select" onchange="renderPerformanceDashboard()"
                                    class="bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2 cursor-pointer shadow-sm hover:border-blue-400 transition-colors">
                                    <option value="status">Priority</option>
                                    <option value="name">Name</option>
                                    <option value="account">Account</option>
                                    <option value="score">Score</option>
                                </select>
                            </div>

                            <!-- Search -->
                            <div class="md:col-span-2 lg:flex-1 lg:max-w-sm ml-auto flex items-center gap-3">
                                <div class="relative group flex-1">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-4 w-4 text-slate-400 group-hover:text-blue-500 transition-colors"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </div>
                                    <input type="text" id="member-search" placeholder="Search team members..."
                                        class="w-full bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block pl-10 pr-8 py-2 shadow-sm hover:border-blue-400 transition-all"
                                        onkeyup="debouncedSearch()">
                                    <button onclick="clearSearch()" id="clear-search-btn"
                                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-600 opacity-0 transition-opacity">
                                        
                                    </button>
                                </div>
                                <button onclick="openClientSyncModal()" 
                                    class="flex items-center gap-2 px-4 py-2 bg-slate-800 text-white text-sm font-bold rounded-lg hover:bg-slate-700 transition-all shadow-sm whitespace-nowrap">
                                    <i data-lucide="share-2" class="w-4 h-4"></i>
                                    Client Sync
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Modern Team Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <!-- Team Average -->
                        <!-- Team Average -->
                        <div
                            class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 px-6 py-5 rounded-2xl shadow-sm border border-blue-100 dark:border-blue-900/30 relative overflow-hidden group transition-all hover:shadow-md">
                            <div
                                class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity pointer-events-none">
                                <i data-lucide="bar-chart-2" class="w-24 h-24 text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div class="relative z-10 flex justify-between items-center">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <div
                                            class="p-1.5 bg-blue-100 dark:bg-blue-900/50 rounded-lg text-blue-600 dark:text-blue-400">
                                            <i data-lucide="activity" class="w-4 h-4"></i>
                                        </div>
                                        <p
                                            class="text-xs font-bold text-blue-800 dark:text-blue-300 uppercase tracking-wider">
                                            Team Average</p>
                                    </div>
                                    <p id="perf-month-display"
                                        class="text-sm text-blue-600/80 dark:text-blue-400/80 font-medium ml-1">
                                        Loading...</p>
                                </div>
                                <div class="text-right">
                                    <div class="flex items-baseline gap-1 justify-end">
                                        <span id="perf-team-avg"
                                            class="text-4xl font-black text-blue-700 dark:text-blue-400 tracking-tight">0.00</span>
                                        <span class="text-sm font-bold text-blue-600/60 dark:text-blue-400/60">/
                                            5.0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Completion Stats -->
                        <div
                            class="bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 px-6 py-5 rounded-2xl shadow-sm border border-emerald-100 dark:border-emerald-900/30 relative overflow-hidden group transition-all hover:shadow-md">
                            <div
                                class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity pointer-events-none">
                                <i data-lucide="check-circle-2"
                                    class="w-24 h-24 text-emerald-600 dark:text-emerald-400"></i>
                            </div>
                            <div class="relative z-10 flex justify-between items-center">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <div
                                            class="p-1.5 bg-emerald-100 dark:bg-emerald-900/50 rounded-lg text-emerald-600 dark:text-emerald-400">
                                            <i data-lucide="pie-chart" class="w-4 h-4"></i>
                                        </div>
                                        <p
                                            class="text-xs font-bold text-emerald-800 dark:text-emerald-300 uppercase tracking-wider">
                                            Completion</p>
                                    </div>
                                    <p class="text-sm text-emerald-600/80 dark:text-emerald-400/80 font-medium ml-1"
                                        id="completion-text">0 of 0 rated</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <span id="completion-percent"
                                            class="text-4xl font-black text-emerald-700 dark:text-emerald-400 tracking-tight">0%</span>
                                    </div>
                                    <div class="w-12 h-12 relative">
                                        <svg class="w-12 h-12 transform -rotate-90" viewBox="0 0 36 36">
                                            <path
                                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                fill="none" stroke="currentColor" stroke-width="3"
                                                stroke-dasharray="100, 100"
                                                class="text-emerald-200 dark:text-emerald-900/50"></path>
                                            <path id="completion-circle"
                                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                                                fill="none" stroke="currentColor" stroke-width="3"
                                                stroke-dasharray="0, 100"
                                                class="text-emerald-500 dark:text-emerald-400 transition-all duration-500 ease-out">
                                            </path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>

                    <!-- Performance Cards Grid -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 tracking-tight">Team
                                Performance</h3>
                            <div
                                class="text-xs text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full">
                                <span id="total-members">0</span> team members
                            </div>
                        </div>
                        <div id="perf-team-grid"
                            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                    </div>
                </div>

                <div id="perf-insights" class="hidden max-w-7xl mx-auto fade-in-premium space-y-6">
                    <div
                        class="flex flex-col md:flex-row justify-between items-center bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2">
                            <span class="text-xl"></span> Team Analytics
                        </h3>
                        <div class="flex items-center gap-3">
                            <div
                                class="flex items-center bg-slate-50 dark:bg-slate-700 rounded-lg p-1 border border-slate-200 dark:border-slate-600">
                                <select id="insight-start-month" onchange="renderTeamInsights()"
                                    class="bg-transparent text-sm font-semibold text-slate-600 dark:text-slate-300 py-1 px-2 outline-none cursor-pointer"></select>
                                <span class="text-slate-400 px-1"></span>
                                <select id="insight-end-month" onchange="renderTeamInsights()"
                                    class="bg-transparent text-sm font-semibold text-slate-600 dark:text-slate-300 py-1 px-2 outline-none cursor-pointer"></select>
                            </div>
                            <button onclick="resetInsightFilters()"
                                class="text-xs font-bold text-blue-600 hover:text-blue-800 dark:text-blue-400">Reset</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div
                            class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm relative overflow-hidden group">
                            <div
                                class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <i data-lucide="bar-chart-2" class="w-16 h-16 text-slate-900 dark:text-white"></i>
                            </div>
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest font-mono">Avg Score
                                (Period)</p>
                            <div class="flex items-end gap-3 mt-2 relative z-10">
                                <h3 id="insight-team-avg"
                                    class="text-4xl font-black text-slate-800 dark:text-white tracking-tighter">0.00
                                </h3>
                            </div>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest font-mono">Strongest
                                Area</p>
                            <h3 id="insight-top-metric" class="text-lg font-bold text-emerald-600 mt-2 truncate">--</h3>
                            <p id="insight-top-score" class="text-xs font-mono text-slate-400 mt-1">Score: 0.0</p>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest font-mono">Growth Area
                            </p>
                            <h3 id="insight-low-metric" class="text-lg font-bold text-rose-500 mt-2 truncate">--</h3>
                            <p id="insight-low-score" class="text-xs font-mono text-slate-400 mt-1">Score: 0.0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-slate-900 p-6 rounded-xl shadow-lg border border-slate-700">
                            <h4 class="text-xs font-bold text-slate-400 mb-6 font-mono uppercase tracking-widest">Team
                                Score Trend</h4>
                            <div class="h-64"><canvas id="insight-score-trend"></canvas></div>
                        </div>
                        <div class="bg-slate-900 p-6 rounded-xl shadow-lg border border-slate-700">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-xs font-bold text-slate-400 mb-0 font-mono uppercase tracking-widest">Metric
                                    Trends</h4>
                            </div>
                            <div id="insight-metric-filters" class="mb-4 grid grid-cols-3 gap-2"></div>
                            <div class="h-64"><canvas id="insight-metric-trend"></canvas></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-slate-900 p-6 rounded-xl shadow-lg border border-slate-700">
                            <h4 class="text-xs font-bold text-slate-400 mb-6 font-mono uppercase tracking-widest">Skill
                                Spectrum (Avg)</h4>
                            <div class="h-64"><canvas id="insight-skill-chart"></canvas></div>
                        </div>
                        <div class="bg-slate-900 p-6 rounded-xl shadow-lg border border-slate-700">
                            <h4 class="text-xs font-bold text-slate-400 mb-6 font-mono uppercase tracking-widest">
                                Performance Distribution</h4>
                            <div class="h-64"><canvas id="insight-dist-chart"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- STUDIO VIEW -->
                <div id="perf-studio" class="hidden max-w-5xl mx-auto fade-in-premium">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="switchPerformanceView('dashboard')"
                            class="text-slate-500 hover:text-blue-600 font-bold text-sm flex items-center gap-2 transition">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Dashboard
                        </button>
                    </div>

                    <div id="studio-selector"
                        class="hidden flex flex-col items-center justify-center min-h-[50vh] text-center animate-fade-in">
                        <div
                            class="bg-white dark:bg-slate-800 p-10 md:p-14 rounded-3xl shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 border border-slate-200 dark:border-slate-700 max-w-2xl w-full relative overflow-hidden group hover:shadow-2xl hover:shadow-blue-100/50 dark:hover:shadow-blue-900/30 transition-all duration-500">
                            <div
                                class="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-blue-50 dark:bg-blue-900/20 rounded-full blur-3xl opacity-50 group-hover:bg-blue-100 dark:group-hover:bg-blue-900/40 transition duration-700">
                            </div>
                            <div
                                class="absolute bottom-0 left-0 -ml-16 -mb-16 w-64 h-64 bg-indigo-50 dark:bg-indigo-900/20 rounded-full blur-3xl opacity-50 group-hover:bg-indigo-100 dark:group-hover:bg-indigo-900/40 transition duration-700">
                            </div>
                            <div class="relative z-10 flex flex-col items-center">
                                <div
                                    class="mb-8 p-5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-2xl shadow-sm ring-1 ring-blue-100 dark:ring-blue-900/50 group-hover:scale-110 group-hover:rotate-3 transition duration-500">
                                    <i data-lucide="user-search" class="w-10 h-10"></i>
                                </div>
                                <h3
                                    class="text-3xl font-extrabold text-slate-900 dark:text-slate-100 tracking-tight mb-3 perf-header">
                                    Action Studio</h3>
                                <p
                                    class="text-slate-500 dark:text-slate-300 mb-10 max-w-md mx-auto text-base leading-relaxed">
                                    Select a team member to set their <span class="font-bold text-blue-700">Quarterly
                                        Strategy</span> (Q1-Q4) or complete their <span
                                        class="font-bold text-green-700">Monthly Performance Rating</span>.
                                </p>
                                <!-- Fuzzy Search Member Selector -->
                                <div class="w-full relative group/input">
                                    <div class="relative">
                                        <input type="text" id="member-search-input" placeholder="Search team members..."
                                            class="block w-full pl-4 pr-12 py-4 text-base border-slate-200 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent rounded-xl bg-slate-50 dark:bg-slate-700 hover:bg-white dark:hover:bg-slate-600 hover:border-blue-300 transition-all shadow-sm font-medium text-slate-700 dark:text-slate-300">

                                        <div
                                            class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                            <i data-lucide="search"
                                                class="h-5 w-5 text-slate-400 dark:text-slate-500"></i>
                                        </div>

                                        <!-- Hidden actual select for form compatibility -->
                                        <select id="studio-member-select" class="hidden">
                                            <option value="">Select a Team Member...</option>
                                        </select>
                                    </div>

                                    <!-- Search Results Dropdown -->
                                    <div id="member-search-results"
                                        class="absolute z-50 w-full mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl shadow-lg max-h-64 overflow-y-auto hidden">
                                        <div id="search-results-list" class="py-2">
                                            <!-- Results populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="studio-landing" class="hidden grid-cols-1 md:grid-cols-2 gap-8"
                        style="display: none !important;">
                        <div onclick="initPerformanceMetricBuilder()"
                            class="group bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 hover:border-blue-500 cursor-pointer transition relative overflow-hidden">
                            <div
                                class="absolute top-0 left-0 w-1.5 h-full bg-slate-300 dark:bg-slate-600 group-hover:bg-blue-500 transition-all duration-300">
                            </div>
                            <div
                                class="mb-5 text-blue-600 bg-blue-50 dark:bg-blue-900/30 w-14 h-14 flex items-center justify-center rounded-xl group-hover:scale-110 transition">
                                <i data-lucide="hammer" class="w-7 h-7"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2">Set Quarterly Strategy
                            </h3>
                            <p class="text-sm text-slate-500 dark:text-slate-300 leading-relaxed">Define 3-4 key metrics
                                for the quarter
                                that will guide monthly performance reviews.</p>
                        </div>
                        <div onclick="initPerformanceMetricRating()"
                            class="group bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 hover:border-green-500 cursor-pointer transition relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-1.5 h-full bg-green-500 transition-all duration-300">
                            </div>
                            <div
                                class="mb-5 text-green-600 bg-green-50 dark:bg-green-900/30 w-14 h-14 flex items-center justify-center rounded-xl group-hover:scale-110 transition">
                                <i data-lucide="star" class="w-7 h-7"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2">Monthly Performance
                                Rating</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-300 leading-relaxed">Rate performance
                                against quarterly
                                strategy metrics plus core DCX values.</p>
                        </div>
                    </div>

                    <div id="studio-workspace"
                        class="hidden bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div
                            class="bg-white dark:bg-slate-800 px-8 py-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                            <div>
                                <div class="flex items-center gap-3">
                                    <h3 id="workspace-title"
                                        class="text-lg font-bold text-slate-800 dark:text-slate-200">Workspace</h3>
                                    <div id="workspace-member-badge" class="hidden">
                                        <span
                                            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                                            <span id="workspace-member-name">Member Name</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <select id="workspace-member-select" onchange="handlePerformanceStudioMemberSelect()"
                                    class="text-sm border-slate-300 dark:border-slate-600 rounded-lg shadow-sm p-2 border font-semibold bg-slate-50 dark:bg-slate-700 text-slate-700 dark:text-slate-300 min-w-[150px]">
                                </select>
                                <div class="flex items-center gap-2">
                                    <label for="workspace-period-select"
                                        class="text-xs font-medium text-slate-600 dark:text-slate-400 uppercase tracking-wide">
                                        Period
                                    </label>
                                    <select id="workspace-period-select" onchange="handlePerformancePeriodChange()"
                                        class="text-sm border-slate-300 dark:border-slate-600 rounded-lg shadow-sm p-2 border font-semibold bg-slate-50 dark:bg-slate-700 text-slate-700 dark:text-slate-300">
                                    </select>
                                </div>
                                <button id="btn-delete-metrics" onclick="confirmDeleteMetrics()"
                                    class="hidden text-red-600 hover:text-red-700 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 px-3 py-2 rounded-lg text-xs font-semibold transition"
                                    title="Delete metrics for this period">
                                     Delete Metrics
                                </button>
                                <button onclick="closePerformanceWorkspace()"
                                    class="text-slate-400 hover:text-slate-600 bg-slate-50 dark:bg-slate-700 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-600 transition"><i
                                        data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                        </div>


                        <div id="workspace-error" class="hidden p-12 text-center">
                            <div
                                class="mx-auto w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100">No Strategy Found</h3>
                            <p class="text-slate-500 dark:text-slate-300 mt-2 mb-6">No metrics established for this
                                quarter.</p>
                            <button onclick="initPerformanceMetricBuilder()"
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md">Go
                                to Metric Builder</button>
                        </div>

                        <div id="builder-grid-area"
                            class="hidden p-8 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50">
                            <div class="flex justify-between items-center mb-6">
                                <h4
                                    class="text-xs font-bold text-slate-500 dark:text-slate-300 uppercase tracking-widest">
                                    Select 3-4
                                    Metrics</h4>
                                <span id="selection-count"
                                    class="text-xs font-bold px-3 py-1 rounded-full bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 shadow-sm">0/4
                                    Selected</span>
                            </div>
                            <div id="metric-selection-grid"
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
                        </div>

                        <div id="workspace-content" class="p-8">
                            <div id="builder-selected-header" class="hidden mb-6">
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Define Success
                                    Criteria</h4>
                            </div>

                            <div id="metric-rows-container" class="space-y-6 mb-10"></div>

                            <div id="rating-core-components"
                                class="hidden border-t border-slate-100 pt-8 mt-4 grid md:grid-cols-2 gap-8">
                                <div
                                    class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase mb-3 tracking-wide">DCX
                                        Values Alignment (30%)</label>
                                    <select id="rating-values-score"
                                        onchange="updatePerformanceRubricDisplay('values', this.value); calculatePerformanceRatingScore()"
                                        class="w-full input-premium rounded-lg p-2.5 text-sm font-semibold text-slate-700 mb-3">
                                        <option value="0">Select Score...</option>
                                        <option value="5">5 - Outstanding</option>
                                        <option value="4">4 - Exceeds Expectations</option>
                                        <option value="3">3 - Meets Expectations</option>
                                        <option value="2">2 - Needs Improvement</option>
                                        <option value="1">1 - Unsatisfactory</option>
                                    </select>
                                    <div id="rubric-display-values" class="rubric-def-box hidden"></div>
                                    <textarea id="rating-values-notes"
                                        class="w-full input-premium rounded-lg p-3 text-sm h-24 mt-4"
                                        placeholder="Evidence..."></textarea>
                                </div>
                                <div
                                    class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition">
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase mb-3 tracking-wide">Attendance
                                        (15%)</label>
                                    <select id="rating-attendance-score"
                                        onchange="updatePerformanceRubricDisplay('attendance', this.value); calculatePerformanceRatingScore()"
                                        class="w-full input-premium rounded-lg p-2.5 text-sm font-semibold text-slate-700 mb-3">
                                        <option value="0">Select Score...</option>
                                        <option value="5">5 - 100%</option>
                                        <option value="4">4 - 98-99%</option>
                                        <option value="3">3 - 95-97%</option>
                                        <option value="2">2 - <95%< /option>
                                        <option value="1">1 - <90%< /option>
                                    </select>
                                    <div id="rubric-display-attendance" class="rubric-def-box hidden"></div>
                                    <textarea id="rating-attendance-notes"
                                        class="w-full input-premium rounded-lg p-3 text-sm h-24 mt-4"
                                        placeholder="Notes..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div id="workspace-footer"
                            class="bg-slate-50 px-8 py-5 border-t border-slate-200 flex justify-between items-center">
                            <div id="score-readout" class="hidden">
                                <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Total Score
                                </p>
                                <p id="final-score-display"
                                    class="text-4xl font-black text-blue-600 tracking-tight perf-score">0.00</p>
                            </div>
                            <div class="flex-1">
                                <p id="builder-validation-msg"
                                    class="text-xs text-red-500 font-bold hidden ml-4 bg-red-50 px-3 py-1 rounded-full w-fit">
                                    Select 3-4 metrics to save.</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="closePerformanceWorkspace()"
                                    class="px-5 py-2.5 text-slate-600 font-bold text-sm hover:bg-slate-200 rounded-lg transition">Cancel</button>
                                <button id="btn-save-workspace" onclick="savePerformanceWorkspaceData()"
                                    class="px-6 py-2.5 bg-blue-600 text-white font-bold text-sm rounded-lg hover:bg-blue-700 shadow-md shadow-blue-200 transition transform hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed">Save
                                    Data</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- UNIFIED RATING FORM -->
                <div id="perf-unified-rating" class="hidden max-w-6xl mx-auto fade-in-premium">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="switchPerformanceView('dashboard')"
                            class="text-slate-500 hover:text-blue-600 font-bold text-sm flex items-center gap-2 transition">
                            <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Dashboard
                        </button>
                        <div class="flex items-center gap-4">
                            <div class="text-sm text-slate-500">
                                <span id="rating-member-name" class="font-semibold text-slate-700">Member Name</span>
                                <span class="mx-2"></span>
                                <span id="rating-month-display">Month</span>
                            </div>
                        </div>
                    </div>

                    <!-- METRIC SELECTION PHASE -->
                    <div id="rating-phase-select"
                        class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden mb-6">
                        <div class="px-8 py-6 border-b border-slate-100 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2">Choose & Define 3
                                Performance
                                Metrics</h3>
                            <p class="text-slate-600 dark:text-slate-300 text-sm">Select metrics and define what success
                                looks like for each.</p>
                        </div>

                        <div class="p-8">
                            <div id="metric-selection-grid-rating"
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                <!-- Metrics will be populated here -->
                            </div>

                            <div class="flex justify-between items-center">
                                <div class="text-sm text-slate-500">
                                    <span id="selected-count">0</span> of 3 selected
                                </div>
                                <div class="flex gap-3">
                                    <button id="btn-save-metrics"
                                        class="px-6 py-2.5 bg-slate-200 text-slate-500 font-semibold text-sm rounded-lg transition disabled:opacity-30 disabled:cursor-not-allowed hover:bg-green-600 hover:text-white"
                                        style="transition: all 0.3s ease;" disabled>
                                         Save Metrics
                                    </button>
                                    <button id="btn-continue-to-rating"
                                        class="px-6 py-2.5 bg-blue-600 text-white font-semibold text-sm rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                        disabled>
                                        Continue to Rating 
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- COMPLETION PHASE -->
                    <div id="rating-phase-complete"
                        class="hidden bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="px-8 py-6 border-b border-slate-100 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2">Complete Rating</h3>
                            <p class="text-slate-600 dark:text-slate-300 text-sm">Review the final scores and save the
                                performance rating.</p>
                        </div>

                        <div class="p-8 space-y-8">
                            <!-- Final metrics summary -->
                            <div id="final-metrics-summary" class="space-y-4">
                                <!-- Final metrics will be populated here -->
                            </div>

                            <!-- Value alignment and attendance -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <label class="block text-sm font-semibold text-slate-900 dark:text-slate-100">
                                         Value Alignment
                                    </label>
                                    <div class="star-rating flex gap-1" data-rating="values">
                                        <button class="star w-8 h-8 text-slate-300 hover:text-yellow-400 transition"
                                            data-value="1"></button>
                                        <button class="star w-8 h-8 text-slate-300 hover:text-yellow-400 transition"
                                            data-value="2"></button>
                                        <button class="star w-8 h-8 text-slate-300 hover:text-yellow-400 transition"
                                            data-value="3"></button>
                                        <button class="star w-8 h-8 text-slate-300 hover:text-yellow-400 transition"
                                            data-value="4"></button>
                                        <button class="star w-8 h-8 text-slate-300 hover:text-yellow-400 transition"
                                            data-value="5"></button>
                                    </div>
                                    <p class="text-xs text-slate-500">How well does this team member demonstrate company
                                        values?</p>
                                </div>

                                <div class="space-y-4">
                                    <label class="block text-sm font-semibold text-slate-900 dark:text-slate-100">
                                         Attendance
                                    </label>
                                    <div class="star-rating flex gap-1" data-rating="attendance">
                                        <button class="star w-8 h-8 text-slate-300 hover:text-yellow-400 transition"
                                            data-value="1"></button>
                                        <button class="star w-8 h-8 text-slate-300 hover:text-yellow-400 transition"
                                            data-value="2"></button>
                                        <button class="star w-8 h-8 text-slate-300 hover:text-yellow-400 transition"
                                            data-value="3"></button>
                                        <button class="star w-8 h-8 text-slate-300 hover:text-yellow-400 transition"
                                            data-value="4"></button>
                                        <button class="star w-8 h-8 text-slate-300 hover:text-yellow-400 transition"
                                            data-value="5"></button>
                                    </div>
                                    <p class="text-xs text-slate-500">Punctuality and availability this month.</p>
                                </div>
                            </div>

                            <!-- Final score -->
                            <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6 text-center">
                                <h4 class="text-lg font-bold text-slate-900 dark:text-slate-100 mb-2">Final Score</h4>
                                <div class="text-4xl font-black text-blue-600 mb-1" id="final-score-display">0.00</div>
                                <p class="text-sm text-slate-600 dark:text-slate-300">Average of all ratings</p>
                            </div>

                            <div class="flex justify-end gap-3 pt-6 border-t border-slate-100 dark:border-slate-700">
                                <button onclick="cancelUnifiedRating()"
                                    class="px-6 py-2.5 text-slate-600 font-semibold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition">
                                    Cancel
                                </button>
                                <button onclick="saveUnifiedRating()"
                                    class="px-6 py-2.5 bg-blue-600 text-white font-semibold text-sm rounded-lg hover:bg-blue-700 transition">
                                    Save Rating
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- PHASE 1: PERFORMANCE METRIC RATING WINDOW -->
                    <div id="rating-phase-metrics"
                        class="hidden bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden mb-6">
                        <div class="px-8 py-6 border-b border-slate-100 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2">Performance Metric
                                Rating</h3>
                            <p class="text-slate-600 dark:text-slate-300 text-sm">Rate each selected metric on a 1-5
                                scale.</p>
                        </div>

                        <div class="p-8">
                            <div id="metrics-rating-grid" class="space-y-8">
                                <!-- Metrics will be populated here -->
                            </div>

                            <div
                                class="flex justify-between items-center mt-8 pt-6 border-t border-slate-100 dark:border-slate-700">
                                <button onclick="showMetricSelectionPhase()"
                                    class="px-6 py-2.5 text-slate-600 font-semibold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition">
                                     Back to Selection
                                </button>
                                <button id="btn-continue-to-mandatory" onclick="showMandatoryRatingPhase()"
                                    class="px-6 py-2.5 bg-blue-600 text-white font-semibold text-sm rounded-lg hover:bg-blue-700 transition">
                                    Continue to Mandatory Ratings 
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- PHASE 2: MANDATORY METRIC RATING WINDOW -->
                    <div id="rating-phase-mandatory"
                        class="hidden bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden mb-6">

                        <div class="px-8 py-6 border-b border-slate-100 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2">Mandatory Metric
                                Rating</h3>
                            <p class="text-slate-600 dark:text-slate-300 text-sm">Rate core values alignment and
                                attendance.</p>
                        </div>

                        <div class="p-8">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Core Values Rating -->
                                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6">
                                    <label class="block text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3">
                                         Value Alignment (30%)
                                    </label>
                                    <select id="unified-values-score"
                                        onchange="updateUnifiedMandatoryMetrics('values', this.value)"
                                        class="w-full input-premium rounded-lg p-2.5 text-sm font-semibold text-slate-700 mb-3">
                                        <option value="0">Select Score...</option>
                                        <option value="5">5 - Outstanding</option>
                                        <option value="4">4 - Exceeds Expectations</option>
                                        <option value="3">3 - Meets Expectations</option>
                                        <option value="2">2 - Needs Improvement</option>
                                        <option value="1">1 - Unsatisfactory</option>
                                    </select>
                                    <div id="unified-rubric-values" class="rubric-def-box hidden"></div>
                                    <textarea id="unified-values-notes"
                                        class="w-full input-premium rounded-lg p-3 text-sm h-24 mt-4"
                                        placeholder="Evidence..."></textarea>
                                </div>

                                <!-- Attendance Rating -->
                                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6">
                                    <label class="block text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3">
                                         Attendance (15%)
                                    </label>
                                    <select id="unified-attendance-score"
                                        onchange="updateUnifiedMandatoryMetrics('attendance', this.value)"
                                        class="w-full input-premium rounded-lg p-2.5 text-sm font-semibold text-slate-700 mb-3">
                                        <option value="0">Select Score...</option>
                                        <option value="5">5 - 100%</option>
                                        <option value="4">4 - 98-99%</option>
                                        <option value="3">3 - 95-97%</option>
                                        <option value="2">2 - &lt;95%</option>
                                        <option value="1">1 - &lt;90%</option>
                                    </select>
                                    <div id="unified-rubric-attendance" class="rubric-def-box hidden"></div>
                                    <textarea id="unified-attendance-notes"
                                        class="w-full input-premium rounded-lg p-3 text-sm h-24 mt-4"
                                        placeholder="Notes..."></textarea>
                                </div>

                                <!-- Engagement Level -->
                                <div class="bg-teal-50 dark:bg-teal-900/30 rounded-xl p-6 border-2 border-teal-200 dark:border-teal-700">
                                    <label class="block text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3 flex items-center gap-2">
                                        <span class="text-teal-600"></span> Level of Engagement
                                    </label>
                                    <select id="unified-engagement-level"
                                        onchange="updateUnifiedMandatoryMetrics('engagement', this.value)"
                                        class="w-full input-premium rounded-lg p-2.5 text-sm font-semibold text-slate-700 mb-3 border-teal-300 focus:ring-teal-500">
                                        <option value="">Select Level...</option>
                                        <option value="High">High - Always Attending</option>
                                        <option value="Medium">Medium - Attending from time to time</option>
                                        <option value="Low">Low - Rarely/never attends</option>
                                    </select>
                                    <p class="text-xs text-teal-700 dark:text-teal-300 italic bg-teal-100/50 dark:bg-teal-800/30 p-2 rounded border border-teal-200 dark:border-teal-700">
                                         Strategic Signal: This selection does not impact the mathematical final score.
                                    </p>
                                </div>
                            </div>

                            <div
                                class="flex justify-between items-center mt-8 pt-6 border-t border-slate-100 dark:border-slate-700">
                                <button onclick="showMetricRatingPhase()"
                                    class="px-6 py-2.5 text-slate-600 font-semibold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition">
                                     Back to Metrics
                                </button>
                                <button id="btn-continue-to-recap" onclick="showFinalRecapPhase()"
                                    class="px-6 py-2.5 bg-blue-600 text-white font-semibold text-sm rounded-lg hover:bg-blue-700 transition">
                                    Continue to Summary 
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- PHASE 3: FINAL RECAP WINDOW -->
                    <div id="rating-phase-recap"
                        class="hidden bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden mb-6">
                        <div class="px-8 py-6 border-b border-slate-100 dark:border-slate-700">
                            <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2">Final Performance
                                Summary</h3>
                            <p class="text-slate-600 dark:text-slate-300 text-sm">Review all ratings and save the final
                                score.</p>
                        </div>

                        <div class="p-8">
                            <!-- Metrics Summary -->
                            <div class="mb-8">
                                <h4 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-4">Performance
                                    Metrics (55%)</h4>
                                <div id="recap-metrics-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <!-- Individual metric summaries will be populated here -->
                                </div>
                            </div>

                            <!-- Mandatory Components -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">Value
                                            Alignment</span>
                                        <span id="recap-values-score" class="text-lg font-bold text-blue-600">0</span>
                                    </div>
                                    <p id="recap-values-rubric" class="text-xs text-slate-600 dark:text-slate-300">Not
                                        rated yet</p>
                                </div>
                                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6">
                                    <div class="flex items-center justify-between mb-2">
                                        <span
                                            class="text-sm font-semibold text-slate-900 dark:text-slate-100">Attendance</span>
                                        <span id="recap-attendance-score"
                                            class="text-lg font-bold text-blue-600">0</span>
                                    </div>
                                    <p id="recap-attendance-rubric" class="text-xs text-slate-600 dark:text-slate-300">
                                        Not rated yet</p>
                                </div>
                                <div class="bg-teal-50 dark:bg-teal-900/30 rounded-xl p-6 border-2 border-teal-200 dark:border-teal-700">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-semibold text-slate-900 dark:text-slate-100">Level of Engagement</span>
                                        <span class="text-teal-600"></span>
                                    </div>
                                    <p id="recap-engagement-level" class="text-base font-bold text-teal-700 dark:text-teal-300 mb-2">Not Set</p>
                                    <p class="text-[10px] text-teal-600 dark:text-teal-400 italic bg-teal-100/50 dark:bg-teal-800/30 px-2 py-1 rounded">
                                        Strategic Signal Only
                                    </p>
                                </div>
                            </div>

                            <!-- Final Score -->
                            <div
                                class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-8 text-center mb-8">
                                <h4 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-3">Final Performance
                                    Score</h4>
                                <div class="text-5xl font-black text-blue-600 mb-2" id="recap-final-score">0.00</div>
                                <p class="text-sm text-slate-600 dark:text-slate-300">Weighted average of all components
                                </p>
                            </div>

                            <div
                                class="flex justify-between items-center pt-6 border-t border-slate-100 dark:border-slate-700">
                                <button onclick="showMandatoryRatingPhase()"
                                    class="px-6 py-2.5 text-slate-600 font-semibold text-sm hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition">
                                     Back to Mandatory
                                </button>
                                <button onclick="saveUnifiedRating()"
                                    class="px-8 py-3 bg-green-600 text-white font-bold text-sm rounded-lg hover:bg-green-700 shadow-md transition">
                                     Save Rating
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DETAILS VIEW -->
                <div id="perf-details" class="hidden space-y-8 fade-in-premium pb-12">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 id="detail-name"
                                class="text-3xl font-extrabold text-slate-900 tracking-tight perf-header">Member Name
                            </h2>
                            <p id="detail-role" class="text-lg text-slate-500 font-medium">Role Title</p>
                        </div>
                        <span onclick="switchPerformanceView('dashboard')"
                            class="bg-white border border-slate-300 text-slate-700 px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-50 shadow-sm flex items-center gap-2 transition cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 12H5M12 19l-7-7 7-7" />
                            </svg>
                            Back to Dashboard
                        </span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div
                            class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex justify-between items-center">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Latest Score</p>
                                <p id="detail-score"
                                    class="text-5xl font-black text-blue-600 mt-2 tracking-tighter perf-score">0.00</p>
                            </div>
                            <div id="detail-rating-badge"
                                class="px-4 py-1.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600 uppercase tracking-wide">
                                N/A</div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Monthly Trend</p>
                            <div class="flex items-baseline gap-3 mt-2">
                                <p id="detail-trend"
                                    class="text-5xl font-black text-slate-800 tracking-tighter perf-score">--</p>
                                <span id="detail-trend-text" class="text-sm font-bold text-slate-400">vs last
                                    month</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Filter Metrics</h3>
                            <button onclick="resetDetailFilters()"
                                class="text-xs text-blue-600 font-bold hover:underline">Reset</button>
                        </div>
                        <div id="detail-metric-filters" class="flex flex-wrap gap-3"></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-6 tracking-widest">Overall Score
                                Trend</h3>
                            <div class="h-72"><canvas id="chart-final-score"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-6 tracking-widest">Metric Specific
                                Trends</h3>
                            <div class="h-72"><canvas id="chart-metrics"></canvas></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-6 tracking-widest">Core Alignment
                                Trend</h3>
                            <div class="h-64"><canvas id="chart-values"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-6 tracking-widest">Attendance Trend
                            </h3>
                            <div class="h-64"><canvas id="chart-attendance"></canvas></div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                        <h3
                            class="text-xs font-bold text-slate-500 uppercase mb-6 border-b border-slate-100 pb-4 tracking-widest">
                            History & Notes</h3>
                        <div id="detail-notes-container" class="space-y-8"></div>
                    </div>
                </div>
        </main>

        <!-- ========================================== -->
        <!-- TEAM ANALYTICS MODAL (Premium TSM Design)  -->
        <!-- ========================================== -->
        <div id="member-analytics-modal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div
                    class="bg-white rounded-2xl shadow-2xl max-w-7xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                    <!-- Header -->
                    <div class="px-8 py-6 border-b border-slate-200 flex-none">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 id="analytics-member-name"
                                    class="text-3xl font-extrabold text-slate-900 tracking-tight">Member Name</h2>
                                <p id="analytics-member-role" class="text-lg text-slate-500 font-medium mt-1">Role Title
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <select id="analytics-date-range" onchange="updateAnalyticsCharts()"
                                    class="text-sm border-slate-300 rounded-lg shadow-sm p-2 border font-semibold bg-white">
                                    <option value="3">Last 3 Months</option>
                                    <option value="6" selected>Last 6 Months</option>
                                    <option value="12">Last 12 Months</option>
                                </select>
                                <button onclick="closeMemberAnalytics()"
                                    class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-200 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto p-8 space-y-8">

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div
                                class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex justify-between items-center">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Latest Score
                                    </p>
                                    <p id="analytics-latest-score"
                                        class="text-5xl font-black text-blue-600 mt-2 tracking-tighter">
                                        0.00</p>
                                </div>
                                <div id="analytics-rating-badge"
                                    class="px-4 py-1.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600 uppercase tracking-wide">
                                    N/A</div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Monthly Trend</p>
                                <div class="flex items-baseline gap-3 mt-2">
                                    <p id="analytics-trend" class="text-5xl font-black text-slate-800 tracking-tighter">
                                        --</p>
                                    <span id="analytics-trend-text" class="text-sm font-bold text-slate-400">vs last
                                        month</span>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Current Engagement</p>
                                <div class="flex items-center gap-3 mt-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-teal-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                    </svg>
                                    <div id="analytics-engagement-badge" class="px-4 py-1.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600 uppercase tracking-wide">
                                        Not Set
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <h3 class="text-xs font-bold text-slate-500 uppercase mb-6 tracking-widest">Overall
                                    Score Trend</h3>
                                <div class="h-72">
                                    <canvas id="score-trend-chart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <h3 class="text-xs font-bold text-slate-500 uppercase mb-6 tracking-widest">Metric
                                    Specific Trends
                                </h3>
                                <div class="h-72">
                                    <canvas id="metrics-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <h3 class="text-xs font-bold text-slate-500 uppercase mb-6 tracking-widest">Core
                                    Alignment Trend</h3>
                                <div class="h-64">
                                    <canvas id="core-values-chart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <h3 class="text-xs font-bold text-slate-500 uppercase mb-6 tracking-widest">Attendance
                                    Trend</h3>
                                <div class="h-64">
                                    <canvas id="attendance-chart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <h3 class="text-xs font-bold text-slate-500 uppercase mb-6 tracking-widest">Engagement Timeline</h3>
                                <div class="h-64">
                                    <canvas id="engagement-chart"></canvas>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Footer -->
                    <div class="bg-slate-50 p-4 border-t border-slate-200 text-right flex-none">
                        <button onclick="closeMemberAnalytics()"
                            class="text-slate-500 hover:text-slate-700 hover:bg-slate-200 px-5 py-2 rounded-lg text-sm font-bold transition-colors">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- ACTIONHUB MODALS                               -->
        <!-- ========================================== -->
        <div id="logbookModal"
            class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
            <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
            <div class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto"
                style="max-height: 90vh;">
                <form id="logbookForm" onsubmit="saveLogbookEntry(event)">
                    <div class="modal-content py-6 text-left px-8">
                        <div class="flex justify-between items-center pb-3 mb-4 border-b">
                            <p class="text-2xl font-bold text-slate-800" id="logbookModalTitle">Add New Log Entry</p>
                            <div class="modal-close cursor-pointer" onclick="toggleModal('logbookModal')">
                                <svg class="fill-current text-slate-500 hover:text-slate-800"
                                    xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 18 18">
                                    <path
                                        d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z" />
                                </svg>
                            </div>
                        </div>

                        <input type="hidden" id="logbookEntryId">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2" for="logbookTmSelect">
                                    Team Member
                                </label>
                                <div class="relative">
                                    <input type="text" id="logbookTmSearch" oninput="renderLogbookDropdown()"
                                        onfocus="renderLogbookDropdown()" placeholder="Type name, role, or account..."
                                        class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-hub-500"
                                        autocomplete="off">

                                    <input type="hidden" id="logbookTmSelect">

                                    <div id="logbookTmDropdownList"
                                        class="hidden absolute z-50 w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 max-h-48 overflow-y-auto">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2" for="logbookDate">
                                    Date of Entry
                                </label>
                                <div class="relative group w-full">
                                    <input type="text" id="logbookDate" required readonly
                                        class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                                        onclick="openPremiumCalendar(event, 'logbookDate')">

                                    <div
                                        class="logbook-date-empty flex items-center justify-center w-full py-3 px-4 rounded-lg border border-dashed border-slate-300 text-slate-400 bg-slate-50 group-hover:bg-white group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:hidden"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-5 w-5 hidden group-hover:block text-hub-600" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 11v6m-3-3h6" />
                                            </svg>
                                            <span class="text-sm font-medium group-hover:text-hub-600">Set Date</span>
                                        </div>
                                    </div>

                                    <div
                                        class="logbook-date-filled hidden flex items-center justify-between w-full py-3 px-4 rounded-lg border border-slate-200 bg-white shadow-sm">
                                        <div class="flex items-center gap-2 text-slate-700">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <span class="logbook-date-text text-sm font-bold"></span>
                                        </div>
                                        <button type="button" onclick="clearLogbookDate(event, 'logbookDate')"
                                            class="relative z-40 text-slate-400 hover:text-red-500 p-1 rounded-full hover:bg-slate-100 transition-colors"><svg
                                                xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                                fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                    clip-rule="evenodd" />
                                            </svg></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="logbookTitle">
                                Entry Title
                            </label>
                            <input
                                class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-hub-500"
                                id="logbookTitle" type="text" placeholder="E.g., PC Replacement Request" required>
                        </div>

                        <div class="mb-4">
                            <label class="block text-slate-700 text-sm font-bold mb-2">
                                Entry Type
                            </label>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="logbookType" value="kudos" class="peer sr-only"
                                        onchange="toggleDueDateField()" required>
                                    <div
                                        class="text-center py-3 px-2 rounded-xl border-2 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 hover:bg-slate-50">
                                        <div class="text-xl mb-1"></div>
                                        <div class="text-sm font-bold text-slate-600">Kudos</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="logbookType" value="issue" class="peer sr-only"
                                        onchange="toggleDueDateField()">
                                    <div
                                        class="text-center py-3 px-2 rounded-xl border-2 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 hover:bg-slate-50">
                                        <div class="text-xl mb-1"></div>
                                        <div class="text-sm font-bold text-slate-600">Issue</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="logbookType" value="request" class="peer sr-only"
                                        onchange="toggleDueDateField()">
                                    <div
                                        class="text-center py-3 px-2 rounded-xl border-2 transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-slate-50">
                                        <div class="text-xl mb-1"></div>
                                        <div class="text-sm font-bold text-slate-600">Request</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="logbookType" value="note" class="peer sr-only"
                                        onchange="toggleDueDateField()">
                                    <div
                                        class="text-center py-3 px-2 rounded-xl border-2 transition-all peer-checked:border-slate-500 peer-checked:bg-slate-50 hover:bg-slate-50">
                                        <div class="text-xl mb-1"></div>
                                        <div class="text-sm font-bold text-slate-600">Note</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Removed Kudos Points Container Logic as Vault is gone -->
                        <div class="mb-4 hidden" id="logbookKudosPointsContainer"></div>

                        <div class="mb-4 hidden" id="logbookDueDateContainer">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="logbookDueDate">
                                Due Date (for Issues/Requests)
                            </label>
                            <div class="relative group w-full">
                                <input type="text" id="logbookDueDate" readonly
                                    class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                                    onclick="openPremiumCalendar(event, 'logbookDueDate')">

                                <div
                                    class="logbook-date-empty flex items-center justify-center w-full py-3 px-4 rounded-lg border border-dashed border-slate-300 text-slate-400 bg-slate-50 group-hover:bg-white group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                                    <div class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:hidden"
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5 hidden group-hover:block text-hub-600" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 11v6m-3-3h6" />
                                        </svg>
                                        <span class="text-sm font-medium group-hover:text-hub-600">Set Due Date</span>
                                    </div>
                                </div>

                                <div
                                    class="logbook-date-filled hidden flex items-center justify-between w-full py-3 px-4 rounded-lg border border-slate-200 bg-white shadow-sm">
                                    <div class="flex items-center gap-2 text-slate-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400"
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        <span class="logbook-date-text text-sm font-bold"></span>
                                    </div>
                                    <button type="button" onclick="clearLogbookDate(event, 'logbookDueDate')"
                                        class="relative z-40 text-slate-400 hover:text-red-500 p-1 rounded-full hover:bg-slate-100 transition-colors"><svg
                                            xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg></button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="logbookNotes">
                                Notes
                            </label>
                            <textarea
                                class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-hub-500 h-32"
                                id="logbookNotes" placeholder="Client feedback, PC issue details, etc."
                                required></textarea>
                        </div>

                        <div class="flex justify-between">
                            <button type="button" onclick="deleteLogbookEntry()" id="deleteLogEntryBtn"
                                class="bg-red-100 text-red-700 hover:bg-red-200 font-bold py-3 px-6 rounded-lg">
                                Delete
                            </button>
                            <div>
                                <button type="button" onclick="toggleModal('logbookModal')"
                                    class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-6 rounded-lg mr-3">
                                    Cancel
                                </button>
                                <button type="submit"
                                    class="bg-hub-600 hover:bg-hub-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                                    Save Entry
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="myDeskModal"
            class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
            <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
            <div
                class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl z-50">
                <form id="myDeskForm" onsubmit="saveMyDeskEntry(event)" novalidate>
                    <div class="modal-content py-6 text-left px-8">
                        <div class="flex justify-between items-center pb-3 mb-6 border-b">
                            <p class="text-2xl font-bold text-slate-800">Add New Desk Task</p>
                            <div class="modal-close cursor-pointer" onclick="toggleModal('myDeskModal')">
                                <svg class="fill-current text-slate-500 hover:text-slate-800"
                                    xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 18 18">
                                    <path
                                        d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z" />
                                </svg>
                            </div>
                        </div>
                        <input type="hidden" id="myDeskTaskId">

                        <div class="mb-4">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="myDeskTitle">Task
                                Title</label>
                            <input class="vault-input" id="myDeskTitle" type="text"
                                placeholder="E.g., Prepare Payroll Report" required>
                        </div>

                        <div class="grid grid-cols-12 gap-3 mb-4">
                            <div class="col-span-4">
                                <label class="block text-slate-700 text-sm font-bold mb-2" for="myDeskDueDate">Due
                                    Date</label>
                                <div class="relative group w-full">
                                    <!-- Hidden Input Trigger -->
                                    <input type="text" id="myDeskDueDate" readonly
                                        class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                                        onclick="openPremiumCalendar(event, 'myDeskDueDate')">

                                    <!-- Empty State -->
                                    <div id="myDeskDateEmpty"
                                        class="flex items-center justify-center w-full py-3 px-4 rounded-lg border border-dashed border-slate-300 text-slate-400 bg-slate-50 group-hover:bg-white group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:hidden"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-5 w-5 hidden group-hover:block text-hub-600" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 11v6m-3-3h6" />
                                            </svg>
                                            <span class="text-sm font-medium group-hover:text-hub-600">Set Date</span>
                                        </div>
                                    </div>

                                    <!-- Filled State -->
                                    <div id="myDeskDateFilled"
                                        class="hidden flex items-center justify-between w-full py-3 px-3 rounded-lg border border-slate-200 bg-white shadow-sm">
                                        <div class="flex items-center gap-1.5 text-slate-700 min-w-0">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4 text-slate-400 flex-shrink-0" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <span id="myDeskDateText"
                                                class="text-sm font-bold whitespace-nowrap"></span>
                                        </div>
                                        <button type="button" onclick="clearMyDeskDate(event)"
                                            class="relative z-40 text-slate-400 hover:text-red-500 p-1 rounded-full hover:bg-slate-100 transition-colors flex-shrink-0">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                                fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-span-4">
                                <label class="block text-slate-700 text-sm font-bold mb-2">Time</label>
                                <input type="time" id="myDeskScheduledTime"
                                    class="vault-input cursor-pointer text-sm font-semibold text-slate-600 w-full">

                            </div>
                            <div class="col-span-4">
                                <label class="block text-slate-700 text-sm font-bold mb-2"
                                    for="myDeskCategory">Category</label>
                                <select id="myDeskCategory" class="vault-input">
                                    <option value="Admin">Admin</option>
                                    <option value="Meeting">Meeting</option>
                                    <option value="Project">Project</option>
                                    <option value="Payroll">Payroll</option>
                                    <option value="Logbook">Logbook</option>
                                    <option value="Evaluation">Evaluation</option>
                                    <option value="Broadcast">Broadcast</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>

                        <!-- Enhanced Rich Text Editor -->
                        <div class="mb-4">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="myDeskNotes">Notes / Context
                                (Optional)</label>

                            <!-- Formatting Toolbar -->
                            <div
                                class="flex items-center gap-1 mb-2 p-2 bg-slate-50 rounded-lg border border-slate-200">
                                <button type="button" onclick="formatText('bold')"
                                    class="p-1.5 rounded hover:bg-slate-200 transition-colors" title="Bold (Ctrl+B)">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 12h9a4 4 0 014 4 4 4 0 01-4 4H6z" />
                                    </svg>
                                </button>

                                <button type="button" onclick="formatText('insertUnorderedList')"
                                    class="p-1.5 rounded hover:bg-slate-200 transition-colors" title="Bullet List">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 6v0M8 10v0M8 14v0M8 18v0" />
                                    </svg>
                                </button>

                                <button type="button" onclick="formatText('insertOrderedList')"
                                    class="p-1.5 rounded hover:bg-slate-200 transition-colors" title="Numbered List">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                    </svg>
                                </button>

                                <div class="w-px h-6 bg-slate-300 mx-1"></div>

                                <button type="button" onclick="clearFormatting()"
                                    class="p-1.5 rounded hover:bg-slate-200 transition-colors" title="Clear Formatting">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            <!-- Rich Text Editor -->
                            <div id="myDeskNotesEditor" contenteditable="true"
                                class="vault-input min-h-[80px] max-h-32 overflow-y-auto p-3 focus:ring-2 focus:ring-hub-500 focus:border-transparent resize-none"
                                placeholder="Add details, links, or context here..." oninput="updateNotesTextarea()"
                                onkeydown="handleKeyDown(event)"></div>

                            <!-- Hidden textarea for form submission -->
                            <textarea id="myDeskNotes" class="hidden"></textarea>
                        </div>

                        <div class="mb-5">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <label class="block text-slate-800 text-sm font-semibold"
                                        for="myDeskEstimatedMinutes">Estimated Time</label>
                                    <p class="text-xs text-slate-500 mt-0.5">Pick a quick block or add your own minutes.
                                    </p>
                                </div>
                                <span
                                    class="text-[11px] font-semibold text-slate-500 px-2 py-1 rounded-full bg-slate-100 border border-slate-200">Optional</span>
                            </div>
                            <div class="estimate-wrap">
                                <button type="button" class="estimate-chip" data-minutes="15"
                                    onclick="selectEstimatedTime(15, this)">15m</button>
                                <button type="button" class="estimate-chip" data-minutes="30"
                                    onclick="selectEstimatedTime(30, this)">30m</button>
                                <button type="button" class="estimate-chip" data-minutes="60"
                                    onclick="selectEstimatedTime(60, this)">1h</button>
                                <div class="estimate-chip estimate-custom"
                                    onclick="this.querySelector('input').focus()">
                                    <input id="myDeskEstimateCustom" type="number" min="1" placeholder="..."
                                        oninput="onCustomEstimateChange(this)">
                                    <span>m</span>
                                </div>
                                <button type="button" id="estimateClearBtn" onclick="clearEstimatedTime()"
                                    class="hidden text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-white transition-colors"
                                    title="Clear estimate">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <input type="hidden" id="myDeskEstimatedMinutes">
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="myDeskStatus">Initial
                                Status</label>
                            <select id="myDeskStatus" class="vault-input">
                                <option value="OnTheTable">On The Table</option>
                                <option value="AtHand">At Hand</option>
                                <option value="InDrawer">In the Drawer (Queued)</option>
                            </select>
                        </div>

                        <div class="flex justify-end">
                            <button type="button" onclick="toggleModal('myDeskModal')"
                                class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-6 rounded-lg mr-3">Cancel</button>
                            <button type="submit"
                                class="bg-hub-600 hover:bg-hub-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">Save
                                Task</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Calendar Event Modal -->
        <div id="modal-myDesk-calendar-event"
            class="modal opacity-0 pointer-events-none fixed inset-0 z-[60] flex items-center justify-center">
            <div class="modal-backdrop absolute inset-0" onclick="toggleModal('modal-myDesk-calendar-event')"></div>
            <div
                class="modal-content bg-white dark:bg-slate-900 rounded-2xl w-full max-w-md border border-slate-200/60 dark:border-slate-700/60 overflow-hidden relative">
                <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white" id="myDesk-calendar-event-modal-title">
                        New Event</h3>
                </div>
                <form onsubmit="saveMyDeskCalendarEvent(event)" class="p-6 space-y-4">
                    <input type="hidden" id="myDesk-calendar-event-id">

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Event
                            Title</label>
                        <input type="text" id="myDesk-calendar-event-title" required
                            class="vault-input w-full text-sm shadow-sm font-semibold" placeholder="e.g. Team Meeting">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Start
                                Date</label>
                            <input type="date" id="myDesk-calendar-event-start" required
                                class="smart-date-picker vault-input" onchange="updateDateInput(this)"
                                onclick="this.showPicker()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">End
                                Date</label>
                            <input type="date" id="myDesk-calendar-event-end" required
                                class="smart-date-picker vault-input" onchange="updateDateInput(this)"
                                onclick="this.showPicker()">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Color</label>
                        <div id="myDesk-calendar-event-colors" class="flex flex-wrap gap-2"></div>
                        <input type="hidden" id="myDesk-calendar-event-color" value="bg-blue-500">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1.5">Notes
                            (Optional)</label>
                        <textarea id="myDesk-calendar-event-notes" class="vault-input w-full text-sm h-24 resize-none"
                            placeholder="Add notes..."></textarea>
                    </div>

                    <div class="flex justify-between items-center pt-4 border-t border-slate-200 dark:border-slate-700">
                        <button type="button" onclick="deleteMyDeskCalendarEvent()"
                            id="myDesk-calendar-event-delete-btn"
                            class="text-red-600 hover:text-red-700 text-sm font-bold hidden">Delete</button>
                        <div class="flex gap-3 ml-auto">
                            <button type="button" onclick="toggleModal('modal-myDesk-calendar-event')"
                                class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg text-sm">Cancel</button>
                            <button type="submit"
                                class="bg-hub-600 hover:bg-hub-700 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-md">Save
                                Event</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="broadcastModal"
            class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
            <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
            <div
                class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-xl mx-auto rounded-2xl shadow-2xl z-50">
                <form id="broadcastForm" onsubmit="saveBroadcast(event)">
                    <div class="modal-content py-6 text-left px-8">
                        <div class="flex justify-between items-center pb-3 mb-4 border-b">
                            <p class="text-2xl font-bold text-slate-800" id="broadcastModalTitle">New Broadcast</p>
                            <div class="modal-close cursor-pointer" onclick="toggleModal('broadcastModal')">
                                <svg class="fill-current text-slate-500 hover:text-slate-800"
                                    xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 18 18">
                                    <path
                                        d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z" />
                                </svg>
                            </div>
                        </div>
                        <input type="hidden" id="broadcastId">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2" for="broadcastCategory">
                                    Category
                                </label>
                                <select id="broadcastCategory"
                                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-hub-500"
                                    required>
                                    <option value="General/Others">General/Others</option>
                                    <option value="Engagement Program">Engagement Program</option>
                                    <option value="Wellness Program">Wellness Program</option>
                                    <option value="HR Update">HR Update</option>
                                    <option value="IT Update">IT Update</option>
                                    <option value="Weather Update">Weather Update</option>
                                    <option value="Workday Update">Workday Update</option>
                                    <option value="Cluster Update">Cluster Update</option>
                                    <option value="Team-Specific Update">Team-Specific Update</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2" for="broadcastTitle">
                                    Title
                                </label>
                                <input
                                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-hub-500"
                                    id="broadcastTitle" type="text" placeholder="E.g., New PTO Policy" required>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="broadcastDueDate">
                                Follow-up Due Date (Optional)
                            </label>
                            <div class="relative group w-full">
                                <input type="text" id="broadcastDueDate" readonly
                                    class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                                    onclick="openPremiumCalendar(event, 'broadcastDueDate')">

                                <div id="broadcastDateEmpty"
                                    class="flex items-center justify-center w-full py-3 px-4 rounded-lg border border-dashed border-slate-300 text-slate-400 bg-slate-50 group-hover:bg-white group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                                    <div class="flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:hidden"
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            class="h-5 w-5 hidden group-hover:block text-hub-600" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 11v6m-3-3h6" />
                                        </svg>
                                        <span class="text-sm font-medium group-hover:text-hub-600">Set Due Date</span>
                                    </div>
                                </div>

                                <div id="broadcastDateFilled"
                                    class="hidden flex items-center justify-between w-full py-3 px-4 rounded-lg border border-slate-200 bg-white shadow-sm">
                                    <div class="flex items-center gap-2 text-slate-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400"
                                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        <span id="broadcastDateText" class="text-sm font-bold"></span>
                                    </div>
                                    <button type="button" onclick="clearBroadcastDate(event)"
                                        class="relative z-40 text-slate-400 hover:text-red-500 p-1 rounded-full hover:bg-slate-100 transition-colors"><svg
                                            xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg></button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="broadcastNotes">
                                Key Points / Notes (Optional)
                            </label>
                            <textarea
                                class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-hub-500 h-24"
                                id="broadcastNotes"
                                placeholder="E.g., Must be communicated by EOD Friday..."></textarea>
                        </div>
                        <div class="flex justify-between">
                            <button type="button" onclick="deleteBroadcast()" id="deleteBroadcastBtn"
                                class="bg-red-100 text-red-700 hover:bg-red-200 font-bold py-3 px-6 rounded-lg">
                                Delete
                            </button>
                            <div>
                                <button type="button" onclick="toggleModal('broadcastModal')"
                                    class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-6 rounded-lg mr-3">
                                    Cancel
                                </button>
                                <button type="submit"
                                    class="bg-hub-600 hover:bg-hub-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">
                                    Save Broadcast
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="broadcastTrackModal"
            class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
            <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
            <div class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-4xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto"
                style="max-height: 90vh;">
                <div class="modal-content py-6 text-left px-8">
                    <div class="flex justify-between items-start pb-3 mb-4 border-b">
                        <div class="flex-1">
                            <p class="text-2xl font-bold text-slate-800" id="broadcastTrackTitle">Track Update</p>
                            <div class="flex items-center gap-3 mt-2">
                                <p class="text-sm font-semibold text-slate-700" id="broadcastTrackProgress">0/0 Acknowledged</p>
                                <span class="text-sm text-slate-500" id="broadcastTrackPercentage">(0%)</span>
                            </div>
                            <div class="w-full bg-slate-200 h-2 rounded-full mt-2">
                                <div id="broadcastTrackProgressBar" class="bg-hub-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="modal-close cursor-pointer" onclick="toggleModal('broadcastTrackModal')">
                            <svg class="fill-current text-slate-500 hover:text-slate-800"
                                xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 18 18">
                                <path
                                    d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z" />
                            </svg>
                        </div>
                    </div>
                    <input type="hidden" id="broadcastTrackId">
                    <input type="hidden" id="broadcastTrackFilter" value="all">
                    <input type="hidden" id="broadcastTrackSort" value="name-asc">

                    <div class="relative mb-4">
                        <input type="text" id="broadcastSearchInput"
                            oninput="openBroadcastTrackModal(document.getElementById('broadcastTrackId').value)"
                            placeholder="Search team..."
                            class="w-full pl-10 pr-3 py-2.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-hub-500 focus:border-hub-500">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>

                    <!-- Filter and Sort Controls -->
                    <div class="flex flex-wrap gap-3 mb-4 items-center justify-between">
                        <div class="flex gap-2">
                            <button type="button" onclick="setBroadcastTrackFilter('all')" 
                                class="broadcast-filter-btn px-4 py-2 text-sm font-semibold rounded-lg transition-all border-2 border-slate-300 bg-slate-50 text-slate-700"
                                data-filter="all">
                                All
                            </button>
                            <button type="button" onclick="setBroadcastTrackFilter('acknowledged')" 
                                class="broadcast-filter-btn px-4 py-2 text-sm font-semibold rounded-lg transition-all border-2 border-transparent bg-white text-slate-600 hover:bg-slate-50"
                                data-filter="acknowledged">
                                <span class="inline-flex items-center gap-1.5">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    Acknowledged
                                </span>
                            </button>
                            <button type="button" onclick="setBroadcastTrackFilter('pending')" 
                                class="broadcast-filter-btn px-4 py-2 text-sm font-semibold rounded-lg transition-all border-2 border-transparent bg-white text-slate-600 hover:bg-slate-50"
                                data-filter="pending">
                                <span class="inline-flex items-center gap-1.5">
                                    <svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                    </svg>
                                    Pending
                                </span>
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-slate-600">Sort:</label>
                            <select id="broadcastTrackSortSelect" onchange="setBroadcastTrackSort(this.value)"
                                class="text-sm border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-hub-500 focus:border-hub-500">
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="status-ack">Acknowledged First</option>
                                <option value="status-pending">Pending First</option>
                                <option value="account">By Account</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[32rem] overflow-y-auto pr-2" id="broadcastTmChecklist"></div>

                    <div class="flex justify-between items-center mt-6 pt-4 border-t">
                        <button type="button" onclick="markAllBroadcastAck()"
                            class="bg-green-100 text-green-700 hover:bg-green-200 text-sm font-bold py-3 px-4 rounded-lg transition-all">
                            Mark All Acknowledged
                        </button>
                        <button type="button" onclick="toggleModal('broadcastTrackModal')"
                            class="bg-hub-600 hover:bg-hub-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all">
                            Done
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- CLOSING ACTIONHUB CONTAINER -->

    <!-- START PULSECHECK CONTAINER -->
    <div id="app-container-2" class="app-view" style="display:none;">
        <!-- PulseCheck Toolbar (Replaces Navigation Actions) -->
        <div class="bg-dcx-blue py-2 px-4">
        </div>

        <!-- BACKUP REMINDER BANNER -->
        <div id="backupReminder" class="hidden bg-amber-50 border-b border-amber-100 px-4 py-3">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600 mr-2" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd" />
                    </svg>
                    <p class="text-sm font-medium text-amber-800">
                        Data Safety Alert: You haven't backed up your database in over 7 days.
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="exportData()"
                        class="text-sm bg-amber-100 hover:bg-amber-200 text-amber-800 font-bold py-1 px-3 rounded transition-colors">
                        Backup Now
                    </button>
                    <button onclick="dismissBackupAlert()"
                        class="text-amber-600 hover:text-amber-800 hover:bg-amber-100 p-1 rounded transition-colors"
                        title="Dismiss alert">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex-grow">

            <!-- TABS -->
            <div class="sticky-tabs-container mb-8 overflow-x-auto pb-1">
                <div class="segmented-nav">
                    <button id="tabTeamInfo" onclick="switchTab('teamInfo')"
                        class="tab-pill-active px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg> Team Info
                    </button>
                    <button id="tabPulse" onclick="switchTab('pulse')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="h-4 w-4">
                            <path
                                d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5" />
                            <path d="M3.22 13H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27" />
                        </svg> Monthly Pulse
                    </button>
                    <button id="tabTimesheets" onclick="switchTab('timesheets')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg> Timesheet Tracker
                    </button>
                    <button id="tabRollCall" onclick="switchTab('rollCall')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg> Morning Roll Call
                    </button>
                    <button id="tabReliability" onclick="switchTab('reliability')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg> Reliability
                    </button>
                    <button id="tabCapacity" onclick="switchTab('capacity')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                        Capacity
                    </button>
                    <button id="tabQuickLinks" onclick="switchTab('quickLinks')"
                        class="tab-pill-inactive px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                        </svg>
                        Quick Links
                    </button>
                </div>
            </div>

            <!-- ================= TEAM INFO VIEW ================= -->
            <div id="quickLinksView" class="hidden fade-in">
                <!-- Toolbar -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex items-center gap-3 w-full md:w-auto">
                        <div class="relative flex-1 md:w-64">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input type="text" id="quickLinksSearch" oninput="renderQuickLinks()"
                                placeholder="Search links..."
                                class="pl-10 block w-full rounded-lg border border-slate-300 bg-white py-2.5 text-sm placeholder-slate-400 focus:border-dcx-blue focus:outline-none focus:ring-1 focus:ring-dcx-blue shadow-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-slate-500 font-medium whitespace-nowrap">Sort by:</span>
                            <select id="quickLinksSortSelect" onchange="renderQuickLinks()"
                                class="bg-white border border-slate-300 text-sm rounded-lg focus:ring-dcx-blue focus:border-dcx-blue block p-2 cursor-pointer font-medium text-slate-700">
                                <option value="custom">Custom Order</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="category">Category</option>
                                <option value="dateAdded">Date Added</option>
                            </select>

                            <div class="h-6 w-px bg-slate-300 mx-2"></div>

                            <button id="viewToggleGrid" onclick="toggleQuickLinksView('grid')"
                                class="p-2 rounded-lg text-dcx-blue bg-blue-50 hover:bg-blue-100 transition-colors"
                                title="Grid View">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                </svg>
                            </button>
                            <button id="viewToggleGroup" onclick="toggleQuickLinksView('group')"
                                class="p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors"
                                title="Grouped View">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button onclick="openQuickLinkModal()"
                        class="bg-dcx-blue hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition-colors flex items-center gap-2 text-sm whitespace-nowrap">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Add Link
                    </button>
                </div>

                <!-- Links Grid -->
                <div id="quickLinksGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Links will be injected here -->
                </div>

                <!-- Empty State (Hidden by default) -->
                <div id="quickLinksEmptyState" class="hidden text-center py-20">
                    <div class="bg-slate-50 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-slate-400" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-slate-700 mb-2">No Links Found</h3>
                    <p class="text-slate-500 mb-6 max-w-md mx-auto">Add your frequently used tools, documents, and
                        resources here for quick access.</p>
                    <button onclick="openQuickLinkModal()" class="text-dcx-blue font-bold hover:underline">Add your
                        first link</button>
                </div>
            </div>

            <!-- ================= TEAM INFO VIEW ================= -->
            <div id="teamInfoView" class="fade-in">
                <div id="pulse-check-roster-actions" class="mb-8 hidden"></div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200 mb-8">
                    <!-- Toolbar -->
                    <div id="team-info-card-header"
                        class="p-4 bg-slate-50 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="relative w-full md:w-1/3">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input type="text" id="teamSearchInput" oninput="renderTeamInfo()"
                                placeholder="Search team..."
                                class="pl-10 block w-full rounded-lg border border-slate-300 bg-white py-2 text-sm placeholder-slate-400 focus:border-dcx-blue focus:outline-none focus:ring-1 focus:ring-dcx-blue">
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openColorManager()"
                                class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 hover:text-dcx-blue px-3 py-2 rounded-lg text-sm font-bold flex items-center shadow-sm transition-colors mr-2">
                                <span class="mr-2"></span> Colors
                            </button>
                            <span class="text-sm text-slate-500 font-medium">Sort by:</span>
                            <select id="teamSortSelect" onchange="renderTeamInfo()"
                                class="bg-white border border-slate-300 text-sm rounded-lg focus:ring-dcx-blue focus:border-dcx-blue block p-2 cursor-pointer font-medium text-slate-700">
                                <option value="account">Account</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="hireDate">Hire Date</option>
                            </select>
                            <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                                <button onclick="toggleTeamInfoView('list')" id="btnTeamList"
                                    class="p-1.5 rounded-md text-slate-600 bg-white shadow-sm transition-all"
                                    title="List View">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6h16M4 12h16M4 18h16" />
                                    </svg>
                                </button>
                                <button onclick="toggleTeamInfoView('grid')" id="btnTeamGrid"
                                    class="p-1.5 rounded-md text-slate-400 hover:text-slate-600 hover:bg-white/50 transition-all"
                                    title="Grid View">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Table with Sticky Header and Max Height -->
                    <div id="teamInfoListView" class="overflow-x-auto max-h-[70vh]">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th scope="col"
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider border-b shadow-sm">
                                        Account</th>
                                    <th scope="col"
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider border-b shadow-sm">
                                        Team Member</th>
                                    <th scope="col"
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider border-b shadow-sm">
                                        Role</th>
                                    <th scope="col"
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider border-b shadow-sm">
                                        Hire Date</th>
                                    <th scope="col"
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider border-b shadow-sm">
                                        EMP ID</th>
                                    <th scope="col"
                                        class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider border-b shadow-sm">
                                        Point of Contact (POC)</th>
                                    <!-- Removed separate POC Email header -->
                                </tr>
                            </thead>
                            <tbody id="teamInfoTableBody" class="bg-white divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                    <div id="teamInfoGridView"
                        class="hidden p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
                    <div class="bg-slate-50 p-3 text-xs text-center text-slate-500 border-t">
                         Tip: Click on any row to edit member details.
                    </div>
                </div>
            </div>

            <!-- ================= PULSE VIEW (Merged Dashboard & Trends) ================= -->
            <div id="pulseView" class="hidden fade-in">
                <!-- DASHBOARD SECTION -->
                <div id="pulseTopControls" class="flex flex-col xl:flex-row justify-between items-center mb-8 gap-4">

                    <!-- Month Selector -->
                    <div class="flex items-center bg-white p-3 rounded-xl shadow-sm order-1">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-100 rounded-full text-slate-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="currentMonthDisplay"
                            class="text-xl font-bold mx-6 min-w-[180px] text-center text-dcx-blue">October 2025</h2>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-100 rounded-full text-slate-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>

                    <!-- Progress Bar -->
                    <div class="w-full md:w-1/3 bg-white p-4 rounded-xl shadow-sm order-3 md:order-2">
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-semibold text-slate-600">Monthly Coverage</span>
                            <span id="progressText" class="text-sm font-bold text-dcx-blue">0/0 Completed</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-4 overflow-hidden">
                            <div id="progressBar" class="bg-dcx-light h-4 rounded-full transition-all duration-500"
                                style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3 order-2 md:order-3">
                        <button onclick="togglePulseMode('trends')"
                            class="bg-dcx-blue text-white px-4 py-2 rounded-lg shadow-sm font-bold text-sm hover:bg-dcx-light transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                            Trends
                        </button>
                        <div class="bg-white flex items-center px-3 rounded-lg shadow-sm">
                            <span class="text-sm text-slate-500 mr-2">Sort by:</span>
                            <select id="sortSelect" onchange="renderDashboard()"
                                class="bg-transparent font-semibold text-dcx-blue focus:outline-none py-2 cursor-pointer">
                                <option value="name">Name</option>
                                <option value="account">Account</option>
                                <option value="role">Role</option>
                                <option value="ews">EWS Risk</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="pulseDashboardContent">
                    <!-- DASHBOARD STATS -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-slate-300">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Not Started</p>
                            <p id="statNotStarted" class="text-3xl font-extrabold text-slate-700 mt-1">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-400">
                            <p class="text-xs font-bold text-green-600 uppercase tracking-wider">Positive</p>
                            <p id="statGood" class="text-3xl font-extrabold text-slate-700 mt-1">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-400">
                            <p class="text-xs font-bold text-yellow-600 uppercase tracking-wider">Neutral</p>
                            <p id="statMid" class="text-3xl font-extrabold text-slate-700 mt-1">0</p>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-400">
                            <p class="text-xs font-bold text-red-600 uppercase tracking-wider">Concerning</p>
                            <p id="statBad" class="text-3xl font-extrabold text-slate-700 mt-1">0</p>
                        </div>
                    </div>

                    <!-- MAIN GRID -->
                    <div id="tmGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12"></div>
                </div>

                <!-- TRENDS SECTION -->
                <div id="pulseTrendsContent" class="hidden border-t border-slate-200 pt-8 mt-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-dcx-blue" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                            Team Trends
                        </h2>
                        <button onclick="togglePulseMode('dashboard')"
                            class="text-slate-500 hover:text-dcx-blue font-bold text-sm flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            Back to Dashboard
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Team Vibe (Last 12 Months)</h3>
                        <p class="text-sm text-slate-500 mb-6">Average sentiment across all active team members.</p>
                        <div class="h-64">
                            <canvas id="teamTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm overflow-hidden">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-slate-800 mb-1">Individual Heatmap</h3>
                                <p class="text-sm text-slate-500">12-month view. Toggle to see EWS Risk history.</p>
                            </div>
                            <div class="bg-slate-100 p-1 rounded-lg flex items-center">
                                <button onclick="toggleHeatmapMode('sentiment')" id="hmBtnSentiment"
                                    class="px-3 py-1.5 text-sm font-semibold rounded-md bg-white shadow-sm text-dcx-blue transition-all">Sentiment</button>
                                <button onclick="toggleHeatmapMode('ews')" id="hmBtnEws"
                                    class="px-3 py-1.5 text-sm font-semibold rounded-md text-slate-500 hover:text-slate-700 transition-all">EWS
                                    Risk</button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr id="heatmapHeader"></tr>
                                </thead>
                                <tbody id="heatmapBody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= TIMESHEETS VIEW ================= -->
            <div id="timesheetsView" class="hidden fade-in">
                <!-- TOP CONTROLS TIMESHEET -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
                    <div class="w-full md:w-1/3 order-2 md:order-1 flex items-end gap-2">
                        <div>
                            <label class="block text-slate-700 text-sm font-bold mb-2">
                                Tracking Date
                            </label>
                            <div id="tsDateDisplay"
                                class="bg-white border border-slate-300 px-4 py-3 rounded-xl shadow-sm font-bold text-slate-700 text-lg">
                                <!-- Date will be inserted by JS -->
                            </div>
                        </div>
                        <button onclick="resetTimesheet()"
                            class="h-12 bg-red-100 hover:bg-red-200 text-red-700 px-4 rounded-xl font-bold flex items-center transition-colors shadow-sm border border-red-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Reset
                        </button>
                    </div>
                    <!-- Progress Bar Timesheet -->
                    <div
                        class="w-full md:w-2/3 bg-white p-5 rounded-xl shadow-sm order-1 md:order-2 border border-blue-50">
                        <div class="flex justify-between mb-3 items-end">
                            <div>
                                <h3 class="text-lg font-bold text-slate-800">Timesheet Submission Progress</h3>
                                <p class="text-sm text-slate-500" id="tsProgressSubtitle">Tracking for today</p>
                            </div>
                            <span id="tsProgressText" class="text-2xl font-extrabold text-dcx-blue">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-6 overflow-hidden">
                            <div id="tsProgressBar"
                                class="bg-dcx-blue h-6 rounded-full transition-all duration-500 flex items-center justify-end pr-3 text-xs font-bold text-white"
                                style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- CONTROLS & LIST -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                    <div class="p-4 bg-slate-50 border-b flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h3 class="font-bold text-slate-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-slate-500" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                            Team Roster Status
                        </h3>

                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <select id="tsAccountFilter" onchange="renderTimesheetView()"
                                class="bg-white border border-slate-300 text-sm rounded-lg focus:ring-dcx-blue focus:border-dcx-blue block w-full sm:w-auto p-2 cursor-pointer font-medium text-slate-700">
                                <option value="all">All Accounts</option>
                            </select>

                            <div class="h-6 w-px bg-slate-300 hidden sm:block"></div>

                            <div class="flex items-center whitespace-nowrap">
                                <span class="text-sm text-slate-500 mr-2 hidden sm:block">Sort:</span>
                                <select id="tsSortSelect" onchange="renderTimesheetView()"
                                    class="bg-white border border-slate-300 text-sm rounded-lg focus:ring-dcx-blue focus:border-dcx-blue block p-2 cursor-pointer font-medium text-slate-700">
                                    <option value="status">Pending First</option>
                                    <option value="name">Name (A-Z)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="divide-y divide-slate-100" id="tsList"></div>
                </div>
            </div>

            <!-- ================= ROLL CALL VIEW ================= -->
            <div id="rollCallView" class="hidden fade-in">
                <!-- TOP CONTROLS ROLL CALL - Improved Layout -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-8">
                    <!-- Card 1: Date Display with Reset -->
                    <div class="bg-white p-3 rounded-xl shadow-sm flex items-center justify-between">
                        <span id="rcDateDisplay" class="text-base font-bold text-slate-700 whitespace-nowrap"></span>
                        <button onclick="resetDailyAttendance()"
                            class="ml-3 text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-1.5 px-3 rounded-full transition-colors flex items-center whitespace-nowrap flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Reset Today
                        </button>
                    </div>

                    <!-- Card 2: Attendance Summary (Button moved out) -->
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <span
                                class="text-xs font-bold text-slate-500 uppercase tracking-wider whitespace-nowrap">Attendance</span>
                            <span id="rcProgressText"
                                class="text-xs font-bold text-dcx-blue whitespace-nowrap">0/0</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-3">
                            <div id="rcProgressBar" class="bg-dcx-blue h-3 rounded-full transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Card 3: Search Bar -->
                    <div class="bg-white p-4 rounded-xl shadow-sm flex items-center">
                        <div class="relative flex-1 w-full">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input type="text" id="rcSearch" oninput="renderRollCallView()"
                                placeholder="Search team members..."
                                class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-dcx-blue focus:border-dcx-blue text-sm">
                        </div>
                    </div>

                    <!-- Card 4: Action Buttons (Now includes Mark All Present) -->
                    <div class="bg-white p-3 rounded-xl shadow-sm flex flex-col gap-2">
                        <button onclick="markRemainingPresent()"
                            class="w-full bg-green-100 hover:bg-green-200 text-green-800 px-3 py-2 rounded-lg text-sm font-bold flex items-center justify-center transition-colors whitespace-nowrap">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                    clip-rule="evenodd" />
                            </svg>
                            Mark All Present
                        </button>
                        <div class="flex gap-2">
                            <button onclick="saveRollCallToAttendanceHistory()"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2.5 rounded-lg font-bold flex items-center justify-center transition-colors shadow-sm whitespace-nowrap text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7" />
                                </svg>
                                Save
                            </button>
                            <button onclick="toggleSnapshotMode()"
                                class="flex-1 bg-white text-dcx-blue hover:bg-blue-50 px-3 py-2.5 rounded-lg font-bold flex items-center justify-center transition-colors shadow-sm border border-blue-100 whitespace-nowrap text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Snapshot
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ROLL CALL LIST -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                    <div
                        class="bg-slate-50 px-6 py-3 border-b border-slate-200 flex justify-between items-center text-xs font-bold text-slate-500 uppercase tracking-wider sticky top-0 z-10">
                        <div class="w-1/3 md:w-1/4">Team Member</div>
                        <div class="w-1/3 md:w-5/12 text-center">Morning Status</div>
                        <div class="w-1/3 text-right pr-4">Action</div>
                    </div>
                    <div class="divide-y divide-slate-100 p-4 space-y-2 max-h-[70vh] overflow-y-auto" id="rcRosterList">
                    </div>
                </div>
            </div>

            <!-- ================= RELIABILITY VIEW ================= -->
            <div id="reliabilityView" class="hidden fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div class="flex items-center bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                        <button onclick="changeReliabilityMonth(-1)"
                            class="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="reliabilityMonthDisplay"
                            class="text-lg font-bold mx-4 min-w-[140px] text-center text-slate-800">October 2025</h2>
                        <button onclick="changeReliabilityMonth(1)"
                            class="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>

                    <!-- Legend -->
                    <div
                        class="flex items-center gap-4 bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex-wrap">
                        <div class="flex items-center gap-1.5">
                            <div class="w-3 h-3 rounded-full tile-present shadow-sm"></div>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Present (100%)</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-3 h-3 rounded-full tile-late shadow-sm"></div>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Late (50%)</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-3 h-3 rounded-full tile-unplanned shadow-sm"></div>
                            <span class="text-xs text-slate-500 dark:text-slate-400">Unplanned (0%)</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-3 h-3 rounded-full tile-pto shadow-sm"></div>
                            <span class="text-xs text-slate-500 dark:text-slate-400">PTO (Excluded)</span>
                        </div>
                    </div>
                </div>

                <!-- Search & Filter Bar -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4">
                    <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
                        <!-- Search Input -->
                        <div class="flex-1 min-w-[200px]">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <input type="text" id="reliabilitySearch" placeholder="Search team members..."
                                    oninput="applyReliabilityFilters()"
                                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-dcx-blue focus:border-dcx-blue text-sm">
                            </div>
                        </div>

                        <!-- Status Filter -->
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-semibold text-slate-600 whitespace-nowrap">Status:</label>
                            <select id="reliabilityStatusFilter" onchange="applyReliabilityFilters()"
                                class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-dcx-blue focus:border-dcx-blue text-sm">
                                <option value="all">All</option>
                                <option value="unplanned">Has Unplanned</option>
                            </select>
                        </div>

                        <!-- Account Filter -->
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-semibold text-slate-600 whitespace-nowrap">Account:</label>
                            <select id="reliabilityAccountFilter" onchange="applyReliabilityFilters()"
                                class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-dcx-blue focus:border-dcx-blue text-sm min-w-[150px]">
                                <option value="all">All Accounts</option>
                            </select>
                        </div>

                        <!-- Sort Options -->
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-semibold text-slate-600 whitespace-nowrap">Sort:</label>
                            <select id="reliabilitySort" onchange="applyReliabilityFilters()"
                                class="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-dcx-blue focus:border-dcx-blue text-sm">
                                <option value="name">By Name</option>
                                <option value="score-asc">Score (Low to High)</option>
                                <option value="score-desc">Score (High to Low)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-slate-200">
                        <button onclick="markAllPresentToday()"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold text-sm transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                            Mark All Present Today
                        </button>

                        <button id="reliabilityBulkEditToggle" onclick="toggleBulkEditMode()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold text-sm transition-colors flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                            </svg>
                            Bulk Edit Mode
                        </button>

                        <div id="reliabilityBulkActions" class="hidden flex items-center gap-2">
                            <span class="text-sm text-slate-600 font-semibold">Selected: <span
                                    id="reliabilitySelectedCount">0</span></span>
                            <button onclick="applyBulkStatus('present')"
                                class="px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded text-xs font-semibold">Set
                                Present</button>
                            <button onclick="applyBulkStatus('late')"
                                class="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white rounded text-xs font-semibold">Set
                                Late</button>
                            <button onclick="applyBulkStatus('unplanned')"
                                class="px-3 py-1.5 bg-rose-500 hover:bg-rose-600 text-white rounded text-xs font-semibold">Set
                                Unplanned</button>
                            <button onclick="applyBulkStatus('pto')"
                                class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs font-semibold">Set
                                PTO</button>
                            <button onclick="clearBulkSelection()"
                                class="px-3 py-1.5 bg-slate-500 hover:bg-slate-600 text-white rounded text-xs font-semibold">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- RELIABILITY MATRIX GRID -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="max-h-[calc(100vh-280px)] overflow-auto border rounded-xl shadow-inner">
                        <div id="reliabilityMatrixGrid" class="min-w-max">
                            <!-- Grid will be generated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Context Menu -->
                <div id="reliabilityContextMenu">
                    <button onclick="contextMenuSetStatus('present')">
                        <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
                        <span>Set Present</span>
                    </button>
                    <button onclick="contextMenuSetStatus('late')">
                        <div class="w-3 h-3 rounded-full bg-amber-400"></div>
                        <span>Set Late</span>
                    </button>
                    <button onclick="contextMenuSetStatus('unplanned')">
                        <div class="w-3 h-3 rounded-full bg-rose-500"></div>
                        <span>Set Unplanned</span>
                    </button>
                    <button onclick="contextMenuSetStatus('pto')">
                        <div class="w-3 h-3 rounded-full bg-blue-400"></div>
                        <span>Set PTO</span>
                    </button>
                    <button onclick="contextMenuSetStatus(null)">
                        <span>Clear Status</span>
                    </button>
                </div>
            </div>

            <div id="capacityView" class="hidden fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex items-center bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                        <button onclick="changeCapacityMonth(-1)"
                            class="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <h2 id="capacityMonthDisplay"
                            class="text-lg font-bold mx-4 min-w-[140px] text-center text-slate-800">October 2025</h2>
                        <button onclick="changeCapacityMonth(1)"
                            class="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-center gap-4">
                        <div
                            class="flex items-center gap-2 text-xs font-bold text-slate-500 bg-white px-3 py-2 rounded-lg border border-slate-200 shadow-sm">
                            <span class="flex items-center gap-1"><span
                                    class="w-2 h-2 rounded-full bg-amber-400"></span> 2 Out (Risk)</span>
                            <span class="w-px h-3 bg-slate-300 mx-1"></span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span>
                                3+ Out (Critical)</span>
                        </div>
                        <button onclick="openCapacityModal()"
                            class="bg-dcx-blue hover:bg-dcx-light text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition-all flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Log Leave
                        </button>
                        <button onclick="openCaptoModal()"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition-all flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Log CAPTO
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="grid grid-cols-7 border-b border-slate-200 bg-slate-50">
                        <div class="py-2 text-center text-xs font-bold text-slate-400 uppercase">Sun</div>
                        <div class="py-2 text-center text-xs font-bold text-slate-400 uppercase">Mon</div>
                        <div class="py-2 text-center text-xs font-bold text-slate-400 uppercase">Tue</div>
                        <div class="py-2 text-center text-xs font-bold text-slate-400 uppercase">Wed</div>
                        <div class="py-2 text-center text-xs font-bold text-slate-400 uppercase">Thu</div>
                        <div class="py-2 text-center text-xs font-bold text-slate-400 uppercase">Fri</div>
                        <div class="py-2 text-center text-xs font-bold text-slate-400 uppercase">Sat</div>
                    </div>
                    <div id="capacityGrid"
                        class="grid grid-cols-7 min-h-[600px] bg-slate-200 gap-px border-b border-slate-200"></div>
                </div>
            </div>

        </main>

        <!-- PULSECHECK MODALS -->
        <div id="checkinModal"
            class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
            <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
            <div class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto"
                style="max-height: 90vh;">
                <div class="modal-content py-6 text-left px-8">
                    <div class="flex justify-between items-center pb-3 mb-4 border-b">
                        <div>
                            <p class="text-2xl font-bold text-slate-800" id="modalTmName">TM Name</p>
                            <p class="text-sm text-slate-500" id="modalTmAccountRole">Account - Role</p>
                        </div>

                        <div class="modal-close cursor-pointer z-50" onclick="toggleCheckinModal()">
                            <svg class="fill-current text-slate-500 hover:text-slate-800"
                                xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 18 18">
                                <path
                                    d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z" />
                            </svg>
                        </div>
                    </div>

                    <form id="checkinForm" onsubmit="saveCheckin(event)">
                        <input type="hidden" id="modalTmId">

                        <div class="mb-6 grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2" for="checkinDate">
                                    Check-in Date
                                </label>
                                <div class="relative group w-full">
                                    <input
                                        class="date-input-hidden-placeholder shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-dcx-blue bg-transparent relative z-10"
                                        id="checkinDate" type="date" required onchange="updateDateInput(this)">
                                    <div
                                        class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                                        <div class="empty-state-icons flex items-center justify-center w-full h-full">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-5 w-5 text-slate-400 transition-all duration-200 group-hover:opacity-0 group-hover:scale-75"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-6 w-6 text-dcx-blue absolute transition-all duration-200 opacity-0 scale-75 group-hover:opacity-100 group-hover:scale-100"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 4v16m8-8H4" />
                                            </svg>
                                        </div>
                                        <div
                                            class="filled-state-text hidden flex items-center font-bold text-slate-700">
                                            <span class="date-text mr-2 text-sm"></span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2" for="checkinEws">
                                    EWS Risk Status
                                </label>
                                <select id="checkinEws"
                                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-dcx-blue bg-white font-semibold">
                                    <option value="green"> Green</option>
                                    <option value="amber"> Amber</option>
                                    <option value="red"> Red</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-700 text-sm font-bold mb-2">
                                Sentiment Vibe
                            </label>
                            <div class="grid grid-cols-3 gap-3">
                                <label class="cursor-pointer">
                                    <input type="radio" name="sentiment" value="good" class="peer sr-only" required>
                                    <div
                                        class="text-center py-3 px-2 rounded-xl border-2 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 hover:bg-slate-50">
                                        <div class="text-2xl mb-1"></div>
                                        <div class="text-xs font-bold text-slate-600">Positive</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="sentiment" value="mid" class="peer sr-only">
                                    <div
                                        class="text-center py-3 px-2 rounded-xl border-2 transition-all peer-checked:border-yellow-500 peer-checked:bg-yellow-50 hover:bg-slate-50">
                                        <div class="text-2xl mb-1"></div>
                                        <div class="text-xs font-bold text-slate-600">Neutral</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="sentiment" value="bad" class="peer sr-only">
                                    <div
                                        class="text-center py-3 px-2 rounded-xl border-2 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 hover:bg-slate-50">
                                        <div class="text-2xl mb-1"></div>
                                        <div class="text-xs font-bold text-slate-600">Concerning</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="checkinNotes">
                                Key Discussion Points / Action Items
                            </label>
                            <textarea
                                class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-dcx-blue h-32"
                                id="checkinNotes"
                                placeholder="E.g., Discussed PTO for next month. Feeling overwhelmed by Client X's new process..."></textarea>
                        </div>

                        <div class="flex justify-end">
                            <button type="button" onclick="clearCheckin()"
                                class="mr-auto text-red-500 hover:text-red-700 text-sm font-semibold">
                                Delete Entry
                            </button>
                            <button type="button" onclick="toggleCheckinModal()"
                                class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-6 rounded-lg mr-3">
                                Cancel
                            </button>
                            <button type="submit"
                                class="bg-dcx-blue hover:bg-dcx-light text-white font-bold py-3 px-6 rounded-lg shadow-md">
                                Save Check-in
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="ewsModal"
            class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
            <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
            <div
                class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-sm mx-auto rounded-2xl shadow-2xl z-50">
                <div class="modal-content py-6 text-left px-8">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Update EWS Status</h3>
                    <input type="hidden" id="ewsTmId">
                    <div class="space-y-3">
                        <button onclick="saveEwsStatus('green')"
                            class="w-full p-4 rounded-xl border-2 font-bold text-left flex items-center hover:bg-slate-50 transition-all ews-green border-green-600">
                            <span class="text-xl mr-3"></span> Green Risk
                        </button>
                        <button onclick="saveEwsStatus('amber')"
                            class="w-full p-4 rounded-xl border-2 font-bold text-left flex items-center hover:bg-slate-50 transition-all bg-white text-slate-800 border-amber-500">
                            <span class="text-xl mr-3"></span> Amber Risk
                        </button>
                        <button onclick="saveEwsStatus('red')"
                            class="w-full p-4 rounded-xl border-2 font-bold text-left flex items-center hover:bg-slate-50 transition-all bg-white text-slate-800 border-red-500">
                            <span class="text-xl mr-3"></span> Red Risk
                        </button>
                    </div>
                    <button onclick="toggleEwsModal()"
                        class="mt-6 w-full py-3 font-bold text-slate-500 hover:bg-slate-100 rounded-lg">Cancel</button>
                </div>
            </div>
        </div>


        <div id="attendanceDetailsModal"
            class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
            <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
            <div
                class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
                <div class="modal-content py-6 text-left px-8">
                    <div class="flex justify-between items-start mb-5">
                        <div>
                            <p class="text-lg font-bold text-slate-800">Attendance Details</p>
                            <p class="text-sm text-slate-500" id="attendanceSubtitle">For [TM Name] ([Status])</p>
                        </div>
                        <div class="modal-close cursor-pointer z-50 p-1 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors"
                            onclick="toggleModal('attendanceDetailsModal')">
                            <svg class="fill-current text-slate-500" xmlns="http://www.w3.org/2000/svg" width="18"
                                height="18" viewBox="0 0 18 18">
                                <path
                                    d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z" />
                            </svg>
                        </div>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-slate-700 text-sm font-bold mb-2">Reason for
                                Absence/Lateness</label>
                            <select id="reasonSelect" onchange="handleReasonChange()"
                                class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-dcx-blue focus:border-dcx-blue font-medium text-slate-700 bg-white">
                                <option value="sick"> Feeling Unwell / Sick</option>
                                <option value="power"> Power Outage</option>
                                <option value="internet"> Internet/ISP Issues</option>
                                <option value="emergency"> Family/Personal Emergency</option>
                                <option value="other"> Other (Specify below)</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-slate-700 text-sm font-bold mb-2">Current Status / Next
                                Steps</label>
                            <div class="space-y-2">
                                <select id="quickStatusSelect" onchange="applyQuickStatus()"
                                    class="w-full p-2 border border-slate-200 rounded-lg text-sm font-medium text-slate-600 bg-slate-50 hover:border-dcx-blue transition-colors cursor-pointer">
                                    <option value=""> Click to choose a standard status...</option>
                                    <option value="Standing by for power restoration"> Standing by for power
                                        restoration</option>
                                    <option value="Standing by for internet restoration"> Standing by for internet
                                        restoration</option>
                                    <option value="Waiting for ISP technician"> Waiting for ISP technician</option>
                                    <option value="Resting and recovering"> Resting and recovering</option>
                                    <option value="Working intermittently when possible"> Working intermittently when
                                        possible</option>
                                    <option value="Will provide an update in 1 hour"> Will provide an update in 1 hour
                                    </option>
                                    <option value="Won't be able to login for the rest of the day"> Won't be able to
                                        login for the rest of the day</option>
                                </select>
                                <input type="text" id="statusInput"
                                    placeholder="Or type custom status here..."
                                    class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-dcx-blue text-slate-700 font-medium shadow-sm">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center">
                        <label class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="clientNotifiedCheck" class="sr-only peer">
                                <div
                                    class="w-10 h-6 bg-slate-200 rounded-full shadow-inner peer-checked:bg-green-500 transition-colors">
                                </div>
                                <div
                                    class="dot absolute w-4 h-4 bg-white rounded-full shadow left-1 top-1 transition transform peer-checked:translate-x-full">
                                </div>
                            </div>
                            <div class="ml-3 text-slate-700 font-medium">Mark as "Client Notified"</div>
                        </label>
                        <button onclick="saveAttendanceDetails()"
                            class="bg-dcx-blue hover:bg-dcx-light text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all">Done</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="snapshotModal"
            class="modal opacity-0 pointer-events-none fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
            <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden">
                <div class="bg-dcx-blue p-4 text-white flex justify-between items-center">
                    <h2 class="text-xl font-bold">Daily Attendance Report</h2>
                    <button onclick="toggleModal('snapshotModal')" class="text-blue-200 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6">
                    <div class="flex justify-between items-end mb-6 border-b pb-4">
                        <div>
                            <p class="text-sm text-slate-500 font-semibold uppercase tracking-wider">Team</p>
                            <h3 class="text-2xl font-extrabold text-slate-800" id="snapshotTeamName">DCX</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-slate-500 font-semibold uppercase tracking-wider">Date</p>
                            <h3 class="text-xl font-bold text-slate-800" id="snapshotDate"></h3>
                        </div>
                    </div>
                    <div class="space-y-6" id="snapshotContent"></div>
                </div>
                <div class="bg-slate-50 p-4 text-center text-slate-500 text-xs border-t">
                     Tip: Use your screenshot tool to capture this card.
                </div>
            </div>
        </div>
    </div><!-- END PULSECHECK CONTAINER -->

    <div id="commandPalette" class="fixed inset-0 z-[60] hidden transition-all duration-200">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="toggleCommandPalette()"></div>
        <div
            class="relative w-full max-w-xl mx-auto mt-[15vh] bg-white rounded-xl shadow-2xl overflow-hidden border border-slate-200 flex flex-col max-h-[60vh]">
            <div class="flex items-center px-4 py-4 border-b border-slate-100">
                <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="cmdInput" placeholder="What do you need?"
                    class="flex-1 bg-transparent border-none focus:ring-0 text-slate-800 placeholder-slate-400 text-lg font-medium ml-3"
                    autocomplete="off">
                <span
                    class="hidden md:block text-[10px] font-bold text-slate-500 bg-slate-100 border-b-2 border-slate-200 px-2 py-1 rounded shadow-sm">ESC</span>
            </div>
            <div id="cmdResults" class="overflow-y-auto p-2 space-y-1 scroll-smooth"></div>
            <div
                class="bg-slate-50 px-4 py-2 text-[10px] text-slate-400 border-t border-slate-100 flex justify-between items-center select-none">
                <div class="flex gap-3">
                    <span><strong class="font-semibold text-slate-600"></strong> to navigate</span>
                    <span><strong class="font-semibold text-slate-600"></strong> to select</span>
                </div>
                <span class="text-slate-300">Leadership OS</span>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Focus Mode Pill Container -->
    <div id="focusPillContainer"></div>

    <div id="tmContextModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
            onclick="toggleModal('tmContextModal')"></div>

        <div
            class="modal-container bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 w-11/12 md:max-w-2xl mx-auto rounded-2xl shadow-2xl z-50 flex flex-col max-h-[95vh] overflow-hidden transform transition-all scale-100">

            <div
                class="bg-slate-50 dark:bg-slate-800 border-b border-slate-300 dark:border-slate-600 p-6 flex-none z-10">
                <div class="flex justify-between items-start">
                    <div class="flex items-start gap-4">
                        <div
                            class="bg-white dark:bg-slate-700 p-3 rounded-xl border border-slate-300 dark:border-slate-600 shadow-sm">
                            <span class="text-3xl" id="ctxVibeIcon"></span>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-100 leading-none" id="ctxName">
                                Team Member Name</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400 font-medium mt-1" id="ctxRole">Role 
                                Account</p>
                            <div class="flex gap-2 mt-2">
                                <span id="ctxEwsBadge"
                                    class="px-2 py-0.5 rounded text-xs font-bold border border-slate-300 dark:border-slate-600 uppercase tracking-wider bg-slate-100 text-slate-500">
                                    EWS: Unknown
                                </span>
                                <span id="ctxPocBadge"
                                    class="px-2 py-0.5 rounded text-xs font-bold border bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 border-slate-300 dark:border-slate-600 truncate max-w-[200px]">
                                    POC: -
                                </span>
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleModal('tmContextModal')"
                        class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-hidden grid grid-cols-1 md:grid-cols-2 bg-white dark:bg-slate-900 relative">

                <div class="flex flex-col border-r border-slate-300 dark:border-slate-600 h-full overflow-hidden">
                    <div class="p-6 pb-0 flex-none">
                        <h3 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-4">
                            Score Trend (6 Months)</h3>
                        <div class="h-32 w-full relative mb-6">
                            <canvas id="ctxScoreTrendChart"></canvas>
                        </div>
                        <h3 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-4">
                            Vibe Trend (6 Months)</h3>
                        <div class="h-32 w-full relative mb-6">
                            <canvas id="ctxTrendChart"></canvas>
                        </div>
                        <h3 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-3">
                            Recent Check-ins (3 Months)</h3>
                    </div>

                    <div id="ctxCheckinList" class="flex-1 overflow-y-auto px-6 pb-8 space-y-1">
                    </div>
                </div>

                <div class="flex flex-col bg-slate-50 dark:bg-slate-800/50 h-full overflow-hidden">
                    <div class="p-6 pb-0 flex-none">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">
                                Logbook (Last 6 Entries)</h3>
                            <button onclick="goToLogbookContext()"
                                class="text-xs font-bold text-hub-600 hover:text-hub-800 transition-colors">View All
                                &rarr;</button>
                        </div>
                    </div>

                    <div id="ctxLogList" class="flex-1 overflow-y-auto px-6 pb-8 space-y-3">
                    </div>
                </div>
            </div>

            <div
                class="bg-slate-50 dark:bg-slate-800 p-4 border-t border-slate-300 dark:border-slate-600 text-right flex-none z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <input type="hidden" id="ctxTmId">
                <button onclick="toggleModal('tmContextModal')"
                    class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-700 px-5 py-2 rounded-lg text-sm font-bold transition-colors">Close</button>
            </div>
        </div>
    </div>

    <div id="rosterModal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[60]">
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
        <div class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-2xl mx-auto rounded-2xl shadow-2xl z-50 overflow-y-auto"
            style="max-height: 90vh;">
            <div class="modal-content py-6 text-left px-8">
                <div class="flex justify-between items-center pb-3 mb-4 border-b">
                    <div>
                        <p class="text-2xl font-bold text-slate-800" id="rosterModalTitle">Team Member Profile</p>
                        <p class="text-xs text-slate-500 font-medium">Manage HR record and contact details</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="rosterImport"
                            class="bg-dcx-blue hover:bg-dcx-light text-white px-3 py-1.5 rounded-lg font-bold flex items-center shadow-sm transition text-xs cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Import CSV/Excel
                        </label>
                        <input type="file" id="rosterImport" class="hidden" accept=".csv,.xlsx,.xls"
                            onchange="handleRosterImport(event)">
                        <div class="modal-close cursor-pointer" onclick="toggleRosterModal()">
                            <svg class="fill-current text-slate-500 hover:text-slate-800" width="18" height="18"
                                viewBox="0 0 18 18">
                                <path
                                    d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-4 border-b border-slate-200 mb-6">
                    <button type="button" onclick="switchRosterTab('profile')" id="rtab-profile"
                        class="pb-2 border-b-2 border-dcx-blue text-dcx-blue font-bold text-sm transition-colors">Profile
                        & Settings</button>
                    <button type="button" onclick="switchRosterTab('psi')" id="rtab-psi"
                        class="pb-2 border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-medium text-sm transition-colors">PSI
                        & Contact</button>
                </div>

                <form id="rosterForm" onsubmit="saveRosterMember(event)">
                    <input type="hidden" id="editTmId">

                    <div id="rview-profile">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2">Name</label>
                                <input type="text" id="editTmName"
                                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue"
                                    required>
                            </div>
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2">Nickname / Alias</label>
                                <input type="text" id="editTmNickname"
                                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue"
                                    placeholder="e.g. Tine, Hernan">
                            </div>
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2">Account</label>
                                <input type="text" id="editTmAccount"
                                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue">
                            </div>
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2">Role</label>
                                <input type="text" id="editTmRole"
                                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-slate-700 text-sm font-bold mb-2">Hire Date</label>
                                    <div class="relative group w-full">
                                        <input
                                            class="date-input-hidden-placeholder shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue bg-transparent relative z-10"
                                            id="editTmHireDate" type="date" onchange="updateDateInput(this)">
                                        <div
                                            class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                                            <div
                                                class="empty-state-icons flex items-center justify-center w-full h-full">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                    class="h-5 w-5 text-slate-400 transition-all duration-200 group-hover:opacity-0 group-hover:scale-75"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                    class="h-6 w-6 text-dcx-blue absolute transition-all duration-200 opacity-0 scale-75 group-hover:opacity-100 group-hover:scale-100"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M12 4v16m8-8H4" />
                                                </svg>
                                            </div>
                                            <div
                                                class="filled-state-text hidden flex items-center font-bold text-slate-700">
                                                <span class="date-text mr-2 text-sm"></span>
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-slate-700 text-sm font-bold mb-2">Birthday</label>
                                    <div class="relative group w-full">
                                        <input
                                            class="date-input-hidden-placeholder shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue bg-transparent relative z-10"
                                            id="editTmBirthday" type="date" onchange="updateDateInput(this)">
                                        <div
                                            class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                                            <div
                                                class="empty-state-icons flex items-center justify-center w-full h-full">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                    class="h-5 w-5 text-slate-400 transition-all duration-200 group-hover:opacity-0 group-hover:scale-75"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                    class="h-6 w-6 text-dcx-blue absolute transition-all duration-200 opacity-0 scale-75 group-hover:opacity-100 group-hover:scale-100"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M12 4v16m8-8H4" />
                                                </svg>
                                            </div>
                                            <div
                                                class="filled-state-text hidden flex items-center font-bold text-slate-700">
                                                <span class="date-text mr-2 text-sm"></span>
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400"
                                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2">EMP ID</label>
                                <input type="text" id="editTmEmpId"
                                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue">
                            </div>
                            <div>
                                <label class="block text-slate-700 text-sm font-bold mb-2">POC Name</label>
                                <input type="text" id="editTmPoc"
                                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-slate-700 text-sm font-bold mb-2">POC Email</label>
                                <input type="email" id="editTmPocEmail"
                                    class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue">
                            </div>
                        </div>
                    </div>

                    <div id="rview-psi" class="hidden">
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6">
                            <h4
                                class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                </svg>
                                Contact Details
                            </h4>
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="block text-slate-700 text-sm font-bold mb-2">Mobile Number</label>
                                    <input type="text" id="editTmPhone"
                                        class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue"
                                        placeholder="0917xxxxxxx">
                                </div>
                                <div>
                                    <label class="block text-slate-700 text-sm font-bold mb-2">Home Address</label>
                                    <textarea id="editTmAddress"
                                        class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-dcx-blue h-20 resize-none"
                                        placeholder="Unit, Street, City, Province"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                            <h4 class="text-xs font-bold text-red-800 uppercase tracking-wider mb-4 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                Emergency Contact (ICE)
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-slate-700 text-sm font-bold mb-2">Contact Person</label>
                                    <input type="text" id="editTmIceName"
                                        class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-red-500"
                                        placeholder="Name of relation">
                                </div>
                                <div>
                                    <label class="block text-slate-700 text-sm font-bold mb-2">Emergency Number</label>
                                    <input type="text" id="editTmIcePhone"
                                        class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-slate-700 focus:outline-none focus:ring-2 focus:ring-red-500"
                                        placeholder="Contact #">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-6">
                        <button type="button" onclick="deleteTeamMember()" id="btnDeleteMember"
                            class="text-red-500 hover:text-red-700 text-sm font-bold hidden">Delete Member</button>
                        <div class="flex gap-3 ml-auto">
                            <button type="button" onclick="toggleRosterModal()"
                                class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 px-6 rounded-lg">Cancel</button>
                            <button type="submit"
                                class="bg-dcx-blue hover:bg-dcx-light text-white font-bold py-3 px-6 rounded-lg shadow-md">Save
                                Changes</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Snoozed Tasks Manager Modal -->
    <div id="snoozedTasksModal"
        class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
        <div
            class="modal-container bg-white border border-slate-200 dark:bg-slate-900 dark:border-slate-800 w-11/12 md:max-w-2xl mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden">
            <div
                class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <span class="text-xl"></span> Snoozed Tasks
                </h3>
                <div class="modal-close cursor-pointer" onclick="toggleModal('snoozedTasksModal')">
                    <svg class="fill-current text-slate-500 hover:text-slate-800 dark:hover:text-slate-200"
                        xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 18 18">
                        <path
                            d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z" />
                    </svg>
                </div>
            </div>
            <div id="snoozedTasksList" class="p-6 max-h-[60vh] overflow-y-auto space-y-3 custom-scrollbar">
                <!-- Snoozed tasks will be rendered here -->
            </div>
            <div
                class="px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-800 flex justify-end">
                <button onclick="toggleModal('snoozedTasksModal')"
                    class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Custom Snooze Date Modal -->
    <div id="customSnoozeModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" onclick="toggleModal('customSnoozeModal')"></div>
        <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl p-6 w-full max-w-sm relative z-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <span class="text-xl"></span> Custom Snooze Date
                </h3>
                <button onclick="toggleModal('customSnoozeModal')" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-slate-700 dark:text-slate-300 text-sm font-bold mb-2">
                        Return Date
                    </label>
                    <input type="date" id="customSnoozeDate" 
                        class="vault-input w-full" 
                        min="" 
                        required>
                </div>
                <div>
                    <label class="block text-slate-700 dark:text-slate-300 text-sm font-bold mb-2">
                        Return Time
                    </label>
                    <input type="time" id="customSnoozeTime" 
                        class="vault-input w-full" 
                        value="09:00" 
                        required>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="toggleModal('customSnoozeModal')"
                        class="flex-1 px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                        Cancel
                    </button>
                    <button onclick="confirmCustomSnooze()"
                        class="flex-1 px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white rounded-lg font-medium transition-colors shadow-sm">
                        Snooze Task
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="colorModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-[70] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"
            onclick="toggleModal('colorModal')"></div>
        <div
            class="modal-container bg-white border border-slate-200 w-full max-w-lg mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden">
            <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">Account Color Mapping</h3>
                <button onclick="toggleModal('colorModal')" class="text-slate-400 hover:text-slate-600"></button>
            </div>
            <div id="colorModalList" class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
            </div>
            <div class="bg-slate-50 p-4 border-t border-slate-200 text-right">
                <button onclick="saveAccountColors()"
                    class="bg-dcx-blue hover:bg-dcx-light text-white font-bold py-2 px-6 rounded-lg shadow-sm">Save
                    Colors</button>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN (Old Version Restored & Enhanced) -->
    <div id="loginScreen"
        class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center transition-opacity duration-500">
        <div class="absolute inset-0 opacity-40"
            style="background: radial-gradient(circle at 50% 50%, #5b21b6 0%, #0f172a 50%);"></div>
        <div class="absolute inset-0 opacity-20"
            style="background-image: radial-gradient(#a78bfa 1px, transparent 1px); background-size: 30px 30px;"></div>

        <div
            class="bg-white/90 backdrop-blur-xl border border-white/20 w-full max-w-md p-8 rounded-3xl shadow-2xl relative z-10 text-center">

            <!-- Loading State (Default Visible) -->
            <div id="auth-loading-state" class="flex flex-col items-center justify-center py-10">
                <div
                    class="w-20 h-20 bg-dcx-blue rounded-2xl flex items-center justify-center mb-6 shadow-xl shadow-blue-500/30 animate-pulse">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-slate-800">Initializing System...</h2>
                <p class="text-slate-500 text-sm mt-2">Verifying secure session</p>
            </div>

            <!-- Login Form Container (Hidden by default) -->
            <div id="auth-form-container" style="display: none;">
                <div class="mb-8">
                    <div
                        class="w-20 h-20 bg-dcx-blue rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-xl shadow-blue-500/30 transition-transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Leadership OS</h1>
                    <p class="text-slate-500 text-sm font-medium mt-1">Authorized Personnel Only</p>
                </div>

                <form onsubmit="verifyIdentity(event)" class="space-y-5">
                    <div class="text-left">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Registered
                            Email</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                                <i data-lucide="mail" class="w-4 h-4"></i>
                            </span>
                            <input type="email" id="loginEmail"
                                class="w-full border border-slate-200 bg-white/50 rounded-xl pl-10 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-dcx-blue focus:border-transparent transition-all placeholder:text-slate-300"
                                placeholder="name@company.com" required>
                        </div>
                    </div>

                    <div class="text-left">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Security
                            Password</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                                <i data-lucide="lock" class="w-4 h-4"></i>
                            </span>
                            <input type="password" id="loginPassword"
                                class="w-full border border-slate-200 bg-white/50 rounded-xl pl-10 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-dcx-blue focus:border-transparent transition-all placeholder:text-slate-300"
                                placeholder="" required>
                        </div>
                    </div>

                    <button type="submit" id="loginBtn"
                        class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-[0.98] flex items-center justify-center group">
                        <span id="loginBtnText">Unlock Dashboard</span>
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-5 w-5 ml-2 transition-transform group-hover:translate-x-1" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </form>

                <p id="loginError"
                    class="text-red-500 text-xs font-bold mt-5 hidden flex items-center justify-center gap-1">
                    <i data-lucide="alert-circle" class="w-3 h-3"></i>
                    Access Denied: Invalid credentials.
                </p>

                <div class="mt-8 pt-6 border-t border-slate-100">
                    <p class="text-[10px] text-slate-400 font-medium uppercase tracking-widest">Secure Local Environment
                        
                        Internal Use Only</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- Performance Context Menu -->
    <div id="perf-context-menu" class="hidden fixed z-[9999] bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 w-48 py-1 overflow-hidden transition-opacity duration-200">
        <button onclick="handleContextMenuAction('details')" class="w-full text-left px-4 py-2.5 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2 transition-colors">
            <i data-lucide="eye" class="w-4 h-4 text-blue-500"></i>
            View Details
        </button>
        <div class="h-px bg-slate-100 dark:bg-slate-700 my-1"></div>
        <button onclick="handleContextMenuAction('edit')" class="w-full text-left px-4 py-2.5 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2 transition-colors">
            <i data-lucide="edit-2" class="w-4 h-4 text-amber-500"></i>
            Edit Rating
        </button>
        <button onclick="handleContextMenuAction('clear')" class="w-full text-left px-4 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2 transition-colors">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            Clear Rating
        </button>
    </div>

    <!-- Performance Details Modal -->
    <div id="perf-details-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closePerformanceDetails()"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-slate-900 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-slate-200 dark:border-slate-700">
                    
                    <!-- Header -->
                    <div class="bg-white dark:bg-slate-900 px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white" id="perf-details-name">
                                Member Name
                            </h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Performance Details & Context</p>
                        </div>
                        <button type="button" class="text-slate-400 hover:text-slate-500 focus:outline-none transition-colors" onclick="closePerformanceDetails()">
                            <span class="sr-only">Close</span>
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Month Navigation -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 px-6 py-3 flex items-center justify-between border-b border-slate-100 dark:border-slate-800">
                        <button onclick="changePerformanceDetailsMonth(-1)" class="p-1.5 rounded-full hover:bg-white dark:hover:bg-slate-700 hover:shadow-sm text-slate-500 transition-all">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <span id="perf-details-month" class="font-bold text-sm text-slate-700 dark:text-slate-300">September '24</span>
                        <button onclick="changePerformanceDetailsMonth(1)" class="p-1.5 rounded-full hover:bg-white dark:hover:bg-slate-700 hover:shadow-sm text-slate-500 transition-all">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Content Body -->
                    <div id="perf-details-content" class="px-6 py-6 max-h-[60vh] overflow-y-auto space-y-6">
                        <!-- Content will be injected here -->
                    </div>

                    <!-- Footer -->
                    <div class="bg-slate-50 dark:bg-slate-800/50 px-6 py-4 flex justify-end gap-3 border-t border-slate-100 dark:border-slate-800">
                        <button type="button" class="px-4 py-2 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-sm font-medium rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" onclick="closePerformanceDetails()">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- JAVASCRIPT: Application Logic                 -->
    <!-- ========================================== -->
    <script>
        // --- UPGRADE: Zero-Loss Local Auto-Save Module ---
        const LocalBackup = {
            fileHandle: null,

            // 1. Initial Connection (User must click this button once)
            async connect() {
                if (!window.showOpenFilePicker) {
                    showToast("Your browser does not support local file access.", "error");
                    return;
                }
                try {
                    const pickerOpts = {
                        types: [{
                            description: 'Leadership OS Data',
                            accept: { 'application/json': ['.json'] }
                        }],
                        excludeAcceptAllOption: true,
                        multiple: false
                    };

                    // Open file picker
                    [this.fileHandle] = await window.showOpenFilePicker(pickerOpts);

                    showToast("Backup Connected! Auto-saving enabled.", "success");
                    this.save(); // Initial save to confirm connection

                    // Optional: Update a visual indicator if it exists
                    const indicator = document.getElementById('backupStatusIndicator');
                    if (indicator) {
                        indicator.innerHTML = ' Auto-Save Active';
                        indicator.classList.remove('hidden');
                    }

                } catch (err) {
                    // User cancelled or error occurred
                    if (err.name !== 'AbortError') {
                        console.error("Backup connection failed", err);
                        showToast("Failed to connect to local file.", "error");
                    }
                }
            },

            // 2. The Silent Saver
            async save() {
                // Guard clause: Only save if connected and data exists
                if (!this.fileHandle || !appData) return;

                try {
                    // Create a writable stream to the file
                    const writable = await this.fileHandle.createWritable();

                    // Write the current appData
                    await writable.write(JSON.stringify(appData, null, 2));

                    // Close the file
                    await writable.close();

                    console.log(`[AutoSave] Saved to disk at ${new Date().toLocaleTimeString()}`);
                } catch (err) {
                    console.error("Auto-save failed", err);
                    // Don't spam toasts on every keystroke save failure, maybe just log it
                    // unless it's a permission error
                    if (err.name === 'NotAllowedError') {
                        showToast(" Lost permission to save file. Re-connect backup.", "error");
                        this.fileHandle = null; // Reset handle
                    }
                }
            }
        };
        // ==========================================
        // GLOBAL STATE & DATA MODEL
        // ==========================================

        // ==========================================
        // SECURITY / GATEKEEPER AUTH LOGIC (Supabase)
        // ==========================================
        
        async function checkAuthStatus() {
            const screen = document.getElementById('loginScreen');
            const loadingState = document.getElementById('auth-loading-state');
            const formContainer = document.getElementById('auth-form-container');

            try {
                // Check if user has an active Supabase session
                const { data: { session } } = await supabaseClient.auth.getSession();

                if (session) {
                    // Scenario A: Logged In
                    // 1. Ensure loading state is visible
                    if (loadingState) loadingState.style.display = 'flex';
                    if (formContainer) formContainer.style.display = 'none';

                    // 2. Wait, then fade out
                    setTimeout(() => {
                        if (screen) {
                            screen.style.opacity = '0';
                            setTimeout(() => {
                                screen.style.display = 'none';
                            }, 500); // Match CSS transition duration
                        }
                    }, 800); // Splash duration
                } else {
                    // Scenario B: Not Logged In
                    // 1. Hide loading state
                    if (loadingState) loadingState.style.display = 'none';
                    // 2. Show form
                    if (formContainer) formContainer.style.display = 'block';
                    // 3. Ensure screen is visible
                    if (screen) {
                        screen.style.display = 'flex';
                        screen.style.opacity = '1';
                    }
                }
            } catch (error) {
                console.error('Auth check error:', error);
                // Show login form on error
                if (loadingState) loadingState.style.display = 'none';
                if (formContainer) formContainer.style.display = 'block';
                if (screen) {
                    screen.style.display = 'flex';
                    screen.style.opacity = '1';
                }
            }
        }

        // Ensure checkAuthStatus runs on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkAuthStatus);
        } else {
            checkAuthStatus();
        }

        async function verifyIdentity(e) {
            if (e) e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            const btnText = document.getElementById('loginBtnText');
            const errorMsg = document.getElementById('loginError');
            const card = document.querySelector('#loginScreen > div.bg-white\\/90');

            if (!email || !password) return;

            // UI State: Verifying
            btn.disabled = true;
            const originalBtnText = btnText.innerText;
            btnText.innerText = 'Verifying Identity...';
            errorMsg.classList.add('hidden');
            if (card) card.classList.remove('shake');

            try {
                // Sign in with Supabase
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                if (data.session) {
                    // Success
                    const screen = document.getElementById('loginScreen');
                    screen.style.opacity = '0';

                    setTimeout(() => {
                        screen.style.display = 'none';
                        showToast("Identity Verified. Decrypting Local Data...", "success");
                    }, 500);
                } else {
                    throw new Error("Invalid credentials");
                }
            } catch (err) {
                // Failure
                console.error('Login error:', err);
                if (card) {
                    card.classList.add('shake');
                    setTimeout(() => card.classList.remove('shake'), 500);
                }
                errorMsg.classList.remove('hidden');
                btn.disabled = false;
                btnText.innerText = originalBtnText;
            }
        }

        async function lockApp() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        // Add Enter key listener for login
        document.addEventListener('keydown', (e) => {
            const screen = document.getElementById('loginScreen');
            if (screen && screen.style.display !== 'none' && e.key === 'Enter') {
                verifyIdentity();
            }
        });

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('leadershipOS_DarkMode', isDark);

            if (window.Chart) {
                Chart.defaults.color = isDark ? '#ecedee' : '#64748b';
                Chart.defaults.borderColor = isDark ? '#2e3138' : '#e2e8f0';
            }

            // Update toggle state in settings if it exists
            updateDarkModeToggle();
        }

        function initDarkMode() {
            if (localStorage.getItem('leadershipOS_DarkMode') === 'true') {
                document.body.classList.add('dark-mode');
                if (window.Chart) {
                    Chart.defaults.color = '#ecedee';
                    Chart.defaults.borderColor = '#2e3138';
                }
            }
            // Update toggle state after initialization
            setTimeout(() => updateDarkModeToggle(), 100);
        }



        function saveModuleSettings() {
            if (!appData.settings) appData.settings = {};
            if (!appData.settings.modules) appData.settings.modules = {};

            // ActionHub
            appData.settings.modules.myDesk = document.getElementById('set_myDesk').checked;
            appData.settings.modules.pipeline = document.getElementById('set_pipeline').checked;
            appData.settings.modules.logbook = document.getElementById('set_logbook').checked;
            appData.settings.modules.broadcast = document.getElementById('set_broadcast').checked;
            appData.settings.modules.performance = document.getElementById('set_performance').checked;
            appData.settings.modules.projects = document.getElementById('set_projects').checked;

            // PulseCheck
            appData.settings.modules.rollCall = document.getElementById('set_rollCall').checked;
            appData.settings.modules.pulse = document.getElementById('set_pulse').checked;
            appData.settings.modules.timesheets = document.getElementById('set_timesheets').checked;

            // NEW: Capacity
            appData.settings.modules.capacity = document.getElementById('set_capacity').checked;

            // Quick Links
            appData.settings.modules.quickLinks = document.getElementById('set_quickLinks').checked;

            // Reliability
            appData.settings.modules.reliability = document.getElementById('set_reliability').checked;

            // Sound Effects
            appData.settings.soundEffects = document.getElementById('set_soundEffects').checked;
            SoundEngine.enabled = appData.settings.soundEffects;

            saveData();
            applyModuleSettings();
            showToast("Workspace modules updated", "success");
        }

        function saveUserProfile() {
            const emailInput = document.getElementById('set_userEmail');
            if (!emailInput) return;

            const email = emailInput.value.trim();
            if (!email) return;

            // Extract name from email (text before @)
            const nameFromEmail = email.split('@')[0];
            const capitalizedName = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);

            // Update appData
            if (!appData.userProfile) {
                appData.userProfile = {};
            }
            appData.userProfile.email = email;
            appData.userProfile.name = capitalizedName;

            // Save to localStorage
            saveData();

            // Update header badge immediately
            renderUserProfile();

            showToast("User profile updated", "success");
        }

        function applyModuleSettings() {
            // Default to TRUE if settings don't exist yet
            const defaults = {
                myDesk: true, pipeline: true, logbook: true, broadcast: true, performance: true, projects: true,
                rollCall: true, pulse: true, timesheets: true, capacity: true, quickLinks: true, reliability: true
            };

            const saved = (appData.settings && appData.settings.modules) ? appData.settings.modules : {};
            const s = { ...defaults, ...saved };

            // Helper to toggle visibility
            const toggle = (id, visible) => {
                const el = document.getElementById(id);
                if (el) {
                    if (visible) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            };

            // Apply to Navigation Buttons (ActionHub)
            toggle('tabMyDesk', s.myDesk);
            toggle('tabPipeline', s.pipeline);
            toggle('tabLogbook', s.logbook);
            toggle('tabBroadcast', s.broadcast);
            toggle('tabPerformance', s.performance);
            toggle('tabProjects', s.projects);

            // Apply to Navigation Buttons (PulseCheck)
            toggle('tabRollCall', s.rollCall);
            toggle('tabPulse', s.pulse);
            toggle('tabTimesheets', s.timesheets);
            toggle('tabCapacity', s.capacity);
            toggle('tabQuickLinks', s.quickLinks);
            toggle('tabReliability', s.reliability);

            // Apply Sound Settings
            const soundEnabled = (appData.settings && appData.settings.soundEffects !== undefined) ? appData.settings.soundEffects : true;
            SoundEngine.enabled = soundEnabled;
            const soundCheck = document.getElementById('set_soundEffects');
            if (soundCheck) soundCheck.checked = soundEnabled;

            // Sync Checkboxes (in case we just loaded data)
            const checks = {
                'set_myDesk': s.myDesk,
                'set_pipeline': s.pipeline,
                'set_logbook': s.logbook,
                'set_broadcast': s.broadcast,
                'set_performance': s.performance,
                'set_projects': s.projects,
                'set_rollCall': s.rollCall,
                'set_pulse': s.pulse,
                'set_timesheets': s.timesheets,
                'set_capacity': s.capacity,
                'set_quickLinks': s.quickLinks,
                'set_reliability': s.reliability
            };

            for (const [id, checked] of Object.entries(checks)) {
                const el = document.getElementById(id);
                if (el) el.checked = (checked !== false); // Default to true if undefined
            }
        }

        // ==========================================
        // SOUND ENGINE (Synthesized Audio)
        // ==========================================
        const SoundEngine = {
            ctx: null,
            enabled: true,

            init() {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) {
                        this.ctx = new AudioContext();
                    }
                } catch (e) {
                    console.warn('AudioContext not supported');
                }
            },

            playTone(freq, type, duration, vol = 0.1, time = 0) {
                if (!this.enabled || !this.ctx) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const t = this.ctx.currentTime + time;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = type;
                osc.frequency.setValueAtTime(freq, t);

                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(vol, t + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, t + duration);

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start(t);
                osc.stop(t + duration);
            },

            click() { this.playTone(600, 'sine', 0.05, 0.15); },

            success() {
                this.playTone(523.25, 'sine', 0.3, 0.05, 0);   // C5
                this.playTone(659.25, 'sine', 0.3, 0.05, 0.1); // E5
                this.playTone(783.99, 'sine', 0.4, 0.05, 0.2); // G5
            },

            delete() { this.playTone(300, 'triangle', 0.2, 0.1); },
            pop() { this.playTone(400, 'sine', 0.1, 0.05); },
            reminder() { this.playTone(587.33, 'sine', 0.15, 0.12); },

            // NEW: Garshu Bark (High pitch double chirp)
            bark() {
                if (!this.enabled || !this.ctx) return;
                if (this.ctx.state === 'suspended') this.ctx.resume();

                const triggerBark = (startTime) => {
                    const t = this.ctx.currentTime + startTime;
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(600, t);
                    osc.frequency.linearRampToValueAtTime(1100, t + 0.08);
                    gain.gain.setValueAtTime(0, t);
                    gain.gain.linearRampToValueAtTime(0.15, t + 0.02);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(t);
                    osc.stop(t + 0.15);
                };
                triggerBark(0);
                triggerBark(0.25);
            }
        };

        let appData = {
            // --- Shared Data ---
            team: [], // Single Source of Truth for Roster
            capacity: [],
            capto: [], // Client Approved PTO - Account Level
            meta: { lastBackup: null },
            userProfile: {
                email: "admin@leados.com",
                name: "Admin"
            },
            settings: {
                modules: {
                    myDesk: true,
                    pipeline: true,
                    logbook: true,
                    logbook: true,
                    broadcast: true,
                    performance: true,
                    rollCall: true,
                    rollCall: true,
                    pulse: true,
                    timesheets: true,
                    quickLinks: true
                }
            },
            performanceCustomWSLL: {}, // { metricName: [customOptions] }
        };

        let focusTimer = null;
        let focusDrag = { dragging: false, offsetX: 0, offsetY: 0, handle: null, startHandler: null, windowBound: false, pill: null };



        // UI State
        let activeTool = 'ActionHub'; // 'ActionHub' or 'PulseCheck'
        let currentHubTab = 'mailbox';
        let currentPulseTab = 'teamInfo';
        let currentDate = new Date(); // For PulseCheck Dashboard
        let currentReliabilityMonth = new Date(); // For Reliability Matrix
        let reliabilityFilterSearch = ''; // Search filter for team member names
        let reliabilityFilterStatus = 'all'; // Filter by status: 'all', 'unplanned'
        let reliabilityFilterAccount = 'all'; // Filter by account
        let reliabilitySortBy = 'name'; // Sort: 'name', 'score-asc', 'score-desc'
        let reliabilityBulkEditMode = false; // Bulk edit mode toggle
        let reliabilitySelectedCells = new Set(); // Set of selected cells: "tmId-dateString"
        let reliabilityContextMenuCell = null; // Stores cell info for context menu
        let heatmapMode = 'sentiment';
        let currentAttendanceTmId = null; // For Attendance Details Modal
        let logbookSelectionMode = false;
        let selectedLogEntries = [];
        let currentLogbookFilter = 'all';
        window.trackingEnabled = true; // Global flag for view history tracking
        let broadcastSelectionMode = false;
        let selectedBroadcasts = [];
        let teamTrendChartInstance = null;
        let performanceInitialized = false;

        // --- CALENDAR LOGIC ---
        let myDeskCalendarViewMode = 'board'; // 'board' or 'calendar'
        let calendarView = 'week'; // 'week' or 'month'
        let calendarCurrentDate = new Date();
        let calendarDragState = null;
        let calendarHasDragged = false;
        let calendarSelection = null;

        const CALENDAR_COLORS = [
            { name: 'Blue', bg: 'bg-blue-500' },
            { name: 'Indigo', bg: 'bg-indigo-500' },
            { name: 'Emerald', bg: 'bg-emerald-500' },
            { name: 'Rose', bg: 'bg-rose-500' },
            { name: 'Amber', bg: 'bg-amber-500' },
            { name: 'Purple', bg: 'bg-purple-500' },
            { name: 'Pink', bg: 'bg-pink-500' },
            { name: 'Cyan', bg: 'bg-cyan-500' },
            { name: 'Slate', bg: 'bg-slate-500' },
        ];

        // --- COMMAND PALETTE LOGIC ---
        let cmdSelectedIndex = 0;

        function toggleCommandPalette() {
            const cp = document.getElementById('commandPalette');
            const input = document.getElementById('cmdInput');
            if (cp.classList.contains('hidden')) {
                cp.classList.remove('hidden');
                input.value = '';
                input.focus();
                renderCommands('');
            } else {
                cp.classList.add('hidden');
            }
        }

        function renderCommands(filter = '') {
            const navs = [
                { icon: '', text: 'Go to Monthly Pulse', fn: () => { switchTool('PulseCheck'); switchTab('pulse'); } },
                { icon: '', text: 'Go to Mailbox', fn: () => { switchTool('ActionHub'); switchTab('mailbox'); } },
                { icon: '', text: 'Go to My Desk', fn: () => { switchTool('ActionHub'); switchTab('myDesk'); } },
                { icon: '', text: 'Go to Logbook', fn: () => { switchTool('ActionHub'); switchTab('logbook'); } },
                { icon: '', text: 'Go to Broadcasts', fn: () => { switchTool('ActionHub'); switchTab('broadcast'); } },
                { icon: '', text: 'Go to Performance', fn: () => { switchTool('ActionHub'); switchTab('performance'); } },
                { icon: '', text: 'Go to Team Info', fn: () => { switchTool('PulseCheck'); switchTab('teamInfo'); } },
                { icon: '', text: 'Go to Roll Call', fn: () => { switchTool('PulseCheck'); switchTab('rollCall'); } },
                { icon: '', text: 'Go to Capacity', fn: () => { switchTool('PulseCheck'); switchTab('capacity'); } },
                { icon: '', text: 'Go to Reliability', fn: () => { switchTool('PulseCheck'); switchTab('reliability'); } },
                { icon: '', text: 'Go to Quick Links', fn: () => { switchTool('PulseCheck'); switchTab('quickLinks'); } },
                { icon: '', text: 'Go to Project Tracker', keywords: 'tasks kanban board agile', fn: () => { switchTool('ActionHub'); switchTab('projects'); } },
                { icon: '', text: 'Go to Timesheet Tracker', keywords: 'hours log clock time', fn: () => { switchTool('PulseCheck'); switchTab('timesheets'); } },
                { icon: '', text: 'New Log Entry', fn: () => { switchTool('ActionHub'); openLogbookModal(); } },
                { icon: '', text: 'New Desk Task', fn: () => { switchTool('ActionHub'); openMyDeskModal(); } }
            ];

            const list = document.getElementById('cmdResults');
            list.innerHTML = '';
            cmdSelectedIndex = 0;
            let actions = [];

            const cleanFilter = filter.toLowerCase().trim();

            if (!cleanFilter) {
                actions = navs.map(n => ({ ...n, type: 'Nav' }));
            } else {
                const searchTerms = cleanFilter.split(" ").filter(t => t.length > 0);

                // 1. Navigation (Only match if typed)
                navs.forEach(n => {
                    if (n.text.toLowerCase().includes(cleanFilter) || (n.keywords && n.keywords.toLowerCase().includes(cleanFilter))) actions.push({ ...n, type: 'Nav' });
                });

                // 2. Team Search (Roster)
                if (appData.team) {
                    appData.team.filter(t => t.active).forEach(tm => {
                        const match = searchTerms.every(term =>
                            tm.name.toLowerCase().includes(term) ||
                            (tm.role || '').toLowerCase().includes(term) ||
                            (tm.account || '').toLowerCase().includes(term)
                        );
                        if (match) {
                            actions.push({
                                icon: '', text: tm.name, sub: tm.role, type: 'Team',
                                fn: () => openContextModal(tm.id)
                            });
                        }
                    });
                }

                // 3. Deep Search: My Desk Tasks
                if (appData.myDesk) {
                    appData.myDesk.forEach(t => {
                        if (t.title.toLowerCase().includes(cleanFilter) || (t.notes && t.notes.toLowerCase().includes(cleanFilter))) {
                            actions.push({
                                icon: '', text: t.title, sub: `Task  ${t.status}`, type: 'Task',
                                fn: () => { switchTool('ActionHub'); switchTab('myDesk'); openMyDeskModal(t.id); }
                            });
                        }
                    });
                }

                // 4. Deep Search: Logbook Entries
                if (appData.logbook) {
                    // Sort by date desc, limit to top 20 matches to prevent lag
                    appData.logbook
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .forEach(l => {
                            if (actions.length > 20) return; // Soft limit
                            if (l.title.toLowerCase().includes(cleanFilter) || l.notes.toLowerCase().includes(cleanFilter)) {
                                actions.push({
                                    icon: '', text: l.title, sub: `Log  ${formatDate(l.date)}`, type: 'Log',
                                    fn: () => { switchTool('ActionHub'); switchTab('logbook'); openLogbookModal(l.id); }
                                });
                            }
                        });
                }

                // 5. Deep Search: Broadcasts
                if (appData.broadcasts) {
                    appData.broadcasts.forEach(b => {
                        if (b.title.toLowerCase().includes(cleanFilter)) {
                            actions.push({
                                icon: '', text: b.title, sub: `Broadcast  ${b.category}`, type: 'Broadcast',
                                fn: () => { switchTool('ActionHub'); switchTab('broadcast'); openBroadcastModal(b.id); }
                            });
                        }
                    });
                }
            }

            if (actions.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-slate-400 text-sm">No results found.</div>`;
                return;
            }

            // Render Results (Top 12)
            actions.slice(0, 12).forEach((act, idx) => {
                const activeClass = idx === 0 ? 'bg-slate-100 text-slate-900' : 'text-slate-600 hover:bg-slate-50';
                list.innerHTML += `
                <div id="cmd-item-${idx}" onclick="executeCommand(${idx})" class="cmd-item cursor-pointer p-3 rounded-lg flex items-center justify-between transition-colors ${activeClass}">
                    <div class="flex items-center overflow-hidden">
                        <span class="text-lg mr-3 opacity-70 flex-shrink-0">${act.icon}</span>
                        <div class="overflow-hidden">
                            <div class="font-bold text-sm truncate">${act.text}</div>
                            ${act.sub ? `<div class="text-[10px] text-slate-400 truncate">${act.sub}</div>` : ''}
                        </div>
                    </div>
                    <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wider flex-shrink-0 ml-2">${act.type}</span>
                </div>`;
            });

            window.currentCmdActions = actions;
        }

        function executeCommand(index) {
            if (window.currentCmdActions && window.currentCmdActions[index]) {
                window.currentCmdActions[index].fn();
                toggleCommandPalette();
            }
        }

        /* ---------------------------------------------------------
            COMMAND PALETTE NAVIGATION ENGINE
        --------------------------------------------------------- */
        function initCommandPaletteNav() {
            const input = document.getElementById('cmdInput');
            const list = document.getElementById('cmdResults');

            if (!input || !list) return;

            // 1. Handle Navigation Keys
            input.addEventListener('keydown', (e) => {
                const items = Array.from(list.querySelectorAll('.cmd-item'))
                    .filter(el => !el.classList.contains('hidden'));

                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    cmdSelectedIndex = (cmdSelectedIndex + 1) % items.length;
                    updateHighlight(items);
                    scrollToItem(items[cmdSelectedIndex]);
                }
                else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    cmdSelectedIndex = (cmdSelectedIndex - 1 + items.length) % items.length;
                    updateHighlight(items);
                    scrollToItem(items[cmdSelectedIndex]);
                }
                else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (items[cmdSelectedIndex]) {
                        items[cmdSelectedIndex].click();
                    }
                }
            });

            // Helper: Update Visual Classes
            function updateHighlight(items) {
                if (!items) {
                    items = Array.from(list.querySelectorAll('.cmd-item'))
                        .filter(el => !el.classList.contains('hidden'));
                }

                items.forEach((item, index) => {
                    if (index === cmdSelectedIndex) {
                        item.classList.add('bg-slate-100', 'text-slate-900', 'dark:bg-slate-700');
                        item.classList.remove('text-slate-600', 'hover:bg-slate-50');
                        item.setAttribute('aria-selected', 'true');
                    } else {
                        item.classList.remove('bg-slate-100', 'text-slate-900', 'dark:bg-slate-700');
                        item.classList.add('text-slate-600', 'hover:bg-slate-50');
                        item.setAttribute('aria-selected', 'false');
                    }
                });
            }

            // Helper: Scroll into view
            function scrollToItem(item) {
                if (item) {
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            }

            // Expose updateHighlight for renderCommands to use
            window.updateCmdHighlight = updateHighlight;
        }

        function initSpotlight() {
            // Updated selectors to include Roll Call (#rcRosterList) and Performance tab
            const selectors = [
                '#tmGrid > div',
                '#mailboxGrid > div',
                '#colAtHand > div',
                '#colOnTheTable > div',
                '#colInDrawer > div',
                '.kanban-column > div',
                '#logbookEntryList > div',
                '#broadcastList > div',
                '#rcRosterList > div',
                '#perf-team-grid > div' // Performance tab cards


            ];

            const cards = document.querySelectorAll(selectors.join(', '));

            cards.forEach(card => {
                // Only add the class if it's not there (prevents duplicate event listeners)
                if (!card.classList.contains('spotlight-card')) {
                    card.classList.add('spotlight-card');

                    card.addEventListener('mousemove', (e) => {
                        const rect = card.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;

                        card.style.setProperty('--mouse-x', `${x}px`);
                        card.style.setProperty('--mouse-y', `${y}px`);
                    });
                }
            });
        }

        // ==========================================
        // ROSTER IMPORT LOGIC (Workday CSV)
        // ==========================================
        function handleRosterImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (fileExtension === 'csv') {
                // Handle CSV files (existing logic)
                const reader = new FileReader();
                reader.onload = function (e) {
                    processCSV(e.target.result);
                };
                reader.readAsText(file);
            } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                // Handle Excel files
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        processExcel(e.target.result);
                    } catch (error) {
                        console.error('Excel import error:', error);
                        showToast("Import Failed: Could not read Excel file. Please ensure it's a valid .xlsx file.", "error");
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                showToast("Import Failed: Unsupported file type. Please use .csv or .xlsx files.", "error");
            }

            event.target.value = ''; // Reset input
        }

        function processExcel(arrayBuffer) {
            try {
                // Parse Excel workbook
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // Get the first sheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convert sheet to JSON array (first row will be headers)
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1, // Use array format [["header1", "header2"], ["value1", "value2"]]
                    defval: "" // Default value for empty cells
                });
                
                if (!jsonData || jsonData.length === 0) {
                    showToast("Import Failed: Excel file appears to be empty.", "error");
                    return;
                }
                
                // Convert Excel data to CSV-like format for processing
                // Headers are in first row
                const headers = jsonData[0].map(h => String(h || "").trim().toLowerCase());
                
                // Validate headers
                const nameIndex = headers.findIndex(h => 
                    h.includes('team member') || h.includes('worker') || h.includes('name')
                );
                
                if (nameIndex === -1) {
                    showToast("Import Failed: Excel must have a 'Team Member', 'Worker' or 'Name' column.", "error");
                    return;
                }
                
                // Process rows (similar to CSV processing)
                const map = {
                    name: headers.findIndex(h => h.includes('team member') || h.includes('worker') || h.includes('name')),
                    empId: headers.findIndex(h => h.includes('employee id') || h.includes('emp id')),
                    hireDate: headers.findIndex(h => h.includes('service date') || h.includes('hire date')),
                    role: headers.findIndex(h => h.includes('role') || h.includes('position') || h.includes('job title')),
                    account: headers.findIndex(h => h.includes('account') || h.includes('customer') || h.includes('client'))
                };
                
                let importedCount = 0;
                let updatedCount = 0;
                
                // Process rows (skip header row)
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;
                    
                    // Extract & Clean Data (Excel cells are already parsed, no need for quote removal)
                    const rawName = row[map.name] || "";
                    const name = String(rawName).trim();
                    if (!name) continue;
                    
                    const rawEmpId = map.empId > -1 ? String(row[map.empId] || "").trim() : "";
                    // Handle Excel dates (can be numbers, Date objects, or formatted strings)
                    let rawDate = "";
                    if (map.hireDate > -1) {
                        const dateCell = row[map.hireDate];
                        if (dateCell !== undefined && dateCell !== null && dateCell !== "") {
                            // Check if it's a Date object
                            if (dateCell instanceof Date) {
                                const day = String(dateCell.getDate()).padStart(2, '0');
                                const month = String(dateCell.getMonth() + 1).padStart(2, '0');
                                const year = dateCell.getFullYear();
                                rawDate = `${day}/${month}/${year}`;
                            }
                            // Check if it's an Excel date serial number (numeric)
                            else if (typeof dateCell === 'number') {
                                // Convert Excel date serial to JavaScript date
                                // Excel epoch is December 30, 1899 (Excel incorrectly treats 1900 as leap year)
                                const excelEpoch = new Date(1899, 11, 30);
                                const jsDate = new Date(excelEpoch.getTime() + dateCell * 86400000);
                                // Format as DD/MM/YYYY for formatImportDate
                                const day = String(jsDate.getDate()).padStart(2, '0');
                                const month = String(jsDate.getMonth() + 1).padStart(2, '0');
                                const year = jsDate.getFullYear();
                                rawDate = `${day}/${month}/${year}`;
                            } else {
                                // It's already a string (formatted date from Excel)
                                // Workday exports use DD/MM/YYYY format, so pass it directly
                                rawDate = String(dateCell).trim();
                            }
                        }
                    }
                    const rawAccount = map.account > -1 ? String(row[map.account] || "").trim() : "Unassigned";
                    
                    // Default to "Team Member" if role column is missing or empty
                    const rawRole = map.role > -1 ? String(row[map.role] || "").trim() : "";
                    const finalRole = rawRole || "Team Member";
                    
                    // Date Conversion (using the same formatImportDate function)
                    const hireDate = formatImportDate(rawDate);
                    
                    // Merge or Create (same logic as CSV)
                    let existing = null;
                    if (rawEmpId) existing = appData.team.find(t => t.empId === rawEmpId);
                    if (!existing) existing = appData.team.find(t => t.name.toLowerCase() === name.toLowerCase());
                    
                    if (existing) {
                        // UPDATE existing member
                        if (rawAccount !== "Unassigned") existing.account = rawAccount;
                        if (finalRole !== "Team Member") existing.role = finalRole; // Only update if we have a real role
                        if (hireDate) existing.hireDate = hireDate;
                        if (rawEmpId) existing.empId = rawEmpId;
                        updatedCount++;
                    } else {
                        // CREATE new member
                        appData.team.push({
                            id: Date.now() + i,
                            name: name,
                            role: finalRole,
                            account: rawAccount,
                            hireDate: hireDate,
                            empId: rawEmpId,
                            poc: "",       // Left blank (User enters manually)
                            pocEmail: "",  // Left blank
                            active: true,
                            ews: "green"
                        });
                        importedCount++;
                    }
                }
                
                saveData();
                
                // Success Feedback & Redirect
                let msg = `Import Success: ${importedCount} added`;
                if (updatedCount > 0) msg += `, ${updatedCount} updated.`;
                showToast(msg, "success");
                
                toggleRosterModal();
                
            } catch (error) {
                console.error('Excel processing error:', error);
                showToast("Import Failed: " + (error.message || "Could not process Excel file."), "error");
            }
        }

        function processCSV(csvText) {
            const lines = csvText.split(/\r\n|\n/);

            // 1. Identify Headers
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());

            // 2. Map Workday Columns to App Fields
            const map = {
                name: headers.findIndex(h => h.includes('team member') || h.includes('worker') || h.includes('name')),
                empId: headers.findIndex(h => h.includes('employee id') || h.includes('emp id')),
                hireDate: headers.findIndex(h => h.includes('service date') || h.includes('hire date')),
                // User Note: Role might be missing now, but logic is ready for 'Role' or 'Position'
                role: headers.findIndex(h => h.includes('role') || h.includes('position') || h.includes('job title')),
                // User Note: Account = Customer
                account: headers.findIndex(h => h.includes('account') || h.includes('customer') || h.includes('client'))
            };

            if (map.name === -1) {
                showToast("Import Failed: CSV must have a 'Team Member', 'Worker' or 'Name' column.", "error");
                return;
            }

            let importedCount = 0;
            let updatedCount = 0;

            // 3. Process Rows
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const row = parseCSVRow(lines[i]); // Handle commas in quotes

                // Extract & Clean Data
                const rawName = row[map.name] || "";
                const name = rawName.replace(/"/g, '').trim(); // Remove quotes
                if (!name) continue;

                const rawEmpId = map.empId > -1 ? (row[map.empId] || "").replace(/"/g, '').trim() : "";
                const rawDate = map.hireDate > -1 ? (row[map.hireDate] || "").replace(/"/g, '').trim() : "";
                const rawAccount = map.account > -1 ? (row[map.account] || "").replace(/"/g, '').trim() : "Unassigned";

                // Default to "Team Member" if role column is missing or empty
                const rawRole = map.role > -1 ? (row[map.role] || "").replace(/"/g, '').trim() : "";
                const finalRole = rawRole || "Team Member";

                // Date Conversion
                const hireDate = formatImportDate(rawDate);

                // 4. Merge or Create
                let existing = null;
                if (rawEmpId) existing = appData.team.find(t => t.empId === rawEmpId);
                if (!existing) existing = appData.team.find(t => t.name.toLowerCase() === name.toLowerCase());

                if (existing) {
                    // UPDATE existing member
                    if (rawAccount !== "Unassigned") existing.account = rawAccount;
                    if (finalRole !== "Team Member") existing.role = finalRole; // Only update if we have a real role
                    if (hireDate) existing.hireDate = hireDate;
                    if (rawEmpId) existing.empId = rawEmpId;
                    updatedCount++;
                } else {
                    // CREATE new member
                    appData.team.push({
                        id: Date.now() + i,
                        name: name,
                        role: finalRole,
                        account: rawAccount,
                        hireDate: hireDate,
                        empId: rawEmpId,
                        poc: "",       // Left blank (User enters manually)
                        pocEmail: "",  // Left blank
                        active: true,
                        ews: "green"
                    });
                    importedCount++;
                }
            }

            saveData();

            // 5. Success Feedback & Redirect
            let msg = `Import Success: ${importedCount} added`;
            if (updatedCount > 0) msg += `, ${updatedCount} updated.`;
            showToast(msg, "success");

            toggleRosterModal();
            switchTool('PulseCheck');
            switchTab('teamInfo');
            renderTeamInfo();
        }

        // Helper: Handle spliting CSV lines even with commas inside quotes
        function parseCSVRow(text) {
            const result = [];
            let cell = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') { inQuotes = !inQuotes; }
                else if (char === ',' && !inQuotes) { result.push(cell); cell = ''; }
                else { cell += char; }
            }
            result.push(cell);
            return result;
        }

        function formatImportDate(dateStr) {
            if (!dateStr) return "";
            let s = dateStr.trim();

            // Remove Time if present
            if (s.includes(' ')) s = s.split(' ')[0];

            // STRATEGY 1: Handle Slashes (DD/MM/YYYY)
            // This is the specific fix for Workday CSV exports
            if (s.includes('/')) {
                const parts = s.split('/').map(p => p.trim()); // Trim whitespace from each part
                if (parts.length === 3) {
                    // Validate that all parts are numbers
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10);
                    const year = parseInt(parts[2], 10);
                    
                    // Validate date ranges
                    if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year > 0) {
                        // Format as DD/MM/YYYY (Workday format)
                        const dayStr = parts[0].padStart(2, '0');
                        const monthStr = parts[1].padStart(2, '0');
                        const yearStr = parts[2];
                        
                        // Return ISO format for HTML (YYYY-MM-DD)
                        return `${yearStr}-${monthStr}-${dayStr}`;
                    }
                }
            }

            // STRATEGY 2: Handle Dashes (DD-Mon-YYYY)
            const monthMap = { 'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04', 'may': '05', 'jun': '06', 'jul': '07', 'aug': '08', 'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12', 'sept': '09' };
            if (s.includes('-')) {
                const parts = s.split('-').map(p => p.trim());
                // Check middle part for month name (14-Nov-2022)
                if (parts.length === 3 && monthMap[parts[1].toLowerCase()]) {
                    return `${parts[2]}-${monthMap[parts[1].toLowerCase()]}-${parts[0].padStart(2, '0')}`;
                }
            }

            // Fallback - Try to parse but DON'T use new Date() directly as it assumes MM/DD/YYYY
            // Instead, try a more explicit approach or return empty
            console.warn(`Could not parse date: ${dateStr}`);
            return "";
        }

        // ==========================================
        // CORE INFRASTRUCTURE (Load, Save, Import)
        // ==========================================

        // --- NEW 360 VIEW LOGIC START ---
        let rosterChartInstance = null;

        function switchRosterTab(tab) {
            // UI Toggle for just Profile and PSI
            ['profile', 'psi'].forEach(t => {
                document.getElementById(`rview-${t}`).classList.add('hidden');
                document.getElementById(`rtab-${t}`).className = "pb-2 border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-medium text-sm transition-colors";
            });
            document.getElementById(`rview-${tab}`).classList.remove('hidden');
            document.getElementById(`rtab-${tab}`).className = "pb-2 border-b-2 border-dcx-blue text-dcx-blue font-bold text-sm transition-colors";
        }

        function renderRosterVibe(tmId) {
            const list = document.getElementById('rosterCheckinList');
            list.innerHTML = '';

            let labels = [], dataPoints = [];
            let d = new Date(); d.setDate(1);

            for (let i = 5; i >= 0; i--) {
                let p = new Date(d); p.setMonth(p.getMonth() - i);
                let k = getMonthKey(p);
                labels.push(p.toLocaleDateString('en-US', { month: 'short' }));

                let val = null;
                if (appData.checkins[k] && appData.checkins[k][tmId]) {
                    const s = appData.checkins[k][tmId].sentiment;
                    val = s === 'good' ? 3 : (s === 'mid' ? 2 : 1);
                    const emoji = s === 'good' ? '' : (s === 'mid' ? '' : '');
                    list.innerHTML += `
                    <div class="flex items-center justify-between text-sm py-2 border-b border-slate-100">
                        <span class="text-slate-600 font-medium">${k}</span>
                        <span class="text-lg">${emoji}</span>
                    </div>`;
                }
                dataPoints.push(val);
            }

            if (!list.innerHTML) list.innerHTML = `<div class="text-center py-4 text-slate-400 text-xs">No recent check-ins.</div>`;

            if (rosterChartInstance) rosterChartInstance.destroy();
            const ctx = document.getElementById('rosterMiniChart').getContext('2d');

            rosterChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Vibe', data: dataPoints, borderColor: '#00509D', borderWidth: 2, tension: 0.3, pointBackgroundColor: '#fff', pointBorderColor: '#00509D', fill: true, backgroundColor: 'rgba(0, 80, 157, 0.05)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false, min: 0.5, max: 3.5 }, x: { grid: { display: false }, ticks: { font: { size: 10 } } } } }
            });
        }
        // --- NEW 360 VIEW LOGIC END ---

        // --- Date Format Helpers ---
        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            // Handle YYYY-MM-DD strings directly to avoid timezone issues
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const day = parseInt(parts[2]);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[month]} ${day}`;
            }
            // Fallback
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[d.getMonth()]} ${d.getDate()}`;
        }

        function formatDateWithYear(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const day = parseInt(parts[2]);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[month]} ${day}, ${year}`;
            }
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
        }

        function formatDateRange(startDate, endDate) {
            if (!startDate || !endDate) return '';
            // Same day (shouldn't happen, but handle as single date)
            if (startDate === endDate) return formatDateShort(startDate);

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            const startParts = startDate.split('-');
            const endParts = endDate.split('-');

            if (startParts.length === 3 && endParts.length === 3) {
                const startMonth = parseInt(startParts[1]) - 1;
                const startDay = parseInt(startParts[2]);
                const endMonth = parseInt(endParts[1]) - 1;
                const endDay = parseInt(endParts[2]);

                // Same month: "Jan 1-15"
                if (startMonth === endMonth) {
                    return `${months[startMonth]} ${startDay}-${endDay}`;
                }
                // Different months: "Jan 1 - Feb 15"
                return `${months[startMonth]} ${startDay} - ${months[endMonth]} ${endDay}`;
            }

            // Fallback
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (isNaN(start.getTime()) || isNaN(end.getTime())) return '';

            if (start.getMonth() === end.getMonth()) {
                return `${months[start.getMonth()]} ${start.getDate()}-${end.getDate()}`;
            }
            return `${months[start.getMonth()]} ${start.getDate()} - ${months[end.getMonth()]} ${end.getDate()}`;
        }

        /* --- FIXED DATE INPUT HANDLER --- */
        function updateDateInput(input) {
            const container = input.nextElementSibling; // The div with icons (z-0)
            if (!container) return;

            const emptyState = container.querySelector('.empty-state-icons');
            const filledState = container.querySelector('.filled-state-text');

            if (input.value) {
                // STATE: Date Selected
                // 1. Make native input opaque and white background to cover the custom UI
                input.classList.remove('opacity-0');
                input.classList.add('opacity-100', 'bg-white');

                // 2. Hide the custom container entirely so it doesn't bleed through
                container.classList.add('hidden');
            } else {
                // STATE: Empty
                // 1. Make native input invisible (but clickable)
                input.classList.remove('opacity-100', 'bg-white');
                input.classList.add('opacity-0');

                // 2. Show the custom container
                container.classList.remove('hidden');

                // Ensure empty state icon is shown
                if (emptyState) emptyState.classList.remove('hidden');
                if (filledState) filledState.classList.add('hidden');
            }
        }

        // Original formatDate (overwriting or defining if missing)
        function formatDate(dateStr) {
            return formatDateShort(dateStr);
        }

        // Calendar date utilities (ported from VantagePro)
        function formatCalendarDate(date) {
            // Format date as YYYY-MM-DD for HTML date inputs
            if (!date) return '';
            const d = date instanceof Date ? date : parseCalendarDate(date);
            if (!d || isNaN(d.getTime())) return '';
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseCalendarDate(dateStr) {
            // Parse date string to Date object, using noon to avoid timezone issues
            if (!dateStr) return null;
            if (dateStr instanceof Date) return dateStr;
            // Handle YYYY-MM-DD format
            if (typeof dateStr === 'string' && dateStr.length === 10 && dateStr.includes('-')) {
                const d = new Date(dateStr + 'T12:00:00');
                if (!isNaN(d.getTime())) return d;
            }
            // Fallback
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return null;
            // Normalize to noon
            d.setHours(12, 0, 0, 0);
            return d;
        }

        // Helper function to get calendar color from task category
        function getCategoryCalendarColor(cat) {
            // Use the same color mapping as the board view (getCategoryColor)
            const fullColor = getCategoryColor(cat || 'Other');
            // Extract just the background color class (remove "text-white")
            return fullColor.replace(' text-white', '').trim();
        }

        function getCalendarEventsForDateRange(startDate, endDate) {
            const events = [];

            // Normalize range dates for comparison
            const rangeStart = new Date(startDate);
            rangeStart.setHours(0, 0, 0, 0);
            const rangeEnd = new Date(endDate);
            rangeEnd.setHours(23, 59, 59, 999);

            // Process calendar events
            appData.calendarEvents.forEach(event => {
                const start = event.startDate instanceof Date ? event.startDate : parseCalendarDate(event.startDate);
                const end = event.endDate instanceof Date ? event.endDate : parseCalendarDate(event.endDate);
                if (start && end) {
                    const eventStart = new Date(start);
                    eventStart.setHours(0, 0, 0, 0);
                    const eventEnd = new Date(end);
                    eventEnd.setHours(23, 59, 59, 999);
                    if (eventStart <= rangeEnd && eventEnd >= rangeStart) {
                        events.push({
                            ...event,
                            startDate: start,
                            endDate: end
                        });
                    }
                }
            });

            // Always include MyDesk tasks (no toggle needed)
            appData.myDesk.forEach(task => {
                let taskStartDate, taskEndDate;

                // Handle date ranges (dueDateStart/dueDateEnd) or single dates (dueDate)
                if (task.dueDateStart && task.dueDateEnd) {
                    // Range date
                    taskStartDate = parseCalendarDate(task.dueDateStart);
                    taskEndDate = parseCalendarDate(task.dueDateEnd);
                } else if (task.dueDate) {
                    // Single date (legacy or current)
                    taskStartDate = parseCalendarDate(task.dueDate);
                    taskEndDate = taskStartDate; // Single date: start and end are the same
                } else {
                    // No date, skip this task
                    return;
                }

                if (taskStartDate && taskEndDate) {
                    // Normalize task dates for comparison
                    const taskStart = new Date(taskStartDate);
                    taskStart.setHours(0, 0, 0, 0);
                    const taskEnd = new Date(taskEndDate);
                    taskEnd.setHours(23, 59, 59, 999);

                    // Check if task date/range overlaps with calendar view range
                    if (taskStart <= rangeEnd && taskEnd >= rangeStart) {
                        // Use category-based color for tasks
                        const color = getCategoryCalendarColor(task.category || 'Admin');
                        events.push({
                            id: `task-${task.id}`,
                            title: task.title,
                            startDate: taskStartDate,
                            endDate: taskEndDate,
                            color: color,
                            taskId: task.id,
                            notes: task.notes || '',
                            category: task.category || 'Admin'
                        });
                    }
                }
            });

            return events;
        }

        // View toggle function
        function toggleMyDeskView(mode) {
            myDeskCalendarViewMode = mode;
            const boardView = document.getElementById('myDeskBoardView');
            const calendarView = document.getElementById('myDeskCalendarView');
            const boardBtn = document.getElementById('myDeskViewBoard');
            const calendarBtn = document.getElementById('myDeskViewCalendar');
            const boardToolbar = document.getElementById('myDeskBoardToolbar');

            if (mode === 'calendar') {
                if (boardView) boardView.classList.add('hidden');
                if (calendarView) calendarView.classList.remove('hidden');
                if (boardBtn) {
                    boardBtn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                    boardBtn.classList.add('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
                }
                if (calendarBtn) {
                    calendarBtn.classList.remove('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
                    calendarBtn.classList.add('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                }
                if (boardToolbar) boardToolbar.classList.add('hidden');
                renderCalendar();
            } else {
                if (boardView) boardView.classList.remove('hidden');
                if (calendarView) calendarView.classList.add('hidden');
                if (calendarBtn) {
                    calendarBtn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                    calendarBtn.classList.add('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
                }
                if (boardBtn) {
                    boardBtn.classList.remove('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
                    boardBtn.classList.add('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                }
                if (boardToolbar) boardToolbar.classList.remove('hidden');
            }
        }

        // Calendar navigation functions
        function setCalendarView(view) {
            calendarView = view;
            renderCalendar();
        }

        function calendarToday() {
            calendarCurrentDate = new Date();
            renderCalendar();
        }

        function calendarPrevWeek() {
            calendarCurrentDate.setDate(calendarCurrentDate.getDate() - 7);
            renderCalendar();
        }

        function calendarNextWeek() {
            calendarCurrentDate.setDate(calendarCurrentDate.getDate() + 7);
            renderCalendar();
        }

        function calendarPrevMonth() {
            calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
            renderCalendar();
        }

        function calendarNextMonth() {
            calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
            renderCalendar();
        }

        // Main calendar render function
        function renderCalendar() {
            const container = document.getElementById('myDeskCalendarContainer');
            if (!container) return;

            if (calendarView === 'week') {
                renderWeekView(container);
            } else {
                renderMonthView(container);
            }
        }

        // Handle task click in calendar - open myDeskModal
        function handleCalendarTaskClick(taskId) {
            const id = taskId.replace('task-', '');
            openMyDeskModal(id);
        }

        // Handle calendar event click - open calendar event modal
        function handleCalendarEventClick(eventId) {
            openMyDeskCalendarEventModal(eventId);
        }

        // Calendar Event Modal Functions
        function openMyDeskCalendarEventModal(id = null, prefillStartDate = null, prefillEndDate = null) {
            toggleModal('modal-myDesk-calendar-event');

            // Get input elements
            const startDateInput = document.getElementById('myDesk-calendar-event-start');
            const endDateInput = document.getElementById('myDesk-calendar-event-end');

            // Clear date inputs first to force browser to update
            if (startDateInput) startDateInput.value = '';
            if (endDateInput) endDateInput.value = '';

            // Force a reflow to ensure the browser processes the clear
            if (startDateInput) startDateInput.offsetHeight;
            if (endDateInput) endDateInput.offsetHeight;

            // Populate color options
            const colorContainer = document.getElementById('myDesk-calendar-event-colors');
            if (colorContainer) {
                colorContainer.innerHTML = '';
                CALENDAR_COLORS.forEach(color => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = `w-8 h-8 rounded-full ${color.bg} shadow-sm hover:scale-110 transition-transform`;
                    btn.onclick = () => {
                        const colorInput = document.getElementById('myDesk-calendar-event-color');
                        if (colorInput) colorInput.value = color.bg;
                        colorContainer.querySelectorAll('button').forEach(b => b.classList.remove('ring-2', 'ring-offset-2', 'ring-hub-400'));
                        btn.classList.add('ring-2', 'ring-offset-2', 'ring-hub-400');
                    };
                    colorContainer.appendChild(btn);
                });
            }

            if (id) {
                const event = appData.calendarEvents.find(e => e.id === id);
                if (event) {
                    const eventIdInput = document.getElementById('myDesk-calendar-event-id');
                    const titleInput = document.getElementById('myDesk-calendar-event-title');
                    const notesInput = document.getElementById('myDesk-calendar-event-notes');
                    const colorInput = document.getElementById('myDesk-calendar-event-color');
                    const titleElement = document.getElementById('myDesk-calendar-event-modal-title');
                    const deleteBtn = document.getElementById('myDesk-calendar-event-delete-btn');
                    const startDateInputEdit = document.getElementById('myDesk-calendar-event-start');
                    const endDateInputEdit = document.getElementById('myDesk-calendar-event-end');

                    if (eventIdInput) eventIdInput.value = event.id;
                    if (titleInput) titleInput.value = event.title;

                    // Parse dates properly
                    const startDateParsed = parseCalendarDate(event.startDate);
                    const endDateParsed = parseCalendarDate(event.endDate);

                    let startDateStr = startDateParsed ? formatCalendarDate(startDateParsed) : (typeof event.startDate === 'string' ? event.startDate : formatCalendarDate(event.startDate));
                    let endDateStr = endDateParsed ? formatCalendarDate(endDateParsed) : (typeof event.endDate === 'string' ? event.endDate : formatCalendarDate(event.endDate));

                    // Set date values with a small delay to ensure browser updates
                    setTimeout(() => {
                        if (startDateInputEdit) {
                            startDateInputEdit.value = startDateStr;
                            startDateInputEdit.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        if (endDateInputEdit) {
                            endDateInputEdit.value = endDateStr;
                            endDateInputEdit.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }, 0);

                    if (colorInput) colorInput.value = event.color || 'bg-blue-500';
                    if (notesInput) notesInput.value = event.notes || '';
                    if (titleElement) titleElement.textContent = 'Edit Event';
                    if (deleteBtn) deleteBtn.classList.remove('hidden');

                    // Select color button
                    const selectedColor = event.color || 'bg-blue-500';
                    if (colorContainer) {
                        colorContainer.querySelectorAll('button').forEach(btn => {
                            if (btn.className.includes(selectedColor)) {
                                btn.classList.add('ring-2', 'ring-offset-2', 'ring-hub-400');
                            }
                        });
                    }
                }
            } else {
                // Use prefill dates if provided, otherwise use today
                const startDate = prefillStartDate ? formatCalendarDate(prefillStartDate) : formatCalendarDate(new Date());
                const endDate = prefillEndDate ? formatCalendarDate(prefillEndDate) : formatCalendarDate(new Date());

                const eventIdInput = document.getElementById('myDesk-calendar-event-id');
                const titleInput = document.getElementById('myDesk-calendar-event-title');
                const notesInput = document.getElementById('myDesk-calendar-event-notes');
                const colorInput = document.getElementById('myDesk-calendar-event-color');
                const titleElement = document.getElementById('myDesk-calendar-event-modal-title');
                const deleteBtn = document.getElementById('myDesk-calendar-event-delete-btn');

                if (eventIdInput) eventIdInput.value = '';
                if (titleInput) titleInput.value = '';

                // Set date values with a small delay to ensure browser updates
                setTimeout(() => {
                    if (startDateInput) {
                        startDateInput.value = startDate;
                        startDateInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    if (endDateInput) {
                        endDateInput.value = endDate;
                        endDateInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }, 0);

                if (colorInput) colorInput.value = 'bg-blue-500';
                if (notesInput) notesInput.value = '';
                if (titleElement) titleElement.textContent = 'New Event';
                if (deleteBtn) deleteBtn.classList.add('hidden');

                // Select default color
                if (colorContainer) {
                    colorContainer.querySelectorAll('button').forEach(btn => {
                        if (btn.className.includes('bg-blue-500')) {
                            btn.classList.add('ring-2', 'ring-offset-2', 'ring-hub-400');
                        }
                    });
                }
            }
        }

        function saveMyDeskCalendarEvent(e) {
            e.preventDefault();
            const idInput = document.getElementById('myDesk-calendar-event-id');
            const titleInput = document.getElementById('myDesk-calendar-event-title');
            const startDateInput = document.getElementById('myDesk-calendar-event-start');
            const endDateInput = document.getElementById('myDesk-calendar-event-end');
            const colorInput = document.getElementById('myDesk-calendar-event-color');
            const notesInput = document.getElementById('myDesk-calendar-event-notes');

            if (!titleInput || !startDateInput || !endDateInput) return;

            const id = idInput ? idInput.value : '';
            const title = titleInput.value;
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const color = colorInput ? colorInput.value : 'bg-blue-500';
            const notes = notesInput ? notesInput.value : '';

            // Parse dates to ensure they're normalized
            const startDateParsed = parseCalendarDate(startDate);
            const endDateParsed = parseCalendarDate(endDate);

            if (!startDateParsed || !endDateParsed) {
                showToast('Invalid dates', 'error');
                return;
            }

            if (startDateParsed > endDateParsed) {
                showToast('End date must be after start date', 'error');
                return;
            }

            // Format dates back to strings for storage
            const startDateStr = formatCalendarDate(startDateParsed);
            const endDateStr = formatCalendarDate(endDateParsed);

            if (id) {
                const event = appData.calendarEvents.find(e => e.id === id);
                if (event) {
                    event.title = title;
                    event.startDate = startDateStr;
                    event.endDate = endDateStr;
                    event.color = color;
                    event.notes = notes;
                }
            } else {
                appData.calendarEvents.push({
                    id: Date.now().toString(),
                    title: title,
                    startDate: startDateStr,
                    endDate: endDateStr,
                    color: color,
                    notes: notes
                });
            }

            saveData();
            renderCalendar();
            toggleModal('modal-myDesk-calendar-event');
            showToast(id ? 'Event updated' : 'Event created', 'success');
        }

        function deleteMyDeskCalendarEvent() {
            const idInput = document.getElementById('myDesk-calendar-event-id');
            if (!idInput || !idInput.value) return;
            const id = idInput.value;
            if (confirm('Are you sure you want to delete this event?')) {
                appData.calendarEvents = appData.calendarEvents.filter(e => e.id !== id);
                saveData();
                renderCalendar();
                toggleModal('modal-myDesk-calendar-event');
                showToast('Event deleted', 'success');
            }
        }

        // Calendar Drag and Drop Functions
        function calendarStartDrag(e, eventId, type) {
            e.stopPropagation();
            e.preventDefault();
            calendarHasDragged = false;

            const isTask = eventId.startsWith('task-');
            const event = isTask
                ? appData.myDesk.find(t => `task-${t.id}` === eventId)
                : appData.calendarEvents.find(ev => ev.id === eventId);

            if (!event) return;

            let startDate, endDate;

            if (isTask) {
                // Extract dates from task (dueDateStart/dueDateEnd or dueDate)
                if (event.dueDateStart && event.dueDateEnd) {
                    startDate = parseCalendarDate(event.dueDateStart);
                    endDate = parseCalendarDate(event.dueDateEnd);
                } else if (event.dueDate) {
                    startDate = parseCalendarDate(event.dueDate);
                    endDate = startDate; // Single date: start and end are the same
                } else {
                    return; // No date, can't drag
                }
            } else {
                // Calendar event
                startDate = event.startDate instanceof Date ? event.startDate : parseCalendarDate(event.startDate);
                endDate = event.endDate instanceof Date ? event.endDate : parseCalendarDate(event.endDate);
            }

            if (!startDate || !endDate) return;

            calendarDragState = {
                type: type,
                eventId: eventId,
                isTask: isTask,
                startX: e.clientX,
                originalStart: new Date(startDate),
                originalEnd: new Date(endDate)
            };

            // Add dragging cursor
            document.body.style.cursor = 'grabbing';

            // Add cursor to the event being dragged
            const eventEls = document.querySelectorAll(`[data-event-id="${eventId}"]`);
            eventEls.forEach(el => {
                el.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', calendarHandleDrag);
            document.addEventListener('mouseup', calendarEndDrag);
        }

        function calendarHandleDrag(e) {
            if (!calendarDragState) return;
            const deltaX = e.clientX - calendarDragState.startX;
            if (Math.abs(deltaX) > 3) {
                calendarHasDragged = true;
                // Ensure cursor is grabbing when dragging
                document.body.style.cursor = 'grabbing';
            }

            // Calculate days delta
            const container = document.getElementById('myDeskCalendarContainer');
            const containerWidth = container ? container.clientWidth : window.innerWidth;
            const cellWidth = containerWidth / 7;
            const daysDelta = Math.round(deltaX / cellWidth);

            // For resize operations, allow smaller movements
            if (calendarDragState.type === 'move' && daysDelta === 0 && Math.abs(deltaX) < 50) return;
            if ((calendarDragState.type === 'resize-start' || calendarDragState.type === 'resize-end') && daysDelta === 0 && Math.abs(deltaX) < 20) return;

            const isTask = calendarDragState.isTask;
            const event = isTask
                ? appData.myDesk.find(t => `task-${t.id}` === calendarDragState.eventId)
                : appData.calendarEvents.find(ev => ev.id === calendarDragState.eventId);
            if (!event) return;

            let newStart = new Date(calendarDragState.originalStart);
            let newEnd = new Date(calendarDragState.originalEnd);

            // Normalize to start of day
            newStart.setHours(0, 0, 0, 0);
            newEnd.setHours(0, 0, 0, 0);

            if (calendarDragState.type === 'move') {
                newStart.setDate(newStart.getDate() + daysDelta);
                newEnd.setDate(newEnd.getDate() + daysDelta);
            } else if (calendarDragState.type === 'resize-start') {
                newStart.setDate(newStart.getDate() + daysDelta);
                if (newStart > newEnd) {
                    const temp = new Date(newStart);
                    newStart = new Date(newEnd);
                    newEnd = temp;
                }
            } else if (calendarDragState.type === 'resize-end') {
                newEnd.setDate(newEnd.getDate() + daysDelta);
                if (newEnd < newStart) {
                    const temp = new Date(newEnd);
                    newEnd = new Date(newStart);
                    newStart = temp;
                }
            }

            // Ensure dates are valid
            newStart.setHours(0, 0, 0, 0);
            newEnd.setHours(0, 0, 0, 0);

            // Update the event/task data
            if (isTask) {
                // For tasks, save as dueDateStart/dueDateEnd
                event.dueDateStart = formatCalendarDate(newStart);
                event.dueDateEnd = formatCalendarDate(newEnd);
                // Clear legacy dueDate if it exists
                if (event.dueDate) delete event.dueDate;
            } else {
                // Calendar event
                event.startDate = formatCalendarDate(newStart);
                event.endDate = formatCalendarDate(newEnd);
            }

            // Update DOM directly instead of re-rendering entire calendar
            updateEventPositionInDOM(calendarDragState.eventId, newStart, newEnd, calendarDragState.type);
        }

        function updateEventPositionInDOM(eventId, newStart, newEnd, dragType) {
            const container = document.getElementById('myDeskCalendarContainer');
            if (!container) return;

            const eventElements = container.querySelectorAll(`[data-event-id="${eventId}"]`);
            if (eventElements.length === 0) return;

            if (calendarView === 'week') {
                updateWeekEventPosition(eventElements, newStart, newEnd, dragType);
            } else {
                updateMonthEventPosition(eventElements, newStart, newEnd, dragType);
            }
        }

        function updateWeekEventPosition(eventElements, newStart, newEnd, dragType) {
            const grid = document.getElementById('myDesk-week-calendar-grid');
            if (!grid) return;

            const gridWidth = grid.offsetWidth;
            const columnWidth = gridWidth / 7;
            const ROW_PADDING_TOP = CALENDAR_SIZING.week.rowPaddingTop;

            const startOfWeek = new Date(calendarCurrentDate);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0, 0, 0, 0);

            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                date.setHours(12, 0, 0, 0);
                weekDays.push(date);
            }

            const newStartDay = new Date(newStart);
            newStartDay.setHours(0, 0, 0, 0);
            const newEndDay = new Date(newEnd);
            newEndDay.setHours(0, 0, 0, 0);

            const startCol = weekDays.findIndex(d => {
                const dStart = new Date(d);
                dStart.setHours(0, 0, 0, 0);
                return dStart.getTime() === newStartDay.getTime();
            });
            const endCol = weekDays.findIndex(d => {
                const dStart = new Date(d);
                dStart.setHours(0, 0, 0, 0);
                return dStart.getTime() === newEndDay.getTime();
            });

            if (startCol >= 0 && endCol >= 0) {
                const span = (endCol - startCol) + 1;
                const left = startCol * columnWidth + 1;
                const width = span * columnWidth - 2;

                // Get dynamic sizing for the start column
                const defaultSizing = calculateEventSizing(0, 'week');
                const sizing = defaultSizing; // Use default for drag updates, will be recalculated after drag ends

                const currentLane = parseInt(eventElements[0].getAttribute('data-lane') || '0');
                const top = ROW_PADDING_TOP + (currentLane * (sizing.height + sizing.gap));

                eventElements.forEach(el => {
                    el.style.left = left + 'px';
                    el.style.width = width + 'px';
                    el.style.top = top + 'px';
                    el.setAttribute('data-col-start', startCol);
                    el.setAttribute('data-col-span', span);
                });
            }
        }

        function updateMonthEventPosition(eventElements, newStart, newEnd, dragType) {
            const container = document.getElementById('myDeskCalendarContainer');
            if (!container) return;

            const year = calendarCurrentDate.getFullYear();
            const month = calendarCurrentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - startDate.getDay() + (startDate.getDay() === 0 ? -6 : 1));
            startDate.setHours(0, 0, 0, 0);

            const calendarDays = [];
            const currentDate = new Date(startDate);
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const date = new Date(currentDate);
                    date.setHours(12, 0, 0, 0);
                    calendarDays.push(date);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            const newStartDay = new Date(newStart);
            newStartDay.setHours(0, 0, 0, 0);
            const newEndDay = new Date(newEnd);
            newEndDay.setHours(0, 0, 0, 0);

            const startCol = calendarDays.findIndex(d => {
                const dStart = new Date(d);
                dStart.setHours(0, 0, 0, 0);
                return dStart.getTime() === newStartDay.getTime();
            });
            const endCol = calendarDays.findIndex(d => {
                const dStart = new Date(d);
                dStart.setHours(0, 0, 0, 0);
                return dStart.getTime() === newEndDay.getTime();
            });

            if (startCol >= 0 && endCol >= 0) {
                const grid = document.getElementById('myDesk-month-calendar-grid');
                if (!grid) return;

                const gridWidth = grid.offsetWidth;
                const columnWidth = gridWidth / 7;
                const gridCells = grid.querySelectorAll('div');
                const cellHeight = gridCells.length > 0 ? gridCells[0].offsetHeight : CALENDAR_SIZING.month.defaultCellHeight;
                const headerHeight = 48;
                const defaultSizing = calculateEventSizing(0, 'month');
                const ROW_PADDING_TOP = CALENDAR_SIZING.month.rowPaddingTop;

                const startWeek = Math.floor(startCol / 7);
                const endWeek = Math.floor(endCol / 7);

                let segmentIndex = 0;
                for (let w = startWeek; w <= endWeek && w < 6; w++) {
                    const segStartCol = w === startWeek ? (startCol % 7) : 0;
                    const segEndCol = w === endWeek ? (endCol % 7) : 6;
                    const span = (segEndCol - segStartCol) + 1;

                    const left = segStartCol * columnWidth + 1;
                    const width = span * columnWidth - 2;
                    const weekTop = headerHeight + (w * cellHeight);

                    const el = eventElements[segmentIndex];
                    if (el) {
                        const currentLane = parseInt(el.getAttribute('data-lane') || '0');
                        el.style.left = left + 'px';
                        el.style.width = width + 'px';
                        el.style.top = (weekTop + ROW_PADDING_TOP + (currentLane * (defaultSizing.height + defaultSizing.gap))) + 'px';
                        el.setAttribute('data-col-start', segStartCol);
                        el.setAttribute('data-col-span', span);
                        el.setAttribute('data-week', w);
                    }
                    segmentIndex++;
                }
            }
        }

        function calendarEndDrag() {
            if (calendarDragState) {
                const isTask = calendarDragState.isTask;

                if (calendarHasDragged) {
                    // Recalculate lanes and update positions without full re-render
                    recalculateAndUpdateLanes();

                    if (isTask) {
                        const task = appData.myDesk.find(t => `task-${t.id}` === calendarDragState.eventId);
                        if (task) {
                            saveData();
                            renderMyDesk(false); // Update desk view
                        }
                    } else {
                        const event = appData.calendarEvents.find(ev => ev.id === calendarDragState.eventId);
                        if (event) {
                            saveData();
                        }
                    }
                } else {
                    // Click without drag - open edit modal
                    const eventId = calendarDragState.eventId;
                    if (isTask) {
                        // Open task modal
                        const taskId = eventId.replace('task-', '');
                        openMyDeskModal(taskId);
                    } else if (eventId) {
                        openMyDeskCalendarEventModal(eventId);
                    }
                }
            }
            // Remove dragging cursor
            document.body.style.cursor = '';

            // Reset cursor on all event elements
            if (calendarDragState) {
                const eventEls = document.querySelectorAll(`[data-event-id="${calendarDragState.eventId}"]`);
                eventEls.forEach(el => {
                    el.style.cursor = '';
                });
            }

            calendarDragState = null;
            calendarHasDragged = false;
            document.removeEventListener('mousemove', calendarHandleDrag);
            document.removeEventListener('mouseup', calendarEndDrag);
        }

        function recalculateAndUpdateLanes() {
            if (calendarView === 'week') {
                recalculateWeekLanes();
            } else {
                recalculateMonthLanes();
            }
        }

        function recalculateWeekLanes() {
            const container = document.getElementById('myDeskCalendarContainer');
            if (!container) return;

            const grid = document.getElementById('myDesk-week-calendar-grid');
            if (!grid) return;

            const gridWidth = grid.offsetWidth;
            const columnWidth = gridWidth / 7;
            const ROW_PADDING_TOP = CALENDAR_SIZING.week.rowPaddingTop;

            // Get week start date
            const startOfWeek = new Date(calendarCurrentDate);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            const events = getCalendarEventsForDateRange(startOfWeek, endOfWeek);
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                date.setHours(12, 0, 0, 0); // Normalize to noon to avoid timezone issues
                weekDays.push(date);
            }

            // Calculate event segments with column positions
            const eventSegments = [];
            events.forEach(event => {
                const eventStart = event.startDate instanceof Date ? event.startDate : parseCalendarDate(event.startDate);
                const eventEnd = event.endDate instanceof Date ? event.endDate : parseCalendarDate(event.endDate);
                if (!eventStart || !eventEnd) return;

                const eventStartDay = new Date(eventStart);
                eventStartDay.setHours(0, 0, 0, 0);
                const eventEndDay = new Date(eventEnd);
                eventEndDay.setHours(0, 0, 0, 0);

                const startCol = weekDays.findIndex(d => {
                    const dStart = new Date(d);
                    dStart.setHours(0, 0, 0, 0);
                    return dStart.getTime() === eventStartDay.getTime();
                });
                const endCol = weekDays.findIndex(d => {
                    const dStart = new Date(d);
                    dStart.setHours(0, 0, 0, 0);
                    return dStart.getTime() === eventEndDay.getTime();
                });

                if (startCol >= 0 && endCol >= 0) {
                    const span = (endCol - startCol) + 1;
                    eventSegments.push({
                        ...event,
                        colIndex: startCol,
                        span: span,
                        laneIndex: 0
                    });
                }
            });

            // Calculate lanes for stacking
            const lanes = [];
            eventSegments.sort((a, b) => {
                if (a.colIndex !== b.colIndex) return a.colIndex - b.colIndex;
                return b.span - a.span;
            });

            eventSegments.forEach(seg => {
                let placed = false;
                for (let i = 0; i < lanes.length; i++) {
                    if (lanes[i] < seg.colIndex) {
                        seg.laneIndex = i;
                        lanes[i] = seg.colIndex + seg.span - 1;
                        placed = true;
                        break;
                    }
                }
                if (!placed) {
                    seg.laneIndex = lanes.length;
                    lanes.push(seg.colIndex + seg.span - 1);
                }
            });

            // Calculate day stats for dynamic sizing
            const dayStats = calculateWeekDayStats(eventSegments);
            const daySizing = {};
            let maxCellHeight = CALENDAR_SIZING.week.defaultCellHeight;

            Object.keys(dayStats).forEach(dayIdx => {
                const stats = dayStats[dayIdx];
                const sizing = calculateEventSizing(stats.taskCount, 'week');
                daySizing[dayIdx] = sizing;
                const cellHeight = calculateCellHeight(stats.maxLanes, sizing, 'week', ROW_PADDING_TOP);
                if (cellHeight > maxCellHeight) {
                    maxCellHeight = cellHeight;
                }
            });

            const defaultSizing = calculateEventSizing(0, 'week');

            // Update all event positions in DOM with dynamic sizing
            eventSegments.forEach(segment => {
                const eventEls = container.querySelectorAll(`[data-event-id="${segment.id}"]`);
                if (eventEls.length > 0) {
                    const segmentSizing = daySizing[segment.colIndex] || defaultSizing;
                    const left = segment.colIndex * columnWidth + 1;
                    const width = segment.span * columnWidth - 2;
                    const top = ROW_PADDING_TOP + (segment.laneIndex * (segmentSizing.height + segmentSizing.gap));

                    eventEls.forEach(el => {
                        el.style.left = left + 'px';
                        el.style.width = width + 'px';
                        el.style.top = top + 'px';
                        el.style.height = segmentSizing.height + 'px';
                        el.style.fontSize = segmentSizing.fontSize;
                        el.setAttribute('data-col-start', segment.colIndex);
                        el.setAttribute('data-col-span', segment.span);
                        el.setAttribute('data-lane', segment.laneIndex);
                    });
                }
            });

            // Update cell heights
            const cells = grid.querySelectorAll('[data-day-index]');
            cells.forEach(cell => {
                const dayIdx = parseInt(cell.getAttribute('data-day-index') || '0');
                const stats = dayStats[dayIdx];
                if (stats) {
                    const sizing = daySizing[dayIdx] || defaultSizing;
                    const cellHeight = calculateCellHeight(stats.maxLanes, sizing, 'week', ROW_PADDING_TOP);
                    cell.style.minHeight = Math.max(maxCellHeight, cellHeight) + 'px';
                }
            });
        }

        function recalculateMonthLanes() {
            const container = document.getElementById('myDeskCalendarContainer');
            if (!container) return;

            const grid = document.getElementById('myDesk-month-calendar-grid');
            if (!grid) return;

            const year = calendarCurrentDate.getFullYear();
            const month = calendarCurrentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - startDate.getDay() + (startDate.getDay() === 0 ? -6 : 1));
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(lastDay);
            endDate.setDate(endDate.getDate() + (7 - endDate.getDay()) % 7);
            endDate.setHours(23, 59, 59, 999);

            const events = getCalendarEventsForDateRange(startDate, endDate);
            const calendarDays = [];
            const currentDate = new Date(startDate);
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const date = new Date(currentDate);
                    date.setHours(12, 0, 0, 0); // Normalize to noon to avoid timezone issues
                    calendarDays.push(date);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            // Rebuild week events structure for lane calculation
            const weekEvents = {};
            for (let w = 0; w < 6; w++) {
                weekEvents[w] = [];
            }

            events.forEach(event => {
                const eventStart = event.startDate instanceof Date ? event.startDate : parseCalendarDate(event.startDate);
                const eventEnd = event.endDate instanceof Date ? event.endDate : parseCalendarDate(event.endDate);
                if (!eventStart || !eventEnd) return;

                const eventStartDay = new Date(eventStart);
                eventStartDay.setHours(0, 0, 0, 0);
                const eventEndDay = new Date(eventEnd);
                eventEndDay.setHours(0, 0, 0, 0);

                const startCol = calendarDays.findIndex(d => {
                    const dStart = new Date(d);
                    dStart.setHours(0, 0, 0, 0);
                    return dStart.getTime() === eventStartDay.getTime();
                });
                const endCol = calendarDays.findIndex(d => {
                    const dStart = new Date(d);
                    dStart.setHours(0, 0, 0, 0);
                    return dStart.getTime() === eventEndDay.getTime();
                });

                if (startCol >= 0 && endCol >= 0) {
                    const startWeek = Math.floor(startCol / 7);
                    const endWeek = Math.floor(endCol / 7);

                    for (let w = startWeek; w <= endWeek && w < 6; w++) {
                        const segStartCol = w === startWeek ? (startCol % 7) : 0;
                        const segEndCol = w === endWeek ? (endCol % 7) : 6;
                        const span = (segEndCol - segStartCol) + 1;

                        weekEvents[w].push({
                            ...event,
                            weekIndex: w,
                            colIndex: segStartCol,
                            span: span,
                            laneIndex: 0
                        });
                    }
                }
            });

            // Calculate day stats for dynamic sizing
            const dayStats = calculateDayStats(events, calendarDays, weekEvents);
            const daySizing = {};
            const weekCellHeights = {};

            Object.keys(dayStats).forEach(dayIdx => {
                const stats = dayStats[dayIdx];
                const sizing = calculateEventSizing(stats.taskCount, 'month');
                daySizing[dayIdx] = sizing;
                const cellHeight = calculateCellHeight(stats.maxLanes, sizing, 'month', CALENDAR_SIZING.month.rowPaddingTop);
                const week = Math.floor(parseInt(dayIdx) / 7);
                if (!weekCellHeights[week] || cellHeight > weekCellHeights[week]) {
                    weekCellHeights[week] = cellHeight;
                }
            });

            const gridWidth = grid.offsetWidth;
            const columnWidth = gridWidth / 7;
            const headerHeight = 48;
            const ROW_PADDING_TOP = CALENDAR_SIZING.month.rowPaddingTop;

            // Calculate lanes per week and update positions with dynamic sizing
            Object.keys(weekEvents).forEach(weekKey => {
                const week = parseInt(weekKey);
                const weekSegs = weekEvents[week];
                const lanes = [];

                weekSegs.sort((a, b) => {
                    if (a.colIndex !== b.colIndex) return a.colIndex - b.colIndex;
                    return b.span - a.span;
                });

                weekSegs.forEach(seg => {
                    let placed = false;
                    for (let i = 0; i < lanes.length; i++) {
                        if (lanes[i] < seg.colIndex) {
                            seg.laneIndex = i;
                            lanes[i] = seg.colIndex + seg.span - 1;
                            placed = true;
                            break;
                        }
                    }
                    if (!placed) {
                        seg.laneIndex = lanes.length;
                        lanes.push(seg.colIndex + seg.span - 1);
                    }

                    // Get dynamic sizing for this segment
                    const firstDayIdx = (week * 7) + seg.colIndex;
                    const segmentSizing = daySizing[firstDayIdx] || defaultSizing;

                    // Calculate week top position using dynamic cell heights
                    let weekTop = headerHeight;
                    for (let w = 0; w < week; w++) {
                        weekTop += (weekCellHeights[w] || CALENDAR_SIZING.month.defaultCellHeight);
                    }

                    // Update position in DOM
                    const eventEls = container.querySelectorAll(`[data-event-id="${seg.id}"][data-week="${week}"]`);
                    if (eventEls.length > 0) {
                        const left = seg.colIndex * columnWidth + 1;
                        const width = seg.span * columnWidth - 2;
                        const top = weekTop + ROW_PADDING_TOP + (seg.laneIndex * (segmentSizing.height + segmentSizing.gap));

                        eventEls.forEach(el => {
                            el.style.left = left + 'px';
                            el.style.width = width + 'px';
                            el.style.top = top + 'px';
                            el.style.height = segmentSizing.height + 'px';
                            el.style.fontSize = segmentSizing.fontSize;
                            el.setAttribute('data-col-start', seg.colIndex);
                            el.setAttribute('data-col-span', seg.span);
                            el.setAttribute('data-lane', seg.laneIndex);
                        });
                    }
                });
            });

            // Update cell heights
            const cells = grid.querySelectorAll('[data-day-index]');
            cells.forEach(cell => {
                const dayIdx = parseInt(cell.getAttribute('data-day-index') || '0');
                const week = parseInt(cell.getAttribute('data-week') || '0');
                const stats = dayStats[dayIdx];
                if (stats && weekCellHeights[week]) {
                    cell.style.minHeight = weekCellHeights[week] + 'px';
                }
            });
        }

        // Date Selection Handlers
        function handleCalendarDateMouseDown(e, date, colIndex, weekIndex = null) {
            if (e.button !== 0) return; // Only left click
            e.stopPropagation();
            e.preventDefault();

            const normalizedDate = new Date(date);
            normalizedDate.setHours(12, 0, 0, 0);

            calendarSelection = {
                start: { date: normalizedDate, colIndex: colIndex, weekIndex: weekIndex },
                end: { date: normalizedDate, colIndex: colIndex, weekIndex: weekIndex },
                isDragging: true
            };

            // Close any open modals
            const modal = document.getElementById('modal-myDesk-calendar-event');
            if (modal) {
                modal.classList.add('opacity-0', 'pointer-events-none');
                modal.classList.remove('modal-active');
            }

            updateSelectionVisualFeedback();
        }

        function handleCalendarDateMouseEnter(date, colIndex, weekIndex = null) {
            if (calendarSelection && calendarSelection.isDragging) {
                const currentWeekIndex = calendarView === 'week' ? 0 : weekIndex;
                const startWeekIndex = calendarView === 'week' ? 0 : calendarSelection.start.weekIndex;

                if (currentWeekIndex === startWeekIndex || calendarView === 'week') {
                    const normalizedDate = new Date(date);
                    normalizedDate.setHours(12, 0, 0, 0);
                    calendarSelection.end = { date: normalizedDate, colIndex: colIndex, weekIndex: weekIndex };
                    updateSelectionVisualFeedback();
                }
            }
        }

        function handleCalendarDateMouseUp() {
            if (calendarSelection && calendarSelection.isDragging) {
                calendarSelection.isDragging = false;
                renderCalendar();
            }
        }

        function updateSelectionVisualFeedback() {
            if (!calendarSelection) return;

            const container = document.getElementById('myDeskCalendarContainer');
            if (!container) return;

            if (calendarView === 'week') {
                updateWeekSelectionVisualFeedback();
            } else {
                updateMonthSelectionVisualFeedback();
            }
        }

        function updateWeekSelectionVisualFeedback() {
            const grid = document.getElementById('myDesk-week-calendar-grid');
            if (!grid) return;

            const cells = Array.from(grid.children);
            const minCol = Math.min(calendarSelection.start.colIndex, calendarSelection.end.colIndex);
            const maxCol = Math.max(calendarSelection.start.colIndex, calendarSelection.end.colIndex);

            cells.forEach((cell, idx) => {
                if (idx >= 0 && idx < 7) {
                    const isSelected = idx >= minCol && idx <= maxCol;
                    const isRangeStart = idx === minCol;
                    const isRangeEnd = idx === maxCol;

                    cell.classList.remove(
                        'bg-indigo-50', 'dark:bg-indigo-900/20',
                        'border-indigo-200', 'dark:border-indigo-700',
                        'border-y-2', 'border-t-indigo-400', 'dark:border-t-indigo-500',
                        'border-b-indigo-400', 'dark:border-b-indigo-500',
                        'border-l-2', 'border-l-indigo-400', 'dark:border-l-indigo-500',
                        'border-r-2', 'border-r-indigo-400', 'dark:border-r-indigo-500',
                        'rounded-l-sm', 'rounded-r-sm'
                    );

                    if (isSelected) {
                        cell.classList.add(
                            'bg-indigo-50', 'dark:bg-indigo-900/20',
                            'border-indigo-200', 'dark:border-indigo-700',
                            'border-y-2', 'border-t-indigo-400', 'dark:border-t-indigo-500',
                            'border-b-indigo-400', 'dark:border-b-indigo-500'
                        );
                        if (isRangeStart) {
                            cell.classList.add('border-l-2', 'border-l-indigo-400', 'dark:border-l-indigo-500', 'rounded-l-sm');
                        }
                        if (isRangeEnd) {
                            cell.classList.add('border-r-2', 'border-r-indigo-400', 'dark:border-r-indigo-500', 'rounded-r-sm');
                        }

                        const header = cell.querySelector('div');
                        if (header) {
                            header.classList.add('text-indigo-600', 'dark:text-indigo-400', 'font-bold');
                            header.classList.remove('text-slate-800', 'dark:text-white');
                        }
                    } else {
                        const header = cell.querySelector('div');
                        if (header) {
                            header.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'font-bold');
                            const isToday = cell.classList.contains('bg-hub-50') || cell.classList.contains('dark:bg-hub-900/10');
                            if (!isToday) {
                                header.classList.add('text-slate-800', 'dark:text-white');
                            }
                        }
                    }
                }
            });

            updateFloatingActionBar();
        }

        function updateMonthSelectionVisualFeedback() {
            const grid = document.getElementById('myDesk-month-calendar-grid');
            if (!grid) return;

            const cells = Array.from(grid.children);
            const startWeek = calendarSelection.start.weekIndex;
            const endWeek = calendarSelection.end.weekIndex;
            const startCol = calendarSelection.start.colIndex;
            const endCol = calendarSelection.end.colIndex;
            const minCol = Math.min(startCol, endCol);
            const maxCol = Math.max(startCol, endCol);

            cells.forEach((cell, idx) => {
                const week = Math.floor(idx / 7);
                const day = idx % 7;

                let isSelected = false;
                let isRangeStart = false;
                let isRangeEnd = false;

                if (week >= startWeek && week <= endWeek) {
                    if (week === startWeek && week === endWeek) {
                        if (day >= minCol && day <= maxCol) {
                            isSelected = true;
                            if (day === minCol) isRangeStart = true;
                            if (day === maxCol) isRangeEnd = true;
                        }
                    } else if (week === startWeek) {
                        if (day >= startCol) {
                            isSelected = true;
                            if (day === startCol) isRangeStart = true;
                        }
                    } else if (week === endWeek) {
                        if (day <= endCol) {
                            isSelected = true;
                            if (day === endCol) isRangeEnd = true;
                        }
                    } else {
                        isSelected = true;
                    }
                }

                cell.classList.remove(
                    'bg-indigo-50', 'dark:bg-indigo-900/20',
                    'border-indigo-200', 'dark:border-indigo-700',
                    'border-y-2', 'border-t-indigo-400', 'dark:border-t-indigo-500',
                    'border-b-indigo-400', 'dark:border-b-indigo-500',
                    'border-l-2', 'border-l-indigo-400', 'dark:border-l-indigo-500',
                    'border-r-2', 'border-r-indigo-400', 'dark:border-r-indigo-500',
                    'rounded-l-sm', 'rounded-r-sm'
                );

                if (isSelected) {
                    cell.classList.add(
                        'bg-indigo-50', 'dark:bg-indigo-900/20',
                        'border-indigo-200', 'dark:border-indigo-700',
                        'border-y-2', 'border-t-indigo-400', 'dark:border-t-indigo-500',
                        'border-b-indigo-400', 'dark:border-b-indigo-500'
                    );
                    if (isRangeStart) {
                        cell.classList.add('border-l-2', 'border-l-indigo-400', 'dark:border-l-indigo-500', 'rounded-l-sm');
                    }
                    if (isRangeEnd) {
                        cell.classList.add('border-r-2', 'border-r-indigo-400', 'dark:border-r-indigo-500', 'rounded-r-sm');
                    }

                    const header = cell.querySelector('div');
                    if (header) {
                        header.classList.add('text-indigo-600', 'dark:text-indigo-400', 'font-bold');
                        header.classList.remove('text-slate-800', 'dark:text-white', 'text-slate-400', 'dark:text-slate-600');
                    }
                } else {
                    const header = cell.querySelector('div');
                    if (header) {
                        header.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'font-bold');
                        const isCurrentMonth = !cell.classList.contains('bg-slate-50');
                        if (isCurrentMonth) {
                            header.classList.add('text-slate-800', 'dark:text-white');
                        } else {
                            header.classList.add('text-slate-400', 'dark:text-slate-600');
                        }
                    }
                }
            });

            updateFloatingActionBar();
        }

        // Floating Action Bar Functions
        function updateFloatingActionBar() {
            const container = document.getElementById('myDeskCalendarContainer');
            if (!container) return;

            const existingBar = container.querySelector('.fixed.bottom-6');
            if (existingBar) {
                existingBar.remove();
            }

            if (calendarSelection) {
                const dayCount = getCalendarSelectionDayCount();
                const actionBar = document.createElement('div');
                actionBar.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 z-[60]';
                actionBar.style.animation = 'slideUp 0.3s ease-out';
                actionBar.innerHTML = `
                    <div class="bg-slate-900 dark:bg-slate-800 text-white rounded-full shadow-2xl shadow-slate-900/20 px-4 py-2 flex items-center gap-4 border border-slate-700/50 dark:border-slate-600/50 backdrop-blur-md">
                        <div class="flex items-center gap-2 pl-2">
                            <span class="font-bold text-sm tracking-wide text-indigo-300 dark:text-indigo-400">${dayCount}</span>
                            <span class="text-xs font-medium text-slate-300 dark:text-slate-400 uppercase tracking-wider">Days Selected</span>
                        </div>
                        <div class="h-6 w-px bg-slate-700 dark:bg-slate-600"></div>
                        <div class="flex items-center gap-2">
                            <button 
                                onclick="clearCalendarSelection()"
                                class="p-1.5 hover:bg-slate-800 dark:hover:bg-slate-700 rounded-full text-slate-400 dark:text-slate-500 hover:text-white transition-colors"
                                title="Cancel Selection">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                            <button 
                                onclick="handleAddTaskFromSelection()"
                                class="bg-hub-600 hover:bg-hub-500 dark:bg-hub-500 dark:hover:bg-hub-400 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-lg shadow-hub-900/30 flex items-center gap-2 transition-all active:scale-95">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                </svg>
                                Add Task
                            </button>
                            <button 
                                onclick="handleLogEventFromSelection()"
                                class="bg-indigo-600 hover:bg-indigo-500 dark:bg-indigo-500 dark:hover:bg-indigo-400 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-lg shadow-indigo-900/30 flex items-center gap-2 transition-all active:scale-95">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                </svg>
                                Log Event
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(actionBar);
            }
        }

        function clearCalendarSelection() {
            calendarSelection = null;
            const container = document.getElementById('myDeskCalendarContainer');
            if (container) {
                const existingBar = container.querySelector('.fixed.bottom-6');
                if (existingBar) {
                    existingBar.remove();
                }
            }
            renderCalendar();
        }

        function getCalendarSelectionDayCount() {
            if (!calendarSelection) return 0;
            const t1 = calendarSelection.start.date.getTime();
            const t2 = calendarSelection.end.date.getTime();
            const diff = Math.abs(t2 - t1);
            return Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
        }

        function handleAddTaskFromSelection() {
            if (!calendarSelection) return;

            let startDate = new Date(calendarSelection.start.date);
            let endDate = new Date(calendarSelection.end.date);

            startDate.setHours(12, 0, 0, 0);
            endDate.setHours(12, 0, 0, 0);

            if (startDate > endDate) {
                const temp = startDate;
                startDate = endDate;
                endDate = temp;
            }

            openMyDeskModal(null, startDate, endDate);
            // Delay clearing selection to ensure modal opens first
            setTimeout(() => {
                clearCalendarSelection();
            }, 150);
        }

        function handleLogEventFromSelection() {
            if (!calendarSelection) return;

            let startDate = new Date(calendarSelection.start.date);
            let endDate = new Date(calendarSelection.end.date);

            startDate.setHours(12, 0, 0, 0);
            endDate.setHours(12, 0, 0, 0);

            if (startDate > endDate) {
                const temp = startDate;
                startDate = endDate;
                endDate = temp;
            }

            openMyDeskCalendarEventModal(null, startDate, endDate);
            // Delay clearing selection to ensure modal opens first
            setTimeout(() => {
                clearCalendarSelection();
            }, 150);
        }

        // Add global mouseup listener for selection
        document.addEventListener('mouseup', function (e) {
            if (calendarSelection && calendarSelection.isDragging) {
                handleCalendarDateMouseUp();
            }
        });

        // --- DYNAMIC CALENDAR SIZING CONFIGURATION ---
        const CALENDAR_SIZING = {
            month: {
                defaultHeight: 24,
                defaultFont: '10px',
                minHeight: 16,
                minFont: '8px',
                maxHeight: 24,
                maxFont: '10px',
                defaultGap: 4,
                minGap: 2,
                defaultCellHeight: 120,
                rowPaddingTop: 32
            },
            week: {
                defaultHeight: 28,
                defaultFont: '12px',
                minHeight: 18,
                minFont: '9px',
                maxHeight: 32,
                maxFont: '12px',
                defaultGap: 6,
                minGap: 3,
                defaultCellHeight: 600,
                rowPaddingTop: 40
            }
        };

        // Calculate optimal event sizing based on task count
        function calculateEventSizing(taskCount, viewType) {
            const config = CALENDAR_SIZING[viewType];

            if (taskCount <= 3) {
                return {
                    height: config.defaultHeight,
                    fontSize: config.defaultFont,
                    gap: config.defaultGap,
                    needsCellExpansion: false
                };
            } else if (taskCount <= 6) {
                const scale = 0.85;
                return {
                    height: Math.max(config.minHeight, Math.floor(config.defaultHeight * scale)),
                    fontSize: viewType === 'month' ? '9px' : '11px',
                    gap: Math.max(config.minGap, Math.floor(config.defaultGap * scale)),
                    needsCellExpansion: false
                };
            } else if (taskCount <= 9) {
                const scale = 0.75;
                return {
                    height: Math.max(config.minHeight, Math.floor(config.defaultHeight * scale)),
                    fontSize: viewType === 'month' ? '8px' : '10px',
                    gap: Math.max(config.minGap, Math.floor(config.defaultGap * scale)),
                    needsCellExpansion: false
                };
            } else {
                // Use minimums and expand cell
                return {
                    height: config.minHeight,
                    fontSize: config.minFont,
                    gap: config.minGap,
                    needsCellExpansion: true
                };
            }
        }

        // Calculate required cell height based on max lanes and sizing
        function calculateCellHeight(maxLanes, sizing, viewType, basePadding) {
            const config = CALENDAR_SIZING[viewType];
            const minHeight = config.defaultCellHeight;
            const requiredHeight = basePadding + (maxLanes * (sizing.height + sizing.gap)) + 8; // +8 for bottom padding
            return Math.max(minHeight, requiredHeight);
        }

        // Calculate task counts and max lanes per day for month view
        function calculateDayStats(events, calendarDays, weekEvents) {
            const dayStats = {};

            // Initialize all days
            calendarDays.forEach((day, idx) => {
                const dayStart = new Date(day);
                dayStart.setHours(0, 0, 0, 0);
                dayStats[idx] = {
                    taskCount: 0,
                    maxLanes: 0,
                    events: []
                };
            });

            // Count tasks per day and calculate lanes
            Object.keys(weekEvents).forEach(weekKey => {
                const week = parseInt(weekKey);
                const weekSegs = weekEvents[week];
                const lanes = [];

                weekSegs.sort((a, b) => {
                    if (a.colIndex !== b.colIndex) return a.colIndex - b.colIndex;
                    return b.span - a.span;
                });

                weekSegs.forEach(seg => {
                    let placed = false;
                    for (let i = 0; i < lanes.length; i++) {
                        if (lanes[i] < seg.colIndex) {
                            seg.laneIndex = i;
                            lanes[i] = seg.colIndex + seg.span - 1;
                            placed = true;
                            break;
                        }
                    }
                    if (!placed) {
                        seg.laneIndex = lanes.length;
                        lanes.push(seg.colIndex + seg.span - 1);
                    }

                    // Count tasks for each day this segment spans
                    for (let col = seg.colIndex; col <= seg.colIndex + seg.span - 1; col++) {
                        const dayIdx = (week * 7) + col;
                        if (dayStats[dayIdx]) {
                            dayStats[dayIdx].taskCount++;
                            dayStats[dayIdx].maxLanes = Math.max(dayStats[dayIdx].maxLanes, seg.laneIndex + 1);
                            dayStats[dayIdx].events.push(seg);
                        }
                    }
                });
            });

            return dayStats;
        }

        // Calculate task counts and max lanes per day for week view
        function calculateWeekDayStats(eventSegments) {
            const dayStats = {};

            for (let i = 0; i < 7; i++) {
                dayStats[i] = {
                    taskCount: 0,
                    maxLanes: 0,
                    events: []
                };
            }

            eventSegments.forEach(seg => {
                for (let col = seg.colIndex; col <= seg.colIndex + seg.span - 1; col++) {
                    if (col >= 0 && col < 7 && dayStats[col]) {
                        dayStats[col].taskCount++;
                        dayStats[col].maxLanes = Math.max(dayStats[col].maxLanes, seg.laneIndex + 1);
                        dayStats[col].events.push(seg);
                    }
                }
            });

            return dayStats;
        }

        function renderWeekView(container) {
            const startOfWeek = new Date(calendarCurrentDate);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // Monday as first day
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            const events = getCalendarEventsForDateRange(startOfWeek, endOfWeek);
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                date.setHours(12, 0, 0, 0); // Normalize to noon to avoid timezone issues
                weekDays.push(date);
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Calculate event segments with column positions
            const eventSegments = [];
            events.forEach(event => {
                const eventStart = event.startDate instanceof Date ? event.startDate : parseCalendarDate(event.startDate);
                const eventEnd = event.endDate instanceof Date ? event.endDate : parseCalendarDate(event.endDate);
                if (!eventStart || !eventEnd) return;

                const eventStartDay = new Date(eventStart);
                eventStartDay.setHours(0, 0, 0, 0);
                const eventEndDay = new Date(eventEnd);
                eventEndDay.setHours(0, 0, 0, 0);

                // Find which columns this event spans in the week
                const startCol = weekDays.findIndex(d => {
                    const dStart = new Date(d);
                    dStart.setHours(0, 0, 0, 0);
                    return dStart.getTime() === eventStartDay.getTime();
                });
                const endCol = weekDays.findIndex(d => {
                    const dStart = new Date(d);
                    dStart.setHours(0, 0, 0, 0);
                    return dStart.getTime() === eventEndDay.getTime();
                });

                // Include events that overlap with this week
                if (startCol >= 0 || endCol >= 0 || (eventStartDay <= endOfWeek && eventEndDay >= startOfWeek)) {
                    const actualStartCol = startCol >= 0 ? startCol : (eventStartDay < startOfWeek ? 0 : -1);
                    const actualEndCol = endCol >= 0 ? endCol : (eventEndDay > endOfWeek ? 6 : -1);

                    if (actualStartCol >= 0 && actualEndCol >= 0) {
                        const span = (actualEndCol - actualStartCol) + 1;
                        eventSegments.push({
                            ...event,
                            colIndex: actualStartCol,
                            span: span,
                            laneIndex: 0
                        });
                    }
                }
            });

            // Calculate lanes for stacking
            const lanes = [];
            eventSegments.sort((a, b) => {
                if (a.colIndex !== b.colIndex) return a.colIndex - b.colIndex;
                return b.span - a.span;
            });

            eventSegments.forEach(seg => {
                let placed = false;
                for (let i = 0; i < lanes.length; i++) {
                    if (lanes[i] < seg.colIndex) {
                        seg.laneIndex = i;
                        lanes[i] = seg.colIndex + seg.span - 1;
                        placed = true;
                        break;
                    }
                }
                if (!placed) {
                    seg.laneIndex = lanes.length;
                    lanes.push(seg.colIndex + seg.span - 1);
                }
            });

            // Calculate day statistics for dynamic sizing
            const dayStats = calculateWeekDayStats(eventSegments);

            // Calculate optimal sizing per day and determine cell heights
            const daySizing = {};
            let maxCellHeight = CALENDAR_SIZING.week.defaultCellHeight;

            Object.keys(dayStats).forEach(dayIdx => {
                const stats = dayStats[dayIdx];
                const sizing = calculateEventSizing(stats.taskCount, 'week');
                daySizing[dayIdx] = sizing;

                // Calculate required cell height for this day
                const cellHeight = calculateCellHeight(stats.maxLanes, sizing, 'week', CALENDAR_SIZING.week.rowPaddingTop);
                if (cellHeight > maxCellHeight) {
                    maxCellHeight = cellHeight;
                }
            });

            // Use default sizing if no tasks, otherwise use calculated
            const defaultSizing = calculateEventSizing(0, 'week');
            const EVENT_HEIGHT = defaultSizing.height;
            const EVENT_GAP = defaultSizing.gap;
            const ROW_PADDING_TOP = CALENDAR_SIZING.week.rowPaddingTop;

            let html = `
                <div class="h-full flex flex-col">
                    <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 sticky top-0 z-10">
                        <div class="flex items-center gap-4">
                            <button onclick="calendarPrevWeek()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <button onclick="calendarNextWeek()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white">
                                ${startOfWeek.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                            </h3>
                            <button onclick="calendarToday()" class="px-3 py-1 text-sm font-semibold text-hub-600 hover:bg-hub-50 dark:hover:bg-hub-900/20 rounded-lg transition-colors">
                                Today
                            </button>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="openMyDeskCalendarEventModal()" class="bg-hub-600 hover:bg-hub-700 text-white px-4 py-2 rounded-lg font-semibold shadow-sm text-sm border border-hub-500 transition-all flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                New Event
                            </button>
                            <div class="flex items-center gap-1 bg-slate-100 dark:bg-slate-800 rounded-lg p-1">
                                <button onclick="setCalendarView('week')" class="px-3 py-1 text-xs font-semibold rounded ${calendarView === 'week' ? 'bg-white dark:bg-slate-700 text-hub-600 dark:text-hub-400 shadow-sm' : 'text-slate-600 dark:text-slate-400'}">
                                    Week
                                </button>
                                <button onclick="setCalendarView('month')" class="px-3 py-1 text-xs font-semibold rounded ${calendarView === 'month' ? 'bg-white dark:bg-slate-700 text-hub-600 dark:text-hub-400 shadow-sm' : 'text-slate-600 dark:text-slate-400'}">
                                    Month
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto relative" style="min-height: 600px;">
                        <div class="grid grid-cols-7 h-full relative" id="myDesk-week-calendar-grid">
            `;

            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            weekDays.forEach((day, idx) => {
                const isToday = day.getTime() === today.getTime();
                const dayStart = new Date(day);
                dayStart.setHours(0, 0, 0, 0);

                // Get dynamic sizing for this day
                const sizing = daySizing[idx] || defaultSizing;
                const dayCellHeight = calculateCellHeight(dayStats[idx].maxLanes, sizing, 'week', ROW_PADDING_TOP);
                const finalCellHeight = Math.max(maxCellHeight, dayCellHeight);

                // Check if this day is selected
                let isSelected = false;
                let isRangeStart = false;
                let isRangeEnd = false;

                if (calendarSelection && calendarView === 'week') {
                    const selStart = new Date(calendarSelection.start.date);
                    selStart.setHours(0, 0, 0, 0);
                    const selEnd = new Date(calendarSelection.end.date);
                    selEnd.setHours(0, 0, 0, 0);

                    const minCol = Math.min(calendarSelection.start.colIndex, calendarSelection.end.colIndex);
                    const maxCol = Math.max(calendarSelection.start.colIndex, calendarSelection.end.colIndex);

                    if (idx >= minCol && idx <= maxCol) {
                        isSelected = true;
                        if (idx === minCol) isRangeStart = true;
                        if (idx === maxCol) isRangeEnd = true;
                    }
                }

                html += `
                    <div class="border-r border-b border-slate-200 dark:border-slate-700 ${idx === 6 ? 'border-r-0' : ''} ${isToday ? 'bg-hub-50 dark:bg-hub-900/10' : 'bg-white dark:bg-slate-900'} relative cursor-cell transition-colors ${isSelected ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-700 border-y-2 border-t-indigo-400 dark:border-t-indigo-500 border-b-indigo-400 dark:border-b-indigo-500' : ''} ${isRangeStart ? 'border-l-2 border-l-indigo-400 dark:border-l-indigo-500 rounded-l-sm' : ''} ${isRangeEnd ? 'border-r-2 border-r-indigo-400 dark:border-r-indigo-500 rounded-r-sm' : ''}" 
                        style="min-height: ${finalCellHeight}px;"
                        data-day-index="${idx}"
                        onmousedown="handleCalendarDateMouseDown(event, new Date(${day.getTime()}), ${idx})"
                        onmouseenter="handleCalendarDateMouseEnter(new Date(${day.getTime()}), ${idx})"
                        onmouseup="handleCalendarDateMouseUp()">
                        <div class="font-bold text-sm text-slate-800 dark:text-white mb-2 p-2 sticky top-0 bg-inherit z-10 ${isSelected ? 'text-indigo-600 dark:text-indigo-400 font-bold' : ''}">
                            ${dayNames[idx]}
                            <span class="text-xs font-normal text-slate-500 dark:text-slate-400 ml-1">${day.getDate()}</span>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;

            // Render events as absolutely positioned bars with dynamic sizing
            eventSegments.forEach(segment => {
                const isCalendarEvent = !segment.id.startsWith('task-');

                // Get sizing for the first day this segment spans
                const segmentSizing = daySizing[segment.colIndex] || defaultSizing;

                html += `
                    <div class="calendar-event ${segment.color} text-white text-xs rounded-md shadow-sm border border-white/10 cursor-move hover:brightness-105 hover:shadow-md transition-all duration-150 absolute flex items-center justify-center px-2 overflow-hidden select-none"
                        data-event-id="${segment.id}"
                        data-col-start="${segment.colIndex}"
                        data-col-span="${segment.span}"
                        data-lane="${segment.laneIndex}"
                        data-day-index="${segment.colIndex}"
                        onmousedown="calendarStartDrag(event, '${segment.id}', 'move')"
                        title="${segment.title}"
                        style="z-index: ${isCalendarEvent ? 10 : 5}; height: ${segmentSizing.height}px; font-size: ${segmentSizing.fontSize};">
                        ${isCalendarEvent || segment.id.startsWith('task-') ? `
                            <div class="absolute left-0 top-0 bottom-0 w-2 cursor-e-resize z-20 hover:bg-black/10 transition-colors rounded-l"
                                onmousedown="event.stopPropagation(); calendarStartDrag(event, '${segment.id}', 'resize-start')"></div>
                            <span class="pointer-events-none z-0 drop-shadow-sm truncate text-center w-full px-1 font-medium" style="font-size: ${segmentSizing.fontSize};">${segment.title}</span>
                            <div class="absolute right-0 top-0 bottom-0 w-2 cursor-w-resize z-20 hover:bg-black/10 transition-colors rounded-r"
                                onmousedown="event.stopPropagation(); calendarStartDrag(event, '${segment.id}', 'resize-end')"></div>
                        ` : `<span class="truncate font-medium" style="font-size: ${segmentSizing.fontSize};">${segment.title}</span>`}
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // Update floating action bar if selection exists (managed dynamically)
            if (calendarSelection) {
                updateFloatingActionBar();
            }

            // Calculate and apply positions after DOM is rendered
            setTimeout(() => {
                const grid = document.getElementById('myDesk-week-calendar-grid');
                if (grid) {
                    const gridWidth = grid.offsetWidth;
                    const columnWidth = gridWidth / 7;

                    eventSegments.forEach(segment => {
                        const eventEl = container.querySelector(`[data-event-id="${segment.id}"]`);
                        if (eventEl) {
                            // Get dynamic sizing for this segment
                            const segmentSizing = daySizing[segment.colIndex] || defaultSizing;

                            const left = segment.colIndex * columnWidth + 1;
                            const width = segment.span * columnWidth - 2;
                            const top = ROW_PADDING_TOP + (segment.laneIndex * (segmentSizing.height + segmentSizing.gap));

                            eventEl.style.left = left + 'px';
                            eventEl.style.width = width + 'px';
                            eventEl.style.top = top + 'px';
                            eventEl.style.height = segmentSizing.height + 'px';
                        }
                    });
                }
            }, 0);
        }

        function renderMonthView(container) {
            const year = calendarCurrentDate.getFullYear();
            const month = calendarCurrentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - startDate.getDay() + (startDate.getDay() === 0 ? -6 : 1)); // Monday
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(lastDay);
            endDate.setDate(endDate.getDate() + (7 - endDate.getDay()) % 7);
            endDate.setHours(23, 59, 59, 999);

            const events = getCalendarEventsForDateRange(startDate, endDate);
            const monthName = firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Build calendar grid dates
            const calendarDays = [];
            const currentDate = new Date(startDate);
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const date = new Date(currentDate);
                    date.setHours(12, 0, 0, 0); // Normalize to noon to avoid timezone issues
                    calendarDays.push(date);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            // Calculate event segments with column positions for month view
            // Group events by week for proper lane calculation
            const weekEvents = {};
            for (let w = 0; w < 6; w++) {
                weekEvents[w] = [];
            }

            events.forEach(event => {
                const eventStart = event.startDate instanceof Date ? event.startDate : parseCalendarDate(event.startDate);
                const eventEnd = event.endDate instanceof Date ? event.endDate : parseCalendarDate(event.endDate);
                if (!eventStart || !eventEnd) return;

                const eventStartDay = new Date(eventStart);
                eventStartDay.setHours(0, 0, 0, 0);
                const eventEndDay = new Date(eventEnd);
                eventEndDay.setHours(0, 0, 0, 0);

                // Find which columns this event spans in the month grid
                const startCol = calendarDays.findIndex(d => {
                    const dStart = new Date(d);
                    dStart.setHours(0, 0, 0, 0);
                    return dStart.getTime() === eventStartDay.getTime();
                });
                const endCol = calendarDays.findIndex(d => {
                    const dStart = new Date(d);
                    dStart.setHours(0, 0, 0, 0);
                    return dStart.getTime() === eventEndDay.getTime();
                });

                if (startCol >= 0 && endCol >= 0) {
                    const startWeek = Math.floor(startCol / 7);
                    const endWeek = Math.floor(endCol / 7);

                    // Create segments for each week the event spans
                    for (let w = startWeek; w <= endWeek && w < 6; w++) {
                        const weekStartCol = w * 7;
                        const weekEndCol = Math.min((w + 1) * 7 - 1, calendarDays.length - 1);
                        const segStartCol = w === startWeek ? (startCol % 7) : 0;
                        const segEndCol = w === endWeek ? (endCol % 7) : 6;
                        const span = (segEndCol - segStartCol) + 1;

                        weekEvents[w].push({
                            ...event,
                            weekIndex: w,
                            colIndex: segStartCol,
                            span: span,
                            laneIndex: 0
                        });
                    }
                }
            });

            // Calculate lanes for stacking per week
            const eventSegments = [];
            Object.keys(weekEvents).forEach(weekKey => {
                const week = parseInt(weekKey);
                const weekSegs = weekEvents[week];
                const lanes = [];

                weekSegs.sort((a, b) => {
                    if (a.colIndex !== b.colIndex) return a.colIndex - b.colIndex;
                    return b.span - a.span;
                });

                weekSegs.forEach(seg => {
                    let placed = false;
                    for (let i = 0; i < lanes.length; i++) {
                        if (lanes[i] < seg.colIndex) {
                            seg.laneIndex = i;
                            lanes[i] = seg.colIndex + seg.span - 1;
                            placed = true;
                            break;
                        }
                    }
                    if (!placed) {
                        seg.laneIndex = lanes.length;
                        lanes.push(seg.colIndex + seg.span - 1);
                    }
                    eventSegments.push(seg);
                });
            });

            // Calculate day statistics for dynamic sizing
            const dayStats = calculateDayStats(events, calendarDays, weekEvents);

            // Calculate optimal sizing per day and determine cell heights
            const daySizing = {};
            const weekCellHeights = {}; // Track max height per week

            Object.keys(dayStats).forEach(dayIdx => {
                const stats = dayStats[dayIdx];
                const sizing = calculateEventSizing(stats.taskCount, 'month');
                daySizing[dayIdx] = sizing;

                // Calculate required cell height for this day
                const cellHeight = calculateCellHeight(stats.maxLanes, sizing, 'month', CALENDAR_SIZING.month.rowPaddingTop);
                const week = Math.floor(parseInt(dayIdx) / 7);

                // Track max height needed for each week
                if (!weekCellHeights[week] || cellHeight > weekCellHeights[week]) {
                    weekCellHeights[week] = cellHeight;
                }
            });

            // Use default sizing if no tasks, otherwise use calculated
            const defaultSizing = calculateEventSizing(0, 'month');
            const EVENT_HEIGHT = defaultSizing.height;
            const EVENT_GAP = defaultSizing.gap;
            const ROW_PADDING_TOP = CALENDAR_SIZING.month.rowPaddingTop;

            let html = `
                <div class="h-full flex flex-col">
                    <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 sticky top-0 z-10">
                        <div class="flex items-center gap-4">
                            <button onclick="calendarPrevMonth()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <button onclick="calendarNextMonth()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white">${monthName}</h3>
                            <button onclick="calendarToday()" class="px-3 py-1 text-sm font-semibold text-hub-600 hover:bg-hub-50 dark:hover:bg-hub-900/20 rounded-lg transition-colors">
                                Today
                            </button>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="openMyDeskCalendarEventModal()" class="bg-hub-600 hover:bg-hub-700 text-white px-4 py-2 rounded-lg font-semibold shadow-sm text-sm border border-hub-500 transition-all flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                New Event
                            </button>
                            <div class="flex items-center gap-1 bg-slate-100 dark:bg-slate-800 rounded-lg p-1">
                                <button onclick="setCalendarView('week')" class="px-3 py-1 text-xs font-semibold rounded ${calendarView === 'week' ? 'bg-white dark:bg-slate-700 text-hub-600 dark:text-hub-400 shadow-sm' : 'text-slate-600 dark:text-slate-400'}">
                                    Week
                                </button>
                                <button onclick="setCalendarView('month')" class="px-3 py-1 text-xs font-semibold rounded ${calendarView === 'month' ? 'bg-white dark:bg-slate-700 text-hub-600 dark:text-hub-400 shadow-sm' : 'text-slate-600 dark:text-slate-400'}">
                                    Month
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto relative">
                        <div class="grid grid-cols-7">
                            ${dayNames.map(day => `<div class="p-3 text-center text-xs font-bold text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700 sticky top-0 bg-white dark:bg-slate-900 z-10">${day}</div>`).join('')}
                        </div>
                        <div class="grid grid-cols-7 auto-rows-fr relative" id="myDesk-month-calendar-grid">
            `;

            const gridDate = new Date(startDate);
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const isCurrentMonth = gridDate.getMonth() === month;
                    const isToday = gridDate.getTime() === today.getTime();
                    const dayNum = gridDate.getDate();
                    const dayStart = new Date(gridDate);
                    dayStart.setHours(0, 0, 0, 0);
                    const colIndex = (week * 7) + day;

                    // Get dynamic sizing for this day
                    const dayIdx = colIndex;
                    const sizing = daySizing[dayIdx] || defaultSizing;
                    const cellHeight = weekCellHeights[week] || CALENDAR_SIZING.month.defaultCellHeight;

                    // Check if this day is selected
                    let isSelected = false;
                    let isRangeStart = false;
                    let isRangeEnd = false;

                    if (calendarSelection && calendarView === 'month') {
                        const selStart = new Date(calendarSelection.start.date);
                        selStart.setHours(0, 0, 0, 0);
                        const selEnd = new Date(calendarSelection.end.date);
                        selEnd.setHours(0, 0, 0, 0);

                        // Check if selection is in the same week range
                        const startWeek = calendarSelection.start.weekIndex;
                        const endWeek = calendarSelection.end.weekIndex;

                        if (week >= startWeek && week <= endWeek) {
                            const startCol = calendarSelection.start.colIndex;
                            const endCol = calendarSelection.end.colIndex;
                            const minCol = Math.min(startCol, endCol);
                            const maxCol = Math.max(startCol, endCol);

                            if (week === startWeek && week === endWeek) {
                                // Same week selection
                                if (day >= minCol && day <= maxCol) {
                                    isSelected = true;
                                    if (day === minCol) isRangeStart = true;
                                    if (day === maxCol) isRangeEnd = true;
                                }
                            } else if (week === startWeek) {
                                // Start week
                                if (day >= startCol) {
                                    isSelected = true;
                                    if (day === startCol) isRangeStart = true;
                                }
                            } else if (week === endWeek) {
                                // End week
                                if (day <= endCol) {
                                    isSelected = true;
                                    if (day === endCol) isRangeEnd = true;
                                }
                            } else {
                                // Middle weeks
                                isSelected = true;
                            }
                        }
                    }

                    html += `
                        <div class="border-r border-b border-slate-200 dark:border-slate-700 p-2 relative cursor-cell transition-colors ${isCurrentMonth ? (isToday ? 'bg-hub-50 dark:bg-hub-900/10' : 'bg-white dark:bg-slate-900') : 'bg-slate-50 dark:bg-slate-950'} ${isSelected ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-700 border-y-2 border-t-indigo-400 dark:border-t-indigo-500 border-b-indigo-400 dark:border-b-indigo-500' : ''} ${isRangeStart ? 'border-l-2 border-l-indigo-400 dark:border-l-indigo-500 rounded-l-sm' : ''} ${isRangeEnd ? 'border-r-2 border-r-indigo-400 dark:border-r-indigo-500 rounded-r-sm' : ''}"
                            style="min-height: ${cellHeight}px;"
                            data-day-index="${dayIdx}"
                            data-week="${week}"
                            onmousedown="handleCalendarDateMouseDown(event, new Date(${gridDate.getTime()}), ${day}, ${week})"
                            onmouseenter="handleCalendarDateMouseEnter(new Date(${gridDate.getTime()}), ${day}, ${week})"
                            onmouseup="handleCalendarDateMouseUp()">
                            <div class="font-bold text-sm mb-1 ${isCurrentMonth ? (isSelected ? 'text-indigo-600 dark:text-indigo-400 font-bold' : 'text-slate-800 dark:text-white') : 'text-slate-400 dark:text-slate-600'}">
                                ${dayNum}
                            </div>
                        </div>
                    `;

                    gridDate.setDate(gridDate.getDate() + 1);
                }
            }

            html += `</div>`;

            // Render events as absolutely positioned bars with dynamic sizing
            eventSegments.forEach(segment => {
                const isCalendarEvent = !segment.id.startsWith('task-');

                // Get sizing for the first day this segment spans
                const firstDayIdx = (segment.weekIndex * 7) + segment.colIndex;
                const segmentSizing = daySizing[firstDayIdx] || defaultSizing;

                html += `
                    <div class="calendar-event ${segment.color} text-white text-xs rounded-md shadow-sm border border-white/10 cursor-move hover:brightness-105 hover:shadow-md transition-all duration-150 absolute flex items-center justify-center px-1.5 overflow-hidden select-none"
                        data-event-id="${segment.id}"
                        data-week="${segment.weekIndex}"
                        data-col-start="${segment.colIndex}"
                        data-col-span="${segment.span}"
                        data-lane="${segment.laneIndex}"
                        data-day-index="${firstDayIdx}"
                        onmousedown="calendarStartDrag(event, '${segment.id}', 'move')"
                        title="${segment.title}"
                        style="z-index: ${isCalendarEvent ? 10 : 5}; height: ${segmentSizing.height}px; font-size: ${segmentSizing.fontSize};">
                        ${isCalendarEvent || segment.id.startsWith('task-') ? `
                            <div class="absolute left-0 top-0 bottom-0 w-1.5 cursor-e-resize z-20 hover:bg-black/10 transition-colors rounded-l"
                                onmousedown="event.stopPropagation(); calendarStartDrag(event, '${segment.id}', 'resize-start')"></div>
                            <span class="pointer-events-none z-0 drop-shadow-sm truncate text-center w-full px-0.5 font-medium" style="font-size: ${segmentSizing.fontSize};">${segment.title}</span>
                            <div class="absolute right-0 top-0 bottom-0 w-1.5 cursor-w-resize z-20 hover:bg-black/10 transition-colors rounded-r"
                                onmousedown="event.stopPropagation(); calendarStartDrag(event, '${segment.id}', 'resize-end')"></div>
                        ` : `<span class="truncate font-medium" style="font-size: ${segmentSizing.fontSize};">${segment.title}</span>`}
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // Update floating action bar if selection exists (managed dynamically)
            if (calendarSelection) {
                updateFloatingActionBar();
            }

            // Calculate and apply positions after DOM is rendered
            setTimeout(() => {
                const grid = document.getElementById('myDesk-month-calendar-grid');
                if (grid) {
                    const gridWidth = grid.offsetWidth;
                    const columnWidth = gridWidth / 7;
                    const headerHeight = 48;

                    eventSegments.forEach(segment => {
                        const eventEls = container.querySelectorAll(`[data-event-id="${segment.id}"][data-week="${segment.weekIndex}"]`);
                        eventEls.forEach(eventEl => {
                            // Get dynamic sizing for this segment
                            const firstDayIdx = (segment.weekIndex * 7) + segment.colIndex;
                            const segmentSizing = daySizing[firstDayIdx] || defaultSizing;

                            // Calculate week top position using dynamic cell heights
                            let weekTop = headerHeight;
                            for (let w = 0; w < segment.weekIndex; w++) {
                                weekTop += (weekCellHeights[w] || CALENDAR_SIZING.month.defaultCellHeight);
                            }

                            const left = segment.colIndex * columnWidth + 1;
                            const width = segment.span * columnWidth - 2;
                            const top = weekTop + ROW_PADDING_TOP + (segment.laneIndex * (segmentSizing.height + segmentSizing.gap));

                            eventEl.style.left = left + 'px';
                            eventEl.style.width = width + 'px';
                            eventEl.style.top = top + 'px';
                            eventEl.style.height = segmentSizing.height + 'px';
                        });
                    });
                }
            }, 0);
        }

        function loadData() {
            checkAuthStatus();
            const saved = localStorage.getItem('leadershipOSData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    appData = { ...appData, ...parsed };

                    // Initialize missing arrays
                    if (!appData.team) appData.team = [];
                    if (!appData.logbook) appData.logbook = [];
                    if (!appData.broadcasts) appData.broadcasts = [];
                    if (!appData.myDesk) appData.myDesk = [];
                    if (!appData.calendarEvents) appData.calendarEvents = [];
                    if (!appData.checkins) appData.checkins = {};
                    if (!appData.rollCall) appData.rollCall = {};

                    // --- FIX: Initialize Capacity Data ---
                    if (!appData.capacity) appData.capacity = [];
                    if (!appData.capto) appData.capto = [];

                    if (!appData.mailboxOrder) appData.mailboxOrder = [];
                    if (!appData.quickLinks) appData.quickLinks = [];
                    if (!appData.performanceCustomWSLL) appData.performanceCustomWSLL = {};
                    if (!appData.projects) appData.projects = [];

                    // Initialize userProfile if missing
                    if (!appData.userProfile) {
                        appData.userProfile = {
                            email: "admin@leados.com",
                            name: "Admin"
                        };
                    }

                    // Focus mode defaults
                    if (appData.focusTaskId === undefined) appData.focusTaskId = null;
                    if (appData.focusEndAt === undefined) appData.focusEndAt = null;
                    if (appData.focusShowNotes === undefined) appData.focusShowNotes = false;

                    // Initialize Garshu Notifications System
                    if (!appData.garshuNotifications) {
                        appData.garshuNotifications = {
                            unread: [],
                            lastSentTime: null,
                            cooldownHours: 4,
                            proactiveEnabled: true, // Default to enabled
                            triggers: {
                                morningBrief: { enabled: true, lastSent: null },
                                driftNudge: { enabled: true, lastSent: null },
                                victoryLap: { enabled: true, lastSent: null }
                            }
                        };
                    }

                    migrateData();
                    renderUserProfile();
                    renderFocusPill();
                    initFocusTimer();
                } catch (e) {
                    console.error("Data corrupt, initializing empty.", e);
                }
            }
            checkBackupStatus();

            // Re-attach Command Palette listeners
            const cmdInput = document.getElementById('cmdInput');
            if (cmdInput) {
                const newInput = cmdInput.cloneNode(true);
                cmdInput.parentNode.replaceChild(newInput, cmdInput);
                newInput.addEventListener('input', (e) => {
                    cmdSelectedIndex = 0;
                    renderCommands(e.target.value);
                    if (window.updateCmdHighlight) setTimeout(() => window.updateCmdHighlight(), 10);
                });
                initCommandPaletteNav(); // Initialize the navigation engine
                newInput.focus();
            }

            // Initialize Date Inputs
            document.querySelectorAll('input[type="date"]').forEach(updateDateInput);

            // Global ESC Key Handler - Only for specialized overlays (not modals)
            // Modal closing is handled by Power Shortcuts Engine v2.0
            document.addEventListener('keydown', function (e) {
                if (e.key !== 'Escape') return;

                // Priority 1: Close premium calendar if open (the calendar widget overlay)
                const premiumCal = document.getElementById('premiumCalendar');
                if (premiumCal && !premiumCal.classList.contains('hidden')) {
                    e.preventDefault();
                    e.stopImmediatePropagation(); // Stop other handlers
                    premiumCal.classList.add('hidden');
                    document.removeEventListener('click', closePremiumCalendarOutside);
                    return;
                }

                // Priority 2: Close global task date picker if open (the date settings modal)
                const globalDatePicker = document.getElementById('global-task-date-popover');
                if (globalDatePicker && !globalDatePicker.classList.contains('hidden')) {
                    e.preventDefault();
                    e.stopImmediatePropagation(); // Stop other handlers
                    closeGlobalDatePicker();
                    return;
                }

                // All other ESC handling (modals, input blur) is done by Power Shortcuts Engine
            });

            // Start default view
            switchTool('ActionHub');
        }

        function saveData(skipRender = false) {
            localStorage.setItem('leadershipOSData', JSON.stringify(appData));
            // Refresh active view only if not skipping render
            if (!skipRender) {
                if (activeTool === 'ActionHub') renderHubView();
                if (activeTool === 'PulseCheck') renderPulseView();
            }
        }

        function renderUserProfile() {
            if (!appData.userProfile) {
                appData.userProfile = {
                    email: "admin@leados.com",
                    name: "Admin"
                };
            }

            const email = appData.userProfile.email || "admin@leados.com";
            const name = appData.userProfile.name || email.split('@')[0];

            // Update name (no avatar needed in pill design)
            const nameEl = document.getElementById('userProfileName');
            if (nameEl) {
                nameEl.textContent = name;
            }
        }

        // --- HOOK: Integrate into existing saveData() ---
        // Important: This must run AFTER your original saveData function is defined.
        // Place this block right after your `function saveData() { ... }` definition.
        const originalSaveData = saveData;
        saveData = function (skipRender = false) {
            originalSaveData(skipRender); // 1. Run the original localStorage save (Instant)
            LocalBackup.save(); // 2. Trigger the hard drive save (Async/Background)
        };

        function migrateData() {
            // Ensure every team member has an ID and active status
            appData.team.forEach((tm, index) => {
                if (!tm.id) tm.id = 1000 + index;
                if (tm.active === undefined) tm.active = true;
                if (!tm.role) tm.role = "Team Member";
            });

            // --- MIGRATION: Monthly Pulse ---
            // Ensure 'pulse' setting exists for legacy data
            if (appData.settings && appData.settings.modules) {
                if (appData.settings.modules.pulse === undefined) {
                    appData.settings.modules.pulse = true;
                }
            }

            // --- MIGRATION: Unified Performance System ---
            // Migrate from separate quarterly strategy + monthly rating to unified monthly entries
            appData.team.forEach(member => {
                if (!member.history) member.history = [];

                // Group entries by month to process each month
                const monthlyEntries = {};
                const strategyEntries = {};

                // Separate existing entries
                member.history.forEach(entry => {
                    if (entry.isStrategyEntry && entry.quarter) {
                        // Quarterly strategy entry
                        strategyEntries[entry.quarter] = entry;
                    } else if (!entry.isStrategyEntry && entry.month) {
                        // Monthly rating entry
                        monthlyEntries[entry.month] = entry;
                    }
                });

                // Function to get quarter for a month
                const getQuarterForMonth = (monthStr) => {
                    if (!monthStr) return null;
                    const [month] = monthStr.split(" '");
                    const monthMap = { "Jan": 0, "Feb": 0, "Mar": 0, "Apr": 1, "May": 1, "Jun": 1, "Jul": 2, "Aug": 2, "Sep": 2, "Oct": 3, "Nov": 3, "Dec": 3 };
                    const quarterNum = monthMap[month];
                    const [, year] = monthStr.split(" '");
                    return `Q${quarterNum + 1} '${year}`;
                };

                // Process each monthly entry
                Object.keys(monthlyEntries).forEach(month => {
                    const monthlyEntry = monthlyEntries[month];
                    const quarter = getQuarterForMonth(month);
                    const strategyEntry = strategyEntries[quarter];

                    // Create unified entry if we have both strategy and rating
                    if (strategyEntry && strategyEntry.metrics) {
                        // Find existing unified entry or create new one
                        let unifiedEntry = member.history.find(h =>
                            h.month === month &&
                            h.isUnifiedEntry === true
                        );

                        if (!unifiedEntry) {
                            unifiedEntry = {
                                month: month,
                                isUnifiedEntry: true, // New flag to identify migrated entries
                                metrics: [],
                                finalScore: monthlyEntry.finalScore || 0,
                                valuesScore: monthlyEntry.valuesScore || 0,
                                attendance: monthlyEntry.attendance || 0,
                                coreValues: monthlyEntry.coreValues || {},
                                createdAt: monthlyEntry.createdAt || Date.now()
                            };

                            // Combine strategy metrics with monthly scores
                            strategyEntry.metrics.forEach(strategyMetric => {
                                const ratingMetric = monthlyEntry.metrics?.find(m => m.name === strategyMetric.name);
                                unifiedEntry.metrics.push({
                                    name: strategyMetric.name,
                                    definition: strategyMetric.definition || '',
                                    score: ratingMetric ? ratingMetric.score : 0,
                                    wsll: ratingMetric ? ratingMetric.wsll : null
                                });
                            });

                            member.history.push(unifiedEntry);
                        }
                    }
                });

                // Mark old entries as migrated (don't delete them yet for safety)
                member.history.forEach(entry => {
                    if (entry.isStrategyEntry || (!entry.isUnifiedEntry && !entry.isStrategyEntry)) {
                        entry.migratedToUnified = true;
                    }
                });
            });

            // --- MIGRATION: Convert range dates to single dates ---
            // Convert My Desk tasks with range dates to single dates (use end date)
            // Convert Logbook entries with range dates to single dates (use end date)
            if (appData.logbook) {
                appData.logbook.forEach(entry => {
                    if (entry.dueDateStart && entry.dueDateEnd) {
                        entry.dueDate = entry.dueDateEnd;
                        delete entry.dueDateStart;
                        delete entry.dueDateEnd;
                    }
                });
            }

            // Broadcasts now support range dates - no conversion needed
            // Legacy code removed to preserve range date functionality
        }

        function exportData() {
            const data = {
                version: '1.2', // Updated version for tracking
                todos: appData.todos,
                team: appData.team,
                pulseCheckData: appData.pulseCheckData,
                projects: appData.projects,         // Ensure projects are backed up
                accountColors: appData.accountColors, // Ensure theme settings are backed up
                checkins: appData.checkins,
                ewsHistory: appData.ewsHistory,
                timesheets: appData.timesheets,
                rollCall: appData.rollCall,
                capacity: appData.capacity,
                capto: appData.capto,
                logbook: appData.logbook,
                broadcasts: appData.broadcasts,
                myDesk: appData.myDesk,
                calendarEvents: appData.calendarEvents,
                evaluations: appData.evaluations,
                meta: appData.meta,
                completedMyDesk: appData.completedMyDesk,
                quickLinks: appData.quickLinks,
                mailboxOrder: appData.mailboxOrder,
                garshuNotifications: appData.garshuNotifications,
                settings: appData.settings,
                braindump: localStorage.getItem('leadership_os_braindump') || '',
                attendanceHistory: getAttendanceHistory(),
                snoozedTasks: JSON.parse(localStorage.getItem('leadership_os_snoozed') || '[]'),
                emailGuide: localStorage.getItem('leadership_os_email_guide') || ''
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `leadership_os_backup_${dateStr}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast("Backup generated successfully", "success");

            // Hide the backup reminder banner
            const reminderEl = document.getElementById('backupReminder');
            if (reminderEl) {
                reminderEl.classList.add('hidden');
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // --- SECURITY CHECK ---
                    if (!data.team || !Array.isArray(data.team)) {
                        throw new Error("Invalid Backup File: Missing 'team' roster data.");
                    }

                    // 1. Restore Core Data directly into appData
                    if (data.todos) appData.todos = data.todos;
                    if (data.team) appData.team = data.team;
                    if (data.pulseCheckData) appData.pulseCheckData = data.pulseCheckData;
                    if (data.checkins) appData.checkins = data.checkins;
                    if (data.ewsHistory) appData.ewsHistory = data.ewsHistory;
                    if (data.timesheets) appData.timesheets = data.timesheets;
                    if (data.rollCall) appData.rollCall = data.rollCall;
                    if (data.capacity) appData.capacity = data.capacity;
                    if (data.capto) appData.capto = data.capto;
                    if (data.logbook) appData.logbook = data.logbook;
                    if (data.broadcasts) appData.broadcasts = data.broadcasts;
                    if (data.myDesk) appData.myDesk = data.myDesk;
                    if (data.calendarEvents) appData.calendarEvents = data.calendarEvents;
                    if (data.evaluations) appData.evaluations = data.evaluations;
                    if (data.completedMyDesk) appData.completedMyDesk = data.completedMyDesk;

                    // Initialize sortOrder for existing tasks if not present
                    if (appData.myDesk) {
                        initializeTaskSortOrders();
                    }

                    if (data.quickLinks) appData.quickLinks = data.quickLinks;
                    if (data.mailboxOrder) appData.mailboxOrder = data.mailboxOrder;
                    if (data.garshuNotifications) appData.garshuNotifications = data.garshuNotifications;
                    if (data.settings) appData.settings = data.settings;

                    // 2. Restore Projects
                    if (data.projects) {
                        appData.projects = data.projects;
                    }

                    // 3. Restore Account Colors (Personalization)
                    if (data.accountColors) {
                        appData.accountColors = data.accountColors;
                    }

                    // 4. Restore Brain Dump (localStorage)
                    if (data.braindump !== undefined) {
                        localStorage.setItem('leadership_os_braindump', data.braindump || '');
                        if (typeof loadBrainDumpContent === 'function') {
                            loadBrainDumpContent(); // Refresh the textarea if panel is visible
                        }
                    }

                    // 5. Restore Attendance History (localStorage)
                    if (data.attendanceHistory) {
                        localStorage.setItem('leadership_os_attendance_history', JSON.stringify(data.attendanceHistory));
                    }

                    // 6. Restore Snoozed Tasks (localStorage)
                    if (data.snoozedTasks) {
                        localStorage.setItem('leadership_os_snoozed', JSON.stringify(data.snoozedTasks));
                        if (typeof updateSnoozeButton === 'function') {
                            updateSnoozeButton(); // Refresh the badge
                        }
                    }

                    // 7. Restore Email Guide Template (localStorage)
                    if (data.emailGuide !== undefined) {
                        localStorage.setItem('leadership_os_email_guide', data.emailGuide);
                    }

                    // 8. Update Meta
                    if (data.meta) appData.meta = data.meta;

                    // 9. Save all changes to LocalStorage
                    saveData();

                    // 10. Re-render all relevant UI components
                    if (typeof renderHubView === 'function') renderHubView();
                    if (typeof renderPulseView === 'function') renderPulseView();
                    if (typeof applyAccountColors === 'function') applyAccountColors();

                    showToast("Full system restore successful!", "success");

                } catch (err) {
                    console.error("Restore failed:", err);
                    showToast("Invalid backup file format: " + err.message, "error");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // ==========================================
        // CLOUD SYNC FUNCTIONS (Supabase Storage)
        // ==========================================
        
        async function pushToCloud() {
            const btn = document.getElementById('btnPushCloud');
            const statusEl = document.getElementById('cloudSyncStatusText');
            const statusIndicator = document.getElementById('cloudSyncStatus');
            
            try {
                // Check if user is authenticated
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showToast("Please log in to use cloud sync", "error");
                    return;
                }

                // Disable button and show loading state
                btn.disabled = true;
                const originalText = btn.querySelector('span').innerText;
                btn.querySelector('span').innerText = 'Pushing...';

                // Prepare data (same as exportData)
                const data = {
                    version: '1.2',
                    todos: appData.todos,
                    team: appData.team,
                    pulseCheckData: appData.pulseCheckData,
                    projects: appData.projects,
                    accountColors: appData.accountColors,
                    checkins: appData.checkins,
                    ewsHistory: appData.ewsHistory,
                    timesheets: appData.timesheets,
                    rollCall: appData.rollCall,
                    capacity: appData.capacity,
                    capto: appData.capto,
                    logbook: appData.logbook,
                    broadcasts: appData.broadcasts,
                    myDesk: appData.myDesk,
                    calendarEvents: appData.calendarEvents,
                    evaluations: appData.evaluations,
                    meta: appData.meta,
                    completedMyDesk: appData.completedMyDesk,
                    quickLinks: appData.quickLinks,
                    mailboxOrder: appData.mailboxOrder,
                    garshuNotifications: appData.garshuNotifications,
                    settings: appData.settings,
                    braindump: localStorage.getItem('leadership_os_braindump') || '',
                    attendanceHistory: getAttendanceHistory(),
                    snoozedTasks: JSON.parse(localStorage.getItem('leadership_os_snoozed') || '[]'),
                    emailGuide: localStorage.getItem('leadership_os_email_guide') || '',
                    syncedAt: new Date().toISOString()
                };

                // Convert to blob
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const fileName = `${session.user.id}/leadership_data_backup.json`;

                // Upload to Supabase Storage
                const { error: uploadError } = await supabaseClient.storage
                    .from('leadership-os-backups')
                    .upload(fileName, blob, {
                        upsert: true,
                        contentType: 'application/json'
                    });

                if (uploadError) throw uploadError;

                // Update status
                const now = new Date().toLocaleString();
                statusEl.innerText = `Last pushed: ${now}`;
                statusIndicator.querySelector('.w-2').classList.remove('bg-slate-300');
                statusIndicator.querySelector('.w-2').classList.add('bg-green-500');

                // Store last sync time in localStorage
                localStorage.setItem('leadership_os_last_cloud_sync', new Date().toISOString());

                showToast("Data pushed to cloud successfully!", "success");

            } catch (error) {
                console.error('Push to cloud error:', error);
                showToast("Failed to push to cloud: " + error.message, "error");
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.querySelector('span').innerText = 'Push to Cloud';
            }
        }

        async function pullFromCloud() {
            const btn = document.getElementById('btnPullCloud');
            const statusEl = document.getElementById('cloudSyncStatusText');
            const statusIndicator = document.getElementById('cloudSyncStatus');
            
            try {
                // Check if user is authenticated
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    showToast("Please log in to use cloud sync", "error");
                    return;
                }

                // Confirm before overwriting local data
                const confirmPull = confirm(" This will overwrite your local data with the cloud backup. Continue?");
                if (!confirmPull) return;

                // Disable button and show loading state
                btn.disabled = true;
                const originalText = btn.querySelector('span').innerText;
                btn.querySelector('span').innerText = 'Pulling...';

                const fileName = `${session.user.id}/leadership_data_backup.json`;

                // Download from Supabase Storage
                const { data: fileData, error: downloadError } = await supabaseClient.storage
                    .from('leadership-os-backups')
                    .download(fileName);

                if (downloadError) throw downloadError;

                // Parse the JSON
                const text = await fileData.text();
                const data = JSON.parse(text);

                // Restore data (same logic as importData)
                if (!data.team || !Array.isArray(data.team)) {
                    throw new Error("Invalid Backup File: Missing 'team' roster data.");
                }

                // Restore all data
                if (data.todos) appData.todos = data.todos;
                if (data.team) appData.team = data.team;
                if (data.pulseCheckData) appData.pulseCheckData = data.pulseCheckData;
                if (data.checkins) appData.checkins = data.checkins;
                if (data.ewsHistory) appData.ewsHistory = data.ewsHistory;
                if (data.timesheets) appData.timesheets = data.timesheets;
                if (data.rollCall) appData.rollCall = data.rollCall;
                if (data.capacity) appData.capacity = data.capacity;
                if (data.capto) appData.capto = data.capto;
                if (data.logbook) appData.logbook = data.logbook;
                if (data.broadcasts) appData.broadcasts = data.broadcasts;
                if (data.myDesk) appData.myDesk = data.myDesk;
                if (data.calendarEvents) appData.calendarEvents = data.calendarEvents;
                if (data.evaluations) appData.evaluations = data.evaluations;
                if (data.completedMyDesk) appData.completedMyDesk = data.completedMyDesk;

                if (appData.myDesk) {
                    initializeTaskSortOrders();
                }

                if (data.quickLinks) appData.quickLinks = data.quickLinks;
                if (data.mailboxOrder) appData.mailboxOrder = data.mailboxOrder;
                if (data.garshuNotifications) appData.garshuNotifications = data.garshuNotifications;
                if (data.settings) appData.settings = data.settings;
                if (data.projects) appData.projects = data.projects;
                if (data.accountColors) appData.accountColors = data.accountColors;

                // Restore localStorage items
                if (data.braindump) localStorage.setItem('leadership_os_braindump', data.braindump);
                if (data.snoozedTasks) localStorage.setItem('leadership_os_snoozed', JSON.stringify(data.snoozedTasks));
                if (data.emailGuide) localStorage.setItem('leadership_os_email_guide', data.emailGuide);
                if (data.attendanceHistory) {
                    for (const [key, value] of Object.entries(data.attendanceHistory)) {
                        localStorage.setItem(key, JSON.stringify(value));
                    }
                }

                if (data.meta) appData.meta = data.meta;

                // Save all changes
                saveData();

                // Re-render UI
                if (typeof renderHubView === 'function') renderHubView();
                if (typeof renderPulseView === 'function') renderPulseView();
                if (typeof applyAccountColors === 'function') applyAccountColors();

                // Update status
                const syncTime = data.syncedAt ? new Date(data.syncedAt).toLocaleString() : 'Unknown';
                statusEl.innerText = `Last pulled: ${syncTime}`;
                statusIndicator.querySelector('.w-2').classList.remove('bg-slate-300');
                statusIndicator.querySelector('.w-2').classList.add('bg-blue-500');

                showToast("Data pulled from cloud successfully!", "success");

            } catch (error) {
                console.error('Pull from cloud error:', error);
                if (error.message.includes('Object not found')) {
                    showToast("No cloud backup found. Push your data first.", "error");
                } else {
                    showToast("Failed to pull from cloud: " + error.message, "error");
                }
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.querySelector('span').innerText = 'Pull from Cloud';
            }
        }

        // Update cloud sync status on page load
        async function updateCloudSyncStatus() {
            const statusEl = document.getElementById('cloudSyncStatusText');
            const statusIndicator = document.getElementById('cloudSyncStatus');
            
            if (!statusEl || !statusIndicator) return;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    statusEl.innerText = 'Not logged in';
                    return;
                }

                const lastSync = localStorage.getItem('leadership_os_last_cloud_sync');
                if (lastSync) {
                    const syncDate = new Date(lastSync).toLocaleString();
                    statusEl.innerText = `Last synced: ${syncDate}`;
                    statusIndicator.querySelector('.w-2').classList.remove('bg-slate-300');
                    statusIndicator.querySelector('.w-2').classList.add('bg-green-500');
                } else {
                    statusEl.innerText = 'Never synced';
                }
            } catch (error) {
                console.error('Error updating cloud sync status:', error);
            }
        }

        function checkBackupStatus() {
            const last = appData.meta.lastBackup;
            const now = Date.now();
            const sevenDays = 7 * 24 * 60 * 60 * 1000;

            // Check if alert was dismissed
            const dismissedUntil = localStorage.getItem('backupAlertDismissedUntil');
            const isDismissed = dismissedUntil && parseInt(dismissedUntil) > now;

            // 1. Alert Banner logic
            const reminderEl = document.getElementById('backupReminder');
            if (reminderEl) {
                if (!isDismissed && (!last || (now - last > sevenDays))) {
                    reminderEl.classList.remove('hidden');
                } else {
                    reminderEl.classList.add('hidden');
                }
            }

            // 2. Friday Pulse Logic
            const today = new Date();
            const btnSettings = document.getElementById('btnSettings'); // Header Gear
            const btnBackup = document.getElementById('btnBackup');     // Modal Button

            if (today.getDay() === 5) {
                // Pulse the gear icon
                if (btnSettings) {
                    btnSettings.classList.add('text-amber-400', 'animate-pulse');
                    btnSettings.classList.remove('text-slate-400');
                }
                // Highlight the internal button so they know what to click
                if (btnBackup) {
                    btnBackup.classList.add('border-amber-400', 'bg-amber-50');
                    btnBackup.classList.remove('border-blue-200', 'bg-white');
                    const span = btnBackup.querySelector('span');
                    if (span) span.innerText = "Backup (It's Friday!)";
                }
            } else {
                // Reset styles
                if (btnSettings) {
                    btnSettings.classList.remove('text-amber-400', 'animate-pulse');
                    btnSettings.classList.add('text-slate-400');
                }
                if (btnBackup) {
                    btnBackup.classList.remove('border-amber-400', 'bg-amber-50');
                    btnBackup.classList.add('border-blue-200', 'bg-white');
                    const span = btnBackup.querySelector('span');
                    if (span) span.innerText = "Backup Data";
                }
            }
        }

        function dismissBackupAlert() {
            // Dismiss for 24 hours
            const dismissUntil = Date.now() + (24 * 60 * 60 * 1000);
            localStorage.setItem('backupAlertDismissedUntil', dismissUntil.toString());
            const reminderEl = document.getElementById('backupReminder');
            if (reminderEl) {
                reminderEl.classList.add('hidden');
            }
            showToast("Alert dismissed for 24 hours", "info");
        }

        // ==========================================
        // SHARED UTILITIES
        // ==========================================
        function getTodayShort() { return new Date().toISOString().split('T')[0]; }
        function getToday() { return new Date(); }

        // ==========================================
        // RELIABILITY MATRIX - Attendance History Storage
        // ==========================================
        function getAttendanceHistory() {
            try {
                const stored = localStorage.getItem('leadership_os_attendance_history');
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error('Error reading attendance history:', e);
                return {};
            }
        }

        function saveAttendanceHistory(data) {
            try {
                localStorage.setItem('leadership_os_attendance_history', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving attendance history:', e);
            }
        }

        function updateAttendanceStatus(date, tmId, status) {
            const history = getAttendanceHistory();
            if (!history[date]) history[date] = {};
            if (status) {
                history[date][tmId] = status;
            } else {
                delete history[date][tmId];
                if (Object.keys(history[date]).length === 0) {
                    delete history[date];
                }
            }
            saveAttendanceHistory(history);
        }

        function isWeekend(dateString) {
            const date = new Date(dateString + 'T12:00:00');
            const day = date.getDay();
            return day === 0 || day === 6; // Sunday = 0, Saturday = 6
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getWeekdayCount(year, month) {
            let count = 0;
            const daysInMonth = getDaysInMonth(year, month);
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Not Sunday (0) or Saturday (6)
                    count++;
                }
            }
            return count;
        }

        function calculateScore(tmId, year, month) {
            const history = getAttendanceHistory();
            const daysInMonth = getDaysInMonth(year, month);
            let totalPoints = 0;
            let ptoDays = 0;

            // Count weekdays and calculate points
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();

                // Skip weekends
                if (dayOfWeek === 0 || dayOfWeek === 6) continue;

                // Format date as YYYY-MM-DD
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const status = history[dateString]?.[tmId];

                if (status === 'pto') {
                    ptoDays++;
                } else if (status === 'present') {
                    totalPoints += 1.0;
                } else if (status === 'late') {
                    totalPoints += 0.5;
                } else if (status === 'unplanned') {
                    totalPoints += 0.0;
                }
                // Empty/undefined = 0 points, but still counts as workable day
            }

            const totalWeekdays = getWeekdayCount(year, month);
            const totalWorkableDays = totalWeekdays - ptoDays;

            if (totalWorkableDays === 0) return 0;

            return Math.round((totalPoints / totalWorkableDays) * 100);
        }

        function getMonthKey(d) {
            // If d is a string (e.g. "2025-12-01"), append Noon to prevent timezone fallback
            let dateObj = d;
            if (typeof d === 'string') {
                // Check if it's just a date string YYYY-MM-DD
                if (d.length === 10 && d.includes('-')) {
                    dateObj = new Date(d + 'T12:00:00');
                } else {
                    dateObj = new Date(d);
                }
            }

            // Safety check
            if (isNaN(dateObj.getTime())) return "Unknown";

            return dateObj.getFullYear() + '-' + String(dateObj.getMonth() + 1).padStart(2, '0');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const [year, month, day] = dateStr.split('-');
            return `${month}/${day}/${year}`;
        }

        function getDaysDiff(date1, date2) {
            const d1 = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const d2 = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
            return Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
        }

        // Shared helper to check if a date is within [-5 days to +7 days] window
        // Handles year wrap-arounds (e.g., Dec 30 to Jan 2) automatically
        function isDateInActiveWindow(dateStr) {
            if (!dateStr) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const [y, m, d] = dateStr.split('-').map(Number);

            // We check 3 scenarios to handle year boundaries safely:
            // 1. Event is this year
            // 2. Event is next year (e.g., Today is Dec 30, Bday is Jan 2)
            // 3. Event was last year (e.g., Today is Jan 2, Bday was Dec 30)
            const yearsToCheck = [today.getFullYear(), today.getFullYear() + 1, today.getFullYear() - 1];

            for (let year of yearsToCheck) {
                let target = new Date(year, m - 1, d);
                const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));

                // THE WINDOW: 5 days ago (-5) to 7 days in future (+7)
                if (diff >= -5 && diff <= 7) {
                    return true;
                }
            }
            return false;
        }

        function isBirthdayApproaching(dateStr) {
            return isDateInActiveWindow(dateStr);
        }

        function isAnniversaryApproaching(dateStr) {
            return isDateInActiveWindow(dateStr);
        }

        // ==========================================
        // ACCOUNT COLOR MANAGER
        // ==========================================
        const COLOR_PALETTE = [
            { id: 'slate', label: 'Slate', bg: 'bg-slate-100 dark:bg-slate-800', text: 'text-slate-800 dark:text-slate-200', border: 'border-slate-200 dark:border-slate-600' },
            { id: 'red', label: 'Red', bg: 'bg-red-100 dark:bg-red-900/30', text: 'text-red-800 dark:text-red-200', border: 'border-red-200 dark:border-red-700' },
            { id: 'orange', label: 'Orange', bg: 'bg-orange-100 dark:bg-orange-900/30', text: 'text-orange-800 dark:text-orange-200', border: 'border-orange-200 dark:border-orange-700' },
            { id: 'amber', label: 'Amber', bg: 'bg-amber-100 dark:bg-amber-900/30', text: 'text-amber-800 dark:text-amber-200', border: 'border-amber-200 dark:border-amber-700' },
            { id: 'yellow', label: 'Yellow', bg: 'bg-yellow-100 dark:bg-yellow-900/30', text: 'text-yellow-800 dark:text-yellow-200', border: 'border-yellow-200 dark:border-yellow-700' },
            { id: 'lime', label: 'Lime', bg: 'bg-lime-100 dark:bg-lime-900/30', text: 'text-lime-800 dark:text-lime-200', border: 'border-lime-200 dark:border-lime-700' },
            { id: 'green', label: 'Green', bg: 'bg-green-100 dark:bg-green-900/30', text: 'text-green-800 dark:text-green-200', border: 'border-green-200 dark:border-green-700' },
            { id: 'teal', label: 'Teal', bg: 'bg-teal-100 dark:bg-teal-900/30', text: 'text-teal-800 dark:text-teal-200', border: 'border-teal-200 dark:border-teal-700' },
            { id: 'cyan', label: 'Cyan', bg: 'bg-cyan-100 dark:bg-cyan-900/30', text: 'text-cyan-800 dark:text-cyan-200', border: 'border-cyan-200 dark:border-cyan-700' },
            { id: 'blue', label: 'Blue', bg: 'bg-blue-100 dark:bg-blue-900/30', text: 'text-blue-800 dark:text-blue-200', border: 'border-blue-200 dark:border-blue-700' },
            { id: 'indigo', label: 'Indigo', bg: 'bg-indigo-100 dark:bg-indigo-900/30', text: 'text-indigo-800 dark:text-indigo-200', border: 'border-indigo-200 dark:border-indigo-700' },
            { id: 'violet', label: 'Violet', bg: 'bg-violet-100 dark:bg-violet-900/30', text: 'text-violet-800 dark:text-violet-200', border: 'border-violet-200 dark:border-violet-700' },
            { id: 'purple', label: 'Purple', bg: 'bg-purple-100 dark:bg-purple-900/30', text: 'text-purple-800 dark:text-purple-200', border: 'border-purple-200 dark:border-purple-700' },
            { id: 'fuchsia', label: 'Fuchsia', bg: 'bg-fuchsia-100 dark:bg-fuchsia-900/30', text: 'text-fuchsia-800 dark:text-fuchsia-200', border: 'border-fuchsia-200 dark:border-fuchsia-700' },
            { id: 'pink', label: 'Pink', bg: 'bg-pink-100 dark:bg-pink-900/30', text: 'text-pink-800 dark:text-pink-200', border: 'border-pink-200 dark:border-pink-700' },
            { id: 'rose', label: 'Rose', bg: 'bg-rose-100 dark:bg-rose-900/30', text: 'text-rose-800 dark:text-rose-200', border: 'border-rose-200 dark:border-rose-700' }
        ];

        function openColorManager() {
            if (!appData.accountColors) appData.accountColors = {};
            const accounts = [...new Set(appData.team.map(t => t.account || 'Unassigned'))].filter(a => a).sort();
            const list = document.getElementById('colorModalList');
            list.innerHTML = '';

            if (accounts.length === 0) list.innerHTML = '<p class="text-slate-500 text-center">No accounts found.</p>';

            accounts.forEach(acc => {
                const currentId = appData.accountColors[acc] || 'slate';
                let options = '';
                COLOR_PALETTE.forEach(c => {
                    options += `<option value="${c.id}" ${c.id === currentId ? 'selected' : ''}>${c.label}</option>`;
                });
                const currentColor = COLOR_PALETTE.find(c => c.id === currentId) || COLOR_PALETTE[0];
                const safeId = acc.replace(/[^a-zA-Z0-9]/g, '');

                list.innerHTML += `
                <div class="flex items-center justify-between p-3 bg-white border border-slate-100 rounded-lg shadow-sm">
                    <div class="flex items-center gap-3 w-1/2">
                        <div id="preview-${safeId}" class="w-4 h-4 rounded-full flex-none ${currentColor.bg.replace('100', '400')}"></div>
                        <span class="font-bold text-slate-700 truncate text-sm" title="${acc}">${acc}</span>
                    </div>
                    <select onchange="updateColorPreview(this, '${safeId}')" data-account="${acc}" class="w-1/2 border border-slate-300 rounded text-sm py-1 px-2">
                        ${options}
                    </select>
                </div>`;
            });
            toggleModal('colorModal');
        }

        function updateColorPreview(select, idSuffix) {
            const color = COLOR_PALETTE.find(c => c.id === select.value);
            const preview = document.getElementById(`preview-${idSuffix}`);
            if (preview && color) preview.className = `w-4 h-4 rounded-full flex-none ${color.bg.replace('100', '400')}`;
        }

        function saveAccountColors() {
            if (!appData.accountColors) appData.accountColors = {};
            document.querySelectorAll('#colorModalList select').forEach(sel => {
                appData.accountColors[sel.getAttribute('data-account')] = sel.value;
            });
            saveData();
            toggleModal('colorModal');
            if (typeof renderTeamInfo === 'function') renderTeamInfo();
            if (typeof renderMailbox === 'function') renderMailbox();
            showToast("Colors saved successfully!", "success");
        }

        function getAccountColor(accountName) {
            if (!accountName) return 'bg-slate-100 text-slate-800 border-slate-200';
            if (appData.accountColors && appData.accountColors[accountName]) {
                const theme = COLOR_PALETTE.find(c => c.id === appData.accountColors[accountName]);
                if (theme) return `${theme.bg} ${theme.text} border ${theme.border}`;
            }
            const hash = accountName.split('').reduce((acc, char) => char.charCodeAt(0) + acc, 0);
            const theme = COLOR_PALETTE[hash % COLOR_PALETTE.length];
            return `${theme.bg} ${theme.text} border ${theme.border}`;
        }

        function getBroadcastColor(cat) {
            const map = {
                'HR Update': 'bg-purple-100 text-purple-700 border border-purple-200',
                'IT Update': 'bg-blue-100 text-blue-700 border border-blue-200',
                'Workday Update': 'bg-indigo-100 text-indigo-700 border border-indigo-200',
                'Engagement Program': 'bg-pink-100 text-pink-700 border border-pink-200',
                'Wellness Program': 'bg-green-100 text-green-700 border border-green-200',
                'Weather Update': 'bg-cyan-100 text-cyan-700 border border-cyan-200',
                'Cluster Update': 'bg-orange-100 text-orange-700 border border-orange-200',
                'Team-Specific Update': 'bg-teal-100 text-teal-700 border border-teal-200',
                'General/Others': 'bg-slate-100 text-slate-700 border border-slate-200'
            };
            return map[cat] || 'bg-slate-100 text-slate-700 border border-slate-200';
        }

        function getCategoryColor(category) {
            const DESK_CATEGORY_COLORS = {
                "Admin": "bg-slate-500",
                "Meeting": "bg-teal-500",
                "Project": "bg-blue-500",
                "Payroll": "bg-green-500",
                "Other": "bg-purple-500",
                "Evaluation": "bg-hub-500",
                "Logbook": "bg-pink-500",
                "Broadcast": "bg-orange-500"
            };
            const color = DESK_CATEGORY_COLORS[category] || DESK_CATEGORY_COLORS["Other"];
            return `${color} text-white`;
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            if (!m) return;

            // SAFETY: If trying to CLOSE a modal (it is currently open),
            // check if a higher-priority overlay (Calendar/DatePicker) is open.
            // If so, BLOCK the close.
            if (!m.classList.contains('opacity-0')) {
                const premiumCal = document.getElementById('premiumCalendar');
                if (premiumCal && !premiumCal.classList.contains('hidden')) {
                    // Calendar is open. Block modal close.
                    return;
                }
                const globalDatePicker = document.getElementById('global-task-date-popover');
                if (globalDatePicker && !globalDatePicker.classList.contains('hidden')) {
                    // Date picker is open. Block modal close.
                    return;
                }
            }

            // Play Pop Sound
            if (m.classList.contains('opacity-0')) {
                SoundEngine.pop();
            }

            m.classList.toggle('opacity-0');
            m.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');

            // If opening settings modal, set default tab to General and update dark mode toggle
            if (id === 'settingsModal' && m.classList.contains('opacity-0') === false) {
                switchSettingsTab('general');
                updateDarkModeToggle();

                // Populate user email field
                const emailInput = document.getElementById('set_userEmail');
                if (emailInput && appData.userProfile && appData.userProfile.email) {
                    emailInput.value = appData.userProfile.email;
                }
            }
        }

        function updateDarkModeToggle() {
            const darkModeToggle = document.getElementById('set_darkMode');
            const moonIcon = darkModeToggle?.closest('label')?.querySelector('.icon-moon');
            const sunIcon = darkModeToggle?.closest('label')?.querySelector('.icon-sun');

            if (darkModeToggle) {
                const isDark = document.body.classList.contains('dark-mode');
                darkModeToggle.checked = isDark;

                // Update icon visibility
                if (moonIcon && sunIcon) {
                    if (isDark) {
                        moonIcon.classList.add('hidden');
                        sunIcon.classList.remove('hidden');
                    } else {
                        moonIcon.classList.remove('hidden');
                        sunIcon.classList.add('hidden');
                    }
                }
            }
        }

        function switchSettingsTab(tabName) {
            // Hide all tab panels
            const allTabs = ['general', 'modules', 'data', 'ai', 'security'];
            allTabs.forEach(tab => {
                const panel = document.getElementById(`settings-tab-${tab}`);
                const btn = document.getElementById(`tab-btn-${tab}`);
                if (panel) panel.classList.add('hidden');
                if (btn) {
                    btn.classList.remove('text-dcx-blue', 'border-dcx-blue', 'font-bold');
                    btn.classList.add('text-slate-600');
                }
            });

            // Show selected tab panel
            const selectedPanel = document.getElementById(`settings-tab-${tabName}`);
            const selectedBtn = document.getElementById(`tab-btn-${tabName}`);
            if (selectedPanel) {
                selectedPanel.classList.remove('hidden');
            }
            if (selectedBtn) {
                selectedBtn.classList.remove('text-slate-600');
                selectedBtn.classList.add('text-dcx-blue', 'border-dcx-blue', 'font-bold');
            }
        }

        function showToast(message, type = 'success', durationMs = 4000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type} font-bold`;
            toast.textContent = message;

            // For longer durations, add a custom animation delay
            if (durationMs > 4000) {
                toast.style.animation = `toast-in 0.5s ease-out, toast-out 0.5s ease-in ${durationMs - 500}ms forwards`;
            }

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, durationMs);
        }


        // ==========================================
        // QUICK LINKS LOGIC
        // ==========================================

        let draggedLinkId = null;
        let quickLinksViewMode = 'grid'; // 'grid' or 'group'

        function toggleQuickLinksView(mode) {
            quickLinksViewMode = mode;

            // Update Toggle Buttons
            const btnGrid = document.getElementById('viewToggleGrid');
            const btnGroup = document.getElementById('viewToggleGroup');

            if (mode === 'grid') {
                btnGrid.className = "p-2 rounded-lg text-dcx-blue bg-blue-50 hover:bg-blue-100 transition-colors";
                btnGroup.className = "p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors";
            } else {
                btnGrid.className = "p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors";
                btnGroup.className = "p-2 rounded-lg text-dcx-blue bg-blue-50 hover:bg-blue-100 transition-colors";
            }

            renderQuickLinks();
        }

        function renderQuickLinks() {
            const grid = document.getElementById('quickLinksGrid');
            const emptyState = document.getElementById('quickLinksEmptyState');
            const searchTerm = document.getElementById('quickLinksSearch').value.toLowerCase();
            const sortBy = document.getElementById('quickLinksSortSelect')?.value || 'custom';

            // Ensure appData.quickLinks exists
            if (!appData.quickLinks) appData.quickLinks = [];

            // Ensure all links have sortOrder
            appData.quickLinks.forEach((link, index) => {
                if (link.sortOrder === undefined) link.sortOrder = index;
            });

            // Filter links
            let filteredLinks = appData.quickLinks.filter(link => {
                return (link.title && link.title.toLowerCase().includes(searchTerm)) ||
                    (link.category && link.category.toLowerCase().includes(searchTerm)) ||
                    (link.description && link.description.toLowerCase().includes(searchTerm));
            });

            // Sort links
            if (sortBy === 'custom') {
                filteredLinks.sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0));
            } else if (sortBy === 'name') {
                filteredLinks.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
            } else if (sortBy === 'category') {
                filteredLinks.sort((a, b) => {
                    const catCompare = (a.category || '').localeCompare(b.category || '');
                    return catCompare !== 0 ? catCompare : (a.title || '').localeCompare(b.title || '');
                });
            } else if (sortBy === 'dateAdded') {
                filteredLinks.sort((a, b) => {
                    const aTime = parseInt(a.id.split('_')[1]) || 0;
                    const bTime = parseInt(b.id.split('_')[1]) || 0;
                    return bTime - aTime; // Newest first
                });
            }

            if (filteredLinks.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                grid.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            grid.classList.remove('hidden');

            const isDraggable = sortBy === 'custom' && quickLinksViewMode === 'grid'; // Only drag in Grid Custom mode

            // RENDER LOGIC
            if (quickLinksViewMode === 'group') {
                // GROUPED VIEW
                grid.className = "flex flex-col gap-8"; // Change grid container to flex col for sections

                const categories = ['Tools', 'HR', 'AI', 'Documents', 'Other'];
                const groupedHTML = categories.map(cat => {
                    const linksInCat = filteredLinks.filter(l => l.category === cat);
                    if (linksInCat.length === 0) return '';

                    return `
                    <div class="animate-fade-in-up">
                        <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 border-b border-slate-200 pb-2">${cat}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${linksInCat.map(link => renderQuickLinkCard(link, false)).join('')}
                        </div>
                    </div>
                    `;
                }).join('');

                grid.innerHTML = groupedHTML;

            } else {
                // GRID VIEW (Default)
                grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6";
                grid.innerHTML = filteredLinks.map(link => renderQuickLinkCard(link, isDraggable)).join('');
            }
        }

        function renderQuickLinkCard(link, isDraggable) {
            const safeId = link.id;
            const categoryColors = {
                'Tools': 'bg-blue-500',
                'HR': 'bg-purple-500',
                'AI': 'bg-amber-500',
                'Documents': 'bg-green-500',
                'Other': 'bg-slate-500'
            };
            const badgeClass = categoryColors[link.category] || categoryColors['Other'];

            return `
            <div class="quick-link-card bg-white rounded-xl p-5 border border-slate-200 relative group h-48
                        hover:shadow-xl hover:border-dcx-blue/30 transition-all duration-300 ease-out hover:-translate-y-1
                        ${isDraggable ? 'cursor-move' : ''}" 
                    data-link-id="${safeId}"
                    ${isDraggable ? 'draggable="true"' : ''}
                    ondragstart="handleDragStart(event)"
                    ondragover="handleDragOver(event)"
                    ondrop="handleDrop(event)"
                    ondragend="handleDragEnd(event)">
                
                ${isDraggable ? `
                <div class="absolute top-3 left-3 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                    </svg>
                </div>
                ` : ''}

                <!-- Hover Actions -->
                <div class="absolute top-3 right-3 flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-200 translate-y-2 group-hover:translate-y-0 z-20">
                    <button onclick="copyLinkToClipboard('${link.url}')" class="p-1.5 bg-white text-slate-400 hover:text-dcx-blue rounded-lg shadow-sm border border-slate-100 hover:border-dcx-blue transition-colors" title="Copy URL">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    </button>
                    <button onclick="editQuickLink('${safeId}')" class="p-1.5 bg-white text-slate-400 hover:text-dcx-blue rounded-lg shadow-sm border border-slate-100 hover:border-dcx-blue transition-colors" title="Edit">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
                </div>
                
                <a href="${link.url}" target="_blank" class="block h-full flex flex-col justify-between" onclick="if(event.target.closest('.quick-link-card').draggable && event.buttons === 1) return false;">
                    <div class="flex items-start justify-between mb-2">
                        <div class="p-3 bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm group-hover:scale-110 transition-transform duration-300">
                            ${getIconHTML(link)}
                        </div>
                    </div>
                    
                    <div class="flex-grow">
                        <div class="flex items-center justify-between mb-1">
                            <h4 class="font-bold text-slate-800 text-lg tracking-tight group-hover:text-dcx-blue transition-colors truncate pr-2">${link.title}</h4>
                            <div class="w-2.5 h-2.5 rounded-full ${badgeClass} opacity-70 flex-shrink-0" title="${link.category}"></div>
                        </div>
                        <p class="text-xs text-slate-400 font-medium truncate mb-2">${getHostname(link.url)}</p>
                        ${link.description ? `<p class="text-sm text-slate-500 line-clamp-2 leading-relaxed h-10 overflow-hidden">${link.description}</p>` : '<div class="h-10"></div>'}
                    </div>
                </a>
            </div>
            `;
        }

        function getHostname(url) {
            try {
                if (!url.startsWith('http')) return 'Local / App';
                return new URL(url).hostname;
            } catch (e) {
                return 'Link';
            }
        }

        function getIconHTML(link) {
            // 1. If Custom Icon (Emoji or URL) is set
            if (link.icon) {
                // If it looks like a URL (http/s), render as image
                if (link.icon.startsWith('http')) {
                    return `<img src="${link.icon}" class="w-8 h-8 object-contain" onerror="this.src='https://icons.duckduckgo.com/ip3/${getHostname(link.url)}.ico'">`;
                }
                // Otherwise assume it's an Emoji
                return `<div class="w-8 h-8 flex items-center justify-center text-2xl leading-none">${link.icon}</div>`;
            }

            // 2. Fallback to Auto-Fetch
            // Try high-quality DuckDuckGo service first, fallback to Google
            const domain = getHostname(link.url);
            if (domain === 'Local / App') return `<div class="w-8 h-8 flex items-center justify-center text-2xl leading-none"></div>`;

            return `<img src="https://icons.duckduckgo.com/ip3/${domain}.ico" 
                    class="w-8 h-8 object-contain mix-blend-multiply dark:mix-blend-normal"
                    onerror="this.onerror=null;this.src='https://www.google.com/s2/favicons?domain=${domain}&sz=64'">`;
        }

        function openQuickLinkModal() {
            document.getElementById('quickLinkId').value = '';
            document.getElementById('quickLinkTitle').value = '';
            document.getElementById('quickLinkUrl').value = '';
            document.getElementById('quickLinkIcon').value = '';
            document.getElementById('quickLinkCategory').value = 'Tools';
            document.getElementById('quickLinkDesc').value = '';
            document.getElementById('quickLinkModalTitle').innerText = 'Add Quick Link';
            document.getElementById('btnDeleteQuickLink').classList.add('hidden');
            toggleModal('quickLinkModal');
        }

        function editQuickLink(id) {
            const link = appData.quickLinks.find(l => l.id === id);
            if (!link) return;

            document.getElementById('quickLinkId').value = link.id;
            document.getElementById('quickLinkTitle').value = link.title;
            document.getElementById('quickLinkUrl').value = link.url;
            document.getElementById('quickLinkIcon').value = link.icon || '';
            document.getElementById('quickLinkCategory').value = link.category;
            document.getElementById('quickLinkDesc').value = link.description || '';

            document.getElementById('quickLinkModalTitle').innerText = 'Edit Quick Link';
            document.getElementById('btnDeleteQuickLink').classList.remove('hidden');

            toggleModal('quickLinkModal');
        }

        function saveQuickLink() {
            const id = document.getElementById('quickLinkId').value;
            const title = document.getElementById('quickLinkTitle').value;
            let url = document.getElementById('quickLinkUrl').value;
            const icon = document.getElementById('quickLinkIcon').value;
            const category = document.getElementById('quickLinkCategory').value;
            const description = document.getElementById('quickLinkDesc').value;

            if (!title || !url) {
                showToast('Please fill in Title and URL', 'error');
                return;
            }

            // Smarter URL validation/correction
            // If it starts with common protocols or drive letters, keep it as is.
            const isLocalOrCustom =
                url.startsWith('file:') ||
                url.startsWith('onenote:') ||
                url.startsWith('slack:') ||
                url.startsWith('teams:') ||
                /^[a-zA-Z]:\\/.test(url) || // Windows Path C:\...
                url.startsWith('\\\\');     // Network Share \\server\...

            if (!isLocalOrCustom && !url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }

            if (!appData.quickLinks) appData.quickLinks = [];

            if (id) {
                // Edit existing
                const index = appData.quickLinks.findIndex(l => l.id === id);
                if (index > -1) {
                    appData.quickLinks[index] = { ...appData.quickLinks[index], title, url, icon, category, description };
                    showToast('Link updated successfully', 'success');
                }
            } else {
                // Create new
                const newLink = {
                    id: 'link_' + Date.now(),
                    title,
                    url,
                    icon,
                    category,
                    description,
                    sortOrder: appData.quickLinks.length
                };
                appData.quickLinks.push(newLink);
                showToast('Link added successfully', 'success');
            }

            saveData();
            toggleModal('quickLinkModal');
            renderQuickLinks();
        }

        function deleteQuickLink() {
            const id = document.getElementById('quickLinkId').value;
            if (!id) return;

            if (confirm('Are you sure you want to delete this link?')) {
                appData.quickLinks = appData.quickLinks.filter(l => l.id !== id);
                saveData();
                toggleModal('quickLinkModal');
                renderQuickLinks();
                showToast('Link deleted', 'success');
            }
        }

        function copyLinkToClipboard(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy link', 'error');
            });
        }

        // Drag and Drop Handlers
        function handleDragStart(e) {
            const card = e.target.closest('.quick-link-card');
            if (!card) return;

            draggedLinkId = card.getAttribute('data-link-id');
            card.classList.add('opacity-50');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', card.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const card = e.target.closest('.quick-link-card');
            if (card && draggedLinkId) {
                const targetId = card.getAttribute('data-link-id');
                if (targetId !== draggedLinkId) {
                    card.classList.add('border-dcx-blue', 'border-2');
                }
            }
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetCard = e.target.closest('.quick-link-card');
            if (!targetCard || !draggedLinkId) return false;

            const targetId = targetCard.getAttribute('data-link-id');

            if (draggedLinkId !== targetId) {
                // Find indices
                const draggedIndex = appData.quickLinks.findIndex(l => l.id === draggedLinkId);
                const targetIndex = appData.quickLinks.findIndex(l => l.id === targetId);

                if (draggedIndex > -1 && targetIndex > -1) {
                    // Reorder array
                    const [draggedItem] = appData.quickLinks.splice(draggedIndex, 1);
                    appData.quickLinks.splice(targetIndex, 0, draggedItem);

                    // Update sortOrder for all items
                    appData.quickLinks.forEach((link, index) => {
                        link.sortOrder = index;
                    });

                    saveData();
                    renderQuickLinks();
                    showToast('Link order updated', 'success');
                }
            }

            return false;
        }

        function handleDragEnd(e) {
            const card = e.target.closest('.quick-link-card');
            if (card) {
                card.classList.remove('opacity-50');
            }

            // Remove all drag-over highlights
            document.querySelectorAll('.quick-link-card').forEach(c => {
                c.classList.remove('border-dcx-blue', 'border-2');
            });

            draggedLinkId = null;
        }

        // ==========================================
        // TOOL SWITCHING LOGIC
        // ==========================================
        function switchTool(toolName) {
            activeTool = toolName;

            const container1 = document.getElementById('app-container-1'); // ActionHub
            const container2 = document.getElementById('app-container-2'); // PulseCheck

            const btnHub = document.getElementById('toggle-hub');
            const btnPulse = document.getElementById('toggle-pulse');
            const banner = document.getElementById('sub-header-banner');
            const bannerText = document.getElementById('sub-header-text');

            if (toolName === 'ActionHub') {
                // Show Container 1
                if (container1) container1.style.display = 'block';
                if (container2) container2.style.display = 'none';

                // Header Styling (Purple)
                if (btnHub) btnHub.className = "header-toggle-btn px-5 py-1.5 rounded-full text-sm font-semibold bg-hub-600 text-white shadow";
                if (btnPulse) btnPulse.className = "header-toggle-btn px-5 py-1.5 rounded-full text-sm font-semibold text-slate-400 hover:text-white";

                if (banner) banner.className = "bg-hub-800 shadow-md transition-colors duration-300";
                if (bannerText) bannerText.textContent = "Operational Command Center";

                renderHubView();
            } else {
                // Show Container 2
                if (container1) container1.style.display = 'none';
                if (container2) container2.style.display = 'block';

                // Header Styling (Blue)
                if (btnPulse) btnPulse.className = "header-toggle-btn px-5 py-1.5 rounded-full text-sm font-semibold bg-dcx-blue text-white shadow";
                if (btnHub) btnHub.className = "header-toggle-btn px-5 py-1.5 rounded-full text-sm font-semibold text-slate-400 hover:text-white";

                if (banner) banner.className = "bg-dcx-blue shadow-md transition-colors duration-300";
                if (bannerText) bannerText.textContent = "Team Insights & Performance";

                renderPulseView();
            }
        }

        function switchTab(tabName) {
            SoundEngine.click();

            const commonBtnClasses = "px-4 py-2 text-sm transition-all whitespace-nowrap flex items-center gap-2";
            const activeClass = "tab-pill-active " + commonBtnClasses;
            const inactiveClass = "tab-pill-inactive " + commonBtnClasses;

            // Hub Tabs (Order matches visual UI: Mailbox, My Desk, Projects, Pipeline, Logbook, Broadcast, Performance)
            if (['mailbox', 'myDesk', 'projects', 'pipeline', 'logbook', 'broadcast', 'performance'].includes(tabName)) {
                currentHubTab = tabName;
                ['mailbox', 'myDesk', 'projects', 'pipeline', 'logbook', 'broadcast', 'performance'].forEach(t => {
                    const view = document.getElementById(t + 'View');
                    const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                    if (view) view.classList.toggle('hidden', t !== tabName);
                    if (btn) {
                        // Preserve hidden class if tab is disabled by settings
                        const isHidden = btn.classList.contains('hidden');
                        btn.className = t === tabName ? activeClass : inactiveClass;
                        if (isHidden) btn.classList.add('hidden');
                    }
                });
                renderHubView(true); // Animate on tab switch
            }
            // Pulse Tabs
            else {
                currentPulseTab = tabName;
                ['teamInfo', 'pulse', 'timesheets', 'rollCall', 'reliability', 'capacity', 'quickLinks'].forEach(t => {
                    const view = document.getElementById(t + 'View');
                    const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                    if (view) view.classList.toggle('hidden', t !== tabName);
                    if (btn) {
                        // Preserve hidden class if tab is disabled by settings
                        const isHidden = btn.classList.contains('hidden');
                        btn.className = t === tabName ? activeClass : inactiveClass;
                        if (isHidden) btn.classList.add('hidden');
                    }
                });
                renderPulseView(true); // Animate on tab switch
            }
        }


        function renderHubView(animate = false) {
            // Check for returned snoozed tasks before rendering My Desk
            if (currentHubTab === 'myDesk') {
                checkSnoozedTasks();
            }
            if (currentHubTab === 'mailbox') renderMailbox(animate);
            if (currentHubTab === 'myDesk') renderMyDesk(animate);
            if (currentHubTab === 'pipeline') renderPipeline();
            if (currentHubTab === 'logbook') renderLogbook();
            if (currentHubTab === 'broadcast') renderBroadcast();
            if (currentHubTab === 'projects') renderProjectsView();
            if (currentHubTab === 'performance') {
                // Check if performance functions are loaded
                if (typeof initializePerformanceDashboard === 'function' && typeof renderPerformanceDashboard === 'function') {
                    if (!performanceInitialized) {
                        initializePerformanceDashboard();
                        performanceInitialized = true;
                    } else {
                        renderPerformanceDashboard();
                    }
                } else {
                    console.log('Performance functions not yet loaded, skipping initialization');
                }
            }
        }

        function renderPulseView(animate = false) {
            if (currentPulseTab === 'teamInfo') renderTeamInfo(animate);
            if (currentPulseTab === 'pulse') {
                togglePulseMode('dashboard');
                renderDashboard(animate);
                renderTrendsView();
            }
            if (currentPulseTab === 'timesheets') renderTimesheetView();
            if (currentPulseTab === 'rollCall') renderRollCallView();
            if (currentPulseTab === 'reliability') {
                populateReliabilityAccountFilter();
                renderReliabilityMatrix();
            }

            // --- THIS WAS MISSING ---
            if (currentPulseTab === 'capacity') renderCapacityView();
            if (currentPulseTab === 'quickLinks') renderQuickLinks();
        }

        function togglePulseMode(mode) {
            const topControls = document.getElementById('pulseTopControls');
            const dashboardContent = document.getElementById('pulseDashboardContent');
            const trendsContent = document.getElementById('pulseTrendsContent');

            if (mode === 'dashboard') {
                if (topControls) topControls.classList.remove('hidden');
                if (dashboardContent) dashboardContent.classList.remove('hidden');
                if (trendsContent) trendsContent.classList.add('hidden');
            } else if (mode === 'trends') {
                if (topControls) topControls.classList.add('hidden');
                if (dashboardContent) dashboardContent.classList.add('hidden');
                if (trendsContent) trendsContent.classList.remove('hidden');
                // Ensure charts resize correctly
                if (window.teamTrendChartInstance) window.teamTrendChartInstance.resize();
            }
        }

        // ==========================================
        // UPDATED: CONTEXT MODAL (Polished UI)
        // ==========================================
        let ctxChartInstance = null;

        function openContextModal(tmId) {
            const tm = appData.team.find(t => t.id === tmId);
            if (!tm) return;

            // 1. Populate Header / Profile
            document.getElementById('ctxTmId').value = tmId;
            document.getElementById('ctxName').textContent = tm.name;
            document.getElementById('ctxRole').textContent = `${tm.role}  ${tm.account}`;
            document.getElementById('ctxPocBadge').textContent = `POC: ${tm.poc || 'N/A'}`;

            // 2. EWS Badge Logic (Colors)
            const ews = tm.ews || 'green';
            const ewsColors = {
                green: 'bg-green-100 text-green-700 border-green-200',
                amber: 'bg-amber-100 text-amber-700 border-amber-200',
                red: 'bg-red-100 text-red-700 border-red-200'
            };
            const ewsLabel = { green: 'Low Risk', amber: 'Medium Risk', red: 'High Risk' };

            const ewsBadge = document.getElementById('ctxEwsBadge');
            ewsBadge.className = `px-2 py-0.5 rounded text-xs font-bold border uppercase tracking-wider ${ewsColors[ews] || 'bg-slate-100'}`;
            ewsBadge.textContent = `EWS: ${ewsLabel[ews] || 'Unknown'}`;

            // 3. Populate Recent Logs (Last 6 Only) - IMPROVED UI
            const logs = appData.logbook.filter(l => l.tmId === tmId).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 6);
            const logList = document.getElementById('ctxLogList');
            logList.innerHTML = '';

            if (logs.length === 0) {
                logList.innerHTML = `<div class="text-center py-8 text-slate-400 text-xs italic">No logbook entries found.</div>`;
            } else {
                logs.forEach(l => {
                    const colors = { issue: 'text-red-600', request: 'text-blue-600', kudos: 'text-green-600' };
                    const icon = { issue: '', request: '', kudos: '' };

                    // Added bg-slate-50 and hover effect for better contrast
                    logList.innerHTML += `
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 shadow-sm hover:border-dcx-blue transition-colors cursor-default">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-[10px] font-bold uppercase ${colors[l.type] || 'text-slate-500'} flex items-center">
                                <span class="mr-1">${icon[l.type]}</span> ${l.type}
                            </span>
                            <span class="text-[10px] text-slate-400">${formatDate(l.date)}</span>
                        </div>
                        <p class="text-sm font-bold text-slate-700 leading-tight line-clamp-1">${l.title}</p>
                        <p class="text-xs text-slate-500 mt-1 line-clamp-2">${l.notes}</p>
                    </div>`;
                });
            }

            // 4. Vibe & Chart Logic - IMPROVED DATES
            const checkinList = document.getElementById('ctxCheckinList');
            checkinList.innerHTML = '';

            let labels = [], dataPoints = [];
            let d = new Date(); d.setDate(1);
            let currentVibe = '';

            for (let i = 5; i >= 0; i--) {
                let p = new Date(d); p.setMonth(p.getMonth() - i);
                let k = getMonthKey(p);

                // Human Readable Date (e.g., "Nov 2025")
                let niceDate = p.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

                labels.push(p.toLocaleDateString('en-US', { month: 'short' }));

                let val = null;
                if (appData.checkins[k] && appData.checkins[k][tmId]) {
                    const s = appData.checkins[k][tmId].sentiment;
                    val = s === 'good' ? 3 : (s === 'mid' ? 2 : 1);
                    const emoji = s === 'good' ? '' : (s === 'mid' ? '' : '');
                    const sentimentLabel = s === 'good' ? 'Positive' : (s === 'mid' ? 'Neutral' : 'Concerning');

                    if (i === 0) currentVibe = emoji;

                    // Cleaned up the list item layout
                    checkinList.innerHTML = `
                    <div class="flex items-center justify-between text-xs py-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 px-2 rounded transition-colors">
                        <div class="flex items-center">
                            <span class="text-lg mr-3">${emoji}</span>
                            <span class="font-bold text-slate-700 capitalize">${sentimentLabel}</span>
                        </div>
                        <span class="text-slate-400 font-mono text-[10px]">${niceDate}</span>
                    </div>` + checkinList.innerHTML;
                }
                dataPoints.push(val);
            }

            if (!checkinList.innerHTML) checkinList.innerHTML = `<div class="text-center py-4 text-slate-400 text-xs italic">No recent check-ins.</div>`;

            document.getElementById('ctxVibeIcon').textContent = currentVibe;

            // Render Chart (Hidden Grid Lines for cleaner look)
            if (ctxChartInstance) ctxChartInstance.destroy();
            const ctx = document.getElementById('ctxTrendChart').getContext('2d');

            ctxChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Vibe',
                        data: dataPoints,
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        tension: 0.3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#6366f1',
                        pointRadius: 4,
                        fill: true,
                        backgroundColor: 'rgba(99, 102, 241, 0.05)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false, min: 0.5, max: 3.5 },
                        x: {
                            grid: { display: false }, // Hides vertical grid lines
                            ticks: { font: { size: 10 }, color: '#94a3b8' }
                        }
                    }
                }
            });

            toggleModal('tmContextModal');
        }
        function goToLogbookContext() {
            const tmId = document.getElementById('ctxTmId').value;

            // 1. Close the modal
            toggleModal('tmContextModal');

            // 2. Navigate to the Logbook view
            switchTool('ActionHub');
            switchTab('logbook');

            // 3. Apply "View All" Filters
            // We use a small timeout to ensure the view renders before we manipulate the DOM
            setTimeout(() => {
                const tmSelect = document.getElementById('lbFilterTm');
                const typeSelect = document.getElementById('lbFilterType');
                const statusSelect = document.getElementById('lbFilterStatus');
                const searchInput = document.getElementById('lbSearch');

                // Populate dropdown if it's empty (Edge case handling)
                if (tmSelect && tmSelect.options.length <= 1) {
                    appData.team.filter(t => t.active).sort((a, b) => a.name.localeCompare(b.name)).forEach(tm => {
                        const opt = document.createElement('option');
                        opt.value = tm.id;
                        opt.textContent = tm.name;
                        tmSelect.appendChild(opt);
                    });
                }

                // --- THE UX FIX ---
                if (tmSelect) tmSelect.value = tmId; // Select the Team Member
                if (searchInput) searchInput.value = ''; // Clear Search

                // Force these to 'all' so the manager sees everything (Notes, Kudos, Closed items)
                if (typeSelect) typeSelect.value = 'all';
                if (statusSelect) statusSelect.value = 'all';

                // Apply the changes
                renderLogbook();

                // Optional: Scroll to top of view
                const view = document.getElementById('logbookView');
                if (view) view.scrollIntoView({ behavior: 'smooth' });

                // Optional: User Feedback
                showToast("Filtering history for " + tmSelect.options[tmSelect.selectedIndex].text, "info");

            }, 200);
        }

        function jumpToMemberLogs(tmId) {
            console.log('jumpToMemberLogs called for TM:', tmId);

            switchTool('ActionHub');
            switchTab('logbook');

            setTimeout(() => {
                const tmSelect = document.getElementById('lbFilterTm');
                const typeSelect = document.getElementById('lbFilterType');
                const statusSelect = document.getElementById('lbFilterStatus');
                const searchInput = document.getElementById('lbSearch');

                if (tmSelect && tmSelect.options.length <= 1) {
                    appData.team.filter(t => t.active).sort((a, b) => a.name.localeCompare(b.name)).forEach(tm => {
                        const opt = document.createElement('option');
                        opt.value = tm.id;
                        opt.textContent = tm.name;
                        tmSelect.appendChild(opt);
                    });
                }

                // Apply Filters: Issues & Requests, Open/Pending
                if (tmSelect) tmSelect.value = tmId;
                if (searchInput) searchInput.value = '';
                if (typeSelect) typeSelect.value = 'actionable';
                if (statusSelect) statusSelect.value = 'Open';

                console.log('Red Badge Filters Applied:', {
                    tm: tmSelect ? tmSelect.value : 'N/A',
                    type: typeSelect ? typeSelect.value : 'N/A',
                    status: statusSelect ? statusSelect.value : 'N/A'
                });

                renderLogbook();

                const view = document.getElementById('logbookView');
                if (view) view.scrollIntoView({ behavior: 'smooth' });
            }, 200);
        }

        // ==========================================
        // SHARED ROSTER MANAGEMENT
        // ==========================================
        function openRosterModal(tmId = null, startTab = 'profile') {
            const modalTitle = document.getElementById('rosterModalTitle');
            const btnDelete = document.getElementById('btnDeleteMember');
            const form = document.getElementById('rosterForm');
            if (!form) return;

            form.reset();

            if (tmId) {
                const tm = appData.team.find(t => t.id === tmId);
                if (!tm) return;

                // Standard Profile
                document.getElementById('editTmId').value = tm.id;
                document.getElementById('editTmName').value = tm.name;
                document.getElementById('editTmNickname').value = tm.nickname || '';
                document.getElementById('editTmAccount').value = tm.account;
                document.getElementById('editTmRole').value = tm.role;
                document.getElementById('editTmHireDate').value = tm.hireDate || '';
                updateDateInput(document.getElementById('editTmHireDate'));
                document.getElementById('editTmBirthday').value = tm.birthday || '';
                updateDateInput(document.getElementById('editTmBirthday'));
                document.getElementById('editTmEmpId').value = tm.empId || '';
                document.getElementById('editTmPoc').value = tm.poc || '';
                document.getElementById('editTmPocEmail').value = tm.pocEmail || '';

                // PSI Fields
                document.getElementById('editTmPhone').value = tm.phone || '';
                document.getElementById('editTmAddress').value = tm.address || '';
                document.getElementById('editTmIceName').value = tm.iceName || '';
                document.getElementById('editTmIcePhone').value = tm.icePhone || '';

                modalTitle.textContent = tm.name;
                btnDelete.classList.remove('hidden');

                switchRosterTab(startTab);
            } else {
                document.getElementById('rosterForm').reset();
                document.getElementById('editTmId').value = '';
                modalTitle.textContent = "Add New Member";
                btnDelete.classList.add('hidden');
                switchRosterTab('profile');
            }
            toggleModal('rosterModal');
        }

        function toggleRosterModal() { toggleModal('rosterModal'); }

        function saveRosterMember(event) {
            event.preventDefault();
            const id = document.getElementById('editTmId').value;
            const name = document.getElementById('editTmName').value.trim();
            if (!name) return;

            const memberData = {
                name: name,
                nickname: document.getElementById('editTmNickname').value.trim(),
                account: document.getElementById('editTmAccount').value.trim(),
                role: document.getElementById('editTmRole').value.trim(),
                hireDate: document.getElementById('editTmHireDate').value,
                birthday: document.getElementById('editTmBirthday').value,
                empId: document.getElementById('editTmEmpId').value.trim(),
                poc: document.getElementById('editTmPoc').value.trim(),
                pocEmail: document.getElementById('editTmPocEmail').value.trim(),

                // NEW PSI DATA
                phone: document.getElementById('editTmPhone').value.trim(),
                address: document.getElementById('editTmAddress').value.trim(),
                iceName: document.getElementById('editTmIceName').value.trim(),
                icePhone: document.getElementById('editTmIcePhone').value.trim()
            };

            if (id) {
                const tm = appData.team.find(t => t.id == id);
                if (tm) Object.assign(tm, memberData);
            } else {
                appData.team.push({
                    id: Date.now(),
                    ...memberData,
                    active: true,
                    ews: 'green'
                });
            }

            saveData();
            toggleRosterModal();

            // AUTO-SWITCH to Team Info
            switchTool('PulseCheck');
            switchTab('teamInfo');
            renderTeamInfo();
            showToast("Roster updated successfully!", "success");
        }

        function deleteTeamMember() {
            const id = document.getElementById('editTmId').value;
            if (confirm("Are you sure you want to remove this member from the active roster?")) {
                const tm = appData.team.find(t => t.id == id);
                if (tm) tm.active = false; // This is a soft delete
                saveData();
                toggleRosterModal();
                showToast("Member removed from roster", "success");
            }
        }

        // ==========================================
        // TOOL 1: ACTIONHUB LOGIC
        // ==========================================

        // --- Navigation Helpers ---
        function goToLogbook(tmId) {
            // Switch to Logbook tab
            switchTab('logbook');
            // Set the filter to that specific TM
            setLogbookFilter('tm_' + tmId);
        }

        function goToPipeline() {
            switchTab('pipeline');
        }

        // --- Mailbox Drag & Drop ---
        let draggedMailboxId = null;

        function handleMailboxDragStart(e, id) {
            draggedMailboxId = id;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', id);
            e.target.classList.add('opacity-50');
        }

        function handleMailboxDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleMailboxDrop(e, targetId) {
            e.stopPropagation();
            e.preventDefault();

            const cards = document.querySelectorAll('#mailboxGrid > div');
            cards.forEach(c => c.classList.remove('opacity-50'));

            if (draggedMailboxId === targetId) return;

            // Switch to 'custom' sort if not already
            const sortSelect = document.getElementById('mailboxSort');
            if (sortSelect.value !== 'custom') {
                sortSelect.value = 'custom';
            }

            // Initialize/Update Order
            if (!appData.mailboxOrder) appData.mailboxOrder = [];

            // Ensure all current IDs are in mailboxOrder
            const currentIds = appData.team.filter(t => t.active).map(t => t.id);

            // 1. Filter out obsolete IDs from order
            appData.mailboxOrder = appData.mailboxOrder.filter(id => currentIds.includes(id));

            // 2. Add any missing IDs to the end
            currentIds.forEach(id => {
                if (!appData.mailboxOrder.includes(id)) appData.mailboxOrder.push(id);
            });

            const fromIndex = appData.mailboxOrder.indexOf(draggedMailboxId);
            const toIndex = appData.mailboxOrder.indexOf(targetId);

            if (fromIndex > -1 && toIndex > -1) {
                appData.mailboxOrder.splice(fromIndex, 1);
                appData.mailboxOrder.splice(toIndex, 0, draggedMailboxId);
                saveData();
                renderMailbox(false); // No animation on drag
            }
        }

        // --- Mailbox ---
        function renderMailbox(animate = false) {
            const grid = document.getElementById('mailboxGrid');
            if (!grid) return;

            const sortValue = document.getElementById('mailboxSort').value;
            grid.innerHTML = '';

            let activeTeam = appData.team.filter(tm => tm.active);

            if (sortValue === 'name') activeTeam.sort((a, b) => a.name.localeCompare(b.name));
            else if (sortValue === 'role') activeTeam.sort((a, b) => (a.role || '').localeCompare(b.role || ''));
            else if (sortValue === 'custom') {
                if (appData.mailboxOrder && appData.mailboxOrder.length > 0) {
                    activeTeam.sort((a, b) => {
                        const idxA = appData.mailboxOrder.indexOf(a.id);
                        const idxB = appData.mailboxOrder.indexOf(b.id);
                        // If not in order list, put at end
                        return (idxA === -1 ? 9999 : idxA) - (idxB === -1 ? 9999 : idxB);
                    });
                }
            }
            else activeTeam.sort((a, b) => (a.account || '').localeCompare(b.account || ''));

            if (activeTeam.length === 0) {
                grid.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-24 px-4 text-center">
                    <div class="bg-indigo-50 p-6 rounded-full mb-6 shadow-sm ring-4 ring-indigo-50/50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-dcx-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>

                    <h2 class="text-3xl font-bold text-slate-800 mb-3">Welcome to Leadership OS</h2>
                    <p class="text-slate-500 max-w-md mx-auto mb-8 text-lg">
                        This is your command center. To get started, you need to add your team. You can add them one by one or import your roster directly from Workday.
                    </p>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                        <button onclick="openRosterModal()" class="flex items-center gap-2 bg-white border border-slate-300 text-slate-700 hover:text-dcx-blue hover:border-dcx-blue px-6 py-3 rounded-xl font-bold transition-all shadow-sm hover:shadow-md">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                            Add Manually
                        </button>

                        <button onclick="openRosterModal(); setTimeout(() => document.getElementById('rosterUpload').click(), 300);" class="flex items-center gap-2 bg-dcx-blue hover:bg-dcx-light text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg hover:shadow-xl hover:-translate-y-1">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                            Import from Workday
                        </button>
                    </div>
                </div>`;
                return;
            }

            const allEvals = calculateAllEvaluations();

            activeTeam.forEach((tm, index) => {
                const pendingLog = appData.logbook.filter(e => e.tmId === tm.id && (e.type === 'issue' || e.type === 'request') && e.status === 'Open').length;
                const hasEval = allEvals.some(ev => ev.tm.id === tm.id && ev.status === 'InProgress');
                const isBday = isBirthdayApproaching(tm.birthday);
                const isAnniv = isAnniversaryApproaching(tm.hireDate); // NEW: Check Anniversary


                let notifs = '';
                // 1. Birthday (Highest Priority - Bouncing Animation)
                if (isBday) {
                    notifs += `<div class="bg-pink-100 text-pink-600 text-xs font-bold rounded-full w-7 h-7 flex items-center justify-center shadow-sm mr-1 animate-bounce" title="Birthday coming up!"></div>`;
                }
                // 2. Anniversary (Cyan Rocket - NEW ADDITION)
                if (isAnniv) {
                    notifs += `<div class="bg-cyan-100 text-cyan-600 text-xs font-bold rounded-full w-7 h-7 flex items-center justify-center shadow-sm mr-1 animate-bounce" title="Work Anniversary coming up!"></div>`;
                }
                // 3. Pending Logs (Red Badge)
                if (pendingLog > 0) notifs += `<button onclick="event.stopPropagation(); jumpToMemberLogs(${tm.id})" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center shadow-sm mr-1 transition-transform hover:scale-110" title="Manage Pending Logs">${pendingLog}</button>`;
                // 4. Evaluation (Purple Icon)
                if (hasEval) notifs += `<button onclick="event.stopPropagation(); goToPipeline()" class="bg-hub-600 hover:bg-hub-700 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-sm transition-transform hover:scale-110" title="View Evaluation"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></button>`;

                // CLICK CARD -> Open Profile
                grid.innerHTML += `
                <div class="${animate ? 'stagger-item' : ''} bg-white rounded-xl shadow-sm border border-slate-200 p-4 relative h-36 flex flex-col justify-between transition hover:shadow-md cursor-pointer hover:border-dcx-blue group"
                     style="animation-delay: ${index * 30}ms"
                     onclick="openContextModal(${tm.id})"
                     draggable="true"
                     ondragstart="handleMailboxDragStart(event, ${tm.id})"
                     ondragover="handleMailboxDragOver(event)"
                     ondrop="handleMailboxDrop(event, ${tm.id})">
                    <div class="absolute top-2 right-2 flex items-center z-10">${notifs}</div>
                    <div>
                        <h3 class="font-bold text-slate-800 leading-tight truncate pr-6 group-hover:text-dcx-blue transition-colors">${tm.name}</h3>
                        <p class="text-sm text-slate-500 truncate">${tm.role}</p>
                    </div>
                    <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${getAccountColor(tm.account)} self-start">${tm.account}</span>
                </div>`;
            });
            setTimeout(initSpotlight, 100);
        }

        // --- My Desk ---
        function renderMyDesk(animate = false) {
            updateSnoozeButton();
            const atHand = document.getElementById('colAtHand');
            const onTable = document.getElementById('colOnTheTable');
            const inDrawer = document.getElementById('colInDrawer');
            const completedCol = document.getElementById('colCompletedTasks');
            if (!atHand || !onTable || !inDrawer || !completedCol) return;

            atHand.innerHTML = ''; onTable.innerHTML = ''; inDrawer.innerHTML = ''; completedCol.innerHTML = '';

            const tasks = appData.myDesk.sort((a, b) => {
                // Primary sort: Due date
                // Use start date for range dates, or single date (dueDateStart/dueDateEnd)
                const date1 = a.dueDateStart || a.dueDate;
                const date2 = b.dueDateStart || b.dueDate;
                const d1 = date1 ? new Date(date1 + 'T00:00:00') : new Date(8640000000000000);
                const d2 = date2 ? new Date(date2 + 'T00:00:00') : new Date(8640000000000000);

                // If dates are different, sort by date
                if (d1.getTime() !== d2.getTime()) {
                    return d1 - d2;
                }

                // If dates are the same, sort by sortOrder (or default to 0)
                const order1 = a.sortOrder || 0;
                const order2 = b.sortOrder || 0;
                return order1 - order2;
            });

            // Filter and sort completed tasks
            const completedTasks = (appData.completedMyDesk || []).filter(task => {
                const completedDate = new Date(task.completedDate + 'T12:00:00');
                const today = new Date();
                const filter = document.getElementById('completedTaskFilter').value;

                if (filter === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    return completedDate >= weekAgo;
                } else if (filter === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    return completedDate >= monthAgo;
                }
                return true; // 'all' filter
            }).sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate));

            const completedPill = document.getElementById('completedCountPill');
            if (completedPill) {
                completedPill.textContent = completedTasks.length === 0
                    ? 'Up to date'
                    : `${completedTasks.length} done`;
            }

            tasks.forEach((t, index) => {
                const today = getToday();

                // Determine due date for display and urgency (use start date for ranges)
                let dueDateStr = null;
                let isRange = false;

                if (t.dueDateStart && t.dueDateEnd) {
                    // Range date: use start date for urgency calculation
                    dueDateStr = t.dueDateStart;
                    isRange = (t.dueDateStart !== t.dueDateEnd);
                } else if (t.dueDate) {
                    // Legacy single date
                    dueDateStr = t.dueDate;
                }

                let due = null;
                if (dueDateStr) {
                    due = new Date(dueDateStr + 'T12:00:00');
                }

                let dueText = 'No Date';
                if (isRange) {
                    // Display range using formatDateRange
                    dueText = formatDateRange(t.dueDateStart, t.dueDateEnd);
                } else if (due) {
                    dueText = getRelativeDateDisplay(due);
                }

                let dueClass = 'text-slate-500';
                let dueIcon = '';

                // Append scheduled time if present
                if (t.scheduledTime && due) {
                    const [h, m] = t.scheduledTime.split(':');
                    const timeDate = new Date();
                    timeDate.setHours(parseInt(h), parseInt(m));
                    const timeStr = timeDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                    dueText += ` @ ${timeStr}`;
                }

                // Use start date for urgency color coding
                if (due) {
                    const daysDiff = getDaysDiff(today, due);
                    if (daysDiff < 0) {
                        dueClass = 'text-red-600 font-bold';
                        dueIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    } else if (daysDiff <= 3) {
                        dueClass = 'text-orange-600 font-bold';
                        dueIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    } else {
                        dueIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`;
                    }
                }

                // STRICT FILTERING: Determine Target Column by Status Only
                let targetCol = null;
                if (t.status === 'AtHand') {
                    targetCol = atHand;
                } else if (t.status === 'InDrawer') {
                    targetCol = inDrawer;
                } else if (t.status === 'OnTheTable') {
                    targetCol = onTable;
                } else {
                    // Fallback for backwards compatibility
                    targetCol = onTable;
                }

                // Button Logic - Always Visible Pill Design
                const pillBtnClass = "flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium bg-slate-100 hover:bg-slate-200 text-slate-600 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-300 transition-colors";

                let moveButtons = '';
                if (t.status === 'AtHand') {
                    moveButtons = `
                        <button onclick="moveDeskTask('${t.id}', 'OnTheTable')" class="${pillBtnClass}" title="Move to Table">
                            <span>Move to Table</span>
                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/></svg>
                        </button>
                    `;
                } else if (t.status === 'OnTheTable') {
                    moveButtons = `
                        <div class="flex gap-2">
                            <button onclick="moveDeskTask('${t.id}', 'AtHand')" class="${pillBtnClass}" title="Move to Hand">
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                                <span>To Hand</span>
                            </button>
                            <button onclick="moveDeskTask('${t.id}', 'InDrawer')" class="${pillBtnClass}" title="Move to Drawer">
                                <span>To Drawer</span>
                                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                            </button>
                        </div>
                    `;
                } else if (t.status === 'InDrawer') {
                    moveButtons = `
                        <button onclick="moveDeskTask('${t.id}', 'OnTheTable')" class="${pillBtnClass}" title="Move back to Table">
                            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                            <span>Move to Table</span>
                        </button>
                    `;
                }

                const isFocused = appData.focusTaskId === t.id;
                const focusBtn = t.status === 'AtHand'
                    ? `<button onclick="${isFocused ? 'stopFocus()' : `startFocus('${t.id}')`}" class="${isFocused ? 'bg-green-600 text-white' : 'bg-slate-100 text-slate-700 hover:bg-hub-600 hover:text-white'} text-xs font-bold px-3 py-1 rounded-lg shadow-sm transition-colors">${isFocused ? 'Focused' : 'Focus'}</button>`
                    : '';

                const noteIcon = t.notes ?
                    `<button onclick="toggleTaskNote('${t.id}')" class="text-slate-400 hover:text-hub-600" title="View Notes"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></button>` : '';

                const noteDiv = t.notes ?
                    `<div id="note-${t.id}" class="note-content bg-slate-50 rounded-lg text-xs text-slate-600 p-3 border border-slate-200">${t.notes}</div>` : '';

                const estimateLabel = t.estimatedMinutes ? `<span class="text-xs text-slate-500 font-semibold flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>${formatEstimate(t.estimatedMinutes)}</span>` : '';

                const returnedBadge = t.isReturned ? `<span onclick="dismissReturnedStatus('${t.id}')" class="returned-badge cursor-pointer hover:bg-yellow-100 dark:hover:bg-yellow-900/50 flex items-center gap-1 text-[10px] font-bold text-yellow-600 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/30 px-1.5 py-0.5 rounded border border-yellow-200 dark:border-yellow-800/50" title="Click to dismiss status"> Returned <span class="ml-1 opacity-50"></span></span>` : '';
                const returnedClass = t.isReturned ? 'returned-badge-glow' : '';

                // STAGGER APPLIED HERE
                const dragIndicator = `<div class="drag-indicator absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                    </svg>
                </div>`;
                const card = `
            <div data-id="${t.id}" class="${(animate && !t.isReturned) ? 'stagger-item' : ''} task-card-container ${returnedClass} p-4 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md hover:-translate-y-1 transition-all group relative mb-3 border-l-4 border-hub-500 cursor-move" style="animation-delay: ${index * 30}ms">
                ${dragIndicator}
                <div class="flex justify-between items-start mb-2">
                    <div class="flex flex-col gap-1">
                        <h3 class="font-bold text-slate-800 dark:text-slate-100 leading-tight">${t.title}</h3>
                        ${returnedBadge}
                    </div>
                    <span class="text-xs font-bold px-2 py-0.5 rounded-full ${getCategoryColor(t.category)} whitespace-nowrap">${t.category}</span>
                </div>
                <div class="flex justify-between items-center text-sm mb-2">
                    <span class="flex items-center ${dueClass}">${dueIcon} ${due ? `Due: ${dueText}` : dueText}</span>
                    <div class="flex items-center gap-3">
                        ${estimateLabel}
                        ${noteIcon}
                    </div>
                </div>
                ${noteDiv}
                <div class="desk-actions">
                    ${moveButtons}
                    <div class="space-x-2">
                        ${focusBtn}
                        <button onclick="openMyDeskModal('${t.id}')" class="text-xs text-hub-600 font-bold hover:text-hub-800">Edit</button>
                        <button onclick="completeMyDeskTask('${t.id}', this)" class="text-xs text-slate-400 font-bold hover:text-red-600">Done</button>
                    </div>
                </div>
            </div>`;

                if (targetCol) targetCol.innerHTML += card;
            });

            // Render completed tasks
            completedTasks.forEach((t, index) => {
                const completedDate = new Date(t.completedDate + 'T12:00:00');
                const completedText = getRelativeDateDisplay(completedDate);
                const isSelected = selectedCompletedTasks.includes(t.id);

                const checkboxHtml = completedSelectionMode ?
                    `<input type="checkbox" ${isSelected ? 'checked' : ''} onclick="toggleCompletedTaskSelection('${t.id}')" class="mr-3 w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500">` : '';

                const completedCard = `
            <div class="${animate ? 'stagger-item' : ''} ${isSelected ? 'ring-2 ring-green-500' : ''} desk-card border-l-4 border-green-500 mb-3" style="animation-delay: ${index * 30}ms">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center flex-1">
                        ${checkboxHtml}
                        <h3 class="font-bold text-slate-800 leading-tight line-through">${t.title}</h3>
                    </div>
                    <span class="text-xs font-bold px-2 py-0.5 rounded-full ${getCategoryColor(t.category)} whitespace-nowrap">${t.category}</span>
                </div>
                <div class="flex justify-between items-center text-sm mb-2">
                    <span class="flex items-center text-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Completed ${completedText}
                    </span>
                </div>
                ${t.notes ? `<div class="note-content bg-slate-50 rounded-lg text-xs text-slate-600 p-3 border border-slate-200 whitespace-pre-wrap">${t.notes}</div>` : ''}
                <div class="desk-actions">
                    <div class="text-xs text-slate-500">${t.originalStatus === 'AtHand' ? 'From At Hand' : 'From Table'}</div>
                    <div class="space-x-2">
                        ${!completedSelectionMode ? `<button onclick="restoreCompletedTask('${t.id}')" class="text-xs text-hub-600 font-bold hover:text-hub-800">Restore</button>` : ''}
                        ${!completedSelectionMode ? `<button onclick="archiveCompletedTask('${t.id}')" class="text-xs text-slate-400 font-bold hover:text-red-600">Archive</button>` : ''}
                    </div>
                </div>
            </div>`;

                completedCol.innerHTML += completedCard;
            });

            // Empty states
            if (!atHand.innerHTML) {
                atHand.innerHTML = `<div class="flex flex-col items-center justify-center py-8 opacity-60 hover:opacity-100 transition-opacity group cursor-pointer" onclick="openMyDeskModal()"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-slate-300 mb-3 group-hover:text-hub-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M18 8h1a4 4 0 010 8h-1M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8zM6 1v3M10 1v3M14 1v3" /></svg><p class="text-slate-500 font-bold text-sm">All clear!</p><button class="text-xs bg-slate-200 hover:bg-hub-600 hover:text-white text-slate-600 font-bold py-1 px-3 rounded mt-2 transition-colors">+ Add Priority Task</button></div>`;
            }
            if (!onTable.innerHTML) {
                onTable.innerHTML = `<div class="flex flex-col items-center justify-center py-8 opacity-60 hover:opacity-100 transition-opacity group cursor-pointer" onclick="openMyDeskModal()"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-slate-300 mb-3 group-hover:text-hub-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" /></svg><p class="text-slate-500 font-bold text-sm">Clean Desk</p><button class="text-xs bg-slate-200 hover:bg-hub-600 hover:text-white text-slate-600 font-bold py-1 px-3 rounded mt-2 transition-colors">+ Add Task</button></div>`;
            }
            if (!inDrawer.innerHTML) {
                inDrawer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-48 text-center opacity-60 mt-8">
                    <div class="w-16 h-16 bg-amber-50 dark:bg-slate-700/50 rounded-full flex items-center justify-center mb-3">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                    </div>
                    <p class="text-sm text-slate-400 font-medium">Drawer is empty</p>
                    <p class="text-xs text-slate-300">Future tasks go here</p>
                </div>`;
            }
            if (!completedCol.innerHTML) {
                completedCol.innerHTML = `<div class="flex flex-col items-center justify-center py-8 opacity-60 hover:opacity-100 transition-opacity group cursor-pointer" onclick="document.getElementById('completedTaskFilter').value='all'; renderMyDesk();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-slate-300 mb-3 group-hover:text-green-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="text-slate-500 font-bold text-sm">No completed tasks</p>
                    <button class="text-xs bg-slate-200 hover:bg-green-600 hover:text-white text-slate-600 font-bold py-1 px-3 rounded mt-2 transition-colors">Show All</button>
                </div>`;
            }
            if (animate) setTimeout(initSpotlight, 100);
            else initSpotlight();

            // Initialize drag & drop for each column with cross-column support
            const columnConfigs = [
                { id: 'colAtHand', status: 'AtHand' },
                { id: 'colOnTheTable', status: 'OnTheTable' },
                { id: 'colInDrawer', status: 'InDrawer' }
            ];

            // Destroy existing instances
            columnConfigs.forEach(config => {
                const column = document.getElementById(config.id);
                if (column && column.sortableInstance) {
                    column.sortableInstance.destroy();
                }
            });

            // Create new Sortable instances with shared group
            columnConfigs.forEach(config => {
                const column = document.getElementById(config.id);
                if (column) {
                    column.sortableInstance = new Sortable(column, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        delay: 100,
                        delayOnTouchOnly: true,
                        group: 'desk-columns', // Same group allows cross-column dragging
                        handle: '.task-card-container', // Make entire card draggable
                        onEnd: function (evt) {
                            handleDeskTaskDragEnd(evt);
                        }
                    });
                }
            });

            // Safeguard for invisible returned tasks
            setTimeout(() => {
                document.querySelectorAll('.returned-badge-glow').forEach(el => {
                    el.style.opacity = '1';
                    el.style.visibility = 'visible';
                });
            }, 100);
        }

        function handleDeskTaskDragEnd(evt) {
            const { item, from, to, oldIndex, newIndex } = evt;

            if (!item || !from || !to) return;

            const taskId = item.getAttribute('data-id');
            if (!taskId) return;

            const task = appData.myDesk.find(t => t.id === taskId);
            if (!task) return;

            const fromColumnId = from.id;
            const toColumnId = to.id;

            // Determine source and target statuses from column IDs
            let sourceStatus = task.status; // Current status from task
            if (fromColumnId === 'colAtHand') sourceStatus = 'AtHand';
            else if (fromColumnId === 'colOnTheTable') sourceStatus = 'OnTheTable';
            else if (fromColumnId === 'colInDrawer') sourceStatus = 'InDrawer';

            let targetStatus = sourceStatus; // Default to same status
            if (toColumnId === 'colAtHand') targetStatus = 'AtHand';
            else if (toColumnId === 'colOnTheTable') targetStatus = 'OnTheTable';
            else if (toColumnId === 'colInDrawer') targetStatus = 'InDrawer';

            // Update task status if moved to different column
            const movedToNewColumn = fromColumnId !== toColumnId;
            if (movedToNewColumn) {
                task.status = targetStatus;
            }

            // Get all tasks in the target column after the drop
            const targetColumnTasks = Array.from(to.querySelectorAll('.task-card-container'));
            const targetTaskIds = targetColumnTasks.map(card => card.getAttribute('data-id'));

            // Update sortOrder for all tasks in the target column
            // Group by due date and update sortOrder within each group
            const tasksByDate = {};

            targetTaskIds.forEach(taskId => {
                const t = appData.myDesk.find(task => task.id === taskId);
                if (t && t.status === targetStatus) {
                    const dateKey = (t.dueDateStart || t.dueDate || 'no-date');
                    if (!tasksByDate[dateKey]) tasksByDate[dateKey] = [];
                    tasksByDate[dateKey].push(t);
                }
            });

            // Update sortOrder based on DOM order within each due date group
            Object.keys(tasksByDate).forEach(dateKey => {
                const sameDateTasks = tasksByDate[dateKey];
                if (sameDateTasks.length > 0) {
                    // Get the order of these tasks in the DOM
                    const orderedTaskIds = targetTaskIds.filter(id =>
                        sameDateTasks.some(t => t.id === id)
                    );

                    // Update sortOrder based on DOM order
                    orderedTaskIds.forEach((taskId, index) => {
                        const t = appData.myDesk.find(task => task.id === taskId);
                        if (t && t.status === targetStatus) {
                            t.sortOrder = index;
                        }
                    });
                }
            });

            // If moved to new column, also update sortOrder for source column
            if (movedToNewColumn) {
                const sourceColumn = document.getElementById(fromColumnId);
                if (sourceColumn) {
                    const sourceTaskIds = Array.from(sourceColumn.querySelectorAll('.task-card-container'))
                        .map(card => card.getAttribute('data-id'));

                    // Update sortOrder for remaining tasks in source column
                    const sourceTasksByDate = {};
                    sourceTaskIds.forEach(taskId => {
                        const t = appData.myDesk.find(task => task.id === taskId);
                        if (t && t.status === sourceStatus) {
                            const dateKey = (t.dueDateStart || t.dueDate || 'no-date');
                            if (!sourceTasksByDate[dateKey]) sourceTasksByDate[dateKey] = [];
                            sourceTasksByDate[dateKey].push(t);
                        }
                    });

                    Object.keys(sourceTasksByDate).forEach(dateKey => {
                        const sameDateTasks = sourceTasksByDate[dateKey];
                        const orderedTaskIds = sourceTaskIds.filter(id =>
                            sameDateTasks.some(t => t.id === id)
                        );

                        orderedTaskIds.forEach((taskId, index) => {
                            const t = appData.myDesk.find(task => task.id === taskId);
                            if (t && t.status === sourceStatus) {
                                t.sortOrder = index;
                            }
                        });
                    });
                }
            }

            saveData();

            // Re-render to ensure proper sorting and visual update
            renderMyDesk(false);

            // Re-render calendar if in calendar view
            if (myDeskCalendarViewMode === 'calendar') {
                renderCalendar();
            }

            // Show feedback if moved to new column
            if (movedToNewColumn) {
                const statusNames = {
                    'AtHand': 'At Hand',
                    'OnTheTable': 'On The Table',
                    'InDrawer': 'In The Drawer'
                };
                showToast(`Task moved to ${statusNames[targetStatus]}`, "success");
            }
        }

        function initializeTaskSortOrders() {
            if (!appData.myDesk) return;

            // Group by status and due date, then assign sortOrder
            const statuses = ['AtHand', 'OnTheTable', 'InDrawer'];

            statuses.forEach(status => {
                const statusTasks = appData.myDesk.filter(t => t.status === status);

                // Sort by due date first
                statusTasks.sort((a, b) => {
                    const date1 = a.dueDateStart || a.dueDate;
                    const date2 = b.dueDateStart || b.dueDate;
                    const d1 = date1 ? new Date(date1 + 'T00:00:00') : new Date(8640000000000000);
                    const d2 = date2 ? new Date(date2 + 'T00:00:00') : new Date(8640000000000000);
                    return d1 - d2;
                });

                // Group by due date and assign sortOrder
                const tasksByDate = {};
                statusTasks.forEach(task => {
                    const dateKey = (task.dueDateStart || task.dueDate || 'no-date');
                    if (!tasksByDate[dateKey]) tasksByDate[dateKey] = [];
                    tasksByDate[dateKey].push(task);
                });

                Object.keys(tasksByDate).forEach(dateKey => {
                    tasksByDate[dateKey].forEach((task, index) => {
                        if (task.sortOrder === undefined) {
                            task.sortOrder = index;
                        }
                    });
                });
            });
        }

        function toggleTaskNote(id) {
            const el = document.getElementById(`note-${id}`);
            if (el) el.classList.toggle('open');
        }

        function getRelativeDateDisplay(date) {
            if (!date) return 'No Date';
            const diff = getDaysDiff(getToday(), date);
            if (diff === 0) return 'Today';
            if (diff === 1) return 'Tomorrow';
            if (diff === -1) return 'Yesterday';
            if (diff < -1) return `${Math.abs(diff)} days ago`;
            if (diff > 1) return `in ${diff} days`;
            return formatDateShort(date.toISOString().split('T')[0]);
        }

        function formatEstimate(minutes) {
            if (!minutes) return '';
            if (minutes < 60) return `${minutes}m`;
            const hrs = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins ? `${hrs}h ${mins}m` : `${hrs}h`;
        }

        function formatRemainingTime(ms) {
            if (ms <= 0) return '00:00';
            const totalSeconds = Math.ceil(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            if (hours > 0) return `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            return `${minutes}:${String(seconds).padStart(2, '0')}`;
        }

        // --- Scheduled Task Notifications ---
        function checkScheduledNotifications() {
            if (!appData || !appData.myDesk) return;
            const now = new Date();
            const todayStr = now.toLocaleDateString('en-CA'); // YYYY-MM-DD

            console.log(`[NotifCheck] Running at ${now.toLocaleTimeString()}`);

            appData.myDesk.forEach(task => {
                // Skip if no scheduled time
                if (!task.scheduledTime) return;

                // Skip if no date or not today (handle both YYYY-MM-DD and other formats)
                if (!task.dueDate) return;
                const taskDateStr = task.dueDate.split('T')[0]; // Handle ISO format too
                if (taskDateStr !== todayStr) return;

                // Parse time (format: "HH:MM")
                const timeParts = task.scheduledTime.split(':');
                if (timeParts.length < 2) return;
                const hours = parseInt(timeParts[0], 10);
                const mins = parseInt(timeParts[1], 10);
                if (isNaN(hours) || isNaN(mins)) return;

                const taskTime = new Date();
                taskTime.setHours(hours, mins, 0, 0);

                const diffMs = taskTime - now;
                const diffMins = diffMs / 60000;

                // Log tasks being checked
                console.log(`[NotifCheck] "${task.title}" scheduled ${taskTime.toLocaleTimeString()}, diff: ${diffMins.toFixed(1)} min, notified: ${task.notifiedAt ? 'yes' : 'no'}`);

                // Notify AT the scheduled time (within 1.5 minute window: -0.5 to +1 minute)
                // This fires when the time arrives or just passed
                if (diffMins >= -0.5 && diffMins <= 1 && !task.notifiedAt) {
                    const timeStr = taskTime.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

                    console.log(`[Notification]  FIRING for "${task.title}" at ${new Date().toLocaleTimeString()}`);

                    // 1. Play alert sound (with repeat for attention)
                    SoundEngine.reminder();
                    setTimeout(() => SoundEngine.reminder(), 1500);
                    setTimeout(() => SoundEngine.reminder(), 3000);

                    // 2. Show sticky reminder toast (stays until dismissed or 30 seconds)
                    showStickyReminder(task.title, timeStr);

                    // 3. Browser notification (if permitted)
                    showBrowserNotification(task.title, `It's time! Scheduled for ${timeStr}`);

                    task.notifiedAt = Date.now();
                    saveData();
                }
            });
        }

        // Sticky reminder that's hard to miss
        function showStickyReminder(title, timeStr) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = 'toast toast-reminder font-bold';
            toast.style.animation = 'toast-in 0.5s ease-out, toast-shake 0.5s ease-in-out 0.5s, toast-pulse 2s ease-in-out 1s infinite';
            toast.innerHTML = `
                <div class="flex items-center justify-between gap-4">
                    <span> NOW: "${title}" (${timeStr})</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="bg-white/20 hover:bg-white/30 rounded-full p-1 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            `;

            container.appendChild(toast);

            // Auto-remove after 30 seconds if not dismissed
            setTimeout(() => {
                if (toast.parentElement) toast.remove();
            }, 30000);
        }

        // Browser Notification helper
        function showBrowserNotification(title, body) {
            // Check if browser supports notifications
            if (!('Notification' in window)) {
                console.log('[Notification] Browser does not support notifications');
                return;
            }

            if (Notification.permission === 'granted') {
                new Notification(` ${title}`, {
                    body: body,
                    icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"%3E%3Crect width="24" height="24" rx="6" fill="%237c3aed"/%3E%3Cpath d="M12 8v4l3 3" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/%3E%3Ccircle cx="12" cy="12" r="7" stroke="white" stroke-width="2" fill="none"/%3E%3C/svg%3E',
                    tag: 'task-reminder', // Prevents duplicate notifications
                    requireInteraction: false
                });
            } else if (Notification.permission !== 'denied') {
                // Request permission
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification(` ${title}`, { body: body });
                    }
                });
            }
        }

        // Request notification permission on first user interaction
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('[Notification] Permission:', permission);
                });
            }
        }

        // Request permission after first click anywhere
        document.addEventListener('click', function requestOnce() {
            requestNotificationPermission();
            document.removeEventListener('click', requestOnce);
        }, { once: true });

        // Start the scheduled notification checker (every 20 seconds for reliability)
        setInterval(checkScheduledNotifications, 20000);
        // Also run once on load after a short delay
        setTimeout(checkScheduledNotifications, 1500);
        console.log('[LeadershipOS] Scheduled task notification checker started');

        // Utility: Clear all notification flags (run in console if notifications are stuck)
        function resetTaskNotifications() {
            if (!appData || !appData.myDesk) return;
            appData.myDesk.forEach(task => {
                delete task.notifiedAt;
            });
            saveData();
            console.log('[LeadershipOS] All task notification flags cleared');
            showToast('Notification flags reset', 'success');
        }

        // Utility: Debug scheduled tasks (run in console)
        function debugScheduledTasks() {
            const now = new Date();
            const todayStr = now.toLocaleDateString('en-CA');
            console.log('=== Scheduled Tasks Debug ===');
            console.log('Current time:', now.toLocaleTimeString());
            console.log('Today (en-CA):', todayStr);
            appData.myDesk.forEach(task => {
                if (task.scheduledTime) {
                    console.log(`Task: "${task.title}"`);
                    console.log(`  - dueDate: ${task.dueDate}`);
                    console.log(`  - scheduledTime: ${task.scheduledTime}`);
                    console.log(`  - notifiedAt: ${task.notifiedAt || 'not set'}`);
                    console.log(`  - matches today: ${task.dueDate === todayStr}`);
                }
            });
        }

        function updateMyDeskDateDisplay(input) {
            const inputId = input.id;

            // Handle single date input
            if (inputId === 'myDeskDueDate') {
                const container = input.parentElement;
                if (!container) return;
                const emptyState = container.querySelector('#myDeskDateEmpty');
                const filledState = container.querySelector('#myDeskDateFilled');
                const textSpan = container.querySelector('#myDeskDateText');

                // Check for range dates
                const rangeStart = input.getAttribute('data-range-start');
                const rangeEnd = input.getAttribute('data-range-end');

                if (rangeStart && rangeEnd) {
                    // Range date: use formatDateRange
                    emptyState.classList.add('hidden');
                    filledState.classList.remove('hidden');
                    textSpan.textContent = formatDateRange(rangeStart, rangeEnd);
                } else if (input.value) {
                    // Single date: format as before
                    emptyState.classList.add('hidden');
                    filledState.classList.remove('hidden');
                    // Format date: "Oct 24"
                    const d = new Date(input.value + 'T12:00:00');
                    const m = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    textSpan.textContent = m;
                } else {
                    emptyState.classList.remove('hidden');
                    filledState.classList.add('hidden');
                    textSpan.textContent = '';
                }
            }
        }

        function clearMyDeskDate(e, inputId) {
            e.stopPropagation();
            const id = inputId || 'myDeskDueDate';
            const input = document.getElementById(id);
            if (input) {
                input.value = '';
                input.removeAttribute('data-range-start');
                input.removeAttribute('data-range-end');
                updateMyDeskDateDisplay(input);
            }
        }


        function clearScheduledTime() {
            const input = document.getElementById('myDeskScheduledTime');
            if (input) {
                input.value = '';
                toggleTimeClearBtn();
            }
        }

        function toggleTimeClearBtn() {
            const input = document.getElementById('myDeskScheduledTime');
            const btn = document.getElementById('timeClearBtn');
            if (btn && input) {
                btn.classList.toggle('hidden', !input.value);
            }
        }

        function openMyDeskModal(id = null, prefillStartDate = null, prefillEndDate = null) {
            document.getElementById('myDeskForm').reset();
            document.getElementById('myDeskTaskId').value = '';
            const editor = document.getElementById('myDeskNotesEditor');
            editor.innerHTML = '';
            editor.removeAttribute('data-placeholder');
            editor.classList.remove('empty-editor');
            setSelectedEstimate('');

            if (id) {
                const t = appData.myDesk.find(x => x.id === id);
                if (t) {
                    document.getElementById('myDeskTaskId').value = t.id;
                    document.getElementById('myDeskTitle').value = t.title;

                    // Load range dates or single date
                    const dueDateInput = document.getElementById('myDeskDueDate');
                    if (t.dueDateStart && t.dueDateEnd) {
                        // Range date: set both start and end
                        dueDateInput.value = t.dueDateEnd; // Display end date in input
                        dueDateInput.setAttribute('data-range-start', t.dueDateStart);
                        dueDateInput.setAttribute('data-range-end', t.dueDateEnd);
                    } else if (t.dueDate) {
                        // Legacy single date: convert to new format
                        dueDateInput.value = t.dueDate;
                        dueDateInput.setAttribute('data-range-start', t.dueDate);
                        dueDateInput.setAttribute('data-range-end', t.dueDate);
                    } else {
                        dueDateInput.value = '';
                        dueDateInput.removeAttribute('data-range-start');
                        dueDateInput.removeAttribute('data-range-end');
                    }
                    updateMyDeskDateDisplay(dueDateInput);

                    // Show time field
                    const timeField = document.getElementById('myDeskScheduledTime');
                    const timeFieldContainer = timeField ? timeField.closest('.col-span-4') : null;
                    if (timeFieldContainer) {
                        timeFieldContainer.classList.remove('hidden');
                    }

                    document.getElementById('myDeskScheduledTime').value = t.scheduledTime || '';
                    toggleTimeClearBtn();
                    document.getElementById('myDeskCategory').value = t.category;
                    document.getElementById('myDeskStatus').value = t.status;
                    loadNotesIntoEditor(t.notes);
                    setSelectedEstimate(t.estimatedMinutes || '');
                }
            } else {
                // New task - ensure time field is visible
                const timeField = document.getElementById('myDeskScheduledTime');
                const timeFieldContainer = timeField ? timeField.closest('.col-span-4') : null;
                if (timeFieldContainer) {
                    timeFieldContainer.classList.remove('hidden');
                }
                const dd = document.getElementById('myDeskDueDate');
                if (dd) {
                    if (prefillStartDate && prefillEndDate) {
                        // Pre-fill with date range from calendar selection
                        const startDateStr = formatCalendarDate(prefillStartDate);
                        const endDateStr = formatCalendarDate(prefillEndDate);
                        dd.value = endDateStr; // Display end date in input
                        dd.setAttribute('data-range-start', startDateStr);
                        dd.setAttribute('data-range-end', endDateStr);
                        updateMyDeskDateDisplay(dd);
                    } else {
                        dd.value = ''; // Ensure empty by default
                        dd.removeAttribute('data-range-start');
                        dd.removeAttribute('data-range-end');
                        updateMyDeskDateDisplay(dd);
                    }
                }
                document.getElementById('myDeskScheduledTime').value = '';
                toggleTimeClearBtn();
                loadNotesIntoEditor('');
                setSelectedEstimate('');
            }
            toggleModal('myDeskModal');
            setTimeout(() => {
                setupEditorPlaceholder();
                document.getElementById('myDeskTitle').focus();
            }, 100);
        }

        function saveMyDeskEntry(e) {
            e.preventDefault();
            const id = document.getElementById('myDeskTaskId').value;
            const title = document.getElementById('myDeskTitle').value;
            const scheduledTime = document.getElementById('myDeskScheduledTime').value;
            const category = document.getElementById('myDeskCategory').value;
            const status = document.getElementById('myDeskStatus').value;
            const notes = document.getElementById('myDeskNotes').value;
            const estimatedInput = parseInt(document.getElementById('myDeskEstimatedMinutes').value, 10);
            const estimatedMinutes = isNaN(estimatedInput) ? null : estimatedInput;

            const dueDateInput = document.getElementById('myDeskDueDate');
            const dueDate = dueDateInput.value || '';

            // Check for range dates
            const rangeStart = dueDateInput.getAttribute('data-range-start');
            const rangeEnd = dueDateInput.getAttribute('data-range-end');

            const task = {
                id: id || 'desk_' + Date.now(),
                title,
                scheduledTime,
                category,
                status,
                notes,
                estimatedMinutes,
                sourceId: null,
                sortOrder: 0 // Initialize sortOrder for new tasks
            };

            // Store dates as object format: dueDateStart and dueDateEnd
            if (rangeStart && rangeEnd) {
                task.dueDateStart = rangeStart;
                task.dueDateEnd = rangeEnd;
            } else if (dueDate) {
                // Single date: use same value for both start and end
                task.dueDateStart = dueDate;
                task.dueDateEnd = dueDate;
            } else {
                // Explicitly clear dates when due date is empty
                task.dueDateStart = null;
                task.dueDateEnd = null;
            }

            if (id) {
                const idx = appData.myDesk.findIndex(x => x.id === id);
                // Clear notifiedAt if time changed so notification can fire again
                const existingTask = appData.myDesk[idx];
                if (existingTask && existingTask.scheduledTime !== scheduledTime) {
                    delete task.notifiedAt;
                }
                if (idx > -1) {
                    // Remove old date properties to ensure they're cleared
                    const updatedTask = { ...appData.myDesk[idx], ...task };
                    // Preserve sortOrder if it exists, otherwise keep the default
                    if (appData.myDesk[idx].sortOrder !== undefined) {
                        updatedTask.sortOrder = appData.myDesk[idx].sortOrder;
                    }
                    if (!task.dueDateStart && !task.dueDateEnd) {
                        delete updatedTask.dueDateStart;
                        delete updatedTask.dueDateEnd;
                        // Also remove legacy dueDate if it exists
                        delete updatedTask.dueDate;
                    }
                    appData.myDesk[idx] = updatedTask;
                }
            } else {
                appData.myDesk.push(task);
            }
            saveData(); toggleModal('myDeskModal');
            showToast("Task saved to My Desk", "success");
            // Re-render calendar if in calendar view
            if (myDeskCalendarViewMode === 'calendar') {
                renderCalendar();
            }
        }

        function moveDeskTask(id, status) {
            const t = appData.myDesk.find(x => x.id === id);
            if (t) {
                t.status = status;
                saveData();
                renderMyDesk(false);
                // Re-render calendar if in calendar view
                if (myDeskCalendarViewMode === 'calendar') {
                    renderCalendar();
                }
            }
        }
        function completeMyDeskTask(id, btnElement) {
            const task = appData.myDesk.find(x => x.id === id);
            if (task) {
                if (appData.focusTaskId === id) stopFocus(true);
                // Move to completed tasks with completion date
                const completedTask = {
                    ...task,
                    completedDate: new Date().toLocaleDateString('en-CA'),
                    originalStatus: task.status
                };
                if (!appData.completedMyDesk) appData.completedMyDesk = [];
                appData.completedMyDesk.push(completedTask);

                // Remove from active tasks
                appData.myDesk = appData.myDesk.filter(x => x.id !== id);

                SoundEngine.success();
                if (btnElement) {
                    triggerTaskCompletionConfetti(btnElement);
                }
                saveData();
                renderMyDesk();
                // Re-render calendar if in calendar view
                if (myDeskCalendarViewMode === 'calendar') {
                    renderCalendar();
                }
                showToast("Task completed!", "success");
            }
        }

        let currentContextMenuTaskId = null;

        function snoozeTask(taskId, snoozeType) {
            const taskIndex = appData.myDesk.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = appData.myDesk[taskIndex];
            const returnDate = calculateSnoozeReturnDate(snoozeType);

            // Visual fade out
            const cardElement = document.querySelector(`.task-card-container[data-id="${taskId}"]`);
            if (cardElement) {
                cardElement.classList.add('fade-out');
            }

            setTimeout(() => {
                // Remove from myDesk
                appData.myDesk.splice(taskIndex, 1);

                // Add to snoozed array in localStorage
                const snoozed = JSON.parse(localStorage.getItem('leadership_os_snoozed') || '[]');
                snoozed.push({
                    task: task,
                    returnDate: returnDate.toISOString()
                });
                localStorage.setItem('leadership_os_snoozed', JSON.stringify(snoozed));

                saveData();
                renderMyDesk();
                hideTaskContextMenu();

                const timeStr = returnDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                const dateStr = returnDate.toLocaleDateString([], { month: 'short', day: 'numeric' });
                showToast(`Task snoozed until ${dateStr} at ${timeStr}`, "info");
            }, 400); // Match CSS transition duration
        }

        function calculateSnoozeReturnDate(type) {
            let date = new Date();
            date.setHours(9, 0, 0, 0); // Default to 9 AM

            if (type === 'tomorrow') {
                date.setDate(date.getDate() + 1);
            } else if (type === '2days') {
                // Add 2 business days
                let daysAdded = 0;
                while (daysAdded < 2) {
                    date.setDate(date.getDate() + 1);
                    const day = date.getDay();
                    if (day !== 0 && day !== 6) { // Skip Sunday (0) and Saturday (6)
                        daysAdded++;
                    }
                }
            } else if (type === 'monday') {
                // Next Monday
                const day = date.getDay();
                const daysUntilMonday = (1 + 7 - day) % 7 || 7;
                date.setDate(date.getDate() + daysUntilMonday);
            }
            return date;
        }

        let customSnoozeTaskId = null;

        function openCustomSnoozeModal(taskId) {
            customSnoozeTaskId = taskId;
            const dateInput = document.getElementById('customSnoozeDate');
            const timeInput = document.getElementById('customSnoozeTime');
            
            // Set minimum date to today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            dateInput.min = today.toISOString().split('T')[0];
            
            // Set default to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            dateInput.value = tomorrow.toISOString().split('T')[0];
            timeInput.value = '09:00';
            
            hideTaskContextMenu();
            toggleModal('customSnoozeModal');
        }

        function confirmCustomSnooze() {
            if (!customSnoozeTaskId) return;
            
            const dateInput = document.getElementById('customSnoozeDate');
            const timeInput = document.getElementById('customSnoozeTime');
            
            if (!dateInput.value || !timeInput.value) {
                showToast('Please select both date and time', 'error');
                return;
            }
            
            // Combine date and time
            const selectedDate = new Date(dateInput.value + 'T' + timeInput.value + ':00');
            
            // Validate that the date is in the future
            if (selectedDate <= new Date()) {
                showToast('Please select a future date and time', 'error');
                return;
            }
            
            snoozeTaskWithCustomDate(customSnoozeTaskId, selectedDate);
            toggleModal('customSnoozeModal');
            customSnoozeTaskId = null;
        }

        function snoozeTaskWithCustomDate(taskId, returnDate) {
            const taskIndex = appData.myDesk.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const task = appData.myDesk[taskIndex];

            // Visual fade out
            const cardElement = document.querySelector(`.task-card-container[data-id="${taskId}"]`);
            if (cardElement) {
                cardElement.classList.add('fade-out');
            }

            setTimeout(() => {
                // Remove from myDesk
                appData.myDesk.splice(taskIndex, 1);

                // Add to snoozed array in localStorage
                const snoozed = JSON.parse(localStorage.getItem('leadership_os_snoozed') || '[]');
                snoozed.push({
                    task: task,
                    returnDate: returnDate.toISOString()
                });
                localStorage.setItem('leadership_os_snoozed', JSON.stringify(snoozed));

                saveData();
                renderMyDesk();
                hideTaskContextMenu();

                const timeStr = returnDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                const dateStr = returnDate.toLocaleDateString([], { 
                    month: 'short', 
                    day: 'numeric', 
                    year: returnDate.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined 
                });
                showToast(`Task snoozed until ${dateStr} at ${timeStr}`, "info");
            }, 400);
        }

        function hideTaskContextMenu() {
            const menu = document.getElementById('taskContextMenu');
            if (menu) {
                menu.classList.add('hidden');
                menu.style.display = 'none';
            }
        }

        function checkSnoozedTasks() {
            try {
                const snoozed = JSON.parse(localStorage.getItem('leadership_os_snoozed') || '[]');
                if (snoozed.length === 0) return;

                const now = new Date();
                const stillSnoozed = [];
                let returnedCount = 0;

                snoozed.forEach(item => {
                    const returnDate = new Date(item.returnDate);
                    if (now >= returnDate) {
                        const task = item.task;
                        
                        // Check if task already exists in myDesk to prevent duplicates
                        const existingTask = appData.myDesk.find(t => t.id === task.id);
                        if (!existingTask) {
                            task.status = 'OnTheTable';
                            task.isReturned = true;
                            // Set sortOrder to -1 so returned tasks appear first among tasks with same due date
                            if (task.sortOrder === undefined) {
                                task.sortOrder = -1;
                            }
                            appData.myDesk.push(task);
                            returnedCount++;
                        }
                    } else {
                        stillSnoozed.push(item);
                    }
                });

                if (returnedCount > 0) {
                    localStorage.setItem('leadership_os_snoozed', JSON.stringify(stillSnoozed));
                    saveData(true); // Skip render - we'll handle rendering separately
                    
                    // Only render My Desk if the tab is currently active
                    const myDeskView = document.getElementById('myDeskView');
                    if (myDeskView && !myDeskView.classList.contains('hidden')) {
                        renderMyDesk();
                    }
                    // If tab is not active, just update the badge - task will render when tab is switched to
                    updateSnoozeButton();
                    showToast(`${returnedCount} task(s) returned from snooze`, "info");
                }
            } catch (e) {
                console.error('Error checking snoozed tasks:', e);
            }
        }

        function updateSnoozeButton() {
            const snoozed = JSON.parse(localStorage.getItem('leadership_os_snoozed') || '[]');
            const badge = document.getElementById('snoozedCountBadge');
            if (badge) {
                if (snoozed.length > 0) {
                    badge.textContent = snoozed.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        function renderSnoozedTasks() {
            const list = document.getElementById('snoozedTasksList');
            const snoozed = JSON.parse(localStorage.getItem('leadership_os_snoozed') || '[]');

            if (snoozed.length === 0) {
                list.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-slate-400">
                    <span class="text-5xl mb-4"></span>
                    <p class="font-medium">No tasks are currently snoozed.</p>
                </div>`;
                return;
            }

            list.innerHTML = snoozed.map((item, index) => {
                const returnDate = new Date(item.returnDate);
                const isOverdue = new Date() >= returnDate;
                return `
                    <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-violet-300 dark:hover:border-violet-900/50 transition-colors group">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-bold uppercase px-1.5 py-0.5 rounded bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400">${item.task.category}</span>
                                <h4 class="font-bold text-slate-800 dark:text-slate-100">${item.task.title}</h4>
                            </div>
                            <p class="text-xs ${isOverdue ? 'text-amber-600 font-bold' : 'text-slate-500'} flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Returns: ${returnDate.toLocaleDateString([], { month: 'short', day: 'numeric' })} at ${returnDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="unsnoozeTask(${index})" class="px-3 py-1.5 bg-violet-100 text-violet-700 dark:bg-violet-900/30 dark:text-violet-400 rounded-lg text-xs font-bold hover:bg-violet-200 dark:hover:bg-violet-900/50 transition-colors">Restore Now</button>
                            <button onclick="deleteSnoozedTask(${index})" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function dismissReturnedStatus(taskId) {
            const task = appData.myDesk.find(t => t.id === taskId);
            if (task) {
                task.isReturned = false;
                saveData(true);
                renderMyDesk();
                showToast("Status cleared", "info");
            }
        }

        function unsnoozeTask(index) {
            const snoozed = JSON.parse(localStorage.getItem('leadership_os_snoozed') || '[]');
            const item = snoozed.splice(index, 1)[0];

            // Put back in appData
            item.task.status = 'OnTheTable';
            item.task.isReturned = true;
            appData.myDesk.push(item.task);

            localStorage.setItem('leadership_os_snoozed', JSON.stringify(snoozed));
            saveData();
            renderMyDesk();
            renderSnoozedTasks();
            showToast("Task restored to My Desk", "success");

            if (snoozed.length === 0) {
                toggleModal('snoozedTasksModal');
            }
        }

        function deleteSnoozedTask(index) {
            if (confirm("Permanently delete this snoozed task?")) {
                const snoozed = JSON.parse(localStorage.getItem('leadership_os_snoozed') || '[]');
                snoozed.splice(index, 1);
                localStorage.setItem('leadership_os_snoozed', JSON.stringify(snoozed));
                renderSnoozedTasks();
                updateSnoozeButton();
                showToast("Snoozed task deleted", "info");

                if (snoozed.length === 0) {
                    toggleModal('snoozedTasksModal');
                }
            }
        }

        function deleteDeskTask(id) {
            if (confirm("Mark complete?")) {
                SoundEngine.delete();
                if (appData.focusTaskId === id) stopFocus(true);
                appData.myDesk = appData.myDesk.filter(x => x.id !== id);
                saveData();
                renderMyDesk(); // Refresh view
                showToast("Task completed", "success");
            }
        }

        // --- Completed Tasks Management ---
        let completedSelectionMode = false;
        let selectedCompletedTasks = [];

        function toggleCompletedSelectionMode() {
            completedSelectionMode = !completedSelectionMode;
            const btn = document.getElementById('completedSelectBtn');
            if (completedSelectionMode) {
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg><span>Done</span>`;
                btn.className = "bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm transition text-xs";
                selectedCompletedTasks = [];
                renderMyDesk(); // Re-render to show checkboxes
            } else {
                if (selectedCompletedTasks.length > 0) {
                    if (confirm(`Archive ${selectedCompletedTasks.length} completed task(s)?`)) {
                        archiveMultipleCompletedTasks(selectedCompletedTasks);
                    }
                }
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg><span>Select / Archive</span>`;
                btn.className = "desk-ghost-btn flex items-center gap-2";
                selectedCompletedTasks = [];
                renderMyDesk();
            }
        }

        function toggleCompletedTaskSelection(taskId) {
            const index = selectedCompletedTasks.indexOf(taskId);
            if (index > -1) {
                selectedCompletedTasks.splice(index, 1);
            } else {
                selectedCompletedTasks.push(taskId);
            }
            renderMyDesk();
        }

        function restoreCompletedTask(id) {
            const task = appData.completedMyDesk.find(x => x.id === id);
            if (task) {
                // Remove from completed and restore to active tasks
                appData.completedMyDesk = appData.completedMyDesk.filter(x => x.id !== id);
                const restoredTask = {
                    id: task.id,
                    title: task.title,
                    category: task.category,
                    status: task.originalStatus || 'OnTheTable',
                    notes: task.notes,
                    estimatedMinutes: task.estimatedMinutes
                };
                // Restore range dates if they exist, otherwise use legacy dueDate
                if (task.dueDateStart && task.dueDateEnd) {
                    restoredTask.dueDateStart = task.dueDateStart;
                    restoredTask.dueDateEnd = task.dueDateEnd;
                } else if (task.dueDate) {
                    restoredTask.dueDateStart = task.dueDate;
                    restoredTask.dueDateEnd = task.dueDate;
                }
                appData.myDesk.push(restoredTask);
                saveData();
                renderMyDesk();
                showToast("Task restored!", "success");
            }
        }

        function archiveCompletedTask(id) {
            if (confirm("Archive this completed task?")) {
                appData.completedMyDesk = appData.completedMyDesk.filter(x => x.id !== id);
                saveData();
                renderMyDesk();
                showToast("Task archived", "success");
            }
        }

        function archiveMultipleCompletedTasks(ids) {
            appData.completedMyDesk = appData.completedMyDesk.filter(x => !ids.includes(x.id));
            saveData();
            renderMyDesk();
            showToast(`${ids.length} task(s) archived`, "success");
        }

        // --- Rich Text Editor Functions ---
        function formatText(command, value = null) {
            const editor = document.getElementById('myDeskNotesEditor');
            editor.focus();

            // Special handling for list commands
            if (command === 'insertUnorderedList' || command === 'insertOrderedList') {
                // Ensure there's a selection or cursor position
                const selection = window.getSelection();
                if (selection.rangeCount === 0) {
                    const range = document.createRange();
                    range.selectNodeContents(editor);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }

            document.execCommand(command, false, value);
            updateNotesTextarea();
        }

        function clearFormatting() {
            const editor = document.getElementById('myDeskNotesEditor');
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            const selectedText = range.toString();

            if (selectedText) {
                document.execCommand('removeFormat');
            } else {
                // Clear all formatting
                editor.innerHTML = editor.innerText;
            }
            editor.focus();
            updateNotesTextarea();
        }

        function updateNotesTextarea() {
            const editor = document.getElementById('myDeskNotesEditor');
            const textarea = document.getElementById('myDeskNotes');
            textarea.value = editor.innerHTML;
        }

        function handleKeyDown(event) {
            // Handle keyboard shortcuts
            if (event.ctrlKey || event.metaKey) {
                switch (event.key) {
                    case 'b':
                        event.preventDefault();
                        formatText('bold');
                        break;
                    case 'i':
                        event.preventDefault();
                        formatText('italic');
                        break;
                }
            }
        }

        function loadNotesIntoEditor(notesHtml) {
            const editor = document.getElementById('myDeskNotesEditor');
            if (notesHtml && notesHtml.trim()) {
                editor.innerHTML = notesHtml;
            } else {
                editor.innerHTML = '';
            }
            updateNotesTextarea();
        }

        // Enhanced placeholder for contenteditable
        function setupEditorPlaceholder() {
            const editor = document.getElementById('myDeskNotesEditor');
            const placeholder = editor.getAttribute('placeholder');

            function checkPlaceholder() {
                if (editor.innerHTML.trim() === '' || editor.innerHTML === '<br>') {
                    editor.innerHTML = '';
                    editor.setAttribute('data-placeholder', placeholder);
                    editor.classList.add('empty-editor');
                } else {
                    editor.removeAttribute('data-placeholder');
                    editor.classList.remove('empty-editor');
                }
            }

            editor.addEventListener('input', checkPlaceholder);
            editor.addEventListener('focus', checkPlaceholder);
            editor.addEventListener('blur', checkPlaceholder);
            checkPlaceholder();
        }

        // --- Estimated Time Helpers ---
        function selectEstimatedTime(minutes, el) {
            const hidden = document.getElementById('myDeskEstimatedMinutes');
            const custom = document.getElementById('myDeskEstimateCustom');
            const customWrap = custom ? custom.closest('.estimate-custom') : null;
            document.querySelectorAll('.estimate-chip').forEach(btn => btn.classList.remove('estimate-chip-active'));
            if (el) el.classList.add('estimate-chip-active');
            if (hidden) hidden.value = minutes || '';
            if (custom) custom.value = '';
            toggleEstimateClearBtn();
        }

        function onCustomEstimateChange(input) {
            const val = parseInt(input.value, 10);
            const hidden = document.getElementById('myDeskEstimatedMinutes');
            const customWrap = input ? input.closest('.estimate-custom') : null;
            document.querySelectorAll('.estimate-chip').forEach(btn => btn.classList.remove('estimate-chip-active'));
            const hasValue = !isNaN(val);
            if (hidden) hidden.value = hasValue ? val : '';
            if (customWrap && hasValue) {
                customWrap.classList.add('estimate-chip-active');
            }
            toggleEstimateClearBtn();
        }

        function setSelectedEstimate(value) {
            const hidden = document.getElementById('myDeskEstimatedMinutes');
            const custom = document.getElementById('myDeskEstimateCustom');
            const customWrap = custom ? custom.closest('.estimate-custom') : null;
            document.querySelectorAll('.estimate-chip').forEach(btn => {
                const mins = parseInt(btn.getAttribute('data-minutes'), 10);
                if (value && mins === Number(value)) btn.classList.add('estimate-chip-active');
                else btn.classList.remove('estimate-chip-active');
            });

            if (hidden) hidden.value = value || '';

            if (custom) {
                if (value && ![15, 30, 60].includes(Number(value))) {
                    custom.value = value;
                    if (customWrap) customWrap.classList.add('estimate-chip-active');
                } else {
                    custom.value = '';
                }
            }
            toggleEstimateClearBtn();
        }

        function clearEstimatedTime() {
            const hidden = document.getElementById('myDeskEstimatedMinutes');
            const custom = document.getElementById('myDeskEstimateCustom');
            document.querySelectorAll('.estimate-chip').forEach(btn => btn.classList.remove('estimate-chip-active'));
            if (hidden) hidden.value = '';
            if (custom) custom.value = '';
            toggleEstimateClearBtn();
        }

        function toggleEstimateClearBtn() {
            const hidden = document.getElementById('myDeskEstimatedMinutes');
            const btn = document.getElementById('estimateClearBtn');
            if (btn && hidden) {
                btn.classList.toggle('hidden', !hidden.value);
            }
        }

        // --- Focus Mode ---
        function startFocus(taskId) {
            const task = appData.myDesk.find(x => x.id === taskId);
            if (!task) return;

            // FIX: Corrected 'app.Data' to 'appData'
            if (appData.focusTaskId && appData.focusTaskId !== taskId) {
                stopFocus(true);
            }

            appData.focusTaskId = taskId;
            appData.focusShowNotes = false;

            // Reset paused state
            delete appData.focusPaused;
            delete appData.focusPausedAt;
            delete appData.focusOriginalEndAt;

            appData.focusEndAt = task.estimatedMinutes
                ? new Date(Date.now() + task.estimatedMinutes * 60000).toISOString()
                : null;

            saveData();
            renderFocusPill();
            initFocusTimer();

            // Start the distraction monitor
            if (typeof startDriftCheck === 'function') {
                startDriftCheck();
            }

            showToast("Focus started", "success");

            // Add pulse effect
            const pill = document.getElementById('focusPill');
            if (pill) pill.classList.add('focus-active-pulse');
        }

        function stopFocus(silent = false) {
            appData.focusTaskId = null;
            appData.focusEndAt = null;
            appData.focusShowNotes = false;

            // Clear paused state
            delete appData.focusPaused;
            delete appData.focusPausedAt;
            delete appData.focusOriginalEndAt;

            saveData();

            const container = document.getElementById('focusPillContainer');
            if (container) container.innerHTML = '';

            if (focusTimer) {
                clearInterval(focusTimer);
                focusTimer = null;
            }
            if (!silent) showToast("Focus ended", "info");

            // Remove pulse effect and exit widget mode
            const pill = document.getElementById('focusPill');
            if (pill) pill.classList.remove('focus-active-pulse');
            document.body.classList.remove('widget-mode');

            // Re-render desk to update buttons
            if (typeof renderMyDesk === 'function') renderMyDesk();
        }

        // Focus mode helpers
        function toggleWidgetMode(btn) {
            document.body.classList.toggle('widget-mode');
            if (document.body.classList.contains('widget-mode')) {
                btn.innerHTML = "";
            } else {
                btn.innerHTML = "";
            }
        }

        function pauseResumeFocus() {
            if (appData.focusPaused) {
                // Resume: restore original end time
                // Handle potential string format from JSON
                const originalEnd = appData.focusOriginalEndAt ? new Date(appData.focusOriginalEndAt) : null;

                if (appData.focusPausedAt && originalEnd && !isNaN(originalEnd.getTime())) {
                    const elapsed = Date.now() - appData.focusPausedAt;
                    appData.focusEndAt = new Date(originalEnd.getTime() + elapsed).toISOString();
                } else {
                    // Fallback if data is missing: just extend current time by remaining duration or default
                    // If we can't calculate exact resume, just unpause.
                    console.warn("Focus resume data missing, unpausing without time adjustment");
                    // If originalEndAt is available but calculation failed, use it as a fallback
                    if (appData.focusOriginalEndAt) {
                        appData.focusEndAt = appData.focusOriginalEndAt;
                    }
                }

                delete appData.focusPaused;
                delete appData.focusPausedAt;
                delete appData.focusOriginalEndAt;

                saveData();
                renderFocusPill(); // Re-render to update status
                initFocusTimer(); // Restart timer
                showToast("Focus resumed", "success");

                // Add pulse effect
                if (pill) pill.classList.add('focus-active-pulse');
            } else {
                // Pause: save current state
                appData.focusPaused = true;
                appData.focusPausedAt = Date.now();
                appData.focusOriginalEndAt = appData.focusEndAt; // Store as string (ISO)

                saveData();
                renderFocusPill(); // Re-render to update status
                updateFocusTimer(); // Update display immediately
                showToast("Focus paused", "info");
            }
        }

        function adjustFocusTime(minutes) {
            if (!appData.focusEndAt) return;

            const currentEnd = new Date(appData.focusEndAt);
            currentEnd.setMinutes(currentEnd.getMinutes() + minutes);
            appData.focusEndAt = currentEnd.toISOString();

            saveData();
            saveData();
            updateFocusTimer(); // Just update the timer display
            showToast(`${minutes > 0 ? '+' : ''}${minutes} minutes`, "info");
        }

        // Draggable focus pill (copied from AI pill)
        function attachFocusDrag() {
            const pill = document.getElementById('focusPill');
            if (!pill) return;

            let isDragging = false;
            let hasMoved = false;
            let startX, startY, initialX, initialY;

            // Load saved position
            const savedPos = localStorage.getItem('focusPillPosition');
            if (savedPos) {
                try {
                    const { top, left, right } = JSON.parse(savedPos);
                    pill.style.top = top;
                    pill.style.left = left || 'auto';
                    pill.style.right = right || 'auto';
                } catch (e) {
                    console.log('Error loading focus pill position');
                }
            }

            function onDragStart(e) {
                const rect = pill.getBoundingClientRect();

                if (e.type === 'mousedown') {
                    startX = e.clientX;
                    startY = e.clientY;
                } else if (e.type === 'touchstart') {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }

                initialX = rect.left;
                initialY = rect.top;

                isDragging = true;
                hasMoved = false;

                pill.style.transition = 'none';
                e.preventDefault();
            }

            function onDrag(e) {
                if (!isDragging) return;

                let currentX, currentY;
                if (e.type === 'mousemove') {
                    currentX = e.clientX;
                    currentY = e.clientY;
                } else if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                }

                const deltaX = currentX - startX;
                const deltaY = currentY - startY;

                if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                    hasMoved = true;
                }

                const newX = initialX + deltaX;
                const newY = initialY + deltaY;

                const maxX = window.innerWidth - pill.offsetWidth;
                const maxY = window.innerHeight - pill.offsetHeight;

                const constrainedX = Math.max(0, Math.min(newX, maxX));
                const constrainedY = Math.max(0, Math.min(newY, maxY));

                pill.style.left = constrainedX + 'px';
                pill.style.right = 'auto';
                pill.style.top = constrainedY + 'px';
                pill.style.bottom = 'auto';
            }

            function onDragEnd() {
                if (!isDragging) return;
                isDragging = false;

                pill.style.transition = 'all 0.3s';

                // Save position
                const top = pill.style.top;
                const left = pill.style.left;
                const right = pill.style.right;

                localStorage.setItem('focusPillPosition', JSON.stringify({
                    top: top !== 'auto' ? top : 'auto',
                    left: left !== 'auto' ? left : 'auto',
                    right: right !== 'auto' ? right : 'auto'
                }));
            }

            // Mouse events
            pill.addEventListener('mousedown', onDragStart);
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', onDragEnd);

            // Touch events
            pill.addEventListener('touchstart', onDragStart, { passive: false });
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('touchend', onDragEnd);

            // Handle click vs drag for actions
            pill.addEventListener('click', (e) => {
                if (hasMoved) {
                    e.stopPropagation();
                    hasMoved = false;
                }
            });
        }

        function toggleFocusNotes() {
            appData.focusShowNotes = !appData.focusShowNotes;
            saveData();
            renderFocusPill();
        }

        function initFocusTimer() {
            if (focusTimer) clearInterval(focusTimer);
            if (!appData.focusTaskId || !appData.focusEndAt) {
                updateFocusTimer();
                return;
            }

            updateFocusTimer(); // Immediate update

            focusTimer = setInterval(() => {
                if (appData.focusPaused) {
                    updateFocusTimer();
                    return;
                }
                updateFocusTimer();
            }, 1000);
        }

        function updateFocusTimer() {
            const timerDisplay = document.getElementById('focusTimerDisplay');
            const pill = document.getElementById('focusPill');

            if (!timerDisplay || !pill) return;
            if (!appData.focusTaskId) return;

            const task = appData.myDesk.find(x => x.id === appData.focusTaskId);
            if (!task) return;

            if (appData.focusPaused) {
                timerDisplay.textContent = 'Paused';
                timerDisplay.classList.remove('text-red-400', 'animate-pulse');
                pill.classList.remove('focus-active-pulse');
                return;
            }

            // Ensure pulse is active if not paused and timer is running
            if (!pill.classList.contains('focus-active-pulse')) {
                pill.classList.add('focus-active-pulse');
            }

            if (!appData.focusEndAt) {
                timerDisplay.textContent = 'No Estimate';
                return;
            }

            const now = Date.now();
            const end = new Date(appData.focusEndAt).getTime();
            const diff = end - now;

            // OVERTIME LOGIC
            if (diff < 0) {
                // Count UP (positive number)
                const overtimeMs = Math.abs(diff);
                timerDisplay.textContent = '+' + formatRemainingTime(overtimeMs);
                timerDisplay.classList.add('text-red-400', 'font-bold', 'animate-pulse');

                // Ring stays full for overtime
                const ring = pill.querySelector('.focus-status-ring');
                if (ring) ring.style.setProperty('--progress', '100%');

                return;
            }

            // NORMAL COUNTDOWN
            timerDisplay.classList.remove('text-red-400', 'font-bold', 'animate-pulse');
            timerDisplay.textContent = formatRemainingTime(diff);

            // Update progress ring
            if (task.estimatedMinutes) {
                const totalMs = task.estimatedMinutes * 60000;
                const progress = Math.max(0, Math.min(1, diff / totalMs));
                const percentage = progress * 100;
                const ring = pill.querySelector('.focus-status-ring');
                if (ring) {
                    ring.style.setProperty('--progress', `${percentage}%`);
                }
            }
        }

        function renderFocusPill() {
            const container = document.getElementById('focusPillContainer');
            if (!container) return;

            if (!appData.focusTaskId) {
                container.innerHTML = '';
                return;
            }

            // Check if pill already exists and matches current task
            const existingPill = document.getElementById('focusPill');
            if (existingPill && existingPill.dataset.taskId === appData.focusTaskId) {
                // Just ensure it's visible and update static info if needed
                updateFocusTimer();
                updateFocusPlayPauseIcon();
                return;
            }

            const task = appData.myDesk.find(x => x.id === appData.focusTaskId);
            if (!task) {
                stopFocus(true);
                container.innerHTML = '';
                return;
            }

            const darkClass = document.body.classList.contains('dark-mode') ? 'dark' : '';

            container.innerHTML = `
                <div class="focus-pill ${darkClass}" id="focusPill" data-task-id="${task.id}">
                    <div class="focus-status-ring">
                        <svg class="focus-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/>
                        </svg>
                    </div>
                    
                    <div class="focus-content">
                        <div class="focus-task-title" title="${task.title}">${task.title}</div>
                        <div class="focus-timer" id="focusTimerDisplay">--:--</div>
                    </div>

                    <div class="focus-actions">
                        <button id="widgetModeBtn" onclick="toggleWidgetMode(this)" class="focus-action-btn" title="Toggle Widget Mode">
                            
                        </button>
                        <button id="focusPauseBtn" onclick="pauseResumeFocus()" class="focus-action-btn" title="Pause/Resume">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="6" y="4" width="4" height="16"></rect>
                                <rect x="14" y="4" width="4" height="16"></rect>
                            </svg>
                        </button>
                        <button onclick="stopFocus()" class="focus-action-btn danger" title="Stop Focus">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            </svg>
                        </button>
                    </div>
                </div>
            `;

            attachFocusDrag();
            updateFocusTimer(); // Initial update
            updateFocusPlayPauseIcon();
        }

        function updateFocusPlayPauseIcon() {
            const btn = document.getElementById('focusPauseBtn');
            if (!btn) return;

            if (appData.focusPaused) {
                // Show Play icon (Resume)
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`;
                btn.title = "Resume";
            } else {
                // Show Pause icon
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`;
                btn.title = "Pause";
            }
        }

        function attachFocusDrag() {
            const pill = document.getElementById('focusPill');
            if (!pill) return;

            let isDragging = false;
            let hasMoved = false;
            let startX, startY, initialX, initialY;

            // Load saved position or default slightly above center-right
            const savedPos = localStorage.getItem('focusPillPosition');
            if (savedPos) {
                try {
                    const { top, left, right } = JSON.parse(savedPos);
                    pill.style.top = top;
                    pill.style.left = left || 'auto';
                    pill.style.right = right || 'auto';
                } catch (e) {
                    pill.style.top = '35vh';
                    pill.style.right = '24px';
                }
            } else {
                pill.style.top = '35vh';
                pill.style.right = '24px';
            }

            function onDragStart(e) {
                const rect = pill.getBoundingClientRect();
                if (e.type === 'mousedown') {
                    startX = e.clientX;
                    startY = e.clientY;
                } else if (e.type === 'touchstart') {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }
                initialX = rect.left;
                initialY = rect.top;
                isDragging = true;
                hasMoved = false;
                pill.style.transition = 'none';
                e.preventDefault();
            }

            function onDrag(e) {
                if (!isDragging) return;
                let currentX, currentY;
                if (e.type === 'mousemove') {
                    currentX = e.clientX;
                    currentY = e.clientY;
                } else {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                }
                const deltaX = currentX - startX;
                const deltaY = currentY - startY;
                if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) hasMoved = true;

                const newX = initialX + deltaX;
                const newY = initialY + deltaY;
                const maxX = window.innerWidth - pill.offsetWidth;
                const maxY = window.innerHeight - pill.offsetHeight;
                const constrainedX = Math.max(0, Math.min(newX, maxX));
                const constrainedY = Math.max(0, Math.min(newY, maxY));

                pill.style.left = constrainedX + 'px';
                pill.style.right = 'auto';
                pill.style.top = constrainedY + 'px';
                pill.style.bottom = 'auto';
            }

            function onDragEnd() {
                if (!isDragging) return;
                isDragging = false;
                pill.style.transition = 'all 0.3s';
                localStorage.setItem('focusPillPosition', JSON.stringify({
                    top: pill.style.top || 'auto',
                    left: pill.style.left || 'auto',
                    right: pill.style.right || 'auto'
                }));
            }

            pill.addEventListener('mousedown', onDragStart);
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', onDragEnd);
            pill.addEventListener('touchstart', onDragStart, { passive: false });
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('touchend', onDragEnd);

            pill.addEventListener('click', (e) => {
                if (hasMoved) {
                    e.stopPropagation();
                    hasMoved = false;
                }
            });
        }

        // --- Pipeline ---
        function calculateAllEvaluations() {
            let evals = [];
            const today = getToday();

            appData.team.filter(t => t.active && t.hireDate).forEach(tm => {
                const hire = new Date(tm.hireDate + 'T12:00:00');
                if (isNaN(hire.getTime())) return;

                // 1. 5th Month Probational
                const month5 = new Date(hire);
                month5.setMonth(hire.getMonth() + 5);
                evals.push(createEvalObj(tm, month5, '5th Month'));

                // 2. Annual Evaluation
                let annual = new Date(hire);
                annual.setFullYear(today.getFullYear());
                // If anniversary already passed this year, next annual is next year
                if (annual < today) annual.setFullYear(today.getFullYear() + 1);
                evals.push(createEvalObj(tm, annual, 'Annual'));

                // 3. Mid-Year Evaluation (For tenure > 1 year)
                // Mid-year is exactly 6 months before the NEXT annual
                const yearsTenure = (today - hire) / (1000 * 60 * 60 * 24 * 365);
                if (yearsTenure >= 0.5) { // Start showing mid-years after 6 months
                    let midYear = new Date(annual);
                    midYear.setMonth(annual.getMonth() - 6);
                    evals.push(createEvalObj(tm, midYear, 'Mid-Year'));
                }
            });
            return evals.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        }

        function createEvalObj(tm, date, type) {
            const dStr = date.toISOString().split('T')[0];
            const id = `${tm.id}_${type}_${dStr}`;
            const prog = appData.evaluations[id] || {};
            const steps = Object.values(prog).filter(Boolean).length;
            const days = getDaysDiff(getToday(), date);

            let status = 'Upcoming';
            if (steps === 4) status = 'Completed';
            else if (days <= 45) status = 'InProgress';

            // Hide conditions
            if (status === 'Upcoming' && days > 120) status = 'Hidden';
            if (status !== 'Completed' && days < -60) status = 'Hidden';

            return { tm, dueDate: dStr, type, days, id, prog, steps, status };
        }

        function renderPipeline() {
            // 1. Get Data & Elements
            const evals = calculateAllEvaluations();
            const colInProgress = document.getElementById('colInProgress');
            const colUpcoming = document.getElementById('colUpcoming');
            const colCompleted = document.getElementById('colCompleted');

            if (!colInProgress || !colUpcoming || !colCompleted) return;

            // 2. Clear Columns
            colInProgress.innerHTML = '';
            colUpcoming.innerHTML = '';
            colCompleted.innerHTML = '';

            // 3. Create Buckets (Split the data first)
            // This allows us to reset the animation index (0, 1, 2...) for EACH column separately.
            // 'evals' is already sorted by date, so these buckets remain sorted.
            const listInProgress = evals.filter(ev => ev.status === 'InProgress');
            const listUpcoming = evals.filter(ev => ev.status === 'Upcoming');
            const listCompleted = evals.filter(ev => ev.status === 'Completed' && Math.abs(ev.days) < 45);

            // 4. Render 'Upcoming' (Starts at index 0 -> Instant)
            if (listUpcoming.length === 0) {
                colUpcoming.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">Nothing here.</div>`;
            } else {
                listUpcoming.forEach((ev, index) => {
                    // Pass the local 'index' so animation starts at 0ms
                    colUpcoming.innerHTML += createEvalCard(ev, index);
                });
            }

            // 5. Render 'In Progress' (Starts at index 0 -> Instant)
            if (listInProgress.length === 0) {
                colInProgress.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">Nothing here.</div>`;
            } else {
                listInProgress.forEach((ev, index) => {
                    colInProgress.innerHTML += createEvalCard(ev, index);
                });
            }

            // 6. Render 'Completed' (Starts at index 0 -> Instant)
            if (listCompleted.length === 0) {
                colCompleted.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm">Nothing here.</div>`;
            } else {
                listCompleted.forEach((ev, index) => {
                    colCompleted.innerHTML += createEvalCard(ev, index);
                });
            }

            // 7. Re-initialize Spotlight effect
            setTimeout(initSpotlight, 100);
        }

        function createEvalCard(ev, index) {
            const progress = (ev.steps / 4) * 100;
            const steps = [1, 2, 3, 4].map(i => `
            <label class="eval-step">
                <input type="checkbox" ${ev.prog['step' + i] ? 'checked' : ''} 
                       class="form-checkbox h-4 w-4 text-hub-600 rounded"
                       onchange="toggleEvalStep(event, '${ev.id}', 'step${i}')"
                       onclick="event.stopPropagation();">
                <span class="text-xs ml-2 ${ev.prog['step' + i] ? 'line-through text-slate-400' : 'text-slate-700'}">${getStepLabel(i)}</span>
            </label>`).join('');

            const typeColor = ev.type === '5th Month' ? 'text-yellow-700 dark:text-yellow-300 bg-yellow-100 dark:bg-yellow-900/30' : (ev.type === 'Mid-Year' ? 'text-blue-700 dark:text-blue-300 bg-blue-100 dark:bg-blue-900/30' : 'text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30');

            const deskBtn = `<button onclick="addToMyDeskFromEval('${ev.id}')" class="ml-2 text-hub-600 hover:text-hub-800 p-1 rounded hover:bg-hub-50 dark:hover:bg-hub-900/30" title="Add to My Desk">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
        </button>`;

            // STAGGER APPLIED HERE
            return `
            <div class="stagger-item bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-4 transition-all hover:shadow-md hover:border-dcx-blue group ${ev.status === 'InProgress' ? 'ring-1 ring-hub-500/20' : ''}" style="animation-delay: ${index * 30}ms">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-bold text-slate-800 group-hover:text-dcx-blue transition-colors">${ev.tm.name}</h4>
                        <p class="text-sm text-slate-500">${ev.tm.role}</p>
                    </div>
                    <div class="flex items-center">
                        <span class="text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap ${typeColor}">${ev.type}</span>
                        ${deskBtn}
                    </div>
                </div>
                <p class="text-xs ${ev.days < 0 ? 'text-red-600' : 'text-slate-500'} mt-2 mb-3 font-medium">Due: ${formatDateShort(ev.dueDate)} (${ev.days} days)</p>
                <div class="w-full bg-slate-200 h-2 rounded-full mb-3"><div class="bg-hub-500 h-2 rounded-full transition-all duration-300" style="width:${progress}%"></div></div>
                ${steps}
            </div>`;
        }

        function getStepLabel(i) { return ['Ask feedback', 'Received feedback', 'Discussed w/ TM', 'TM Acknowledged'][i - 1]; }

        function toggleEvalStep(e, id, step) {
            e.stopPropagation();

            // Find the checkbox - it's the event target when clicking directly, or we find it
            let checkbox = null;
            if (e.target.type === 'checkbox') {
                checkbox = e.target;
            } else {
                const evalStepLabel = e.target.closest('.eval-step');
                if (evalStepLabel) {
                    checkbox = evalStepLabel.querySelector('input[type="checkbox"]');
                }
            }

            if (!checkbox) {
                // Fallback: if we can't find the checkbox, do a full re-render
                if (!appData.evaluations[id]) appData.evaluations[id] = {};
                appData.evaluations[id][step] = !appData.evaluations[id][step];
                saveData();
                return;
            }

            // Don't prevent default - let the checkbox toggle naturally
            // Update data to match the checkbox state (it's already toggled by browser)
            if (!appData.evaluations[id]) appData.evaluations[id] = {};
            appData.evaluations[id][step] = checkbox.checked;

            // Find the eval-step label that contains this step
            const evalStepLabel = checkbox.closest('.eval-step');
            if (!evalStepLabel) {
                saveData();
                return;
            }

            // Find the card element (closest parent card)
            const cardElement = checkbox.closest('.stagger-item');
            if (!cardElement) {
                // Fallback: if we can't find the card, do a full re-render
                saveData();
                return;
            }

            // Update step label styling (span is sibling of checkbox)
            const stepLabel = evalStepLabel.querySelector('span');
            if (stepLabel) {
                if (checkbox.checked) {
                    stepLabel.classList.add('line-through', 'text-slate-400');
                    stepLabel.classList.remove('text-slate-700');
                } else {
                    stepLabel.classList.remove('line-through', 'text-slate-400');
                    stepLabel.classList.add('text-slate-700');
                }
            }

            // Recalculate progress for this evaluation
            const prog = appData.evaluations[id] || {};
            const completedSteps = Object.values(prog).filter(Boolean).length;
            const progress = (completedSteps / 4) * 100;

            // Update progress bar
            const progressBar = cardElement.querySelector('.bg-hub-500');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }

            // Save data without triggering full re-render
            saveData(true); // Pass true to skip render

            // Check if we need to move the card to a different column
            const ev = calculateAllEvaluations().find(e => e.id === id);
            if (!ev) return;

            // Determine which column the card should be in based on status
            const colInProgress = document.getElementById('colInProgress');
            const colUpcoming = document.getElementById('colUpcoming');
            const colCompleted = document.getElementById('colCompleted');

            if (!colInProgress || !colUpcoming || !colCompleted) return;

            // Find which column the card is currently in
            const currentColumn = cardElement.parentElement;
            let targetColumn = null;
            let shouldMove = false;

            if (ev.status === 'Completed' && currentColumn !== colCompleted) {
                targetColumn = colCompleted;
                shouldMove = true;
            } else if (ev.status === 'InProgress' && currentColumn !== colInProgress) {
                targetColumn = colInProgress;
                shouldMove = true;
            } else if (ev.status === 'Upcoming' && currentColumn !== colUpcoming) {
                targetColumn = colUpcoming;
                shouldMove = true;
            }

            if (shouldMove && targetColumn) {
                // Remove card from current column
                cardElement.remove();

                // Handle empty column message
                if (currentColumn === colInProgress && colInProgress.children.length === 0) {
                    colInProgress.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">Nothing here.</div>';
                } else if (currentColumn === colUpcoming && colUpcoming.children.length === 0) {
                    colUpcoming.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">Nothing here.</div>';
                } else if (currentColumn === colCompleted && colCompleted.children.length === 0) {
                    colCompleted.innerHTML = '<div class="text-center py-8 text-slate-400 text-sm">Nothing here.</div>';
                }

                // Remove empty message from target column if it exists
                const emptyMsg = targetColumn.querySelector('.text-center');
                if (emptyMsg && emptyMsg.textContent.includes('Nothing here')) {
                    emptyMsg.remove();
                }

                // Get all evaluations for the target column to find correct position
                const allEvals = calculateAllEvaluations();
                const targetEvals = allEvals.filter(e => {
                    if (targetColumn === colCompleted) return e.status === 'Completed' && Math.abs(e.days) < 45;
                    if (targetColumn === colInProgress) return e.status === 'InProgress';
                    if (targetColumn === colUpcoming) return e.status === 'Upcoming';
                    return false;
                }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                // Find position in sorted list
                const evIndex = targetEvals.findIndex(e => e.id === id);
                const targetCards = Array.from(targetColumn.querySelectorAll('.stagger-item'));

                if (evIndex === 0 || targetCards.length === 0) {
                    // Insert at the beginning
                    targetColumn.insertBefore(cardElement, targetColumn.firstChild);
                } else if (evIndex === targetEvals.length - 1 || evIndex === -1) {
                    // Insert at the end
                    targetColumn.appendChild(cardElement);
                } else {
                    // Insert in the middle - find the card that should come after this one
                    const nextEval = targetEvals[evIndex + 1];
                    if (nextEval) {
                        const nextCard = targetCards.find(card => {
                            const cardNameEl = card.querySelector('h4');
                            const cardTypeEl = card.querySelector('.rounded-full');
                            const cardName = cardNameEl ? cardNameEl.textContent : '';
                            const cardType = cardTypeEl ? cardTypeEl.textContent.trim() : '';
                            return cardName === nextEval.tm.name && cardType === nextEval.type;
                        });

                        if (nextCard) {
                            targetColumn.insertBefore(cardElement, nextCard);
                        } else {
                            targetColumn.appendChild(cardElement);
                        }
                    } else {
                        targetColumn.appendChild(cardElement);
                    }
                }
            }
        }

        function addToMyDeskFromEval(evalId) {
            const ev = calculateAllEvaluations().find(e => e.id === evalId);
            if (!ev) return;

            if (appData.myDesk.some(t => t.sourceId === evalId)) {
                showToast("Task already exists in My Desk.", "info");
                return;
            }

            appData.myDesk.push({
                id: 'desk_' + Date.now(),
                title: `${ev.type} Evaluation: ${ev.tm.name}`,
                dueDate: ev.dueDate,
                category: 'Evaluation',
                status: 'OnTheTable',
                notes: `Process ${ev.type} evaluation steps.`,
                sourceId: evalId
            });
            saveData();
            renderMyDesk(); // Update view if needed
            showToast("Added to My Desk!", "success");
        }

        // --- Logbook ---
        function setLogbookFilter(f) { currentLogbookFilter = f; renderLogbook(); }

        // ==========================================
        // NEW: UNIFIED LOGBOOK FILTERING LOGIC
        // ==========================================

        function resetLogFilters() {
            document.getElementById('lbSearch').value = '';
            document.getElementById('lbFilterTm').value = 'all';
            document.getElementById('lbFilterType').value = 'all';
            document.getElementById('lbFilterStatus').value = 'all';
            renderLogbook();
        }

        function renderLogbook() {
            const list = document.getElementById('logbookEntryList');
            const countLabel = document.getElementById('logbookCount');

            // 1. Populate TM Dropdown (Only if empty, to preserve selection)
            const tmSelect = document.getElementById('lbFilterTm');
            if (tmSelect.options.length === 1) {
                appData.team.filter(t => t.active).sort((a, b) => a.name.localeCompare(b.name)).forEach(tm => {
                    const opt = document.createElement('option');
                    opt.value = tm.id;
                    opt.textContent = tm.name;
                    tmSelect.appendChild(opt);
                });
            }

            // 2. Get Filter Values
            const search = document.getElementById('lbSearch').value.toLowerCase();
            const fTm = document.getElementById('lbFilterTm').value;
            const fType = document.getElementById('lbFilterType').value;
            const fStatus = document.getElementById('lbFilterStatus').value;

            // 3. Create Team Member Cache for Performance
            const teamMap = new Map(appData.team.map(t => [t.id, t]));

            // 3. Filter Data (Additive Logic)
            let entries = appData.logbook.filter(e => {
                const tm = teamMap.get(e.tmId) || { name: '' };

                // Search Text (Matches Title, Notes, or TM Name)
                const matchesSearch = !search ||
                    e.title.toLowerCase().includes(search) ||
                    e.notes.toLowerCase().includes(search) ||
                    tm.name.toLowerCase().includes(search);

                // Match Team Member
                const matchesTm = fTm === 'all' || e.tmId == fTm;

                // Match Type (Updated for 'actionable')
                let matchesType = true;
                if (fType === 'actionable') matchesType = (e.type === 'issue' || e.type === 'request');
                else if (fType !== 'all') matchesType = (e.type === fType);

                // Match Status
                // Normalize "Open" (Open/NotUploaded) and "Closed" (Closed/Uploaded)
                let eStatusGroup = (e.status === 'Open' || e.status === 'NotUploaded') ? 'Open' : 'Closed';
                const matchesStatus = fStatus === 'all' || eStatusGroup === fStatus;

                return matchesSearch && matchesTm && matchesType && matchesStatus;
            });

            // 4. Smart Sort
            // IF looking at OPEN items -> Sort by Due Date (Ascending/Urgent First)
            // ELSE -> Sort by Date Created (Descending/Newest First)
            if (fStatus === 'Open') {
                entries.sort((a, b) => {
                    // If no due date, push to bottom
                    if (!a.dueDate) return 1;
                    if (!b.dueDate) return -1;
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });
            } else {
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            // 5. Update Count
            countLabel.textContent = `${entries.length} entries`;

            // 6. Render List
            // 6. Render List (Timeline View)
            list.innerHTML = '';
            if (entries.length === 0) {
                list.innerHTML = `
            <div class="text-center py-16 bg-slate-50 dark:bg-slate-800/50 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700">
                <p class="text-slate-400 dark:text-slate-500 font-medium">No entries match your filters.</p>
                <button onclick="resetLogFilters()" class="text-hub-600 dark:text-hub-400 text-sm font-bold mt-2 hover:underline">Clear filters</button>
            </div>`;
                return;
            }

            // Helper to get timeline label
            const getTimelineLabel = (dateStr) => {
                const date = new Date(dateStr + 'T12:00:00');
                const today = getToday();
                const diff = getDaysDiff(today, date);

                if (diff === 0) return 'Today';
                if (diff === -1) return 'Yesterday';
                if (diff > -7 && diff < 0) return 'This Week';
                if (diff >= -30 && diff <= -7) return 'This Month';
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            };

            // 7. Build HTML efficiently (single DOM update)
            let html = '';
            let currentLabel = '';

            entries.forEach((e, index) => {
                const tm = teamMap.get(e.tmId) || { name: 'Unknown' };
                const isOpen = e.status === 'Open' || e.status === 'NotUploaded';

                // Timeline Header Logic
                const label = getTimelineLabel(e.date);
                if (label !== currentLabel) {
                    currentLabel = label;
                    html += `<div class="sticky top-0 z-10 bg-slate-50/95 dark:bg-[#0e1015]/95 backdrop-blur-sm py-2 px-1 mb-2 mt-4 border-b border-slate-200 dark:border-slate-800 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">${label}</div>`;
                }

                // Premium Card Styles
                let badgeClass = 'bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400';
                let icon = '';
                let borderClass = 'border-l-4 border-slate-300 dark:border-slate-600'; // Default Note

                if (e.type === 'issue') {
                    badgeClass = 'bg-red-50 text-red-700 border-red-100 dark:bg-red-900/30 dark:text-red-400 dark:border-red-900/50';
                    icon = '';
                }
                if (e.type === 'request') {
                    badgeClass = 'bg-blue-50 text-blue-700 border-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-900/50';
                    icon = '';
                }
                if (e.type === 'kudos') {
                    badgeClass = 'bg-green-50 text-green-700 border-green-100 dark:bg-green-900/30 dark:text-green-400 dark:border-green-900/50';
                    icon = '';
                }

                const deskBtn = (isOpen && (e.type === 'issue' || e.type === 'request')) ?
                    `<button onclick="addToMyDeskFromLog('${e.id}')" class="text-slate-400 hover:text-hub-600 dark:hover:text-hub-400 p-1 transition-colors" title="Add to My Desk"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg></button>` : '';

                const capBtn = `<button onclick="addToCapacityFromLog('${e.id}')" class="text-slate-400 hover:text-purple-600 p-1 transition-colors" title="Add to Calendar"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></button>`;

                const selectBox = logbookSelectionMode ? `<input type="checkbox" onchange="toggleLogSelect('${e.id}')" ${selectedLogEntries.includes(e.id) ? 'checked' : ''} class="mt-1 mr-3 h-5 w-5 text-hub-600 rounded cursor-pointer">` : '';

                let dueHtml = '';
                if (e.dueDate && isOpen) {
                    const days = getDaysDiff(getToday(), new Date(e.dueDate + 'T12:00:00'));
                    const absDays = Math.abs(days);
                    const plural = absDays === 1 ? 'day' : 'days';

                    let color = 'text-slate-500 dark:text-slate-400';
                    let text = `Due in ${days} ${plural}`;

                    if (days < 0) {
                        color = 'text-red-600 dark:text-red-400 font-bold';
                        text = `Overdue by ${absDays} ${plural}`;
                    } else if (days === 0) {
                        color = 'text-orange-600 dark:text-orange-400 font-bold';
                        text = 'Due Today';
                    } else if (days <= 7) {
                        color = 'text-orange-600 dark:text-orange-400 font-bold';
                    }

                    const dateDisplay = formatDateShort(e.dueDate);
                    dueHtml = `<span class="text-xs ${color} ml-3 font-medium flex items-center bg-slate-50 dark:bg-slate-800 px-2 py-0.5 rounded border border-slate-100 dark:border-slate-700 whitespace-nowrap">Due: ${dateDisplay}  ${text}</span>`;
                }

                // Parse Notes for Mentions (Simple Implementation)
                let parsedNotes = e.notes.replace(/@(\w+)/g, '<span class="text-hub-600 dark:text-hub-400 font-bold">@$1</span>');

                html += `
            <div class="stagger-item group relative bg-white dark:bg-slate-800/50 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5 mb-3 hover:shadow-md transition-all ${borderClass}" style="animation-delay: ${index * 30}ms">
                <div class="flex items-start">
                    ${selectBox}
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center flex-wrap gap-2">
                                <span class="text-[10px] font-bold uppercase px-2 py-1 rounded-full ${badgeClass} flex items-center border border-black/5 dark:border-white/5 tracking-wide">
                                    <span class="mr-1.5 text-sm">${icon}</span> ${e.type}
                                </span>
                                <span class="font-bold text-slate-700 dark:text-slate-200 text-sm">${tm.name}</span>
                                <span class="text-xs text-slate-400 dark:text-slate-500"> ${formatDateShort(e.date)}</span>
                                ${dueHtml}
                            </div>
                            <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                ${capBtn}${deskBtn}
                                <button onclick="toggleLogStatus('${e.id}')" class="text-xs font-bold px-3 py-1 rounded-full border transition-colors ${isOpen ? 'text-red-600 border-red-200 hover:bg-red-50 dark:text-red-400 dark:border-red-900/50 dark:hover:bg-red-900/20' : 'text-green-600 border-green-200 hover:bg-green-50 dark:text-green-400 dark:border-green-900/50 dark:hover:bg-green-900/20'}">
                                    ${isOpen ? 'Mark Done' : 'Re-open'}
                                </button>
                            </div>
                        </div>

                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-100">${e.title}</h3>
                        <p class="text-slate-600 dark:text-slate-400 mt-2 whitespace-pre-wrap text-sm leading-relaxed">${parsedNotes}</p>

                        <div class="mt-4 pt-3 border-t border-slate-50 dark:border-slate-700/50 flex justify-end">
                            <button onclick="openLogbookModal('${e.id}')" class="text-xs font-bold text-slate-400 hover:text-hub-600 dark:hover:text-hub-400 flex items-center transition-colors">
                                Edit Entry
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            });

            // Set innerHTML once for maximum performance
            list.innerHTML = html;
            setTimeout(initSpotlight, 100);
        }

        function addToMyDeskFromLog(logId) {
            const entry = appData.logbook.find(e => e.id === logId);
            if (!entry) return;

            if (appData.myDesk.some(t => t.sourceId === logId)) {
                showToast("Task already exists in My Desk.", "info");
                return;
            }
            const tm = appData.team.find(t => t.id === entry.tmId) || { name: 'Unknown' };
            const deskTask = {
                id: 'desk_' + Date.now(),
                title: `${entry.type.toUpperCase()}: ${entry.title}`,
                category: 'Logbook',
                status: 'OnTheTable',
                notes: `TM: ${tm.name}\n\n${entry.notes}`,
                sourceId: logId
            };
            // Copy single date (convert range to single if needed)
            if (entry.dueDateStart && entry.dueDateEnd) {
                deskTask.dueDate = entry.dueDateEnd || getTodayShort(); // Use end date from range
            } else {
                deskTask.dueDate = entry.dueDate || getTodayShort();
            }
            appData.myDesk.push(deskTask);
            saveData();
            renderMyDesk();
            showToast("Added to My Desk (Priority)!", "success");
        }

        function toggleLogbookSelectionMode() {
            logbookSelectionMode = !logbookSelectionMode;
            selectedLogEntries = [];
            document.getElementById('logbookSelectBtn').textContent = logbookSelectionMode ? 'Cancel' : 'Select for Archive';
            document.getElementById('logbookBulkDeleteControls').classList.toggle('hidden', !logbookSelectionMode);
            renderLogbook();
        }

        function toggleLogSelect(id) {
            if (selectedLogEntries.includes(id)) selectedLogEntries = selectedLogEntries.filter(x => x !== id);
            else selectedLogEntries.push(id);
            document.getElementById('logbookSelectedCount').textContent = selectedLogEntries.length + " selected";
        }

        function deleteSelectedLogEntries() {
            if (confirm("Delete selected entries?")) {
                appData.logbook = appData.logbook.filter(e => !selectedLogEntries.includes(e.id));
                saveData(); toggleLogbookSelectionMode();
                showToast("Selected entries deleted", "success");
            }
        }

        function toggleLogStatus(id) {
            const e = appData.logbook.find(x => x.id === id);
            if (e) {
                if (e.type === 'kudos') e.status = e.status === 'Uploaded' ? 'NotUploaded' : 'Uploaded';
                else e.status = e.status === 'Open' ? 'Closed' : 'Open';
                saveData();
                renderLogbook(); // REFRESH LOGBOOK
            }
        }

        // ==========================================
        // CUSTOM FUZZY SEARCH LOGIC
        // ==========================================

        function renderLogbookDropdown() {
            const input = document.getElementById('logbookTmSearch');
            const list = document.getElementById('logbookTmDropdownList');
            const hiddenId = document.getElementById('logbookTmSelect');
            const query = input.value.toLowerCase();

            list.innerHTML = '';
            list.classList.remove('hidden');

            // Fuzzy Filter: Matches Name OR Account OR Role
            const matches = appData.team.filter(t =>
                t.active && (
                    t.name.toLowerCase().includes(query) ||
                    t.role.toLowerCase().includes(query) ||
                    t.account.toLowerCase().includes(query)
                )
            ).sort((a, b) => a.name.localeCompare(b.name));

            if (matches.length === 0) {
                list.innerHTML = `<div class="p-3 text-sm text-slate-400 italic">No matches found.</div>`;
            } else {
                matches.forEach(tm => {
                    const div = document.createElement('div');
                    div.className = "p-3 hover:bg-hub-50 cursor-pointer border-b border-slate-50 last:border-0 transition-colors";
                    div.innerHTML = `
                    <div class="font-bold text-slate-700 text-sm">${tm.name}</div>
                    <div class="text-xs text-slate-400">${tm.role}  ${tm.account}</div>
                `;
                    div.onclick = () => selectLogbookTm(tm.id, tm.name);
                    list.appendChild(div);
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function closeDrop(e) {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.classList.add('hidden');
                    document.removeEventListener('click', closeDrop);
                }
            });
        }

        function selectLogbookTm(id, name) {
            document.getElementById('logbookTmSearch').value = name; // Show Name
            document.getElementById('logbookTmSelect').value = id;   // Store ID
            document.getElementById('logbookTmDropdownList').classList.add('hidden');
        }

        // --- Logbook Date Helpers ---
        function updateLogbookDateDisplay(input) {
            const inputId = input.id;

            if (inputId === 'logbookDueDate' || inputId === 'logbookDate') {
                const container = input.parentElement;
                if (!container) return;
                const emptyState = container.querySelector('.logbook-date-empty');
                const filledState = container.querySelector('.logbook-date-filled');
                const textSpan = container.querySelector('.logbook-date-text');

                if (input.value) {
                    emptyState.classList.add('hidden');
                    filledState.classList.remove('hidden');
                    // Format date: "Oct 24"
                    const d = new Date(input.value + 'T12:00:00');
                    const m = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    textSpan.textContent = m;
                } else {
                    emptyState.classList.remove('hidden');
                    filledState.classList.add('hidden');
                    textSpan.textContent = '';
                }
            }
        }

        function clearLogbookDate(e, inputId) {
            e.stopPropagation();
            const input = document.getElementById(inputId);
            input.value = '';
            updateLogbookDateDisplay(input);
        }


        // --- Broadcast Date Helpers ---
        function updateBroadcastDateDisplay(input) {
            const inputId = input.id;

            if (inputId === 'broadcastDueDate') {
                const container = input.parentElement;
                if (!container) return;
                const emptyState = container.querySelector('#broadcastDateEmpty');
                const filledState = container.querySelector('#broadcastDateFilled');
                const textSpan = container.querySelector('#broadcastDateText');

                // Check for range dates
                const rangeStart = input.getAttribute('data-range-start');
                const rangeEnd = input.getAttribute('data-range-end');

                if (rangeStart && rangeEnd) {
                    // Range date: use formatDateRange
                    emptyState.classList.add('hidden');
                    filledState.classList.remove('hidden');
                    textSpan.textContent = formatDateRange(rangeStart, rangeEnd);
                } else if (input.value) {
                    // Single date: format as before
                    emptyState.classList.add('hidden');
                    filledState.classList.remove('hidden');
                    const d = new Date(input.value + 'T12:00:00');
                    const m = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    textSpan.textContent = m;
                } else {
                    emptyState.classList.remove('hidden');
                    filledState.classList.add('hidden');
                    textSpan.textContent = '';
                }
            }
        }

        function clearBroadcastDate(e, inputId) {
            e.stopPropagation();
            const id = inputId || 'broadcastDueDate';
            const input = document.getElementById(id);
            if (input) {
                input.value = '';
                input.removeAttribute('data-range-start');
                input.removeAttribute('data-range-end');
                updateBroadcastDateDisplay(input);
            }
        }

        // --- Project Date Helpers ---
        function updateProjectDateDisplay(input) {
            const inputId = input.id;

            if (inputId === 'newProjDue') {
                const container = input.parentElement;
                if (!container) return;
                const emptyState = container.querySelector('#projectDateEmpty');
                const filledState = container.querySelector('#projectDateFilled');
                const textSpan = container.querySelector('#projectDateText');

                // Check for range dates
                const rangeStart = input.getAttribute('data-range-start');
                const rangeEnd = input.getAttribute('data-range-end');

                if (rangeStart && rangeEnd) {
                    // Range date: use formatDateRange
                    emptyState.classList.add('hidden');
                    filledState.classList.remove('hidden');
                    textSpan.textContent = formatDateRange(rangeStart, rangeEnd);
                } else if (input.value) {
                    // Single date: format as before
                    emptyState.classList.add('hidden');
                    filledState.classList.remove('hidden');
                    const d = new Date(input.value + 'T12:00:00');
                    const m = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    textSpan.textContent = m;
                } else {
                    emptyState.classList.remove('hidden');
                    filledState.classList.add('hidden');
                    textSpan.textContent = '';
                }
            }
        }

        function clearProjectDate(e, inputId) {
            e.stopPropagation();
            const id = inputId || 'newProjDue';
            const input = document.getElementById(id);
            if (input) {
                input.value = '';
                input.removeAttribute('data-range-start');
                input.removeAttribute('data-range-end');
                updateProjectDateDisplay(input);
            }
        }


        function openLogbookModal(id = null) {
            document.getElementById('logbookForm').reset();

            // Reset Custom Dropdown
            document.getElementById('logbookTmSearch').value = '';
            document.getElementById('logbookTmSelect').value = '';
            document.getElementById('logbookTmDropdownList').classList.add('hidden');

            document.getElementById('logbookEntryId').value = '';
            // Default to today's date
            const today = new Date();
            const todayStr = today.getFullYear() + '-' +
                String(today.getMonth() + 1).padStart(2, '0') + '-' +
                String(today.getDate()).padStart(2, '0');
            document.getElementById('logbookDate').value = todayStr;
            updateLogbookDateDisplay(document.getElementById('logbookDate'));
            
            // Clear due date when opening a new modal
            const dueDateInput = document.getElementById('logbookDueDate');
            dueDateInput.value = '';
            dueDateInput.removeAttribute('data-range-start');
            dueDateInput.removeAttribute('data-range-end');
            updateLogbookDateDisplay(dueDateInput);
            
            // Update due date field visibility based on selected type (if any)
            const selectedType = document.querySelector('input[name="logbookType"]:checked');
            if (selectedType) {
                toggleDueDateField();
            }
            
            document.getElementById('deleteLogEntryBtn').style.display = 'none';

            if (id) {
                const e = appData.logbook.find(x => x.id === id);
                if (e) {
                    document.getElementById('logbookEntryId').value = e.id;

                    // --- NEW: Set the Search Box values based on ID ---
                    const tm = appData.team.find(t => t.id === e.tmId);
                    if (tm) {
                        document.getElementById('logbookTmSearch').value = tm.name;
                        document.getElementById('logbookTmSelect').value = tm.id;
                    }
                    // -------------------------------------------------

                    document.getElementById('logbookDate').value = e.date;
                    updateLogbookDateDisplay(document.getElementById('logbookDate'));
                    document.getElementById('logbookTitle').value = e.title;
                    document.getElementById('logbookNotes').value = e.notes;

                    const r = document.querySelector(`input[name="logbookType"][value="${e.type}"]`);
                    if (r) r.checked = true;

                    toggleDueDateField();
                    // Convert range dates to single date if they exist (use end date)
                    const dueDateInput = document.getElementById('logbookDueDate');
                    if (e.dueDateStart && e.dueDateEnd) {
                        // Convert range to single date (use end date)
                        const endDate = e.dueDateEnd;
                        dueDateInput.value = endDate || '';
                        // Clean up range data
                        delete e.dueDateStart;
                        delete e.dueDateEnd;
                        e.dueDate = endDate || '';
                    } else {
                        dueDateInput.value = e.dueDate || '';
                    }
                    dueDateInput.removeAttribute('data-range-start');
                    dueDateInput.removeAttribute('data-range-end');
                    updateLogbookDateDisplay(dueDateInput);

                    document.getElementById('deleteLogEntryBtn').style.display = 'block';
                }
            }
            toggleModal('logbookModal');
        }

        function toggleDueDateField() {
            const type = document.querySelector('input[name="logbookType"]:checked').value;
            const hide = (type === 'kudos' || type === 'note');
            document.getElementById('logbookDueDateContainer').classList.toggle('hidden', hide);
        }

        function saveLogbookEntry(e) {
            e.preventDefault();

            // --- NEW: Validation for Custom Dropdown ---
            const tmIdVal = document.getElementById('logbookTmSelect').value;
            if (!tmIdVal) {
                showToast('Please select a Team Member from the list.', 'error');
                return;
            }
            // -------------------------------------------

            const id = document.getElementById('logbookEntryId').value;
            const typeRadio = document.querySelector('input[name="logbookType"]:checked');

            if (!typeRadio) {
                showToast('Please select an Entry Type.', 'error');
                return;
            }

            const dueDateInput = document.getElementById('logbookDueDate');
            const dueDate = dueDateInput.value || '';

            const entry = {
                id: id || 'log_' + Date.now(),
                tmId: parseInt(tmIdVal), // Use the captured ID
                date: document.getElementById('logbookDate').value,
                title: document.getElementById('logbookTitle').value,
                type: typeRadio.value,
                notes: document.getElementById('logbookNotes').value,
                dueDate: dueDate,
                status: 'Open' // Default
            };

            if (entry.type === 'kudos') entry.status = 'NotUploaded';

            if (id) {
                const idx = appData.logbook.findIndex(x => x.id === id);
                if (idx > -1) appData.logbook[idx] = { ...appData.logbook[idx], ...entry };
            } else {
                appData.logbook.push(entry);
            }
            saveData(); toggleModal('logbookModal');
            renderLogbook(); // REFRESH LOGBOOK
            showToast("Log entry saved", "success");
        }

        function deleteLogbookEntry() {
            const id = document.getElementById('logbookEntryId').value;
            if (id && confirm("Delete this entry?")) {
                appData.logbook = appData.logbook.filter(x => x.id !== id);
                saveData(); toggleModal('logbookModal');
                renderLogbook(); // REFRESH LOGBOOK
                showToast("Log entry deleted", "success");
            }
        }

        // --- Broadcasts ---
        function renderBroadcast() {
            const list = document.getElementById('broadcastList');
            if (!list) return;
            list.innerHTML = '';

            // 1. Populate Category Filter (Only if empty)
            const catSelect = document.getElementById('broadcastCategoryFilter');
            if (catSelect.options.length === 1) {
                const categories = [...new Set(appData.broadcasts.map(b => b.category).filter(Boolean))].sort();
                categories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.textContent = cat;
                    catSelect.appendChild(opt);
                });
            }

            // 2. Get Filter Values
            const search = document.getElementById('broadcastSearch').value.toLowerCase();
            const catFilter = document.getElementById('broadcastCategoryFilter').value;
            const statusFilter = document.getElementById('broadcastStatusFilter').value;

            // 3. Filter Items (Smart Search + Filters)
            let items = appData.broadcasts.filter(b => {
                // Smart Search (Title + Content)
                const matchesSearch = !search ||
                    b.title.toLowerCase().includes(search) ||
                    b.notes.toLowerCase().includes(search);

                // Category Filter
                const matchesCategory = catFilter === 'all' || b.category === catFilter;

                // Status Filter
                const matchesStatus = statusFilter === 'all' || b.status === statusFilter;

                return matchesSearch && matchesCategory && matchesStatus;
            });

            items.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (items.length === 0) {
                list.innerHTML = `
        <div class="col-span-full flex flex-col items-center justify-center py-16 text-center bg-white rounded-xl border border-dashed border-slate-300">
            <div class="bg-purple-50 p-4 rounded-full mb-4 ring-4 ring-purple-50/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-hub-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
                </svg>
            </div>
            <h3 class="text-lg font-bold text-slate-800">All Quiet on the Floor</h3>
            <p class="text-slate-500 max-w-sm mx-auto mt-2 text-sm mb-6">
                No active broadcasts right now. Create a new announcement to keep your team aligned on updates and programs.
            </p>
            <button onclick="openBroadcastModal()" class="flex items-center gap-2 bg-hub-600 hover:bg-hub-700 text-white px-5 py-2.5 rounded-lg font-bold transition-all shadow-sm hover:shadow-md hover:-translate-y-0.5">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                New Broadcast
            </button>
        </div>`;
                return;
            }

            // STAGGER APPLIED HERE
            items.forEach((b, index) => {
                const ackCount = Object.values(b.ack || {}).filter(Boolean).length;
                const total = appData.team.filter(t => t.active).length;
                const pct = total > 0 ? (ackCount / total) * 100 : 0;
                const isComp = pct === 100 || b.status === 'Completed';

                let dueHtml = '';
                if ((b.dueDateStart && b.dueDateEnd) || b.dueDate) {
                    let dueDateStr = '';
                    let days = 0;

                    if (b.dueDateStart && b.dueDateEnd) {
                        // Range date: use end date for calculation
                        dueDateStr = formatDateRange(b.dueDateStart, b.dueDateEnd);
                        days = getDaysDiff(getToday(), new Date(b.dueDateEnd + 'T12:00:00'));
                    } else if (b.dueDate) {
                        // Single date
                        dueDateStr = formatDateShort(b.dueDate);
                        days = getDaysDiff(getToday(), new Date(b.dueDate + 'T12:00:00'));
                    }

                    if (!isComp && dueDateStr) {
                        const absDays = Math.abs(days);
                        const plural = absDays === 1 ? 'day' : 'days';
                        let color = 'text-slate-500';
                        let text = `Due in ${days} ${plural}`;
                        if (days < 0) { color = 'text-red-600 font-bold'; text = `Overdue by ${absDays} ${plural}`; }
                        else if (days === 0) { color = 'text-orange-600 font-bold'; text = 'Due Today'; }
                        else if (days <= 7) { color = 'text-orange-600 font-bold'; }
                        dueHtml = `<div class="text-xs ${color} mt-2 font-medium">Due: ${dueDateStr}  ${text}</div>`;
                    }
                }

                const selectBox = broadcastSelectionMode ? `<input type="checkbox" onchange="toggleBcSelect('${b.id}')" ${selectedBroadcasts.includes(b.id) ? 'checked' : ''} class="mr-3 h-5 w-5 text-red-600 rounded">` : '';

                const deskBtn = !isComp ?
                    `<button onclick="addToMyDeskFromBroadcast('${b.id}')" class="ml-2 text-slate-400 hover:text-hub-600 p-1 transition-colors" title="Add to My Desk">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
            </button>` : '';

                list.innerHTML += `
            <div class="stagger-item bg-white rounded-lg shadow-sm border border-slate-200 p-4 ${isComp ? '' : 'border-l-4 border-yellow-500'}" style="animation-delay: ${index * 30}ms">
                <div class="flex justify-between items-start">
                    <div class="flex items-center">
                        ${selectBox}
                        <h3 class="font-bold text-lg text-slate-800">${b.title}</h3>
                        ${deskBtn}
                    </div>
                    <span class="text-xs font-bold px-2 py-1 rounded whitespace-nowrap ${getBroadcastColor(b.category)}">${b.category}</span>
                </div>
                <p class="text-slate-600 text-sm mt-2 bg-slate-50 p-2 rounded whitespace-pre-wrap">${b.notes || 'No notes'}</p>
                ${dueHtml}
                <div class="mt-3">
                    <div class="flex justify-between text-xs mb-1 font-bold text-slate-500">
                        <span>Acknowledgement</span>
                        <span>${ackCount}/${total}</span>
                    </div>
                    <div class="w-full bg-slate-200 h-2 rounded-full"><div class="bg-hub-500 h-2 rounded-full" style="width:${pct}%"></div></div>
                </div>
                <div class="mt-3 flex justify-between">
                    <button onclick="openBroadcastModal('${b.id}')" class="text-sm text-hub-600 hover:underline">Edit</button>
                    <button onclick="openBroadcastTrackModal('${b.id}')" class="text-sm font-bold text-hub-600">Track</button>
                </div>
            </div>`;
            });
            setTimeout(initSpotlight, 100);
        }

        function toggleBroadcastSelectionMode() {
            broadcastSelectionMode = !broadcastSelectionMode;
            selectedBroadcasts = [];
            document.getElementById('broadcastSelectBtn').textContent = broadcastSelectionMode ? 'Cancel' : 'Select for Archive';
            document.getElementById('broadcastBulkDeleteControls').classList.toggle('hidden', !broadcastSelectionMode);
            renderBroadcast();
        }

        function toggleBcSelect(id) {
            if (selectedBroadcasts.includes(id)) selectedBroadcasts = selectedBroadcasts.filter(x => x !== id);
            else selectedBroadcasts.push(id);
            document.getElementById('broadcastSelectedCount').textContent = selectedBroadcasts.length + " selected";
        }

        function deleteSelectedBroadcasts() {
            if (confirm("Delete selected broadcasts?")) {
                appData.broadcasts = appData.broadcasts.filter(b => !selectedBroadcasts.includes(b.id));
                saveData(); toggleBroadcastSelectionMode();
                showToast("Selected broadcasts deleted", "success");
            }
        }

        function openBroadcastModal(id = null) {
            document.getElementById('broadcastForm').reset();
            document.getElementById('broadcastId').value = '';

            // Always clear date input first to ensure clean state
            const dueDateInput = document.getElementById('broadcastDueDate');
            if (dueDateInput) {
                dueDateInput.value = '';
                dueDateInput.removeAttribute('data-range-start');
                dueDateInput.removeAttribute('data-range-end');
            }

            if (id) {
                const b = appData.broadcasts.find(x => x.id === id);
                if (b) {
                    document.getElementById('broadcastId').value = b.id;
                    document.getElementById('broadcastTitle').value = b.title;
                    document.getElementById('broadcastCategory').value = b.category;
                    document.getElementById('broadcastNotes').value = b.notes;

                    // Load range dates or single date
                    if (b.dueDateStart && b.dueDateEnd) {
                        // Range date: set both start and end
                        dueDateInput.value = b.dueDateEnd; // Display end date in input
                        dueDateInput.setAttribute('data-range-start', b.dueDateStart);
                        dueDateInput.setAttribute('data-range-end', b.dueDateEnd);
                    } else if (b.dueDate) {
                        // Legacy single date: convert to new format
                        dueDateInput.value = b.dueDate;
                        dueDateInput.setAttribute('data-range-start', b.dueDate);
                        dueDateInput.setAttribute('data-range-end', b.dueDate);
                    }
                    updateBroadcastDateDisplay(dueDateInput);
                }
            } else {
                // For new entries, display is already cleared above, just update the display
                updateBroadcastDateDisplay(dueDateInput);
            }
            toggleModal('broadcastModal');
        }

        function addToMyDeskFromBroadcast(id) {
            const b = appData.broadcasts.find(x => x.id === id);
            if (!b) return;

            if (appData.myDesk.some(t => t.sourceId === id)) {
                showToast("Task already exists in My Desk.", "info");
                return;
            }

            const deskTask = {
                id: 'desk_' + Date.now(),
                title: ` ${b.title}`,
                category: 'Broadcast',
                status: 'OnTheTable', // Default to Table
                notes: `Category: ${b.category}\n\n${b.notes || ''}`,
                sourceId: id
            };
            // Copy range dates or single date
            if (b.dueDateStart && b.dueDateEnd) {
                deskTask.dueDateStart = b.dueDateStart;
                deskTask.dueDateEnd = b.dueDateEnd;
            } else if (b.dueDate) {
                deskTask.dueDateStart = b.dueDate;
                deskTask.dueDateEnd = b.dueDate;
            } else {
                deskTask.dueDate = getTodayShort();
            }
            appData.myDesk.push(deskTask);
            saveData();
            renderMyDesk(); // Refresh view if active
            showToast("Broadcast added to My Desk!", "success");
        }

        function saveBroadcast(e) {
            e.preventDefault();
            const id = document.getElementById('broadcastId').value;

            const dueDateInput = document.getElementById('broadcastDueDate');
            const dueDate = dueDateInput.value || '';

            // Check for range dates
            const rangeStart = dueDateInput.getAttribute('data-range-start');
            const rangeEnd = dueDateInput.getAttribute('data-range-end');

            const bData = {
                id: id || 'bc_' + Date.now(),
                title: document.getElementById('broadcastTitle').value,
                category: document.getElementById('broadcastCategory').value,
                notes: document.getElementById('broadcastNotes').value,
                date: getTodayShort(),
                status: 'InProgress',
                ack: {}
            };

            // Store dates as object format: dueDateStart and dueDateEnd
            if (rangeStart && rangeEnd) {
                bData.dueDateStart = rangeStart;
                bData.dueDateEnd = rangeEnd;
            } else if (dueDate) {
                // Single date: use same value for both start and end
                bData.dueDateStart = dueDate;
                bData.dueDateEnd = dueDate;
            } else {
                // Explicitly clear dates when due date is empty
                bData.dueDateStart = null;
                bData.dueDateEnd = null;
            }

            if (id) {
                const idx = appData.broadcasts.findIndex(x => x.id === id);
                if (idx > -1) {
                    // Remove old date properties to ensure they're cleared
                    const updatedBroadcast = { ...appData.broadcasts[idx], ...bData, ack: appData.broadcasts[idx].ack };
                    if (!bData.dueDateStart && !bData.dueDateEnd) {
                        delete updatedBroadcast.dueDateStart;
                        delete updatedBroadcast.dueDateEnd;
                        // Also remove legacy dueDate if it exists
                        delete updatedBroadcast.dueDate;
                    }
                    appData.broadcasts[idx] = updatedBroadcast;
                }
            } else {
                appData.broadcasts.push(bData);
            }
            saveData(); toggleModal('broadcastModal');
            showToast("Broadcast saved", "success");
        }

        function deleteBroadcast() {
            const id = document.getElementById('broadcastId').value;
            if (id && confirm("Delete broadcast?")) {
                appData.broadcasts = appData.broadcasts.filter(x => x.id !== id);
                saveData(); toggleModal('broadcastModal');
                showToast("Broadcast deleted", "success");
            }
        }

        function openBroadcastTrackModal(id) {
            const b = appData.broadcasts.find(x => x.id === id);
            if (!b) return;
            document.getElementById('broadcastTrackId').value = id;
            document.getElementById('broadcastTrackTitle').textContent = b.title;

            const list = document.getElementById('broadcastTmChecklist');
            const search = document.getElementById('broadcastSearchInput').value.toLowerCase();
            const filter = document.getElementById('broadcastTrackFilter').value;
            const sortBy = document.getElementById('broadcastTrackSort').value;
            list.innerHTML = '';

            // Get active team members
            let teamMembers = appData.team.filter(t => t.active && t.name.toLowerCase().includes(search));

            // Apply filter
            if (filter === 'acknowledged') {
                teamMembers = teamMembers.filter(tm => b.ack[tm.id]);
            } else if (filter === 'pending') {
                teamMembers = teamMembers.filter(tm => !b.ack[tm.id]);
            }

            // Apply sort
            if (sortBy === 'name-asc') {
                teamMembers.sort((x, y) => x.name.localeCompare(y.name));
            } else if (sortBy === 'name-desc') {
                teamMembers.sort((x, y) => y.name.localeCompare(x.name));
            } else if (sortBy === 'status-ack') {
                teamMembers.sort((x, y) => {
                    const xAck = b.ack[x.id] ? 1 : 0;
                    const yAck = b.ack[y.id] ? 1 : 0;
                    if (yAck !== xAck) return yAck - xAck;
                    return x.name.localeCompare(y.name);
                });
            } else if (sortBy === 'status-pending') {
                teamMembers.sort((x, y) => {
                    const xAck = b.ack[x.id] ? 1 : 0;
                    const yAck = b.ack[y.id] ? 1 : 0;
                    if (xAck !== yAck) return xAck - yAck;
                    return x.name.localeCompare(y.name);
                });
            } else if (sortBy === 'account') {
                teamMembers.sort((x, y) => {
                    const xAcc = x.account || 'Zzz';
                    const yAcc = y.account || 'Zzz';
                    if (xAcc !== yAcc) return xAcc.localeCompare(yAcc);
                    return x.name.localeCompare(y.name);
                });
            }

            // Calculate stats
            const totalActive = appData.team.filter(t => t.active).length;
            let ackCount = 0;
            appData.team.filter(t => t.active).forEach(tm => {
                if (b.ack[tm.id]) ackCount++;
            });
            const percentage = totalActive > 0 ? Math.round((ackCount / totalActive) * 100) : 0;

            // Update progress display
            document.getElementById('broadcastTrackProgress').textContent = `${ackCount}/${totalActive} Acknowledged`;
            document.getElementById('broadcastTrackPercentage').textContent = `(${percentage}%)`;
            document.getElementById('broadcastTrackProgressBar').style.width = `${percentage}%`;

            // Render team members
            teamMembers.forEach(tm => {
                const isAck = b.ack[tm.id];
                const accountBadge = tm.account ? `<span class="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">${tm.account}</span>` : '';
                const statusIcon = isAck 
                    ? `<svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                       </svg>`
                    : `<svg class="w-5 h-5 text-orange-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                       </svg>`;

                list.innerHTML += `
                <label class="flex items-center gap-3 p-3 hover:bg-slate-50 rounded-lg border border-slate-200 cursor-pointer transition-all ${isAck ? 'bg-green-50/30' : 'bg-white'}">
                    <input type="checkbox" onchange="toggleBcAck('${b.id}', ${tm.id})" ${isAck ? 'checked' : ''} 
                        class="form-checkbox h-5 w-5 text-hub-600 rounded border-slate-300 focus:ring-2 focus:ring-hub-500">
                    ${statusIcon}
                    <div class="flex-1 min-w-0">
                        <span class="block text-sm font-medium ${isAck ? 'text-slate-400 line-through' : 'text-slate-700'}">${tm.name}</span>
                        ${accountBadge}
                    </div>
                </label>`;
            });

            if (!document.body.classList.contains('modal-active')) toggleModal('broadcastTrackModal');
        }

        function setBroadcastTrackFilter(filterType) {
            document.getElementById('broadcastTrackFilter').value = filterType;
            
            // Update button styles
            document.querySelectorAll('.broadcast-filter-btn').forEach(btn => {
                if (btn.getAttribute('data-filter') === filterType) {
                    btn.className = 'broadcast-filter-btn px-4 py-2 text-sm font-semibold rounded-lg transition-all border-2 border-slate-300 bg-slate-50 text-slate-700';
                } else {
                    btn.className = 'broadcast-filter-btn px-4 py-2 text-sm font-semibold rounded-lg transition-all border-2 border-transparent bg-white text-slate-600 hover:bg-slate-50';
                }
            });
            
            openBroadcastTrackModal(document.getElementById('broadcastTrackId').value);
        }

        function setBroadcastTrackSort(sortType) {
            document.getElementById('broadcastTrackSort').value = sortType;
            openBroadcastTrackModal(document.getElementById('broadcastTrackId').value);
        }

        function toggleBcAck(bid, tmid) {
            const b = appData.broadcasts.find(x => x.id === bid);
            if (b) {
                b.ack[tmid] = !b.ack[tmid];
                // Check completion
                const activeCount = appData.team.filter(t => t.active).length;
                const ackCount = Object.values(b.ack).filter(Boolean).length;
                b.status = ackCount >= activeCount ? 'Completed' : 'InProgress';
                saveData();
                openBroadcastTrackModal(bid); // refresh
                if (activeTool === 'ActionHub' && currentHubTab === 'broadcast') renderBroadcast();
            }
        }

        function markAllBroadcastAck() {
            const bid = document.getElementById('broadcastTrackId').value;
            const b = appData.broadcasts.find(x => x.id === bid);
            if (b && confirm("Mark ALL as acknowledged?")) {
                appData.team.forEach(tm => b.ack[tm.id] = true);
                b.status = 'Completed';
                saveData();
                openBroadcastTrackModal(bid);
                if (activeTool === 'ActionHub' && currentHubTab === 'broadcast') renderBroadcast();
            }
        }

        // ==========================================
        // TOOL 2: PULSECHECK UI LOGIC
        // ==========================================

        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderDashboard();
        }


        let teamInfoViewMode = 'list'; // 'list' or 'grid'

        function toggleTeamInfoView(mode) {
            teamInfoViewMode = mode;

            // Update Buttons
            const btnList = document.getElementById('btnTeamList');
            const btnGrid = document.getElementById('btnTeamGrid');

            if (mode === 'list') {
                btnList.className = "p-1.5 rounded-md text-slate-600 bg-white shadow-sm transition-all";
                btnGrid.className = "p-1.5 rounded-md text-slate-400 hover:text-slate-600 hover:bg-white/50 transition-all";
            } else {
                btnGrid.className = "p-1.5 rounded-md text-slate-600 bg-white shadow-sm transition-all";
                btnList.className = "p-1.5 rounded-md text-slate-400 hover:text-slate-600 hover:bg-white/50 transition-all";
            }

            renderTeamInfo();
        }

        function renderTeamInfo(animate = false) {
            // 1. Get Elements
            const listView = document.querySelector('#teamInfoView .overflow-x-auto'); // Existing Table
            const gridView = document.getElementById('teamInfoGridView');
            const tbody = document.getElementById('teamInfoTableBody');
            const rosterContainer = document.getElementById('pulse-check-roster-actions');
            const teamInfoCardHeader = document.getElementById('team-info-card-header');

            // --- DYNAMIC ROSTER ENTRY POINT LOGIC ---
            if (appData.team.length === 0) {
                // EMPTY STATE: Show prominent CTA in the center of the Pulse Check dashboard
                rosterContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 px-4 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200 shadow-sm">
                        <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Build Your Team</h3>
                        <p class="text-slate-500 mb-8 max-w-sm mx-auto">You haven't added any team members yet. Start by building your roster to unlock all LeadershipOS features.</p>
                        <button onclick="openRosterModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition-all transform hover:scale-105 flex items-center gap-2 mx-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add First Member
                        </button>
                    </div>
                `;
                rosterContainer.classList.remove('hidden');
            } else {
                // ACTIVE STATE: Hide prominent CTA and add subtle manage icon to card header
                rosterContainer.classList.add('hidden');

                // Add subtle edit button to the top-right of the card header if it doesn't exist
                if (teamInfoCardHeader && !document.getElementById('subtle-roster-edit')) {
                    const editBtn = document.createElement('button');
                    editBtn.id = 'subtle-roster-edit';
                    editBtn.onclick = () => openRosterModal();
                    editBtn.className = "p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all ml-auto";
                    editBtn.title = "Manage Roster";
                    editBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    `;
                    teamInfoCardHeader.appendChild(editBtn);
                }
            }

            // 2. Toggle Visibility
            if (teamInfoViewMode === 'list') {
                listView.classList.remove('hidden');
                gridView.classList.add('hidden');
            } else {
                listView.classList.add('hidden');
                gridView.classList.remove('hidden');
            }

            // 3. Filter & Sort Data
            const searchInput = document.getElementById('teamSearchInput');
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            const sort = document.getElementById('teamSortSelect').value;

            let list = appData.team.filter(t => t.active &&
                (t.name.toLowerCase().includes(search) || t.account.toLowerCase().includes(search)));

            if (sort === 'name') list.sort((a, b) => a.name.localeCompare(b.name));
            else if (sort === 'account') list.sort((a, b) => a.account.localeCompare(b.account));
            else list.sort((a, b) => (a.hireDate || '').localeCompare(b.hireDate || ''));

            // 4. Render LIST View (Existing Logic)
            if (teamInfoViewMode === 'list') {
                tbody.innerHTML = '';
                if (list.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400">No results.</td></tr>`; return; }

                list.forEach((tm, index) => {
                    tbody.innerHTML += `
            <tr class="${animate ? 'stagger-item' : ''} team-row border-b border-slate-100" style="animation-delay: ${index * 20}ms" onclick="if(window.getSelection().toString().length === 0) openRosterModal(${tm.id})">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                    <span class="inline-block px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wide border max-w-[150px] truncate align-middle ${getAccountColor(tm.account)}" title="${tm.account}">${tm.account}</span>
                </td>
                <td class="px-6 py-4 font-bold text-slate-900">${tm.name}</td>
                <td class="px-6 py-4 text-slate-500">${tm.role}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${tm.hireDate ? new Date(tm.hireDate + 'T12:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'}</td>
                <td class="px-6 py-4 text-slate-500 font-mono">${tm.empId || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
    <div class="flex items-center gap-2">
        <span class="truncate max-w-[180px]" title="${tm.pocEmail || ''}">${tm.pocEmail || '-'}</span>
        ${tm.pocEmail ? `
        <button onclick="copyPocEmail(event, '${tm.pocEmail}', this)" 
                class="text-slate-400 hover:text-blue-600 transition-colors p-1.5 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700" 
                title="Copy Email">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
        </button>` : ''}
    </div>
</td>
            </tr>`;
                });
            }
            // 5. Render GRID View (New Logic)
            else {
                gridView.innerHTML = '';
                if (list.length === 0) { gridView.innerHTML = `<div class="col-span-full text-center py-12 text-slate-400">No results found.</div>`; return; }

                list.forEach((tm, index) => {
                    // Calculate Tenure
                    let tenure = 'New Hire';
                    if (tm.hireDate) {
                        const diff = new Date() - new Date(tm.hireDate);
                        const years = Math.floor(diff / (1000 * 60 * 60 * 24 * 365));
                        const months = Math.floor((diff % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24 * 30));
                        tenure = years > 0 ? `${years}y ${months}m` : `${months}m`;
                    }

                    // Initials for Avatar
                    const initials = tm.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    const bgClass = getAccountColor(tm.account).split(' ')[0]; // Extract just the bg color class

                    gridView.innerHTML += `
            <div class="${animate ? 'stagger-item' : ''} bg-white dark:bg-slate-800 rounded-2xl shadow-sm hover:shadow-lg transition-all border border-slate-200 dark:border-slate-700 overflow-hidden group cursor-pointer hover:-translate-y-1 relative" 
                 style="animation-delay: ${index * 30}ms"
                 onclick="openRosterModal(${tm.id})">

                <div class="h-20 ${bgClass} opacity-80"></div>

                <div class="absolute top-10 left-6">
                    <div class="w-16 h-16 rounded-full border-4 border-white dark:border-slate-800 bg-white dark:bg-slate-700 flex items-center justify-center text-xl font-bold text-slate-700 dark:text-slate-200 shadow-sm">
                        ${initials}
                    </div>
                </div>

                <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button class="bg-white/90 p-2 rounded-full shadow-sm hover:bg-white text-slate-500 hover:text-blue-600">
                        <i data-lucide="edit-2" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="pt-10 px-6 pb-6">
                    <h3 class="font-bold text-lg text-slate-800 dark:text-white truncate">${tm.name}</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 font-medium mb-4">${tm.role}</p>

                    <div class="space-y-3">
                        <div class="flex items-center text-sm text-slate-600 dark:text-slate-300">
                            <i data-lucide="briefcase" class="w-4 h-4 mr-2 text-slate-400"></i>
                            <span class="truncate">${tm.account}</span>
                        </div>
                        <div class="flex items-center text-sm text-slate-600 dark:text-slate-300">
                            <i data-lucide="clock" class="w-4 h-4 mr-2 text-slate-400"></i>
                            <span>${tenure}</span>
                        </div>
                        <div class="flex items-center text-sm text-slate-600 dark:text-slate-300">
                            <i data-lucide="user" class="w-4 h-4 mr-2 text-slate-400"></i>
                            <span class="truncate">${tm.poc || 'No POC Assigned'}</span>
                        </div>
                    </div>
                </div>
            </div>`;
                });
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }


        function renderDashboardSkeleton() {
            const grid = document.getElementById('tmGrid');
            if (!grid) return;
            grid.innerHTML = '';
            for (let i = 0; i < 6; i++) {
                grid.innerHTML += `
                <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
                    <div class="mt-6">
                        <div class="h-4 bg-slate-200 rounded w-3/4 mb-2 skeleton"></div>
                        <div class="h-3 bg-slate-200 rounded w-1/2 mb-4 skeleton"></div>
                        <div class="h-8 bg-slate-200 rounded w-1/4 skeleton"></div>
                    </div>
                    <div class="mt-4 p-3 rounded-lg border-2 border-dashed border-slate-300">
                        <div class="h-4 bg-slate-200 rounded w-full skeleton"></div>
                    </div>
                </div>`;
            }
        }

        function renderDashboard(animate = false) {
            const grid = document.getElementById('tmGrid');
            if (!grid) return; // Safety

            if (animate) {
                renderDashboardSkeleton();
                setTimeout(() => _renderDashboardContent(true), 400);
            } else {
                _renderDashboardContent(false);
            }
        }

        function _renderDashboardContent(animate) {
            const grid = document.getElementById('tmGrid');
            if (!grid) return;

            const mKey = getMonthKey(currentDate);
            document.getElementById('currentMonthDisplay').textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            grid.innerHTML = '';
            const monthData = appData.checkins[mKey] || {};

            let stats = { total: 0, done: 0, good: 0, mid: 0, bad: 0 };
            let team = appData.team.filter(t => t.active);
            const sort = document.getElementById('sortSelect').value;

            // Basic Sort
            if (sort === 'name') team.sort((a, b) => a.name.localeCompare(b.name));
            else if (sort === 'account') team.sort((a, b) => a.account.localeCompare(b.account));
            else if (sort === 'role') team.sort((a, b) => (a.role || '').localeCompare(b.role || ''));
            else if (sort === 'ews') {
                const ewsRank = { red: 3, amber: 2, green: 1, undefined: 0 };
                team.sort((a, b) => {
                    const rankA = ewsRank[a.ews] || 0;
                    const rankB = ewsRank[b.ews] || 0;
                    return rankB - rankA; // High risk first
                });
            }

            if (team.length === 0) { grid.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400">No active team members.</div>`; return; }

            team.forEach(tm => {
                stats.total++;
                const chk = monthData[tm.id];
                let statusHtml = `<div class="mt-3 p-3 rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-700 text-slate-400 dark:text-slate-500 flex justify-center text-sm">Not checked in</div>`;

                if (chk) {
                    stats.done++; stats[chk.sentiment]++;
                    const styles = {
                        good: 'bg-green-100 text-green-800 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-900/50',
                        mid: 'bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-900/50',
                        bad: 'bg-red-100 text-red-800 border-red-200 dark:bg-red-900/30 dark:text-red-400 dark:border-red-900/50'
                    }[chk.sentiment];
                    const emoji = { good: '', mid: '', bad: '' }[chk.sentiment];
                    const label = { good: 'Positive', mid: 'Neutral', bad: 'Concerning' }[chk.sentiment];

                    statusHtml = `
                    <div class="mt-3 p-3 rounded-lg border ${styles} flex justify-between items-center">
                        <div>
                            <span class="text-xl mr-2">${emoji}</span>
                            <span class="font-bold text-sm">${label}</span>
                            <p class="text-xs opacity-75">On ${formatDate(chk.date)}</p>
                        </div>
                        <div class="text-lg text-current opacity-50"></div>
                    </div>`;
                }

                // --- HISTORY DOTS LOGIC (Restored) ---
                let historyHtml = '<div class="flex gap-1.5 mt-3 mb-1 pl-1">';
                let dHist = new Date(currentDate);
                dHist.setDate(1);
                // Look back 5 months
                for (let i = 5; i >= 1; i--) {
                    let p = new Date(dHist);
                    p.setMonth(p.getMonth() - i);
                    const k = getMonthKey(p);
                    const s = appData.checkins[k]?.[tm.id]?.sentiment;

                    let color = 'bg-slate-200 dark:bg-slate-700'; // No data (Gray)
                    if (s === 'good') color = 'bg-green-400';
                    if (s === 'mid') color = 'bg-yellow-400';
                    if (s === 'bad') color = 'bg-red-400';

                    const title = p.toLocaleDateString('en-US', { month: 'short' });
                    historyHtml += `<div class="w-2.5 h-2.5 rounded-full ${color}" title="${title}"></div>`;
                }
                historyHtml += '</div>';
                // -------------------------------------

                // EWS History Logic
                const ews = (appData.ewsHistory[mKey] && appData.ewsHistory[mKey][tm.id]) || tm.ews || 'green';

                // PREMIUM EWS BADGE
                let ewsBadge = '';
                if (ews === 'green') {
                    ewsBadge = `<div class="flex items-center gap-1.5 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2.5 py-1 rounded-full border border-green-100 dark:border-green-900/50 shadow-sm"><div class="w-2 h-2 rounded-full bg-green-500"></div><span class="text-[10px] font-bold tracking-wider uppercase">Stable</span></div>`;
                } else if (ews === 'amber') {
                    ewsBadge = `<div class="flex items-center gap-1.5 bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 px-2.5 py-1 rounded-full border border-amber-100 dark:border-amber-900/50 shadow-sm"><div class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></div><span class="text-[10px] font-bold tracking-wider uppercase">Risk</span></div>`;
                } else {
                    ewsBadge = `<div class="flex items-center gap-1.5 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400 px-2.5 py-1 rounded-full border border-red-100 dark:border-red-900/50 shadow-sm"><div class="w-2 h-2 rounded-full bg-red-500 animate-ping"></div><span class="text-[10px] font-bold tracking-wider uppercase">Critical</span></div>`;
                }

                grid.innerHTML += `
                <div class="${animate ? 'stagger-item' : ''} bg-white rounded-xl shadow-sm p-6 border border-slate-100 relative hover:shadow-md group cursor-pointer transition-all" style="animation-delay: ${stats.total * 30}ms" onclick="openCheckinModal(${tm.id})">
                    <div class="absolute top-4 right-4" onclick="event.stopPropagation(); openEwsModal(${tm.id})">
                        ${ewsBadge}
                    </div>
                    <div class="mt-6">
                        <h3 class="text-lg font-bold text-slate-800 hover:text-dcx-blue cursor-pointer transition-colors inline-block" onclick="event.stopPropagation(); openContextModal(${tm.id})">${tm.name}</h3>
                        <p class="text-sm text-slate-500">${tm.role}</p>
                        <span class="inline-block mt-2 px-2 py-1 text-xs font-semibold rounded-full ${getAccountColor(tm.account)}">${tm.account}</span>
                    </div>

                    ${historyHtml}

                    ${statusHtml}
                </div>`;
            });

            // Update Stats
            document.getElementById('statNotStarted').textContent = stats.total - stats.done;
            document.getElementById('statGood').textContent = stats.good;
            document.getElementById('statMid').textContent = stats.mid;
            document.getElementById('statBad').textContent = stats.bad;
            const pct = stats.total > 0 ? Math.round((stats.done / stats.total) * 100) : 0;
            document.getElementById('progressBar').style.width = pct + '%';
            document.getElementById('progressText').textContent = `${stats.done}/${stats.total} Completed`;
            if (animate) setTimeout(initSpotlight, 100);
            else initSpotlight();
        }

        function toggleHeatmapMode(mode) {
            heatmapMode = mode;
            document.getElementById('hmBtnSentiment').className = mode === 'sentiment' ? 'px-3 py-1.5 text-sm font-semibold rounded-md bg-white shadow-sm text-dcx-blue' : 'px-3 py-1.5 text-sm font-semibold rounded-md text-slate-500';
            document.getElementById('hmBtnEws').className = mode === 'ews' ? 'px-3 py-1.5 text-sm font-semibold rounded-md bg-white shadow-sm text-dcx-blue' : 'px-3 py-1.5 text-sm font-semibold rounded-md text-slate-500';
            renderTrendsView();
        }

        function renderTrendsView() {
            const isDark = document.body.classList.contains('dark-mode');

            let keys = [], labels = [];
            let d = new Date(); d.setDate(1);
            for (let i = 11; i >= 0; i--) {
                let p = new Date(d); p.setMonth(p.getMonth() - i);
                keys.push(getMonthKey(p));
                labels.push(p.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
            }
            let avgs = keys.map(mk => {
                const md = appData.checkins[mk]; if (!md) return null;
                let tot = 0, cnt = 0;
                Object.values(md).forEach(c => { tot += (c.sentiment === 'good' ? 3 : (c.sentiment === 'mid' ? 2 : 1)); cnt++; });
                return cnt > 0 ? (tot / cnt).toFixed(2) : null;
            });
            if (teamTrendChartInstance) teamTrendChartInstance.destroy();
            const ctx = document.getElementById('teamTrendChart').getContext('2d');

            // Create Gradient (Dark mode friendly)
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            if (isDark) {
                gradient.addColorStop(0, 'rgba(56, 189, 248, 0.4)'); // Light Blue
                gradient.addColorStop(1, 'rgba(56, 189, 248, 0.0)');
            } else {
                gradient.addColorStop(0, 'rgba(0, 80, 157, 0.4)'); // DCX Blue
                gradient.addColorStop(1, 'rgba(0, 80, 157, 0.0)');
            }

            const gridColor = isDark ? '#334155' : '#f1f5f9';
            const tickColor = isDark ? '#94a3b8' : '#64748b';
            const lineColor = isDark ? '#38bdf8' : '#00509D';
            const pointBg = isDark ? '#0f172a' : '#ffffff';

            teamTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Team Avg Sentiment',
                        data: avgs,
                        borderColor: lineColor,
                        backgroundColor: gradient,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: pointBg,
                        pointBorderColor: lineColor,
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 1,
                            max: 3,
                            grid: { color: gridColor },
                            ticks: {
                                color: tickColor,
                                font: { size: 14 },
                                callback: v => v === 3 ? '' : (v === 2 ? '' : (v === 1 ? '' : ''))
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: tickColor }
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                            titleColor: isDark ? '#f8fafc' : '#1e293b',
                            bodyColor: isDark ? '#cbd5e1' : '#475569',
                            borderColor: isDark ? '#334155' : '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        const val = context.parsed.y;
                                        const emoji = val >= 2.5 ? '' : (val >= 1.5 ? '' : '');
                                        label += val + ' ' + emoji;
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: { display: false }
                    }
                }
            });
            const hHeader = document.getElementById('heatmapHeader');
            hHeader.innerHTML = '<th class="text-left py-3 px-4 bg-slate-50 dark:bg-slate-800 dark:text-slate-300 sticky left-0 z-10">Team Member</th>';
            labels.forEach(l => hHeader.innerHTML += `<th class="py-3 px-2 bg-slate-50 dark:bg-slate-800 text-xs text-slate-500 dark:text-slate-400">${l}</th>`);
            const hBody = document.getElementById('heatmapBody'); hBody.innerHTML = '';
            appData.team.filter(tm => tm.active).sort((a, b) => a.name.localeCompare(b.name)).forEach(tm => {
                let row = `<tr><td class="py-3 px-4 font-medium text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-900 sticky left-0 z-10 border-r dark:border-slate-700"><div>${tm.name}</div><div class="text-xs text-slate-400 dark:text-slate-500">${tm.account}</div></td>`;
                keys.forEach(mk => {
                    let cls = 'sentiment-none', txt = '-';
                    if (heatmapMode === 'sentiment') {
                        const c = appData.checkins[mk]?.[tm.id];
                        if (c) { cls = `sentiment-${c.sentiment}`; txt = c.sentiment === 'good' ? '' : (c.sentiment === 'mid' ? '' : ''); }
                    } else {
                        const ewsStatus = appData.ewsHistory[mk]?.[tm.id];
                        if (ewsStatus) { cls = `heatmap-ews-${ewsStatus}`; txt = ewsStatus === 'green' ? '' : (ewsStatus === 'amber' ? '' : ''); } else if (mk === getMonthKey(new Date())) { cls = `heatmap-ews-${tm.ews}`; txt = tm.ews === 'green' ? '' : (tm.ews === 'amber' ? '' : ''); }
                    }
                    row += `<td class="py-2 px-2 text-center border dark:border-slate-700 ${cls}">${txt}</td>`;
                });
                hBody.innerHTML += row + '</tr>';
            });
        }

        function resetTimesheet() {
            const todayKey = getTodayShort();
            if (confirm("Are you sure you want to reset all timesheet submissions for today?")) {
                if (appData.timesheets[todayKey]) {
                    delete appData.timesheets[todayKey];
                }
                saveData();
            }
        }

        function renderTimesheetView() {
            const cutoff = getTodayShort();
            const dateDisplay = document.getElementById('tsDateDisplay');
            if (dateDisplay) dateDisplay.textContent = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

            // 1. Get Controls
            // We default to 'status' sort (Pending First) effectively ignoring the dropdown if it exists
            const accFilter = document.getElementById('tsAccountFilter');
            const accValue = accFilter ? accFilter.value : 'all';

            // 2. Populate Account Filter (Dynamic) if empty
            // We check if length <= 1 because "All Accounts" is always index 0
            if (accFilter && accFilter.options.length <= 1) {
                // Extract unique accounts from the team list
                const uniqueAccounts = [...new Set(appData.team.filter(t => t.active).map(t => t.account || 'Unassigned'))].sort();

                uniqueAccounts.forEach(acc => {
                    const opt = document.createElement('option');
                    opt.value = acc;
                    opt.textContent = acc;
                    accFilter.appendChild(opt);
                });
                // Restore selection if needed
                accFilter.value = accValue;
            }

            const list = document.getElementById('tsList');
            if (!list) return;
            list.innerHTML = '';

            const tsData = (appData.timesheets && appData.timesheets[cutoff]) ? appData.timesheets[cutoff] : {};

            // 3. Filter Data
            let team = appData.team.filter(t => t.active);

            // Apply Account Filter
            if (accValue !== 'all') {
                team = team.filter(t => t.account === accValue);
            }

            // 4. SMART SORT (The "Checklist" Logic)
            team.sort((a, b) => {
                // Safety Variables (Prevents Crash)
                const nameA = (a.name || 'Unknown').toLowerCase();
                const nameB = (b.name || 'Unknown').toLowerCase();

                const doneA = !!tsData[a.id];
                const doneB = !!tsData[b.id];

                // Rule 1: Pending (Not Done) comes BEFORE Done
                if (doneA !== doneB) {
                    return doneA ? 1 : -1; // If A is done, push it down (1)
                }

                // Rule 2: If status is same, sort Alphabetically
                return nameA.localeCompare(nameB);
            });

            // 5. Render
            let doneCount = 0;

            if (team.length === 0) {
                list.innerHTML = `<div class="p-8 text-center text-slate-400 italic">No team members found.</div>`;
            } else {
                team.forEach(tm => {
                    const done = !!tsData[tm.id];
                    if (done) doneCount++;

                    const displayName = tm.name || 'Unknown Member';
                    const displayAccount = tm.account || 'No Account';

                    // Visuals: If done, dim the row to push focus to pending items
                    const rowClass = done ? 'bg-slate-50/50 opacity-75' : 'bg-white';

                    list.innerHTML += `
                    <div class="p-4 flex items-center justify-between hover:bg-slate-50 border-b border-slate-50 last:border-0 ${rowClass}">
                        <div class="flex items-center">
                            <button onclick="toggleTimesheet('${cutoff}', ${tm.id})" class="ts-toggle w-8 h-8 rounded-full border-2 flex items-center justify-center mr-4 transition-all ${done ? 'ts-checked text-white border-dcx-blue bg-dcx-blue' : 'ts-unchecked border-slate-300 hover:border-dcx-blue text-transparent'}">
                                
                            </button>
                            <div>
                                <p class="font-bold text-slate-800 ${done ? 'line-through text-slate-400' : ''}">${displayName}</p>
                                <p class="text-xs text-slate-500 font-medium">${displayAccount}</p>
                            </div>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 rounded-full uppercase tracking-wider ${done ? 'text-green-700 bg-green-100' : 'text-orange-600 bg-orange-100'}">${done ? 'Submitted' : 'Pending'}</span>
                    </div>`;
                });
            }

            // 6. Update Progress Bar (Based on Filtered List)
            const pct = team.length ? Math.round((doneCount / team.length) * 100) : 0;
            const bar = document.getElementById('tsProgressBar');
            const txt = document.getElementById('tsProgressText');

            if (bar) bar.style.width = pct + '%';
            if (txt) {
                txt.textContent = `${doneCount}/${team.length}`;
                txt.className = pct === 100 ? "text-2xl font-extrabold text-green-600" : "text-2xl font-extrabold text-dcx-blue";
            }
        }

        function toggleTimesheet(cutoff, id) {
            if (!appData.timesheets[cutoff]) appData.timesheets[cutoff] = {};
            appData.timesheets[cutoff][id] = !appData.timesheets[cutoff][id];
            saveData(); renderTimesheetView();
        }

        function renderRollCallView() {
            const todayKey = getTodayShort();
            const dateDisplay = document.getElementById('rcDateDisplay');
            if (dateDisplay) dateDisplay.textContent = new Date().toDateString();

            const list = document.getElementById('rcRosterList');
            if (!list) return;
            list.innerHTML = '';

            // Clear search on initial load (but preserve during filtering)
            const searchInput = document.getElementById('rcSearch');
            const search = searchInput.value.toLowerCase();

            const data = appData.rollCall[todayKey] || {};

            // Calculate overall progress (all active team members)
            let overallPresent = 0, overallTotal = 0;
            appData.team.filter(t => t.active).forEach(tm => {
                overallTotal++;
                const rc = data[tm.id] || {};
                if (rc.status === 'present') overallPresent++;
            });

            // Filter team members based on search, then sort
            const filteredTeam = appData.team.filter(t => t.active && (
                !search ||
                t.name.toLowerCase().includes(search) ||
                t.role.toLowerCase().includes(search) ||
                (t.account && t.account.toLowerCase().includes(search))
            )).sort((a, b) => a.name.localeCompare(b.name));

            // STAGGER APPLIED HERE
            filteredTeam.forEach((tm, index) => {
                const rc = data[tm.id] || {};
                const status = rc.status;

                let rowBg = 'bg-white';
                if (status === 'absent') rowBg = 'bg-red-50';
                if (status === 'late') rowBg = 'bg-yellow-50';
                if (status === 'pto') rowBg = 'bg-purple-50';

                let actionHtml = '';
                if (status && status !== 'present' && status !== 'pto') {
                    // Only show edit button for late/absent (PTO is handled automatically)
                    if (rc.notified) {
                        actionHtml = `<span class="flex items-center text-green-600 font-bold text-xs"><svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg> Notified</span>`;
                    } else {
                        actionHtml = `<button onclick="openAttendanceDetails(${tm.id}, '${status}')" class="text-blue-500 hover:bg-blue-100 p-1 rounded" title="Edit details"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>`;
                    }
                }

                let reasonText = '';
                if (status === 'absent' || status === 'late') {
                    reasonText = `<div class="text-xs text-red-600 font-bold text-right mr-2">${formatReason(rc.reason)}</div>`;
                } else if (status === 'pto') {
                    reasonText = `<div class="text-xs text-purple-600 font-bold text-right mr-2">Planned PTO</div>`;
                }

                list.innerHTML += `
            <div class="stagger-item flex items-center justify-between p-3 border-b border-slate-100 ${rowBg} hover:bg-slate-50 transition" style="animation-delay: ${index * 20}ms">
                <div class="w-1/3">
                    <div class="font-bold text-slate-800 text-sm">${tm.name}</div>
                    <div class="text-xs text-slate-400">${tm.account}</div>
                </div>
                <div class="w-1/3 flex justify-center space-x-1">
                    ${['present', 'late', 'absent', 'pto'].map(s => {
                    let btnClass = 'bg-slate-100 text-slate-400';
                    if (status === s) {
                        if (s === 'present') btnClass = 'bg-green-100 text-green-700 ring-1 ring-green-300';
                        if (s === 'late') btnClass = 'bg-yellow-100 text-yellow-700 ring-1 ring-yellow-300';
                        if (s === 'absent') btnClass = 'bg-red-100 text-red-700 ring-1 ring-red-300';
                        if (s === 'pto') btnClass = 'bg-purple-100 text-purple-700 ring-1 ring-purple-300';
                    }
                    return `<button onclick="setRollCall(${tm.id}, '${s}')" class="px-3 py-1 text-xs font-bold rounded-md capitalize ${btnClass} hover:shadow-sm rc-status-btn">${s}</button>`;
                }).join('')}
                </div>
                <div class="w-1/3 flex justify-end items-center">
                    ${reasonText}
                    ${actionHtml}
                </div>
            </div>`;
            });

            const pct = overallTotal ? Math.round((overallPresent / overallTotal) * 100) : 0;
            document.getElementById('rcProgressBar').style.width = pct + '%';
            document.getElementById('rcProgressText').textContent = `${overallPresent}/${overallTotal}`;
            setTimeout(initSpotlight, 100);
        }

        function setRollCall(id, status) {
            const k = getTodayShort();
            if (!appData.rollCall[k]) appData.rollCall[k] = {};
            if (!appData.rollCall[k][id]) appData.rollCall[k][id] = {};

            appData.rollCall[k][id].status = status;
            if (status === 'present') {
                // Clear reasons
                delete appData.rollCall[k][id].reason;
                delete appData.rollCall[k][id].notified;
                delete appData.rollCall[k][id].currentStatus;
                saveData();
                renderRollCallView();
                syncRollCallToCapacity(id, status);
            } else if (status === 'pto') {
                // PTO is always planned - set automatically
                appData.rollCall[k][id].reason = 'pto';
                appData.rollCall[k][id].currentStatus = 'Planned PTO';
                saveData();
                renderRollCallView();
                syncRollCallToCapacity(id, status);
            } else {
                // For late/absent, open the attendance details modal
                openAttendanceDetails(id, status);
            }
        }

        function markRemainingPresent() {
            const k = getTodayShort();
            if (!appData.rollCall[k]) appData.rollCall[k] = {};
            appData.team.filter(t => t.active).forEach(tm => {
                if (!appData.rollCall[k][tm.id] || !appData.rollCall[k][tm.id].status) {
                    appData.rollCall[k][tm.id] = { status: 'present' };
                }
                appData.rollCall[k][tm.id] = { status: 'present' };
            });
            saveData(); renderRollCallView();
        }

        function resetDailyAttendance() {
            if (confirm("Reset today?")) {
                delete appData.rollCall[getTodayShort()];
                saveData(); renderRollCallView();
            }
        }

        function saveRollCallToAttendanceHistory() {
            const todayKey = getTodayShort();
            const rollCallData = appData.rollCall[todayKey] || {};
            const history = getAttendanceHistory();

            if (!history[todayKey]) {
                history[todayKey] = {};
            }

            // Map Roll Call statuses to Reliability Matrix statuses
            Object.keys(rollCallData).forEach(tmId => {
                const rcEntry = rollCallData[tmId];
                const status = rcEntry?.status;

                if (status === 'present') {
                    history[todayKey][tmId] = 'present';
                } else if (status === 'late') {
                    history[todayKey][tmId] = 'late';
                } else if (status === 'absent') {
                    history[todayKey][tmId] = 'unplanned';
                } else if (status === 'pto') {
                    history[todayKey][tmId] = 'pto';
                }
            });

            saveAttendanceHistory(history);
            saveData(); // Also save appData.rollCall (existing behavior)

            // Show success feedback
            if (typeof showToast === 'function') {
                showToast('Attendance saved to Reliability Matrix!', 'success');
            }
        }

        // ==========================================
        // RELIABILITY MATRIX FUNCTIONS
        // ==========================================
        function changeReliabilityMonth(offset) {
            currentReliabilityMonth = new Date(currentReliabilityMonth.getFullYear(), currentReliabilityMonth.getMonth() + offset, 1);
            renderReliabilityMatrix();
        }

        // ==========================================
        // RELIABILITY MATRIX - FILTERS & ACTIONS
        // ==========================================
        function applyReliabilityFilters() {
            reliabilityFilterSearch = document.getElementById('reliabilitySearch')?.value.toLowerCase() || '';
            reliabilityFilterStatus = document.getElementById('reliabilityStatusFilter')?.value || 'all';
            reliabilityFilterAccount = document.getElementById('reliabilityAccountFilter')?.value || 'all';
            reliabilitySortBy = document.getElementById('reliabilitySort')?.value || 'name';
            renderReliabilityMatrix();
        }

        function populateReliabilityAccountFilter() {
            const accountFilter = document.getElementById('reliabilityAccountFilter');
            if (!accountFilter) return;

            // Get all unique accounts from active team members, including 'Unassigned' for those without one
            const accounts = [...new Set(
                appData.team
                    .filter(t => t.active)
                    .map(t => t.account || 'Unassigned')
            )].sort();

            accountFilter.innerHTML = '<option value="all">All Accounts</option>';
            accounts.forEach(account => {
                accountFilter.innerHTML += `<option value="${account}">${account}</option>`;
            });
        }

        function markAllPresentToday() {
            const todayDateString = getTodayShort();
            const history = getAttendanceHistory();

            if (!history[todayDateString]) {
                history[todayDateString] = {};
            }

            appData.team.filter(t => t.active).forEach(tm => {
                history[todayDateString][tm.id] = 'present';
            });

            saveAttendanceHistory(history);
            renderReliabilityMatrix();

            if (typeof showToast === 'function') {
                showToast('All team members marked as Present for today!', 'success');
            }
        }

        function toggleBulkEditMode() {
            reliabilityBulkEditMode = !reliabilityBulkEditMode;
            reliabilitySelectedCells.clear();

            const toggleBtn = document.getElementById('reliabilityBulkEditToggle');
            const bulkActions = document.getElementById('reliabilityBulkActions');
            const selectedCount = document.getElementById('reliabilitySelectedCount');

            if (toggleBtn) {
                if (reliabilityBulkEditMode) {
                    toggleBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    toggleBtn.classList.add('bg-violet-600', 'hover:bg-violet-700');
                    toggleBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg> Exit Bulk Edit';
                } else {
                    toggleBtn.classList.remove('bg-violet-600', 'hover:bg-violet-700');
                    toggleBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    toggleBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" /></svg> Bulk Edit Mode';
                }
            }

            if (bulkActions) {
                bulkActions.classList.toggle('hidden', !reliabilityBulkEditMode);
            }

            if (selectedCount) {
                selectedCount.textContent = '0';
            }

            renderReliabilityMatrix();
        }

        function toggleCellSelection(tmId, dateString, event) {
            if (!reliabilityBulkEditMode) return;

            event.stopPropagation();
            const cellKey = `${tmId}-${dateString}`;

            if (reliabilitySelectedCells.has(cellKey)) {
                reliabilitySelectedCells.delete(cellKey);
            } else {
                if (event.ctrlKey || event.metaKey) {
                    reliabilitySelectedCells.add(cellKey);
                } else {
                    reliabilitySelectedCells.clear();
                    reliabilitySelectedCells.add(cellKey);
                }
            }

            updateBulkSelectionCount();
            renderReliabilityMatrix();
        }

        function clearBulkSelection() {
            reliabilitySelectedCells.clear();
            updateBulkSelectionCount();
            renderReliabilityMatrix();
        }

        function updateBulkSelectionCount() {
            const selectedCount = document.getElementById('reliabilitySelectedCount');
            if (selectedCount) {
                selectedCount.textContent = reliabilitySelectedCells.size;
            }
        }

        function applyBulkStatus(status) {
            if (reliabilitySelectedCells.size === 0) return;

            const count = reliabilitySelectedCells.size;

            reliabilitySelectedCells.forEach(cellKey => {
                const [tmId, dateString] = cellKey.split('-');
                updateAttendanceStatus(dateString, parseInt(tmId), status);
            });

            reliabilitySelectedCells.clear();
            updateBulkSelectionCount();
            renderReliabilityMatrix();

            if (typeof showToast === 'function') {
                showToast(`Status applied to ${count} cell${count !== 1 ? 's' : ''}`, 'success');
            }
        }

        function showContextMenu(event, tmId, dateString) {
            event.preventDefault();
            event.stopPropagation();

            reliabilityContextMenuCell = { tmId, dateString };

            const menu = document.getElementById('reliabilityContextMenu');
            if (!menu) return;

            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
        }

        function hideContextMenu() {
            const menu = document.getElementById('reliabilityContextMenu');
            if (menu) menu.style.display = 'none';
            reliabilityContextMenuCell = null;
        }

        function contextMenuSetStatus(status) {
            if (!reliabilityContextMenuCell) return;

            const { tmId, dateString } = reliabilityContextMenuCell;
            updateAttendanceStatus(dateString, tmId, status);
            renderReliabilityMatrix();
            hideContextMenu();
        }

        function addRippleEffect(element) {
            if (!element) return;
            element.classList.add('ripple-effect');
            setTimeout(() => {
                if (element) element.classList.remove('ripple-effect');
            }, 600);
        }

        // Close context menu on click outside (initialize once)
        if (!window.reliabilityContextMenuInitialized) {
            document.addEventListener('click', hideContextMenu);
            document.addEventListener('contextmenu', (e) => {
                const menu = document.getElementById('reliabilityContextMenu');
                if (menu && !menu.contains(e.target)) {
                    hideContextMenu();
                }
            });
            window.reliabilityContextMenuInitialized = true;
        }

        function toggleAttendanceStatus(tmId, dateString) {
            const history = getAttendanceHistory();
            const currentStatus = history[dateString]?.[tmId];

            // Cycle: empty  present  late  unplanned  pto  empty
            let nextStatus;
            if (!currentStatus) {
                nextStatus = 'present';
            } else if (currentStatus === 'present') {
                nextStatus = 'late';
            } else if (currentStatus === 'late') {
                nextStatus = 'unplanned';
            } else if (currentStatus === 'unplanned') {
                nextStatus = 'pto';
            } else if (currentStatus === 'pto') {
                nextStatus = null; // Empty
            }

            updateAttendanceStatus(dateString, tmId, nextStatus);
            renderReliabilityMatrix();
        }

        function renderReliabilityMatrix() {
            const grid = document.getElementById('reliabilityMatrixGrid');
            const monthDisplay = document.getElementById('reliabilityMonthDisplay');
            if (!grid) return;

            const year = currentReliabilityMonth.getFullYear();
            const month = currentReliabilityMonth.getMonth();
            const daysInMonth = getDaysInMonth(year, month);
            const history = getAttendanceHistory();
            const today = new Date();
            const todayDateString = getTodayShort();

            // Update month display
            if (monthDisplay) {
                monthDisplay.textContent = currentReliabilityMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            }

            // Get active team members and apply filters
            let teamMembers = appData.team.filter(t => t.active);

            // Apply search filter
            if (reliabilityFilterSearch) {
                teamMembers = teamMembers.filter(t =>
                    t.name.toLowerCase().includes(reliabilityFilterSearch)
                );
            }

            // Apply account filter
            if (reliabilityFilterAccount && reliabilityFilterAccount !== 'all') {
                teamMembers = teamMembers.filter(t => (t.account || 'Unassigned') === reliabilityFilterAccount);
            }

            // Apply status filter (unplanned)
            if (reliabilityFilterStatus === 'unplanned') {
                teamMembers = teamMembers.filter(tm => {
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        if (history[dateString]?.[tm.id] === 'unplanned') {
                            return true;
                        }
                    }
                    return false;
                });
            }

            // Calculate scores and create array with scores
            let teamMembersWithScores = teamMembers.map(tm => ({
                ...tm,
                score: calculateScore(tm.id, year, month)
            }));

            // Sort based on selected option
            if (reliabilitySortBy === 'score-asc') {
                teamMembersWithScores.sort((a, b) => a.score - b.score);
            } else if (reliabilitySortBy === 'score-desc') {
                teamMembersWithScores.sort((a, b) => b.score - a.score);
            } else {
                teamMembersWithScores.sort((a, b) => a.name.localeCompare(b.name));
            }

            teamMembers = teamMembersWithScores;

            // Build grid HTML
            let html = '';

            // Header row with day numbers (sticky top)
            html += '<div class="flex flex-nowrap border-b-2 border-slate-300 sticky top-0 z-40 bg-slate-50 dark:bg-slate-900">';

            // Corner cell (Team Member label) - sticky top-left
            html += '<div class="w-56 font-bold text-xs text-slate-500 uppercase tracking-wider flex items-center justify-center px-4 py-3 border-r-2 border-slate-300 sticky left-0 z-50 bg-slate-50 dark:bg-slate-900 flex-shrink-0">Team Member</div>';

            // Day numbers row
            html += '<div class="flex flex-nowrap">';
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                const isWeekendDay = dayOfWeek === 0 || dayOfWeek === 6;
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateString === todayDateString;
                const dateObj = new Date(year, month, day);
                const isFuture = dateObj > today;

                let headerClass = 'matrix-cell-size flex items-center justify-center text-[10px] font-bold flex-shrink-0';
                if (isToday) {
                    headerClass += ' ring-2 ring-violet-500 text-violet-600 font-bold rounded-md bg-violet-50/50';
                } else if (isWeekendDay) {
                    headerClass += ' text-slate-400 bg-slate-50/50';
                } else {
                    headerClass += ' text-slate-500';
                }

                html += `<div class="${headerClass}">${day}</div>`;
            }
            html += '</div></div>';

            // Helper function to get status label
            function getStatusLabel(status) {
                const labels = {
                    'present': 'Present',
                    'late': 'Late',
                    'unplanned': 'Unplanned',
                    'pto': 'PTO'
                };
                return labels[status] || 'Empty';
            }

            // Helper function to format date for tooltip
            function formatDateForTooltip(dateString) {
                const d = new Date(dateString + 'T12:00:00');
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            // Team member rows
            teamMembers.forEach(tm => {
                const score = tm.score; // Score already calculated in teamMembersWithScores
                const scoreColorClass = score >= 90 ? 'text-green-600' : score >= 75 ? 'text-amber-600' : 'text-red-600';

                html += '<div class="flex flex-nowrap border-b border-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800/50 group">';

                // Name column (sticky left) - hover effect applied via group
                html += `<div class="w-56 font-semibold text-sm text-slate-800 dark:text-slate-200 flex items-center gap-2 px-4 py-3 border-r-2 border-slate-300 sticky left-0 z-30 bg-white dark:bg-slate-900 flex-shrink-0 group-hover:bg-slate-50 dark:group-hover:bg-slate-800/50 transition-colors">`;
                html += `<span class="truncate">${tm.name}</span>`;
                html += `<span class="text-xs font-bold flex-shrink-0 ${scoreColorClass}">${score}%</span>`;
                html += `</div>`;

                // Day cells row
                html += '<div class="flex flex-nowrap">';
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay();
                    const isWeekendDay = dayOfWeek === 0 || dayOfWeek === 6;
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const status = history[dateString]?.[tm.id];
                    const dateObj = new Date(year, month, day);
                    const isFuture = dateObj > today;
                    const isToday = dateString === todayDateString;

                    // Build tooltip
                    const statusLabel = status ? getStatusLabel(status) : 'Empty';
                    const dateLabel = formatDateForTooltip(dateString);
                    const tooltip = `${tm.name} - ${dateLabel}: ${statusLabel}`;

                    let cellClass = 'matrix-cell-size rounded border flex-shrink-0 flex items-center justify-center relative reliability-tile';
                    let cellBg = '';
                    let cellStyle = '';

                    if (isFuture) {
                        cellBg = 'tile-future';
                        cellClass += ' cursor-not-allowed';
                    } else if (isWeekendDay) {
                        cellBg = 'bg-slate-100 dark:bg-slate-800/50 opacity-40';
                        cellClass += ' cursor-not-allowed';
                    } else {
                        cellClass += ' cursor-pointer';

                        if (status === 'present') {
                            cellBg = 'tile-present';
                        } else if (status === 'late') {
                            cellBg = 'tile-late';
                        } else if (status === 'unplanned') {
                            cellBg = 'tile-unplanned';
                        } else if (status === 'pto') {
                            cellBg = 'tile-pto';
                        } else {
                            cellBg = 'tile-empty';
                            // Add subtle tint for today column if empty
                            if (isToday) {
                                cellClass += ' ring-2 ring-inset ring-violet-500/30';
                            }
                        }
                    }

                    const cellKey = `${tm.id}-${dateString}`;
                    const isSelected = reliabilitySelectedCells.has(cellKey);

                    if (isSelected) {
                        cellClass += ' reliability-cell-selected';
                    }

                    const styleAttr = cellStyle ? ` style="${cellStyle}"` : '';
                    const titleAttr = ` title="${tooltip.replace(/"/g, '&quot;')}"`;
                    const dataKey = ` data-cell-key="${cellKey}"`;

                    if (isFuture || isWeekendDay) {
                        html += `<div class="${cellClass} ${cellBg}"${styleAttr}${titleAttr}${dataKey}></div>`;
                    } else {
                        let onClickHandler = '';
                        let onContextMenuHandler = '';

                        if (reliabilityBulkEditMode) {
                            onClickHandler = `onclick="toggleCellSelection(${tm.id}, '${dateString}', event); addRippleEffect(this)"`;
                        } else {
                            onClickHandler = `onclick="toggleAttendanceStatus(${tm.id}, '${dateString}'); addRippleEffect(this)"`;
                            onContextMenuHandler = `oncontextmenu="showContextMenu(event, ${tm.id}, '${dateString}')"`;
                        }

                        html += `<div ${onClickHandler} ${onContextMenuHandler} class="${cellClass} ${cellBg}"${styleAttr}${titleAttr}${dataKey}></div>`;
                    }
                }
                html += '</div></div>';
            });

            grid.innerHTML = html;
        }

        // PulseCheck Modals
        function openCheckinModal(id) {
            const tm = appData.team.find(t => t.id === id);
            if (!tm) return;
            document.getElementById('modalTmId').value = id;
            document.getElementById('modalTmName').textContent = tm.name;
            document.getElementById('modalTmAccountRole').textContent = `${tm.account} - ${tm.role}`;
            document.getElementById('checkinForm').reset();

            // SET DEFAULT DATE TO TODAY (Local Time)
            const today = new Date();
            const localIso = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            document.getElementById('checkinDate').value = localIso;
            updateDateInput(document.getElementById('checkinDate'));

            const k = getMonthKey(currentDate);

            const chk = appData.checkins[k]?.[id];
            if (chk) {
                document.getElementById('checkinDate').value = chk.date;
                updateDateInput(document.getElementById('checkinDate'));
                document.getElementById('checkinNotes').value = chk.notes;
                const r = document.querySelector(`input[name="sentiment"][value="${chk.sentiment}"]`);
                if (r) r.checked = true;
            }

            // EWS
            const ews = appData.ewsHistory[k]?.[id] || tm.ews || 'green';
            document.getElementById('checkinEws').value = ews;

            toggleModal('checkinModal');
        }

        function saveCheckin(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('modalTmId').value);
            const date = document.getElementById('checkinDate').value;
            const sentiment = document.querySelector('input[name="sentiment"]:checked').value;
            const notes = document.getElementById('checkinNotes').value;
            const ews = document.getElementById('checkinEws').value;

            // FIX: Force Noon to ensure the Month Key matches the Date picked (prevents Timezone offset)
            const k = getMonthKey(new Date(date + 'T12:00:00'));
            if (!appData.checkins[k]) appData.checkins[k] = {};
            appData.checkins[k][id] = { date, sentiment, notes };

            // Save EWS History
            if (!appData.ewsHistory[k]) appData.ewsHistory[k] = {};
            appData.ewsHistory[k][id] = ews;

            // Update current EWS on roster if this month is current
            if (k === getMonthKey(new Date())) {
                const tm = appData.team.find(t => t.id === id);
                if (tm) tm.ews = ews;
            }

            saveData(); toggleModal('checkinModal');
            showToast("Check-in saved", "success");
        }
        function toggleCheckinModal() { toggleModal('checkinModal'); }
        function clearCheckin() {
            const id = parseInt(document.getElementById('modalTmId').value);
            const date = document.getElementById('checkinDate').value;
            const k = getMonthKey(new Date(date));
            if (appData.checkins[k]?.[id] && confirm("Delete check-in?")) {
                delete appData.checkins[k][id];
                saveData(); toggleModal('checkinModal');
                showToast("Check-in deleted", "success");
            }
        }

        function openEwsModal(id) { document.getElementById('ewsTmId').value = id; toggleModal('ewsModal'); }
        function toggleEwsModal() { toggleModal('ewsModal'); }
        function saveEwsStatus(s) {
            const id = parseInt(document.getElementById('ewsTmId').value);
            const tm = appData.team.find(t => t.id === id);
            if (tm) {
                tm.ews = s;
                const k = getMonthKey(new Date());
                if (!appData.ewsHistory[k]) appData.ewsHistory[k] = {};
                appData.ewsHistory[k][id] = s;
                saveData(); toggleEwsModal();
                showToast("EWS status updated", "success");
            }
        }

        function openHistoryModal(id) {
            const tm = appData.team.find(t => t.id === id);
            if (!tm) return;
            document.getElementById('historyTmName').textContent = tm.name;
            document.getElementById('historyTmRole').textContent = tm.role;

            const list = document.getElementById('historyList');
            list.innerHTML = '';

            // Last 6 months history
            let historyData = [];
            let d = new Date(); d.setDate(1);
            for (let i = 0; i < 6; i++) {
                const k = getMonthKey(d);
                const c = appData.checkins[k]?.[id];
                if (c) {
                    historyData.push(c);
                    list.innerHTML += `
                    <div class="border p-3 rounded mb-2">
                        <div class="flex justify-between font-bold text-sm">
                            <span>${k}</span>
                            <span class="uppercase text-xs px-2 rounded bg-slate-100">${c.sentiment}</span>
                        </div>
                        <p class="text-xs mt-1 italic text-slate-600">${c.notes}</p>
                    </div>`;
                }
                d.setMonth(d.getMonth() - 1);
            }
            // Chart logic omitted for brevity, assuming Chart.js is loaded
            toggleModal('historyModal');
        }
        function toggleHistoryModal() { toggleModal('historyModal'); }

        function openAttendanceDetails(id, status) {
            currentAttendanceTmId = id;
            const tm = appData.team.find(t => t.id === id);
            if (!tm) return;
            document.getElementById('attendanceSubtitle').textContent = `For ${tm.name} (${status})`;

            const k = getTodayShort();
            const rc = appData.rollCall[k]?.[id] || {};

            // Set defaults based on status
            if (status === 'absent') {
                document.getElementById('reasonSelect').value = rc.reason || 'sick';
                document.getElementById('statusInput').value = rc.currentStatus || 'Resting';
            } else if (status === 'late') {
                document.getElementById('reasonSelect').value = rc.reason || 'power';
                document.getElementById('statusInput').value = rc.currentStatus || 'Standing by for power restoration';
            }

            document.getElementById('clientNotifiedCheck').checked = !!rc.notified;
            toggleModal('attendanceDetailsModal');
        }

        function handleReasonChange() {
            const reason = document.getElementById('reasonSelect').value;
            const statusInput = document.getElementById('statusInput');
            
            // Auto-set status based on reason if empty
            if (!statusInput.value || statusInput.value === 'Resting') {
                if (reason === 'power') {
                    statusInput.value = 'Standing by for power restoration';
                } else if (reason === 'internet') {
                    statusInput.value = 'Standing by for internet restoration';
                } else if (reason === 'sick') {
                    statusInput.value = 'Resting and recovering';
                } else if (reason === 'emergency') {
                    statusInput.value = 'Handling personal emergency';
                }
            }
        }

        function applyQuickStatus() {
            const val = document.getElementById('quickStatusSelect').value;
            if (val) {
                document.getElementById('statusInput').value = val;
            }
        }

        function saveAttendanceDetails() {
            const id = currentAttendanceTmId;
            const k = getTodayShort();
            if (!appData.rollCall[k]) appData.rollCall[k] = {};
            if (!appData.rollCall[k][id]) appData.rollCall[k][id] = {};

            appData.rollCall[k][id].reason = document.getElementById('reasonSelect').value;
            appData.rollCall[k][id].currentStatus = document.getElementById('statusInput').value;
            appData.rollCall[k][id].notified = document.getElementById('clientNotifiedCheck').checked;

            saveData();
            toggleModal('attendanceDetailsModal');
            renderRollCallView();
            syncRollCallToCapacity(id, appData.rollCall[k][id].status);
            showToast("Attendance details saved", "success");
        }

        function copyPocEmail(event, email, buttonElement) {
            event.stopPropagation();
            navigator.clipboard.writeText(email).then(() => {
                showToast("Email copied", "success");

                // Visual Cue: Change icon to checkmark
                const originalHTML = buttonElement.innerHTML;
                buttonElement.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                `;
                buttonElement.classList.add('bg-green-50');

                // Revert after 2 seconds
                setTimeout(() => {
                    buttonElement.innerHTML = originalHTML;
                    buttonElement.classList.remove('bg-green-50');
                }, 2000);

            }).catch(err => {
                console.error('Failed to copy email: ', err);
                showToast("Failed to copy email", "error");
            });
        }

        function toggleSnapshotMode() {
            const todayKey = getTodayShort();
            document.getElementById('snapshotDate').textContent = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const content = document.getElementById('snapshotContent');
            if (!content) return;
            content.innerHTML = '';

            const data = appData.rollCall[todayKey] || {};
            let s = { present: 0, late: 0, absent: 0, pto: 0, pending: 0 };
            const activeTeam = appData.team.filter(tm => tm.active);

            activeTeam.forEach(tm => {
                const stat = data[tm.id]?.status || 'pending';
                if (s[stat] !== undefined) s[stat]++;
            });

            content.innerHTML += `<div class="flex justify-center gap-2 md:gap-4 text-center mb-8">
            <div class="bg-green-50 p-3 rounded-lg border border-green-100 w-20 md:w-24"><div class="text-xl md:text-2xl font-extrabold text-green-600">${s.present}</div><div class="text-[10px] font-bold text-green-800 uppercase">Present</div></div>
            <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 w-20 md:w-24"><div class="text-xl md:text-2xl font-extrabold text-yellow-600">${s.late}</div><div class="text-[10px] font-bold text-yellow-800 uppercase">Late</div></div>
            <div class="bg-red-50 p-3 rounded-lg border border-red-100 w-20 md:w-24"><div class="text-xl md:text-2xl font-extrabold text-red-600">${s.absent}</div><div class="text-[10px] font-bold text-red-800 uppercase">Absent</div></div>
            <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 w-20 md:w-24"><div class="text-xl md:text-2xl font-extrabold text-purple-600">${s.pto}</div><div class="text-[10px] font-bold text-purple-800 uppercase">PTO</div></div>
            ${s.pending > 0 ? `<div class="bg-slate-50 p-3 rounded-lg border border-slate-200 w-20 md:w-24"><div class="text-xl md:text-2xl font-extrabold text-slate-400">${s.pending}</div><div class="text-[10px] font-bold text-slate-500 uppercase">Pending</div></div>` : ''}
        </div>`;

            let exceptionsHtml = '';
            activeTeam.forEach(tm => {
                const r = data[tm.id];
                if (r && r.status && r.status !== 'present') {
                    let color = 'slate';
                    if (r.status === 'late') color = 'yellow';
                    else if (r.status === 'absent') color = 'red';
                    else if (r.status === 'pto') color = 'purple';

                    const reasonDisplay = formatReason(r.reason);
                    const statusDisplay = r.currentStatus ? `  ${r.currentStatus}` : '';
                    const notifiedDisplay = r.notified
                        ? '<span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded-full"> Notified</span>'
                        : '<span class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded-full"> Pending</span>';

                    exceptionsHtml += `
                    <div class="flex justify-between items-start py-3 border-b border-slate-100 last:border-0">
                        <div>
                            <span class="font-bold text-slate-700 mr-2">${tm.name}</span>
                            <span class="text-xs px-2 py-1 rounded-full font-bold bg-${color}-100 text-${color}-800 uppercase tracking-wider">${r.status}</span>
                            <div class="text-sm text-slate-500 mt-1">${reasonDisplay}${statusDisplay}</div>
                        </div>
                        <div class="flex items-center flex-shrink-0 ml-2">
                           ${notifiedDisplay}
                        </div>
                    </div>`;
                }
            });

            if (exceptionsHtml === '') {
                content.innerHTML += `<div class="text-center py-6 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 text-slate-400 font-medium"> Full Attendance!</div>`;
            } else {
                content.innerHTML += `<div class="bg-white rounded-xl border border-slate-200 p-4">${exceptionsHtml}</div>`;
            }

            toggleModal('snapshotModal');
        }

        function formatReason(reason) {
            if (!reason) return 'N/A';
            const reasonMap = {
                'sick': 'Sick / Unwell',
                'power': 'Power Outage',
                'internet': 'Internet/ISP Issues',
                'emergency': 'Family/Personal Emergency',
                'pto': 'Planned Leave / PTO',
                'other': 'Other'
            };
            return reasonMap[reason] || reason.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        }

        function jumpToMemberLogs(tmId) {
            // 1. Close any open modals
            const contextModal = document.getElementById('tmContextModal');
            if (contextModal && !contextModal.classList.contains('opacity-0')) {
                toggleModal('tmContextModal');
            }

            // 2. Navigate to Logbook
            switchTool('ActionHub');
            switchTab('logbook');

            // 3. Apply Filter for this user
            const tmSelect = document.getElementById('lbFilterTm');
            const typeSelect = document.getElementById('lbFilterType');
            const statusSelect = document.getElementById('lbFilterStatus');

            if (tmSelect) {
                // Ensure options are populated if empty
                if (tmSelect.options.length <= 1) {
                    appData.team.filter(t => t.active).sort((a, b) => a.name.localeCompare(b.name)).forEach(tm => {
                        const opt = document.createElement('option');
                        opt.value = tm.id;
                        opt.textContent = tm.name;
                        tmSelect.appendChild(opt);
                    });
                }
                // Set value
                tmSelect.value = tmId;
            }

            // Set additional filters as requested
            if (typeSelect) typeSelect.value = 'actionable';
            if (statusSelect) statusSelect.value = 'Open';

            renderLogbook();
        }

        // --- 360 VIEW (CONTEXT MODAL) ---
        let ctxScoreTrendChartInstance = null;
        let ctxVibeTrendChartInstance = null;

        function openContextModal(tmId) {
            const tm = appData.team.find(t => t.id === tmId);
            if (!tm) return;

            // Update member info
            document.getElementById('ctxName').textContent = tm.name;
            document.getElementById('ctxRole').textContent = `${tm.role}  ${tm.account}`;
            document.getElementById('ctxVibeIcon').textContent = '';

            // Update EWS Badge
            const ews = tm.ews || 'green';
            const ewsBadge = document.getElementById('ctxEwsBadge');
            if (ews === 'green') {
                ewsBadge.className = 'px-2 py-0.5 rounded text-xs font-bold border uppercase tracking-wider bg-green-100 text-green-700 border-green-200';
                ewsBadge.textContent = 'EWS: Green';
            } else if (ews === 'amber') {
                ewsBadge.className = 'px-2 py-0.5 rounded text-xs font-bold border uppercase tracking-wider bg-amber-100 text-amber-700 border-amber-200';
                ewsBadge.textContent = 'EWS: Amber';
            } else {
                ewsBadge.className = 'px-2 py-0.5 rounded text-xs font-bold border uppercase tracking-wider bg-red-100 text-red-700 border-red-200';
                ewsBadge.textContent = 'EWS: Red';
            }

            // Update POC Badge
            document.getElementById('ctxPocBadge').textContent = tm.poc ? `POC: ${tm.poc}` : 'POC: -';

            // Render Score Trend Chart (Last 6 months)
            renderContextScoreTrend(tm);

            // Render Vibe Trend Chart (Last 6 months)
            renderContextVibeTrend(tm);

            // Render Recent Check-ins (Last 3 months only)
            renderContextCheckins(tm);

            // Render Logbook Entries (Last 6)
            renderContextLogbook(tm);

            // Store current TM ID for logbook navigation
            document.getElementById('ctxTmId').value = tmId;

            // Open modal
            toggleModal('tmContextModal');
        }

        function renderContextScoreTrend(tm) {
            const isDark = document.body.classList.contains('dark-mode');
            let labels = [], scores = [];
            let d = new Date();
            d.setDate(1);

            // Get last 6 months
            for (let i = 5; i >= 0; i--) {
                let p = new Date(d);
                p.setMonth(p.getMonth() - i);
                const monthKey = `${["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][p.getMonth()]} '${p.getFullYear().toString().slice(-2)}`;
                labels.push(p.toLocaleDateString('en-US', { month: 'short' }));

                // Find performance score for this month
                const entry = (tm.history || []).find(h => h.month === monthKey && !h.isStrategyEntry);
                scores.push(entry && entry.finalScore ? entry.finalScore : null);
            }

            // Destroy existing chart
            if (ctxScoreTrendChartInstance) ctxScoreTrendChartInstance.destroy();

            const ctx = document.getElementById('ctxScoreTrendChart').getContext('2d');

            // Create gradient - same style as Vibe Trend
            const gradient = ctx.createLinearGradient(0, 0, 0, 130);
            if (isDark) {
                gradient.addColorStop(0, 'rgba(56, 189, 248, 0.4)');
                gradient.addColorStop(1, 'rgba(56, 189, 248, 0.0)');
            } else {
                gradient.addColorStop(0, 'rgba(0, 80, 157, 0.3)');
                gradient.addColorStop(1, 'rgba(0, 80, 157, 0.0)');
            }

            const gridColor = isDark ? '#334155' : '#f1f5f9';
            const tickColor = isDark ? '#94a3b8' : '#64748b';
            const lineColor = isDark ? '#38bdf8' : '#00509D';
            const pointBg = isDark ? '#0f172a' : '#ffffff';

            ctxScoreTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score',
                        data: scores,
                        borderColor: lineColor,
                        backgroundColor: gradient,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: pointBg,
                        pointBorderColor: lineColor,
                        pointBorderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 1,
                            max: 5,
                            grid: { color: gridColor },
                            ticks: {
                                color: tickColor,
                                font: { size: 10 }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: tickColor, font: { size: 10 } }
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                            titleColor: isDark ? '#f8fafc' : '#1e293b',
                            bodyColor: isDark ? '#cbd5e1' : '#475569',
                            borderColor: isDark ? '#334155' : '#e2e8f0',
                            borderWidth: 1,
                            padding: 8,
                            displayColors: false
                        },
                        legend: { display: false }
                    }
                }
            });
        }

        function renderContextVibeTrend(tm) {
            const isDark = document.body.classList.contains('dark-mode');
            let keys = [], labels = [], vibes = [];
            let d = new Date();
            d.setDate(1);

            // Get last 6 months
            for (let i = 5; i >= 0; i--) {
                let p = new Date(d);
                p.setMonth(p.getMonth() - i);
                const monthKey = getMonthKey(p);
                labels.push(p.toLocaleDateString('en-US', { month: 'short' }));

                // Find check-in for this month
                const checkin = appData.checkins[monthKey]?.[tm.id];
                if (checkin) {
                    const val = checkin.sentiment === 'good' ? 3 : (checkin.sentiment === 'mid' ? 2 : 1);
                    vibes.push(val);
                } else {
                    vibes.push(null);
                }
            }

            // Destroy existing chart
            if (ctxVibeTrendChartInstance) ctxVibeTrendChartInstance.destroy();

            const ctx = document.getElementById('ctxTrendChart').getContext('2d');

            // Create gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 130);
            if (isDark) {
                gradient.addColorStop(0, 'rgba(56, 189, 248, 0.4)');
                gradient.addColorStop(1, 'rgba(56, 189, 248, 0.0)');
            } else {
                gradient.addColorStop(0, 'rgba(0, 80, 157, 0.3)');
                gradient.addColorStop(1, 'rgba(0, 80, 157, 0.0)');
            }

            const gridColor = isDark ? '#334155' : '#f1f5f9';
            const tickColor = isDark ? '#94a3b8' : '#64748b';
            const lineColor = isDark ? '#38bdf8' : '#00509D';
            const pointBg = isDark ? '#0f172a' : '#ffffff';

            ctxVibeTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Vibe',
                        data: vibes,
                        borderColor: lineColor,
                        backgroundColor: gradient,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: pointBg,
                        pointBorderColor: lineColor,
                        pointBorderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 1,
                            max: 3,
                            grid: { color: gridColor },
                            ticks: {
                                color: tickColor,
                                font: { size: 10 },
                                callback: v => v === 3 ? '' : (v === 2 ? '' : (v === 1 ? '' : ''))
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: tickColor, font: { size: 10 } }
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                            titleColor: isDark ? '#f8fafc' : '#1e293b',
                            bodyColor: isDark ? '#cbd5e1' : '#475569',
                            borderColor: isDark ? '#334155' : '#e2e8f0',
                            borderWidth: 1,
                            padding: 8,
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    if (context.parsed.y === null) return 'No data';
                                    const val = context.parsed.y;
                                    const emoji = val >= 2.5 ? '' : (val >= 1.5 ? '' : '');
                                    return `Vibe: ${emoji}`;
                                }
                            }
                        },
                        legend: { display: false }
                    }
                }
            });
        }

        function renderContextCheckins(tm) {
            const list = document.getElementById('ctxCheckinList');
            list.innerHTML = '';

            let d = new Date();
            d.setDate(1);
            let checkinsFound = [];

            // Look back up to 12 months to find the last 3 check-ins with data
            for (let i = 0; i < 12 && checkinsFound.length < 3; i++) {
                let p = new Date(d);
                p.setMonth(p.getMonth() - i);
                const monthKey = getMonthKey(p);
                const checkin = appData.checkins[monthKey]?.[tm.id];

                if (checkin) {
                    const emoji = checkin.sentiment === 'good' ? '' : (checkin.sentiment === 'mid' ? '' : '');
                    const color = checkin.sentiment === 'good' ? 'text-green-600' : (checkin.sentiment === 'mid' ? 'text-yellow-600' : 'text-red-600');
                    const label = checkin.sentiment === 'good' ? 'Positive' : (checkin.sentiment === 'mid' ? 'Neutral' : 'Concerning');

                    checkinsFound.push({
                        emoji,
                        color,
                        label,
                        date: p.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
                        notes: checkin.notes
                    });
                }
            }

            // Render the found check-ins
            checkinsFound.forEach(item => {
                list.innerHTML += `
                    <div class="p-2 hover:bg-slate-50 rounded-lg transition-colors cursor-pointer">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${item.emoji}</span>
                                <span class="text-xs font-bold ${item.color}">${item.label}</span>
                            </div>
                            <span class="text-xs text-slate-400">${item.date}</span>
                        </div>
                        ${item.notes ? `<p class="text-xs text-slate-500 mt-1 ml-7 line-clamp-2">${item.notes}</p>` : ''}
                    </div>
                `;
            });

            if (checkinsFound.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-400 text-xs py-4">No recent check-ins found</div>';
            }
        }

        function renderContextLogbook(tm) {
            const list = document.getElementById('ctxLogList');
            list.innerHTML = '';

            const entries = appData.logbook
                .filter(e => e.tmId === tm.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 6);

            if (entries.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-400 text-xs py-4">No logbook entries</div>';
                return;
            }

            entries.forEach(entry => {
                const typeColors = {
                    'issue': 'bg-red-50 text-red-700 border-red-200 dark:bg-red-900/30 dark:border-red-800',
                    'request': 'bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:border-blue-800',
                    'kudos': 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/30 dark:border-green-800',
                    'note': 'bg-slate-50 text-slate-600 border-slate-300 dark:bg-slate-800 dark:border-slate-600'
                };
                const typeIcons = { 'issue': '', 'request': '', 'kudos': '', 'note': '' };

                const color = typeColors[entry.type] || typeColors['note'];
                const icon = typeIcons[entry.type] || typeIcons['note'];

                // Added border-slate-300 for clearer definition
                list.innerHTML += `
            <div class="p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 hover:border-slate-400 transition-colors shadow-sm">
                <div class="flex items-start justify-between mb-1">
                    <span class="px-2 py-0.5 rounded text-xs font-bold border ${color}">${icon} ${entry.type}</span>
                    <span class="text-xs text-slate-400 font-mono">${formatDate(entry.date)}</span>
                </div>
                <p class="text-sm text-slate-800 dark:text-slate-200 font-semibold mt-2">${entry.title}</p>
            </div>
        `;
            });
        }



        // --- CLOCK & TIMEZONE LOGIC ---
        let currentTimezoneIndex = 0;
        // "null" zone means use the User's Local PC time
        const timezones = [
            { label: 'PC', zone: null },
            { label: 'PH', zone: 'Asia/Manila' },
            { label: 'CST', zone: 'America/Chicago' },
            { label: 'EST', zone: 'America/New_York' },
            { label: 'PST', zone: 'America/Los_Angeles' }
        ];

        function rotateTimezone() {
            currentTimezoneIndex = (currentTimezoneIndex + 1) % timezones.length;
            updateClockDisplay(); // Update immediately on click
        }

        function updateClockDisplay() {
            const el = document.getElementById('osClock');
            if (!el) return;

            const tz = timezones[currentTimezoneIndex];
            const now = new Date();

            // Config: Hour/Minute
            const timeOptions = {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };

            // Config: Date (Critical for cross-timezone days)
            const dateOptions = {
                month: 'short',
                day: 'numeric'
            };

            // Apply Timezone if it's not the default "PC" setting
            if (tz.zone) {
                timeOptions.timeZone = tz.zone;
                dateOptions.timeZone = tz.zone;
            }

            try {
                const timePart = now.toLocaleTimeString('en-US', timeOptions);
                const datePart = now.toLocaleDateString('en-US', dateOptions);

                // Render: Grey Date | White Time | Purple Tag
                el.innerHTML = `
                <span class="text-slate-500 mr-2 font-normal border-r border-slate-600 pr-2">${datePart}</span>
                <span class="tracking-wide text-white mr-2">${timePart}</span>
                <span class="text-[10px] font-bold text-hub-300 bg-hub-500/20 px-1.5 py-0.5 rounded border border-hub-500/30 tracking-wider">${tz.label}</span>
            `;
            } catch (e) {
                console.error("Timezone error", e);
                el.innerText = "--:--";
            }
        }

        function startOsClock() {
            updateClockDisplay();
            setInterval(updateClockDisplay, 1000);
        }

        // ==========================================
        // BACK TO TOP BUTTON & STICKY TABS
        // ==========================================
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Throttle function for scroll performance
        function throttle(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Handle scroll detection for back-to-top button and sticky tabs shadow
        const handleScroll = throttle(() => {
            const scrollY = window.scrollY || window.pageYOffset;
            const backToTopBtn = document.getElementById('backToTopBtn');
            const stickyTabsContainers = document.querySelectorAll('.sticky-tabs-container');

            // Show/hide back-to-top button
            if (backToTopBtn) {
                if (scrollY > 300) {
                    backToTopBtn.classList.remove('opacity-0', 'pointer-events-none');
                    backToTopBtn.classList.add('opacity-100', 'pointer-events-auto');
                } else {
                    backToTopBtn.classList.add('opacity-0', 'pointer-events-none');
                    backToTopBtn.classList.remove('opacity-100', 'pointer-events-auto');
                }
            }

            // Add shadow to sticky tabs when scrolled
            stickyTabsContainers.forEach(container => {
                if (scrollY > 100) {
                    container.classList.add('scrolled');
                } else {
                    container.classList.remove('scrolled');
                }
            });
        }, 50); // Throttle to every 50ms for smooth performance

        // ==========================================
        // AI ASSISTANT - CONFIGURATION & LOGIC
        // ==========================================

        // Conversation history for chat mode
        let aiConversationHistory = [];
        let currentAIMode = 'insights'; // 'insights', 'chat', 'settings'
        let cachedInsights = null; // Cache AI insights to avoid re-analyzing every time
        let lastAnalysisTime = null; // Track when insights were last generated

        // 1. REPORT MODE: Strict, structured, data-driven (For Morning Briefs)
        const AI_REPORT_PROMPT = `You are an executive auditor for a Team Manager using Leadership OS.
Your job is to analyze the provided JSON data deeply and output a structured "Morning Briefing".

STRUCTURE YOUR RESPONSE EXACTLY LIKE THIS:
- Morning Brief (Bullet points of critical items, status, immediate needs)
- Blind Spots (Risks, coverage gaps, or anomalies in the data)
- Proactive Questions (1-2 sharp, strategic questions based on the data)
- Recommended Actions (Specific, immediate steps)
- Patterns (One significant trend if observed)

TONE: Concise, efficiency-focused, no fluff. Do not use conversational filler. Use the data to be factually accurate.`;

        // 2. CHAT MODE: Empathetic, conversational, adaptive (For Chat Tab)
        const AI_CHAT_PROMPT = `You are Garshu, a loyal, intelligent, and empathetic leadership assistant.
Your goal is to be the manager's "Second Brain" and "Safe Space."

CORE BEHAVIORS:
1. **The Analyst:** If asked about specific data (e.g., "Who is sick?", "attendance stats"), look at the provided JSON context and answer accurately and briefly.
2. **The Sounding Board:** If the manager is ranting, venting, or brainstorming (e.g., "I'm frustrated with...", "What do you think about..."):
   - LISTEN first. Validate their feelings (e.g., "That sounds incredibly draining.").
   - Do NOT rush to "fix" it unless asked. Sometimes they just need to vent.
   - Offer a balanced perspective or a strategic question to help them clarify their thoughts.
   - Be casual and conversational (like a trusted co-worker), not robotic.

TONE:
- Professional but warm and human-like.
- Candid and direct when needed.
- Use natural language (no bullet points unless requested or listing data).

CONTEXT: You have access to the team's data below. Use it for factual queries, but for "ranting" or "opinion" questions, rely on your general leadership knowledge and empathy.`;

        // ---------------------------------------------------------
        // AI CORE FUNCTIONS
        // ---------------------------------------------------------

        async function callGeminiAI(userPrompt, conversationContext = [], systemPrompt = AI_REPORT_PROMPT) {
            const apiKey = localStorage.getItem('gemini_api_key');

            if (!apiKey) {
                return {
                    error: true,
                    message: 'Please add your Gemini API key in Settings to enable AI insights.'
                };
            }

            // Build the full prompt: System Instruction + History + Current Request
            let fullPrompt = systemPrompt + '\n\n';

            if (conversationContext.length > 0) {
                fullPrompt += 'CONVERSATION HISTORY:\n';
                conversationContext.forEach(msg => {
                    fullPrompt += `${msg.role === 'user' ? 'Manager' : 'Garshu'}: ${msg.content}\n`;
                });
                fullPrompt += '\nCURRENT CONTEXT & REQUEST:\n';
            }

            fullPrompt += userPrompt;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: fullPrompt }]
                }],
                generationConfig: {
                    temperature: 0.7, // Slightly higher creativity for better conversation
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 8192,
                }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    console.error('Gemini API Error Response:', data);
                    throw new Error(data.error?.message || `API Error: ${response.status}`);
                }

                if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                    throw new Error('No text found in response.');
                }

                return {
                    error: false,
                    content: data.candidates[0].content.parts[0].text
                };
            } catch (error) {
                console.error('Gemini API Error:', error);
                return {
                    error: true,
                    message: `Failed to connect to AI: ${error.message}`
                };
            }
        }

        function analyzeRollCallPatterns() {
            const patterns = {};
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);

            Object.entries(appData.rollCall || {}).forEach(([date, data]) => {
                const dateObj = new Date(date + 'T12:00:00');
                if (dateObj < thirtyDaysAgo) return; // Only last 30 days

                Object.entries(data).forEach(([tmId, entry]) => {
                    if (!patterns[tmId]) {
                        patterns[tmId] = { present: 0, absent: 0, pto: 0, total: 0 };
                    }
                    patterns[tmId].total++;
                    if (entry.status === 'present') patterns[tmId].present++;
                    else if (entry.status === 'absent') patterns[tmId].absent++;
                    else if (entry.status === 'pto') patterns[tmId].pto++;
                });
            });

            return Object.entries(patterns).map(([tmId, data]) => {
                const tm = (appData.team || []).find(t => t.id === tmId);
                if (!tm) return null;
                return {
                    teamMember: tm.name,
                    totalDays: data.total,
                    absentDays: data.absent,
                    ptoDays: data.pto,
                    presentDays: data.present,
                    attendanceRate: data.total > 0 ? Math.round((data.present / data.total) * 100) : 0
                };
            }).filter(Boolean);
        }

        function generateContextPrompt(mode = 'morning-brief') {
            const today = getTodayShort();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            // Build rich context
            const context = {
                currentDate: today,

                team: (appData.team || []).filter(t => t.active).map(tm => ({
                    name: tm.name,
                    role: tm.role,
                    account: tm.account,
                    hireDate: tm.hireDate
                })),

                // Recent logbook with notes for sentiment analysis
                recentLogbook: (appData.logbook || [])
                    .filter(l => {
                        const logDate = new Date((l.date || today) + 'T12:00:00');
                        return logDate >= thirtyDaysAgo;
                    })
                    .slice(-20)
                    .map(log => {
                        // Use String() for type-safe comparison
                        const tm = (appData.team || []).find(t => String(t.id) === String(log.tmId));
                        return {
                            teamMember: tm?.name || 'Unknown',
                            title: log.title,
                            type: log.type,
                            notes: log.notes,
                            date: log.date,
                            status: log.status,
                            dueDate: log.dueDate
                        };
                    })
                    .filter(log => log.teamMember && log.teamMember !== 'Unknown'),

                // Pulse check sentiment - ONLY include months with actual notes
                recentPulseChecks: (() => {
                    const months = Object.keys(appData.checkins || {}).sort().slice(-3);
                    return months.map(month => ({
                        month,
                        entries: Object.entries(appData.checkins[month] || {}).map(([tmId, entry]) => {
                            // Use String() for type-safe comparison
                            const tm = (appData.team || []).find(t => String(t.id) === String(tmId));
                            return {
                                teamMember: tm?.name || 'Unknown',
                                sentiment: entry.sentiment,
                                notes: entry.notes,
                                date: entry.date
                            };
                        })
                            // Filter: Must have team member AND actual notes (ignore empty/completion-only entries)
                            .filter(entry =>
                                entry.teamMember &&
                                entry.teamMember !== 'Unknown' &&
                                entry.notes &&
                                entry.notes.trim().length > 0
                            )
                    }))
                        // Filter out months with zero entries (empty months)
                        .filter(monthData => monthData.entries.length > 0);
                })(),

                // Capacity and PTO - Full capacity data
                capacityData: (() => {
                    const today = getTodayShort();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    const sixtyDaysAhead = new Date();
                    sixtyDaysAhead.setDate(sixtyDaysAhead.getDate() + 60);
                    
                    return (appData.capacity || [])
                        .filter(c => {
                            const startDate = new Date(c.startDate + 'T12:00:00');
                            const endDate = new Date(c.endDate + 'T12:00:00');
                            // Include events that overlap with the last 30 days to next 60 days
                            return (startDate <= sixtyDaysAhead && endDate >= thirtyDaysAgo);
                        })
                        .map(c => {
                            // Use String() for type-safe comparison
                            const tm = (appData.team || []).find(t => String(t.id) === String(c.tmId));
                            return {
                                teamMember: tm?.name || 'Unknown',
                                type: c.type, // 'PTO', 'Request', 'Absent'
                                status: c.status, // 'Approved', 'Pending'
                                startDate: c.startDate,
                                endDate: c.endDate,
                                account: tm?.account || 'Unassigned',
                                notes: c.notes || ''
                            };
                        })
                        .filter(c => c.teamMember && c.teamMember !== 'Unknown');
                })(),
                
                // Upcoming PTO (for backward compatibility and quick reference)
                upcomingPTO: (appData.capacity || [])
                    .filter(c => c.type === 'PTO' && new Date(c.startDate + 'T12:00:00') >= new Date(today + 'T12:00:00'))
                    .map(c => {
                        // Use String() for type-safe comparison
                        const tm = (appData.team || []).find(t => String(t.id) === String(c.tmId));
                        return {
                            teamMember: tm?.name || 'Unknown',
                            startDate: c.startDate,
                            endDate: c.endDate,
                            status: c.status
                        };
                    })
                    .filter(pto => pto.teamMember && pto.teamMember !== 'Unknown'),

                // My Desk tasks
                myDeskTasks: (appData.myDesk || []).map(task => ({
                    title: task.title,
                    dueDate: task.dueDate,
                    status: task.status,
                    category: task.category,
                    notes: task.notes
                })),

                // Evaluation pipeline
                evaluations: (() => {
                    return Object.entries(appData.evaluations || {}).map(([id, data]) => {
                        // Extract team member from eval ID pattern
                        const parts = id.split('_');
                        const tmId = parts.length > 1 ? parts.slice(1, -1).join('_') : null;
                        // Use String() for type-safe comparison
                        const tm = tmId ? (appData.team || []).find(t => String(t.id) === String(tmId)) : null;
                        const type = id.includes('annual') ? 'Annual' : 'Mid-Year';
                        const completedSteps = Object.values(data || {}).filter(Boolean).length;

                        return {
                            teamMember: tm?.name || 'Unknown',
                            type,
                            completedSteps,
                            totalSteps: 4,
                            progress: `${completedSteps}/4`
                        };
                    }).filter(eval => eval.teamMember && eval.teamMember !== 'Unknown');
                })(),

                // Roll call patterns
                rollCallPatterns: analyzeRollCallPatterns(),

                // Reliability Matrix data
                reliabilityData: (() => {
                    const attendanceHistory = getAttendanceHistory();
                    const today = getTodayShort();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    // Get reliability data for the last 30 days
                    const reliability = {};
                    Object.entries(attendanceHistory || {}).forEach(([date, dayData]) => {
                        const dateObj = new Date(date + 'T12:00:00');
                        if (dateObj >= thirtyDaysAgo) {
                            Object.entries(dayData || {}).forEach(([tmId, status]) => {
                                // Use String() for type-safe comparison
                                const tm = (appData.team || []).find(t => String(t.id) === String(tmId));
                                if (tm && tm.active) {
                                    if (!reliability[tmId]) {
                                        reliability[tmId] = {
                                            teamMember: tm.name,
                                            statuses: []
                                        };
                                    }
                                    reliability[tmId].statuses.push({
                                        date: date,
                                        status: status // 'present', 'absent', 'pto', 'unplanned', etc.
                                    });
                                }
                            });
                        }
                    });
                    
                    // Calculate reliability scores for each team member
                    return Object.values(reliability).map(tmData => {
                        const total = tmData.statuses.length;
                        const unplanned = tmData.statuses.filter(s => s.status === 'unplanned' || s.status === 'absent').length;
                        const score = total > 0 ? Math.round(((total - unplanned) / total) * 100) : 100;
                        
                        return {
                            teamMember: tmData.teamMember,
                            totalDays: total,
                            unplannedDays: unplanned,
                            reliabilityScore: score,
                            recentStatuses: tmData.statuses.slice(-10) // Last 10 statuses
                        };
                    });
                })()
            };

            // Different prompts for different modes
            if (mode === 'morning-brief') {
                return `Today is ${today}. As my morning brief and daily audit, analyze this team data and provide insights in the following format:

Morning Brief
(Bullet points only. High-level summary of critical items.)

Blind Spots
(Max 2 most critical items. Focus on risks.)

Proactive Questions
(1-2 sharp, critical thinking questions.)

Recommended Actions
(Specific, immediate steps. No fluff.)

Pattern
(One significant trend, briefly explained. Optional - only if significant.)

CRITICAL RULES:
- If recentPulseChecks is empty or has no entries, IGNORE IT COMPLETELY. Do NOT mention missing pulse check data.
- The upcomingPTO list is the SOURCE OF TRUTH for PTO. If someone is in upcomingPTO, their PTO IS tracked.
- Only flag PTO issues if a logbook entry mentions PTO but the person is NOT in upcomingPTO for those dates.
- Focus on ACTIONABLE insights, not data quality issues.

Data Context:
${JSON.stringify(context, null, 2)}

Be specific with names and dates, but keep it brief. Impact over word count.
Analyze sentiment from notes, detect patterns, and flag potential issues efficiently.`;
            } else if (mode === 'audit') {
                return `Perform a comprehensive audit of this team management data. Look for:
- Cross-module inconsistencies
- Missing or incomplete data
- Sentiment trends and potential team health issues
- Coverage gaps or scheduling conflicts
- Overdue or blocked items
- Unusual patterns

Data Context:
${JSON.stringify(context, null, 2)}

Provide a detailed audit report with specific findings and recommendations.`;
            } else {
                // Chat mode - just provide context
                return `Current team management data context:
${JSON.stringify(context, null, 2)}`;
            }
        }

        async function generateAIPoweredInsights(mode = 'morning-brief') {
            try {
                // For insights, we use the specific REPORT prompt
                const prompt = generateContextPrompt(mode);
                const response = await callGeminiAI(prompt, [], AI_REPORT_PROMPT);

                if (response.error) {
                    return { error: true, message: response.message };
                }

                return {
                    error: false,
                    content: response.content,
                    mode: mode
                };
            } catch (error) {
                return { error: true, message: 'An unexpected error occurred.' };
            }
        }

        async function askAI(question) {
            // 1. Get Data Context (The JSON blob of team info)
            const dataContext = generateContextPrompt('chat');

            // 2. Combine Data + User Question
            // We explicitly tell the AI this is the current data, but the User's question is the priority.
            const userMessage = `HERE IS THE CURRENT TEAM DATA (Use only if relevant to the question):\n${dataContext}\n\nMANAGER SAYS: ${question}`;

            // 3. Add to History
            aiConversationHistory.push({
                role: 'user',
                content: question
            });

            // 4. Call Gemini with the CHAT personality (Empathetic/Conversational)
            const response = await callGeminiAI(userMessage, aiConversationHistory.slice(0, -1), AI_CHAT_PROMPT);

            // 5. Save Response to History
            if (!response.error) {
                aiConversationHistory.push({
                    role: 'ai',
                    content: response.content
                });
            }

            return response;
        }

        // Removed: Old rule-based system replaced with AI-powered insights above

        function renderAIInsightsContent(aiResponse) {
            const container = document.getElementById('aiInsightsContent');
            const summary = document.getElementById('aiInsightsSummary');

            if (aiResponse.error) {
                container.innerHTML = `
                    <div class="text-center py-12 px-6">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-2">Unable to Generate Insights</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4 max-w-md mx-auto">${aiResponse.message}</p>
                        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 mb-4 max-w-md mx-auto">
                            <p class="text-xs text-amber-800 dark:text-amber-300 font-semibold mb-1"> Detailed Error Logs Available</p>
                            <p class="text-xs text-amber-700 dark:text-amber-400">Press F12 to open Developer Console and check the detailed API response logs.</p>
                        </div>
                        <button onclick="switchAITab('settings')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold rounded-lg transition-colors">
                            Go to Settings
                        </button>
                    </div>
                `;
                summary.textContent = 'AI Error';
                return;
            }

            // Render AI-generated content in markdown-like format
            let content = aiResponse.content;

            // Remove markdown bolding (**) for cleaner look
            content = content.replace(/\*\*/g, '');

            // Show when it was analyzed
            const timeAgo = lastAnalysisTime
                ? `Last analyzed ${formatTimeAgo(lastAnalysisTime)}`
                : 'Just now';
            summary.textContent = timeAgo;

            let html = '<div class="space-y-6">';

            // 1. Parse Sections
            const sections = {
                brief: '',
                actions: [],
                insights: ''
            };

            // Simple parser based on headers
            const lines = content.split('\n');
            let currentSection = 'brief';

            lines.forEach(line => {
                if (line.includes('Morning Brief')) currentSection = 'brief';
                else if (line.includes('Actions') || line.includes('Recommended Actions')) currentSection = 'actions_text';
                else if (line.includes('Blind Spots') || line.includes('Proactive Questions') || line.includes('Pattern')) currentSection = 'insights';
                else if (line.trim()) {
                    if (currentSection === 'brief') sections.brief += line + '\n';
                    else if (currentSection === 'insights') sections.insights += line + '\n';
                }
            });

            // 2. Render Morning Brief (Top)
            if (sections.brief) {
                html += `
                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-slate-600 dark:to-slate-500 p-6 rounded-xl border border-purple-200/50 dark:border-slate-400 shadow-sm">
                        <h4 class="text-sm font-bold text-purple-900 dark:text-purple-300 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <span class="text-xl"></span> Morning Brief
                        </h4>
                        <div class="space-y-2.5 text-slate-800 dark:text-white leading-relaxed">
                            ${sections.brief.split('\n').filter(l => l.trim()).map(l => {
                    const line = l.trim();
                    // Check if it's a bullet point
                    if (line.startsWith('*') || line.startsWith('-') || line.startsWith('')) {
                        const content = line.substring(1).trim();
                        return `
                                        <div class="flex items-start gap-3 group">
                                            <span class="text-purple-500 dark:text-purple-400 mt-1 flex-shrink-0"></span>
                                            <p class="flex-1 text-sm font-medium">${content}</p>
                                        </div>
                                    `;
                    }
                    // Regular paragraph
                    return `<p class="text-sm font-medium pl-6">${line}</p>`;
                }).join('')}
                        </div>
                    </div>
                `;
            }

            // 3. Render Quick Actions (Hardcoded + AI suggested)
            const detectedActions = detectActionablePatterns();

            // Filter out dismissed actions
            const dismissedActions = JSON.parse(localStorage.getItem('aiDismissedActions') || '[]');
            const activeActions = detectedActions.filter(a => !dismissedActions.includes(a.id));

            if (activeActions.length > 0) {
                html += '<div>';
                html += '<h4 class="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wider mb-4 px-1 flex items-center gap-2"><span class="text-sm"></span> Quick Actions</h4>';
                html += '<div class="grid grid-cols-1 gap-3">';

                activeActions.forEach(action => {
                    html += `
                        <div class="bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700/50 rounded-xl p-5 shadow-sm hover:shadow-md dark:hover:shadow-purple-900/10 transition-all" data-action-id="${action.id}">
                            <div class="flex items-start gap-3 mb-3">
                                <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-purple-100 to-indigo-100 dark:from-purple-900/30 dark:to-indigo-900/30 flex items-center justify-center text-xl flex-shrink-0 border border-purple-200/50 dark:border-purple-800/50">
                                    ${action.icon}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h5 class="font-semibold text-sm text-slate-900 dark:text-white">${action.title}</h5>
                                    <p class="text-xs font-medium text-slate-500 dark:text-slate-400 mt-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${action.priority === 'High' ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300' :
                            action.priority === 'Medium' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300' :
                                'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300'
                        }">
                                            ${action.priority} Priority
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <p class="text-sm text-slate-600 dark:text-slate-300 mb-4 leading-relaxed">${action.description}</p>
                            <div class="flex items-center gap-2 flex-wrap">
                                <button onclick="${action.action.primaryHandler}" 
                                    class="flex-1 px-4 py-2.5 bg-purple-600 hover:bg-purple-700 dark:bg-purple-600 dark:hover:bg-purple-500 text-white text-sm font-semibold rounded-lg transition-colors shadow-sm hover:shadow-md">
                                    ${action.action.primaryLabel}
                                </button>
                                <button onclick="${action.action.secondaryHandler}" 
                                    class="px-4 py-2.5 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700/50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 text-sm font-semibold rounded-lg transition-colors border border-slate-200 dark:border-slate-600">
                                    ${action.action.secondaryLabel}
                                </button>
                                <button onclick="${action.action.dismissHandler}" 
                                    class="px-3 py-2 text-slate-500 dark:text-slate-400 hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 text-sm font-medium rounded-lg transition-colors">
                                    Dismiss
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            // 4. Strategic Insights (Collapsible)
            if (sections.insights) {
                html += `
                    <div class="border-t border-slate-200 dark:border-slate-700 pt-4 mt-4">
                        <button onclick="toggleStrategicInsights()" class="flex items-center justify-between w-full p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors group">
                            <span class="text-sm font-semibold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                                <span class="text-xl"></span> Strategic Deep Dive
                            </span>
                            <svg id="insightChevron" class="w-5 h-5 text-slate-400 dark:text-slate-500 group-hover:text-purple-500 dark:group-hover:text-purple-400 transform transition-all duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="strategicInsightsContent" class="hidden mt-4 space-y-4">
                            <div class="bg-slate-50 dark:bg-slate-600 p-5 rounded-lg border border-slate-200 dark:border-slate-400">
                                ${sections.insights.split('\n').filter(l => l.trim()).map(l => {
                    const line = l.trim();
                    // Section headers
                    if (line.includes('Blind Spot') || line.includes('Pattern') || line.includes('Question') || line.includes('Proactive')) {
                        return `<h5 class="text-sm font-bold text-purple-800 dark:text-purple-300 mt-5 first:mt-0 mb-3 flex items-center gap-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-purple-500 dark:bg-purple-400"></span>
                                            ${line}
                                        </h5>`;
                    }
                    // Bullet points - MATCH MORNING BRIEF
                    if (line.startsWith('*') || line.startsWith('-') || line.startsWith('')) {
                        const content = line.substring(1).trim();
                        return `
                                            <div class="flex items-start gap-3 group">
                                                <span class="text-purple-500 dark:text-purple-400 mt-1 flex-shrink-0"></span>
                                                <p class="flex-1 text-sm font-medium text-slate-800 dark:text-white">${content}</p>
                                            </div>
                                        `;
                    }
                    // Regular text - MATCH MORNING BRIEF
                    return `<p class="text-sm font-medium text-slate-800 dark:text-white pl-6">${line}</p>`;
                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Re-analyze button
            html += `
                <div class="pt-4 border-t border-slate-200 dark:border-slate-700 mt-6">
                    <button onclick="reanalyzeInsights()" 
                        class="w-full px-5 py-3.5 border-2 border-dashed border-slate-300 dark:border-slate-600 hover:bg-purple-50 dark:hover:bg-purple-950/30 hover:border-purple-400 dark:hover:border-purple-600 text-slate-700 dark:text-slate-200 hover:text-purple-700 dark:hover:text-purple-300 text-sm font-semibold rounded-xl transition-all flex items-center justify-center gap-2 group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:rotate-180 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Ask Garshu to Reanalyze
                    </button>
                </div>
            `;

            html += '</div>'; // Close space-y-6
            container.innerHTML = html;
        }

        function toggleStrategicInsights() {
            const content = document.getElementById('strategicInsightsContent');
            const chevron = document.getElementById('insightChevron');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }

        // Helper function to show time ago
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            return 'today';
        }

        function getPriorityBadgeClass(priority) {
            const classes = {
                'High': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400',
                'Medium': 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400',
                'Low': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400'
            };
            return classes[priority] || 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300';
        }

        // ==========================================
        // ACTION BUTTONS - AI + RULES HYBRID
        // ==========================================

        // Helper function to extract PTO date from title text
        function extractDateFromTitle(title) {
            if (!title) return null;

            const currentYear = new Date().getFullYear();

            // Pattern 1: "December 26" or "December 26, 2025"
            const monthNamePattern = /\b(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d{1,2})(?:,?\s*(\d{4}))?\b/i;
            let match = title.match(monthNamePattern);
            if (match) {
                const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
                const month = monthNames.indexOf(match[1].toLowerCase());
                const day = parseInt(match[2]);
                const year = match[3] ? parseInt(match[3]) : currentYear;

                if (month >= 0 && day >= 1 && day <= 31) {
                    const date = new Date(year, month, day);
                    // If date is in the past and no year specified, assume next year
                    if (!match[3] && date < new Date()) {
                        date.setFullYear(currentYear + 1);
                    }
                    return date.toISOString().split('T')[0];
                }
            }

            // Pattern 2: "Dec 26" or "Dec 26, 2025"
            const shortMonthPattern = /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{1,2})(?:,?\s*(\d{4}))?\b/i;
            match = title.match(shortMonthPattern);
            if (match) {
                const monthNames = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                const month = monthNames.indexOf(match[1].toLowerCase());
                const day = parseInt(match[2]);
                const year = match[3] ? parseInt(match[3]) : currentYear;

                if (month >= 0 && day >= 1 && day <= 31) {
                    const date = new Date(year, month, day);
                    if (!match[3] && date < new Date()) {
                        date.setFullYear(currentYear + 1);
                    }
                    return date.toISOString().split('T')[0];
                }
            }

            // Pattern 3: "12/26" or "12/26/2025"
            const slashPattern = /\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/;
            match = title.match(slashPattern);
            if (match) {
                const month = parseInt(match[1]) - 1;
                const day = parseInt(match[2]);
                let year = match[3] ? parseInt(match[3]) : currentYear;
                if (year < 100) year += 2000;

                if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                    const date = new Date(year, month, day);
                    if (!match[3] && date < new Date()) {
                        date.setFullYear(currentYear + 1);
                    }
                    return date.toISOString().split('T')[0];
                }
            }

            // Pattern 4: "2025-12-26" (ISO format)
            const isoPattern = /\b(\d{4})-(\d{2})-(\d{2})\b/;
            match = title.match(isoPattern);
            if (match) {
                return match[0];
            }

            return null;
        }

        function detectActionablePatterns() {
            const actions = [];
            const today = getTodayShort();

            // Pattern 1: PTO in logbook but not in capacity
            // Check both title AND notes for PTO keywords (matching old logic)
            const ptoLogs = (appData.logbook || []).filter(l => {
                const titleLower = (l.title || '').toLowerCase();
                const notesLower = (l.notes || '').toLowerCase();

                // Check both title AND notes for PTO keywords
                const ptoKeywordRegex = /\b(pto|sick leave|sick|vacation|leave request|annual leave|time off|day off)\b/i;
                const hasPTOKeyword = ptoKeywordRegex.test(titleLower) || ptoKeywordRegex.test(notesLower);

                // Match old logic: type === 'request' AND has PTO keyword, status Open
                const isRequest = l.type === 'request';

                return isRequest && hasPTOKeyword && l.status === 'Open';
            });

            ptoLogs.forEach(log => {
                // Use String() to handle type mismatches (number vs string IDs)
                const tm = (appData.team || []).find(t => String(t.id) === String(log.tmId));
                if (!tm) return;

                // Extract actual PTO date from title, fallback to dueDate
                const extractedDate = extractDateFromTitle(log.title) || extractDateFromTitle(log.notes);
                const ptoDate = extractedDate || log.dueDate || log.date;

                const inCapacity = (appData.capacity || []).some(c => {
                    // Use String() for consistent comparison
                    if (String(c.tmId) !== String(log.tmId)) return false;
                    if (!ptoDate) return false;
                    const capStart = new Date(c.startDate + 'T12:00:00');
                    const capEnd = new Date(c.endDate + 'T12:00:00');
                    const ptoDateObj = new Date(ptoDate + 'T12:00:00');
                    return ptoDateObj >= capStart && ptoDateObj <= capEnd;
                });

                if (!inCapacity) {
                    actions.push({
                        id: `pto_${log.id}`,
                        icon: '',
                        title: 'PTO Missing from Capacity',
                        description: `${tm.name}: "${log.title}"  PTO Date: ${formatDate(ptoDate)}`,
                        priority: 'High',
                        type: 'pto',
                        ptoDate: ptoDate, // Store extracted date for use in handler
                        action: {
                            primaryLabel: 'Add to Capacity',
                            primaryHandler: `handleAddPTOToCapacity('${log.id}', '${ptoDate}')`,
                            secondaryLabel: 'Go to Log',
                            secondaryHandler: `handleGoToLog('${log.id}')`,
                            dismissHandler: `dismissAction('pto_${log.id}')`,
                            data: { logId: log.id, tmId: log.tmId, tmName: tm.name, date: ptoDate }
                        }
                    });
                }
            });

            // Pattern 2: Overdue tasks
            (appData.myDesk || []).forEach(task => {
                if (!task.dueDate) return;
                const taskDate = new Date(task.dueDate + 'T12:00:00');
                const todayDate = new Date(today + 'T12:00:00');
                const daysDiff = Math.ceil((todayDate - taskDate) / (1000 * 60 * 60 * 24));

                if (daysDiff > 0 && task.status !== 'Completed') {
                    actions.push({
                        id: `overdue_${task.id}`,
                        icon: '',
                        title: 'Overdue Task',
                        description: `"${task.title}" is ${daysDiff} day${daysDiff > 1 ? 's' : ''} overdue.`,
                        priority: 'High',
                        type: 'overdue',
                        action: {
                            primaryLabel: 'Extend 1 Week',
                            primaryHandler: `handleExtendTask('${task.id}')`,
                            secondaryLabel: 'Go to Task',
                            secondaryHandler: `handleGoToTask('${task.id}')`,
                            dismissHandler: `dismissAction('overdue_${task.id}')`,
                            data: { taskId: task.id, title: task.title, days: daysDiff }
                        }
                    });
                }
            });

            // Pattern 3: Roll call PTO not in capacity
            const todayRollCall = (appData.rollCall || {})[today] || {};
            Object.keys(todayRollCall).forEach(tmId => {
                const rc = todayRollCall[tmId];
                if (['pto', 'absent'].includes(rc.status)) {
                    const inCapacity = (appData.capacity || []).some(c =>
                        String(c.tmId) === String(tmId) && c.startDate === today
                    );
                    if (!inCapacity) {
                        const tm = (appData.team || []).find(t => String(t.id) === String(tmId));
                        if (tm) {
                            actions.push({
                                id: `rc_sync_${tmId}`,
                                icon: '',
                                title: 'Sync Roll Call to Capacity',
                                description: `${tm.name}'s roll call shows "${rc.status === 'pto' ? 'PTO' : 'Absent'}" today, but it's not in Capacity.`,
                                priority: 'Medium',
                                action: {
                                    label: 'Sync to Capacity',
                                    handler: `handleSyncRollCallToCapacity('${tmId}', '${rc.status}')`,
                                    data: { tmId, tmName: tm.name, status: rc.status, date: today }
                                }
                            });
                        }
                    }
                }
            });

            return actions;
        }

        function handleAddPTOToCapacity(logId, ptoDate) {
            const log = (appData.logbook || []).find(l => l.id === logId);
            if (!log) {
                showToast('Logbook entry not found', 'error');
                return;
            }

            // Use String() for type-safe comparison
            const tm = (appData.team || []).find(t => String(t.id) === String(log.tmId));
            if (!appData.capacity) appData.capacity = [];

            // Use the extracted PTO date from title, or fallback
            const actualPTODate = ptoDate || extractDateFromTitle(log.title) || extractDateFromTitle(log.notes) || log.dueDate || log.date;

            appData.capacity.push({
                id: 'cap_ai_' + Date.now(),
                tmId: log.tmId,
                type: 'PTO',
                status: 'Approved',
                startDate: actualPTODate,
                endDate: actualPTODate,
                notes: `Added via AI Assistant from logbook: "${log.title}"`
            });

            saveData();
            if (activeTool === 'PulseCheck' && currentPulseTab === 'capacity') {
                renderCapacityView();
            }

            // Remove card smoothly instead of re-analyzing
            removeActionCard(`pto_${logId}`);
            showToast(` ${tm?.name || 'Team member'}'s PTO added to Capacity!`, 'success');
        }

        function handleGoToLog(logId) {
            closeAIAssistant();
            switchTool('ActionHub');
            switchTab('logbook');
            setTimeout(() => {
                // Could highlight or scroll to the log entry if needed
                showToast('Navigating to logbook...', 'info');
            }, 300);
        }

        function handleExtendTask(taskId) {
            const task = (appData.myDesk || []).find(t => t.id === taskId);
            if (!task) {
                showToast('Task not found', 'error');
                return;
            }

            const newDate = new Date(task.dueDate + 'T12:00:00');
            newDate.setDate(newDate.getDate() + 7);
            task.dueDate = newDate.toISOString().split('T')[0];

            saveData();
            if (activeTool === 'ActionHub' && currentHubTab === 'myDesk') {
                renderHubView();
            }

            // Remove card smoothly instead of re-analyzing
            removeActionCard(`overdue_${taskId}`);
            showToast(` Extended "${task.title}" by 1 week`, 'success');
        }

        function handleGoToTask(taskId) {
            closeAIAssistant();
            switchTool('ActionHub');
            switchTab('myDesk');
            setTimeout(() => {
                showToast('Navigating to task...', 'info');
            }, 300);
        }

        function removeActionCard(actionId) {
            const card = document.querySelector(`[data-action-id="${actionId}"]`);
            if (card) {
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(20px)';
                setTimeout(() => card.remove(), 300);
            }
        }

        function dismissAction(actionId) {
            // Visual dismiss with animation
            removeActionCard(actionId);

            // Save dismissed state to localStorage to prevent reappearing this session
            let dismissed = JSON.parse(localStorage.getItem('aiDismissedActions') || '[]');
            dismissed.push(actionId);
            localStorage.setItem('aiDismissedActions', JSON.stringify(dismissed));
        }

        async function openAIAssistant() {
            const modal = document.getElementById('aiAssistantModal');
            const container = modal.querySelector('.modal-container');
            const pill = document.getElementById('aiMinimizedPill');

            // Hide pill if showing
            pill.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');

            // Reset to insights tab
            currentAIMode = 'insights';
            switchAITab('insights');

            // Show modal with center animation
            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                container.classList.remove('scale-95', 'opacity-0');
            }, 10);

            // Check if we have cached insights
            if (cachedInsights) {
                // Show cached data immediately
                renderAIInsightsContent(cachedInsights);
            } else {
                // First time - analyze
                await reanalyzeInsights();
            }
        }

        function minimizeAIAssistant() {
            const modal = document.getElementById('aiAssistantModal');
            const container = modal.querySelector('.modal-container');
            const pill = document.getElementById('aiMinimizedPill');

            // Animate modal out
            container.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');

                // Show minimized pill
                pill.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
            }, 200);
        }

        function restoreAIAssistant() {
            const modal = document.getElementById('aiAssistantModal');
            const container = modal.querySelector('.modal-container');
            const pill = document.getElementById('aiMinimizedPill');

            // Hide pill
            pill.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');

            // Show modal
            modal.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                container.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        async function reanalyzeInsights() {
            const contentEl = document.getElementById('aiInsightsContent');
            const summaryEl = document.getElementById('aiInsightsSummary');

            // Show loading state
            if (contentEl) {
                contentEl.innerHTML = `
                    <div class="text-center py-12">
                        <div class="animate-spin h-12 w-12 border-4 border-purple-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Analyzing your team data...</p>
                    </div>
                `;
            }
            if (summaryEl) {
                summaryEl.textContent = 'Analyzing...';
            }

            // Generate fresh AI insights
            const aiResponse = await generateAIPoweredInsights('morning-brief');

            // Cache the results
            cachedInsights = aiResponse;
            lastAnalysisTime = new Date();

            renderAIInsightsContent(aiResponse);
        }

        function closeAIAssistant() {
            const modal = document.getElementById('aiAssistantModal');
            const container = modal.querySelector('.modal-container');
            const pill = document.getElementById('aiMinimizedPill');

            // Hide pill if showing
            pill.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');

            // Animate modal out
            container.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
            }, 200);
        }

        function updateAIBadge() {
            const badge = document.getElementById('aiInsightsBadge');
            if (!badge) return;

            // Show notification count instead of static indicator
            const unreadCount = appData.garshuNotifications?.unread?.length || 0;

            if (unreadCount > 0) {
                badge.classList.remove('hidden');
                badge.textContent = unreadCount; // Show count
                // Change color to purple for AI notifications
                badge.classList.remove('bg-red-500');
                badge.classList.add('bg-purple-600');
            } else {
                badge.classList.add('hidden');
            }
        }

        // ==========================================
        // PROACTIVE AI NOTIFICATION SYSTEM
        // ==========================================

        function canSendProactiveMessage(triggerType) {
            // Check if proactive mode is enabled
            const proactiveEnabled = appData.garshuNotifications?.proactiveEnabled ?? true;
            if (!proactiveEnabled) return false;

            const notifications = appData.garshuNotifications;
            if (!notifications) return false;

            const now = Date.now();
            const lastSent = notifications.lastSentTime;
            const cooldownMs = notifications.cooldownHours * 60 * 60 * 1000;

            // Check global cooldown (4 hours)
            if (lastSent && (now - lastSent) < cooldownMs) {
                return false;
            }

            // Check if trigger is enabled
            if (!notifications.triggers[triggerType]?.enabled) {
                return false;
            }

            return true;
        }

        async function sendGarshuNotification(triggerType, data) {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) return;

            // Build context-specific prompt
            let prompt = '';
            switch (triggerType) {
                case 'morningBrief':
                    const topTasks = appData.myDesk?.filter(t => t.status !== 'Done').slice(0, 3) || [];
                    prompt = `Generate a brief, encouraging morning message (2-3 sentences) summarizing the user's top priorities for today. Tasks: ${JSON.stringify(topTasks.map(t => t.title))}. Keep it motivational and concise.`;
                    break;
                case 'driftNudge':
                    prompt = `The user set a focus timer for "${data.taskTitle}" but exceeded it by 15+ minutes. Write a gentle, supportive nudge (1-2 sentences) asking if they need help or a break. Be empathetic, not pushy.`;
                    break;
                case 'victoryLap':
                    prompt = `The user just completed ${data.count} tasks! Write a short, enthusiastic congratulations message (1-2 sentences). Be genuine and celebratory.`;
                    break;
            }

            try {
                // Call AI (reuse existing callGeminiAI function)
                const message = await callGeminiAI(prompt, [], AI_CHAT_PROMPT);

                // Add to notification queue
                appData.garshuNotifications.unread.push({
                    id: 'notif_' + Date.now(),
                    type: triggerType,
                    message: message,
                    timestamp: Date.now()
                });

                // Update tracking
                appData.garshuNotifications.lastSentTime = Date.now();
                appData.garshuNotifications.triggers[triggerType].lastSent = new Date().toDateString();

                saveData();
                updateAIBadge();

                // Show toast preview
                showToast(` Garshu has a message for you`, 'info', 5000);

                // Play notification sound
                SoundEngine.play('garshuBark');
            } catch (error) {
                console.error('Failed to send Garshu notification:', error);
            }
        }

        // Trigger Detection Functions
        async function checkMorningBrief() {
            const now = new Date();
            const hour = now.getHours();
            const today = now.toDateString();
            const lastSent = appData.garshuNotifications?.triggers?.morningBrief?.lastSent;

            // Only between 6 AM - 10 AM, once per day
            if (hour >= 6 && hour < 10 && lastSent !== today) {
                if (canSendProactiveMessage('morningBrief')) {
                    await sendGarshuNotification('morningBrief', {
                        context: 'Generate a brief morning summary with top 3 priorities'
                    });
                }
            }
        }

        function checkDriftNudge() {
            // Check if user exceeded focus timer
            const focusTask = appData.myDesk?.find(t => t.id === appData.focusTaskId);
            if (!focusTask || !appData.focusEndAt) return;

            const now = Date.now();
            const endTime = new Date(appData.focusEndAt).getTime();
            const overdue = now - endTime;

            // If 15 minutes past focus timer
            if (overdue > 15 * 60 * 1000) {
                if (canSendProactiveMessage('driftNudge')) {
                    sendGarshuNotification('driftNudge', {
                        taskTitle: focusTask.title,
                        context: 'User exceeded focus timer by 15+ minutes'
                    });
                }
            }
        }

        function checkVictoryLap() {
            // Trigger when user completes 5+ tasks in one session
            const recentCompletions = appData.myDesk?.filter(t => {
                if (t.status !== 'Done') return false;
                // Check if completed in last hour
                const completedTime = new Date(t.completedAt || 0).getTime();
                return (Date.now() - completedTime) < 60 * 60 * 1000;
            });

            if (recentCompletions?.length >= 5) {
                if (canSendProactiveMessage('victoryLap')) {
                    sendGarshuNotification('victoryLap', {
                        count: recentCompletions.length,
                        context: 'User completed multiple tasks, send encouragement'
                    });
                }
            }
        }

        // Notification Management Functions
        function toggleProactiveAI(enabled) {
            appData.garshuNotifications.proactiveEnabled = enabled;
            saveData();

            // Show/hide individual trigger controls
            const controls = document.getElementById('triggerControls');
            if (controls) {
                controls.style.display = enabled ? 'block' : 'none';
            }

            // Clear badge if disabling
            if (!enabled) {
                updateAIBadge();
            }

            showToast(
                enabled ? ' Garshu is now proactive!' : 'Garshu will wait for your messages',
                'success'
            );
        }

        function toggleTrigger(triggerType, enabled) {
            if (appData.garshuNotifications?.triggers?.[triggerType]) {
                appData.garshuNotifications.triggers[triggerType].enabled = enabled;
                saveData();
                showToast(
                    `${triggerType} ${enabled ? 'enabled' : 'disabled'}`,
                    'success'
                );
            }
        }

        function dismissNotification(notifId) {
            appData.garshuNotifications.unread = appData.garshuNotifications.unread.filter(n => n.id !== notifId);
            saveData();
            updateAIBadge();
            renderNotifications();
        }

        function renderNotifications() {
            const container = document.getElementById('aiTabNotifications');
            if (!container) return;

            const unread = appData.garshuNotifications?.unread || [];

            if (unread.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center space-y-4">
                        <div class="w-20 h-20 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mb-2 animate-pulse">
                            <span class="text-4xl"></span>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Garshu is watching...</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 max-w-xs mx-auto">
                            No new proactive insights yet. Garshu will nudge you here when it detects focus drift or major milestones!
                        </p>
                        <div class="pt-4">
                            <button onclick="switchAITab('settings')" class="text-xs font-medium text-purple-600 dark:text-purple-400 hover:underline">
                                Check notification settings 
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Recent Alerts</h3>
                        <button onclick="appData.garshuNotifications.unread = []; saveData(); updateAIBadge(); renderNotifications();" 
                            class="text-xs text-purple-600 dark:text-purple-400 hover:underline">Clear all</button>
                    </div>
                    ${unread.map(notif => `
                        <div class="group relative bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl p-4 shadow-sm hover:shadow-md transition-all">
                            <div class="flex items-start gap-4">
                                <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center flex-shrink-0">
                                    <span class="text-xl"></span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-slate-700 dark:text-slate-200 leading-relaxed">${notif.message}</p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <span class="text-[10px] font-medium px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 uppercase tracking-tight">
                                            ${notif.type || 'Insight'}
                                        </span>
                                        <span class="text-[10px] text-slate-400">${formatTimeAgo(notif.timestamp)}</span>
                                    </div>
                                </div>
                                <button onclick="dismissNotification('${notif.id}')" 
                                    class="opacity-0 group-hover:opacity-100 p-1.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-all text-slate-400 hover:text-red-500"
                                    title="Dismiss">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        async function checkAutoTrigger() {
            const now = new Date();
            const hour = now.getHours();
            const today = now.toDateString();
            const lastShown = localStorage.getItem('aiInsights_lastShown');

            // Before 7 AM and not shown today
            if (hour < 7 && lastShown !== today) {
                const apiKey = localStorage.getItem('gemini_api_key');
                if (apiKey) {
                    setTimeout(() => {
                        openAIAssistant();
                        localStorage.setItem('aiInsights_lastShown', today);
                    }, 2000); // Small delay after page load
                }
            }
        }

        function switchAITab(tab) {
            currentAIMode = tab;

            // Update tab buttons - Linear style
            document.querySelectorAll('.ai-tab-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'dark:bg-slate-800', 'text-purple-600', 'dark:text-purple-400', 'shadow-sm');
                btn.classList.add('text-slate-600', 'dark:text-slate-400', 'hover:bg-white/50', 'dark:hover:bg-slate-800/50');
            });

            const activeBtn = document.querySelector(`.ai-tab-btn[data-tab="${tab}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('text-slate-600', 'dark:text-slate-400', 'hover:bg-white/50', 'dark:hover:bg-slate-800/50');
                activeBtn.classList.add('bg-white', 'dark:bg-slate-800', 'text-purple-600', 'dark:text-purple-400', 'shadow-sm');
            }

            // Show correct content
            document.querySelectorAll('.ai-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            let activeContent;
            if (tab === 'chat') {
                activeContent = document.getElementById('aiChatView');
            } else {
                activeContent = document.getElementById(`aiTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            }
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }

            // Load content based on tab
            if (tab === 'insights') {
                // For insights tab, show cached data if available
                if (cachedInsights) {
                    renderAIInsightsContent(cachedInsights);
                } else {
                    // No cache - analyze
                    reanalyzeInsights();
                }
            } else if (tab === 'notifications') {
                // Render notifications when switching to this tab
                renderNotifications();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('aiChatInput');
            const messages = document.getElementById('aiChatContent');

            if (!input || !messages) return;

            const question = input.value.trim();
            if (!question) return;

            // Add user message to UI
            const userMsg = document.createElement('div');
            userMsg.className = 'text-right mb-3 group';
            userMsg.innerHTML = `
                <div class="inline-flex items-start gap-2">
                    <button onclick="this.closest('.group').remove()" 
                        class="opacity-0 group-hover:opacity-100 p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded transition-all mt-1" 
                        title="Remove message">
                        <svg class="w-3 h-3 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <div class="inline-block bg-purple-600 text-white px-4 py-2.5 rounded-lg text-sm max-w-md shadow-sm">
                        ${question}
                    </div>
                </div>
            `;
            messages.appendChild(userMsg);

            input.value = '';

            // Show loading
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'mb-4';
            loadingMsg.id = 'aiLoadingMsg';
            loadingMsg.innerHTML = `
                <div class="inline-block bg-slate-100 dark:bg-slate-800 px-4 py-2 rounded-lg text-sm">
                    <div class="flex items-center gap-2">
                        <div class="animate-spin h-4 w-4 border-2 border-purple-600 border-t-transparent rounded-full"></div>
                        <span class="text-slate-600 dark:text-slate-400">Thinking...</span>
                    </div>
                </div>
            `;
            messages.appendChild(loadingMsg);
            messages.scrollTop = messages.scrollHeight;

            // Get AI response
            const response = await askAI(question);

            // Remove loading
            loadingMsg.remove();

            // Add AI response
            const aiMsg = document.createElement('div');
            aiMsg.className = 'mb-3 group';
            aiMsg.innerHTML = `
                <div class="inline-flex items-start gap-2 max-w-md">
                    <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center flex-shrink-0 shadow-sm">
                        <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <div class="flex-1 bg-slate-100 dark:bg-slate-800 px-4 py-3 rounded-lg text-sm shadow-sm">
                        <p class="text-slate-700 dark:text-slate-300 whitespace-pre-wrap leading-relaxed">${response.error ? response.message : response.content}</p>
                    </div>
                    <button onclick="this.closest('.group').remove()" 
                        class="opacity-0 group-hover:opacity-100 p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded transition-all mt-1" 
                        title="Remove message">
                        <svg class="w-3 h-3 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            `;
            messages.appendChild(aiMsg);
            messages.scrollTop = messages.scrollHeight;
        }

        window.onload = function () {
            SoundEngine.init();
            initDarkMode();
            loadData();
            loadGeminiKey();
            startOsClock();
            checkSnoozedTasks();
            updateSnoozeButton();
            updateCloudSyncStatus();

            // Check for returned snoozed tasks every minute
            setInterval(checkSnoozedTasks, 60000);

            // Initialize scroll listener for back-to-top button and sticky tabs
            window.addEventListener('scroll', handleScroll);
            // Check initial scroll position
            handleScroll();

            // Check for auto-trigger AI Assistant
            checkAutoTrigger();

            // Update AI badge on load
            updateAIBadge();

            // Sync toggle states from appData
            const proactiveToggle = document.getElementById('toggleProactiveAI');
            if (proactiveToggle) {
                proactiveToggle.checked = appData.garshuNotifications?.proactiveEnabled ?? true;
            }
            ['morningBrief', 'driftNudge', 'victoryLap'].forEach(trigger => {
                const toggle = document.getElementById(`toggle${trigger.charAt(0).toUpperCase() + trigger.slice(1)}`);
                if (toggle) {
                    toggle.checked = appData.garshuNotifications?.triggers?.[trigger]?.enabled ?? true;
                }
            });

            // Start monitoring for proactive triggers (check every 5 minutes)
            setInterval(() => {
                if (appData.garshuNotifications?.proactiveEnabled) {
                    checkMorningBrief();
                    checkDriftNudge();
                    checkVictoryLap();
                }
            }, 5 * 60 * 1000); // 5 minutes

            // Check if user has seen the help guide
            const hasSeenHelp = localStorage.getItem('leadershipOS_HasSeenHelp_v2');
            if (!hasSeenHelp) {
                setTimeout(() => {
                    toggleModal('helpModal');
                    localStorage.setItem('leadershipOS_HasSeenHelp_v2', 'true');
                }, 1000); // Small delay for smooth entrance
            }
        };

        // ==========================================
        // CLIENT SYNC GENERATOR
        // ==========================================
        
        const clientSyncState = {
            memberId: null,
            memberName: '',
            memberRole: '',
            startMonth: '',
            endMonth: '',
            aggregatedData: {},
            contextNotes: {}
        };

        let clientSyncMembersList = [];

        function openClientSyncModal() {
            const modal = document.getElementById('client-sync-modal');
            modal.classList.remove('hidden');
            
            // Reset state
            clientSyncState.memberId = null;
            clientSyncState.memberName = '';
            clientSyncState.memberRole = '';
            clientSyncState.startMonth = '';
            clientSyncState.endMonth = '';
            clientSyncState.aggregatedData = {};
            clientSyncState.contextNotes = {};
            
            // Show config screen, hide preview
            document.getElementById('client-sync-config').classList.remove('hidden');
            document.getElementById('client-sync-preview').classList.add('hidden');
            
            // Reset search input
            document.getElementById('client-sync-member-search').value = '';
            document.getElementById('client-sync-member-id').value = '';
            
            // Populate member list for fuzzy search
            clientSyncMembersList = appData.team ? appData.team.filter(m => m.active) : [];
            filterClientSyncMembers('');
            
            // Clear date dropdowns
            document.getElementById('client-sync-start-month').innerHTML = '<option value="">Select start...</option>';
            document.getElementById('client-sync-end-month').innerHTML = '<option value="">Select end...</option>';
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeClientSyncModal() {
            document.getElementById('client-sync-modal').classList.add('hidden');
            document.getElementById('client-sync-member-dropdown').classList.add('hidden');
        }

        function showClientSyncConfig() {
            document.getElementById('client-sync-config').classList.remove('hidden');
            document.getElementById('client-sync-preview').classList.add('hidden');
        }

        function showClientSyncMemberDropdown() {
            document.getElementById('client-sync-member-dropdown').classList.remove('hidden');
        }

        function filterClientSyncMembers(query) {
            const dropdown = document.getElementById('client-sync-member-dropdown');
            const list = document.getElementById('client-sync-member-list');
            
            const filtered = clientSyncMembersList.filter(m => {
                const searchText = `${m.name} ${m.role || ''}`.toLowerCase();
                return searchText.includes(query.toLowerCase());
            });
            
            list.innerHTML = '';
            
            if (filtered.length === 0) {
                list.innerHTML = '<div class="px-4 py-3 text-sm text-slate-500">No members found</div>';
            } else {
                filtered.forEach(member => {
                    const item = document.createElement('div');
                    item.className = 'px-4 py-3 hover:bg-blue-50 cursor-pointer text-sm transition-colors';
                    item.innerHTML = `
                        <div class="font-semibold text-slate-800">${member.name}</div>
                        <div class="text-xs text-slate-500">${member.role || 'Team Member'}</div>
                    `;
                    item.onclick = () => selectClientSyncMember(member);
                    list.appendChild(item);
                });
            }
            
            dropdown.classList.remove('hidden');
        }

        function selectClientSyncMember(member) {
            document.getElementById('client-sync-member-search').value = `${member.name} - ${member.role || 'Team Member'}`;
            document.getElementById('client-sync-member-id').value = member.id;
            document.getElementById('client-sync-member-dropdown').classList.add('hidden');
            
            // Update date range options
            updateClientSyncDateRange(member.id);
        }

        function updateClientSyncDateRange(memberId) {
            if (!memberId) {
                memberId = document.getElementById('client-sync-member-id').value;
            }
            
            if (!memberId) {
                document.getElementById('client-sync-start-month').innerHTML = '<option value="">Select start...</option>';
                document.getElementById('client-sync-end-month').innerHTML = '<option value="">Select end...</option>';
                return;
            }
            
            const member = appData.team.find(m => m.id == memberId);
            if (!member || !member.history || member.history.length === 0) {
                document.getElementById('client-sync-start-month').innerHTML = '<option value="">No history available</option>';
                document.getElementById('client-sync-end-month').innerHTML = '<option value="">No history available</option>';
                return;
            }
            
            // Get all months with completed ratings
            const availableMonths = member.history
                .filter(h => h.finalScore && h.finalScore > 0)
                .map(h => h.month)
                .sort((a, b) => getMonthValue(a) - getMonthValue(b));
            
            if (availableMonths.length === 0) {
                document.getElementById('client-sync-start-month').innerHTML = '<option value="">No completed ratings</option>';
                document.getElementById('client-sync-end-month').innerHTML = '<option value="">No completed ratings</option>';
                return;
            }
            
            // Populate start month dropdown
            const startSelect = document.getElementById('client-sync-start-month');
            startSelect.innerHTML = '<option value="">Select start...</option>';
            availableMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                startSelect.appendChild(option);
            });
            
            // Populate end month dropdown
            const endSelect = document.getElementById('client-sync-end-month');
            endSelect.innerHTML = '<option value="">Select end...</option>';
            availableMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                endSelect.appendChild(option);
            });
        }

        function generateClientSyncStatement() {
            const memberId = document.getElementById('client-sync-member-id').value;
            const startMonth = document.getElementById('client-sync-start-month').value;
            const endMonth = document.getElementById('client-sync-end-month').value;
            
            // Validation
            if (!memberId) {
                showToast('Please select a team member', 'error');
                return;
            }
            if (!startMonth || !endMonth) {
                showToast('Please select both start and end months', 'error');
                return;
            }
            
            const startValue = getMonthValue(startMonth);
            const endValue = getMonthValue(endMonth);
            
            if (startValue > endValue) {
                showToast('Start month must be before or equal to end month', 'error');
                return;
            }
            
            const member = appData.team.find(m => m.id == memberId);
            if (!member) {
                showToast('Member not found', 'error');
                return;
            }
            
            // Store member info
            clientSyncState.memberId = memberId;
            clientSyncState.memberName = member.name;
            clientSyncState.memberRole = member.role || 'Team Member';
            clientSyncState.startMonth = startMonth;
            clientSyncState.endMonth = endMonth;
            
            // Filter history entries within date range
            const filteredHistory = member.history.filter(h => {
                // Match dropdown logic: check for finalScore > 0
                if (!(h.finalScore && h.finalScore > 0) || !h.metrics || !h.month) return false;
                const monthValue = getMonthValue(h.month);
                return monthValue >= startValue && monthValue <= endValue;
            });
            
            if (filteredHistory.length === 0) {
                showToast('No completed ratings found in the selected period', 'error');
                return;
            }
            
            // Process performance metrics (exclude internal metrics)
            const aggregatedData = {};
            
            filteredHistory.forEach(entry => {
                // Handle metrics as an array (LeadershipOS structure)
                if (entry.metrics && Array.isArray(entry.metrics)) {
                    entry.metrics.forEach(metric => {
                        // Use metric name as key since metrics are stored as array
                        const metricName = metric.name;
                        
                        if (!aggregatedData[metricName]) {
                            aggregatedData[metricName] = {
                                scores: [],
                                wsllSet: new Set(),
                                definition: metric.definition || '',
                                name: metricName
                            };
                        }
                        
                        // Add score
                        if (metric.score) {
                            aggregatedData[metricName].scores.push(metric.score);
                        }
                        
                        // Add WSLL if exists and not empty
                        if (metric.wsll && metric.wsll.trim() !== '') {
                            aggregatedData[metricName].wsllSet.add(metric.wsll.trim());
                        }
                    });
                }
            });
            
            // Calculate averages and prepare final data
            const finalData = {};
            Object.keys(aggregatedData).forEach(metricName => {
                const data = aggregatedData[metricName];
                
                const avgScore = data.scores.length > 0
                    ? (data.scores.reduce((a, b) => a + b, 0) / data.scores.length)
                    : 0;
                
                // Use metric name as the key for final data
                finalData[metricName] = {
                    name: data.name,
                    icon: '', // Default icon since metrics don't have icons in array structure
                    avgScore: avgScore,
                    wsllList: Array.from(data.wsllSet),
                    contextNote: ''
                };
            });
            
            clientSyncState.aggregatedData = finalData;
            clientSyncState.contextNotes = {};
            
            // Render the card
            renderClientSyncCard();
            
            // Show preview, hide config
            document.getElementById('client-sync-config').classList.add('hidden');
            document.getElementById('client-sync-preview').classList.remove('hidden');
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function getPerformanceBadge(score) {
            let label = '';
            let bgColor = '';
            let textColor = '';
            
            if (score >= 4.5) {
                label = 'Outstanding';
                bgColor = 'bg-purple-100';
                textColor = 'text-purple-700';
            } else if (score >= 4.0) {
                label = 'Exceeds Expectations';
                bgColor = 'bg-blue-100';
                textColor = 'text-blue-700';
            } else if (score >= 3.5) {
                label = 'Strong Performer';
                bgColor = 'bg-teal-100';
                textColor = 'text-teal-700';
            } else if (score >= 3.0) {
                label = 'Meets Expectations';
                bgColor = 'bg-green-100';
                textColor = 'text-green-700';
            } else if (score >= 2.0) {
                label = 'Developing';
                bgColor = 'bg-amber-100';
                textColor = 'text-amber-700';
            } else {
                label = 'Below Expectations';
                bgColor = 'bg-red-100';
                textColor = 'text-red-700';
            }
            
            return { label, bgColor, textColor };
        }

        function renderClientSyncCard() {
            // Update card header
            document.getElementById('card-member-name').textContent = clientSyncState.memberName;
            document.getElementById('card-member-role').textContent = clientSyncState.memberRole;
            document.getElementById('card-date-range').textContent = `${clientSyncState.startMonth} - ${clientSyncState.endMonth}`;
            
            // Render metrics
            const container = document.getElementById('card-metrics-container');
            container.innerHTML = '';
            
            const metrics = Object.keys(clientSyncState.aggregatedData);
            if (metrics.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center py-8">No performance metrics found in this period.</p>';
                return;
            }
            
            metrics.forEach(metricId => {
                const data = clientSyncState.aggregatedData[metricId];
                const badge = getPerformanceBadge(data.avgScore);
                
                const metricDiv = document.createElement('div');
                metricDiv.className = 'border-b border-slate-200 pb-6 last:border-b-0';
                
                // WSLL list HTML
                let wsllHtml = '';
                if (data.wsllList.length > 0) {
                    wsllHtml = `
                        <div class="mt-3">
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Success Criteria</p>
                            <ul class="space-y-1.5">
                                ${data.wsllList.map(wsll => `
                                    <li class="text-sm text-slate-700 flex items-start gap-2">
                                        <span class="text-blue-500 mt-1"></span>
                                        <span>${wsll}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    wsllHtml = `
                        <div class="mt-3">
                            <p class="text-xs text-slate-400 italic">No success criteria defined for this period.</p>
                        </div>
                    `;
                }
                
                metricDiv.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i data-lucide="${data.icon}" class="w-5 h-5 text-blue-600"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-slate-800">${data.name}</h4>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-3xl font-black text-blue-600">${data.avgScore.toFixed(1)}</p>
                            <p class="text-xs text-slate-500 font-bold mb-2">/ 5.0</p>
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${badge.bgColor} ${badge.textColor} uppercase tracking-wide">
                                ${badge.label}
                            </span>
                        </div>
                    </div>
                    ${wsllHtml}
                    <div class="mt-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Context Note</label>
                        <textarea 
                            oninput="updateContextNote('${metricId}', this.value)"
                            placeholder="Add context for the client (optional)..."
                            class="w-full p-3 rounded-lg border border-slate-200 bg-slate-50 text-slate-700 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                            rows="2">${clientSyncState.contextNotes[metricId] || ''}</textarea>
                    </div>
                `;
                
                container.appendChild(metricDiv);
            });
            
            // Render email template
            renderEmailTemplate();
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updateContextNote(metricId, text) {
            clientSyncState.contextNotes[metricId] = text;
            
            // Update the card display (for export)
            const data = clientSyncState.aggregatedData[metricId];
            if (data) {
                data.contextNote = text;
            }
        }

        function renderEmailTemplate() {
            const emailText = `Hi [Client Name],

Please find attached the Performance Summary for ${clientSyncState.memberName} covering ${clientSyncState.startMonth} - ${clientSyncState.endMonth}.

This summary reflects our internal alignment on their Key Focus Areas (Metrics), Success Criteria, and Performance Rating.

We want to ensure that our current understanding of the role's priorities matches yours. Your validation here will serve as the baseline for the metrics we track in the next cycle.

Please simply reply with one of the options below:

A. Fully Aligned: This matches my experience; the metrics and scores are accurate.
B. Mostly Aligned: I agree with the performance, but I'd like to adjust the Focus/Metrics for next time.
C. Misaligned: I have different feedback or priorities.
D. Can we have a quick meeting?

Best,
[Your Name]`;
            
            document.getElementById('email-template-text').textContent = emailText;
        }

        function copyEmailTemplate() {
            const emailText = document.getElementById('email-template-text').textContent;
            
            navigator.clipboard.writeText(emailText).then(() => {
                showToast('Email template copied to clipboard!', 'success');
            }).catch(err => {
                showToast('Failed to copy to clipboard', 'error');
                console.error('Copy failed:', err);
            });
        }

        function previewClientSyncCard() {
            const cardElement = document.getElementById('client-sync-card');
            
            if (!cardElement) {
                showToast('Card element not found', 'error');
                return;
            }
            
            // Clone the card
            const cardClone = cardElement.cloneNode(true);
            cardClone.id = 'client-sync-preview-clone';
            cardClone.classList.add('transform', 'scale-105', 'shadow-2xl', 'rounded-2xl', 'overflow-hidden');
            
            // Insert clone into preview container
            const previewContainer = document.getElementById('client-sync-preview-container');
            previewContainer.innerHTML = '';
            previewContainer.appendChild(cardClone);
            
            // Show preview modal
            const modal = document.getElementById('client-sync-preview-modal');
            modal.classList.remove('hidden');
            
            // Animate in
            setTimeout(() => {
                cardClone.classList.add('animate-in', 'fade-in', 'zoom-in');
            }, 10);
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeClientSyncPreview() {
            const modal = document.getElementById('client-sync-preview-modal');
            modal.classList.add('hidden');
        }

        async function downloadClientSyncCard() {
            const cardElement = document.getElementById('client-sync-card');
            
            if (!cardElement) {
                showToast('Card element not found', 'error');
                return;
            }
            
            try {
                showToast('Generating image...', 'info');
                
                const canvas = await html2canvas(cardElement, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true
                });
                
                const link = document.createElement('a');
                const fileName = `performance-statement-${clientSyncState.memberName.replace(/\s+/g, '-')}-${clientSyncState.startMonth.replace(/\s+/g, '')}-${clientSyncState.endMonth.replace(/\s+/g, '')}.png`;
                link.download = fileName;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showToast('Image downloaded successfully!', 'success');
            } catch (error) {
                showToast('Failed to generate image', 'error');
                console.error('html2canvas error:', error);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('client-sync-member-dropdown');
            const searchInput = document.getElementById('client-sync-member-search');
            
            if (dropdown && searchInput && !dropdown.contains(e.target) && e.target !== searchInput) {
                dropdown.classList.add('hidden');
            }
        });

        // ==========================================
        // QUICK CAPTURE LOGIC (Smart Parser)
        // ==========================================
        let qcDetectedTm = null;
        let qcMode = 'log'; // Values: 'log' or 'task'
        let qcDetectedType = 'note';

        function toggleQuickCapture() {
            const m = document.getElementById('quickCaptureModal');
            const i = document.getElementById('qcInput');

            if (!m || !i) {
                console.error("Quick Capture DOM elements missing.");
                return;
            }

            m.classList.toggle('opacity-0');
            m.classList.toggle('pointer-events-none');

            // If opening...
            if (!m.classList.contains('opacity-0')) {
                i.value = '';
                qcMode = 'log'; // Reset to default
                analyzeQuickCapture(); // Reset badges
                setTimeout(() => i.focus(), 100); // Auto-focus
            }
        }

        // ==========================================
        // VOICE-TO-ACTION LOGIC
        // ==========================================
        let recognition = null;
        let isRecording = false;

        const AI_ROUTING_PROMPT = `You are a productivity assistant. Your job is to parse a voice transcription and route it to the correct module.
        
        OUTPUT FORMAT: JSON ONLY.
        
        SCHEMA:
        {
            "module": "myDesk" | "logbook",
            "action": "create",
            "data": {
                "title": "string",
                "notes": "string",
                "dueDate": "YYYY-MM-DD" (if myDesk),
                "tmId": "string" (if logbook, match from team list),
                "category": "string"
            }
        }
        
        TEAM LIST:
        ${JSON.stringify(appData.team.map(t => ({ id: t.id, name: t.name, nickname: t.nickname })))}
        
        CURRENT DATE: ${new Date().toISOString().split('T')[0]}
        
        INSTRUCTIONS:
        1. If it's a personal task or reminder, route to "myDesk".
        2. If it mentions a team member, route to "logbook".
        3. Extract the core task/note as "title".
        4. If a date is mentioned (e.g., "tomorrow", "Friday"), calculate the YYYY-MM-DD.
        5. If no date is mentioned for a task, default to today.
        6. Return ONLY the JSON object.`;

        function toggleVoiceCapture() {
            if (isRecording) {
                stopVoiceCapture();
            } else {
                startVoiceCapture();
            }
        }

        function startVoiceCapture() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showToast("Speech recognition is not supported in this browser.", "error");
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('qcMicBtn').classList.add('recording');
                document.getElementById('qcWaveform').classList.add('active');
                showToast("Listening...", "info");
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('qcInput').value = transcript;
                analyzeQuickCapture();
                routeVoiceAction(transcript);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                stopVoiceCapture();
                showToast(`Voice error: ${event.error}`, "error");
            };

            recognition.onend = () => {
                stopVoiceCapture();
            };

            recognition.start();
        }

        function stopVoiceCapture() {
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            document.getElementById('qcMicBtn').classList.remove('recording');
            document.getElementById('qcWaveform').classList.remove('active');
        }

        async function routeVoiceAction(text) {
            if (!text || text.trim().length < 5) return;

            showToast("AI Routing...", "info");

            // Use Gemini 2.5 Flash for routing
            const response = await callGeminiAI(
                `Parse this voice command: "${text}"`,
                [],
                AI_ROUTING_PROMPT
            );

            if (response.error) {
                showToast("AI Routing failed. Please save manually.", "warning");
                return;
            }

            try {
                // Clean up potential markdown code blocks from AI response
                const jsonStr = response.content.replace(/```json|```/g, '').trim();
                const actionData = JSON.parse(jsonStr);
                executeRoutedAction(actionData);
            } catch (e) {
                console.error("Failed to parse AI routing response:", e);
                showToast("AI parsing error. Please save manually.", "warning");
            }
        }

        function executeRoutedAction(actionData) {
            if (actionData.module === 'myDesk') {
                const newTask = {
                    id: 'task_' + Date.now(),
                    title: actionData.data.title,
                    notes: actionData.data.notes || '',
                    dueDate: actionData.data.dueDate || new Date().toISOString().split('T')[0],
                    status: 'At Hand',
                    priority: 'Medium',
                    category: actionData.data.category || 'General',
                    createdAt: new Date().toISOString()
                };
                appData.myDesk.push(newTask);
                showToast(` Task created: ${newTask.title}`, "success");
            } else if (actionData.module === 'logbook') {
                const tm = appData.team.find(t => t.id === actionData.data.tmId) || appData.team[0];
                const newEntry = {
                    id: 'log_' + Date.now(),
                    tmId: tm.id,
                    title: actionData.data.title,
                    notes: actionData.data.notes || '',
                    date: new Date().toISOString().split('T')[0],
                    type: 'Note',
                    sentiment: 'Neutral'
                };
                if (!appData.logbook) appData.logbook = [];
                appData.logbook.push(newEntry);
                showToast(` Log entry for ${tm.name} created`, "success");
            }

            saveData();

            // Visual feedback: briefly highlight the save button or close modal
            const btn = document.getElementById('qcSaveBtn');
            btn.textContent = "Routed!";
            btn.className = "bg-green-600 text-white px-6 py-2 rounded-lg font-bold text-sm transition-all shadow-md";

            setTimeout(() => {
                toggleQuickCapture();
                // Refresh views if they are active
                if (activeTool === 'ActionHub') {
                    if (currentHubTab === 'myDesk') renderHubView();
                    if (currentHubTab === 'logbook') renderLogbook();
                }
            }, 1000);
        }

        function analyzeQuickCapture() {

            const inputEl = document.getElementById('qcInput');
            if (!inputEl) return;

            const raw = inputEl.value;
            const lower = raw.toLowerCase();
            const badgeTm = document.getElementById('qcBadgeTm');
            const badgeType = document.getElementById('qcBadgeType');
            const btn = document.getElementById('qcSaveBtn');

            // TRIGGER WORDS for Tasks
            const taskKeywords = ['task', 'todo', 'remind'];

            // MODE 1: PERSONAL TASK
            if (taskKeywords.some(kw => lower.startsWith(kw))) {
                qcMode = 'task';
                qcDetectedTm = null;

                // Update UI for Task
                badgeTm.classList.remove('hidden', 'bg-slate-200', 'text-slate-500');
                badgeTm.classList.add('bg-hub-100', 'text-hub-700', 'border-hub-200');
                badgeTm.textContent = ` Personal Task`;

                badgeType.classList.remove('hidden');
                badgeType.className = `px-2 py-1 rounded text-xs font-bold transition-all items-center border bg-slate-100 text-slate-700 border-slate-200`;
                badgeType.textContent = ` Due Today`;

                // Enable Save if text exists
                if (raw.trim().length > 4) {
                    btn.disabled = false;
                    btn.className = "bg-hub-600 hover:bg-hub-700 text-white px-6 py-2 rounded-lg font-bold text-sm transition-all shadow-md transform active:scale-95";
                } else {
                    btn.disabled = true;
                    btn.className = "bg-slate-300 text-white px-6 py-2 rounded-lg font-bold text-sm transition-all cursor-not-allowed shadow-sm";
                }

            } else {
                // MODE 2: TEAM LOG
                qcMode = 'log';

                // Detect Team Member (Longest names first to avoid partial matches)
                const activeTeam = appData.team.filter(t => t.active).sort((a, b) => b.name.length - a.name.length);
                qcDetectedTm = null;

                for (const tm of activeTeam) {
                    const nick = (tm.nickname || "").toLowerCase();
                    const nameLower = tm.name.toLowerCase();

                    // Match Nickname OR Full Name
                    if ((nick && lower.includes(nick)) || lower.includes(nameLower)) {
                        qcDetectedTm = tm;
                        break;
                    }
                }

                // Update UI for Team Member
                if (qcDetectedTm) {
                    badgeTm.classList.remove('hidden', 'bg-slate-200', 'text-slate-500');
                    badgeTm.classList.add('bg-hub-100', 'text-hub-700', 'border-hub-200');
                    badgeTm.textContent = ` ${qcDetectedTm.name}`;
                } else {
                    badgeTm.classList.remove('hidden', 'bg-hub-100', 'text-hub-700', 'border-hub-200');
                    badgeTm.classList.add('bg-slate-200', 'text-slate-500');
                    badgeTm.textContent = ` Detecting...`;
                }

                // Detect Type (Note / Issue / Request / Kudos)
                qcDetectedType = 'note';
                let icon = '';
                let colorClass = 'bg-slate-50 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700';

                // Request keywords
                if (lower.includes('request') || lower.includes('pto') || lower.includes('leave') || lower.includes('need')) {
                    qcDetectedType = 'request';
                    icon = '';
                    colorClass = 'bg-blue-50 text-blue-700 border-blue-100 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-900/50';

                    // Kudos / positive feedback
                } else if (lower.includes('kudos') || lower.includes('good') || lower.includes('great') || lower.includes('thanks')) {
                    qcDetectedType = 'kudos';
                    icon = '';
                    colorClass = 'bg-green-50 text-green-700 border-green-100 dark:bg-green-900/30 dark:text-green-400 dark:border-green-900/50';

                    // Issue / problem
                } else if (lower.includes('issue') || lower.includes('problem') || lower.includes('error') || lower.includes('down') || lower.includes('outage')) {
                    qcDetectedType = 'issue';
                    icon = '';
                    colorClass = 'bg-red-50 text-red-700 border-red-100 dark:bg-red-900/30 dark:text-red-400 dark:border-red-900/50';

                    // Optional: explicit Note words (kept last since Note is already default)
                } else if (lower.includes('note') || lower.includes('fyi') || lower.includes('heads up') || lower.includes('update')) {
                    qcDetectedType = 'note';
                    icon = '';
                    colorClass = 'bg-slate-50 text-slate-600 border-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700';
                }

                badgeType.classList.remove('hidden');
                badgeType.className = `px-2 py-1 rounded text-xs font-bold transition-all items-center border ${colorClass}`;
                badgeType.textContent = `${icon} ${qcDetectedType.charAt(0).toUpperCase() + qcDetectedType.slice(1)}`;

                // Enable Save Logic
                if (qcDetectedTm && raw.trim().length > 3) {
                    btn.disabled = false;
                    btn.className = "bg-hub-600 hover:bg-hub-700 text-white px-6 py-2 rounded-lg font-bold text-sm transition-all shadow-md transform active:scale-95";
                } else {
                    btn.disabled = true;
                    btn.className = "bg-slate-300 text-white px-6 py-2 rounded-lg font-bold text-sm transition-all cursor-not-allowed shadow-sm";
                }
            }
        }

        function saveQuickCapture() {
            const rawInput = document.getElementById('qcInput').value;

            if (qcMode === 'task') {
                // Save to My Desk
                appData.myDesk.push({
                    id: 'desk_' + Date.now(),
                    title: rawInput.replace(/^(task|todo|remind)\s*/i, ''), // Remove trigger word
                    dueDate: getTodayShort(),
                    category: 'Admin',
                    status: 'OnTheTable', // Defaults to Today
                    notes: 'Quick Captured',
                    sourceId: null
                });
                showToast("Task added to My Desk", "success");

                // Refresh View if needed
                if (typeof renderMyDesk === 'function') renderMyDesk();

            } else {
                // Save to Logbook
                if (!qcDetectedTm) return;
                let entry = {
                    id: 'log_' + Date.now(),
                    tmId: qcDetectedTm.id,
                    date: getTodayShort(),
                    title: rawInput.substring(0, 50) + (rawInput.length > 50 ? "..." : ""),
                    type: qcDetectedType,
                    notes: rawInput,
                    status: (qcDetectedType === 'kudos' || qcDetectedType === 'note') ? 'Closed' : 'Open'
                };

                if (qcDetectedType !== 'note' && qcDetectedType !== 'kudos') {
                    entry.dueDate = getTodayShort();
                }
                appData.logbook.push(entry);
                showToast(`Saved ${qcDetectedType} for ${qcDetectedTm.name}`, "success");

                // Refresh View if needed
                if (typeof renderLogbook === 'function') renderLogbook();
            }

            saveData();
            toggleQuickCapture(); // Close modal
        }

        // ==========================================
        // UNIVERSAL ESC KEY HANDLER & VIEW HISTORY
        // ==========================================

        // Track view history for back navigation
        const viewHistory = {
            stack: [],
            maxSize: 10,
            push(view) {
                if (this.stack.length > 0 && this.stack[this.stack.length - 1] === view) return;
                this.stack.push(view);
                if (this.stack.length > this.maxSize) this.stack.shift();
            },
            pop() {
                if (this.stack.length > 1) {
                    this.stack.pop();
                    return this.stack[this.stack.length - 1];
                }
                return null;
            },
            getCurrent() {
                return this.stack.length > 0 ? this.stack[this.stack.length - 1] : null;
            }
        };

        function getOpenModals() {
            const modals = document.querySelectorAll('.modal');
            const openModals = [];
            modals.forEach(modal => {
                if (!modal.classList.contains('opacity-0') && !modal.classList.contains('pointer-events-none')) {
                    openModals.push(modal);
                }
            });
            return openModals;
        }

        function closeTopmostModal(modals) {
            if (modals.length === 0) return false;
            let topmostModal = modals[0];
            let highestZ = parseInt(window.getComputedStyle(topmostModal).zIndex) || 0;
            modals.forEach(modal => {
                const z = parseInt(window.getComputedStyle(modal).zIndex) || 0;
                if (z > highestZ) {
                    highestZ = z;
                    topmostModal = modal;
                }
            });
            const modalId = topmostModal.id;
            if (modalId === 'rosterModal' && typeof toggleRosterModal === 'function') {
                toggleRosterModal();
            } else if (modalId === 'quickCaptureModal' && typeof toggleQuickCapture === 'function') {
                toggleQuickCapture();
            } else if (modalId === 'emailDrafterModal' && typeof toggleEmailDrafter === 'function') {
                toggleEmailDrafter();
            } else if (typeof toggleModal === 'function') {
                toggleModal(modalId);
            } else {
                topmostModal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }
            return true;
        }

        function toggleShortcutsModal(show) {
            const modal = document.getElementById('shortcutsModal');
            const content = document.getElementById('shortcutsContent');

            if (show) {
                modal.classList.remove('hidden');
                // Small delay to allow display:block to apply before opacity transition
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                }, 10);
            } else {
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200); // Match CSS duration
            }
        }



        function navigateBack() {
            // viewHistory.pop() returns the previous view (already removes current from stack)
            const previousView = viewHistory.pop();
            if (!previousView) return false;

            const [tool, tab] = previousView.split(':');
            if (tool && tab) {
                // Temporarily disable tracking to avoid re-adding to history
                const tempTracking = window.trackingEnabled;
                window.trackingEnabled = false;

                if (tool !== activeTool) switchTool(tool);
                switchTab(tab);

                window.trackingEnabled = tempTracking;
                return true;
            }
            return false;
        }

        function trackViewChange(tool, tab) {
            if (window.trackingEnabled === false) return;
            const viewKey = `${tool}:${tab}`;
            viewHistory.push(viewKey);
        }

        // --- KEYBOARD SHORTCUTS ---
        // --- UPGRADE: Keyboard First Logic (Universal Escape & Submit) ---

        document.addEventListener('keydown', function (e) {
            // Skip if user is typing in an input, textarea, or contenteditable
            const activeEl = document.activeElement;
            const isTyping = activeEl && (
                activeEl.tagName === 'INPUT' ||
                activeEl.tagName === 'TEXTAREA' ||
                activeEl.isContentEditable
            );

            // --- ESCAPE KEY HANDLING ---
            if (e.key === 'Escape') {
                e.preventDefault();

                // First, check for Client Sync preview modal
                const clientSyncPreviewModal = document.getElementById('client-sync-preview-modal');
                if (clientSyncPreviewModal && !clientSyncPreviewModal.classList.contains('hidden')) {
                    closeClientSyncPreview();
                    return;
                }

                // Check for specific modals with custom toggle functions
                const shortcutsModal = document.getElementById('shortcutsModal');
                if (shortcutsModal && !shortcutsModal.classList.contains('hidden')) {
                    toggleShortcutsModal(false);
                    return;
                }

                const commandPalette = document.getElementById('commandPalette');
                if (commandPalette && !commandPalette.classList.contains('hidden') && !commandPalette.classList.contains('opacity-0')) {
                    if (typeof toggleCommandPalette === 'function') {
                        toggleCommandPalette();
                    } else {
                        commandPalette.classList.add('hidden', 'opacity-0');
                    }
                    return;
                }

                // Then check for any other open modals
                const openModals = getOpenModals();
                if (openModals.length > 0) {
                    closeTopmostModal(openModals);
                    return;
                }

                // If no modals, navigate back
                navigateBack();
                return;
            }

            // Skip other shortcuts if typing (except Escape handled above)
            if (isTyping) return;

            // --- QUICK CAPTURE: Alt + C ---
            if (e.altKey && (e.key === 'c' || e.key === 'C')) {
                e.preventDefault();
                if (typeof toggleQuickCapture === 'function') {
                    toggleQuickCapture();
                }
                return;
            }

            // --- EMAIL DRAFTER: Alt + E ---
            if (e.altKey && (e.key === 'e' || e.key === 'E')) {
                e.preventDefault();
                if (typeof toggleEmailDrafter === 'function') {
                    toggleEmailDrafter();
                }
                return;
            }

            // --- TOOL SWITCHING: Alt + 1 = Action Hub, Alt + 2 = Pulse Check ---
            if (e.altKey && e.key === '1') {
                e.preventDefault();
                if (typeof switchTool === 'function') {
                    switchTool('ActionHub');
                }
                return;
            }

            if (e.altKey && e.key === '2') {
                e.preventDefault();
                if (typeof switchTool === 'function') {
                    switchTool('PulseCheck');
                }
                return;
            }

            // --- TOGGLE DARK MODE: Alt + D ---
            if (e.altKey && (e.key === 'd' || e.key === 'D')) {
                e.preventDefault();
                if (typeof toggleDarkMode === 'function') {
                    toggleDarkMode();
                }
                return;
            }

            // --- COMMAND PALETTE: Cmd/Ctrl + K ---
            if ((e.metaKey || e.ctrlKey) && (e.key === 'k' || e.key === 'K')) {
                e.preventDefault();
                if (typeof toggleCommandPalette === 'function') {
                    toggleCommandPalette();
                }
                return;
            }

            // --- KEYBOARD SHORTCUTS MODAL: ? key ---
            if (e.key === '?' || (e.shiftKey && e.key === '/')) {
                e.preventDefault();
                toggleShortcutsModal(true);
                return;
            }

            // --- TAB NAVIGATION: [ and ] ---
            if (e.key === '[') {
                e.preventDefault();
                navigateTab(-1); // Previous tab
                return;
            }

            if (e.key === ']') {
                e.preventDefault();
                navigateTab(1); // Next tab
                return;
            }
        });

        // Helper function for tab navigation with [ and ]
        function navigateTab(direction) {
            let allTabs = [];
            let currentTab = '';

            if (activeTool === 'ActionHub') {
                allTabs = ['mailbox', 'myDesk', 'projects', 'pipeline', 'logbook', 'broadcast', 'performance'];
                currentTab = currentHubTab;
            } else if (activeTool === 'PulseCheck') {
                allTabs = ['teamInfo', 'pulse', 'timesheets', 'rollCall', 'reliability', 'capacity', 'quickLinks'];
                currentTab = currentPulseTab;
            } else {
                return;
            }

            // Filter for only visible tabs
            const visibleTabs = allTabs.filter(tabId => {
                // Construct button ID from tabId
                const btnId = 'tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1);
                const btn = document.getElementById(btnId);
                return btn && !btn.classList.contains('hidden');
            });

            if (visibleTabs.length === 0) return;

            let currentIndex = visibleTabs.indexOf(currentTab);

            // If current tab isn't visible for some reason, default to 0
            if (currentIndex === -1) currentIndex = 0;

            let newIndex = currentIndex + direction;

            if (newIndex < 0) {
                newIndex = visibleTabs.length - 1;
            } else if (newIndex >= visibleTabs.length) {
                newIndex = 0;
            }

            const newTabToSwitch = visibleTabs[newIndex];
            switchTab(newTabToSwitch);
        }

        console.log(' Universal keyboard shortcuts loaded (Alt+C, Escape, etc)');


        // --- AI LOGIC ---
        function saveGeminiKey() {
            // Get API key from main settings modal
            const key = document.getElementById('set_geminiKey')?.value.trim();

            if (key) {
                localStorage.setItem('leadershipOS_GeminiKey', key);
                localStorage.setItem('gemini_api_key', key); // Also save with alternate key name for AI assistant
                showToast("API Key saved!", "success");
                updateAIBadge(); // Update badge to show AI is ready
            } else {
                showToast("Please enter a valid API key", "error");
            }
        }

        // Load key on startup
        function loadGeminiKey() {
            const key = localStorage.getItem('leadershipOS_GeminiKey');

            if (key) {
                // Also save to alternate key name for consistency
                localStorage.setItem('gemini_api_key', key);

                if (document.getElementById('set_geminiKey')) {
                    document.getElementById('set_geminiKey').value = key;
                }
            }
        }

        async function generateAiDraft(targetId = 'finalDraft', btnId = 'btnAiRefine') {
            const key = localStorage.getItem('leadershipOS_GeminiKey');

            // 1. Check if Key exists
            if (!key) {
                showToast("Missing API Key. Check Settings.", "error");
                toggleModal('settingsModal');
                return;
            }

            const currentText = document.getElementById(targetId).value;

            // 2. Check if there is text to polish
            if (!currentText) {
                showToast("Generate a basic draft first.", "info");
                return;
            }

            // 3. UI Loading State
            const btn = document.getElementById(btnId);
            if (!btn) return;

            const originalBtnText = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin h-4 w-4 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Thinking...`;
            btn.disabled = true;

            // Get Tone if available
            const toneSelect = document.getElementById('emailDrafterTone');
            const selectedTone = toneSelect ? toneSelect.value : 'Professional';

            let toneInstruction = "Professional but warm.";
            if (selectedTone === 'Direct') toneInstruction = "Direct, concise, and to the point. Minimal fluff.";
            if (selectedTone === 'Empathetic') toneInstruction = "Highly empathetic, understanding, and supportive. Soft tone.";
            if (selectedTone === 'Casual') toneInstruction = "Casual, friendly, and relaxed. Good for internal team chats.";

            // NEW: Check for custom guide
            const customGuide = document.getElementById('emailDrafterGuide')?.value;

            let prompt = "";
            if (customGuide && customGuide.trim() !== "") {
                // Prioritize the custom guide from the box
                prompt = `
           Context: I am a Team Lead.
           Current Draft: "${currentText}"
           Custom User Instructions: "${customGuide}"
           Tone: ${toneInstruction}
           
           Task: Polish the current draft into a clear email, strictly following the Custom User Instructions provided.
           Output: Just the email body text. No preamble.
       `;
            } else {
                // Use default style guide
                prompt = `
           Context: I am a Team Lead.
           Current Draft: "${currentText}"
           Task: Polish the following draft into a clear email.
           
           Tone: ${toneInstruction}

           My Style & Phrasing Guide:
            1. Structure: - Greeting: Appropriate for the tone.
   - The News: Be clear.
   - Specific Details: Use "experiencing" for technical issues.
   - Action/Policy: Mention next steps.
   - Proactive Follow-up: Include a clear plan.
            2. Closing: "Please let me know if you have any questions" or "LMK if you have questions."
            3. Sign-off: "Best,"
           Output: Just the email body text. No preamble. Match the requested tone perfectly.
            
       `;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();

                // 4. ERROR HANDLING (The Fix)
                if (!response.ok) {
                    console.error("Gemini API Error:", data);
                    // Extract the actual error message from Google
                    let errorMsg = data.error?.message || "Unknown API Error";
                    throw new Error(errorMsg);
                }

                if (data.candidates && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    document.getElementById(targetId).value = aiText.trim();
                    showToast("Draft refined by Gemini!", "success");
                } else {
                    throw new Error("Invalid response format from AI");
                }
            } catch (error) {
                console.error(error);
                // Show the ACTUAL error message in the toast
                showToast(`AI Error: ${error.message}`, "error");
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
        }



    </script>



    <div class="fixed bottom-8 right-8 z-40 flex flex-col items-end space-y-3 group">
        <div
            class="flex flex-col items-end space-y-3 opacity-0 translate-y-4 pointer-events-none group-hover:opacity-100 group-hover:translate-y-0 group-hover:pointer-events-auto transition-all duration-300 ease-out">

            <button onclick="toggleQuickCapture()" class="flex items-center group/item">
                <span
                    class="mr-3 text-xs font-bold text-slate-500 bg-white px-2 py-1 rounded shadow-sm opacity-0 group-hover/item:opacity-100 transition-opacity">Quick
                    Note (Alt+C)</span>
                <div
                    class="w-10 h-10 bg-white text-slate-600 hover:text-hub-600 rounded-full shadow-lg flex items-center justify-center border border-slate-100 transition-transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </div>
            </button>

            <button onclick="switchTool('ActionHub'); openBroadcastModal()" class="flex items-center group/item">
                <span
                    class="mr-3 text-xs font-bold text-slate-500 bg-white px-2 py-1 rounded shadow-sm opacity-0 group-hover/item:opacity-100 transition-opacity">New
                    Broadcast</span>
                <div
                    class="w-10 h-10 bg-white text-slate-600 hover:text-hub-600 rounded-full shadow-lg flex items-center justify-center border border-slate-100 transition-transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M11 6a13 13 0 0 0 8.4-2.8A1 1 0 0 1 21 4v12a1 1 0 0 1-1.6.8A13 13 0 0 0 11 14H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z" />
                        <path d="M6 14a12 12 0 0 0 2.4 7.2 2 2 0 0 0 3.2-2.4A8 8 0 0 1 10 14" />
                        <path d="M8 6v8" />
                    </svg>
                </div>
            </button>

            <button onclick="switchTool('ActionHub'); openMyDeskModal()" class="flex items-center group/item">
                <span
                    class="mr-3 text-xs font-bold text-slate-500 bg-white px-2 py-1 rounded shadow-sm opacity-0 group-hover/item:opacity-100 transition-opacity">New
                    Task</span>
                <div
                    class="w-10 h-10 bg-white text-slate-600 hover:text-hub-600 rounded-full shadow-lg flex items-center justify-center border border-slate-100 transition-transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                </div>
            </button>

            <button onclick="switchTool('ActionHub'); openLogbookModal()" class="flex items-center group/item">
                <span
                    class="mr-3 text-xs font-bold text-slate-500 bg-white px-2 py-1 rounded shadow-sm opacity-0 group-hover/item:opacity-100 transition-opacity">New
                    Log Entry</span>
                <div
                    class="w-10 h-10 bg-white text-slate-600 hover:text-hub-600 rounded-full shadow-lg flex items-center justify-center border border-slate-100 transition-transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </div>
            </button>
        </div>

        <button
            class="w-14 h-14 bg-hub-600 hover:bg-hub-700 text-white rounded-full shadow-2xl flex items-center justify-center transition-all duration-300 hover:scale-110 hover:rotate-90 focus:outline-none ring-4 ring-hub-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
        </button>
    </div>

    <div id="colorModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-[70] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"
            onclick="toggleModal('colorModal')"></div>
        <div
            class="modal-container bg-white border border-slate-200 w-full max-w-lg mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden">
            <div class="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-slate-800">Account Color Mapping</h3>
                <button onclick="toggleModal('colorModal')" class="text-slate-400 hover:text-slate-600"></button>
            </div>
            <div id="colorModalList" class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
            </div>
            <div class="bg-slate-50 p-4 border-t border-slate-200 text-right">
                <button onclick="saveAccountColors()"
                    class="bg-dcx-blue hover:bg-dcx-light text-white font-bold py-2 px-6 rounded-lg shadow-sm">Save
                    Colors</button>
            </div>
        </div>
    </div>

    <div id="settingsModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"
            onclick="toggleModal('settingsModal')"></div>
        <div
            class="modal-container bg-white border border-slate-200 w-full max-w-2xl mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden">
            <div class="bg-slate-50 p-5 border-b border-slate-200 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg">Settings</h3>
                    <p class="text-xs text-slate-500">Manage your workspace preferences</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="lockApp()" class="text-slate-400 hover:text-slate-600 transition-colors"
                        title="Lock Application">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </button>
                    <button onclick="toggleModal('settingsModal')"
                        class="text-slate-400 hover:text-slate-600"></button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="border-b border-slate-200 bg-slate-50">
                <div class="flex overflow-x-auto">
                    <button onclick="switchSettingsTab('general')" id="tab-btn-general"
                        class="settings-tab-btn px-6 py-3 text-sm font-medium text-dcx-blue border-b-2 border-dcx-blue font-bold transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        General
                    </button>
                    <button onclick="switchSettingsTab('modules')" id="tab-btn-modules"
                        class="settings-tab-btn px-6 py-3 text-sm font-medium text-slate-600 hover:text-slate-800 border-b-2 border-transparent hover:border-slate-300 transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z" />
                        </svg>
                        Modules
                    </button>
                    <button onclick="switchSettingsTab('data')" id="tab-btn-data"
                        class="settings-tab-btn px-6 py-3 text-sm font-medium text-slate-600 hover:text-slate-800 border-b-2 border-transparent hover:border-slate-300 transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                        </svg>
                        Data
                    </button>
                    <button onclick="switchSettingsTab('ai')" id="tab-btn-ai"
                        class="settings-tab-btn px-6 py-3 text-sm font-medium text-slate-600 hover:text-slate-800 border-b-2 border-transparent hover:border-slate-300 transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        AI
                    </button>
                    <button onclick="switchSettingsTab('security')" id="tab-btn-security"
                        class="settings-tab-btn px-6 py-3 text-sm font-medium text-slate-600 hover:text-slate-800 border-b-2 border-transparent hover:border-slate-300 transition-all whitespace-nowrap flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        Security
                    </button>
                </div>
            </div>

            <!-- Tab Content Panels -->
            <div class="max-h-[60vh] overflow-y-auto">
                <!-- General Tab -->
                <div id="settings-tab-general" class="settings-tab-content p-6">
                    <div class="space-y-4">
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <label class="flex items-center justify-between cursor-pointer group">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg"></span>
                                    <span class="text-sm font-bold text-slate-700">Sound Effects</span>
                                </div>
                                <div class="relative inline-block w-11 h-6 align-middle select-none">
                                    <input type="checkbox" id="set_soundEffects" class="peer sr-only" checked
                                        onchange="saveModuleSettings()">
                                    <div
                                        class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <label class="flex items-center justify-between cursor-pointer group">
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-700 icon-moon"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                                    </svg>
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-5 w-5 text-slate-700 icon-sun hidden" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                    <span class="text-sm font-bold text-slate-700">Dark Mode</span>
                                </div>
                                <div class="relative inline-block w-11 h-6 align-middle select-none">
                                    <input type="checkbox" id="set_darkMode" class="peer sr-only"
                                        onchange="toggleDarkMode();">
                                    <div
                                        class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                    </div>
                                </div>
                            </label>
                        </div>

                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <label class="block mb-2">
                                <span class="text-sm font-bold text-slate-700 block mb-2">User ID / Email</span>
                                <input type="text" id="set_userEmail" value=""
                                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-dcx-blue focus:border-dcx-blue text-sm"
                                    placeholder="admin@leados.com" onchange="saveUserProfile()">
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Modules Tab -->
                <div id="settings-tab-modules" class="settings-tab-content p-6 hidden">
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">ActionHub</h4>
                            <div class="space-y-4">
                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">My Task Desk</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_myDesk" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-dcx-blue rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">Evaluation Pipeline</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_pipeline" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">TM Logbook</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_logbook" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">Broadcast Tracker</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_broadcast" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">Performance</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_performance" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">Project</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_projects" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">PulseCheck</h4>
                            <div class="space-y-4">
                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">Daily Roll Call</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_rollCall" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">Monthly Pulse</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_pulse" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">Timesheet Tracker</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_timesheets" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">Capacity Planner</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_capacity" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">Quick Links</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_quickLinks" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>

                                <label class="flex items-center justify-between cursor-pointer group">
                                    <span class="text-sm font-bold text-slate-700">Reliability</span>
                                    <div class="relative inline-block w-11 h-6 align-middle select-none">
                                        <input type="checkbox" id="set_reliability" class="peer sr-only" checked
                                            onchange="saveModuleSettings()">
                                        <div
                                            class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dcx-blue">
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-200 text-center text-xs text-slate-400">
                        Core modules (Team Info & Mailbox) cannot be disabled.
                    </div>
                </div>

                <!-- Data Tab -->
                <div id="settings-tab-data" class="settings-tab-content p-6 hidden">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <h4 class="text-xs font-bold text-blue-800 uppercase tracking-wider mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                            </svg>
                            Data Management
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="btnBackup" onclick="exportData()"
                                class="flex flex-col items-center justify-center p-3 bg-white border border-blue-200 rounded-lg hover:shadow-md hover:border-blue-300 transition-all group">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="h-6 w-6 text-blue-500 mb-1 group-hover:scale-110 transition-transform"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                <span class="text-sm font-bold text-slate-700">Backup Data</span>
                            </button>
                            <label for="importFile"
                                class="flex flex-col items-center justify-center p-3 bg-white border border-blue-200 rounded-lg hover:shadow-md hover:border-blue-300 transition-all cursor-pointer group">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="h-6 w-6 text-slate-500 mb-1 group-hover:text-blue-500 group-hover:scale-110 transition-transform"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                </svg>
                                <span class="text-sm font-bold text-slate-700">Restore File</span>
                            </label>
                            <input type="file" id="importFile" class="hidden" onchange="importData(event)">
                        </div>
                        <div class="mt-4 pt-3 border-t border-blue-200/60">
                            <h5 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Zero-Loss
                                Auto-Save
                            </h5>

                            <button onclick="LocalBackup.connect()"
                                class="w-full flex items-center justify-center gap-2 bg-white hover:bg-indigo-50 text-indigo-600 font-bold py-3 px-4 rounded-xl transition-all border-2 border-dashed border-indigo-200 hover:border-indigo-400 group">
                                <div
                                    class="bg-indigo-100 text-indigo-600 rounded-full p-1 group-hover:scale-110 transition-transform">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                    </svg>
                                </div>
                                <span>Connect Local File</span>
                            </button>

                            <div id="backupStatusIndicator"
                                class="text-center text-xs font-medium text-slate-400 mt-2 flex items-center justify-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-slate-300"></span> Not connected
                            </div>
                        </div>

                        <!-- Cloud Sync Section -->
                        <div class="mt-4 pt-3 border-t border-blue-200/60">
                            <h5 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                                </svg>
                                Cloud Sync
                            </h5>

                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <button onclick="pushToCloud()" id="btnPushCloud"
                                    class="flex items-center justify-center gap-2 bg-white hover:bg-green-50 text-green-600 font-bold py-2.5 px-3 rounded-lg transition-all border border-green-200 hover:border-green-400 group text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <span>Push to Cloud</span>
                                </button>

                                <button onclick="pullFromCloud()" id="btnPullCloud"
                                    class="flex items-center justify-center gap-2 bg-white hover:bg-blue-50 text-blue-600 font-bold py-2.5 px-3 rounded-lg transition-all border border-blue-200 hover:border-blue-400 group text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                                    </svg>
                                    <span>Pull from Cloud</span>
                                </button>
                            </div>

                            <div id="cloudSyncStatus"
                                class="text-center text-xs font-medium text-slate-400 flex items-center justify-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-slate-300"></span>
                                <span id="cloudSyncStatusText">Never synced</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Tab -->
                <div id="settings-tab-ai" class="settings-tab-content p-6 hidden">
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <h4 class="text-xs font-bold text-purple-800 uppercase tracking-wider mb-3 flex items-center">
                            <span></span> Gemini AI Configuration
                        </h4>
                        <label class="block text-xs text-slate-500 mb-1">API Key (Saved locally)</label>
                        <div class="flex gap-2">
                            <input type="password" id="set_geminiKey" placeholder="Paste key here..."
                                class="flex-1 border border-purple-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-hub-500 bg-white">
                            <button onclick="saveGeminiKey()"
                                class="bg-hub-600 hover:bg-hub-700 text-white font-bold px-4 py-2 rounded-lg text-xs shadow-sm transition-colors">
                                Save
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div id="settings-tab-security" class="settings-tab-content p-6 hidden">
                    <div class="pt-4">
                        <button onclick="lockApp()"
                            class="w-full flex items-center justify-center gap-2 bg-slate-100 hover:bg-red-50 text-slate-600 hover:text-red-600 font-bold py-3 px-4 rounded-xl transition-all border border-slate-200 hover:border-red-200 group">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5 group-hover:scale-110 transition-transform" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                            <span>Lock Application</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="quickCaptureModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"
            onclick="toggleQuickCapture()"></div>
        <div
            class="modal-container bg-white border border-slate-200/95 backdrop-blur-xl w-full max-w-lg mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden border border-white/40 transform transition-all scale-100">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-hub-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                        Quick Capture
                    </h3>
                    <span class="text-xs font-mono text-slate-400 border px-2 py-1 rounded">ESC to close</span>
                </div>

                <div class="relative group">
                    <textarea id="qcInput" oninput="analyzeQuickCapture()"
                        class="w-full bg-slate-50 border-0 rounded-xl p-4 pr-16 text-lg text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-hub-500 focus:bg-white transition-all resize-none h-32 shadow-inner"
                        placeholder="Capture anything...&#10; Type 'Task Submit Report' for your desk&#10; Type 'Alex needs PTO' for the logbook"></textarea>

                    <div class="absolute right-3 top-3 flex flex-col items-center gap-3">
                        <button id="qcMicBtn" onclick="toggleVoiceCapture()" class="qc-mic-btn" title="Voice Dictation">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-20a3 3 0 00-3 3v8a3 3 0 006 0V5a3 3 0 00-3-3z" />
                            </svg>
                        </button>

                        <div id="qcWaveform" class="waveform-container">
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                        </div>
                    </div>
                </div>


                <div class="flex justify-between items-center mt-4 h-8">
                    <div class="flex space-x-2" id="qcBadges">
                        <span id="qcBadgeTm"
                            class="hidden px-2 py-1 rounded text-xs font-bold bg-slate-200 text-slate-500 transition-all items-center border border-slate-300">
                            Detecting...</span>
                        <span id="qcBadgeType"
                            class="hidden px-2 py-1 rounded text-xs font-bold bg-slate-200 text-slate-500 transition-all items-center border border-slate-300">
                            General</span>
                    </div>
                    <button onclick="saveQuickCapture()" id="qcSaveBtn"
                        class="bg-slate-300 text-white px-6 py-2 rounded-lg font-bold text-sm transition-all cursor-not-allowed shadow-sm"
                        disabled>Save Log</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        /* --- PERFORMANCE TAB LOGIC --- */

        /**
         * Generates a compact SVG sparkline for performance trends
         * @param {number[]} data - Array of performance scores
         * @returns {string} SVG string
         */
        function getSparklineSVG(data) {
            if (!data || data.length < 2) return '';
            const width = 60;
            const height = 25;
            const strokeWidth = 2.5;
            const padding = 3;

            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;

            const points = data.map((val, i) => {
                const x = (i / (data.length - 1)) * (width - padding * 2) + padding;
                const y = height - (((val - min) / range) * (height - padding * 2) + padding);
                return `${x.toFixed(1)},${y.toFixed(1)}`;
            }).join(' ');

            const isUp = data[data.length - 1] >= data[0];
            const color = isUp ? '#10b981' : '#f59e0b';

            const lastPoint = points.split(' ').pop().split(',');

            return `
                <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" class="overflow-visible">
                    <polyline points="${points}" fill="none" stroke="${color}" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="${lastPoint[0]}" cy="${lastPoint[1]}" r="3" fill="${color}" stroke="white" stroke-width="1" />
                </svg>
            `;
        }

        // Corrected Metrics from TSM Command
        const PERF_CORE_METRICS = [
            {
                id: 'quality-accuracy',
                icon: 'check-circle',
                name: 'Quality & Accuracy',
                definition: 'The ability to produce work that is precise, error-free, and meets established standards.',
                examples: [
                    'Consistently produces accurate and error-free work.',
                    'All reports and deliverables are consistently error-free.',
                    'Proactively identifies and corrects potential quality issues.',
                    'Ensures all data entries are verified and validated.',
                    'Receives consistent positive feedback on the correctness of deliverables.'
                ],
                wsllOptions: [
                    'Consistently produces accurate and error-free work.',
                    'All reports and deliverables are consistently error-free.',
                    'Proactively identifies and corrects potential quality issues.',
                    'Ensures all data entries are verified and validated.',
                    'Receives consistent positive feedback on the correctness of deliverables.'
                ]
            },
            {
                id: 'efficiency-productivity',
                icon: 'clock',
                name: 'Efficiency & Productivity',
                definition: 'The ability to complete tasks effectively and timely, optimizing resource utilization.',
                examples: [
                    'Consistently meets or beats deadlines for all assigned tasks.',
                    'Manages workload effectively to maximize output.',
                    'Identifies and implements process improvements to enhance efficiency.',
                    'Completes tasks within expected timeframes without compromising quality.',
                    'Optimizes personal workflow to handle increased volume efficiently.'
                ],
                wsllOptions: [
                    'Consistently meets or beats deadlines for all assigned tasks.',
                    'Manages workload effectively to maximize output.',
                    'Identifies and implements process improvements to enhance efficiency.',
                    'Completes tasks within expected timeframes without compromising quality.',
                    'Optimizes personal workflow to handle increased volume efficiently.'
                ]
            },
            {
                id: 'communication-collaboration',
                icon: 'users',
                name: 'Communication & Collaboration',
                definition: 'The ability to share information clearly, concisely, and appropriately, and to work effectively with others.',
                examples: [
                    'Provides clear, timely, and concise updates to TL and internal teams.',
                    'Responds promptly to internal communications.',
                    'Collaborates effectively with other TMs or departments when required.',
                    'Adjusts communication style to suit different audiences and situations.',
                    'Proactively shares relevant information with teammates to avoid roadblocks.'
                ],
                wsllOptions: [
                    'Provides clear, timely, and concise updates to TL and internal teams.',
                    'Responds promptly to internal communications.',
                    'Collaborates effectively with other TMs or departments when required.',
                    'Adjusts communication style to suit different audiences and situations.',
                    'Proactively shares relevant information with teammates to avoid roadblocks.'
                ]
            },
            {
                id: 'accountability-proactiveness',
                icon: 'shield',
                name: 'Accountability & Proactiveness',
                definition: 'The willingness to take ownership of tasks and outcomes, and to anticipate needs or issues.',
                examples: [
                    'Takes full responsibility for assigned tasks and follows through to completion.',
                    'Proactively identifies and addresses potential roadblocks or challenges.',
                    'Initiates necessary follow-ups without being prompted.',
                    'Seeks solutions independently before escalating issues.',
                    'Demonstrates a strong sense of ownership over client outcomes.'
                ],
                wsllOptions: [
                    'Takes full responsibility for assigned tasks and follows through to completion.',
                    'Proactively identifies and addresses potential roadblocks or challenges.',
                    'Initiates necessary follow-ups without being prompted.',
                    'Seeks solutions independently before escalating issues.',
                    'Demonstrates a strong sense of ownership over client outcomes.'
                ]
            },
            {
                id: 'adaptability-growth',
                icon: 'trending-up',
                name: 'Adaptability & Growth',
                definition: 'The capacity to adjust to change, learn new skills, and apply feedback for continuous improvement.',
                examples: [
                    'Quickly adapts to new tools, processes, or client requirements.',
                    'Actively seeks and applies feedback to improve performance.',
                    'Demonstrates a willingness to learn and take on new challenges.',
                    'Embraces new responsibilities and adjusts priorities as needed.',
                    'Shows resilience and maintains performance during periods of change.'
                ],
                wsllOptions: [
                    'Quickly adapts to new tools, processes, or client requirements.',
                    'Actively seeks and applies feedback to improve performance.',
                    'Demonstrates a willingness to learn and take on new challenges.',
                    'Embraces new responsibilities and adjusts priorities as needed.',
                    'Shows resilience and maintains performance during periods of change.'
                ]
            },
            {
                id: 'role-specific-skills',
                icon: 'briefcase',
                name: 'Role-Specific Skills & Expertise',
                definition: 'Possesses the essential knowledge and technical abilities required to perform the duties of the position effectively.',
                examples: [
                    'Mastery of specific software/tools (e.g., AR software, design tools).',
                    'Deep understanding of client\'s industry-specific processes.',
                    'Consistently applies best practices relevant to the role.',
                    'Serves as a go-to resource for complex tasks in their domain.',
                    'Stays updated with industry trends and applies new knowledge effectively.'
                ],
                wsllOptions: [
                    'Mastery of specific software/tools (e.g., AR software, design tools).',
                    'Deep understanding of client\'s industry-specific processes.',
                    'Consistently applies best practices relevant to the role.',
                    'Serves as a go-to resource for complex tasks in their domain.',
                    'Stays updated with industry trends and applies new knowledge effectively.'
                ]
            }
        ];
        const PERF_RUBRICS = {
            general: { 1: "Performance generally fails to meet the established expectations or requires frequent, close supervision.", 2: "Meets some of the job expectations, but does not fully meet the remainder.", 3: "Performance fully meets the established job expectations and may on occasion exceed expectations.", 4: "Frequently exceeds expectations in many areas.", 5: "Performance is consistently exceptional." },
            values: { 1: "Performance generally fails to meet the established expectations or requires frequent, close supervision.", 2: "Meets some of the job expectations, but does not fully meet the remainder.", 3: "Demonstrates the core values.", 4: "Consistent with the core values.", 5: "Exceeding and consistent with the core values." },
            attendance: { 1: "<90% attendance.", 2: "<95% attendance.", 3: "95%-97% attendance.", 4: "98%-99% attendance.", 5: "100% attendance." }
        };

        // State
        const getCurrentMonthString = () => {
            const now = new Date();
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return `${months[now.getMonth()]} '${now.getFullYear().toString().slice(-2)}`;
        };
        let perfCurrentMonthView = getCurrentMonthString();
        let perfActiveMemberIdx = null;
        let perfSingleMemberMode = false;

        // Navigation state preservation
        let perfNavigationHistory = [];
        let perfCurrentState = {
            view: 'dashboard',
            month: null,
            filters: {},
            search: '',
            memberIndex: null
        };
        let perfActiveMode = null;
        let perfCurrentSelection = [];

        // --- CONTEXT MENU LOGIC ---
        let perfContextMenuState = {
            isOpen: false,
            memberIndex: null,
            month: null
        };

        function openPerformanceContextMenu(event, memberIndex, month) {
            event.preventDefault();
            event.stopPropagation();

            const menu = document.getElementById('perf-context-menu');
            if (!menu) return;

            perfContextMenuState = { isOpen: true, memberIndex, month };

            const x = event.clientX;
            const y = event.clientY;
            const winWidth = window.innerWidth;
            const winHeight = window.innerHeight;
            const menuWidth = 192;
            const menuHeight = 130;

            let finalX = x;
            let finalY = y;

            if (x + menuWidth > winWidth) finalX = winWidth - menuWidth - 10;
            if (y + menuHeight > winHeight) finalY = winHeight - menuHeight - 10;

            menu.style.left = `${finalX}px`;
            menu.style.top = `${finalY}px`;
            menu.classList.remove('hidden');

            setTimeout(() => {
                document.addEventListener('click', closePerformanceContextMenu);
                document.addEventListener('contextmenu', closePerformanceContextMenu);
            }, 0);
        }

        function closePerformanceContextMenu() {
            const menu = document.getElementById('perf-context-menu');
            if (menu) menu.classList.add('hidden');
            perfContextMenuState.isOpen = false;
            document.removeEventListener('click', closePerformanceContextMenu);
            document.removeEventListener('contextmenu', closePerformanceContextMenu);
        }

        function handleContextMenuAction(action) {
            const { memberIndex, month } = perfContextMenuState;
            if (memberIndex === null || !month) return;
            closePerformanceContextMenu();
            switch (action) {
                case 'details': openPerformanceDetails(memberIndex, month); break;
                case 'edit': initUnifiedRating(memberIndex, month); break;
                case 'clear': clearMonthlyRating(memberIndex, month); break;
            }
        }

        // --- PERFORMANCE DETAILS MODAL LOGIC ---
        let perfDetailsState = {
            memberIndex: null,
            currentMonth: null
        };

        function openPerformanceDetails(memberIndex, month) {
            perfDetailsState.memberIndex = memberIndex;
            perfDetailsState.currentMonth = month;
            
            const modal = document.getElementById('perf-details-modal');
            if (modal) modal.classList.remove('hidden');
            
            renderPerformanceDetailsContent();
        }

        function closePerformanceDetails() {
            const modal = document.getElementById('perf-details-modal');
            if (modal) modal.classList.add('hidden');
        }

        function changePerformanceDetailsMonth(offset) {
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const [mStr, yStr] = perfDetailsState.currentMonth.split(" '");
            const mIdx = months.indexOf(mStr);
            const year = parseInt("20" + yStr);
            
            const date = new Date(year, mIdx + offset, 1);
            perfDetailsState.currentMonth = `${months[date.getMonth()]} '${date.getFullYear().toString().slice(-2)}`;
            
            renderPerformanceDetailsContent();
        }

        function renderPerformanceDetailsContent() {
            const { memberIndex, currentMonth } = perfDetailsState;
            const member = appData.team[memberIndex];
            const contentArea = document.getElementById('perf-details-content');
            const nameDisplay = document.getElementById('perf-details-name');
            const monthDisplay = document.getElementById('perf-details-month');
            
            if (!member || !contentArea) return;
            
            nameDisplay.textContent = member.name;
            monthDisplay.textContent = currentMonth;
            
            const entry = member.history.find(h => h.month === currentMonth && h.isUnifiedEntry);
            
            if (!entry) {
                contentArea.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-center">
                        <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="clipboard-x" class="w-8 h-8 text-slate-400"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-slate-900 dark:text-white mb-1">No Data Found</h4>
                        <p class="text-sm text-slate-500 dark:text-slate-400 max-w-xs">There are no performance ratings or notes recorded for ${member.name} in ${currentMonth}.</p>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }
            
            let html = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800/50">
                        <p class="text-[10px] font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider mb-1">Final Score</p>
                        <p class="text-2xl font-black text-blue-700 dark:text-blue-300">${entry.finalScore.toFixed(1)}</p>
                    </div>
                    <div class="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-xl border border-amber-100 dark:border-amber-800/50">
                        <p class="text-[10px] font-bold text-amber-600 dark:text-amber-400 uppercase tracking-wider mb-1">Values</p>
                        <p class="text-2xl font-black text-amber-700 dark:text-amber-300">${entry.valuesScore}/5</p>
                    </div>
                    <div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-xl border border-emerald-100 dark:border-emerald-800/50">
                        <p class="text-[10px] font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider mb-1">Attendance</p>
                        <p class="text-2xl font-black text-emerald-700 dark:text-emerald-300">${entry.attendanceScore}/5</p>
                    </div>
                    <div class="bg-teal-50 dark:bg-teal-900/20 p-4 rounded-xl border-2 border-teal-200 dark:border-teal-700">
                        <p class="text-[10px] font-bold text-teal-600 dark:text-teal-400 uppercase tracking-wider mb-1">Engagement</p>
                        <p class="text-lg font-black text-teal-700 dark:text-teal-300">${entry.engagementLevel || 'N/A'}</p>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100 dark:border-slate-800 pb-2">Metric Breakdown</h4>
            `;
            
            entry.metrics.forEach(metric => {
                html += `
                    <div class="bg-white dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800 p-5 space-y-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-lg font-bold text-slate-900 dark:text-white">${metric.name}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                ${Array(5).fill(0).map((_, i) => `
                                    <i data-lucide="star" class="w-4 h-4 ${i < metric.score ? 'fill-yellow-400 text-yellow-400' : 'text-slate-200 dark:text-slate-700'}"></i>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Success Criteria (WSLL)</p>
                            <p class="text-sm text-slate-700 dark:text-slate-300 italic">"${metric.wsll || 'Not specified'}"</p>
                        </div>
                        
                        ${metric.notes ? `
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Notes</p>
                            <p class="text-sm text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-800">${metric.notes}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // Add Values and Attendance notes if they exist
            const valuesNotes = entry.valuesNotes || '';
            const attendanceNotes = entry.attendanceNotes || '';
            
            if (valuesNotes.trim() || attendanceNotes.trim()) {
                html += `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                `;
                
                if (valuesNotes.trim()) {
                    html += `
                        <div class="bg-white dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800 p-5 space-y-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="heart" class="w-5 h-5 text-amber-600 dark:text-amber-400"></i>
                                <p class="text-sm font-bold text-slate-900 dark:text-white">Value Alignment Notes</p>
                            </div>
                            <p class="text-sm text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-800">${valuesNotes}</p>
                        </div>
                    `;
                }
                
                if (attendanceNotes.trim()) {
                    html += `
                        <div class="bg-white dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800 p-5 space-y-3">
                            <div class="flex items-center gap-2">
                                <i data-lucide="check" class="w-5 h-5 text-emerald-600 dark:text-emerald-400"></i>
                                <p class="text-sm font-bold text-slate-900 dark:text-white">Attendance Notes</p>
                            </div>
                            <p class="text-sm text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-900/50 p-3 rounded-lg border border-slate-100 dark:border-slate-800">${attendanceNotes}</p>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            html += `</div>`;
            contentArea.innerHTML = html;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Navigation
        function switchPerformanceView(viewName, context = '', preserveState = true) {
            if (preserveState) {
                pushNavigationState(viewName, {
                    month: perfCurrentMonthView,
                    filters: getCurrentFilters(),
                    search: getCurrentSearch(),
                    memberIndex: perfActiveMemberIdx
                });
            }

            ['perf-dashboard', 'perf-studio', 'perf-details', 'perf-unified-rating', 'perf-insights'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById(`perf-${viewName}`);
            if (target) target.classList.remove('hidden');

            if (viewName === 'dashboard') renderPerformanceDashboard();
            if (viewName === 'insights') renderTeamInsights();
            // Note: unified-rating view is now handled directly in initUnifiedRating
            if (viewName === 'studio') {
                perfSingleMemberMode = false; // Reset single member mode when going to studio selector
                memberSearchInitialized = false; // Reset search initialization flag
                const selector = document.getElementById('studio-selector');
                const landing = document.getElementById('studio-landing');
                const workspace = document.getElementById('studio-workspace');
                // Show the big selection card when entering studio
                if (selector) selector.classList.remove('hidden');
                if (landing) landing.classList.add('hidden');
                if (workspace) workspace.classList.add('hidden');

                // Initialize fuzzy search
                setTimeout(() => initializeMemberSearch(), 200); // Small delay to ensure DOM is ready
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();

            updateNavigationState(viewName, context);
        }

        // --- TEAM INSIGHTS LOGIC ---

        // Helper: Generate Month Options
        function populateInsightMonthSelectors() {
            const startSel = document.getElementById('insight-start-month');
            const endSel = document.getElementById('insight-end-month');
            if (!startSel || !endSel) return;

            // Generate months from Jan '24 to Dec '26
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let options = "";
            let defaultStart = "";
            let defaultEnd = "";

            const now = new Date();
            // Default End: Current Month
            defaultEnd = `${months[now.getMonth()]} '${now.getFullYear().toString().slice(-2)}`;

            // Default Start: 6 months ago
            const sixAgo = new Date();
            sixAgo.setMonth(now.getMonth() - 5);
            defaultStart = `${months[sixAgo.getMonth()]} '${sixAgo.getFullYear().toString().slice(-2)}`;

            for (let y = 24; y <= 26; y++) {
                for (let m = 0; m < 12; m++) {
                    const val = `${months[m]} '${y}`;
                    options += `<option value="${val}">${val}</option>`;
                }
            }

            // Only populate if empty
            if (startSel.innerHTML === "") {
                startSel.innerHTML = options;
                endSel.innerHTML = options;
                startSel.value = defaultStart;
                endSel.value = defaultEnd;
            }
        }

        function resetInsightFilters() {
            const startSel = document.getElementById('insight-start-month');
            startSel.innerHTML = ""; // Force re-populate defaults
            renderTeamInsights();
        }

        // Helper: Convert "Oct '25" to comparable integer (e.g. 202510)
        function getMonthValue(mStr) {
            if (!mStr) return 0;
            const [m, y] = mStr.split(" '");
            const monthMap = { "Jan": 0, "Feb": 1, "Mar": 2, "Apr": 3, "May": 4, "Jun": 5, "Jul": 6, "Aug": 7, "Sep": 8, "Oct": 9, "Nov": 10, "Dec": 11 };
            return (parseInt("20" + y) * 100) + monthMap[m];
        }

        function renderTeamInsights() {
            // 1. Init Filters
            populateInsightMonthSelectors();
            const startStr = document.getElementById('insight-start-month').value;
            const endStr = document.getElementById('insight-end-month').value;
            const startVal = getMonthValue(startStr);
            const endVal = getMonthValue(endStr);

            // 2. Aggregate Data
            const team = appData.team.filter(t => t.active);

            // Aggregators for WHOLE RANGE
            let totalScoreSum = 0;
            let totalEntriesCount = 0;
            let metricSums = {};
            let metricCounts = {};
            let scoresDistribution = [];

            // Aggregators for TRENDS (Map: MonthStr -> { sum, count, metrics: {} })
            let trendMap = {};

            team.forEach(tm => {
                (tm.history || []).forEach(h => {
                    // Filter by Date Range & Valid Unified Entry
                    if (!h.isUnifiedEntry || h.finalScore <= 0) return;
                    const hVal = getMonthValue(h.month);
                    if (hVal < startVal || hVal > endVal) return;

                    // -- Range Aggregation --
                    totalScoreSum += h.finalScore;
                    totalEntriesCount++;
                    scoresDistribution.push(h.finalScore);

                    // Metrics
                    if (h.metrics && Array.isArray(h.metrics)) {
                        h.metrics.forEach(m => {
                            if (m.name) {
                                metricSums[m.name] = (metricSums[m.name] || 0) + (m.score || 0);
                                metricCounts[m.name] = (metricCounts[m.name] || 0) + 1;
                            }
                        });
                    }

                    // -- Trend Aggregation --
                    if (!trendMap[h.month]) {
                        trendMap[h.month] = { sum: 0, count: 0, metrics: {} };
                    }
                    trendMap[h.month].sum += h.finalScore;
                    trendMap[h.month].count++;

                    // Trend Metrics
                    if (h.metrics) {
                        h.metrics.forEach(m => {
                            if (!trendMap[h.month].metrics[m.name]) trendMap[h.month].metrics[m.name] = { sum: 0, count: 0 };
                            trendMap[h.month].metrics[m.name].sum += m.score;
                            trendMap[h.month].metrics[m.name].count++;
                        });
                    }
                });
            });

            // 3. Render KPIs (Header)
            const avgScore = totalEntriesCount > 0 ? (totalScoreSum / totalEntriesCount) : 0;
            document.getElementById('insight-team-avg').innerText = avgScore.toFixed(2);

            const labels = Object.keys(metricSums);
            let topMetric = '--', topScore = 0, lowMetric = '--', lowScore = 0;

            if (labels.length > 0) {
                const ranked = labels.map(name => ({
                    name: name,
                    score: metricSums[name] / metricCounts[name]
                })).sort((a, b) => b.score - a.score);

                if (ranked.length > 0) {
                    topMetric = ranked[0].name;
                    topScore = ranked[0].score;
                    lowMetric = ranked[ranked.length - 1].name;
                    lowScore = ranked[ranked.length - 1].score;
                }
            }
            document.getElementById('insight-top-metric').innerText = topMetric;
            document.getElementById('insight-top-score').innerText = labels.length > 0 ? `Avg: ${topScore.toFixed(1)}` : 'No Data';
            document.getElementById('insight-low-metric').innerText = lowMetric;
            document.getElementById('insight-low-score').innerText = labels.length > 0 ? `Avg: ${lowScore.toFixed(1)}` : 'No Data';

            // 4. Sort Trend Data Chronologically
            const sortedMonths = Object.keys(trendMap).sort((a, b) => getMonthValue(a) - getMonthValue(b));

            // Prepare Chart Data
            const trendLabels = sortedMonths;
            const trendScoreData = sortedMonths.map(m => (trendMap[m].sum / trendMap[m].count).toFixed(2));

            // 5. Render Score Trend Chart
            renderLineChart('insight-score-trend', trendLabels, [{
                label: 'Team Score',
                data: trendScoreData,
                borderColor: '#38bdf8',
                backgroundColor: 'rgba(56, 189, 248, 0.1)',
                fill: true
            }]);

            // 6. Render Metric Trend Chart (Multi-line)
            // Use all 6 metrics from PERF_CORE_METRICS to ensure Accountability & Proactiveness is included
            const allMetrics = PERF_CORE_METRICS.map(m => m.name);
            const colors = ['#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#f97316'];
            const metricDatasets = allMetrics.map((mName, i) => {
                const data = sortedMonths.map(m => {
                    const md = trendMap[m].metrics[mName];
                    return md ? (md.sum / md.count).toFixed(2) : null;
                });
                return {
                    label: mName,
                    data: data,
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '20',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    hidden: false
                };
            });
            renderLineChart('insight-metric-trend', trendLabels, metricDatasets, false);
            
            // Render metric filter checkboxes (3 columns)
            renderMetricFilters(allMetrics);

            // 7. Render Aggregated Charts (Skill & Dist)
            const skillData = labels.map(l => (metricSums[l] / metricCounts[l]).toFixed(2));
            renderBarChart('insight-skill-chart', labels, skillData);

            const distData = [0, 0, 0, 0];
            scoresDistribution.forEach(s => {
                if (s >= 4.5) distData[3]++;
                else if (s >= 4.0) distData[2]++;
                else if (s >= 3.0) distData[1]++;
                else distData[0]++;
            });
            renderDistChart('insight-dist-chart', distData);

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderMetricFilters(metrics) {
            const container = document.getElementById('insight-metric-filters');
            if (!container) return;
            
            container.innerHTML = '';
            const colors = ['#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#06b6d4', '#f97316'];
            metrics.forEach((metricName, index) => {
                const color = colors[index % colors.length];
                const checkbox = document.createElement('label');
                checkbox.className = 'flex items-center gap-2 cursor-pointer text-xs text-slate-300 hover:text-white transition-colors';
                checkbox.innerHTML = `
                    <input type="checkbox" 
                           class="w-3.5 h-3.5 rounded border-slate-600 bg-slate-800" 
                           checked 
                           onchange="toggleMetricVisibility('${metricName}', this.checked)"
                           style="accent-color: ${color}">
                    <span class="truncate" title="${metricName}">${metricName}</span>
                `;
                container.appendChild(checkbox);
            });
        }
        
        function toggleMetricVisibility(metricName, visible) {
            const chart = window['insight-metric-trend'];
            if (!chart) return;
            
            const datasetIndex = chart.data.datasets.findIndex(d => d.label === metricName);
            if (datasetIndex !== -1) {
                chart.setDatasetVisibility(datasetIndex, visible);
                chart.update();
            }
        }

        // --- CHART HELPERS ---
        function renderLineChart(id, labels, datasets, showLegend = true) {
            const ctx = document.getElementById(id).getContext('2d');
            if (window[id] instanceof Chart) window[id].destroy();
            window[id] = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { min: 2, max: 5, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { display: showLegend && datasets.length > 1, labels: { color: '#cbd5e1' } } }
                }
            });
        }

        function renderBarChart(id, labels, data) {
            const ctx = document.getElementById(id).getContext('2d');
            if (window[id] instanceof Chart) window[id].destroy();
            window[id] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Avg', data: data, backgroundColor: '#64748b', borderRadius: 4, barThickness: 20 }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    scales: { x: { min: 0, max: 5, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }, y: { grid: { display: false }, ticks: { color: '#e2e8f0', font: { family: 'monospace' } } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderDistChart(id, data) {
            const ctx = document.getElementById(id).getContext('2d');
            if (window[id] instanceof Chart) window[id].destroy();
            window[id] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['<3.0', '3.0-3.9', '4.0-4.4', '4.5+'],
                    datasets: [{ data: data, backgroundColor: ['#334155', '#475569', '#94a3b8', '#f8fafc'], borderRadius: 4, barThickness: 40 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#e2e8f0', font: { family: 'monospace' } } } },
                    plugins: { legend: { display: false } }
                }
            });
        }


        function updateWorkspaceHeaderVisibility() {
            const memberSelect = document.getElementById('workspace-member-select');
            const memberBadge = document.getElementById('workspace-member-badge');
            const memberName = document.getElementById('workspace-member-name');

            if (perfSingleMemberMode && perfActiveMemberIdx !== null && appData.team[perfActiveMemberIdx]) {
                // Show member badge in single-member mode
                if (memberSelect) memberSelect.classList.add('hidden');
                if (memberBadge) memberBadge.classList.remove('hidden');
                const member = appData.team[perfActiveMemberIdx];
                if (memberName) memberName.textContent = member.name;
            } else {
                // Show member dropdown in multi-member mode
                if (memberSelect) memberSelect.classList.remove('hidden');
                if (memberBadge) memberBadge.classList.add('hidden');
            }
        }

        // Navigation state management functions
        function pushNavigationState(viewName, stateData = {}) {
            perfNavigationHistory.push({
                ...perfCurrentState,
                timestamp: Date.now()
            });
            perfCurrentState = { view: viewName, ...stateData };
        }

        function updateNavigationState(viewName, context = '') {
            const navDashboard = document.getElementById('nav-dashboard');
            const navStudio = document.getElementById('nav-studio');
            const navInsights = document.getElementById('nav-insights');

            const viewIndicator = document.getElementById('view-indicator');
            const breadcrumbs = document.getElementById('performance-breadcrumbs');
            const breadcrumbCurrent = document.getElementById('breadcrumb-current');
            const currentViewIcon = document.getElementById('current-view-icon');
            const currentViewText = document.getElementById('current-view-text');

            // 1. Reset Styles
            const inactiveClass = "px-4 py-2 text-sm font-medium rounded-lg transition bg-slate-100 text-slate-700 hover:bg-slate-200";
            const activeClass = "px-4 py-2 text-sm font-medium rounded-lg transition bg-blue-600 text-white shadow-sm";

            // 2. Hide Headers by default
            if (viewIndicator) viewIndicator.classList.add('hidden');
            if (breadcrumbs) breadcrumbs.classList.add('hidden');

            // 3. State Logic
            if (viewName === 'dashboard') {
                // On Dashboard: Hide "Back to Dashboard", Show "Insights"
                if (navDashboard) navDashboard.classList.add('hidden');
                if (navInsights) {
                    navInsights.classList.remove('hidden');
                    navInsights.className = inactiveClass;
                }
            }
            else if (viewName === 'insights') {
                // On Insights: SHOW "Back", Highlight "Insights"
                if (navDashboard) {
                    navDashboard.classList.remove('hidden'); // Fix: Ensure back button is visible
                    navDashboard.className = inactiveClass;
                }
                if (navInsights) {
                    navInsights.classList.remove('hidden');
                    navInsights.className = activeClass;
                }

                if (viewIndicator) {
                    viewIndicator.classList.remove('hidden');
                    if (currentViewIcon) currentViewIcon.textContent = '';
                    if (currentViewText) currentViewText.textContent = 'Team Insights';
                }
            }
            else {
                // On Deep Views (Studio/Details): Hide "Insights" to reduce clutter
                if (navDashboard) navDashboard.classList.remove('hidden'); // Show back button
                if (navInsights) navInsights.classList.add('hidden');

                if (viewIndicator) viewIndicator.classList.remove('hidden');
                if (breadcrumbs) breadcrumbs.classList.remove('hidden');

                if (viewName === 'studio') {
                    if (currentViewIcon) currentViewIcon.textContent = '';
                    if (currentViewText) currentViewText.textContent = 'Action Studio';
                    if (breadcrumbCurrent) breadcrumbCurrent.textContent = 'Action Studio';
                } else if (viewName === 'details') {
                    if (currentViewIcon) currentViewIcon.textContent = '';
                    if (currentViewText) currentViewText.textContent = 'Member Details';
                    if (breadcrumbCurrent) breadcrumbCurrent.textContent = context || 'Member Details';
                }
            }
        }

        // Helper functions for state preservation
        function getCurrentFilters() {
            const accountFilter = document.getElementById('account-filter');
            const statusFilter = document.getElementById('status-filter');
            const sortSelect = document.getElementById('perf-sort-select');

            return {
                account: accountFilter ? accountFilter.value : 'all',
                status: statusFilter ? statusFilter.value : 'all',
                sort: sortSelect ? sortSelect.value : 'status'
            };
        }

        function getCurrentSearch() {
            const searchInput = document.getElementById('member-search');
            return searchInput ? searchInput.value : '';
        }

        // Fuzzy search functionality
        let memberSearchResults = [];

        let memberSearchInitialized = false;

        function initializeMemberSearch() {
            const searchInput = document.getElementById('member-search-input');
            const resultsContainer = document.getElementById('member-search-results');
            const resultsList = document.getElementById('search-results-list');

            if (!searchInput || !resultsContainer || !resultsList) {
                console.log('Member search elements not found');
                return;
            }

            // Prevent duplicate initialization
            if (memberSearchInitialized) {
                return;
            }

            memberSearchInitialized = true;

            searchInput.addEventListener('input', function (e) {
                const query = e.target.value.toLowerCase().trim();

                if (query.length === 0) {
                    resultsContainer.classList.add('hidden');
                    return;
                }

                // Fuzzy search through active team members
                memberSearchResults = appData.team
                    .map((member, index) => ({ member, index }))
                    .filter(({ member }) => member.active &&
                        (member.name.toLowerCase().includes(query) ||
                            member.role.toLowerCase().includes(query)))
                    .sort((a, b) => {
                        // Prioritize exact name matches
                        const aExact = a.member.name.toLowerCase().startsWith(query);
                        const bExact = b.member.name.toLowerCase().startsWith(query);
                        if (aExact && !bExact) return -1;
                        if (!aExact && bExact) return 1;
                        return a.member.name.localeCompare(b.member.name);
                    });

                renderSearchResults();
                resultsContainer.classList.remove('hidden');
            });

            searchInput.addEventListener('focus', function () {
                if (searchInput.value.trim().length > 0) {
                    resultsContainer.classList.remove('hidden');
                }
            });

            searchInput.addEventListener('blur', function () {
                // Delay hiding to allow clicks on results
                setTimeout(() => {
                    resultsContainer.classList.add('hidden');
                }, 200);
            });

            // Initialize with all members shown initially
            populatePerformanceStudioMemberSelect();
        }

        function renderSearchResults() {
            const resultsList = document.getElementById('search-results-list');
            if (!resultsList) return;

            if (memberSearchResults.length === 0) {
                resultsList.innerHTML = `
                    <div class="px-4 py-3 text-sm text-slate-500 text-center">
                        No team members found
                    </div>
                `;
                return;
            }

            resultsList.innerHTML = memberSearchResults
                .slice(0, 10) // Limit to 10 results
                .map(({ member, index }) => `
                    <div class="px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700 last:border-b-0"
                         onclick="selectMemberFromSearch(${index})">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-medium text-slate-900 dark:text-slate-100">${member.name}</div>
                                <div class="text-sm text-slate-500 dark:text-slate-400">${member.role}</div>
                            </div>
                            <div class="text-xs text-slate-400 dark:text-slate-500">${member.account}</div>
                        </div>
                    </div>
                `).join('');
        }

        function selectMemberFromSearch(memberIndex) {
            const member = appData.team[memberIndex];
            const searchInput = document.getElementById('member-search-input');
            const actualSelect = document.getElementById('studio-member-select'); // This is the hidden select in the fuzzy search

            // Update the hidden select
            if (actualSelect) actualSelect.value = memberIndex.toString();

            // Update search input display
            if (searchInput) searchInput.value = member.name;

            // Hide results
            const resultsContainer = document.getElementById('member-search-results');
            if (resultsContainer) resultsContainer.classList.add('hidden');

            // Trigger the normal member selection handler
            handlePerformanceStudioMemberSelect();
        }

        // Dashboard
        function populatePerformanceStudioMemberSelect() {
            const sel = document.getElementById('studio-member-select');
            sel.innerHTML = '<option value="">-- Choose from Roster --</option>';
            appData.team.forEach((m, i) => { sel.innerHTML += `<option value="${i}">${m.name}</option>`; });
        }

        function handlePerformanceStudioMemberSelect() {
            const val = document.getElementById('studio-member-select').value;
            if (val === "") {
                document.getElementById('studio-landing').classList.add('hidden');
                document.getElementById('studio-workspace').classList.add('hidden');
                perfActiveMemberIdx = null; return;
            }
            perfActiveMemberIdx = parseInt(val);
            document.getElementById('studio-landing').classList.remove('hidden');
            document.getElementById('studio-landing').classList.add('grid');
            document.getElementById('studio-workspace').classList.add('hidden');
        }

        // Dashboard Render
        function updatePerformanceMonth() {
            perfCurrentMonthView = document.getElementById('perf-month-select').value;
            renderPerformanceDashboard();
        }

        function getPerformanceRatingLabel(score) {
            if (score >= 4.5) return "Outstanding";
            if (score >= 4.0) return "Exceeds Expectations";
            if (score >= 3.0) return "Meets Expectations";
            if (score >= 1.5) return "Needs Improvement";
            return "Unsatisfactory";
        }

        function getPerformanceRatingBadge(score) {
            if (score >= 4.5) {
                return '<span class="inline-block px-3 py-1 text-xs font-bold text-white bg-green-600 rounded-full whitespace-nowrap shadow-sm">Outstanding</span>';
            } else if (score < 3) {
                return '<span class="inline-block px-3 py-1 text-xs font-bold text-white bg-red-600 rounded-full whitespace-nowrap shadow-sm">Needs Improvement</span>';
            } else {
                return '<span class="inline-block px-3 py-1 text-xs font-bold text-white bg-blue-600 rounded-full whitespace-nowrap shadow-sm">Satisfactory</span>';
            }
        }

        // ==========================================
        // TEAM ANALYTICS FUNCTIONS
        // ==========================================

        let currentAnalyticsMember = null;
        let analyticsCharts = {};

        function openMemberAnalytics(memberIndex) {
            const member = appData.team[memberIndex];
            currentAnalyticsMember = memberIndex;

            // Update member info in header
            document.getElementById('analytics-member-name').textContent = member.name;
            document.getElementById('analytics-member-role').textContent = `${member.role}  ${member.account}`;

            // Calculate and display KPIs
            updateAnalyticsKPIs(member);

            // Show modal
            document.getElementById('member-analytics-modal').classList.remove('hidden');

            // Initialize charts with 6-month default
            initializeAnalyticsCharts(member, 6);
        }

        function updateAnalyticsKPIs(member) {
            const history = member.history || [];
            const ratedEntries = history.filter(h => (h.isUnifiedEntry || (!h.isStrategyEntry && !h.isUnifiedEntry)) && h.finalScore > 0);

            if (ratedEntries.length === 0) {
                document.getElementById('analytics-latest-score').textContent = '0.00';
                document.getElementById('analytics-rating-badge').textContent = 'N/A';
                document.getElementById('analytics-rating-badge').className = 'px-4 py-1.5 rounded-full text-xs font-bold bg-slate-100 text-slate-600 uppercase tracking-wide';
                document.getElementById('analytics-trend').textContent = '--';
                document.getElementById('analytics-trend-text').textContent = 'vs last month';
                return;
            }

            // Sort by date (newest first)
            const sortedEntries = ratedEntries.sort((a, b) => {
                const dateA = parseMonthString(a.month);
                const dateB = parseMonthString(b.month);
                return dateB - dateA;
            });

            // Latest score
            const latestScore = sortedEntries[0].finalScore;
            document.getElementById('analytics-latest-score').textContent = latestScore.toFixed(2);

            // Rating badge
            let badgeClass = 'px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide ';
            let badgeText = '';
            if (latestScore >= 4.5) {
                badgeClass += 'bg-green-100 text-green-700';
                badgeText = 'Outstanding';
            } else if (latestScore >= 3.5) {
                badgeClass += 'bg-blue-100 text-blue-700';
                badgeText = 'Exceeds';
            } else if (latestScore >= 3.0) {
                badgeClass += 'bg-slate-100 text-slate-700';
                badgeText = 'Meets';
            } else {
                badgeClass += 'bg-red-100 text-red-700';
                badgeText = 'Needs Work';
            }
            document.getElementById('analytics-rating-badge').className = badgeClass;
            document.getElementById('analytics-rating-badge').textContent = badgeText;

            // Monthly trend
            if (sortedEntries.length >= 2) {
                const previousScore = sortedEntries[1].finalScore;
                const delta = latestScore - previousScore;
                const trendEl = document.getElementById('analytics-trend');
                const trendTextEl = document.getElementById('analytics-trend-text');

                if (delta > 0) {
                    trendEl.textContent = `+${delta.toFixed(2)}`;
                    trendEl.className = 'text-5xl font-black text-green-600 tracking-tighter';
                    trendTextEl.textContent = 'vs last month ';
                    trendTextEl.className = 'text-sm font-bold text-green-600';
                } else if (delta < 0) {
                    trendEl.textContent = delta.toFixed(2);
                    trendEl.className = 'text-5xl font-black text-red-600 tracking-tighter';
                    trendTextEl.textContent = 'vs last month ';
                    trendTextEl.className = 'text-sm font-bold text-red-600';
                } else {
                    trendEl.textContent = '0.00';
                    trendEl.className = 'text-5xl font-black text-slate-600 tracking-tighter';
                    trendTextEl.textContent = 'vs last month ';
                    trendTextEl.className = 'text-sm font-bold text-slate-600';
                }
            } else {
                document.getElementById('analytics-trend').textContent = '--';
                document.getElementById('analytics-trend').className = 'text-5xl font-black text-slate-800 tracking-tighter';
                document.getElementById('analytics-trend-text').textContent = 'vs last month';
                document.getElementById('analytics-trend-text').className = 'text-sm font-bold text-slate-400';
            }

            // Engagement Level Badge
            const latestEngagement = sortedEntries[0].engagementLevel || 'Not Set';
            const engagementEl = document.getElementById('analytics-engagement-badge');
            if (engagementEl) {
                let engagementClass = 'px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide ';
                if (latestEngagement === 'High') {
                    engagementClass += 'bg-teal-100 text-teal-700';
                } else if (latestEngagement === 'Medium') {
                    engagementClass += 'bg-indigo-100 text-indigo-700';
                } else if (latestEngagement === 'Low') {
                    engagementClass += 'bg-slate-100 text-slate-600';
                } else {
                    engagementClass += 'bg-slate-100 text-slate-400';
                }
                engagementEl.className = engagementClass;
                engagementEl.textContent = latestEngagement;
            }
        }

        function closeMemberAnalytics() {
            document.getElementById('member-analytics-modal').classList.add('hidden');

            // Destroy existing charts
            Object.values(analyticsCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            analyticsCharts = {};
        }

        function updateAnalyticsCharts() {
            if (currentAnalyticsMember === null) return;

            const member = appData.team[currentAnalyticsMember];
            const months = parseInt(document.getElementById('analytics-date-range').value);

            // Destroy existing charts
            Object.values(analyticsCharts).forEach(chart => {
                if (chart) chart.destroy();
            });

            // Reinitialize with new time range
            initializeAnalyticsCharts(member, months);
        }

        function initializeAnalyticsCharts(member, months = 6) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - months);

            // Aggregate historical data
            const historicalData = aggregateMemberHistory(member, startDate, endDate);

            // Create charts
            createScoreTrendChart(historicalData);
            createMetricsChart(historicalData);
            createCoreValuesChart(historicalData);
            createAttendanceChart(historicalData);
            createEngagementChart(historicalData);
        }

        function aggregateMemberHistory(member, startDate, endDate) {
            const monthlyData = {};
            const monthOrder = [];

            // Initialize months in chronological order
            for (let i = 0; i < 12; i++) {
                const date = new Date(startDate);
                date.setMonth(startDate.getMonth() + i);
                if (date <= endDate) {
                    const monthKey = `${["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][date.getMonth()]} '${date.getFullYear().toString().slice(-2)}`;
                    monthlyData[monthKey] = {
                        scores: [],
                        metrics: {},
                        coreValues: {},
                        valuesScores: [],
                        attendance: null
                    };
                    monthOrder.push(monthKey);
                }
            }

            // Aggregate data from member's history
            (member.history || []).forEach(entry => {
                if (entry.isStrategyEntry && !entry.isUnifiedEntry) return; // Skip strategy entries but include unified entries

                if (monthlyData[entry.month]) {
                    if (entry.finalScore !== undefined && entry.finalScore !== null && entry.finalScore > 0) {
                        monthlyData[entry.month].scores.push(entry.finalScore);
                    }

                    // Aggregate values score
                    if (entry.valuesScore !== undefined && entry.valuesScore !== null && entry.valuesScore > 0) {
                        monthlyData[entry.month].valuesScores.push(entry.valuesScore);
                    }

                    // Aggregate metrics
                    if (entry.metrics && Array.isArray(entry.metrics)) {
                        entry.metrics.forEach(metric => {
                            if (metric.name && metric.score !== undefined) {
                                if (!monthlyData[entry.month].metrics[metric.name]) {
                                    monthlyData[entry.month].metrics[metric.name] = [];
                                }
                                monthlyData[entry.month].metrics[metric.name].push(metric.score);
                            }
                        });
                    }

                    // Aggregate core values (if they exist in the entry)
                    if (entry.coreValues) {
                        Object.assign(monthlyData[entry.month].coreValues, entry.coreValues);
                    }

                    // Attendance data (if available)
                    if (entry.attendance !== undefined) {
                        monthlyData[entry.month].attendance = entry.attendance;
                    }
                }
            });

            return {
                months: monthOrder,
                data: monthlyData
            };
        }

        function parseMonthString(monthStr) {
            const match = monthStr.match(/^(\w+) '(\d+)$/);
            if (!match) return new Date();

            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const month = monthNames.indexOf(match[1]);
            const year = 2000 + parseInt(match[2]);

            return new Date(year, month, 1);
        }

        function createScoreTrendChart(data) {
            const ctx = document.getElementById('score-trend-chart').getContext('2d');

            // Calculate average scores for each month
            const scores = data.months.map(month => {
                const monthData = data.data[month];
                if (monthData.scores.length > 0) {
                    return monthData.scores.reduce((a, b) => a + b, 0) / monthData.scores.length;
                }
                return null;
            });

            // Create TSM-style gradient (fades to white)
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

            analyticsCharts.scoreTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Performance Score',
                        data: scores,
                        borderColor: '#3b82f6',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#3b82f6',
                        pointBorderWidth: 2,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(59, 130, 246, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    return `Score: ${context.parsed.y?.toFixed(1) || 'N/A'}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.08)',
                                drawBorder: false,
                                lineWidth: 1
                            },
                            border: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 11, weight: '500' },
                                padding: 8,
                                callback: function (value) {
                                    return value.toFixed(1);
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            border: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 11, weight: '500' },
                                padding: 8
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function createMetricsChart(data) {
            const ctx = document.getElementById('metrics-chart').getContext('2d');

            // Find all unique metric names across all months
            const allMetrics = new Set();
            data.months.forEach(month => {
                Object.keys(data.data[month].metrics).forEach(metric => {
                    allMetrics.add(metric);
                });
            });

            // Create datasets for each metric
            const datasets = Array.from(allMetrics).map((metricName, index) => {
                const colors = ['#0077C8', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
                const color = colors[index % colors.length];

                const metricData = data.months.map(month => {
                    const monthMetrics = data.data[month].metrics[metricName] || [];
                    return monthMetrics.length > 0 ? monthMetrics.reduce((a, b) => a + b, 0) / monthMetrics.length : null;
                });

                return {
                    label: metricName,
                    data: metricData,
                    borderColor: color,
                    backgroundColor: color.replace(')', ', 0.1)'),
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 3,
                    pointBackgroundColor: color,
                    spanGaps: true
                };
            });

            analyticsCharts.metrics = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            cornerRadius: 8,
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            grid: { color: '#f3f4f6', drawBorder: false },
                            ticks: { color: '#6b7280' }
                        },
                        x: {
                            grid: { color: '#f3f4f6', drawBorder: false },
                            ticks: { color: '#6b7280' }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 5
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function createCoreValuesChart(data) {
            const ctx = document.getElementById('core-values-chart').getContext('2d');

            // Calculate average values scores for each month (core alignment)
            const valuesScores = data.months.map(month => {
                const monthData = data.data[month];
                if (monthData.valuesScores.length > 0) {
                    return monthData.valuesScores.reduce((a, b) => a + b, 0) / monthData.valuesScores.length;
                }
                return null;
            });

            // Create TSM-style gradient (fades to white)
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

            analyticsCharts.coreValues = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Core Alignment',
                        data: valuesScores,
                        borderColor: '#8b5cf6',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#8b5cf6',
                        pointBorderWidth: 2,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(139, 92, 246, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    return `Values: ${context.parsed.y?.toFixed(1) || 'N/A'}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.08)',
                                drawBorder: false,
                                lineWidth: 1
                            },
                            border: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 11, weight: '500' },
                                padding: 8,
                                callback: function (value) {
                                    return value.toFixed(1);
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            border: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 11, weight: '500' },
                                padding: 8
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function createAttendanceChart(data) {
            const ctx = document.getElementById('attendance-chart').getContext('2d');

            // Extract attendance data (convert to 0-5 scale to match other charts)
            const attendanceData = data.months.map(month => {
                const monthData = data.data[month];
                // Look for attendanceScore in the history entries for this month
                const entry = (appData.team[currentAnalyticsMember]?.history || []).find(h => h.month === month && !h.isStrategyEntry);
                // Check both field names for backward compatibility (old unified entries used 'attendance', new ones use 'attendanceScore')
                return entry?.attendanceScore || entry?.attendance || null;
            });

            // Create TSM-style gradient (fades to white)
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

            analyticsCharts.attendance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [
                        {
                            label: 'Attendance',
                            data: attendanceData,
                            borderColor: '#10b981',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#ffffff',
                            pointBorderColor: '#10b981',
                            pointBorderWidth: 2,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(16, 185, 129, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    return `Attendance: ${context.parsed.y?.toFixed(1) || 'N/A'}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.08)',
                                drawBorder: false,
                                lineWidth: 1
                            },
                            border: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 11, weight: '500' },
                                padding: 8,
                                callback: function (value) {
                                    return value.toFixed(1);
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            border: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 11, weight: '500' },
                                padding: 8
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function createEngagementChart(data) {
            const ctx = document.getElementById('engagement-chart');
            if (!ctx) return;

            // Extract engagement data and convert to numeric values
            const engagementData = data.months.map(month => {
                const entry = (appData.team[currentAnalyticsMember]?.history || []).find(h => h.month === month && h.isUnifiedEntry);
                if (!entry) return null; // No rating for this month - leave blank
                const level = entry.engagementLevel || '';
                if (level === 'High') return 3;
                if (level === 'Medium') return 2;
                if (level === 'Low') return 1;
                return null; // Not Set or incomplete rating - leave blank
            });

            analyticsCharts.engagement = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [{
                        label: 'Engagement Level',
                        data: engagementData,
                        stepped: 'before',
                        spanGaps: false,
                        borderWidth: 3,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: function(context) {
                            const value = context.parsed.y;
                            if (value === 3) return 'rgb(20, 184, 166)';
                            if (value === 2) return 'rgb(251, 146, 60)';
                            if (value === 1) return 'rgb(244, 63, 94)';
                            return 'rgb(148, 163, 184)';
                        },
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        segment: {
                            borderColor: function(ctx) {
                                const currentValue = ctx.p0.parsed.y;
                                if (currentValue === 3) return 'rgb(20, 184, 166)';
                                if (currentValue === 2) return 'rgb(251, 146, 60)';
                                if (currentValue === 1) return 'rgb(244, 63, 94)';
                                return 'rgb(148, 163, 184)';
                            }
                        },
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return null;
                            
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            gradient.addColorStop(0, 'rgba(244, 63, 94, 0.1)');
                            gradient.addColorStop(0.33, 'rgba(251, 146, 60, 0.05)');
                            gradient.addColorStop(0.67, 'rgba(20, 184, 166, 0.05)');
                            gradient.addColorStop(1, 'rgba(20, 184, 166, 0.1)');
                            return gradient;
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 3.5,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    if (value === 3) return 'High';
                                    if (value === 2) return 'Medium';
                                    if (value === 1) return 'Low';
                                    return '';
                                },
                                color: '#94a3b8',
                                font: {
                                    size: 11,
                                    weight: '500'
                                },
                                padding: 8
                            },
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 1) return 'rgba(244, 63, 94, 0.2)';
                                    if (context.tick.value === 2) return 'rgba(251, 146, 60, 0.2)';
                                    if (context.tick.value === 3) return 'rgba(20, 184, 166, 0.2)';
                                    return 'rgba(148, 163, 184, 0.08)';
                                },
                                lineWidth: function(context) {
                                    if ([1, 2, 3].includes(context.tick.value)) return 2;
                                    return 1;
                                },
                                drawBorder: false
                            },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            border: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 11, weight: '500' },
                                padding: 8
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (value === 3) return 'Engagement: High';
                                    if (value === 2) return 'Engagement: Medium';
                                    if (value === 1) return 'Engagement: Low';
                                    return 'Engagement: Not Set';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Global filter variables
        let currentAccountFilter = 'all';
        let currentStatusFilter = 'all';
        let currentSearchTerm = '';

        function filterPerformanceDashboard() {
            currentAccountFilter = document.getElementById('account-filter').value;
            currentStatusFilter = document.getElementById('status-filter').value;
            renderPerformanceDashboard();
        }

        // Debounced search to improve performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function searchPerformanceDashboard() {
            currentSearchTerm = document.getElementById('member-search').value.toLowerCase().trim();
            // Show/hide clear button based on search term
            const clearBtn = document.getElementById('clear-search-btn');
            if (clearBtn) {
                clearBtn.style.opacity = currentSearchTerm ? '1' : '0';
            }
            renderPerformanceDashboard();
        }

        function clearSearch() {
            document.getElementById('member-search').value = '';
            currentSearchTerm = '';
            const clearBtn = document.getElementById('clear-search-btn');
            if (clearBtn) {
                clearBtn.style.opacity = '0';
            }
            renderPerformanceDashboard();
        }

        // Use debounced search for better performance
        const debouncedSearch = debounce(searchPerformanceDashboard, 300);

        function populateAccountFilter() {
            const accounts = [...new Set(appData.team.map(t => t.account).filter(a => a))].sort();
            const select = document.getElementById('account-filter');
            select.innerHTML = '<option value="all">All Accounts</option>' +
                accounts.map(acc => `<option value="${acc}">${acc}</option>`).join('');
        }

        function getActiveQuarterForMonth(monthStr) {
            if (!monthStr) return 'Q4 2025';
            const [m, y] = monthStr.split(" '");
            const monthIdx = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"].indexOf(m);
            const year = "20" + y;
            if (monthIdx >= 0 && monthIdx <= 2) return `Q1 ${year}`;
            if (monthIdx >= 3 && monthIdx <= 5) return `Q2 ${year}`;
            if (monthIdx >= 6 && monthIdx <= 8) return `Q3 ${year}`;
            return `Q4 ${year}`;
        }

        function getMonthsForQuarter(quarterStr) {
            if (!quarterStr) return [];
            const [q, y] = quarterStr.split(" ");
            const year = y || new Date().getFullYear().toString();
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const yearShort = year.slice(-2);

            if (q === 'Q1') return [`Jan '${yearShort}`, `Feb '${yearShort}`, `Mar '${yearShort}`];
            if (q === 'Q2') return [`Apr '${yearShort}`, `May '${yearShort}`, `Jun '${yearShort}`];
            if (q === 'Q3') return [`Jul '${yearShort}`, `Aug '${yearShort}`, `Sep '${yearShort}`];
            if (q === 'Q4') return [`Oct '${yearShort}`, `Nov '${yearShort}`, `Dec '${yearShort}`];
            return [];
        }

        function initializePerformanceDashboard() {
            // Generate default months (same logic as renderPerformanceDashboard)
            const generateDefaultMonths = () => {
                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const now = new Date();
                const result = [];
                for (let i = -6; i < 13; i++) {
                    const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
                    const monthName = months[date.getMonth()];
                    const year = date.getFullYear();
                    const yearShort = year.toString().slice(-2);
                    result.push(`${monthName} '${yearShort}`);
                }
                return result;
            };

            const monthMap = { "Jan": 0, "Feb": 1, "Mar": 2, "Apr": 3, "May": 4, "Jun": 5, "Jul": 6, "Aug": 7, "Sep": 8, "Oct": 9, "Nov": 10, "Dec": 11 };
            const getMonthValue = (mStr) => {
                if (!mStr) return 0; const [m, y] = mStr.split(" '"); return (parseInt(y) * 12) + monthMap[m];
            };

            const defaultMonths = generateDefaultMonths();
            const allMonthsArray = Array.from(new Set((appData.team || []).flatMap(m => (m.history || []).map(h => h.month)).filter(Boolean)));
            const combinedMonths = new Set([...defaultMonths, ...allMonthsArray]);
            const sortedMonths = Array.from(combinedMonths).sort((a, b) => getMonthValue(b) - getMonthValue(a));

            // Set current month as default
            const now = new Date();
            const currentMonth = `${["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][now.getMonth()]} '${now.getFullYear().toString().slice(-2)}`;

            // Set default to current month if available
            if (sortedMonths.includes(currentMonth)) {
                perfCurrentMonthView = currentMonth;
            } else if (sortedMonths.length > 0) {
                perfCurrentMonthView = sortedMonths[0];
            }

            // Sort by status (incomplete first) by default
            const sortSelect = document.getElementById('perf-sort-select');
            if (sortSelect) sortSelect.value = 'status';

            // Populate account filter
            populateAccountFilter();
        }

        function changePerformanceMonth(delta) {
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            if (!perfCurrentMonthView) perfCurrentMonthView = "Oct '25";

            const [mStr, yStr] = perfCurrentMonthView.split(" '");
            let monthIdx = months.indexOf(mStr);
            let year = parseInt("20" + yStr);

            // Adjust month
            monthIdx += delta;

            // Handle year rollover
            if (monthIdx > 11) {
                monthIdx = 0;
                year++;
            } else if (monthIdx < 0) {
                monthIdx = 11;
                year--;
            }

            const newMonthStr = months[monthIdx];
            const newYearShort = year.toString().slice(-2);
            perfCurrentMonthView = `${newMonthStr} '${newYearShort}`;

            renderPerformanceDashboard();
        }

        function renderPerformanceDashboard() {
            const grid = document.getElementById('perf-team-grid');
            if (!grid) {
                console.error('perf-team-grid element not found');
                return;
            }

            grid.innerHTML = '';

            // Filter for active members only
            let team = (appData.team || []).filter(m => m && m.active);

            // Apply account filter
            if (currentAccountFilter && currentAccountFilter !== 'all') {
                team = team.filter(m => m.account === currentAccountFilter);
            }

            // Apply status filter
            if (currentStatusFilter && currentStatusFilter !== 'all') {
                team = team.filter(m => {
                    const unifiedEntry = (m.history || []).find(h => h && h.month === perfCurrentMonthView && h.isUnifiedEntry);
                    const hasValidUnifiedEntry = unifiedEntry && unifiedEntry.finalScore > 0;

                    if (currentStatusFilter === 'pending') {
                        return !hasValidUnifiedEntry;
                    } else if (currentStatusFilter === 'completed') {
                        return hasValidUnifiedEntry;
                    }
                    return true;
                });
            }

            // Apply search filter
            if (currentSearchTerm) {
                team = team.filter(m =>
                    m.name.toLowerCase().includes(currentSearchTerm) ||
                    m.role.toLowerCase().includes(currentSearchTerm) ||
                    (m.account && m.account.toLowerCase().includes(currentSearchTerm))
                );
            }

            const allMonths = new Set();
            team.forEach(m => (m.history || []).forEach(h => allMonths.add(h.month)));

            // Generate default months (current month + past 3 months + future 12 months)
            const generateDefaultMonths = () => {
                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const now = new Date();
                const result = [];
                for (let i = -6; i < 13; i++) {
                    const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
                    const monthName = months[date.getMonth()];
                    const year = date.getFullYear();
                    const yearShort = year.toString().slice(-2);
                    result.push(`${monthName} '${yearShort}`);
                }
                return result;
            };

            const monthMap = { "Jan": 0, "Feb": 1, "Mar": 2, "Apr": 3, "May": 4, "Jun": 5, "Jul": 6, "Aug": 7, "Sep": 8, "Oct": 9, "Nov": 10, "Dec": 11 };
            const getMonthValue = (mStr) => {
                if (!mStr) return 0; const [m, y] = mStr.split(" '"); return (parseInt(y) * 12) + monthMap[m];
            };

            const defaultMonths = generateDefaultMonths();
            const allMonthsArray = Array.from(allMonths);
            const combinedMonths = new Set([...defaultMonths, ...allMonthsArray]);
            let sortedMonths = Array.from(combinedMonths).sort((a, b) => getMonthValue(b) - getMonthValue(a));

            // Initialize perfCurrentMonthView if not set
            if (!perfCurrentMonthView) perfCurrentMonthView = sortedMonths[0] || "Oct '25";

            const monthNavText = document.getElementById('perf-month-navigator-text');
            if (monthNavText) {
                monthNavText.innerText = perfCurrentMonthView;
            }

            const activeQuarter = getActiveQuarterForMonth(perfCurrentMonthView);
            const sortVal = document.getElementById('perf-sort-select') ? document.getElementById('perf-sort-select').value : 'status';

            team.sort((a, b) => {
                const monthlyEntryA = (a.history || []).find(h => h.month === perfCurrentMonthView && h.isUnifiedEntry);
                const monthlyEntryB = (b.history || []).find(h => h.month === perfCurrentMonthView && h.isUnifiedEntry);

                if (sortVal === 'name') return a.name.localeCompare(b.name);
                if (sortVal === 'account') return (a.account || '').localeCompare(b.account || '');
                if (sortVal === 'score') {
                    const scoreA = monthlyEntryA ? monthlyEntryA.finalScore : -1;
                    const scoreB = monthlyEntryB ? monthlyEntryB.finalScore : -1;
                    return scoreB - scoreA;
                }
                if (sortVal === 'status') {
                    // Priority: Rated > Empty
                    const hasEntryA = monthlyEntryA && monthlyEntryA.finalScore > 0 ? 1 : 0;
                    const hasEntryB = monthlyEntryB && monthlyEntryB.finalScore > 0 ? 1 : 0;

                    return hasEntryB - hasEntryA;
                }
                return 0;
            });

            let totalScore = 0; let count = 0;

            team.forEach((member, i) => {
                const originalIndex = appData.team.findIndex(t => t && t.id === member.id);
                if (originalIndex === -1) return;

                const unifiedEntry = (member.history || []).find(h => h && h.month === perfCurrentMonthView && h.isUnifiedEntry);
                const hasValidUnifiedEntry = unifiedEntry && unifiedEntry.finalScore > 0;

                const card = document.createElement('div');
                let highlightClass = '';
                if (!unifiedEntry || !hasValidUnifiedEntry) {
                    highlightClass = 'card-highlight-empty';
                }

                const accColor = getAccountColor(member.account);

                // --- UI FIX: Absolute Positioned Pill with Truncation ---
                const accountPill = `
        <div class="absolute top-4 right-4 z-10 max-w-[85px]" title="${member.account}">
            <span class="block w-full truncate px-2 py-0.5 text-[10px] font-bold rounded-full ${accColor} uppercase tracking-wide shadow-sm border border-opacity-20 text-center">
                ${member.account}
            </span>
        </div>`;

                if (!unifiedEntry || !hasValidUnifiedEntry) {
                    // Check if there's a saved draft
                    const hasDraft = (member.history || []).find(h => h.month === perfCurrentMonthView && h.isDraft);

                    // EMPTY STATE
                    card.className = `bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col group transition-all hover:shadow-md hover:border-dcx-blue min-h-[260px] ${highlightClass} relative cursor-context-menu`;
                    card.addEventListener('contextmenu', (e) => openPerformanceContextMenu(e, originalIndex, perfCurrentMonthView));
                    card.innerHTML = `
                ${accountPill}
                <div class="flex flex-col gap-1 mb-4 pr-16">
                    <h3 class="font-semibold text-slate-900 text-sm leading-tight truncate">${member.name}</h3>
                    <p class="text-xs text-slate-500 leading-tight">${member.role}</p>
                </div>
                <div class="flex-1 flex items-center justify-center text-center">
                    <div>
                        <button onclick="testStartRating(${originalIndex}, this.dataset.month)" data-month="${perfCurrentMonthView}" class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-200 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                            ${hasDraft ? ' Continue Rating' : 'Start Rating'}
                        </button>
                        ${hasDraft ? `<div class="mt-2 text-xs text-green-600 dark:text-green-400 font-semibold flex items-center justify-center gap-1">
                            <span></span> Metrics Saved
                        </div>` : ''}
                        <div class="mt-3">
                            <button onclick="openMemberAnalytics(${originalIndex})" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-slate-600 dark:text-slate-400 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                                <i data-lucide="bar-chart-3" class="w-3.5 h-3.5"></i>
                                View Analytics
                            </button>
                        </div>
                    </div>
                </div>`;
                }
                else {
                    // RATED STATE
                    totalScore += unifiedEntry.finalScore; count++;

                    // Get actual history for sparkline (up to 5 months ending with the selected month)
                    // Filter to only unified entries with valid scores up to and including the selected month
                    const currentMonthValue = getMonthValue(perfCurrentMonthView);
                    const memberHistory = (member.history || [])
                        .filter(h => {
                            if (!h.isUnifiedEntry || h.finalScore <= 0) return false;
                            const hMonthValue = getMonthValue(h.month);
                            return hMonthValue <= currentMonthValue;
                        })
                        .sort((a, b) => getMonthValue(a.month) - getMonthValue(b.month))
                        .slice(-5)  // Take last 5 months (or fewer if less than 5 exist)
                        .map(h => h.finalScore);

                    // If we have less than 2 data points, generate unique mock data
                    let historyData;
                    if (memberHistory.length < 2) {
                        // Generate deterministic unique trend based on member name
                        const score = unifiedEntry.finalScore;
                        const nameHash = member.name.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
                        historyData = [
                            score + ((Math.sin(nameHash) * 0.5) - 0.2),
                            score + ((Math.sin(nameHash + 1) * 0.4) - 0.1),
                            score + ((Math.sin(nameHash + 2) * 0.3)),
                            score + ((Math.sin(nameHash + 3) * 0.2) + 0.1),
                            score
                        ];
                    } else {
                        historyData = memberHistory;
                    }

                    const trendChart = getSparklineSVG(historyData);

                    let borderColor = unifiedEntry.finalScore >= 4.5 ? "ring-1 ring-green-500/20" : (unifiedEntry.finalScore < 3 ? "ring-1 ring-red-500/20" : "");
                    card.className = `bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative group transition-all hover:shadow-md hover:border-dcx-blue min-h-[260px] ${borderColor} cursor-context-menu`;
                    card.addEventListener('contextmenu', (e) => openPerformanceContextMenu(e, originalIndex, perfCurrentMonthView));

                    const metricsPreview = unifiedEntry.metrics.slice(0, 3).map(m => {
                        let scoreColor = m.score >= 3 ? 'text-green-600' : 'text-red-600';
                        return `<div class="flex items-center justify-between text-xs text-slate-600">
                    <span class="truncate pr-2">${m.name}</span>
                    <span class="${scoreColor} font-bold">${m.score}</span>
                </div>`;
                    }).join('');

                    card.innerHTML = `
                ${accountPill}
                <div class="flex flex-col gap-1 mb-4 pr-16">
                    <h3 class="font-semibold text-slate-900 text-sm leading-tight truncate">${member.name}</h3>
                    <p class="text-xs text-slate-500 leading-tight">${member.role}</p>
                </div>
                <div class="mb-4 space-y-1">${metricsPreview}</div>
                <div class="absolute bottom-4 left-6 right-6 pt-3 border-t border-slate-100 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl font-black text-slate-900">${unifiedEntry.finalScore.toFixed(1)}</span>
                        ${trendChart}
                    </div>
                    <div class="flex items-center gap-2">
                        ${getPerformanceRatingBadge(unifiedEntry.finalScore)}
                        <button onclick="openMemberAnalytics(${originalIndex})" class="p-1.5 text-slate-400 hover:text-slate-600 bg-slate-50 hover:bg-slate-100 rounded-md transition-colors" title="View Analytics">
                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>`;
                }
                grid.appendChild(card);
            });

            document.getElementById('perf-team-avg').innerText = count > 0 ? (totalScore / count).toFixed(2) : "0.00";
            document.getElementById('perf-month-display').innerText = `For ${perfCurrentMonthView}`;

            // Update Completion
            const ratedCount = team.filter(m => (m.history || []).find(h => h.month === perfCurrentMonthView && h.isUnifiedEntry && h.finalScore > 0)).length;
            const pct = team.length > 0 ? Math.round((ratedCount / team.length) * 100) : 0;
            document.getElementById('completion-text').innerText = `${ratedCount} of ${team.length} rated`;
            document.getElementById('completion-percent').innerText = `${pct}%`;
            document.getElementById('completion-circle').style.strokeDasharray = `${pct}, 100`;
            document.getElementById('total-members').innerText = team.length;

            if (typeof lucide !== 'undefined') lucide.createIcons();
            setTimeout(initSpotlight, 100);
        }

        function initPerformanceMetricBuilderForMember(memberIdx) {
            perfSingleMemberMode = true; // Set single member mode
            perfActiveMemberIdx = memberIdx; // Set active member directly

            // Switch to studio view but hide selector and landing
            ['perf-dashboard', 'perf-studio', 'perf-details'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById('perf-studio');
            if (target) target.classList.remove('hidden');

            // Hide studio selector and landing, show workspace directly
            document.getElementById('studio-selector').classList.add('hidden');
            document.getElementById('studio-landing').classList.add('hidden');
            document.getElementById('studio-workspace').classList.remove('hidden');

            // Initialize builder mode
            initPerformanceMetricBuilder();
        }

        function deletePerformanceEntry(memberIdx, month) {
            if (!confirm("Are you sure you want to delete this monthly rating? This action cannot be undone.")) return;

            const member = appData.team[memberIdx];
            if (!member || !member.history) return;

            const entryIdx = member.history.findIndex(h => h.month === month && !h.isStrategyEntry);
            if (entryIdx > -1) {
                member.history.splice(entryIdx, 1);
                saveData(); // Assuming saveData exists globally as per other parts of the app
                renderPerformanceDashboard();
                showToast("Monthly rating deleted successfully", "success");
            }
        }

        function deleteQuarterlyStrategy(memberIdx, quarter) {
            if (!confirm("Are you sure you want to delete this quarterly strategy? This will not affect existing monthly ratings but will remove the strategy framework. This action cannot be undone.")) return;

            const member = appData.team[memberIdx];
            if (!member || !member.history) return;

            const entryIdx = member.history.findIndex(h => h.quarter === quarter && h.isStrategyEntry);
            if (entryIdx > -1) {
                member.history.splice(entryIdx, 1);
                // Also clean up metricBuildingData if it exists
                if (member.metricBuildingData && member.metricBuildingData[quarter]) {
                    delete member.metricBuildingData[quarter];
                }
                saveData();
                renderPerformanceDashboard();
                showToast("Quarterly strategy deleted successfully", "success");
            }
        }

        function openRatingForMember(memberIdx, month) {
            perfSingleMemberMode = true; // Set single member mode
            perfActiveMemberIdx = memberIdx; // Set active member directly

            // Switch to studio view but hide selector and landing, show workspace directly
            ['perf-dashboard', 'perf-studio', 'perf-details'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById('perf-studio');
            if (target) target.classList.remove('hidden');

            // Hide studio selector and landing, show workspace directly
            document.getElementById('studio-selector').classList.add('hidden');
            document.getElementById('studio-landing').classList.add('hidden');
            document.getElementById('studio-workspace').classList.remove('hidden');

            // Open the rating form
            initPerformanceMetricRating();
            const periodSelect = document.getElementById('workspace-period-select');
            if (periodSelect) {
                periodSelect.value = month;
                handlePerformancePeriodChange();
            }
        }

        function editPerformanceEntry(memberIdx, month) {
            const member = appData.team[memberIdx];
            const entry = (member.history || []).find(h => h.month === month && !h.isStrategyEntry);
            if (!entry) return;

            perfSingleMemberMode = true; // Set single member mode
            perfActiveMemberIdx = memberIdx; // Set active member directly

            // Switch to studio view but hide selector and landing, show workspace directly
            ['perf-dashboard', 'perf-studio', 'perf-details'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById('perf-studio');
            if (target) target.classList.remove('hidden');

            // Hide studio selector and landing, show workspace directly
            document.getElementById('studio-selector').classList.add('hidden');
            document.getElementById('studio-landing').classList.add('hidden');
            document.getElementById('studio-workspace').classList.remove('hidden');

            // For monthly ratings, open the rating form
            initPerformanceMetricRating();
            const periodSelect = document.getElementById('workspace-period-select');
            if (periodSelect) {
                periodSelect.value = month;
                handlePerformancePeriodChange();
            }
        }

        function editQuarterlyStrategy(memberIdx, quarter) {
            const member = appData.team[memberIdx];
            const entry = (member.history || []).find(h => h.quarter === quarter && h.isStrategyEntry);
            if (!entry) return;

            perfSingleMemberMode = true; // Set single member mode
            perfActiveMemberIdx = memberIdx; // Set active member directly

            // Switch to studio view but hide selector and landing, show workspace directly
            ['perf-dashboard', 'perf-studio', 'perf-details'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById('perf-studio');
            if (target) target.classList.remove('hidden');

            // Hide studio selector and landing, show workspace directly
            document.getElementById('studio-selector').classList.add('hidden');
            document.getElementById('studio-landing').classList.add('hidden');
            document.getElementById('studio-workspace').classList.remove('hidden');

            // Load the quarterly strategy into metricBuildingData for editing
            if (!member.metricBuildingData) member.metricBuildingData = {};
            member.metricBuildingData[quarter] = entry.metrics;

            // Open the builder form
            initPerformanceMetricBuilder();
            const periodSelect = document.getElementById('workspace-period-select');
            if (periodSelect) {
                periodSelect.value = quarter;
                handlePerformancePeriodChange();
            }
        }

        // Studio Logic
        function closePerformanceWorkspace() {
            document.getElementById('studio-workspace').classList.add('hidden');
            document.getElementById('studio-landing').classList.remove('hidden');
            document.getElementById('studio-landing').classList.add('grid');
        }

        function initPerformanceMetricBuilder() {
            perfActiveMode = 'builder';
            // Hide the big selection card to reduce scrolling
            document.getElementById('studio-selector').classList.add('hidden');
            document.getElementById('studio-landing').classList.add('hidden');
            document.getElementById('studio-landing').classList.remove('grid');
            document.getElementById('studio-workspace').classList.remove('hidden');
            document.getElementById('workspace-error').classList.add('hidden');
            document.getElementById('workspace-content').classList.remove('hidden');
            document.getElementById('workspace-footer').classList.remove('hidden');
            document.getElementById('workspace-title').innerText = "Quarterly Strategy";
            document.getElementById('workspace-period-select').innerHTML = `<option value="Q3 2025">Q3 2025</option><option value="Q4 2025">Q4 2025</option><option value="Q1 2026">Q1 2026</option>`;
            document.getElementById('rating-core-components').classList.add('hidden');
            document.getElementById('score-readout').classList.add('hidden');
            document.getElementById('builder-grid-area').classList.remove('hidden');
            document.getElementById('builder-selected-header').classList.remove('hidden');
            handlePerformancePeriodChange();
            updateWorkspaceHeaderVisibility(); // Update member display
        }

        function initPerformanceMetricRating() {
            perfActiveMode = 'rating';
            // Hide the big selection card to reduce scrolling
            document.getElementById('studio-selector').classList.add('hidden');
            document.getElementById('studio-landing').classList.add('hidden');
            document.getElementById('studio-landing').classList.remove('grid');
            document.getElementById('studio-workspace').classList.remove('hidden');
            document.getElementById('workspace-title').innerText = "Monthly Performance Rating";

            // Dynamic Month Generation (Jan '24 - Dec '26)
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let options = "";
            for (let y = 24; y <= 26; y++) {
                for (let m = 0; m < 12; m++) {
                    const val = `${months[m]} '${y}`;
                    options += `<option value="${val}">${val}</option>`;
                }
            }
            document.getElementById('workspace-period-select').innerHTML = options;
            document.getElementById('rating-core-components').classList.remove('hidden');
            document.getElementById('score-readout').classList.remove('hidden');
            document.getElementById('builder-grid-area').classList.add('hidden');
            document.getElementById('builder-selected-header').classList.add('hidden');
            handlePerformancePeriodChange();
            updateWorkspaceHeaderVisibility(); // Update member display
        }

        function handlePerformancePeriodChange() {
            const period = document.getElementById('workspace-period-select').value;
            const container = document.getElementById('metric-rows-container');
            container.innerHTML = '';
            const member = appData.team[perfActiveMemberIdx];

            if (perfActiveMode === 'builder') {
                perfCurrentSelection = [];
                const existingData = (member.metricBuildingData || {})[period] || [];
                existingData.forEach(m => {
                    const found = PERF_CORE_METRICS.find(cm => cm.name === m.name);
                    if (found) perfCurrentSelection.push(found.id);
                });
                renderPerformanceBuilderGrid();
                renderPerformanceSelectedMetricsEditor(existingData);
                updatePerformanceSaveButtonState();
            } else if (perfActiveMode === 'rating') {
                // Get the active quarter for this month
                const quarter = getActiveQuarterForMonth(period);
                const quarterlyStrategy = getQuarterlyStrategy(perfActiveMemberIdx, quarter);

                if (!quarterlyStrategy || !quarterlyStrategy.metrics || quarterlyStrategy.metrics.length === 0) {
                    document.getElementById('workspace-content').classList.add('hidden');
                    document.getElementById('workspace-footer').classList.add('hidden');
                    document.getElementById('workspace-error').classList.remove('hidden');
                    // Update error message to be more helpful
                    document.getElementById('workspace-error').innerHTML = `
                        <div class="mx-auto w-16 h-16 bg-orange-50 dark:bg-orange-900/30 text-orange-500 dark:text-orange-400 rounded-full flex items-center justify-center mb-4">
                            <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-900 dark:text-slate-100">No Quarterly Strategy Found</h3>
                        <p class="text-slate-500 dark:text-slate-400 mt-2 mb-6">A quarterly strategy needs to be set for ${quarter} before monthly ratings can be completed.</p>
                        <button onclick="initPerformanceMetricBuilder()" class="px-6 py-3 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md">Set ${quarter} Strategy First</button>
                    `;
                    return;
                }
                document.getElementById('workspace-content').classList.remove('hidden');
                document.getElementById('workspace-footer').classList.remove('hidden');
                document.getElementById('workspace-error').classList.add('hidden');

                const existingEntry = (member.history || []).find(h => h.month === period && !h.isStrategyEntry);
                if (existingEntry) {
                    existingEntry.metrics.forEach((m, idx) => addPerformanceRatingRow(m, idx));
                    document.getElementById('rating-values-score').value = existingEntry.valuesScore;
                    document.getElementById('rating-attendance-score').value = existingEntry.attendanceScore;
                    updatePerformanceRubricDisplay('values', existingEntry.valuesScore);
                    updatePerformanceRubricDisplay('attendance', existingEntry.attendanceScore);
                    document.getElementById('final-score-display').innerText = existingEntry.finalScore.toFixed(2);
                } else {
                    quarterlyStrategy.metrics.forEach((m, idx) => addPerformanceRatingRow({ ...m, score: 0, notes: '' }, idx));
                    document.getElementById('rating-values-score').value = 0;
                    document.getElementById('rating-attendance-score').value = 0;
                    document.getElementById('final-score-display').innerText = "0.00";
                }
            }

            updateDeleteButtonVisibility();
        }

        function renderPerformanceBuilderGrid() {
            const grid = document.getElementById('metric-selection-grid');
            grid.innerHTML = '';
            PERF_CORE_METRICS.forEach(metric => {
                const isSelected = perfCurrentSelection.includes(metric.id);
                const card = document.createElement('div');
                card.className = `metric-card bg-white dark:bg-slate-800 p-5 rounded-xl flex items-start gap-4 cursor-pointer ${isSelected ? 'selected' : ''}`;
                card.onclick = () => togglePerformanceMetricSelection(metric.id);
                card.innerHTML = `
        <div class="mt-1 text-blue-600"><i data-lucide="${metric.icon}" class="w-6 h-6"></i></div>
        <div>
            <div class="flex justify-between items-center mb-1.5">
                <h5 class="font-bold text-slate-800 dark:text-slate-200 text-sm">${metric.name}</h5>${isSelected ? '<i data-lucide="check-circle" class="w-5 h-5 text-blue-600"></i>' : ''}
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-300 leading-relaxed font-medium">${metric.definition}</p>
        </div>`;
                grid.appendChild(card);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
            document.getElementById('selection-count').innerText = `${perfCurrentSelection.length}/4 Selected`;
        }

        function togglePerformanceMetricSelection(id) {
            const idx = perfCurrentSelection.indexOf(id);
            if (idx > -1) perfCurrentSelection.splice(idx, 1);
            else if (perfCurrentSelection.length < 4) perfCurrentSelection.push(id);
            else { alert("Max 4 metrics allowed."); return; }
            renderPerformanceBuilderGrid();
            renderPerformanceSelectedMetricsEditor();
            updatePerformanceSaveButtonState();
        }

        function renderPerformanceSelectedMetricsEditor(existingData = []) {
            const container = document.getElementById('metric-rows-container');
            const selectedMetrics = perfCurrentSelection.map(id => PERF_CORE_METRICS.find(m => m.id === id));
            container.innerHTML = '';

            selectedMetrics.forEach(metric => {
                let wsllValue = "";
                if (existingData.length > 0) {
                    const saved = existingData.find(d => d.name === metric.name);
                    if (saved) wsllValue = saved.whatSuccessLooksLike;
                }

                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition duration-300 group";
                const exampleOptions = metric.examples.map(ex => `<option value="${ex}">${ex}</option>`).join('');

                div.innerHTML = `
            <div class="flex items-center gap-3 mb-5">
                <div class="bg-blue-50 p-2.5 rounded-xl text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300 shadow-sm">
                    <i data-lucide="${metric.icon}" class="w-5 h-5"></i>
                </div>
                <h4 class="font-bold text-slate-800 builder-name text-lg tracking-tight">${metric.name}</h4>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-widest">What Success Looks Like</label>
                <select class="w-full input-premium rounded-lg mb-3 text-xs font-medium text-slate-600 p-3 cursor-pointer" onchange="this.nextElementSibling.value=this.value">
                    <option value=""> Select an example to auto-fill...</option>
                    ${exampleOptions}
                </select>
                <textarea class="builder-wsll w-full input-premium rounded-lg text-sm h-28 p-4 font-medium text-slate-700 leading-relaxed resize-none" placeholder="Define specifically what 5/5 performance looks like for this quarter...">${wsllValue}</textarea>
            </div>`;
                container.appendChild(div);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updatePerformanceSaveButtonState() {
            const btn = document.getElementById('btn-save-workspace');
            const msg = document.getElementById('builder-validation-msg');
            if (perfActiveMode === 'builder') {
                if (perfCurrentSelection.length >= 3 && perfCurrentSelection.length <= 4) {
                    btn.disabled = false;
                    msg.classList.add('hidden');
                } else {
                    btn.disabled = true;
                    msg.classList.remove('hidden');
                }
            } else {
                btn.disabled = false;
                msg.classList.add('hidden');
            }
        }

        function addPerformanceRatingRow(data, idx) {
            const container = document.getElementById('metric-rows-container');
            const meta = PERF_CORE_METRICS.find(m => m.name === data.name) || { icon: 'circle' };
            const div = document.createElement('div');
            div.className = "rating-row bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition";
            div.id = `rating-row-${idx}`;
            div.innerHTML = `
        <div class="flex items-center gap-3 mb-4">
            <div class="bg-blue-50 p-2.5 rounded-lg text-blue-600"><i data-lucide="${meta.icon}" class="w-5 h-5"></i></div>
            <div>
                <p class="font-bold text-slate-800 rating-name text-lg">${data.name}</p>
                <p class="text-xs text-slate-500 font-medium italic mt-1 pl-3 border-l-2 border-slate-200">Target: "${data.whatSuccessLooksLike}"</p>
                <input type="hidden" class="rating-wsll" value="${data.whatSuccessLooksLike}">
            </div>
        </div>
        <div class="grid md:grid-cols-2 gap-6 mt-5">
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Score</label>
                <select class="rating-score w-full border border-slate-300 rounded-lg p-2.5 text-sm font-semibold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none" onchange="updatePerformanceRowRubric(${idx}, this.value); calculatePerformanceRatingScore()">
                    <option value="0">Select...</option>
                    <option value="5" ${data.score == 5 ? 'selected' : ''}>5 - Outstanding</option>
                    <option value="4" ${data.score == 4 ? 'selected' : ''}>4 - Exceeds Expectations</option>
                    <option value="3" ${data.score == 3 ? 'selected' : ''}>3 - Meets Expectations</option>
                    <option value="2" ${data.score == 2 ? 'selected' : ''}>2 - Needs Improvement</option>
                    <option value="1" ${data.score == 1 ? 'selected' : ''}>1 - Unsatisfactory</option>
                </select>
                <div id="rubric-display-${idx}" class="rubric-def-box ${data.score > 0 ? '' : 'hidden'}">${data.score > 0 ? PERF_RUBRICS.general[data.score] : ''}</div>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Notes</label>
                <textarea class="rating-notes w-full border border-slate-300 rounded-lg p-3 text-sm h-full focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Evidence...">${data.notes || ''}</textarea>
            </div>
        </div>`;
            container.appendChild(div);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updatePerformanceRowRubric(idx, score) {
            const box = document.getElementById(`rubric-display-${idx}`);
            if (score > 0) { box.innerText = PERF_RUBRICS.general[score]; box.classList.remove('hidden'); }
            else { box.classList.add('hidden'); }
        }

        function updatePerformanceRubricDisplay(type, score) {
            const box = document.getElementById(`rubric-display-${type}`);
            if (score > 0) { box.innerText = PERF_RUBRICS[type][score]; box.classList.remove('hidden'); }
            else { box.classList.add('hidden'); }
        }

        /* --- FIXED: SCORE CALCULATION ENGINE --- */

        function calculatePerformanceRatingScore() {
            // 1. Calculate Average Metric Score from State
            let metricSum = 0;
            let metricCount = 0;

            // Iterate over the state ratings
            if (unifiedRatingState.ratings) {
                Object.values(unifiedRatingState.ratings).forEach(rating => {
                    if (rating.score > 0) {
                        metricSum += rating.score;
                        metricCount++;
                    }
                });
            }

            // 2. Get Mandatory Scores from State
            const valScore = unifiedRatingState.valuesScore || 0;
            const attScore = unifiedRatingState.attendanceScore || 0;

            // 3. Calculate Weighted Final Score
            // Formula: (MetricAvg * 55%) + (Values * 30%) + (Attendance * 15%)
            let final = 0;

            // Calculate Metric Average (Guard against divide by zero)
            const metricAvg = metricCount > 0 ? (metricSum / metricCount) : 0;

            if (metricCount > 0 || valScore > 0 || attScore > 0) {
                final = (metricAvg * 0.55) + (valScore * 0.30) + (attScore * 0.15);
            }

            // 4. Update All Display Elements
            const displayMandatory = document.getElementById('final-score-display'); // Phase 2 Display
            const displayRecap = document.getElementById('recap-final-score');       // Phase 3 Display
            if (displayMandatory) displayMandatory.innerText = final.toFixed(2);
            if (displayRecap) displayRecap.innerText = final.toFixed(2);
        }

        // Helper functions for quarter-month relationship
        function getActiveQuarterForMonth(month) {
            // Parse month and year from format like "Oct '24"
            const match = month.match(/^(\w+) '(\d+)$/);
            if (!match) return "Q4 2025";

            const monthName = match[1];
            const year = parseInt(match[2]);

            // Determine quarter based on month
            const monthIndex = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"].indexOf(monthName);
            const quarter = Math.floor(monthIndex / 3) + 1;

            return `Q${quarter} ${year + 2000}`;
        }

        function getQuarterlyStrategy(memberIdx, quarter) {
            const member = appData.team[memberIdx];
            return (member.history || []).find(h => h.quarter === quarter && h.isStrategyEntry);
        }



        function updatePerformanceSaveButtonState() {
            const btn = document.getElementById('btn-save-workspace');
            if (!btn) return;

            btn.disabled = false;
            btn.innerText = "Save Data";
        }

        function savePerformanceWorkspaceData() {
            const period = document.getElementById('workspace-period-select').value;

            if (perfActiveMemberIdx === null) return;
            const member = appData.team[perfActiveMemberIdx];

            if (perfActiveMode === 'builder') {
                const data = [];
                const container = document.getElementById('metric-rows-container');
                Array.from(container.children).forEach(row => {
                    data.push({
                        name: row.querySelector('.builder-name').innerText,
                        whatSuccessLooksLike: row.querySelector('.builder-wsll').value
                    });
                });

                if (!member.history) member.history = [];
                const existingIdx = member.history.findIndex(h => h.quarter === period && h.isStrategyEntry);

                // Check if metrics have changed
                let metricsChanged = false;
                if (existingIdx > -1) {
                    const existingEntry = member.history[existingIdx];
                    const existingMetricNames = (existingEntry.metrics || []).map(m => m.name).sort();
                    const newMetricNames = data.map(m => m.name).sort();

                    // Compare metric names (ignoring order)
                    if (existingMetricNames.length !== newMetricNames.length ||
                        !existingMetricNames.every((name, idx) => name === newMetricNames[idx])) {
                        metricsChanged = true;
                    }
                } else {
                    metricsChanged = true; // New metrics entry
                }

                // If metrics changed, delete all monthly ratings for this quarter
                if (metricsChanged) {
                    const monthsInQuarter = getMonthsForQuarter(period);
                    member.history = member.history.filter(h => {
                        // Keep strategy entries
                        if (h.isStrategyEntry) return true;
                        // Remove monthly ratings that belong to this quarter
                        if (h.month && monthsInQuarter.includes(h.month)) return false;
                        return true;
                    });
                }

                // Save the updated metrics
                if (existingIdx > -1) member.history.splice(existingIdx, 1);
                member.history.push({
                    quarter: period,
                    isStrategyEntry: true,
                    metrics: data,
                    dateSet: new Date().toISOString()
                });

            } else {
                saveSingleMemberRating(perfActiveMemberIdx, period);
            }

            saveData();
            renderPerformanceDashboard();
            closePerformanceWorkspaceToDashboard();
            showToast("Performance data saved successfully", "success");
        }

        function closePerformanceWorkspaceToDashboard() {
            // Hide workspace
            document.getElementById('studio-workspace').classList.add('hidden');

            // Go back to dashboard
            document.getElementById('perf-studio').classList.add('hidden');
            document.getElementById('perf-dashboard').classList.remove('hidden');

            // Reset studio landing state
            document.getElementById('studio-landing').classList.remove('hidden');
            document.getElementById('studio-landing').classList.add('grid');
        }

        function confirmDeleteMetrics() {
            if (perfActiveMemberIdx === null) return;

            const period = document.getElementById('workspace-period-select').value;
            const member = appData.team[perfActiveMemberIdx];
            const periodType = perfActiveMode === 'builder' ? 'quarter' : 'month';
            const periodLabel = periodType === 'quarter' ? `quarter ${period}` : `month ${period}`;

            const confirmed = confirm(`Are you sure you want to delete all metrics for ${periodLabel}?\n\nThis will also delete all related scores/ratings for this period.\n\nThis action cannot be undone.`);

            if (confirmed) {
                deleteMetricsForPeriod(perfActiveMemberIdx, period, periodType);
            }
        }

        function deleteMetricsForPeriod(memberIdx, period, periodType) {
            const member = appData.team[memberIdx];
            if (!member || !member.history) return;

            if (periodType === 'quarter') {
                // Delete quarterly strategy
                member.history = member.history.filter(h => {
                    if (h.isStrategyEntry && h.quarter === period) return false;
                    return true;
                });

                // Delete all monthly ratings for this quarter
                const monthsInQuarter = getMonthsForQuarter(period);
                member.history = member.history.filter(h => {
                    if (!h.isStrategyEntry && h.month && monthsInQuarter.includes(h.month)) return false;
                    return true;
                });

                // Also clean up metricBuildingData
                if (member.metricBuildingData && member.metricBuildingData[period]) {
                    delete member.metricBuildingData[period];
                }
            } else {
                // Delete monthly rating
                member.history = member.history.filter(h => {
                    if (!h.isStrategyEntry && h.month === period) return false;
                    return true;
                });
            }

            saveData();
            renderPerformanceDashboard();

            // Refresh the current view
            handlePerformancePeriodChange();

            showToast(`Metrics and scores deleted for ${period}`, "success");
        }

        function updateDeleteButtonVisibility() {
            const deleteBtn = document.getElementById('btn-delete-metrics');
            if (!deleteBtn) return;

            if (perfActiveMemberIdx === null) {
                deleteBtn.classList.add('hidden');
                return;
            }

            const period = document.getElementById('workspace-period-select').value;
            const member = appData.team[perfActiveMemberIdx];
            if (!member || !member.history) {
                deleteBtn.classList.add('hidden');
                return;
            }

            let hasMetrics = false;
            if (perfActiveMode === 'builder') {
                // Check if quarterly strategy exists
                hasMetrics = member.history.some(h => h.isStrategyEntry && h.quarter === period);
            } else {
                // Check if monthly rating exists
                hasMetrics = member.history.some(h => !h.isStrategyEntry && h.month === period);
            }

            if (hasMetrics) {
                deleteBtn.classList.remove('hidden');
            } else {
                deleteBtn.classList.add('hidden');
            }
        }

        function saveSingleMemberRating(idx, period) {
            const member = appData.team[idx];
            const rows = document.querySelectorAll('.rating-row');
            const metrics = [];
            rows.forEach(r => {
                metrics.push({
                    name: r.querySelector('.rating-name').innerText,
                    whatSuccessLooksLike: r.querySelector('.rating-wsll').value,
                    score: parseInt(r.querySelector('.rating-score').value) || 0,
                    notes: r.querySelector('.rating-notes').value
                });
            });

            const valScore = parseInt(document.getElementById('rating-values-score').value) || 0;
            const attScore = parseInt(document.getElementById('rating-attendance-score').value) || 0;
            const finalScore = parseFloat(document.getElementById('final-score-display').innerText) || 0;

            if (!member.history) member.history = [];
            const existingIdx = member.history.findIndex(h => h.month === period && !h.isStrategyEntry);
            if (existingIdx > -1) member.history.splice(existingIdx, 1);

            member.history.push({
                month: period,
                isStrategyEntry: false,
                metrics: metrics,
                valuesScore: valScore,
                valuesNotes: document.getElementById('rating-values-notes').value,
                attendanceScore: attScore,
                attendanceNotes: document.getElementById('rating-attendance-notes').value,
                finalScore: finalScore,
                dateRated: new Date().toISOString()
            });
        }

        // ===== UNIFIED RATING SYSTEM =====

        // Test function for debugging
        function testStartRating(memberIdx, month) {
            // Handle both direct string and dataset access
            const monthValue = typeof month === 'string' ? month : month;
            initUnifiedRating(memberIdx, monthValue);
        }

        // State for unified rating
        let unifiedRatingState = {
            memberIdx: null,
            month: null,
            selectedMetrics: [],
            currentMetricIndex: 0,
            ratings: {},
            wsllSelections: {},
            allow4thMetric: false,
            valuesScore: 0,
            attendanceScore: 0,
            valuesNotes: '',
            attendanceNotes: '',
            engagementLevel: ''
        };


        // Initialize unified rating for a member and month
        function initUnifiedRating(memberIdx, month) {
            const member = appData.team[memberIdx];
            if (!member) return;

            // Reset state
            unifiedRatingState = {
                memberIdx: memberIdx,
                month: month,
                selectedMetrics: [],
                currentMetricIndex: 0,
                ratings: {},
                wsllSelections: {},
                allow4thMetric: false,
                valuesScore: 0,
                attendanceScore: 0,
                valuesNotes: '',
                attendanceNotes: '',
                engagementLevel: ''
            };

            // Check if there's an existing unified entry
            const existingEntry = member.history.find(h =>
                h.month === month && h.isUnifiedEntry
            );

            if (existingEntry) {
                // Pre-populate with existing data
                unifiedRatingState.selectedMetrics = existingEntry.metrics.map(m => m.name);
                existingEntry.metrics.forEach(metric => {
                    // 1. Populate Ratings
                    unifiedRatingState.ratings[metric.name] = {
                        score: metric.score,
                        wsll: metric.wsll || null,
                        notes: metric.notes || ''
                    };
                    // 2. CRITICAL FIX: Populate Selection State for Dropdowns
                    unifiedRatingState.wsllSelections[metric.name] = metric.wsll || '';
                });
                unifiedRatingState.valuesScore = existingEntry.valuesScore || 0;
                unifiedRatingState.attendanceScore = existingEntry.attendanceScore || 0;
                unifiedRatingState.valuesNotes = existingEntry.valuesNotes || '';
                unifiedRatingState.attendanceNotes = existingEntry.attendanceNotes || '';
                unifiedRatingState.engagementLevel = existingEntry.engagementLevel || '';
                // Load 4th metric preference
                unifiedRatingState.allow4thMetric = existingEntry.allow4thMetric || false;
            } else {
                // Check if there's a saved draft
                const draftEntry = member.history.find(h => h.month === month && h.isDraft);
                if (draftEntry && draftEntry.draftData) {
                    // Load draft data
                    unifiedRatingState.selectedMetrics = draftEntry.draftData.selectedMetrics || [];
                    unifiedRatingState.wsllSelections = draftEntry.draftData.wsllSelections || {};
                    // Load 4th metric preference from draft
                    unifiedRatingState.allow4thMetric = draftEntry.draftData.allow4thMetric || false;
                    showToast(' Saved metrics loaded! Continue where you left off.', 'info');
                } else {
                    // Pre-populate metrics AND WSLL selections from previous month if available
                    const prevMonth = getPreviousMonth(month);
                    const prevEntry = member.history.find(h =>
                        h.month === prevMonth && h.isUnifiedEntry
                    );
                    if (prevEntry) {
                        // Copy metric names (up to 4 if 4th was enabled)
                        unifiedRatingState.selectedMetrics = prevEntry.metrics.slice(0, 4).map(m => m.name);

                        // NEW: Copy WSLL selections from previous month
                        prevEntry.metrics.slice(0, 4).forEach(metric => {
                            if (metric.wsll && metric.wsll.trim()) {
                                unifiedRatingState.wsllSelections[metric.name] = metric.wsll;
                            }
                        });
                        
                        // Copy 4th metric preference from previous month
                        unifiedRatingState.allow4thMetric = prevEntry.allow4thMetric || false;
                        
                        // Copy engagement level from previous month
                        unifiedRatingState.engagementLevel = prevEntry.engagementLevel || '';
                    }
                }
            }

            // Update UI
            const nameEl = document.getElementById('rating-member-name');
            const monthEl = document.getElementById('rating-month-display');

            if (nameEl) nameEl.textContent = member.name;
            if (monthEl) monthEl.textContent = month;

            // Directly show unified rating form (bypass switchPerformanceView to avoid conflicts)
            console.log('Hiding other views and showing unified rating');
            ['perf-dashboard', 'perf-studio', 'perf-details', 'perf-unified-rating'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('hidden');
                    console.log('Added hidden class to:', id);
                }
            });

            const unifiedEl = document.getElementById('perf-unified-rating');
            console.log('Unified element found:', !!unifiedEl);
            if (unifiedEl) {
                // The 'hidden' class was added just before this. Now, remove it to show the view.
                unifiedEl.classList.remove('hidden');

                // The parent 'performanceView' should already be visible from the main tab navigation.
                // We no longer force its display style, which was causing the bug.
                console.log('Final classes:', unifiedEl.className);
                console.log('Computed display:', getComputedStyle(unifiedEl).display);
            }

            // Start with metric selection phase
            showMetricSelectionPhase();
        }

        function toggleFourthMetricSlot() {
            const checkbox = document.getElementById('allow-4th-metric');
            unifiedRatingState.allow4thMetric = checkbox.checked;
            
            const description = document.getElementById('metric-selection-description');
            if (checkbox.checked) {
                description.textContent = 'Choose 3-4 metrics to evaluate for this period.';
                showToast('4th metric slot enabled', 'info');
            } else {
                description.textContent = 'Choose exactly 3 metrics to evaluate for this period.';
                if (unifiedRatingState.selectedMetrics.length === 4) {
                    showToast('Please deselect one metric to continue with 3', 'warning');
                }
            }
            
            updateSelectionCount();
        }

        // Show metric selection phase
        function showMetricSelectionPhase() {
            console.log('showMetricSelectionPhase called');
            // Hide other phases
            document.getElementById('rating-phase-metrics').classList.add('hidden');
            document.getElementById('rating-phase-mandatory').classList.add('hidden');
            document.getElementById('rating-phase-recap').classList.add('hidden');
            document.getElementById('rating-phase-complete').classList.add('hidden');
            const selectPhase = document.getElementById('rating-phase-select');
            selectPhase.classList.remove('hidden');
            console.log('selectPhase element:', selectPhase);

            // Ensure container has proper styling
            selectPhase.className = "space-y-6";
            selectPhase.innerHTML = `
                <div class="text-center mb-8">
                    <h3 class="text-2xl font-bold text-slate-900 dark:text-slate-100">Select Performance Metrics</h3>
                    <p id="metric-selection-description" class="text-slate-600 dark:text-slate-400 mt-2">${unifiedRatingState.allow4thMetric ? 'Choose 3-4 metrics to evaluate for this period.' : 'Choose exactly 3 metrics to evaluate for this period.'}</p>
                </div>
                
                <!-- 4th Metric Toggle -->
                <div class="mb-6 p-4 bg-amber-50 dark:bg-amber-900/20 border-2 border-amber-200 dark:border-amber-700 rounded-xl">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox" id="allow-4th-metric" onchange="toggleFourthMetricSlot()" 
                            class="w-5 h-5 rounded border-amber-300 text-amber-600 focus:ring-2 focus:ring-amber-500 cursor-pointer" ${unifiedRatingState.allow4thMetric ? 'checked' : ''}>
                        <div class="flex-1">
                            <span class="font-bold text-amber-900 dark:text-amber-100 group-hover:text-amber-700 dark:group-hover:text-amber-300 transition-colors">
                                <i data-lucide="plus-circle" class="w-4 h-4 inline"></i> Allow 4th metric slot
                            </span>
                            <p class="text-xs text-amber-700 dark:text-amber-300 mt-1">Enable this for rare situations requiring an additional focus area (e.g., client-requested priorities).</p>
                        </div>
                    </label>
                </div>
                
                <div id="metric-selection-grid-rating" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                <div class="flex justify-between items-center mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
                    <div class="text-sm font-medium text-slate-600 dark:text-slate-400">
                        <span id="selected-count">0/3 metrics, 0/3 WSLL</span>
                    </div>
                    <div class="flex gap-3">
                        <button id="btn-save-metrics"
                            class="px-6 py-2.5 bg-slate-200 text-slate-500 font-semibold text-sm rounded-lg transition disabled:opacity-30 disabled:cursor-not-allowed hover:bg-green-600 hover:text-white"
                            style="transition: all 0.3s ease;"
                            disabled>
                             Save Metrics
                        </button>
                        <button id="btn-continue-to-rating" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                            Continue <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;

            // Populate metric grid
            const grid = document.getElementById('metric-selection-grid-rating');
            console.log('PERF_CORE_METRICS length:', PERF_CORE_METRICS.length);
            console.log('Grid element:', grid);

            PERF_CORE_METRICS.forEach((metric, index) => {
                console.log('Rendering metric:', metric.name);
                const isSelected = unifiedRatingState.selectedMetrics.includes(metric.name);
                const currentWSLL = unifiedRatingState.wsllSelections?.[metric.name] || '';

                const card = document.createElement('div');
                card.className = `group relative rounded-xl border-2 cursor-pointer transition-all duration-200 hover:shadow-md overflow-hidden ${isSelected
                    ? 'border-blue-500 bg-blue-50/50 dark:bg-blue-900/20 shadow-sm'
                    : 'border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 hover:border-blue-300 dark:hover:border-blue-700'
                    }`;

                // Main card content
                const mainContent = `
                    <div class="p-5 ${isSelected ? 'pb-3' : ''}" onclick="toggleMetricSelection('${metric.name}')">
                        <div class="flex items-start justify-between mb-3">
                            <div class="p-2.5 rounded-lg ${isSelected ? 'bg-blue-100 text-blue-600 dark:bg-blue-900/50 dark:text-blue-300' : 'bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-400 group-hover:bg-blue-50 group-hover:text-blue-500 dark:group-hover:bg-slate-700/80'} transition-colors">
                                <i data-lucide="${metric.icon}" class="w-6 h-6"></i>
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${isSelected
                        ? 'border-blue-500 bg-blue-500 text-white scale-110'
                        : 'border-slate-300 dark:border-slate-600 text-transparent group-hover:border-blue-400'
                    }">
                                <i data-lucide="check" class="w-3.5 h-3.5 stroke-[3]"></i>
                            </div>
                        </div>
                        <h4 class="font-bold text-slate-900 dark:text-slate-100 mb-1.5 text-lg">${metric.name}</h4>
                        <p class="text-sm text-slate-500 dark:text-slate-400 leading-relaxed line-clamp-2">${metric.definition}</p>
                    </div>
                `;

                // WSLL dropdown (only shown when selected)
                // Get custom options for this metric
                // Only use standard options for dropdown
                const allOptions = [...metric.wsllOptions];
                
                // Check if current WSLL is a custom value (not in standard options)
                const isCustomValue = currentWSLL && !metric.wsllOptions.includes(currentWSLL) && currentWSLL !== '__custom__';
                const showCustomInput = currentWSLL === '__custom__' || isCustomValue;
                
                const wsllContent = isSelected ? `
                    <div class="px-5 pb-5 border-t border-blue-200/50 dark:border-blue-800/50 bg-blue-50/30 dark:bg-blue-900/10 animate-in slide-in-from-top-2 duration-200">
                        <label class="block text-xs font-bold text-blue-700 dark:text-blue-300 uppercase tracking-wider mt-4 mb-2">
                             What Success Looks Like (WSLL)
                        </label>
                        <select class="wsll-select w-full p-3 rounded-lg border border-blue-200 dark:border-blue-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                data-metric="${metric.name}" onchange="handleWSLLChange('${metric.name}', this.value)">
                            <option value="">Choose what success looks like...</option>
                            ${allOptions.map(option => `
                                <option value="${option}" ${currentWSLL === option ? 'selected' : ''}>
                                    ${option}
                                </option>
                            `).join('')}
                            <option value="__custom__" ${currentWSLL === '__custom__' ? 'selected' : ''}> Add Custom...</option>
                        </select>
                        
                        <!-- NEW: Display box for selected WSLL (standard dropdown selections) -->
                        <div class="wsll-display-box mt-3 ${currentWSLL && currentWSLL !== '' && currentWSLL !== '__custom__' && !isCustomValue ? '' : 'hidden'}" id="wsll-display-${metric.name.replace(/\s+/g, '-')}">
                            <div class="bg-white dark:bg-slate-700 border border-blue-200 dark:border-blue-600 rounded-lg p-3 max-h-24 overflow-y-auto">
                                <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">${currentWSLL && currentWSLL !== '__custom__' && !isCustomValue ? currentWSLL : ''}</p>
                            </div>
                        </div>
                        
                        <div class="wsll-custom-input mt-3 ${showCustomInput ? '' : 'hidden'}" id="custom-wsll-${metric.name.replace(/\s+/g, '-')}">
                            <textarea 
                                class="w-full p-3 rounded-lg border border-blue-300 dark:border-blue-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none"
                                placeholder="Type your custom success criteria..."
                                rows="3"
                                oninput="setMetricWSLLSelection('${metric.name}', this.value)"
                            >${isCustomValue ? currentWSLL : ''}</textarea>
                        </div>
                        <div class="text-xs text-blue-600 dark:text-blue-400 mt-2 italic">
                            This helps contextualize your performance rating.
                        </div>
                    </div>
                ` : '';

                card.innerHTML = mainContent + wsllContent;
                grid.appendChild(card);
            });

            updateSelectionCount();

            // Re-attach event listener for Save Metrics button
            document.getElementById('btn-save-metrics').addEventListener('click', function () {
                console.log(' Save Metrics button clicked!');

                const selectedCount = unifiedRatingState.selectedMetrics.length;
                const allHaveWSLL = unifiedRatingState.selectedMetrics.every(metric =>
                    unifiedRatingState.wsllSelections[metric] && unifiedRatingState.wsllSelections[metric] !== ''
                );

                console.log('Selected count:', selectedCount);
                console.log('All have WSLL:', allHaveWSLL);
                console.log('State:', unifiedRatingState);

                const expectedCount = unifiedRatingState.allow4thMetric ? 4 : 3;
                if (selectedCount === expectedCount && allHaveWSLL) {
                    try {
                        console.log(' Saving metrics...');

                        // Save the draft to the member's history
                        const member = appData.team[unifiedRatingState.memberIdx];
                        const month = unifiedRatingState.month;

                        console.log('Member:', member.name, 'Month:', month);

                        // Find or create history entry
                        let historyEntry = member.history.find(h => h.month === month);
                        if (!historyEntry) {
                            historyEntry = {
                                month: month,
                                isDraft: true,
                                draftData: {}
                            };
                            member.history.push(historyEntry);
                            console.log('Created new history entry');
                        } else {
                            console.log('Found existing history entry');
                        }

                        // Save draft data
                        historyEntry.isDraft = true;
                        historyEntry.draftData = {
                            selectedMetrics: [...unifiedRatingState.selectedMetrics],
                            wsllSelections: { ...unifiedRatingState.wsllSelections },
                            allow4thMetric: unifiedRatingState.allow4thMetric,
                            savedAt: new Date().toISOString()
                        };

                        console.log('Draft data:', historyEntry.draftData);

                        saveData();
                        console.log(' Saved to localStorage');

                        // Show immediate feedback
                        showToast(' Metrics Saved Successfully!', 'success');

                        // Also change button appearance temporarily
                        const saveBtn = document.getElementById('btn-save-metrics');
                        saveBtn.textContent = ' Saved!';
                        saveBtn.classList.add('bg-green-700');

                        // Return to dashboard
                        setTimeout(() => {
                            console.log('Returning to dashboard...');
                            switchPerformanceView('dashboard');
                            renderPerformanceDashboard();
                        }, 1500);
                    } catch (error) {
                        console.error(' Error saving metrics:', error);
                        showToast(' Error saving metrics. Check console.', 'error');
                    }
                } else {
                    console.log(' Validation failed');
                    const expectedCount = unifiedRatingState.allow4thMetric ? 4 : 3;
                    showToast(` Please select ${expectedCount} metrics and define WSLL for all`, 'error');
                }
            });

            // Re-attach event listener for the new button
            document.getElementById('btn-continue-to-rating').addEventListener('click', function () {
                const selectedCount = unifiedRatingState.selectedMetrics.length;
                const allHaveWSLL = unifiedRatingState.selectedMetrics.every(metric => {
                    const wsllValue = unifiedRatingState.wsllSelections[metric];
                    const hasValue = wsllValue !== undefined && wsllValue !== null && wsllValue !== '';
                    console.log(`Debug - Metric "${metric}": WSLL value = "${wsllValue}", hasValue = ${hasValue}`);
                    return hasValue;
                });

                console.log('Debug - Selected metrics:', unifiedRatingState.selectedMetrics);
                console.log('Debug - WSLL selections:', unifiedRatingState.wsllSelections);
                console.log('Debug - Selected count:', selectedCount);
                console.log('Debug - All have WSLL:', allHaveWSLL);

                // Check if correct number of metrics based on 4th metric toggle
                const expectedCount = unifiedRatingState.allow4thMetric ? 4 : 3;
                if (selectedCount === expectedCount) {
                    showMetricRatingPhase();
                } else {
                    showToast(`Please select ${expectedCount} metrics`, 'error');
                }

                // Keep the detailed logging for debugging
                if (!(selectedCount === expectedCount && allHaveWSLL)) {
                    const missingWSLL = unifiedRatingState.selectedMetrics.filter(metric =>
                        !unifiedRatingState.wsllSelections[metric] ||
                        unifiedRatingState.wsllSelections[metric] === ''
                    );
                    console.log('Debug - Missing WSLL for metrics:', missingWSLL);
                    console.log('Debug - Should proceed?', selectedCount === 3 && allHaveWSLL);
                }
            });

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Toggle metric selection
        function toggleMetricSelection(metricName) {
            const index = unifiedRatingState.selectedMetrics.indexOf(metricName);

            if (index > -1) {
                // Deselecting - remove from selected metrics and clear WSLL
                unifiedRatingState.selectedMetrics.splice(index, 1);
                delete unifiedRatingState.wsllSelections[metricName];
                delete unifiedRatingState.ratings[metricName];
            } else {
                // Selecting - add to selected metrics (only if less than max)
                const maxMetrics = unifiedRatingState.allow4thMetric ? 4 : 3;
                if (unifiedRatingState.selectedMetrics.length < maxMetrics) {
                    unifiedRatingState.selectedMetrics.push(metricName);
                    // Initialize WSLL and rating state
                    unifiedRatingState.wsllSelections[metricName] = '';
                    unifiedRatingState.ratings[metricName] = { score: 0, wsll: null };
                } else {
                    showToast(`You can only select ${maxMetrics} metrics`, 'error');
                    return;
                }
            }

            // Re-render the grid to show/hide WSLL dropdowns
            showMetricSelectionPhase();
        }

        // Update selection count and continue button
        function updateSelectionCount() {
            const maxMetrics = unifiedRatingState.allow4thMetric ? 4 : 3;
            const selectedCount = unifiedRatingState.selectedMetrics.length;
            const wsllComplete = unifiedRatingState.selectedMetrics.filter(metric =>
                unifiedRatingState.wsllSelections[metric] && unifiedRatingState.wsllSelections[metric] !== ''
            ).length;

            document.getElementById('selected-count').textContent = `${selectedCount}/${maxMetrics} metrics, ${wsllComplete}/${maxMetrics} WSLL`;

            const continueBtn = document.getElementById('btn-continue-to-rating');
            const saveMetricsBtn = document.getElementById('btn-save-metrics');

            const isComplete = (selectedCount === 3 || (unifiedRatingState.allow4thMetric && selectedCount === 4)) && selectedCount === wsllComplete;

            // Enable both buttons when complete
            continueBtn.disabled = !isComplete;
            saveMetricsBtn.disabled = !isComplete;

            // Visual feedback for save button
            if (isComplete) {
                saveMetricsBtn.classList.remove('bg-slate-200', 'text-slate-500');
                saveMetricsBtn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700', 'shadow-md');
            } else {
                saveMetricsBtn.classList.add('bg-slate-200', 'text-slate-500');
                saveMetricsBtn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700', 'shadow-md');
            }
        }

        // Continue to rating phase
        document.getElementById('btn-continue-to-rating').addEventListener('click', function () {
            const selectedCount = unifiedRatingState.selectedMetrics.length;
            const allHaveWSLL = unifiedRatingState.selectedMetrics.every(metric =>
                unifiedRatingState.wsllSelections[metric] && unifiedRatingState.wsllSelections[metric] !== ''
            );

            if (selectedCount === 3 && allHaveWSLL) {
                showMetricRatingPhase();
            } else if (selectedCount < 3) {
                showToast('Please select 3 metrics', 'error');
            } else {
                showToast('Please choose WSLL for all selected metrics', 'error');
            }
        });

        // Show metric rating phase (Phase 1: Rate all 3 metrics at once)
        function showMetricRatingPhase() {
            // Hide other phases
            document.getElementById('rating-phase-select').classList.add('hidden');
            document.getElementById('rating-phase-mandatory').classList.add('hidden');
            document.getElementById('rating-phase-recap').classList.add('hidden');
            document.getElementById('rating-phase-metrics').classList.remove('hidden');

            // Render all 3 metrics for simultaneous rating
            renderMetricRatingGrid();
        }

        // Render the metric rating grid (all 3 metrics at once)
        function renderMetricRatingGrid() {
            const container = document.getElementById('metrics-rating-grid');
            container.innerHTML = '';

            unifiedRatingState.selectedMetrics.forEach((metricName, index) => {
                const metric = PERF_CORE_METRICS.find(m => m.name === metricName);
                const existingRating = unifiedRatingState.ratings[metricName] || { score: 0, wsll: unifiedRatingState.wsllSelections[metricName] || null };

                const metricCard = document.createElement('div');
                metricCard.className = 'bg-slate-50 dark:bg-slate-700/50 rounded-xl p-6';
                metricCard.innerHTML = `
                    <div class="flex items-start gap-4 mb-4">
                        <div class="bg-blue-100 dark:bg-blue-900/50 p-3 rounded-lg">
                            <i data-lucide="${metric.icon}" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-900 dark:text-slate-100 mb-1">${metric.name}</h4>
                            <p class="text-sm text-slate-600 dark:text-slate-300 mb-2">${metric.definition}</p>
                            <div class="text-xs text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded inline-block">
                                WSLL: ${existingRating.wsll || 'Not defined'}
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <label class="block text-sm font-semibold text-slate-900 dark:text-slate-100 mb-3">
                             Performance Rating
                        </label>
                        <select class="metric-rating-select w-full input-premium rounded-lg p-2.5 text-sm font-semibold text-slate-700 mb-3"
                                data-metric="${metricName}" onchange="updateMetricRating('${metricName}', this.value)">
                            <option value="0">Select Score...</option>
                            <option value="5" ${existingRating.score == 5 ? 'selected' : ''}>5 - Outstanding</option>
                            <option value="4" ${existingRating.score == 4 ? 'selected' : ''}>4 - Exceeds Expectations</option>
                            <option value="3" ${existingRating.score == 3 ? 'selected' : ''}>3 - Meets Expectations</option>
                            <option value="2" ${existingRating.score == 2 ? 'selected' : ''}>2 - Needs Improvement</option>
                            <option value="1" ${existingRating.score == 1 ? 'selected' : ''}>1 - Unsatisfactory</option>
                        </select>
                        <div class="metric-rubric-display rubric-def-box ${existingRating.score > 0 ? '' : 'hidden'}">${existingRating.score > 0 ? PERF_RUBRICS.general[existingRating.score] : ''}</div>
                        <textarea class="metric-notes w-full input-premium rounded-lg p-3 text-sm h-24 mt-4"
                            data-metric="${metricName}" placeholder="Evidence and notes..." oninput="updateMetricNotes('${metricName}', this.value)">${existingRating.notes || ''}</textarea>
                    </div>
                `;

                container.appendChild(metricCard);
            });

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Update metric rating from dropdown
        function updateMetricRating(metricName, score) {
            const scoreNum = parseInt(score);
            if (!unifiedRatingState.ratings[metricName]) {
                unifiedRatingState.ratings[metricName] = { score: 0, wsll: null, notes: '' };
            }
            unifiedRatingState.ratings[metricName].score = scoreNum;

            // Update rubric display
            const rubricDisplay = document.querySelector(`.metric-rating-select[data-metric="${metricName}"]`).parentElement.querySelector('.metric-rubric-display');
            if (rubricDisplay) {
                if (scoreNum > 0) {
                    rubricDisplay.textContent = PERF_RUBRICS.general[scoreNum];
                    rubricDisplay.classList.remove('hidden');
                } else {
                    rubricDisplay.classList.add('hidden');
                }
            }

            // Recalculate final score
            calculatePerformanceRatingScore();
        }

        // Update metric notes
        function updateMetricNotes(metricName, notes) {
            if (!unifiedRatingState.ratings[metricName]) {
                unifiedRatingState.ratings[metricName] = { score: 0, wsll: null, notes: '' };
            }
            unifiedRatingState.ratings[metricName].notes = notes;
        }

        /* --- FIXED: UNIFIED RATING LOGIC (Correct IDs) --- */

        /* --- UPDATED: MANDATORY METRIC HANDLER --- */

        function updateUnifiedMandatoryMetrics(type, val) {
            const score = parseInt(val) || 0;

            // Update State
            if (type === 'values') {
                unifiedRatingState.valuesScore = score;
                const rubricDiv = document.getElementById('unified-rubric-values');
                if (rubricDiv) {
                    rubricDiv.innerText = score > 0 ? PERF_RUBRICS.values[score] : '';
                    rubricDiv.classList.toggle('hidden', score === 0);
                }
            } else if (type === 'attendance') {
                unifiedRatingState.attendanceScore = score;
                const rubricDiv = document.getElementById('unified-rubric-attendance');
                if (rubricDiv) {
                    rubricDiv.innerText = score > 0 ? PERF_RUBRICS.attendance[score] : '';
                    rubricDiv.classList.toggle('hidden', score === 0);
                }
            } else if (type === 'engagement') {
                unifiedRatingState.engagementLevel = val;
            }

            // TRIGGER RECALCULATION IMMEDIATELY
            calculatePerformanceRatingScore();
        }

        // Updated Show Function to use new IDs
        function showMandatoryRatingPhase() {
            // Hide other phases
            document.getElementById('rating-phase-select').classList.add('hidden');
            document.getElementById('rating-phase-metrics').classList.add('hidden');
            document.getElementById('rating-phase-recap').classList.add('hidden');
            document.getElementById('rating-phase-mandatory').classList.remove('hidden');

            // Pre-populate existing values using the NEW Unique IDs
            const valuesSelect = document.getElementById('unified-values-score');
            const attendanceSelect = document.getElementById('unified-attendance-score');
            const engagementSelect = document.getElementById('unified-engagement-level');
            const valuesNotesElement = document.getElementById('unified-values-notes');
            const attendanceNotesElement = document.getElementById('unified-attendance-notes');
            
            if (valuesSelect) {
                valuesSelect.value = unifiedRatingState.valuesScore || 0;
                updateUnifiedMandatoryMetrics('values', valuesSelect.value);
            }
            if (valuesNotesElement) {
                valuesNotesElement.value = unifiedRatingState.valuesNotes || '';
            }
            if (attendanceSelect) {
                attendanceSelect.value = unifiedRatingState.attendanceScore || 0;
                updateUnifiedMandatoryMetrics('attendance', attendanceSelect.value);
            }
            if (attendanceNotesElement) {
                attendanceNotesElement.value = unifiedRatingState.attendanceNotes || '';
            }
            if (engagementSelect) {
                engagementSelect.value = unifiedRatingState.engagementLevel || '';
            }
        }

        // Show final recap phase (Phase 3: Summary and Save)
        function showFinalRecapPhase() {
            // Hide other phases
            document.getElementById('rating-phase-select').classList.add('hidden');
            document.getElementById('rating-phase-metrics').classList.add('hidden');
            document.getElementById('rating-phase-mandatory').classList.add('hidden');
            document.getElementById('rating-phase-recap').classList.remove('hidden');

            // Ensure WSLL data is transferred from selections to ratings for recap display
            unifiedRatingState.selectedMetrics.forEach(metricName => {
                if (unifiedRatingState.wsllSelections[metricName] &&
                    (!unifiedRatingState.ratings[metricName] || !unifiedRatingState.ratings[metricName].wsll)) {
                    if (!unifiedRatingState.ratings[metricName]) {
                        unifiedRatingState.ratings[metricName] = { score: 0, wsll: null, notes: '' };
                    }
                    unifiedRatingState.ratings[metricName].wsll = unifiedRatingState.wsllSelections[metricName];
                }
            });

            // Capture notes from textareas
            const valuesNotesElement = document.getElementById('unified-values-notes');
            const attendanceNotesElement = document.getElementById('unified-attendance-notes');
            if (valuesNotesElement) {
                unifiedRatingState.valuesNotes = valuesNotesElement.value || '';
            }
            if (attendanceNotesElement) {
                unifiedRatingState.attendanceNotes = attendanceNotesElement.value || '';
            }

            // Populate the recap with all data
            renderFinalRecap();
        }

        // Render the final recap with all ratings and final score
        /* --- FIXED: RECAP UI (Detailed Labels & Formatting) --- */

        function renderFinalRecap() {
            const metricsContainer = document.getElementById('recap-metrics-summary');
            const finalScoreElement = document.getElementById('recap-final-score');

            const valuesScoreElement = document.getElementById('recap-values-score');
            const valuesRubricElement = document.getElementById('recap-values-rubric');

            const attendanceScoreElement = document.getElementById('recap-attendance-score');
            const attendanceRubricElement = document.getElementById('recap-attendance-rubric');

            // Helper for labels
            const getLabel = (s) => getPerformanceRatingLabel(s);
            const getColor = (s) => {
                if (s >= 4.5) return 'text-green-600 bg-green-50 border-green-200';
                if (s >= 4.0) return 'text-blue-600 bg-blue-50 border-blue-200';
                if (s >= 3.0) return 'text-slate-600 bg-slate-50 border-slate-200';
                return 'text-red-600 bg-red-50 border-red-200';
            };

            // 1. Render Metrics Summary
            metricsContainer.innerHTML = '';
            unifiedRatingState.selectedMetrics.forEach(metricName => {
                const metric = PERF_CORE_METRICS.find(m => m.name === metricName);
                const rating = unifiedRatingState.ratings[metricName] || { score: 0, wsll: unifiedRatingState.wsllSelections[metricName] || null };

                const label = getLabel(rating.score);
                const badgeClass = getColor(rating.score);

                const metricCard = document.createElement('div');
                metricCard.className = 'bg-white dark:bg-slate-800 p-5 rounded-xl border border-slate-200 dark:border-slate-600 shadow-sm';

                metricCard.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <span class="text-sm font-bold text-slate-800 dark:text-slate-100 w-2/3">${metric.name}</span>
                        <div class="text-right">
                            <span class="text-lg font-black text-slate-800 dark:text-white block leading-none">${rating.score}/5</span>
                            <span class="text-[10px] font-bold uppercase tracking-wide text-slate-500">${label}</span>
                        </div>
                    </div>

                    <div class="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700 mb-2">
                        <p class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase mb-1">Target</p>
                        <p class="text-xs text-slate-700 dark:text-slate-300 italic">"${rating.wsll || 'No target defined'}"</p>
                    </div>

                    ${rating.notes ? `<p class="text-xs text-slate-600 dark:text-slate-400 mt-2 pl-2 border-l-2 border-slate-300"> ${rating.notes}</p>` : ''}
                `;

                metricsContainer.appendChild(metricCard);
            });

            // 2. Update Values & Attendance
            const vScore = unifiedRatingState.valuesScore || 0;
            const aScore = unifiedRatingState.attendanceScore || 0;

            // Values UI
            valuesScoreElement.innerHTML = `
                <span class="text-xl font-bold text-slate-800 dark:text-white mr-2">${vScore}/5</span>
                <span class="px-2 py-0.5 rounded text-[10px] font-bold border uppercase ${getColor(vScore)}">${getLabel(vScore)}</span>
            `;
            valuesRubricElement.textContent = vScore > 0 ? PERF_RUBRICS.values[vScore] : 'Not rated';
            
            // Remove existing notes element if present
            const existingValuesNotes = valuesRubricElement.parentElement.querySelector('#recap-values-notes');
            if (existingValuesNotes) existingValuesNotes.remove();
            
            // Add notes if they exist
            const valuesNotes = unifiedRatingState.valuesNotes || '';
            if (valuesNotes.trim()) {
                const notesElement = document.createElement('p');
                notesElement.id = 'recap-values-notes';
                notesElement.className = 'text-xs text-slate-600 dark:text-slate-400 mt-2 pl-2 border-l-2 border-slate-300';
                notesElement.textContent = ` ${valuesNotes}`;
                valuesRubricElement.parentElement.appendChild(notesElement);
            }

            // Attendance UI
            attendanceScoreElement.innerHTML = `
                <span class="text-xl font-bold text-slate-800 dark:text-white mr-2">${aScore}/5</span>
                <span class="px-2 py-0.5 rounded text-[10px] font-bold border uppercase ${getColor(aScore)}">${getLabel(aScore)}</span>
            `;
            attendanceRubricElement.textContent = aScore > 0 ? PERF_RUBRICS.attendance[aScore] : 'Not rated';
            
            // Remove existing notes element if present
            const existingAttendanceNotes = attendanceRubricElement.parentElement.querySelector('#recap-attendance-notes');
            if (existingAttendanceNotes) existingAttendanceNotes.remove();
            
            // Add notes if they exist
            const attendanceNotes = unifiedRatingState.attendanceNotes || '';
            if (attendanceNotes.trim()) {
                const notesElement = document.createElement('p');
                notesElement.id = 'recap-attendance-notes';
                notesElement.className = 'text-xs text-slate-600 dark:text-slate-400 mt-2 pl-2 border-l-2 border-slate-300';
                notesElement.textContent = ` ${attendanceNotes}`;
                attendanceRubricElement.parentElement.appendChild(notesElement);
            }

            // Engagement Level
            const engagementLevel = unifiedRatingState.engagementLevel || 'Not Set';
            const engagementLevelElement = document.getElementById('recap-engagement-level');
            if (engagementLevelElement) {
                engagementLevelElement.textContent = engagementLevel;
            }

            // 3. Final Score & Description
            const finalScore = parseFloat(document.getElementById('final-score-display').textContent) || 0;
            const finalLabel = getLabel(finalScore);
            const finalColor = getColor(finalScore); // Reusing the style generator for the badge

            finalScoreElement.textContent = finalScore.toFixed(2);

            // Add the description label below the score if it doesn't exist
            let finalDesc = document.getElementById('recap-final-desc');
            if (!finalDesc) {
                finalDesc = document.createElement('div');
                finalDesc.id = 'recap-final-desc';
                finalScoreElement.parentNode.insertBefore(finalDesc, finalScoreElement.nextSibling);
            }

            finalDesc.innerHTML = `<span class="inline-block mt-2 px-4 py-1.5 rounded-full text-sm font-bold border uppercase tracking-wide shadow-sm ${finalColor}">${finalLabel}</span>`;
        }


        // Setup rating event listeners
        function setupRatingEventListeners() {
            // Star rating
            document.querySelectorAll('.star-rating[data-metric] .star').forEach(star => {
                star.addEventListener('click', function () {
                    const metricName = this.closest('.star-rating').dataset.metric;
                    const value = parseInt(this.dataset.value);
                    setMetricRating(metricName, value);
                });
            });

            // WSLL Select
            const wsllSelect = document.querySelector('.wsll-select');
            if (wsllSelect) {
                wsllSelect.addEventListener('change', function () {
                    const metricName = this.dataset.metric;
                    const value = this.value;
                    setMetricWSLL(metricName, value);
                });
            }
        }

        // Set metric rating
        function setMetricRating(metricName, score) {
            console.log(`Setting rating for ${metricName}: ${score}`);
            if (!unifiedRatingState.ratings[metricName]) {
                unifiedRatingState.ratings[metricName] = { score: 0, wsll: null };
            }
            unifiedRatingState.ratings[metricName].score = score;
            // showCurrentMetricRating(); // Re-render to update UI - Wait, this re-renders the whole view, losing focus?
            // Better to just update the stars visually
            updateMetricStarDisplay(metricName, score);
        }

        function updateMetricStarDisplay(metricName, score) {
            const container = document.querySelector(`.star-rating[data-metric="${metricName}"]`);
            if (container) {
                container.querySelectorAll('.star').forEach(star => {
                    const val = parseInt(star.dataset.value);
                    star.className = `star text-3xl ${val <= score ? 'text-yellow-400' : 'text-slate-300'} hover:text-yellow-400 transition`;
                });
                // Update label
                const label = container.nextElementSibling;
                if (label) {
                    const rubricText = (typeof PERF_RUBRICS !== 'undefined' && PERF_RUBRICS.general && PERF_RUBRICS.general[score]) || 'Select a rating';
                    label.textContent = rubricText;
                }
            }
        }

        // Set metric WSLL
        function setMetricWSLL(metricName, wsll) {
            if (!unifiedRatingState.ratings[metricName]) {
                unifiedRatingState.ratings[metricName] = { score: 0, wsll: null };
            }
            unifiedRatingState.ratings[metricName].wsll = wsll;
            // Also update the wsllSelections for consistency
            unifiedRatingState.wsllSelections[metricName] = wsll;
        }

        // Handle WSLL dropdown change (shows/hides custom input and display box)
        function handleWSLLChange(metricName, value) {
            const customInputId = `custom-wsll-${metricName.replace(/\s+/g, '-')}`;
            const displayBoxId = `wsll-display-${metricName.replace(/\s+/g, '-')}`;
            const customInputContainer = document.getElementById(customInputId);
            const displayBox = document.getElementById(displayBoxId);
            
            if (value === '__custom__') {
                // Show custom input textarea, hide display box
                if (customInputContainer) {
                    customInputContainer.classList.remove('hidden');
                    const textarea = customInputContainer.querySelector('textarea');
                    if (textarea) {
                        textarea.focus();
                        // Clear the selection state temporarily until user types
                        unifiedRatingState.wsllSelections[metricName] = '';
                    }
                }
                if (displayBox) {
                    displayBox.classList.add('hidden');
                }
            } else if (value === '') {
                // No selection - hide both
                if (customInputContainer) {
                    customInputContainer.classList.add('hidden');
                    const textarea = customInputContainer.querySelector('textarea');
                    if (textarea) textarea.value = '';
                }
                if (displayBox) {
                    displayBox.classList.add('hidden');
                }
                setMetricWSLLSelection(metricName, value);
            } else {
                // Standard selection - show display box, hide custom textarea
                if (customInputContainer) {
                    customInputContainer.classList.add('hidden');
                    const textarea = customInputContainer.querySelector('textarea');
                    if (textarea) textarea.value = '';
                }
                if (displayBox) {
                    const displayText = displayBox.querySelector('p');
                    if (displayText) {
                        displayText.textContent = value;
                    }
                    displayBox.classList.remove('hidden');
                }
                setMetricWSLLSelection(metricName, value);
            }
            updateSelectionCount();
        }

        // Set metric WSLL for selection phase dropdowns
        function setMetricWSLLSelection(metricName, wsllValue) {
            console.log('Setting WSLL for', metricName, 'to:', wsllValue);
            unifiedRatingState.wsllSelections[metricName] = wsllValue;
            // Also update the ratings object
            if (unifiedRatingState.ratings[metricName]) {
                unifiedRatingState.ratings[metricName].wsll = wsllValue;
            }
            // Update the selection count display
            updateSelectionCount();
        }

        // Navigation buttons

        // Show completion phase


        // Update star display
        function updateStarDisplay(selector, score) {
            document.querySelectorAll(selector).forEach((star, index) => {
                star.classList.toggle('text-yellow-400', index < score);
                star.classList.toggle('text-slate-300', index >= score);
            });
        }

        // Calculate final score

        // Cancel unified rating
        function cancelUnifiedRating() {
            document.getElementById('perf-unified-rating').classList.add('hidden');
            document.getElementById('perf-dashboard').classList.remove('hidden');
            // Reset state?
            unifiedRatingState = {
                memberIdx: null,
                month: null,
                selectedMetrics: [],
                currentMetricIndex: 0,
                ratings: {},
                wsllSelections: {},
                allow4thMetric: false,
                valuesScore: 0,
                attendanceScore: 0,
                valuesNotes: '',
                attendanceNotes: ''
            };
        }

        // Save unified rating
        function saveUnifiedRating() {
            const member = appData.team[unifiedRatingState.memberIdx];
            if (!member) return;

            // Remove any existing unified entry for this month
            member.history = member.history.filter(h =>
                !(h.month === unifiedRatingState.month && h.isUnifiedEntry)
            );

            // Create new unified entry
            const unifiedEntry = {
                month: unifiedRatingState.month,
                isUnifiedEntry: true,
                metrics: unifiedRatingState.selectedMetrics.map(metricName => {
                    const rating = unifiedRatingState.ratings[metricName] || { score: 0, wsll: null, notes: '' };
                    const metric = PERF_CORE_METRICS.find(m => m.name === metricName);
                    return {
                        name: metricName,
                        definition: metric.definition,
                        score: rating.score,
                        wsll: rating.wsll,
                        notes: rating.notes // Saved here
                    };
                }),
                finalScore: parseFloat(document.getElementById('final-score-display').textContent),
                allow4thMetric: unifiedRatingState.allow4thMetric,
                valuesScore: unifiedRatingState.valuesScore,
                attendanceScore: unifiedRatingState.attendanceScore,
                valuesNotes: unifiedRatingState.valuesNotes || '',
                attendanceNotes: unifiedRatingState.attendanceNotes || '',
                engagementLevel: unifiedRatingState.engagementLevel || '',
                createdAt: new Date().toISOString()
            };

            member.history.push(unifiedEntry);
            saveData();

            // Return to dashboard (bypass switchPerformanceView to avoid conflicts)
            ['perf-dashboard', 'perf-studio', 'perf-details', 'perf-unified-rating'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            document.getElementById('perf-dashboard').classList.remove('hidden');
            renderPerformanceDashboard();

            // Show success message
            showNotification('Performance rating saved successfully!', 'success');
        }

        // Cancel unified rating
        function cancelUnifiedRating() {
            if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                // Directly switch to dashboard (bypass switchPerformanceView to avoid conflicts)
                ['perf-dashboard', 'perf-studio', 'perf-details', 'perf-unified-rating'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                document.getElementById('perf-dashboard').classList.remove('hidden');
            }
        }

        // Clear monthly rating
        function clearMonthlyRating(memberIdx, month) {
            if (!confirm(`Are you sure you want to clear the performance rating for ${appData.team[memberIdx].name} in ${month}? This action cannot be undone.`)) {
                return;
            }

            const member = appData.team[memberIdx];
            if (!member) return;

            // Remove unified entry for this month
            member.history = member.history.filter(h =>
                !(h.month === month && h.isUnifiedEntry)
            );

            saveData();
            renderPerformanceDashboard();

            showNotification('Performance rating cleared successfully!', 'success');
        }

        // Helper function to get previous month
        function getPreviousMonth(monthStr) {
            if (!monthStr) return null;
            const [month, year] = monthStr.split(" '");
            const monthMap = { "Jan": 0, "Feb": 1, "Mar": 2, "Apr": 3, "May": 4, "Jun": 5, "Jul": 6, "Aug": 7, "Sep": 8, "Oct": 9, "Nov": 10, "Dec": 11 };
            const date = new Date(2000 + parseInt(year), monthMap[month] - 1, 1);
            const prevMonth = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][date.getMonth()];
            const prevYear = date.getFullYear().toString().slice(-2);
            return `${prevMonth} '${prevYear}`;
        }

        /* --- CAPACITY PLANNING LOGIC --- */
        let capacityDate = new Date();

        /* --- NEW STATE --- */
        let capacitySelection = [];

        function changeCapacityMonth(offset) {
            capacityDate.setMonth(capacityDate.getMonth() + offset);
            renderCapacityView();
        }

        function renderCapacityView() {
            const grid = document.getElementById('capacityGrid');
            if (!grid) return;

            // Update Header
            document.getElementById('capacityMonthDisplay').textContent = capacityDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            grid.innerHTML = '';

            const year = capacityDate.getFullYear();
            const month = capacityDate.getMonth();

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Previous Month Padding (Dark mode background fix)
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="bg-slate-50 dark:bg-slate-900/50 min-h-[100px] pointer-events-none border-r border-b border-slate-100 dark:border-slate-800/50"></div>`;
            }

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isSelected = capacitySelection.includes(dateStr);

                // 1. Get Events
                const events = (appData.capacity || []).filter(e => dateStr >= e.startDate && dateStr <= e.endDate);
                const captoEvents = (appData.capto || []).filter(e => dateStr >= e.startDate && dateStr <= e.endDate);

                // 2. Calculate Risk (CAPTO events don't affect capacity risk)
                const accountCounts = {};
                events.forEach(e => {
                    const tm = appData.team.find(t => t.id == e.tmId);
                    if (tm && tm.account) {
                        accountCounts[tm.account] = (accountCounts[tm.account] || 0) + 1;
                    }
                });

                // Dark Mode Logic: Use dark: modifiers
                let riskLevel = 'bg-white dark:bg-slate-800';
                let riskBorder = 'border-transparent';

                // Visual Logic: Selection overrides Risk colors for the background
                if (isSelected) {
                    riskLevel = 'bg-blue-50 dark:bg-blue-900/30 ring-2 ring-inset ring-blue-500';
                } else {
                    Object.values(accountCounts).forEach(count => {
                        if (count === 2) {
                            // Amber risk: Light yellow in light mode, subtle amber tint in dark mode
                            riskLevel = 'bg-amber-50 dark:bg-amber-900/20';
                            riskBorder = 'border-amber-300 dark:border-amber-600';
                        }
                        if (count >= 3) {
                            // Red risk: Light red in light mode, subtle red tint in dark mode
                            riskLevel = 'bg-red-50 dark:bg-red-900/20';
                            riskBorder = 'border-red-300 dark:border-red-600';
                        }
                    });
                }

                // 3. Render Cell
                let eventsHtml = '';

                // Regular capacity events (team member level)
                events.forEach(e => {
                    const tm = appData.team.find(t => t.id == e.tmId);
                    // if (!tm) return;

                    // Dark Mode Pills: Darker background, lighter text, darker border
                    let color = 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300';

                    if (e.type === 'PTO')
                        color = 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/40 dark:text-purple-200 dark:border-purple-800';

                    if (e.type === 'Absent')
                        color = 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/40 dark:text-red-200 dark:border-red-800';

                    if (e.type === 'Request')
                        color = 'bg-blue-50 text-blue-600 border-blue-200 border-dashed dark:bg-blue-900/30 dark:text-blue-200 dark:border-blue-800';

                    // Stop propagation to prevent selecting the date when clicking an event
                    eventsHtml += `
            <div onclick="event.stopPropagation(); openCapacityModal('${e.id}')" class="text-[10px] px-1.5 py-0.5 rounded border mb-1 truncate cursor-pointer hover:opacity-80 font-bold transition-opacity ${color}">
                ${tm ? tm.name : 'Unknown'}
            </div>`;
                });

                // CAPTO events (account level)
                captoEvents.forEach(e => {
                    const accountColor = getAccountColor(e.account);

                    // Stop propagation to prevent selecting the date when clicking an event
                    eventsHtml += `
            <div onclick="event.stopPropagation(); openCaptoModal('${e.id}')" class="text-[10px] px-1.5 py-0.5 rounded border mb-1 truncate cursor-pointer hover:opacity-80 font-bold transition-opacity ${accountColor} flex items-center gap-1">
                <span class="text-[8px]"></span>
                <span class="truncate">${e.account}</span>
            </div>`;
                });

                // Day Number Styling
                const dayNumberClass = isSelected
                    ? 'bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center'
                    : 'text-slate-400 dark:text-slate-500';

                // Add border-right/bottom for grid definition in dark mode
                const cellBorder = 'border-r border-b border-slate-100 dark:border-slate-700/50';

                grid.innerHTML += `
        <div onclick="toggleCapacityDate('${dateStr}')" class="${riskLevel} ${cellBorder} min-h-[100px] p-2 border-t-4 ${riskBorder} hover:bg-slate-50 dark:hover:bg-slate-700 transition-all cursor-pointer relative select-none">
            <div class="text-xs font-bold mb-2 ${dayNumberClass}">${d}</div>
            <div class="space-y-1">${eventsHtml}</div>
        </div>`;
            }

            // 4. Render Floating Action Bar if selection exists
            renderCapacityFab();
        }

        /* --- SELECTION LOGIC --- */
        function toggleCapacityDate(dateStr) {
            if (capacitySelection.includes(dateStr)) {
                capacitySelection = capacitySelection.filter(d => d !== dateStr);
            } else {
                capacitySelection.push(dateStr);
            }
            renderCapacityView();
        }

        function renderCapacityFab() {
            let fab = document.getElementById('capacityFab');

            // Create if doesn't exist
            if (!fab) {
                fab = document.createElement('div');
                fab.id = 'capacityFab';
                fab.className = "fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-4 transition-all duration-300 translate-y-20 opacity-0";
                document.body.appendChild(fab);
            }

            if (capacitySelection.length > 0) {
                fab.innerHTML = `
            <span class="font-bold text-sm">${capacitySelection.length} days selected</span>
            <div class="h-4 w-px bg-slate-600"></div>
            <button onclick="openBatchCapacityModal()" class="text-sm font-bold text-blue-300 hover:text-white transition-colors">Log Request</button>
            <button onclick="capacitySelection=[]; renderCapacityView()" class="ml-2 text-slate-500 hover:text-slate-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
        `;
                fab.classList.remove('translate-y-20', 'opacity-0');
            } else {
                fab.classList.add('translate-y-20', 'opacity-0');
            }
        }

        function openCapacityModal(eventId = null) {
            const form = document.getElementById('capacityModal').querySelector('form');
            form.reset();
            document.getElementById('capEventId').value = '';

            // Reset fuzzy search fields
            document.getElementById('capTmSearch').value = '';
            document.getElementById('capTmSelect').value = '';
            document.getElementById('capTmDropdownList').classList.add('hidden');

            document.getElementById('btnDeleteCap').classList.add('hidden');

            if (eventId && typeof eventId === 'string') {
                const e = appData.capacity.find(x => x.id === eventId);
                if (e) {
                    document.getElementById('capEventId').value = e.id;

                    // Set fuzzy search fields for existing event
                    const tm = appData.team.find(t => t.id === e.tmId);
                    if (tm) {
                        document.getElementById('capTmSearch').value = tm.name;
                        document.getElementById('capTmSelect').value = tm.id;
                    }

                    document.getElementById('capType').value = e.type;
                    document.getElementById('capStatus').value = e.status;
                    document.getElementById('capStart').value = e.startDate;
                    document.getElementById('capEnd').value = e.endDate;
                    document.getElementById('btnDeleteCap').classList.remove('hidden');
                }
            }

            toggleModal('capacityModal');
        }

        /* --- BATCH MODAL LOGIC --- */
        function openBatchCapacityModal() {
            const form = document.getElementById('capacityModal').querySelector('form');
            form.reset();
            document.getElementById('capEventId').value = ''; // Ensure no ID for batch

            // Reset fuzzy search fields
            document.getElementById('capTmSearch').value = '';
            document.getElementById('capTmSelect').value = '';
            document.getElementById('capTmDropdownList').classList.add('hidden');

            document.getElementById('btnDeleteCap').classList.add('hidden');

            // Populate TM Select
            const sel = document.getElementById('capTmSelect');
            sel.innerHTML = '<option value="">Select Member...</option>';
            appData.team.filter(t => t.active).sort((a, b) => a.name.localeCompare(b.name)).forEach(tm => {
                sel.innerHTML += `<option value="${tm.id}">${tm.name}</option>`;
            });

            // Special UI for Batch Mode: Hide Date Inputs, Show Summary
            // We assume the modal HTML structure has the date inputs in a specific container
            // Let's modify the values to be hidden effectively

            const startInput = document.getElementById('capStart');
            const endInput = document.getElementById('capEnd');

            // For batch mode, we just fill the first date as a placeholder for validation
            // But the save logic will ignore these if selection array is present
            if (capacitySelection.length > 0) {
                startInput.value = capacitySelection[0];
                endInput.value = capacitySelection[0];

                // Visual trick: Show a toast or update modal title to indicate batch
                const title = document.querySelector('#capacityModal h3');
                if (title) title.innerText = `Log for ${capacitySelection.length} Selected Days`;
            }

            toggleModal('capacityModal');
        }

        function saveCapacityEvent(e) {
            e.preventDefault();

            // Validate team member selection
            const tmId = document.getElementById('capTmSelect').value;
            if (!tmId) {
                showToast('Please select a Team Member from the list.', 'error');
                return;
            }

            const id = document.getElementById('capEventId').value;
            const type = document.getElementById('capType').value;
            const status = document.getElementById('capStatus').value;

            // CASE A: Batch Save (Multiple Dates Selected)
            if (!id && capacitySelection.length > 0) {
                if (!appData.capacity) appData.capacity = [];

                capacitySelection.forEach(dateStr => {
                    appData.capacity.push({
                        id: 'cap_' + Date.now() + Math.random().toString(36).substr(2, 5),
                        tmId: tmId,
                        type: type,
                        status: status,
                        startDate: dateStr,
                        endDate: dateStr // Single day entry per selection
                    });
                });

                capacitySelection = []; // Clear selection
            }
            // CASE B: Standard Single Entry / Edit
            else {
                const data = {
                    id: id || 'cap_' + Date.now(),
                    tmId: tmId,
                    type: type,
                    status: status,
                    startDate: document.getElementById('capStart').value,
                    endDate: document.getElementById('capEnd').value
                };

                if (!appData.capacity) appData.capacity = [];

                if (id) {
                    const idx = appData.capacity.findIndex(x => x.id === id);
                    if (idx > -1) appData.capacity[idx] = data;
                } else {
                    appData.capacity.push(data);
                }
            }

            saveData();
            toggleModal('capacityModal');

            // Reset Modal Title
            setTimeout(() => {
                const title = document.querySelector('#capacityModal h3');
                if (title) title.innerText = 'Log Leave / Absence';
            }, 300);

            renderCapacityView();
            showToast('Capacity updated', 'success');
        }

        function deleteCapacityEvent() {
            const id = document.getElementById('capEventId').value;
            if (confirm('Delete this event?')) {
                appData.capacity = appData.capacity.filter(x => x.id !== id);
                saveData();
                toggleModal('capacityModal');
                renderCapacityView();
            }
        }

        /* --- INTEGRATION: LOGBOOK TO CALENDAR --- */
        function addToCapacityFromLog(logId) {
            const log = appData.logbook.find(l => l.id === logId);
            if (!log) return;

            openCapacityModal(); // Init empty

            // Pre-fill
            document.getElementById('capTmSelect').value = log.tmId;
            document.getElementById('capType').value = 'Request';

            // Smart Date: Use DueDate if exists, else Date Created
            const d = log.dueDate || log.date;
            document.getElementById('capStart').value = d;
            document.getElementById('capEnd').value = d;
        }

        /* --- CAPTO FUNCTIONS --- */
        function openCaptoModal(eventId = null) {
            // Reset form
            document.getElementById('captoEventId').value = '';
            document.getElementById('captoAccountSearch').value = '';
            document.getElementById('captoAccountSelect').value = '';
            document.getElementById('btnDeleteCapto').classList.add('hidden');

            // Clear dates
            clearCaptoDate(null, 'captoStart');
            clearCaptoDate(null, 'captoEnd');

            if (eventId) {
                // Edit existing event
                const e = appData.capto.find(x => x.id === eventId);
                if (e) {
                    document.getElementById('captoEventId').value = e.id;
                    document.getElementById('captoAccountSearch').value = e.account;
                    document.getElementById('captoAccountSelect').value = e.account;
                    document.getElementById('captoStart').value = e.startDate;
                    document.getElementById('captoEnd').value = e.endDate;

                    // Update UI
                    updateCaptoDateDisplay('captoStart', e.startDate);
                    updateCaptoDateDisplay('captoEnd', e.endDate);

                    document.getElementById('btnDeleteCapto').classList.remove('hidden');
                }
            }

            toggleModal('captoModal');
            if (!eventId) {
                // Focus search for new entries
                setTimeout(() => document.getElementById('captoAccountSearch').focus(), 100);
            }
        }

        function renderCaptoDropdown() {
            const search = document.getElementById('captoAccountSearch').value.toLowerCase();
            const list = document.getElementById('captoAccountDropdownList');
            const accounts = [...new Set(appData.team.map(t => t.account).filter(a => a))].sort();

            if (!search) {
                list.classList.add('hidden');
                return;
            }

            const filtered = accounts.filter(acc => acc.toLowerCase().includes(search));
            list.innerHTML = filtered.map(acc => `
                <div onclick="selectCaptoAccount('${acc}')" class="px-3 py-2 hover:bg-green-50 cursor-pointer border-b border-slate-100 last:border-b-0">
                    <div class="flex items-center gap-2">
                        <div class="${getAccountColor(acc)} px-2 py-1 rounded text-xs font-bold">${acc}</div>
                    </div>
                </div>
            `).join('');

            list.classList.remove('hidden');
        }

        function selectCaptoAccount(account) {
            document.getElementById('captoAccountSearch').value = account;
            document.getElementById('captoAccountSelect').value = account;
            document.getElementById('captoAccountDropdownList').classList.add('hidden');
        }

        function saveCaptoEvent(e) {
            e.preventDefault();

            const id = document.getElementById('captoEventId').value || 'capto_' + Date.now();
            const account = document.getElementById('captoAccountSelect').value;
            const startDate = document.getElementById('captoStart').value;
            const endDate = document.getElementById('captoEnd').value;

            if (!account || !startDate || !endDate) {
                showToast('Please fill all fields', 'error');
                return;
            }

            const data = {
                id,
                account,
                startDate,
                endDate,
                type: 'CAPTO',
                created: Date.now()
            };

            if (!appData.capto) appData.capto = [];

            const idx = appData.capto.findIndex(x => x.id === id);
            if (idx > -1) {
                appData.capto[idx] = data;
            } else {
                appData.capto.push(data);
            }

            saveData();
            toggleModal('captoModal');
            renderCapacityView();
            showToast('CAPTO event saved successfully!', 'success');
        }

        function deleteCaptoEvent() {
            const id = document.getElementById('captoEventId').value;
            if (!id) return;

            if (!confirm('Are you sure you want to delete this CAPTO event?')) return;

            appData.capto = appData.capto.filter(x => x.id !== id);
            saveData();
            toggleModal('captoModal');
            renderCapacityView();
            showToast('CAPTO event deleted!', 'success');
        }

        function clearCaptoDate(e, field) {
            if (e) e.stopPropagation();
            document.getElementById(field).value = '';
            updateCaptoDateDisplay(field, '');
        }

        function updateCaptoDateDisplay(field, dateStr) {
            const emptyDiv = document.getElementById(field + 'Empty');
            const filledDiv = document.getElementById(field + 'Filled');
            const textSpan = document.getElementById(field + 'Text');

            if (dateStr) {
                emptyDiv.classList.add('hidden');
                filledDiv.classList.remove('hidden');
                textSpan.textContent = new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            } else {
                emptyDiv.classList.remove('hidden');
                filledDiv.classList.add('hidden');
                textSpan.textContent = '';
            }
        }

        /* --- INTEGRATION: ROLL CALL TO CALENDAR --- */
        function syncRollCallToCapacity(tmId, status) {
            if (!['absent', 'pto'].includes(status)) return; // Only track time off

            const today = getTodayShort();
            if (!appData.capacity) appData.capacity = [];

            // Check if entry already exists for today to avoid dupes
            const existing = appData.capacity.find(e => e.tmId == tmId && e.startDate === today && e.endDate === today);

            if (!existing) {
                appData.capacity.push({
                    id: 'cap_rc_' + Date.now(),
                    tmId: tmId,
                    type: status === 'pto' ? 'PTO' : 'Absent',
                    status: 'Approved', // Auto-approve daily logs
                    startDate: today,
                    endDate: today
                });
            }
        }
    </script>

    <div id="helpModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-[90] flex items-center justify-center">
        <!-- Backdrop with stronger blur for focus -->
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-md transition-opacity duration-300"
            onclick="toggleModal('helpModal')"></div>

        <!-- Modal Container with refined shadows and ring -->
        <div
            class="modal-container bg-white dark:bg-slate-800 w-11/12 md:max-w-5xl mx-auto rounded-3xl shadow-2xl shadow-slate-900/20 dark:shadow-slate-900/50 ring-1 ring-black/5 dark:ring-slate-700/50 z-50 overflow-hidden flex flex-col max-h-[90vh] animate-in fade-in zoom-in-95 duration-300 transform transition-all">

            <!-- Header: Clean, ample whitespace -->
            <div class="bg-white dark:bg-slate-800 px-10 py-8 flex justify-between items-start relative z-10">
                <div>
                    <div class="flex items-center gap-4 mb-2">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-hub-600 to-hub-700 rounded-xl flex items-center justify-center text-white shadow-lg shadow-hub-500/30 ring-2 ring-hub-50 dark:ring-hub-900/30">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h2 class="text-3xl font-bold text-slate-900 dark:text-slate-100 tracking-tight">Leadership OS
                            <span class="text-slate-400 dark:text-slate-500 font-light">Guide</span>
                        </h2>
                    </div>
                    <p class="text-base text-slate-500 dark:text-slate-400 font-medium pl-14 leading-relaxed">Your
                        offline operational
                        command center.</p>
                </div>
                <button onclick="toggleModal('helpModal')"
                    class="group p-2 rounded-full hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <div
                        class="w-8 h-8 flex items-center justify-center rounded-full border border-slate-200 dark:border-slate-700 text-slate-400 dark:text-slate-500 group-hover:border-slate-300 dark:group-hover:border-slate-600 group-hover:text-slate-600 dark:group-hover:text-slate-300 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </div>
                </button>
            </div>

            <!-- Content: Scrollable area -->
            <div class="px-10 pb-10 overflow-y-auto flex-1 bg-white dark:bg-slate-800 scrollbar-hide">

                <!-- Modules Grid -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <!-- Module 1 Card -->
                    <div
                        class="relative group rounded-3xl p-6 border border-indigo-100 dark:border-indigo-900/30 bg-gradient-to-br from-indigo-50/80 dark:from-indigo-950/40 via-indigo-50/40 dark:via-indigo-950/20 to-white dark:to-slate-800 shadow-[0_8px_30px_rgb(0,0,0,0.04)] dark:shadow-[0_8px_30px_rgb(0,0,0,0.3)] hover:shadow-[0_8px_30px_rgb(99,102,241,0.1)] dark:hover:shadow-[0_8px_30px_rgb(99,102,241,0.2)] transition-all duration-500">
                        <div
                            class="absolute top-0 right-0 p-6 opacity-5 dark:opacity-10 group-hover:opacity-10 dark:group-hover:opacity-20 transition-opacity duration-500">
                            <svg class="w-32 h-32 text-indigo-600 dark:text-indigo-400" fill="currentColor"
                                viewBox="0 0 24 24">
                                <path d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-3 mb-3">
                                <span
                                    class="text-[11px] font-bold uppercase tracking-widest text-indigo-600 dark:text-indigo-400 bg-white dark:bg-slate-800 px-3 py-1 rounded-full shadow-sm ring-1 ring-indigo-100 dark:ring-indigo-900/50">Module
                                    1</span>
                                <h3 class="font-bold text-slate-900 dark:text-slate-100 text-xl tracking-tight">
                                    ActionHub</h3>
                            </div>
                            <p
                                class="text-xs text-indigo-900/70 dark:text-indigo-300/70 font-medium mb-4 border-b border-indigo-100/50 dark:border-indigo-900/30 pb-3">
                                Tasks, Execution & Strategy Management</p>
                            <ul class="space-y-2.5">
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Mailbox:</strong>
                                        Inbox & communication.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
                                        <path
                                            d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                                        <path d="m9 14 2 2 4-4" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">My Desk:</strong>
                                        Your personal task manager.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M10 22V7a1 1 0 0 0-1-1H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-5a1 1 0 0 0-1-1H2" />
                                        <rect x="14" y="2" width="8" height="8" rx="1" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Projects:</strong>
                                        Kanban board & tracking.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Pipeline:</strong>
                                        Track evaluations.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Logbook:</strong>
                                        Document incidents & kudos.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <path
                                            d="M11 6a13 13 0 0 0 8.4-2.8A1 1 0 0 1 21 4v12a1 1 0 0 1-1.6.8A13 13 0 0 0 11 14H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z" />
                                        <path d="M6 14a12 12 0 0 0 2.4 7.2 2 2 0 0 0 3.2-2.4A8 8 0 0 1 10 14" />
                                        <path d="M8 6v8" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Broadcasts:</strong>
                                        Team announcements.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 2v20M2 12h20" />
                                        <path d="M2 12l10-10 10 10-10 10-10-10" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Performance:</strong>
                                        Strategy & Ratings.</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Module 2 Card -->
                    <div
                        class="relative group rounded-3xl p-6 border border-sky-100 dark:border-sky-900/30 bg-gradient-to-br from-sky-50/80 dark:from-sky-950/40 via-sky-50/40 dark:via-sky-950/20 to-white dark:to-slate-800 shadow-[0_8px_30px_rgb(0,0,0,0.04)] dark:shadow-[0_8px_30px_rgb(0,0,0,0.3)] hover:shadow-[0_8px_30px_rgb(14,165,233,0.1)] dark:hover:shadow-[0_8px_30px_rgb(14,165,233,0.2)] transition-all duration-500">
                        <div
                            class="absolute top-0 right-0 p-6 opacity-5 dark:opacity-10 group-hover:opacity-10 dark:group-hover:opacity-20 transition-opacity duration-500">
                            <svg class="w-32 h-32 text-sky-600 dark:text-sky-400" fill="currentColor"
                                viewBox="0 0 24 24">
                                <path
                                    d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                            </svg>
                        </div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-3 mb-3">
                                <span
                                    class="text-[11px] font-bold uppercase tracking-widest text-sky-600 dark:text-sky-400 bg-white dark:bg-slate-800 px-3 py-1 rounded-full shadow-sm ring-1 ring-sky-100 dark:ring-sky-900/50">Module
                                    2</span>
                                <h3 class="font-bold text-slate-900 dark:text-slate-100 text-xl tracking-tight">
                                    PulseCheck</h3>
                            </div>
                            <p
                                class="text-xs text-sky-900/70 dark:text-sky-300/70 font-medium mb-4 border-b border-sky-100/50 dark:border-sky-900/30 pb-3">
                                People,
                                Data & Attendance Tracking</p>
                            <ul class="space-y-2.5">
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                        <circle cx="9" cy="7" r="4" />
                                        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Team Info:</strong>
                                        Roster & POCs.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0">
                                        <path
                                            d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5" />
                                        <path d="M3.22 13H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Monthly
                                            Pulse:</strong> Sentiment & EWS.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Timesheets:</strong>
                                        Submission checklist.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Roll Call:</strong>
                                        Daily attendance.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Reliability:</strong>
                                        Performance tracking.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Capacity:</strong>
                                        Leave & risk planner.</span>
                                </li>
                                <li
                                    class="flex items-start gap-3 text-xs text-slate-600 dark:text-slate-300 group/item">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-4 w-4 text-slate-500 dark:text-slate-400 mt-0.5 flex-shrink-0"
                                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                    </svg>
                                    <span class="py-0.5"><strong
                                            class="text-slate-900 dark:text-slate-100 font-semibold">Quick
                                            Links:</strong> Fast access shortcuts.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Shortcuts Section -->
                <div class="relative mb-6">
                    <div class="absolute inset-0 flex items-center" aria-hidden="true">
                        <div class="w-full border-t border-slate-100 dark:border-slate-700"></div>
                    </div>
                    <div class="relative flex justify-center mb-6">
                        <span
                            class="bg-white dark:bg-slate-800 px-4 text-xs font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest">Power
                            User Shortcuts</span>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <!-- Shortcut 1: Alt + C -->
                    <div
                        class="group border border-slate-100 dark:border-slate-700 rounded-2xl p-4 flex items-start gap-3 hover:border-indigo-100 dark:hover:border-indigo-900/50 hover:shadow-lg hover:shadow-indigo-500/5 dark:hover:shadow-indigo-500/10 hover:-translate-y-1 transition-all duration-300 bg-gradient-to-b from-white dark:from-slate-800 to-slate-50/30 dark:to-slate-800/50 cursor-default">
                        <div
                            class="bg-slate-100 dark:bg-slate-700 p-2 rounded-xl text-slate-600 dark:text-slate-300 group-hover:bg-indigo-600 dark:group-hover:bg-indigo-600 group-hover:text-white transition-colors duration-300 shadow-sm flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                        </div>
                        <div>
                            <p
                                class="font-bold text-slate-900 dark:text-slate-100 text-xs mb-1 group-hover:text-indigo-700 dark:group-hover:text-indigo-400 transition-colors">
                                Alt + C</p>
                            <p
                                class="text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed group-hover:text-slate-600 dark:group-hover:text-slate-300">
                                <strong class="text-slate-700 dark:text-slate-200">Quick Capture.</strong> Instantly
                                save a task or log without leaving your screen.
                            </p>
                        </div>
                    </div>
                    <!-- Shortcut 2: Ctrl + K -->
                    <div
                        class="group border border-slate-100 dark:border-slate-700 rounded-2xl p-4 flex items-start gap-3 hover:border-indigo-100 dark:hover:border-indigo-900/50 hover:shadow-lg hover:shadow-indigo-500/5 dark:hover:shadow-indigo-500/10 hover:-translate-y-1 transition-all duration-300 bg-gradient-to-b from-white dark:from-slate-800 to-slate-50/30 dark:to-slate-800/50 cursor-default">
                        <div
                            class="bg-slate-100 dark:bg-slate-700 p-2 rounded-xl text-slate-600 dark:text-slate-300 group-hover:bg-indigo-600 dark:group-hover:bg-indigo-600 group-hover:text-white transition-colors duration-300 shadow-sm flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <div>
                            <p
                                class="font-bold text-slate-900 dark:text-slate-100 text-xs mb-1 group-hover:text-indigo-700 dark:group-hover:text-indigo-400 transition-colors">
                                Ctrl + K</p>
                            <p
                                class="text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed group-hover:text-slate-600 dark:group-hover:text-slate-300">
                                <strong class="text-slate-700 dark:text-slate-200">Command Palette.</strong> Jump to any
                                view or search for a team member.
                            </p>
                        </div>
                    </div>
                    <!-- Shortcut 3: Alt + D -->
                    <div
                        class="group border border-slate-100 dark:border-slate-700 rounded-2xl p-4 flex items-start gap-3 hover:border-indigo-100 dark:hover:border-indigo-900/50 hover:shadow-lg hover:shadow-indigo-500/5 dark:hover:shadow-indigo-500/10 hover:-translate-y-1 transition-all duration-300 bg-gradient-to-b from-white dark:from-slate-800 to-slate-50/30 dark:to-slate-800/50 cursor-default">
                        <div
                            class="bg-slate-100 dark:bg-slate-700 p-2 rounded-xl text-slate-600 dark:text-slate-300 group-hover:bg-indigo-600 dark:group-hover:bg-indigo-600 group-hover:text-white transition-colors duration-300 shadow-sm flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                        </div>
                        <div>
                            <p
                                class="font-bold text-slate-900 dark:text-slate-100 text-xs mb-1 group-hover:text-indigo-700 dark:group-hover:text-indigo-400 transition-colors">
                                Alt + D</p>
                            <p
                                class="text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed group-hover:text-slate-600 dark:group-hover:text-slate-300">
                                <strong class="text-slate-700 dark:text-slate-200">Dark/Light Theme.</strong> Toggle
                                between dark and light mode.
                            </p>
                        </div>
                    </div>
                    <!-- Shortcut 4: Alt + N -->
                    <div
                        class="group border border-slate-100 dark:border-slate-700 rounded-2xl p-4 flex items-start gap-3 hover:border-indigo-100 dark:hover:border-indigo-900/50 hover:shadow-lg hover:shadow-indigo-500/5 dark:hover:shadow-indigo-500/10 hover:-translate-y-1 transition-all duration-300 bg-gradient-to-b from-white dark:from-slate-800 to-slate-50/30 dark:to-slate-800/50 cursor-default">
                        <div
                            class="bg-slate-100 dark:bg-slate-700 p-2 rounded-xl text-slate-600 dark:text-slate-300 group-hover:bg-indigo-600 dark:group-hover:bg-indigo-600 group-hover:text-white transition-colors duration-300 shadow-sm flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </div>
                        <div>
                            <p
                                class="font-bold text-slate-900 dark:text-slate-100 text-xs mb-1 group-hover:text-indigo-700 dark:group-hover:text-indigo-400 transition-colors">
                                Alt + N</p>
                            <p
                                class="text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed group-hover:text-slate-600 dark:group-hover:text-slate-300">
                                <strong class="text-slate-700 dark:text-slate-200">Brain Dump.</strong> Open notepad for
                                quick notes.
                            </p>
                        </div>
                    </div>
                    <!-- Shortcut 5: Alt + E -->
                    <div
                        class="group border border-slate-100 dark:border-slate-700 rounded-2xl p-4 flex items-start gap-3 hover:border-indigo-100 dark:hover:border-indigo-900/50 hover:shadow-lg hover:shadow-indigo-500/5 dark:hover:shadow-indigo-500/10 hover:-translate-y-1 transition-all duration-300 bg-gradient-to-b from-white dark:from-slate-800 to-slate-50/30 dark:to-slate-800/50 cursor-default">
                        <div
                            class="bg-slate-100 dark:bg-slate-700 p-2 rounded-xl text-slate-600 dark:text-slate-300 group-hover:bg-indigo-600 dark:group-hover:bg-indigo-600 group-hover:text-white transition-colors duration-300 shadow-sm flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <div>
                            <p
                                class="font-bold text-slate-900 dark:text-slate-100 text-xs mb-1 group-hover:text-indigo-700 dark:group-hover:text-indigo-400 transition-colors">
                                Alt + E</p>
                            <p
                                class="text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed group-hover:text-slate-600 dark:group-hover:text-slate-300">
                                <strong class="text-slate-700 dark:text-slate-200">Email Drafter.</strong> Compose and
                                draft emails quickly.
                            </p>
                        </div>
                    </div>
                    <!-- Shortcut 6: Local Data -->
                    <div
                        class="group border border-slate-100 dark:border-slate-700 rounded-2xl p-4 flex items-start gap-3 hover:border-orange-100 dark:hover:border-orange-900/50 hover:shadow-lg hover:shadow-orange-500/5 dark:hover:shadow-orange-500/10 hover:-translate-y-1 transition-all duration-300 bg-gradient-to-b from-white dark:from-slate-800 to-slate-50/30 dark:to-slate-800/50 cursor-default">
                        <div
                            class="bg-orange-50 dark:bg-orange-900/30 p-2 rounded-xl text-orange-500 dark:text-orange-400 group-hover:bg-orange-500 dark:group-hover:bg-orange-600 group-hover:text-white transition-colors duration-300 shadow-sm flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </div>
                        <div>
                            <p
                                class="font-bold text-slate-900 dark:text-slate-100 text-xs mb-1 group-hover:text-orange-700 dark:group-hover:text-orange-400 transition-colors">
                                Local Data</p>
                            <p
                                class="text-[11px] text-slate-500 dark:text-slate-400 leading-relaxed group-hover:text-slate-600 dark:group-hover:text-slate-300">
                                Data lives in <strong class="text-slate-700 dark:text-slate-200">this browser</strong>.
                                It is offline. Export backups every Friday!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer: Subtle and clean -->
            <div
                class="bg-slate-50/80 dark:bg-slate-800/80 backdrop-blur px-10 py-6 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <p class="text-xs text-slate-400 dark:text-slate-500 font-medium flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-400 dark:bg-green-500"></span>
                    Version 2.5  Developed by Cloy Caballo
                </p>
                <button onclick="toggleModal('helpModal')"
                    class="bg-slate-900 dark:bg-slate-700 hover:bg-slate-800 dark:hover:bg-slate-600 text-white text-sm font-bold py-3 px-8 rounded-xl shadow-xl shadow-slate-900/10 dark:shadow-slate-900/30 transition-all transform hover:-translate-y-0.5 hover:shadow-slate-900/20 dark:hover:shadow-slate-900/40 ring-1 ring-slate-900/5 dark:ring-slate-600/30">
                    Got it, let's work
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- PREMIUM CALENDAR OVERLAY -->
    <!-- ========================================== -->
    <div id="premiumCalendar"
        class="hidden fixed z-[100] bg-white rounded-2xl shadow-2xl border border-slate-100 p-4 w-72 select-none font-sans animate-in fade-in zoom-in-95 duration-200">
        <!-- Header -->
        <div class="flex justify-between items-center mb-4 px-1">
            <button onclick="changePremiumMonth(-1)"
                class="p-1.5 rounded-full text-slate-400 hover:text-hub-600 hover:bg-slate-50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <span id="premCalTitle" class="text-slate-800 font-bold text-base tracking-tight">October 2025</span>
            <button onclick="changePremiumMonth(1)"
                class="p-1.5 rounded-full text-slate-400 hover:text-hub-600 hover:bg-slate-50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

        <!-- Date Mode Toggle (only for myDeskDueDate) -->
        <div id="premCalModeToggle" class="hidden mb-3 flex items-center justify-center gap-2">
            <button id="premCalSingleBtn" onclick="setPremiumCalendarMode('single')"
                class="px-3 py-1.5 text-xs font-bold rounded-lg transition-colors bg-hub-600 text-white shadow-sm">
                Single Date
            </button>
            <button id="premCalRangeBtn" onclick="setPremiumCalendarMode('range')"
                class="px-3 py-1.5 text-xs font-bold rounded-lg transition-colors text-slate-600 hover:bg-slate-100">
                Range Date
            </button>
        </div>

        <!-- Grid -->
        <div class="grid grid-cols-7 gap-1 mb-2 text-center">
            <!-- Weekday Headers -->
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider py-1">Mon</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider py-1">Tue</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider py-1">Wed</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider py-1">Thu</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider py-1">Fri</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider py-1">Sat</div>
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider py-1">Sun</div>
        </div>
        <div id="premCalGrid" class="grid grid-cols-7 gap-1 text-center">
            <!-- Days injected via JS -->
        </div>

        <!-- Footer Actions -->
        <div class="flex justify-between items-center border-t border-slate-100 pt-3 mt-2">
            <div class="flex gap-2">
                <button onclick="selectQuickDate('today')"
                    class="text-xs font-bold text-slate-500 hover:text-hub-600 hover:bg-slate-50 px-2 py-1 rounded transition-colors">Today</button>
                <button onclick="selectQuickDate('tomorrow')"
                    class="text-xs font-bold text-slate-500 hover:text-hub-600 hover:bg-slate-50 px-2 py-1 rounded transition-colors">Tomorrow</button>
                <button onclick="selectQuickDate('nextWeek')"
                    class="text-xs font-bold text-slate-500 hover:text-hub-600 hover:bg-slate-50 px-2 py-1 rounded transition-colors">Next
                    Mon</button>
            </div>
            <!-- Confirm Range Button (only visible when both dates selected in range mode) -->
            <button id="premCalConfirmRange" onclick="confirmPremiumRange()"
                class="hidden text-xs font-bold text-white bg-hub-600 hover:bg-hub-700 px-3 py-1 rounded transition-colors shadow-sm">
                Confirm Range
            </button>
        </div>
    </div>

    <script>
        // --- PREMIUM CALENDAR LOGIC ---
        let premCalCurrentDate = new Date();
        let premCalTargetInputId = null;
        let premCalDateMode = 'single'; // 'single' or 'range'
        let premCalRangeStart = null; // YYYY-MM-DD
        let premCalRangeEnd = null; // YYYY-MM-DD

        function openPremiumCalendar(e, inputId) {
            e.preventDefault();
            e.stopPropagation(); // Stop bubbling
            premCalTargetInputId = inputId;

            const input = document.getElementById(inputId);
            const cal = document.getElementById('premiumCalendar');
            const toggleContainer = document.getElementById('premCalModeToggle');
            const confirmBtn = document.getElementById('premCalConfirmRange');

            // Show/hide toggle based on input type (only for myDeskDueDate, broadcastDueDate, newProjDue, and task date inputs)
            if (inputId === 'myDeskDueDate' || inputId === 'broadcastDueDate' || inputId === 'newProjDue' || (inputId && inputId.startsWith('task-'))) {
                toggleContainer.classList.remove('hidden');
                // Initialize mode based on existing range data
                const rangeStart = input.getAttribute('data-range-start');
                const rangeEnd = input.getAttribute('data-range-end');
                if (rangeStart && rangeEnd && rangeStart !== rangeEnd) {
                    premCalDateMode = 'range';
                    premCalRangeStart = rangeStart;
                    premCalRangeEnd = rangeEnd;
                } else {
                    premCalDateMode = 'single';
                    premCalRangeStart = null;
                    premCalRangeEnd = null;
                }
                updatePremiumCalendarModeButtons();
            } else {
                toggleContainer.classList.add('hidden');
                premCalDateMode = 'single';
                premCalRangeStart = null;
                premCalRangeEnd = null;
            }

            // Hide confirm button initially
            if (confirmBtn) {
                confirmBtn.classList.add('hidden');
            }

            // Set current date based on input value
            if (input.value) {
                // Parse YYYY-MM-DD correctly (fix timezone offset)
                const parts = input.value.split('-');
                premCalCurrentDate = new Date(parts[0], parts[1] - 1, parts[2]);
            } else {
                premCalCurrentDate = new Date();
            }

            renderPremiumCalendar();
            updateRangeConfirmButton(); // Check if confirm button should be shown

            // Position Logic
            const rect = input.getBoundingClientRect();
            // Default: Bottom Left aligned
            let top = rect.bottom + window.scrollY + 8;
            let left = rect.left + window.scrollX;

            // Check overflow right
            if (left + 300 > window.innerWidth) {
                left = (rect.right + window.scrollX) - 288; // Align right edge (w-72 is approx 288px)
            }
            // Check overflow bottom
            if (top + 350 > window.innerHeight + window.scrollY) {
                top = rect.top + window.scrollY - 360; // Flip to top
            }

            cal.style.top = `${top}px`;
            cal.style.left = `${left}px`;
            cal.classList.remove('hidden');

            // Click Outside Listener
            document.addEventListener('click', closePremiumCalendarOutside);
        }

        function closePremiumCalendarOutside(e) {
            const cal = document.getElementById('premiumCalendar');
            const targetInput = document.getElementById(premCalTargetInputId);

            // If click is NOT inside calendar AND NOT on the input trigger
            if (!cal.contains(e.target) && e.target !== targetInput) {
                // If in range mode with both dates selected, confirm the range
                const isRangeInput = premCalTargetInputId === 'myDeskDueDate' || premCalTargetInputId === 'broadcastDueDate' || premCalTargetInputId === 'newProjDue' || (premCalTargetInputId && premCalTargetInputId.startsWith('task-'));
                if (isRangeInput && premCalDateMode === 'range' && premCalRangeStart && premCalRangeEnd) {
                    const input = document.getElementById(premCalTargetInputId);
                    if (input) {
                        input.value = premCalRangeEnd;
                        input.setAttribute('data-range-start', premCalRangeStart);
                        input.setAttribute('data-range-end', premCalRangeEnd);

                        // Handle task date inputs
                        if (premCalTargetInputId && premCalTargetInputId.startsWith('task-')) {
                            const taskId = input.getAttribute('data-task-id');
                            if (taskId && currentPlannerId) {
                                const p = appData.projects.find(x => x.id === currentPlannerId);
                                const t = p.tasks.find(x => x.id === taskId);
                                if (t) {
                                    t.dueDateStart = premCalRangeStart;
                                    t.dueDateEnd = premCalRangeEnd;
                                    // Clear legacy fields
                                    t.startDate = '';
                                    t.dueDate = '';
                                    saveData();
                                }
                            }
                            updateTaskDateDisplay(input);
                            // Also update the other task date input if it exists
                            const otherInputId = premCalTargetInputId.includes('task-detail-date') ? `task-date-${taskId}` : `task-detail-date-${taskId}`;
                            const otherInput = document.getElementById(otherInputId);
                            if (otherInput) {
                                otherInput.value = input.value;
                                otherInput.setAttribute('data-range-start', premCalRangeStart);
                                otherInput.setAttribute('data-range-end', premCalRangeEnd);
                                updateTaskDateDisplay(otherInput);
                            }
                        } else if (premCalTargetInputId === 'myDeskDueDate') {
                            updateMyDeskDateDisplay(input);
                        } else if (premCalTargetInputId === 'broadcastDueDate') {
                            updateBroadcastDateDisplay(input);
                        } else if (premCalTargetInputId === 'newProjDue') {
                            updateProjectDateDisplay(input);
                        }
                    }
                }

                cal.classList.add('hidden');
                document.removeEventListener('click', closePremiumCalendarOutside);
            }
        }

        function changePremiumMonth(offset) {
            premCalCurrentDate.setMonth(premCalCurrentDate.getMonth() + offset);
            renderPremiumCalendar();
        }

        function setPremiumCalendarMode(mode) {
            premCalDateMode = mode;
            // Clear partial range selection when switching modes
            premCalRangeStart = null;
            premCalRangeEnd = null;
            updatePremiumCalendarModeButtons();
            updateRangeConfirmButton(); // Hide confirm button when switching modes
            renderPremiumCalendar();
        }

        function updatePremiumCalendarModeButtons() {
            const singleBtn = document.getElementById('premCalSingleBtn');
            const rangeBtn = document.getElementById('premCalRangeBtn');
            if (premCalDateMode === 'single') {
                singleBtn.classList.add('bg-hub-600', 'text-white', 'shadow-sm');
                singleBtn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                rangeBtn.classList.remove('bg-hub-600', 'text-white', 'shadow-sm');
                rangeBtn.classList.add('text-slate-600', 'hover:bg-slate-100');
            } else {
                rangeBtn.classList.add('bg-hub-600', 'text-white', 'shadow-sm');
                rangeBtn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                singleBtn.classList.remove('bg-hub-600', 'text-white', 'shadow-sm');
                singleBtn.classList.add('text-slate-600', 'hover:bg-slate-100');
            }
        }

        function renderPremiumCalendar() {
            const grid = document.getElementById('premCalGrid');
            const title = document.getElementById('premCalTitle');
            grid.innerHTML = '';

            const year = premCalCurrentDate.getFullYear();
            const month = premCalCurrentDate.getMonth();

            title.textContent = premCalCurrentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // First day of month
            const firstDay = new Date(year, month, 1);
            // Adjust for Monday start (0=Sun, 1=Mon...)
            let startDay = firstDay.getDay() - 1;
            if (startDay === -1) startDay = 6; // Sunday becomes 6

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            // Empty slots
            for (let i = 0; i < startDay; i++) {
                grid.innerHTML += `<div></div>`;
            }

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                let classes = "h-8 w-8 flex items-center justify-center rounded-full text-sm font-medium cursor-pointer transition-all mx-auto premium-cal-day ";

                // Check if date is in range (for range mode)
                let isInRange = false;
                let isRangeStart = false;
                let isRangeEnd = false;

                if (premCalDateMode === 'range' && premCalRangeStart) {
                    const startDate = new Date(premCalRangeStart + 'T12:00:00');
                    const currentDate = new Date(dateStr + 'T12:00:00');
                    isRangeStart = dateStr === premCalRangeStart;

                    if (premCalRangeEnd) {
                        // Both dates selected
                        const endDate = new Date(premCalRangeEnd + 'T12:00:00');
                        isRangeEnd = dateStr === premCalRangeEnd;
                        isInRange = currentDate >= startDate && currentDate <= endDate;
                    } else {
                        // Only start selected - highlight start date only
                        isInRange = false;
                    }
                }

                // Range mode styling
                if (premCalDateMode === 'range') {
                    if (isRangeStart) {
                        classes += "bg-hub-600 text-white shadow-md shadow-hub-200 font-bold";
                    } else if (isRangeEnd) {
                        classes += "bg-hub-600 text-white shadow-md shadow-hub-200 font-bold";
                    } else if (isInRange) {
                        classes += "bg-hub-100 text-hub-700 hover:bg-hub-200";
                    } else if (dateObj.toDateString() === today.toDateString()) {
                        classes += "text-hub-600 font-bold bg-hub-50 hover:bg-hub-100";
                    } else {
                        const dayOfWeek = dateObj.getDay();
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            classes += "text-slate-500 bg-slate-200 hover:bg-slate-300 hover:text-slate-900";
                        } else {
                            classes += "text-slate-600 hover:bg-slate-100 hover:text-slate-900";
                        }
                    }
                } else {
                    // Single date mode (existing logic)
                    const inputVal = document.getElementById(premCalTargetInputId)?.value;
                    if (inputVal === dateStr) {
                        classes += "bg-hub-600 text-white shadow-md shadow-hub-200";
                    } else if (dateObj.toDateString() === today.toDateString()) {
                        classes += "text-hub-600 font-bold bg-hub-50 hover:bg-hub-100";
                    } else {
                        const dayOfWeek = dateObj.getDay();
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            classes += "text-slate-500 bg-slate-200 hover:bg-slate-300 hover:text-slate-900";
                        } else {
                            classes += "text-slate-600 hover:bg-slate-100 hover:text-slate-900";
                        }
                    }
                }

                grid.innerHTML += `<div onclick="selectPremiumDate('${dateStr}', event)" class="${classes}">${d}</div>`;
            }
        }

        function selectPremiumDate(dateStr, event) {
            // Prevent event propagation to avoid closing calendar prematurely
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            const input = document.getElementById(premCalTargetInputId);
            if (!input) return;

            // Skip global task date picker inputs (they have their own logic)
            if (premCalTargetInputId === 'global-start-input' || premCalTargetInputId === 'global-due-input') {
                const formatted = formatDateWithYear(dateStr);
                input.value = formatted;
                input.setAttribute('data-date-value', dateStr);
                document.getElementById('premiumCalendar').classList.add('hidden');
                document.removeEventListener('click', closePremiumCalendarOutside);
                return;
            }

            // Skip capacity and capto inputs (they have their own logic)
            if (premCalTargetInputId === 'capStart' || premCalTargetInputId === 'capEnd' || premCalTargetInputId === 'captoStart' || premCalTargetInputId === 'captoEnd') {
                if (premCalTargetInputId === 'capStart') updateCapacityDateDisplay(input);
                if (premCalTargetInputId === 'capEnd') updateCapacityDateDisplay(input);
                if (premCalTargetInputId === 'captoStart') updateCaptoDateDisplay('captoStart', dateStr);
                if (premCalTargetInputId === 'captoEnd') updateCaptoDateDisplay('captoEnd', dateStr);
                input.value = dateStr;
                document.getElementById('premiumCalendar').classList.add('hidden');
                document.removeEventListener('click', closePremiumCalendarOutside);
                return;
            }

            // Handle range mode for myDeskDueDate, broadcastDueDate, newProjDue, and task date inputs
            if (premCalDateMode === 'range' && (premCalTargetInputId === 'myDeskDueDate' || premCalTargetInputId === 'broadcastDueDate' || premCalTargetInputId === 'newProjDue' || (premCalTargetInputId && premCalTargetInputId.startsWith('task-')))) {
                if (!premCalRangeStart) {
                    // First click: Set start date
                    premCalRangeStart = dateStr;
                    premCalRangeEnd = null;
                } else if (!premCalRangeEnd) {
                    // Second click: Set end date
                    const startDate = new Date(premCalRangeStart + 'T12:00:00');
                    const clickedDate = new Date(dateStr + 'T12:00:00');

                    if (clickedDate < startDate) {
                        // If clicking before start, reset and set new start
                        premCalRangeStart = dateStr;
                        premCalRangeEnd = null;
                    } else {
                        // Set end date
                        premCalRangeEnd = dateStr;
                    }
                } else {
                    // Both dates selected, reset and start new range
                    premCalRangeStart = dateStr;
                    premCalRangeEnd = null;
                }
                // Re-render to show updated range and update confirm button visibility
                renderPremiumCalendar();
                updateRangeConfirmButton();
                return;
            }

            // Single date mode - set the date and close calendar
            input.value = dateStr;
            input.removeAttribute('data-range-start');
            input.removeAttribute('data-range-end');

            // Handle task date inputs
            if (premCalTargetInputId && premCalTargetInputId.startsWith('task-')) {
                const taskId = input.getAttribute('data-task-id');
                if (taskId && currentPlannerId) {
                    const p = appData.projects.find(x => x.id === currentPlannerId);
                    const t = p.tasks.find(x => x.id === taskId);
                    if (t) {
                        t.dueDateStart = dateStr;
                        t.dueDateEnd = dateStr;
                        // Clear legacy fields
                        t.startDate = '';
                        t.dueDate = '';
                        saveData();
                    }
                }
                updateTaskDateDisplay(input);
                // Also update the other task date input if it exists (main or detail)
                const otherInputId = premCalTargetInputId.includes('task-detail-date') ? `task-date-${taskId}` : `task-detail-date-${taskId}`;
                const otherInput = document.getElementById(otherInputId);
                if (otherInput) {
                    otherInput.value = input.value;
                    if (input.getAttribute('data-range-start')) {
                        otherInput.setAttribute('data-range-start', input.getAttribute('data-range-start'));
                        otherInput.setAttribute('data-range-end', input.getAttribute('data-range-end'));
                    } else {
                        otherInput.removeAttribute('data-range-start');
                        otherInput.removeAttribute('data-range-end');
                    }
                    updateTaskDateDisplay(otherInput);
                }
            } else {
                // Trigger Updates for other inputs
                if (premCalTargetInputId === 'myDeskDueDate' || premCalTargetInputId.includes('myDesk')) {
                    updateMyDeskDateDisplay(input);
                }
                if (premCalTargetInputId === 'logbookDate' || premCalTargetInputId === 'logbookDueDate' || premCalTargetInputId.includes('logbook')) {
                    updateLogbookDateDisplay(input);
                }
                if (premCalTargetInputId === 'broadcastDueDate' || premCalTargetInputId.includes('broadcast')) {
                    updateBroadcastDateDisplay(input);
                }
                if (premCalTargetInputId === 'newProjDue' || premCalTargetInputId.includes('newProj')) {
                    updateProjectDateDisplay(input);
                }
            }

            document.getElementById('premiumCalendar').classList.add('hidden');
            document.removeEventListener('click', closePremiumCalendarOutside);
        }

        function confirmPremiumRange() {
            if (premCalDateMode === 'range' && premCalRangeStart && premCalRangeEnd) {
                const input = document.getElementById(premCalTargetInputId);
                if (!input) return;

                // Set input value to end date for display
                input.value = premCalRangeEnd;
                input.setAttribute('data-range-start', premCalRangeStart);
                input.setAttribute('data-range-end', premCalRangeEnd);

                // Handle task date inputs
                if (premCalTargetInputId && premCalTargetInputId.startsWith('task-')) {
                    const taskId = input.getAttribute('data-task-id');
                    if (taskId && currentPlannerId) {
                        const p = appData.projects.find(x => x.id === currentPlannerId);
                        const t = p.tasks.find(x => x.id === taskId);
                        if (t) {
                            t.dueDateStart = premCalRangeStart;
                            t.dueDateEnd = premCalRangeEnd;
                            // Clear legacy fields
                            t.startDate = '';
                            t.dueDate = '';
                            saveData();
                        }
                    }
                    updateTaskDateDisplay(input);
                    // Also update the other task date input if it exists (main or detail)
                    const otherInputId = premCalTargetInputId.includes('task-detail-date') ? `task-date-${taskId}` : `task-detail-date-${taskId}`;
                    const otherInput = document.getElementById(otherInputId);
                    if (otherInput) {
                        otherInput.value = input.value;
                        otherInput.setAttribute('data-range-start', premCalRangeStart);
                        otherInput.setAttribute('data-range-end', premCalRangeEnd);
                        updateTaskDateDisplay(otherInput);
                    }
                } else if (premCalTargetInputId === 'myDeskDueDate') {
                    updateMyDeskDateDisplay(input);
                } else if (premCalTargetInputId === 'broadcastDueDate') {
                    updateBroadcastDateDisplay(input);
                } else if (premCalTargetInputId === 'newProjDue') {
                    updateProjectDateDisplay(input);
                }

                // Close calendar
                document.getElementById('premiumCalendar').classList.add('hidden');
                document.removeEventListener('click', closePremiumCalendarOutside);
            }
        }

        function updateRangeConfirmButton() {
            const confirmBtn = document.getElementById('premCalConfirmRange');
            if (confirmBtn) {
                // Show confirm button only when both dates are selected in range mode
                const isRangeInput = premCalTargetInputId === 'myDeskDueDate' || premCalTargetInputId === 'broadcastDueDate' || premCalTargetInputId === 'newProjDue' || (premCalTargetInputId && premCalTargetInputId.startsWith('task-'));
                if (isRangeInput && premCalDateMode === 'range' && premCalRangeStart && premCalRangeEnd) {
                    confirmBtn.classList.remove('hidden');
                } else {
                    confirmBtn.classList.add('hidden');
                }
            }
        }

        function selectQuickDate(type) {
            const d = new Date();
            if (type === 'tomorrow') d.setDate(d.getDate() + 1);
            if (type === 'nextWeek') {
                d.setDate(d.getDate() + (1 + 7 - d.getDay()) % 7 || 7); // Next Monday
            }
            const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

            // In range mode, quick dates set the start date
            const isRangeInput = premCalTargetInputId === 'myDeskDueDate' || premCalTargetInputId === 'broadcastDueDate' || premCalTargetInputId === 'newProjDue' || (premCalTargetInputId && premCalTargetInputId.startsWith('task-'));
            if (isRangeInput && premCalDateMode === 'range') {
                premCalRangeStart = dateStr;
                premCalRangeEnd = null;
                renderPremiumCalendar();
            } else {
                selectPremiumDate(dateStr);
            }
        }

        // --- Capacity Date Helpers ---
        function updateCapacityDateDisplay(input) {
            const container = input.parentElement;
            if (!container) return;
            const id = input.id; // capStart or capEnd
            const emptyState = container.querySelector(`#${id}Empty`);
            const filledState = container.querySelector(`#${id}Filled`);
            const textSpan = container.querySelector(`#${id}Text`);

            if (input.value) {
                emptyState.classList.add('hidden');
                filledState.classList.remove('hidden');
                const d = new Date(input.value + 'T12:00:00');
                const m = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                textSpan.textContent = m;
            } else {
                emptyState.classList.remove('hidden');
                filledState.classList.add('hidden');
                textSpan.textContent = '';
            }
        }

        function clearCapacityDate(e, inputId) {
            e.stopPropagation();
            const input = document.getElementById(inputId);
            input.value = '';
            updateCapacityDateDisplay(input);
        }

        // ==========================================
        // CAPACITY TEAM MEMBER FUZZY SEARCH
        // ==========================================

        function renderCapacityDropdown() {
            const input = document.getElementById('capTmSearch');
            const list = document.getElementById('capTmDropdownList');
            const hiddenId = document.getElementById('capTmSelect');
            const query = input.value.toLowerCase();

            list.innerHTML = '';
            list.classList.remove('hidden');

            // Fuzzy Filter: Matches Name OR Account OR Role
            const matches = appData.team.filter(t =>
                t.active && (
                    t.name.toLowerCase().includes(query) ||
                    t.role.toLowerCase().includes(query) ||
                    (t.account && t.account.toLowerCase().includes(query))
                )
            ).slice(0, 10); // Limit to 10 results

            matches.forEach(tm => {
                const div = document.createElement('div');
                div.className = 'px-3 py-2 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0';
                div.innerHTML = `
                    <div class="font-medium text-slate-900">${tm.name}</div>
                    <div class="text-xs text-slate-500">${tm.role}  ${tm.account}</div>
                `;
                div.onclick = () => selectCapacityTm(tm.id, tm.name);
                list.appendChild(div);
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function closeDrop(e) {
                if (!input.contains(e.target) && !list.contains(e.target)) {
                    list.classList.add('hidden');
                    document.removeEventListener('click', closeDrop);
                }
            });
        }

        function selectCapacityTm(id, name) {
            document.getElementById('capTmSearch').value = name; // Show Name
            document.getElementById('capTmSelect').value = id;   // Store ID
            document.getElementById('capTmDropdownList').classList.add('hidden');
        }
    </script>



    <div id="quickLinkModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"
            onclick="toggleModal('quickLinkModal')"></div>
        <div
            class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800" id="quickLinkModalTitle">Add Quick Link</h3>
                <button onclick="toggleModal('quickLinkModal')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form onsubmit="event.preventDefault(); saveQuickLink();">
                <input type="hidden" id="quickLinkId">
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-slate-700 text-sm font-bold mb-2" for="quickLinkTitle">Title</label>
                        <input type="text" id="quickLinkTitle" class="vault-input" placeholder="e.g. Workday" required>
                    </div>
                    <div>
                        <label class="block text-slate-700 text-sm font-bold mb-2" for="quickLinkUrl">URL</label>
                        <input type="url" id="quickLinkUrl" class="vault-input" placeholder="https://..." required>
                    </div>
                    <div>
                        <label class="block text-slate-700 text-sm font-bold mb-2"
                            for="quickLinkCategory">Category</label>
                        <select id="quickLinkCategory" class="vault-input">
                            <option value="Tools">Tools</option>
                            <option value="HR">HR</option>
                            <option value="AI">AI</option>
                            <option value="Documents">Documents</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-slate-700 text-sm font-bold mb-2" for="quickLinkIcon">Custom Icon /
                            Emoji (Optional)</label>
                        <input type="text" id="quickLinkIcon" class="vault-input"
                            placeholder="e.g.  or custom-url.png">
                        <p class="text-xs text-slate-400 mt-1">Leave empty to auto-fetch the website logo.</p>
                    </div>
                    <div>
                        <label class="block text-slate-700 text-sm font-bold mb-2" for="quickLinkDesc">Description
                            (Optional)</label>
                        <input type="text" id="quickLinkDesc" class="vault-input" placeholder="Short description...">
                    </div>
                </div>
                <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-end gap-3">
                    <button type="button" id="btnDeleteQuickLink" onclick="deleteQuickLink()"
                        class="hidden px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 border border-red-200 rounded-lg font-medium text-sm transition-colors mr-auto">Delete</button>

                    <button type="button" onclick="toggleModal('quickLinkModal')"
                        class="px-4 py-2 bg-white border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 font-medium text-sm transition-colors">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-dcx-blue hover:bg-blue-700 text-white rounded-lg font-bold text-sm shadow-md transition-colors">Save
                        Link</button>
                </div>
            </form>
        </div>
    </div>

    <div id="capacityModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"
            onclick="toggleModal('capacityModal')"></div>
        <div
            class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50">
            <form onsubmit="saveCapacityEvent(event)">
                <input type="hidden" id="capEventId">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800">Log Leave / Absence</h3>
                        <button type="button" onclick="toggleModal('capacityModal')"
                            class="text-slate-400 hover:text-slate-600"></button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Team Member</label>
                            <div class="relative">
                                <input type="text" id="capTmSearch" oninput="renderCapacityDropdown()"
                                    onfocus="renderCapacityDropdown()" placeholder="Type name, role, or account..."
                                    class="w-full border border-slate-300 rounded-lg p-2.5 font-medium text-slate-700 focus:ring-2 focus:ring-dcx-blue"
                                    autocomplete="off" required>

                                <input type="hidden" id="capTmSelect">

                                <div id="capTmDropdownList"
                                    class="hidden absolute z-50 w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 max-h-48 overflow-y-auto">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Type</label>
                                <select id="capType"
                                    class="w-full border border-slate-300 rounded-lg p-2.5 font-medium text-slate-700">
                                    <option value="PTO"> PTO / Leave</option>
                                    <option value="Request"> Request (Pending)</option>
                                    <option value="Absent"> Absent / Sick</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Status</label>
                                <select id="capStatus"
                                    class="w-full border border-slate-300 rounded-lg p-2.5 font-medium text-slate-700">
                                    <option value="Approved">Approved</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label>
                                <div class="relative group w-full">
                                    <input type="text" id="capStart" required readonly
                                        class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                                        onclick="openPremiumCalendar(event, 'capStart')">

                                    <div id="capStartEmpty"
                                        class="flex items-center justify-center w-full py-2.5 px-3 rounded-lg border border-dashed border-slate-300 text-slate-400 bg-slate-50 group-hover:bg-white group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:hidden"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4 hidden group-hover:block text-hub-600" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 11v6m-3-3h6" />
                                            </svg>
                                            <span class="text-xs font-medium group-hover:text-hub-600">Start</span>
                                        </div>
                                    </div>

                                    <div id="capStartFilled"
                                        class="hidden flex items-center justify-between w-full py-2.5 px-3 rounded-lg border border-slate-200 bg-white shadow-sm">
                                        <div class="flex items-center gap-2 text-slate-700">
                                            <span id="capStartText" class="text-xs font-bold"></span>
                                        </div>
                                        <button type="button" onclick="clearCapacityDate(event, 'capStart')"
                                            class="relative z-40 text-slate-400 hover:text-red-500 p-0.5 rounded-full hover:bg-slate-100 transition-colors"><svg
                                                xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                                fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                    clip-rule="evenodd" />
                                            </svg></button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">End Date</label>
                                <div class="relative group w-full">
                                    <input type="text" id="capEnd" required readonly
                                        class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                                        onclick="openPremiumCalendar(event, 'capEnd')">

                                    <div id="capEndEmpty"
                                        class="flex items-center justify-center w-full py-2.5 px-3 rounded-lg border border-dashed border-slate-300 text-slate-400 bg-slate-50 group-hover:bg-white group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:hidden"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4 hidden group-hover:block text-hub-600" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 11v6m-3-3h6" />
                                            </svg>
                                            <span class="text-xs font-medium group-hover:text-hub-600">End</span>
                                        </div>
                                    </div>

                                    <div id="capEndFilled"
                                        class="hidden flex items-center justify-between w-full py-2.5 px-3 rounded-lg border border-slate-200 bg-white shadow-sm">
                                        <div class="flex items-center gap-2 text-slate-700">
                                            <span id="capEndText" class="text-xs font-bold"></span>
                                        </div>
                                        <button type="button" onclick="clearCapacityDate(event, 'capEnd')"
                                            class="relative z-40 text-slate-400 hover:text-red-500 p-0.5 rounded-full hover:bg-slate-100 transition-colors"><svg
                                                xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                                fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                    clip-rule="evenodd" />
                                            </svg></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button" onclick="deleteCapacityEvent()" id="btnDeleteCap"
                            class="text-red-500 hover:text-red-700 text-sm font-bold mr-auto hidden">Delete</button>
                        <button type="button" onclick="toggleModal('capacityModal')"
                            class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit"
                            class="bg-dcx-blue hover:bg-dcx-light text-white font-bold py-2 px-6 rounded-lg shadow-sm">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- CAPTO MODAL -->
    <div id="captoModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"
            onclick="toggleModal('captoModal')"></div>
        <div
            class="modal-container bg-white border border-slate-200 w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50">
            <form onsubmit="saveCaptoEvent(event)">
                <input type="hidden" id="captoEventId">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800">Log Client Approved PTO (CAPTO)</h3>
                        <button type="button" onclick="toggleModal('captoModal')"
                            class="text-slate-400 hover:text-slate-600"></button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Account</label>
                            <div class="relative">
                                <input type="text" id="captoAccountSearch" oninput="renderCaptoDropdown()"
                                    onfocus="renderCaptoDropdown()" placeholder="Type account name..."
                                    class="w-full border border-slate-300 rounded-lg p-2.5 font-medium text-slate-700 focus:ring-2 focus:ring-green-500"
                                    autocomplete="off" required>

                                <input type="hidden" id="captoAccountSelect">

                                <div id="captoAccountDropdownList"
                                    class="hidden absolute z-50 w-full bg-white border border-slate-200 rounded-lg shadow-xl mt-1 max-h-48 overflow-y-auto">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label>
                                <div class="relative group w-full">
                                    <input type="text" id="captoStart" required readonly
                                        class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                                        onclick="openPremiumCalendar(event, 'captoStart')">

                                    <div id="captoStartEmpty"
                                        class="flex items-center justify-center w-full py-2.5 px-3 rounded-lg border border-dashed border-slate-300 text-slate-400 bg-slate-50 group-hover:bg-white group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:hidden"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4 hidden group-hover:block text-green-600" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 11v6m-3-3h6" />
                                            </svg>
                                            <span class="text-xs font-medium group-hover:text-green-600">Start</span>
                                        </div>
                                    </div>

                                    <div id="captoStartFilled"
                                        class="hidden flex items-center justify-between w-full py-2.5 px-3 rounded-lg border border-slate-200 bg-white shadow-sm">
                                        <div class="flex items-center gap-2 text-slate-700">
                                            <span id="captoStartText" class="text-xs font-bold"></span>
                                        </div>
                                        <button type="button" onclick="clearCaptoDate(event, 'captoStart')"
                                            class="relative z-40 text-slate-400 hover:text-red-500 p-0.5 rounded-full hover:bg-slate-100 transition-colors"><svg
                                                xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                                fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                    clip-rule="evenodd" />
                                            </svg></button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">End Date</label>
                                <div class="relative group w-full">
                                    <input type="text" id="captoEnd" required readonly
                                        class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                                        onclick="openPremiumCalendar(event, 'captoEnd')">

                                    <div id="captoEndEmpty"
                                        class="flex items-center justify-center w-full py-2.5 px-3 rounded-lg border border-dashed border-slate-300 text-slate-400 bg-slate-50 group-hover:bg-white group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                                        <div class="flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 group-hover:hidden"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                class="h-4 w-4 hidden group-hover:block text-green-600" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 11v6m-3-3h6" />
                                            </svg>
                                            <span class="text-xs font-medium group-hover:text-green-600">End</span>
                                        </div>
                                    </div>

                                    <div id="captoEndFilled"
                                        class="hidden flex items-center justify-between w-full py-2.5 px-3 rounded-lg border border-slate-200 bg-white shadow-sm">
                                        <div class="flex items-center gap-2 text-slate-700">
                                            <span id="captoEndText" class="text-xs font-bold"></span>
                                        </div>
                                        <button type="button" onclick="clearCaptoDate(event, 'captoEnd')"
                                            class="relative z-40 text-slate-400 hover:text-red-500 p-0.5 rounded-full hover:bg-slate-100 transition-colors"><svg
                                                xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                                fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                    clip-rule="evenodd" />
                                            </svg></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-center gap-2 text-green-700">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                <span class="text-xs font-semibold">CAPTO Information</span>
                            </div>
                            <p class="text-xs text-green-600 mt-1">Client Approved PTO does not affect capacity risk
                                indicators (amber/red warnings).</p>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-8">
                        <button type="button" onclick="deleteCaptoEvent()" id="btnDeleteCapto"
                            class="text-red-500 hover:text-red-700 text-sm font-bold mr-auto hidden">Delete</button>
                        <button type="button" onclick="toggleModal('captoModal')"
                            class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-sm">Save
                            CAPTO</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" onclick="scrollToTop()"
        class="fixed bottom-8 left-1/2 transform -translate-x-1/2 px-5 py-2.5 bg-slate-900/95 backdrop-blur-md border border-slate-700/50 rounded-full shadow-lg flex items-center gap-2 text-sm font-semibold text-white hover:bg-slate-800 hover:shadow-xl hover:scale-105 active:scale-95 transition-all duration-300 opacity-0 pointer-events-none z-40"
        title="Back to top" aria-label="Scroll to top">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
        <span>Back to Top</span>
    </button>

    <!-- AI Assistant Panel -->
    <div id="aiAssistantModal"
        class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center transition-opacity duration-300">
        <div class="modal-overlay absolute inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity duration-300"
            onclick="closeAIAssistant()"></div>
        <div
            class="modal-container bg-white dark:bg-slate-900 w-full max-w-3xl max-h-[85vh] rounded-2xl shadow-2xl z-50 overflow-hidden flex flex-col transform transition-all duration-300 scale-95 opacity-0 mx-4">
            <!-- Header - macOS style -->
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-slate-200/50 dark:border-slate-700/50">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center shadow-sm">
                        <!-- Panda Icon for Modal -->
                        <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white">
                            <ellipse cx="120" cy="170" rx="70" ry="65" fill="#1e293b" transform="rotate(-20 120 170)" />
                            <ellipse cx="392" cy="170" rx="70" ry="65" fill="#1e293b" transform="rotate(20 392 170)" />
                            <ellipse cx="256" cy="280" rx="210" ry="180" fill="white" />
                            <ellipse cx="170" cy="280" rx="45" ry="60" fill="#1e293b" transform="rotate(-25 170 280)" />
                            <ellipse cx="342" cy="280" rx="45" ry="60" fill="#1e293b" transform="rotate(25 342 280)" />
                            <circle cx="185" cy="265" r="12" fill="white" />
                            <circle cx="327" cy="265" r="12" fill="white" />
                            <circle cx="130" cy="340" r="35" fill="#f472b6" opacity="0.8" />
                            <circle cx="382" cy="340" r="35" fill="#f472b6" opacity="0.8" />
                            <path d="M226 315 Q256 305 286 315 Q290 330 256 345 Q222 330 226 315 Z" fill="#1e293b" />
                            <path d="M256 345 Q230 380 200 355" fill="none" stroke="#1e293b" stroke-width="12"
                                stroke-linecap="round" />
                            <path d="M256 345 Q280 380 312 355" fill="none" stroke="#1e293b" stroke-width="12"
                                stroke-linecap="round" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-base font-semibold text-slate-900 dark:text-white">Garshu AI</h3>
                        <p id="aiInsightsSummary" class="text-xs text-slate-500 dark:text-slate-400">Ready to help</p>
                    </div>
                </div>

                <!-- Action buttons -->
                <div class="flex items-center gap-1">
                    <button onclick="minimizeAIAssistant()"
                        class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors group"
                        title="Minimize">
                        <svg class="w-4 h-4 text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
                        </svg>
                    </button>
                    <button onclick="closeAIAssistant()"
                        class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors group"
                        title="Close">
                        <svg class="w-4 h-4 text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Tab Navigation - Linear style -->
            <div class="flex gap-1 px-6 py-3 bg-slate-50/50 dark:bg-slate-900/50">
                <button onclick="switchAITab('insights')" data-tab="insights"
                    class="ai-tab-btn px-3 py-1.5 text-sm font-medium rounded-md transition-all bg-white dark:bg-slate-800 text-purple-600 dark:text-purple-400 shadow-sm whitespace-nowrap">
                    Insights
                </button>
                <button onclick="switchAITab('chat')" data-tab="chat"
                    class="ai-tab-btn px-3 py-1.5 text-sm font-medium rounded-md transition-all text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800/50 whitespace-nowrap">
                    Chat
                </button>
                <button onclick="switchAITab('notifications')" data-tab="notifications"
                    class="ai-tab-btn px-3 py-1.5 text-sm font-medium rounded-md transition-all text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800/50 whitespace-nowrap flex items-center gap-1">
                    Notifications
                    <span id="notifBadge"
                        class="ml-1 bg-purple-600 text-white text-xs rounded-full px-1.5 hidden">0</span>
                </button>
                <button onclick="switchAITab('settings')" data-tab="settings"
                    class="ai-tab-btn px-3 py-1.5 text-sm font-medium rounded-md transition-all text-slate-600 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800/50 whitespace-nowrap">
                    Settings
                </button>
            </div>

            <!-- Tab Contents -->
            <!-- Insights Tab -->
            <div id="aiTabInsights" class="ai-tab-content flex-1 overflow-y-auto p-6 space-y-4">
                <div id="aiInsightsContent">
                    <div class="text-center py-12 text-slate-400">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
                        <p class="text-sm">Analyzing your data...</p>
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="aiChatView" class="ai-tab-content hidden flex-1 flex flex-col">
                <div class="flex-1 overflow-y-auto p-6 space-y-4" id="aiChatContent">
                    <div class="text-center py-12 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="h-12 w-12 mx-auto mb-4 text-slate-300 dark:text-slate-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                        <p class="text-sm">Ask me anything about your team and data!</p>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900">
                    <div class="flex gap-2">
                        <input type="text" id="aiChatInput" placeholder="Ask a question..."
                            class="flex-1 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                            onkeydown="if(event.key === 'Enter') sendChatMessage()" />
                        <button onclick="sendChatMessage()"
                            class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div id="aiTabNotifications" class="ai-tab-content hidden flex-1 overflow-y-auto p-6">
                <div class="flex flex-col items-center justify-center h-full text-center space-y-4">
                    <div
                        class="w-20 h-20 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mb-2 animate-pulse">
                        <span class="text-4xl"></span>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-200">Garshu is watching...</h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 max-w-xs mx-auto">
                        No new proactive insights yet. Garshu will nudge you here when it detects focus drift or major
                        milestones!
                    </p>
                    <div class="pt-4">
                        <button onclick="switchAITab('settings')"
                            class="text-xs font-medium text-purple-600 dark:text-purple-400 hover:underline">
                            Check notification settings 
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="aiTabSettings" class="ai-tab-content hidden flex-1 overflow-y-auto p-6 space-y-6">
                <div>
                    <h4 class="text-sm font-bold text-slate-800 dark:text-slate-200 mb-3">Gemini API Configuration</h4>
                    <p class="text-xs text-slate-600 dark:text-slate-400 mb-3">
                        To use AI insights, you need a Google Gemini API key. Get one for free at
                        <a href="https://makersuite.google.com/app/apikey" target="_blank"
                            class="text-purple-600 hover:underline">Google AI Studio</a>.
                    </p>
                    <div
                        class="bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-4">
                        <div class="flex items-start gap-3 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600 flex-shrink-0 mt-0.5"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div>
                                <p class="text-xs font-semibold text-slate-700 dark:text-slate-300 mb-1">API Key is
                                    configured in main Settings</p>
                                <p class="text-xs text-slate-600 dark:text-slate-400">Garshu AI uses the same Gemini API
                                    key from your main application settings.</p>
                            </div>
                        </div>
                        <button onclick="closeAIAssistant(); toggleModal('settingsModal');"
                            class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Open Main Settings
                        </button>
                    </div>
                </div>


                <div class="pt-6 border-t border-slate-200 dark:border-slate-700">
                    <h4 class="text-sm font-bold text-slate-800 dark:text-slate-200 mb-3">Proactive Notifications</h4>
                    <div class="flex items-center justify-between p-4 bg-slate-100 dark:bg-slate-800 rounded-lg">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Enable Proactive Messages
                            </p>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                Allow Garshu to send you helpful nudges and insights automatically
                            </p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer ml-4">
                            <input type="checkbox" id="toggleProactiveAI" onchange="toggleProactiveAI(this.checked)"
                                class="sr-only peer" checked>
                            <div
                                class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-slate-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-purple-600">
                            </div>
                        </label>
                    </div>

                    <!-- Individual Trigger Controls (only shown when proactive is enabled) -->
                    <div id="triggerControls" class="mt-4 space-y-3">
                        <div class="flex items-center justify-between pl-4">
                            <div>
                                <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Morning Brief</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Daily summary before 10 AM</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleMorningBrief"
                                    onchange="toggleTrigger('morningBrief', this.checked)" class="sr-only peer" checked>
                                <div
                                    class="w-9 h-5 bg-slate-300 rounded-full peer peer-checked:bg-purple-500 peer-focus:ring-2 peer-focus:ring-purple-300 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4">
                                </div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between pl-4">
                            <div>
                                <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Drift Nudge</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Alerts when focus timer expires
                                </p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleDriftNudge"
                                    onchange="toggleTrigger('driftNudge', this.checked)" class="sr-only peer" checked>
                                <div
                                    class="w-9 h-5 bg-slate-300 rounded-full peer peer-checked:bg-purple-500 peer-focus:ring-2 peer-focus:ring-purple-300 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4">
                                </div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between pl-4">
                            <div>
                                <p class="text-sm font-medium text-slate-700 dark:text-slate-300">Victory Lap</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Celebrates task completions</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggleVictoryLap"
                                    onchange="toggleTrigger('victoryLap', this.checked)" class="sr-only peer" checked>
                                <div
                                    class="w-9 h-5 bg-slate-300 rounded-full peer peer-checked:bg-purple-500 peer-focus:ring-2 peer-focus:ring-purple-300 after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-4">
                                </div>
                            </label>
                        </div>
                    </div>
                </div>


                <div class="pt-6 border-t border-slate-200 dark:border-slate-700">
                    <h4 class="text-sm font-bold text-slate-800 dark:text-slate-200 mb-2">About Garshu AI </h4>
                    <p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">
                        Named after a beloved Shih Tzu, Garshu AI analyzes your team data, detects patterns,
                        reads sentiment from notes, and provides proactive insights you might miss.
                        Like a loyal companion, Garshu acts as your executive auditor and second brain,
                        helping you stay ahead of potential issues.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Minimized Pill (draggable) - Garshu AI -->
    <button id="aiMinimizedPill" onclick="handlePillClick(event)"
        class="fixed bottom-6 right-6 px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-full shadow-lg flex items-center gap-2 opacity-0 pointer-events-none transform translate-y-4 transition-all duration-300 hover:shadow-xl hover:scale-105 z-[90] cursor-move select-none"
        style="touch-action: none;">
        <!-- Panda Icon -->
        <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5">
            <ellipse cx="120" cy="170" rx="70" ry="65" fill="#1e293b" transform="rotate(-20 120 170)" />
            <ellipse cx="392" cy="170" rx="70" ry="65" fill="#1e293b" transform="rotate(20 392 170)" />
            <ellipse cx="256" cy="280" rx="210" ry="180" fill="white" />
            <ellipse cx="170" cy="280" rx="45" ry="60" fill="#1e293b" transform="rotate(-25 170 280)" />
            <ellipse cx="342" cy="280" rx="45" ry="60" fill="#1e293b" transform="rotate(25 342 280)" />
            <circle cx="185" cy="265" r="12" fill="white" />
            <circle cx="327" cy="265" r="12" fill="white" />
            <circle cx="130" cy="340" r="35" fill="#f472b6" opacity="0.8" />
            <circle cx="382" cy="340" r="35" fill="#f472b6" opacity="0.8" />
            <path d="M226 315 Q256 305 286 315 Q290 330 256 345 Q222 330 226 315 Z" fill="#1e293b" />
            <path d="M256 345 Q230 380 200 355" fill="none" stroke="#1e293b" stroke-width="12" stroke-linecap="round" />
            <path d="M256 345 Q280 380 312 355" fill="none" stroke="#1e293b" stroke-width="12" stroke-linecap="round" />
        </svg>
        <span class="text-sm font-medium">Garshu AI</span>
    </button>

    <!-- Email Drafter Modal -->
    <div id="emailDrafterModal"
        class="modal hidden opacity-0 pointer-events-none fixed inset-0 z-[80] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"
            onclick="toggleEmailDrafter()"></div>
        <div id="emailDrafterContent"
            class="modal-container bg-white border border-slate-200 w-full max-w-2xl mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden transform scale-95 transition-all duration-200">
            <div
                class="bg-gradient-to-r from-indigo-600 to-violet-600 p-4 border-b border-indigo-500 flex justify-between items-center">
                <h3 class="font-bold text-white flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    Email Drafter
                </h3>
                <button onclick="toggleEmailDrafter()"
                    class="text-indigo-100 hover:text-white transition-colors"></button>
            </div>

            <div class="p-6 bg-slate-50">
                <!-- Tone Selector -->
                <div class="flex items-center gap-3 mb-3">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Tone:</label>
                    <select id="emailDrafterTone"
                        class="text-xs font-medium text-slate-700 bg-white border border-slate-200 rounded-lg px-2 py-1 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                        <option value="Professional"> Professional (Default)</option>
                        <option value="Direct"> Direct & Concise</option>
                        <option value="Empathetic"> Empathetic</option>
                        <option value="Casual"> Casual</option>
                    </select>
                </div>

                <!-- Custom Guide Box -->
                <div class="mb-3">
                    <textarea id="emailDrafterGuide" 
                        oninput="localStorage.setItem('leadership_os_email_guide', this.value)"
                        class="w-full bg-indigo-50/30 border border-indigo-100/50 rounded-xl px-3 py-2 text-[11px] focus:outline-none focus:border-indigo-300 focus:ring-1 focus:ring-indigo-300 text-slate-600 h-16 resize-none placeholder-slate-400"
                        placeholder="Custom Guide (Optional): e.g. 'Keep it under 50 words' or 'Mention the deadline is Friday'. If empty, default style guide is used."></textarea>
                </div>

                <div class="bg-white p-1 rounded-xl border border-slate-200 shadow-sm relative group">
                    <button id="btnEmailDrafterAi" onclick="generateAiDraft('emailDrafterInput', 'btnEmailDrafterAi')"
                        class="absolute top-3 right-3 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 border border-indigo-200 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm transition-all flex items-center z-10">
                         AI Polish
                    </button>
                    <textarea id="emailDrafterInput"
                        class="w-full bg-transparent resize-none focus:outline-none text-slate-800 font-medium h-64 p-4 placeholder-slate-400"
                        placeholder="Type your raw thoughts or bullet points here...&#10;&#10;Example:&#10;- Need to reschedule meeting&#10;- Conflict with client call&#10;- Propose next Tuesday at 2pm"></textarea>

                    <div class="absolute bottom-3 right-3 flex gap-2">
                        <button id="btnEmailCopy" onclick="copyEmailDraft()"
                            class="bg-white hover:bg-slate-50 text-slate-600 font-bold py-1.5 px-3 rounded-lg shadow-sm border text-xs flex items-center transition-all active:scale-95">
                            Copy Text
                        </button>
                    </div>
                </div>

                <!-- Smart Templates -->
                <div class="mt-4 flex flex-wrap gap-2">
                    <button onclick="applyEmailTemplate('pto')"
                        class="px-3 py-1.5 bg-white border border-slate-200 hover:border-indigo-300 hover:text-indigo-600 text-slate-500 text-xs font-medium rounded-full transition-colors shadow-sm">
                         PTO Request
                    </button>
                    <button onclick="applyEmailTemplate('power')"
                        class="px-3 py-1.5 bg-white border border-slate-200 hover:border-indigo-300 hover:text-indigo-600 text-slate-500 text-xs font-medium rounded-full transition-colors shadow-sm">
                         Power Outage
                    </button>
                    <button onclick="applyEmailTemplate('internet')"
                        class="px-3 py-1.5 bg-white border border-slate-200 hover:border-indigo-300 hover:text-indigo-600 text-slate-500 text-xs font-medium rounded-full transition-colors shadow-sm">
                         Internet Issue
                    </button>
                    <button onclick="applyEmailTemplate('sick')"
                        class="px-3 py-1.5 bg-white border border-slate-200 hover:border-indigo-300 hover:text-indigo-600 text-slate-500 text-xs font-medium rounded-full transition-colors shadow-sm">
                         Sick Leave
                    </button>
                </div>
            </div>

            <p class="text-xs text-slate-400 mt-3 text-center">
                Pro Tip: Just type the raw facts. The AI will format it into a professional email.
            </p>
        </div>
    </div>
    </div>

    <script>
        function applyEmailTemplate(type) {
            const input = document.getElementById('emailDrafterInput');
            let text = "";

            if (type === 'pto') {
                text = "Team member: [Name]\nRequest: PTO for [Date]\nReason: [Reason]\nCoverage: [Who is covering?]";
            } else if (type === 'power') {
                text = "Team member: [Name]\nIssue: Power Outage\nStatus: Currently offline\nETA: [Time or Unknown]\nNext update: In 1 hour";
            } else if (type === 'internet') {
                text = "Team member: [Name]\nIssue: ISP Outage\nStatus: Intermittent connection\nTicket #: [If available]";
            } else if (type === 'sick') {
                text = "Team member: [Name]\nStatus: Out sick today\nSymptoms: [Optional]\nAvailability: Offline all day";
            }

            input.value = text;
            input.focus();
        }

        function copyEmailDraft() {
            const text = document.getElementById('emailDrafterInput').value;
            if (!text) return;

            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('btnEmailCopy');
                const originalText = btn.innerText;
                const originalClasses = btn.className;

                // Success State
                btn.innerHTML = "Copied! ";
                btn.className = "bg-green-50 text-green-600 border-green-200 font-bold py-1.5 px-3 rounded-lg shadow-sm border text-xs flex items-center transition-all transform scale-105";

                setTimeout(() => {
                    btn.innerHTML = "Copy Text";
                    btn.className = "bg-white hover:bg-slate-50 text-slate-600 font-bold py-1.5 px-3 rounded-lg shadow-sm border text-xs flex items-center transition-all active:scale-95";
                }, 2000);
            });
        }

        function toggleEmailDrafter() {
            const modal = document.getElementById('emailDrafterModal');
            const content = document.getElementById('emailDrafterContent');
            const input = document.getElementById('emailDrafterInput');
            const guide = document.getElementById('emailDrafterGuide');

            if (modal.classList.contains('hidden')) {
                // OPEN
                modal.classList.remove('hidden');

                // Load saved guide
                if (guide) {
                    guide.value = localStorage.getItem('leadership_os_email_guide') || "";
                }

                // Small delay to allow display:block to apply before opacity transition
                setTimeout(() => {
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                    input.focus();
                }, 10);
            } else {
                // CLOSE
                modal.classList.add('opacity-0', 'pointer-events-none');
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');

                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200);
            }
        }

        // ==========================================
        // BRAIN DUMP FEATURE
        // ==========================================
        function toggleBrainDumpPanel() {
            const panel = document.getElementById('brain-dump-panel');
            if (!panel) return;

            if (panel.classList.contains('open')) {
                // CLOSE
                panel.classList.remove('open');
            } else {
                // OPEN
                panel.classList.add('open');
                const textarea = document.getElementById('brain-dump-textarea');
                if (textarea) {
                    setTimeout(() => textarea.focus(), 100);
                }
            }
        }

        function saveBrainDumpContent() {
            const textarea = document.getElementById('brain-dump-textarea');
            if (!textarea) return;
            localStorage.setItem('leadership_os_braindump', textarea.value);

            // Show saved indicator
            const indicator = document.getElementById('brain-dump-saved-indicator');
            if (indicator) {
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        function loadBrainDumpContent() {
            const textarea = document.getElementById('brain-dump-textarea');
            if (!textarea) return;
            const saved = localStorage.getItem('leadership_os_braindump');
            if (saved) {
                textarea.value = saved;
            }
        }

        function clearBrainDump() {
            const textarea = document.getElementById('brain-dump-textarea');
            if (!textarea) return;

            if (confirm('Clear all brain dump content?')) {
                textarea.value = '';
                saveBrainDumpContent();
                textarea.focus();
            }
        }

        function convertSelectionToTask() {
            const textarea = document.getElementById('brain-dump-textarea');
            if (!textarea) return;

            const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();

            if (!selectedText) {
                const tip = document.getElementById('brain-dump-tip');
                if (tip) {
                    tip.textContent = 'Highlight text to convert.';
                    tip.classList.add('text-amber-500');
                    setTimeout(() => {
                        tip.textContent = 'Highlight text to convert.';
                        tip.classList.remove('text-amber-500');
                    }, 2000);
                }
                return;
            }

            // Create task with status 'OnTheTable' and due date today
            const today = new Date();
            const todayStr = today.getFullYear() + '-' +
                String(today.getMonth() + 1).padStart(2, '0') + '-' +
                String(today.getDate()).padStart(2, '0');

            const task = {
                id: 'desk_' + Date.now(),
                title: selectedText,
                category: 'Other',
                status: 'OnTheTable',
                notes: '',
                dueDate: todayStr
            };

            // Add to myDesk
            if (!appData.myDesk) appData.myDesk = [];
            appData.myDesk.push(task);
            saveData();

            // Remove selected text from textarea
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const currentValue = textarea.value;
            textarea.value = currentValue.substring(0, start) + currentValue.substring(end);

            // Update cursor position
            textarea.setSelectionRange(start, start);
            saveBrainDumpContent();

            // Refresh My Desk view if it's currently displayed
            if (typeof renderMyDesk === 'function') {
                renderMyDesk();
            }

            // Show success toast
            if (typeof showToast === 'function') {
                showToast('Task created in On The Table', 'success');
            }

            // Update tip
            const tip = document.getElementById('brain-dump-tip');
            if (tip) {
                tip.textContent = 'Task created! ';
                tip.classList.add('text-green-500');
                setTimeout(() => {
                    tip.textContent = 'Highlight text to convert.';
                    tip.classList.remove('text-green-500');
                }, 2000);
            }
        }

        // ==========================================
        // DRAGGABLE GARSHU PILL
        // ==========================================
        (function () {
            const pill = document.getElementById('aiMinimizedPill');
            let isDragging = false;
            let hasMoved = false;
            let startX, startY, initialX, initialY;

            // Load saved position from localStorage
            const savedPos = localStorage.getItem('garshuPillPosition');
            if (savedPos) {
                try {
                    const { bottom, left, right } = JSON.parse(savedPos);
                    pill.style.bottom = bottom;
                    pill.style.left = left || 'auto';
                    pill.style.right = right || 'auto';
                } catch (e) {
                    console.log('Error loading Garshu pill position');
                }
            }

            function onDragStart(e) {
                const rect = pill.getBoundingClientRect();

                // Get initial position
                if (e.type === 'mousedown') {
                    startX = e.clientX;
                    startY = e.clientY;
                } else if (e.type === 'touchstart') {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }

                initialX = rect.left;
                initialY = rect.top;

                isDragging = true;
                hasMoved = false;

                pill.style.transition = 'none';
                e.preventDefault();
            }

            function onDrag(e) {
                if (!isDragging) return;

                let currentX, currentY;
                if (e.type === 'mousemove') {
                    currentX = e.clientX;
                    currentY = e.clientY;
                } else if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                }

                const deltaX = currentX - startX;
                const deltaY = currentY - startY;

                // If moved more than 5px, consider it a drag
                if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                    hasMoved = true;
                }

                const newX = initialX + deltaX;
                const newY = initialY + deltaY;

                // Constrain to viewport
                const maxX = window.innerWidth - pill.offsetWidth;
                const maxY = window.innerHeight - pill.offsetHeight;

                const constrainedX = Math.max(0, Math.min(newX, maxX));
                const constrainedY = Math.max(0, Math.min(newY, maxY));

                pill.style.left = constrainedX + 'px';
                pill.style.right = 'auto';
                pill.style.top = constrainedY + 'px';
                pill.style.bottom = 'auto';
            }

            function onDragEnd() {
                if (!isDragging) return;
                isDragging = false;

                pill.style.transition = 'all 0.3s';

                // Save position to localStorage
                const bottom = pill.style.bottom;
                const top = pill.style.top;
                const left = pill.style.left;
                const right = pill.style.right;

                localStorage.setItem('garshuPillPosition', JSON.stringify({
                    bottom: bottom !== 'auto' ? bottom : (window.innerHeight - pill.getBoundingClientRect().bottom) + 'px',
                    left: left !== 'auto' ? left : 'auto',
                    right: right !== 'auto' ? right : 'auto'
                }));
            }

            // Mouse events
            pill.addEventListener('mousedown', onDragStart);
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', onDragEnd);

            // Touch events
            pill.addEventListener('touchstart', onDragStart, { passive: false });
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('touchend', onDragEnd);

            // Handle click vs drag
            window.handlePillClick = function (e) {
                if (!hasMoved) {
                    restoreAIAssistant();
                }
            };
        })();

        // --- AI LOGBOOK FEATURE (Gemini 2.5) ---
        async function fixLogTitlesWithAI() {
            // 1. CHECK API KEY
            const API_KEY = localStorage.getItem('leadershipOS_GeminiKey');
            if (!API_KEY) {
                showToast(" Missing Gemini API Key. Please add it in Settings.", "error");
                toggleModal('settingsModal');
                return;
            }

            // 2. GET FILTERS & VISIBLE DATA
            const search = document.getElementById('lbSearch').value.toLowerCase();
            const fTm = document.getElementById('lbFilterTm').value;
            const fType = document.getElementById('lbFilterType').value;
            const fStatus = document.getElementById('lbFilterStatus').value;

            let visibleLogs = appData.logbook.filter(e => {
                const tm = appData.team.find(t => t.id === e.tmId) || { name: '' };
                const matchesSearch = !search || e.title.toLowerCase().includes(search) || e.notes.toLowerCase().includes(search) || tm.name.toLowerCase().includes(search);
                const matchesTm = fTm === 'all' || e.tmId == fTm;

                let matchesType = true;
                if (fType === 'actionable') matchesType = (e.type === 'issue' || e.type === 'request');
                else if (fType !== 'all') matchesType = (e.type === fType);

                const currentStatus = e.status || 'Open';
                let matchesStatus = false;
                if (fStatus === 'all') matchesStatus = true;
                else if (fStatus === 'Open') matchesStatus = (currentStatus === 'Open' || currentStatus === 'NotUploaded');
                else if (fStatus === 'Closed') matchesStatus = (currentStatus === 'Closed' || currentStatus === 'Uploaded');
                else matchesStatus = (currentStatus === fStatus);

                return matchesSearch && matchesTm && matchesType && matchesStatus;
            });

            if (visibleLogs.length === 0) {
                showToast("No visible logs to process.", "info");
                return;
            }

            // 3. USER CONFIRMATION
            if (!confirm(`I found ${visibleLogs.length} visible entries.\n\nReady to rewrite their titles to be short and professional using Gemini 2.5?`)) return;

            // 4. UI LOADING STATE
            const btn = document.querySelector('button[onclick="fixLogTitlesWithAI()"]');
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin h-3.5 w-3.5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Processing...`;
            btn.disabled = true;

            try {
                // 5. PREPARE PAYLOAD
                const payload = visibleLogs.map(l => ({
                    id: l.id,
                    current_title: l.title,
                    context: l.notes || "No details provided"
                }));

                const prompt = `
                    You are a Data Standardization Engine. 
                    Refine these log titles to be concise (Max 6 words) and uniform.

                    STRICT STYLE RULES:
                     1. Use Sentence case (Capitalize the first letter only, unless it's a proper noun).
                     2. NO ending punctuation (Do not end with a period).
                     3. Remove special chars like ||, [], -- etc.
                     4. Maintain the original meaning using the provided 'context'.

                    OUTPUT FORMAT:
                    Return ONLY valid, parseable JSON. Do not include markdown formatting (like \`\`\`json). 
                    Structure: { "log_id": "New Clean Title" }

                    Data: ${JSON.stringify(payload)}
                `;

                // 6. CALL GEMINI API (UPDATED TO 2.5-FLASH)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                const data = await response.json();
                let text = data.candidates[0].content.parts[0].text;

                // Cleanup JSON string
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const improvements = JSON.parse(text);

                // 7. APPLY CHANGES
                let updateCount = 0;
                appData.logbook.forEach(log => {
                    if (improvements[log.id]) {
                        log.title = improvements[log.id];
                        updateCount++;
                    }
                });

                saveData();
                renderLogbook();
                showToast(` Successfully updated ${updateCount} titles!`, "success");

            } catch (err) {
                console.error(err);
                showToast(" AI Error: " + err.message, "error");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }


        // ==========================================
        // DRIFT DETECTION (Garshu Nudge)
        // ==========================================
        let driftInterval = null;
        let lastActiveTime = Date.now();

        // 1. Reset drift timer when user returns to tab
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                lastActiveTime = Date.now();
                // If focus is active, ensure check is running
                if (appData.focusTaskId && !appData.focusPaused) {
                    startDriftCheck();
                }
            }
        });

        // 2. Monitor for inactivity
        function startDriftCheck() {
            if (driftInterval) clearInterval(driftInterval);

            // Check every 1 minute
            driftInterval = setInterval(() => {
                // Only trigger if Focus is active AND not paused
                if (appData.focusTaskId && !appData.focusPaused) {
                    const now = Date.now();
                    const timeAway = now - lastActiveTime;
                    const DRIFT_LIMIT = 10 * 60 * 1000; // 10 Minutes

                    // If hidden AND away longer than limit
                    if (document.hidden && timeAway > DRIFT_LIMIT) {
                        const task = appData.myDesk.find(t => t.id === appData.focusTaskId);
                        if (task) {
                            sendGarshuNudge(task.title);
                            // Reset so it doesn't spam immediately
                            lastActiveTime = Date.now();
                        }
                    }
                }
            }, 60000);
        }

        // 3. The Nudge Action
        function sendGarshuNudge(taskTitle) {
            // 1. Console Log
            console.log(`[Garshu Nudge]  Triggered for: "${taskTitle}" at ${new Date().toLocaleTimeString()}`);

            // 2. Audio Cue
            if (SoundEngine && typeof SoundEngine.bark === 'function') {
                SoundEngine.bark();
            }

            // 3. Visual Cue (Lasts 10 seconds now)
            showToast(` Garshu check: Still working on "${taskTitle}"?`, "info", 10000);

            // 4. System Notification
            if (Notification.permission === "granted") {
                new Notification("Garshu says: 'Woof!' ", {
                    body: `You've been gone a while. Still working on "${taskTitle}"?`,
                    icon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Ctext y='22' font-size='20'%3E%3C/text%3E%3C/svg%3E"
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        // --- FOCUS VISUALS HELPER ---
        function applyFocusVisuals(taskId) {
            // 1. Reset: Remove the ring from any previously focused card
            document.querySelectorAll('.glass-active-ring').forEach(el => {
                el.classList.remove('glass-active-ring');
            });

            if (!taskId) return;

            // 2. Find the card in the DOM
            // We look for a card that contains the specific 'onclick' or 'startFocus' button for this ID
            // This handles both the 'My Desk' list and the 'Pipeline' list
            const btn = document.querySelector(`button[onclick*="'${taskId}'"]`) ||
                document.querySelector(`button[onclick*='"${taskId}"']`);

            if (btn) {
                // The card is usually the great-grandparent of the button
                // structure: card > actions > div > button
                const card = btn.closest('.desk-card, .stagger-item');
                if (card) {
                    card.classList.add('glass-active-ring');
                }
            }
        }

        // 3. Hook into the existing startFocus function
        const existingStartFocus = startFocus; // Save the old function
        startFocus = function (taskId) {
            existingStartFocus(taskId); // Run the old logic (timer, data save)
            applyFocusVisuals(taskId);  // Run the new visual logic
        };

        // 4. Also hook into stopFocus to clear the ring
        const existingStopFocus = stopFocus;
        stopFocus = function (silent) {
            existingStopFocus(silent);
            applyFocusVisuals(null); // Clear visuals
        };

        // 5. Re-apply on load (in case page refreshes while focused)
        setTimeout(() => {
            if (appData.focusTaskId) {
                applyFocusVisuals(appData.focusTaskId);
            }
        }, 1000); // Wait for rendering

        // ==========================================
        // PROJECTS & PLANNING MODULE
        // ==========================================

        let currentPlannerId = null;

        // 1. Initialize Data
        function initProjectsModule() {
            if (!appData.projects) appData.projects = [];
            // Migration: ensure structure and convert legacy date formats
            appData.projects.forEach(p => {
                if (!p.tasks) p.tasks = [];
                if (!p.area) p.area = 'General';
                if (!p.status) p.status = 'Active';
                if (!p.theme) p.theme = 'indigo'; // Default theme

                // Migrate project dueDate to dueDateStart/dueDateEnd
                if (p.dueDate && !p.dueDateStart && !p.dueDateEnd) {
                    p.dueDateStart = p.dueDate;
                    p.dueDateEnd = p.dueDate;
                }

                // Migrate task dates from startDate/dueDate to dueDateStart/dueDateEnd
                p.tasks.forEach(t => {
                    if ((t.startDate || t.dueDate) && !t.dueDateStart && !t.dueDateEnd) {
                        if (t.startDate && t.dueDate) {
                            t.dueDateStart = t.startDate;
                            t.dueDateEnd = t.dueDate;
                        } else if (t.dueDate) {
                            t.dueDateStart = t.dueDate;
                            t.dueDateEnd = t.dueDate;
                        }
                    }
                });
                if (!p.icon) p.icon = 'clipboard'; // Default icon
            });
        }

        // Icon SVG helper
        function getProjectIconSvg(iconName) {
            const icons = {
                clipboard: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>`,
                folder: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>`,
                code: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>`,
                star: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>`,
                rocket: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /></svg>`,
                briefcase: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>`,
                lightning: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>`,
                heart: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>`
            };
            return icons[iconName] || icons.clipboard;
        }

        // 2. Render Dashboard
        function renderProjectsView() {
            const grid = document.getElementById('projectsGrid');
            const archiveGrid = document.getElementById('archivedProjectsGrid');
            const areaFilter = document.getElementById('projectAreaFilter');

            if (!grid) return; // Safety check

            grid.innerHTML = '';
            archiveGrid.innerHTML = '';
            initProjectsModule();

            // Populate Filter
            const areas = [...new Set(appData.projects.map(p => p.area))].sort();
            if (areaFilter.options.length === 1) { // Only refill if just default exists
                areas.forEach(a => {
                    areaFilter.innerHTML += `<option value="${a}">${a}</option>`;
                });
            }

            const filterVal = areaFilter.value;

            // Sort: Active first, then by Creation Date desc
            const sortedProjects = appData.projects.sort((a, b) => b.id.split('_')[1] - a.id.split('_')[1]);

            sortedProjects.forEach(p => {
                if (filterVal !== 'all' && p.area !== filterVal) return;

                // Calculate Progress
                const total = p.tasks.length;
                const done = p.tasks.filter(t => t.status === 'done').length;
                const percent = total === 0 ? 0 : Math.round((done / total) * 100);

                // Theme colors for progress bar
                const theme = p.theme || 'indigo';
                const progressClass = percent === 100 ? 'green' : (percent === 0 ? 'slate' : theme);

                // Project icon based on saved icon property
                const iconSvg = getProjectIconSvg(p.icon || 'clipboard');


                const cardHTML = `
        <div onclick="openProjectPlanner('${p.id}')" class="project-card-linear group">
            <div class="p-5">
                <!-- Header: Icon + Title -->
                <div class="flex items-start gap-4 mb-4">
                    <div class="project-icon-gradient theme-${theme} flex-shrink-0">
                        ${iconSvg}
                    </div>
                    <div class="flex-1 min-w-0">
                        <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 dark:text-slate-500 block mb-0.5">${p.area}</span>
                        <h3 class="text-base font-bold text-slate-800 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors truncate">${p.title}</h3>
                    </div>
                </div>
                
                <!-- Stats Row -->
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center gap-3">
                        <span class="font-semibold text-slate-500 dark:text-slate-400">
                            <span class="text-slate-700 dark:text-slate-200 font-bold">${done}</span>/${total} tasks
                        </span>
                        ${(p.dueDateStart && p.dueDateEnd) || p.dueDate ? `
                        <span class="flex items-center gap-1 text-slate-400 dark:text-slate-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            ${p.dueDateStart && p.dueDateEnd ? formatDateRange(p.dueDateStart, p.dueDateEnd) : (p.dueDate ? formatDateShort(p.dueDate) : '')}
                        </span>` : ''}
                    </div>
                    <span class="font-bold ${percent === 100 ? 'text-green-600 dark:text-green-400' : 'text-slate-600 dark:text-slate-300'}">${percent}%</span>
                </div>
                
                ${total === 0 ? `<p class="mt-3 text-xs text-slate-400 dark:text-slate-500 italic">No tasks yet. Click to start planning.</p>` : ''}
            </div>
            
            <!-- Ultra-thin progress bar at bottom edge -->
            <div class="progress-bar-thin">
                <div class="fill ${progressClass}" style="width: ${percent}%"></div>
            </div>
        </div>`;

                if (p.status === 'Archived') {
                    archiveGrid.innerHTML += cardHTML;
                } else {
                    grid.innerHTML += cardHTML;
                }
            });

            if (grid.innerHTML === '') {
                grid.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-16 border-2 border-dashed border-slate-200 dark:border-slate-700/50 rounded-2xl bg-slate-50/50 dark:bg-slate-800/20">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center mb-4 shadow-lg shadow-indigo-500/20">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                    <p class="text-slate-500 dark:text-slate-400 font-medium">No active projects</p>
                    <p class="text-sm text-slate-400 dark:text-slate-500 mt-1">Create your first project to get started</p>
                </div>`;
            }

            // Initialize Drag & Drop for Projects Grid
            const projectsGrid = document.getElementById('projectsGrid');
            if (projectsGrid) {
                new Sortable(projectsGrid, {
                    animation: 150,             // Smooth animation timing (ms)
                    ghostClass: 'sortable-ghost', // Class applied to the item being dragged (placeholder)
                    dragClass: 'sortable-drag',   // Class applied to the item while in flight
                    delay: 100,                 // Slight delay prevents accidental drags when clicking to open
                    delayOnTouchOnly: true,     // Only delay on touch devices
                    onEnd: function (evt) {
                        // Future: Save the new order to local storage or backend
                        console.log('Project reordered:', evt.oldIndex, '->', evt.newIndex);
                    }
                });
            }
        }

        // Timeline View Functions
        let timelineDate = new Date(); // Defaults to today

        function toggleTimelineView() {
            const grid = document.getElementById('projectsGrid');
            const list = document.getElementById('projectsList');
            const timeline = document.getElementById('projectTimelineView');
            const gridBtn = document.getElementById('projectViewGrid');
            const listBtn = document.getElementById('projectViewList');
            const timelineBtn = document.getElementById('projectViewTimeline');

            if (!timeline) return;

            // Toggle visibility
            if (timeline.classList.contains('hidden')) {
                // Show timeline, hide grid and list
                timeline.classList.remove('hidden');
                if (grid) grid.classList.add('hidden');
                if (list) list.classList.add('hidden');

                // Update button states
                if (gridBtn) {
                    gridBtn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                    gridBtn.classList.add('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
                }
                if (listBtn) {
                    listBtn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                    listBtn.classList.add('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
                }
                if (timelineBtn) {
                    timelineBtn.classList.remove('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
                    timelineBtn.classList.add('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                }

                // Render timeline
                renderTimeline();
            } else {
                // Hide timeline, show grid (default view)
                timeline.classList.add('hidden');
                if (grid) grid.classList.remove('hidden');
                if (list) list.classList.add('hidden'); // Keep list hidden, grid is default

                // Update button states
                if (gridBtn) {
                    gridBtn.classList.remove('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
                    gridBtn.classList.add('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                }
                if (timelineBtn) {
                    timelineBtn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                    timelineBtn.classList.add('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
                }
            }
        }

        function showGridView() {
            const grid = document.getElementById('projectsGrid');
            const list = document.getElementById('projectsList');
            const timeline = document.getElementById('projectTimelineView');
            const gridBtn = document.getElementById('projectViewGrid');
            const listBtn = document.getElementById('projectViewList');
            const timelineBtn = document.getElementById('projectViewTimeline');

            // Show grid, hide timeline and list
            if (grid) grid.classList.remove('hidden');
            if (list) list.classList.add('hidden');
            if (timeline) timeline.classList.add('hidden');

            // Update button states
            if (gridBtn) {
                gridBtn.classList.remove('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
                gridBtn.classList.add('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
            }
            if (listBtn) {
                listBtn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                listBtn.classList.add('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
            }
            if (timelineBtn) {
                timelineBtn.classList.remove('bg-white', 'dark:bg-slate-700', 'text-slate-700', 'dark:text-slate-200', 'shadow-sm');
                timelineBtn.classList.add('text-slate-400', 'hover:text-slate-600', 'dark:hover:text-slate-300');
            }
        }

        function changeTimelineMonth(delta) {
            timelineDate.setMonth(timelineDate.getMonth() + delta);
            renderTimeline();
        }

        // Helper function to get color from theme
        function getProjectColor(project) {
            // If project has explicit color, use it
            if (project.color) return project.color;

            // Map theme names to colors
            const themeColors = {
                'indigo': '#6366f1',
                'violet': '#8b5cf6',
                'purple': '#a855f7',
                'blue': '#3b82f6',
                'emerald': '#10b981',
                'amber': '#f59e0b',
                'rose': '#f43f5e',
                'slate': '#64748b',
                'green': '#22c55e',
                'red': '#ef4444',
                'yellow': '#eab308',
                'orange': '#f97316',
                'pink': '#ec4899',
                'cyan': '#06b6d4',
                'teal': '#14b8a6'
            };

            const theme = project.theme || 'indigo';
            return themeColors[theme] || themeColors['indigo'];
        }

        // Timeline drag state variables
        let timelineDragState = null;
        let timelineHasDragged = false;

        function renderTimeline() {
            const body = document.getElementById('timelineBody');
            const header = document.getElementById('timelineHeader');
            const monthLabel = document.getElementById('timelineMonthLabel');
            const filterVal = document.getElementById('timelineProjectFilter')?.value || 'all';

            if (!body || !header || !monthLabel) return;

            // 1. Setup Dates
            const year = timelineDate.getFullYear();
            const month = timelineDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const viewStart = new Date(year, month, 1);
            const viewEnd = new Date(year, month, daysInMonth, 23, 59, 59);
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
            const todayDate = today.getDate();

            monthLabel.textContent = timelineDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // CSS Grid Definition
            const gridStyle = `display: grid; grid-template-columns: 220px repeat(${daysInMonth}, minmax(42px, 1fr));`;

            // 2. Render Header (Glassy & Clean)
            let headerHtml = `<div class="sticky left-0 z-40 bg-white/95 dark:bg-slate-900/95 backdrop-blur-sm p-3 border-r border-b border-slate-200 dark:border-slate-700 font-bold uppercase tracking-wider text-[10px] text-slate-500 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">Project</div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const isToday = isCurrentMonth && d === todayDate;

                headerHtml += `
                    <div class="relative flex flex-col items-center justify-center border-b border-slate-100 dark:border-slate-800 ${isToday ? 'bg-violet-50/50 text-violet-600' : 'bg-white/50 dark:bg-slate-900/50'} backdrop-blur-sm z-30">
                        <span class="text-[9px] uppercase opacity-50 mb-0.5">${date.toLocaleDateString('en-US', { weekday: 'narrow' })}</span>
                        <span class="text-xs ${isToday ? 'font-bold' : 'font-medium'}">${d}</span>
                        ${isToday ? '<div class="absolute bottom-0 w-full h-[2px] bg-violet-500"></div>' : ''}
                    </div>`;
            }
            header.style.cssText = gridStyle;
            header.innerHTML = headerHtml;

            // 3. Render Body
            let bodyHtml = '';

            // Helper function to convert hex to rgba
            const hexToRgba = (hex, alpha) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            };

            // Safe Data Access
            const allProjects = (appData && appData.projects) ? appData.projects : [];
            const projectsToShow = filterVal === 'all' ? allProjects : allProjects.filter(p => p && p.id == filterVal);

            // Populate Filter (Once)
            const filterSelect = document.getElementById('timelineProjectFilter');
            if (filterSelect && filterSelect.options.length === 1) {
                allProjects.forEach(p => filterSelect.add(new Option(p.title || 'Untitled', p.id)));
            }

            projectsToShow.forEach(proj => {
                const pTasks = (proj && proj.tasks) ? proj.tasks : [];

                // Filter & Clamp Tasks
                const tasksInView = pTasks.filter(t => {
                    if (!t) return false;
                    // Support both new format (dueDateStart/dueDateEnd) and legacy (startDate/dueDate)
                    const taskStart = t.dueDateStart || (t.startDate ? t.startDate : null);
                    const taskEnd = t.dueDateEnd || (t.dueDate ? t.dueDate : null);
                    if (!taskStart && !taskEnd) return false;

                    const s = taskStart ? new Date(taskStart) : (taskEnd ? new Date(taskEnd) : null);
                    const e = taskEnd ? new Date(taskEnd) : (taskStart ? new Date(taskStart) : s);
                    return s && e && s <= viewEnd && e >= viewStart;
                }).map(t => {
                    // Support both new format (dueDateStart/dueDateEnd) and legacy (startDate/dueDate)
                    const taskStart = t.dueDateStart || (t.startDate ? t.startDate : null);
                    const taskEnd = t.dueDateEnd || (t.dueDate ? t.dueDate : null);

                    let s = taskStart ? new Date(taskStart) : (taskEnd ? new Date(taskEnd) : null);
                    let e = taskEnd ? new Date(taskEnd) : (taskStart ? new Date(taskStart) : s);
                    if (!s || !e) return null;
                    if (s < viewStart) s = viewStart;
                    if (e > viewEnd) e = viewEnd;
                    return { ...t, _s: s, _e: e, _origS: taskStart, _origD: taskEnd };
                }).filter(t => t !== null);

                // Packing Algorithm
                tasksInView.sort((a, b) => a._s - b._s);
                const tracks = [];
                const packedTasks = tasksInView.map(t => {
                    let placed = false, trackIdx = 0;
                    for (let i = 0; i < tracks.length; i++) {
                        if (tracks[i] < t._s) { tracks[i] = t._e; trackIdx = i; placed = true; break; }
                    }
                    if (!placed) { tracks.push(t._e); trackIdx = tracks.length - 1; }
                    return { ...t, _track: trackIdx };
                });

                // Dynamic Height
                const rowHeight = Math.max(56, (tracks.length * 34) + 24);
                const pColor = getProjectColor(proj);

                // Start Row
                bodyHtml += `<div class="relative border-b border-slate-100 dark:border-slate-800 group transition-colors hover:bg-slate-50/30" style="${gridStyle} height: ${rowHeight}px;">`;

                // Sticky Sidebar Cell
                bodyHtml += `
                    <div class="sticky left-0 z-20 flex flex-col justify-center px-4 bg-white/95 dark:bg-slate-900/95 backdrop-blur-sm border-r border-slate-200 dark:border-slate-700 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                        <div class="flex items-center gap-2 mb-1">
                             <div class="w-2 h-2 rounded-full shrink-0" style="background-color: ${pColor}"></div>
                             <span class="font-semibold text-xs text-slate-700 dark:text-slate-200 truncate" title="${proj.title || 'Untitled'}">${proj.title || 'Untitled'}</span>
                        </div>
                        <div class="text-[10px] text-slate-400 pl-4 truncate">${proj.area || ''}</div>
                    </div>
                `;

                // Grid Background Lines
                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, month, d);
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const isToday = isCurrentMonth && d === todayDate;

                    // Subtle Vertical Lines Only
                    bodyHtml += `
                        <div class="relative h-full border-r border-dashed border-slate-100 dark:border-slate-800 ${isWeekend ? 'bg-slate-50/50 dark:bg-slate-800/30' : ''}">
                            ${isToday ? '<div class="absolute inset-y-0 left-1/2 -translate-x-1/2 w-[1px] bg-violet-400/50 z-0"></div>' : ''}
                        </div>`;
                }

                // Render Tasks (Pills)
                packedTasks.forEach(t => {
                    const dayStart = t._s.getDate();
                    const dayEnd = t._e.getDate();

                    // Grid Math
                    const colStart = dayStart + 1; // +1 for Sidebar column
                    const colSpan = (dayEnd - dayStart) + 1;

                    // Vertical Positioning
                    // We use margin-top to push it down from the top of the row
                    const marginTop = (t._track * 34) + 12;

                    // Determine Opacity based on status (optional polish)
                    const opacity = t.status === 'done' ? 'opacity-60 grayscale' : '';

                    // SAFE CHECK: Ensure valid span
                    const safeSpan = Math.max(1, colSpan);

                    // Use task.text or task.title (fallback for compatibility)
                    const taskTitle = (t.text || t.title || 'Untitled');
                    const taskId = (t.id || '');
                    const clickHandler = (proj && proj.id) ? `openProjectPlanner('${proj.id}')` : '';

                    // Convert hex color to rgba for transparency (slightly more visible)
                    const bgColor = hexToRgba(pColor, 0.15); // ~25% opacity equivalent
                    const borderColor = hexToRgba(pColor, 0.31); // ~50% opacity equivalent

                    // Calculate duration in days
                    const duration = Math.ceil((t._e - t._s) / (1000 * 60 * 60 * 24)) + 1;

                    const eventId = `task-${taskId}`;
                    bodyHtml += `
                        <div class="timeline-bar flex items-center px-2.5 rounded-full border shadow-sm cursor-move hover:brightness-95 hover:scale-[1.02] hover:shadow-md transition-all select-none truncate ${opacity} z-20 relative"
                             data-event-id="${eventId}"
                             data-id="${taskId}"
                             data-start="${t._origS || ''}"
                             data-end="${t._origD || ''}"
                             data-duration="${duration}"
                             data-project-id="${proj.id || ''}"
                             onmousedown="if (!event.target.closest('.timeline-handle-left') && !event.target.closest('.timeline-handle-right')) { timelineStartDrag(event, '${eventId}', 'move'); }"
                             style="
                                grid-column: ${colStart} / span ${safeSpan};
                                grid-row: 1; /* Force into the main track */
                                margin-top: ${marginTop}px; /* Vertical Stacking */
                                height: 26px;
                                background-color: ${bgColor}; 
                                border-color: ${borderColor};
                                color: ${pColor};
                                font-size: 11px;
                                font-weight: 600;
                                margin-left: 2px; 
                                margin-right: 2px;
                                align-self: start; /* Don't stretch height, just width */
                             ">
                            <div class="timeline-handle-left" onmousedown="event.stopPropagation(); timelineStartDrag(event, '${eventId}', 'resize-start')"></div>
                            <span class="truncate w-full pointer-events-none z-0">${taskTitle}</span>
                            <div class="timeline-handle-right" onmousedown="event.stopPropagation(); timelineStartDrag(event, '${eventId}', 'resize-end')"></div>
                        </div>
                    `;
                });

                bodyHtml += `</div>`; // End Row
            });

            body.innerHTML = bodyHtml;

            // Timeline bars are now handled by timelineStartDrag, timelineHandleDrag, timelineEndDrag
        }

        /* ---------------------------------------------------------
            TIMELINE DRAG AND DROP (Calendar Style)
        --------------------------------------------------------- */
        function timelineStartDrag(e, eventId, type) {
            e.stopPropagation();
            e.preventDefault();
            timelineHasDragged = false;

            // Extract task ID from eventId (remove 'task-' prefix)
            const taskId = eventId.replace('task-', '');

            // Find the task in projects
            let task = null;
            let project = null;
            for (const p of (appData && appData.projects ? appData.projects : [])) {
                if (p && p.tasks) {
                    const foundTask = p.tasks.find(t => t && (t.id === taskId || String(t.id) === String(taskId)));
                    if (foundTask) {
                        task = foundTask;
                        project = p;
                        break;
                    }
                }
            }

            if (!task || !project) return;

            // Parse dates - support both new format (dueDateStart/dueDateEnd) and legacy (startDate/dueDate)
            const taskStart = task.dueDateStart || (task.startDate ? task.startDate : null);
            const taskEnd = task.dueDateEnd || (task.dueDate ? task.dueDate : null);

            if (!taskStart && !taskEnd) return; // No date, can't drag

            let startDate, endDate;
            if (taskStart && taskEnd) {
                startDate = parseCalendarDate(taskStart);
                endDate = parseCalendarDate(taskEnd);
            } else if (taskEnd) {
                startDate = parseCalendarDate(taskEnd);
                endDate = startDate; // Single date: start and end are the same
            } else {
                return; // Can't drag without dates
            }

            if (!startDate || !endDate) return;

            // Get initial grid position
            const barEl = document.querySelector(`[data-event-id="${eventId}"]`);
            let initialGridColumn = 1;
            let initialGridSpan = 1;
            if (barEl) {
                const gridColumn = window.getComputedStyle(barEl).gridColumnStart;
                const gridSpan = window.getComputedStyle(barEl).gridColumnEnd;
                initialGridColumn = parseInt(gridColumn) || 1;
                initialGridSpan = parseInt(gridSpan) - initialGridColumn || 1;
            }

            // Get the handle position for resize operations
            let handleOffset = 0;
            if (type === 'resize-start' || type === 'resize-end') {
                if (barEl) {
                    const barRect = barEl.getBoundingClientRect();
                    if (type === 'resize-start') {
                        // Left handle - offset is from left edge
                        handleOffset = e.clientX - barRect.left;
                    } else {
                        // Right handle - offset is from right edge
                        handleOffset = e.clientX - barRect.right;
                    }
                }
            }

            timelineDragState = {
                type: type,
                eventId: eventId,
                taskId: taskId,
                projectId: project.id,
                startX: e.clientX,
                originalStart: new Date(startDate),
                originalEnd: new Date(endDate),
                initialGridColumn: initialGridColumn,
                initialGridSpan: initialGridSpan,
                lastAppliedDaysDelta: 0,
                handleOffset: handleOffset,
                resizeType: type
            };

            // Add dragging cursor and class to the bar being dragged
            document.body.style.cursor = 'grabbing';
            if (barEl) {
                barEl.style.cursor = 'grabbing';
                barEl.classList.add('dragging');
            }

            document.addEventListener('mousemove', timelineHandleDrag);
            document.addEventListener('mouseup', timelineEndDrag);
        }

        function timelineHandleDrag(e) {
            if (!timelineDragState) return;
            const deltaX = e.clientX - timelineDragState.startX;
            if (Math.abs(deltaX) > 3) {
                timelineHasDragged = true;
                // Ensure cursor is grabbing when dragging
                document.body.style.cursor = 'grabbing';
            }

            const PIXELS_PER_DAY = 42;

            // Calculate days delta - for resize, calculate from handle position
            let daysDelta;
            if (timelineDragState.type === 'resize-start') {
                // For resize-start, calculate from left handle position
                const bar = document.querySelector(`[data-event-id="${timelineDragState.eventId}"]`);
                if (bar) {
                    const barRect = bar.getBoundingClientRect();
                    const currentHandleX = barRect.left;
                    const originalHandleX = timelineDragState.startX - timelineDragState.handleOffset;
                    const handleDeltaX = currentHandleX - originalHandleX;
                    daysDelta = handleDeltaX >= 0 ? Math.floor(handleDeltaX / PIXELS_PER_DAY) : Math.ceil(handleDeltaX / PIXELS_PER_DAY);
                } else {
                    daysDelta = deltaX >= 0 ? Math.floor(deltaX / PIXELS_PER_DAY) : Math.ceil(deltaX / PIXELS_PER_DAY);
                }
            } else if (timelineDragState.type === 'resize-end') {
                // For resize-end, calculate from right handle position
                const bar = document.querySelector(`[data-event-id="${timelineDragState.eventId}"]`);
                if (bar) {
                    const barRect = bar.getBoundingClientRect();
                    const currentHandleX = barRect.right;
                    const originalHandleX = timelineDragState.startX + timelineDragState.handleOffset;
                    const handleDeltaX = currentHandleX - originalHandleX;
                    daysDelta = handleDeltaX >= 0 ? Math.floor(handleDeltaX / PIXELS_PER_DAY) : Math.ceil(handleDeltaX / PIXELS_PER_DAY);
                } else {
                    daysDelta = deltaX >= 0 ? Math.floor(deltaX / PIXELS_PER_DAY) : Math.ceil(deltaX / PIXELS_PER_DAY);
                }
            } else {
                // Move operation - use center
                if (deltaX >= 0) {
                    daysDelta = Math.floor(deltaX / PIXELS_PER_DAY);
                } else {
                    daysDelta = Math.ceil(deltaX / PIXELS_PER_DAY);
                }
            }

            // Only update dates if day delta has changed (prevents duplicate updates)
            if (daysDelta === timelineDragState.lastAppliedDaysDelta) {
                // For resize operations, don't apply transform - let grid handle it
                // For move operations, apply visual transform
                if (timelineDragState.type === 'move') {
                    const bar = document.querySelector(`[data-event-id="${timelineDragState.eventId}"]`);
                    if (bar) {
                        bar.style.transform = `translateX(${deltaX}px)`;
                        bar.style.zIndex = '50';
                    }
                }
                return;
            }

            // For resize operations, allow smaller movements but don't apply transform
            if (timelineDragState.type === 'move' && daysDelta === 0 && Math.abs(deltaX) < 50) {
                const bar = document.querySelector(`[data-event-id="${timelineDragState.eventId}"]`);
                if (bar) {
                    bar.style.transform = `translateX(${deltaX}px)`;
                    bar.style.zIndex = '50';
                }
                return;
            }
            if ((timelineDragState.type === 'resize-start' || timelineDragState.type === 'resize-end') && daysDelta === 0 && Math.abs(deltaX) < 20) {
                // For resize, don't apply transform - just return
                return;
            }

            // Find task
            const project = (appData && appData.projects) ?
                appData.projects.find(p => p && p.id === timelineDragState.projectId) : null;
            if (!project || !project.tasks) return;

            const task = project.tasks.find(t => t && (t.id === timelineDragState.taskId || String(t.id) === String(timelineDragState.taskId)));
            if (!task) return;

            let newStart = new Date(timelineDragState.originalStart);
            let newEnd = new Date(timelineDragState.originalEnd);

            // Normalize to start of day
            newStart.setHours(0, 0, 0, 0);
            newEnd.setHours(0, 0, 0, 0);

            if (timelineDragState.type === 'move') {
                newStart.setDate(newStart.getDate() + daysDelta);
                newEnd.setDate(newEnd.getDate() + daysDelta);
            } else if (timelineDragState.type === 'resize-start') {
                newStart.setDate(newStart.getDate() + daysDelta);
                if (newStart > newEnd) {
                    const temp = new Date(newStart);
                    newStart = new Date(newEnd);
                    newEnd = temp;
                }
            } else if (timelineDragState.type === 'resize-end') {
                newEnd.setDate(newEnd.getDate() + daysDelta);
                if (newEnd < newStart) {
                    const temp = new Date(newEnd);
                    newEnd = new Date(newStart);
                    newStart = temp;
                }
            }

            // Ensure dates are valid
            newStart.setHours(0, 0, 0, 0);
            newEnd.setHours(0, 0, 0, 0);

            // Update the task data
            task.dueDateStart = formatCalendarDate(newStart);
            task.dueDateEnd = formatCalendarDate(newEnd);
            // Clear legacy fields
            if (task.startDate) delete task.startDate;
            if (task.dueDate) delete task.dueDate;

            // Update grid position immediately based on new dates (for proper lane calculation)
            // Then apply fine transform for smooth visual movement
            if (timelineDragState.type === 'move') {
                // First update grid position to new dates
                updateTimelineBarPosition(timelineDragState.eventId, newStart, newEnd, null);

                // Then calculate fine pixel offset within the grid cell for smooth movement
                const PIXELS_PER_DAY = 42;
                const baseOffset = daysDelta * PIXELS_PER_DAY;
                const fineOffset = deltaX - baseOffset;

                // Apply fine transform for smooth visual movement
                const bar = document.querySelector(`[data-event-id="${timelineDragState.eventId}"]`);
                if (bar) {
                    bar.style.transform = `translateX(${fineOffset}px)`;
                    bar.style.zIndex = '50';
                    bar.style.position = 'relative';
                }
            } else {
                // For resize, update grid position directly without transform
                updateTimelineBarPosition(timelineDragState.eventId, newStart, newEnd, null);
            }

            // Store last applied delta to prevent duplicate updates
            timelineDragState.lastAppliedDaysDelta = daysDelta;

            // Recalculate lanes for ALL bars including the dragged one (now that its grid is updated)
            if (timelineDragState && timelineDragState.projectId) {
                recalculateTimelineLanes(timelineDragState.projectId); // Don't exclude - include it!
            }
        }

        function updateTimelineBarPosition(eventId, newStart, newEnd, pixelOffset = null) {
            const bar = document.querySelector(`[data-event-id="${eventId}"]`);
            if (!bar) return;

            // This function now always updates grid position
            // Fine transform is applied separately in timelineHandleDrag for move operations
            // Calculate final grid position and update
            const timelineYear = timelineDate.getFullYear();
            const timelineMonth = timelineDate.getMonth();
            const daysInMonth = new Date(timelineYear, timelineMonth + 1, 0).getDate();
            const viewStart = new Date(timelineYear, timelineMonth, 1);
            viewStart.setHours(0, 0, 0, 0);
            const viewEnd = new Date(timelineYear, timelineMonth, daysInMonth);
            viewEnd.setHours(23, 59, 59, 999);

            // Clamp dates to visible month range
            let startDate = new Date(newStart);
            let endDate = new Date(newEnd);
            if (startDate < viewStart) startDate = new Date(viewStart);
            if (endDate > viewEnd) endDate = new Date(viewEnd);

            // Calculate grid position - ensure dates are in the current month context
            // Check if dates are actually in the current month
            let dayStart = startDate.getDate();
            let dayEnd = endDate.getDate();

            // If dates are outside current month, clamp them
            if (startDate.getMonth() !== timelineMonth || startDate.getFullYear() !== timelineYear) {
                if (startDate < viewStart) {
                    dayStart = 1;
                } else if (startDate > viewEnd) {
                    dayStart = daysInMonth;
                }
            }
            if (endDate.getMonth() !== timelineMonth || endDate.getFullYear() !== timelineYear) {
                if (endDate < viewStart) {
                    dayEnd = 1;
                } else if (endDate > viewEnd) {
                    dayEnd = daysInMonth;
                }
            }

            const colStart = dayStart + 1; // +1 for Sidebar column
            const colSpan = (dayEnd - dayStart) + 1;
            const safeSpan = Math.max(1, colSpan);

            // Update grid position (transform is handled separately in timelineHandleDrag for move ops)
            bar.style.gridColumn = `${colStart} / span ${safeSpan}`;
            // Don't remove transform here - it's managed in timelineHandleDrag and timelineEndDrag
        }

        function timelineEndDrag() {
            if (timelineDragState) {
                const barEl = document.querySelector(`[data-event-id="${timelineDragState.eventId}"]`);

                if (timelineHasDragged) {
                    // Calculate final dates based on last applied delta
                    const project = (appData && appData.projects) ?
                        appData.projects.find(p => p && p.id === timelineDragState.projectId) : null;

                    if (project && project.tasks) {
                        const task = project.tasks.find(t => t && (t.id === timelineDragState.taskId || String(t.id) === String(timelineDragState.taskId)));
                        if (task) {
                            // Final dates are already updated in timelineHandleDrag
                            // Now update grid position and remove transform
                            const taskStart = task.dueDateStart || (task.startDate ? task.startDate : null);
                            const taskEnd = task.dueDateEnd || (task.dueDate ? task.dueDate : null);

                            if (taskStart && taskEnd) {
                                const startDate = parseCalendarDate(taskStart);
                                const endDate = parseCalendarDate(taskEnd);
                                if (startDate && endDate) {
                                    updateTimelineBarPosition(timelineDragState.eventId, startDate, endDate, null);
                                }
                            }
                        }
                    }

                    // Save data
                    if (typeof saveData === 'function') {
                        saveData();
                    }

                    // Refresh project planner modal if it's open and showing the same project
                    if (currentPlannerId === timelineDragState.projectId && typeof renderPlannerTasks === 'function') {
                        renderPlannerTasks();
                    }

                    // Recalculate all lanes after drag ends for smooth repositioning
                    if (timelineDragState && timelineDragState.projectId) {
                        // Remove transform from dragged bar
                        if (barEl) {
                            barEl.style.transform = '';
                            barEl.style.zIndex = '';
                            barEl.style.position = '';
                        }

                        setTimeout(() => {
                            recalculateTimelineLanes(timelineDragState.projectId);
                            // Then re-render to ensure everything is in sync
                            renderTimeline();
                        }, 10);
                    } else {
                        renderTimeline();
                    }
                    // No toast notification for smooth experience
                } else {
                    // Click without drag - open project planner modal
                    const projectId = timelineDragState.projectId;
                    if (projectId) {
                        openProjectPlanner(projectId);
                    }
                }

                // Remove dragging class and reset styles
                if (barEl) {
                    barEl.classList.remove('dragging');
                    barEl.style.cursor = '';
                    barEl.style.transform = '';
                    barEl.style.zIndex = '';
                    barEl.style.position = '';
                }
            }

            // Remove dragging cursor
            document.body.style.cursor = '';

            timelineDragState = null;
            timelineHasDragged = false;
            document.removeEventListener('mousemove', timelineHandleDrag);
            document.removeEventListener('mouseup', timelineEndDrag);
        }

        /* ---------------------------------------------------------
            TIMELINE LANE RECALCULATION (Smooth Repositioning)
        --------------------------------------------------------- */
        function recalculateTimelineLanes(projectId, excludeEventId = null) {
            const body = document.getElementById('timelineBody');
            if (!body) return;

            const project = (appData && appData.projects) ? appData.projects.find(p => p && p.id === projectId) : null;
            if (!project || !project.tasks) return;

            // Get timeline date range
            const timelineYear = timelineDate.getFullYear();
            const timelineMonth = timelineDate.getMonth();
            const daysInMonth = new Date(timelineYear, timelineMonth + 1, 0).getDate();
            const viewStart = new Date(timelineYear, timelineMonth, 1);
            viewStart.setHours(0, 0, 0, 0);
            const viewEnd = new Date(timelineYear, timelineMonth, daysInMonth);
            viewEnd.setHours(23, 59, 59, 999);

            // Get all timeline bars for this project (include all bars for proper stacking)
            const allBars = body.querySelectorAll(`[data-project-id="${projectId}"]`);
            const bars = Array.from(allBars); // Include all bars - don't exclude during drag

            // Group bars by their date ranges and calculate lanes
            const barsWithDates = bars.map(bar => {
                const taskId = bar.getAttribute('data-id');
                let startDate = null;
                let endDate = null;

                // Get dates from task data (most reliable)
                if (taskId && project.tasks) {
                    const task = project.tasks.find(t => t && (t.id === taskId || String(t.id) === String(taskId)));
                    if (task) {
                        const taskStart = task.dueDateStart || (task.startDate ? task.startDate : null);
                        const taskEnd = task.dueDateEnd || (task.dueDate ? task.dueDate : null);
                        if (taskStart) startDate = parseCalendarDate(taskStart);
                        if (taskEnd) endDate = parseCalendarDate(taskEnd);
                    }
                }

                // Fallback to data attributes if task data not available
                if (!startDate || !endDate) {
                    const start = bar.getAttribute('data-start');
                    const end = bar.getAttribute('data-end');
                    if (start) startDate = parseCalendarDate(start);
                    if (end) endDate = parseCalendarDate(end);
                }

                return {
                    bar: bar,
                    start: startDate,
                    end: endDate
                };
            }).filter(b => b.start && b.end);

            // Filter to only bars in current view
            const barsInView = barsWithDates.filter(item => {
                const s = new Date(item.start);
                const e = new Date(item.end);
                return s <= viewEnd && e >= viewStart;
            });

            // Clamp dates to view and calculate positions
            const barsWithPositions = barsInView.map(item => {
                let s = new Date(item.start);
                let e = new Date(item.end);
                if (s < viewStart) s = new Date(viewStart);
                if (e > viewEnd) e = new Date(viewEnd);

                const dayStart = s.getDate();
                const dayEnd = e.getDate();
                const colStart = dayStart + 1; // +1 for Sidebar column
                const colSpan = (dayEnd - dayStart) + 1;

                return {
                    bar: item.bar,
                    colStart: colStart,
                    colSpan: colSpan
                };
            });

            // Sort by start position
            barsWithPositions.sort((a, b) => a.colStart - b.colStart);

            // Calculate lanes (similar to packing algorithm in renderTimeline)
            const lanes = [];
            barsWithPositions.forEach(item => {
                let placed = false;
                let trackIdx = 0;
                for (let i = 0; i < lanes.length; i++) {
                    if (lanes[i] < item.colStart) {
                        lanes[i] = item.colStart + item.colSpan - 1;
                        trackIdx = i;
                        placed = true;
                        break;
                    }
                }
                if (!placed) {
                    trackIdx = lanes.length;
                    lanes.push(item.colStart + item.colSpan - 1);
                }

                // Smoothly update position with transition
                const marginTop = (trackIdx * 34) + 12;
                item.bar.style.transition = 'margin-top 0.2s ease-out';
                item.bar.style.marginTop = `${marginTop}px`;
            });
        }

        /* ---------------------------------------------------------
            OLD INTERACTIVE GANTT ENGINE (Removed - Replaced by timeline drag functions above)
        --------------------------------------------------------- */
        // Old initGanttInteractions function removed - replaced by timelineStartDrag, timelineHandleDrag, timelineEndDrag

        // 3. Project Creation
        function openProjectModal() {
            document.getElementById('newProjTitle').value = '';
            document.getElementById('newProjArea').value = '';
            document.getElementById('newProjTheme').value = 'indigo';
            document.getElementById('newProjIcon').value = 'clipboard';

            // Clear date input and attributes
            const dueDateInput = document.getElementById('newProjDue');
            if (dueDateInput) {
                dueDateInput.value = '';
                dueDateInput.removeAttribute('data-range-start');
                dueDateInput.removeAttribute('data-range-end');
                updateProjectDateDisplay(dueDateInput);
            }

            // Reset pickers
            selectProjectTheme('indigo');
            selectProjectIcon('clipboard');
            toggleModal('projectModal');
            setTimeout(() => document.getElementById('newProjTitle').focus(), 100);
        }

        function selectProjectTheme(theme) {
            const themeInput = document.getElementById('newProjTheme');
            if (themeInput) themeInput.value = theme;
            // Update UI in create modal
            const container = document.getElementById('themePickerContainer');
            if (container) {
                container.querySelectorAll('.theme-btn').forEach(btn => {
                    if (btn.dataset.theme === theme) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }
            // Also update in planner modal if it exists
            const plannerContainer = document.getElementById('plannerThemePickerContainer');
            if (plannerContainer) {
                plannerContainer.querySelectorAll('.theme-btn').forEach(btn => {
                    if (btn.dataset.theme === theme) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }
        }

        function selectProjectIcon(icon) {
            const iconInput = document.getElementById('newProjIcon');
            if (iconInput) iconInput.value = icon;
            // Update UI in create modal
            const container = document.getElementById('iconPickerContainer');
            if (container) {
                container.querySelectorAll('.icon-btn').forEach(btn => {
                    if (btn.dataset.icon === icon) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }
            // Also update in planner modal if it exists
            const plannerContainer = document.getElementById('plannerIconPickerContainer');
            if (plannerContainer) {
                plannerContainer.querySelectorAll('.icon-btn').forEach(btn => {
                    if (btn.dataset.icon === icon) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }
        }

        function saveNewProject() {
            const title = document.getElementById('newProjTitle').value.trim();
            const area = document.getElementById('newProjArea').value.trim() || 'General';
            const dueDateInput = document.getElementById('newProjDue');
            const due = dueDateInput.value || '';
            const theme = document.getElementById('newProjTheme').value || 'indigo';
            const icon = document.getElementById('newProjIcon').value || 'clipboard';

            if (!title) { showToast('Project title is required', 'error'); return; }

            // Check for range dates
            const rangeStart = dueDateInput.getAttribute('data-range-start');
            const rangeEnd = dueDateInput.getAttribute('data-range-end');

            const newProj = {
                id: 'proj_' + Date.now(),
                title,
                area,
                status: 'Active',
                theme: theme,
                icon: icon,
                notes: '',
                tasks: []
            };

            // Store dates as object format: dueDateStart and dueDateEnd
            if (rangeStart && rangeEnd) {
                newProj.dueDateStart = rangeStart;
                newProj.dueDateEnd = rangeEnd;
            } else if (due) {
                // Single date: use same value for both start and end
                newProj.dueDateStart = due;
                newProj.dueDateEnd = due;
            } else {
                // Explicitly clear dates when due date is empty
                newProj.dueDateStart = null;
                newProj.dueDateEnd = null;
            }

            appData.projects.push(newProj);
            saveData();
            toggleModal('projectModal');
            renderProjectsView();
            showToast('Project created successfully', 'success');
        }

        // 4. Project Planner (The Detail Modal)
        function openProjectPlanner(id) {
            const p = appData.projects.find(x => x.id === id);
            if (!p) return;

            currentPlannerId = id;

            // Fill Header
            document.getElementById('plannerTitle').value = p.title;
            document.getElementById('plannerAreaBadge').textContent = p.area;
            document.getElementById('plannerNotes').value = p.notes || '';

            // Status Badge & Button Text
            const statusBadge = document.getElementById('plannerStatusBadge');
            const toggleBtn = document.getElementById('plannerToggleStatusBtn');

            if (p.status === 'Active') {
                // FIX: Use real < and > characters, not &lt; and &gt;
                statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span> <span class="text-xs font-bold text-green-600 dark:text-green-400 ml-1">Active</span>`;
                toggleBtn.textContent = "Archive Project";
            } else {
                // FIX: Use real < and > characters here too
                statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-slate-400 inline-block"></span> <span class="text-xs font-bold text-slate-500 ml-1">Archived</span>`;
                toggleBtn.textContent = "Restore Project";
            }

            // Display project due date in header
            const plannerDueDate = document.getElementById('plannerDueDate');
            if (plannerDueDate) {
                if (p.dueDateStart && p.dueDateEnd) {
                    plannerDueDate.textContent = `Due: ${formatDateRange(p.dueDateStart, p.dueDateEnd)}`;
                    plannerDueDate.classList.remove('hidden');
                } else if (p.dueDate) {
                    plannerDueDate.textContent = `Due: ${formatDateShort(p.dueDate)}`;
                    plannerDueDate.classList.remove('hidden');
                } else {
                    plannerDueDate.classList.add('hidden');
                }
            }

            // Set appearance pickers to project's current values
            updatePlannerIconSelection(p.icon || 'clipboard');
            updatePlannerThemeSelection(p.theme || 'indigo');

            renderPlannerTasks();

            // Show Modal
            const modal = document.getElementById('projectPlannerModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
        }

        function closeProjectPlanner() {
            const modal = document.getElementById('projectPlannerModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            // Reset appearance section to hidden
            const appearanceSection = document.getElementById('plannerAppearanceSection');
            if (appearanceSection) appearanceSection.classList.add('hidden');
            const chevron = document.getElementById('appearanceChevron');
            if (chevron) chevron.style.transform = '';
            currentPlannerId = null;
            renderProjectsView(); // Refresh dashboard on close
        }

        function togglePlannerAppearance() {
            const section = document.getElementById('plannerAppearanceSection');
            const chevron = document.getElementById('appearanceChevron');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                if (chevron) chevron.style.transform = 'rotate(90deg)';
            } else {
                section.classList.add('hidden');
                if (chevron) chevron.style.transform = '';
            }
        }

        function updatePlannerIconSelection(icon) {
            const container = document.getElementById('plannerIconPickerContainer');
            if (container) {
                container.querySelectorAll('.icon-btn').forEach(btn => {
                    if (btn.dataset.icon === icon) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }
        }

        function updatePlannerThemeSelection(theme) {
            const container = document.getElementById('plannerThemePickerContainer');
            if (container) {
                container.querySelectorAll('.theme-btn').forEach(btn => {
                    if (btn.dataset.theme === theme) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }
        }

        function updatePlannerIcon(icon) {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            if (p) {
                p.icon = icon;
                saveData();
                updatePlannerIconSelection(icon);
                showToast('Icon updated', 'success');
            }
        }

        function updatePlannerTheme(theme) {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            if (p) {
                p.theme = theme;
                saveData();
                updatePlannerThemeSelection(theme);
                showToast('Theme updated', 'success');
            }
        }

        function savePlannerTitle() {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            if (p) {
                p.title = document.getElementById('plannerTitle').value;
                saveData();
            }
        }

        function savePlannerNotes() {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            if (p) {
                p.notes = document.getElementById('plannerNotes').value;
                saveData();
            }
        }

        function toggleProjectStatus() {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            if (p) {
                p.status = p.status === 'Active' ? 'Archived' : 'Active';
                saveData();
                closeProjectPlanner();
                showToast(`Project ${p.status === 'Active' ? 'Restored' : 'Archived'}`, 'info');
            }
        }

        function deleteProject() {
            if (!currentPlannerId) return;
            if (confirm("Permanently delete this project and all tasks?")) {
                appData.projects = appData.projects.filter(x => x.id !== currentPlannerId);
                saveData();
                closeProjectPlanner();
                showToast("Project deleted", "success");
            }
        }

        // ==========================================
        // 5. RICH TASK LOGIC (BUG FIX & UPGRADE)
        // ==========================================

        // Helper: Sanitize text to prevent HTML breaks (Fixes the disappearing text bug)
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function normalizeTask(t) {
            if (!t.id) t.id = 'task_' + Math.random().toString(36).substr(2, 9);
            if (!t.text) t.text = '';
            if (!t.status) t.status = 'todo';
            if (!t.priority) t.priority = 'Normal';
            // Support both new format (dueDateStart/dueDateEnd) and legacy (startDate/dueDate)
            if (!t.dueDateStart && !t.dueDateEnd) {
                // Migrate legacy format if present
                if (t.startDate && t.dueDate) {
                    t.dueDateStart = t.startDate;
                    t.dueDateEnd = t.dueDate;
                } else if (t.dueDate) {
                    t.dueDateStart = t.dueDate;
                    t.dueDateEnd = t.dueDate;
                } else {
                    t.dueDateStart = '';
                    t.dueDateEnd = '';
                }
            }
            if (typeof t.progress === 'undefined') t.progress = 0; // Initialize progress
            return t;
        }

        function addProjectTask() {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            if (!p) return;

            const newTask = {
                id: 'task_' + Date.now(),
                text: '',
                status: 'todo',
                priority: 'Normal',
                dueDate: '',
                notes: '',
                progress: 0 // Initialize progress
            };

            p.tasks.push(newTask);
            saveData();
            renderPlannerTasks();

            // Focus the new task input
            setTimeout(() => {
                const row = document.getElementById(`task-row-${newTask.id}`);
                if (row) {
                    const input = row.querySelector('input[type="text"]');
                    if (input) input.focus();
                }
            }, 50);
        }

        function handleQuickTaskEnter(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission if it's inside a form
                const input = e.target;
                const title = input.value.trim();

                if (title && currentPlannerId) {
                    const p = appData.projects.find(x => x.id === currentPlannerId);
                    if (p) {
                        const newTask = {
                            id: 'task_' + Date.now(),
                            text: title,
                            status: 'todo',
                            priority: 'Normal',
                            dueDate: '',
                            notes: '',
                            progress: 0
                        };
                        p.tasks.push(newTask);
                        saveData();
                        renderPlannerTasks(); // This will re-render the whole list including the new task
                        input.value = ''; // Clear input and keep focus
                    }
                }
            }
        }

        function renderPlannerTasks() {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);

            // Sort tasks: Active first, then Done
            const tasks = p.tasks.map(normalizeTask).sort((a, b) => {
                if (a.status === 'done' && b.status !== 'done') return 1;
                if (a.status !== 'done' && b.status === 'done') return -1;
                return 0; // Keep creation order
            });

            const list = document.getElementById('plannerTaskList');
            list.innerHTML = '';

            // Update Progress Header
            const total = tasks.length;
            const doneCount = tasks.filter(t => t.status === 'done').length;
            const percent = total === 0 ? 0 : Math.round((doneCount / total) * 100);

            // Update text displays
            document.getElementById('plannerProgressText').innerText = `${percent}%`;
            const progressBar = document.getElementById('plannerProgressBar');
            if (progressBar) progressBar.style.width = `${percent}%`;

            // Update task stats
            const taskStats = document.getElementById('plannerTaskStats');
            if (taskStats) taskStats.innerText = `${doneCount} of ${total} tasks`;

            // Update circular progress ring
            const progressRing = document.getElementById('plannerProgressRing');
            if (progressRing) {
                // Circumference of circle: 2 *  * r = 2 * 3.14159 * 24  150.8
                const circumference = 150.8;
                const offset = circumference - (percent / 100) * circumference;
                progressRing.style.strokeDashoffset = offset;
            }

            // Cleanup old UI elements if they exist
            const oldCompList = document.getElementById('plannerCompletedList');
            if (oldCompList) oldCompList.innerHTML = '';

            tasks.forEach(t => {
                const isDone = t.status === 'done';

                // Status Config
                const statusConfig = {
                    'todo': { label: 'To Do', class: 'status-todo', icon: '' },
                    'doing': { label: 'In Progress', class: 'status-doing', icon: '' },
                    'blocked': { label: 'Blocked', class: 'status-blocked', icon: '' },
                    'done': { label: 'Done', class: 'status-done', icon: '' }
                };
                const s = statusConfig[t.status] || statusConfig['todo'];

                // Metadata Badges
                let metaHtml = '';
                if (t.priority === 'High') metaHtml += `<span class="meta-badge high mr-2">High</span>`;

                // Date Display with Premium Picker
                // Support both new format (dueDateStart/dueDateEnd) and legacy (startDate/dueDate)
                const dueDateStart = t.dueDateStart || (t.startDate ? t.startDate : '');
                const dueDateEnd = t.dueDateEnd || (t.dueDate ? t.dueDate : '');
                const taskDateInputId = `task-date-${t.id}`;

                metaHtml += `
                <div class="relative w-36 flex-shrink-0">
                    <div class="relative group w-full">
                        <input type="text" id="${taskDateInputId}" readonly
                            class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                            onclick="openPremiumCalendar(event, '${taskDateInputId}')"
                            data-task-id="${t.id}"
                            ${dueDateEnd ? `value="${dueDateEnd}"` : ''}
                            ${dueDateStart && dueDateEnd ? `data-range-start="${dueDateStart}" data-range-end="${dueDateEnd}"` : ''}>

                        <div id="task-date-empty-${t.id}" class="${dueDateStart || dueDateEnd ? 'hidden' : ''} flex items-center justify-center w-full py-1 px-2 rounded border border-dashed border-slate-300 text-slate-400 bg-slate-50 dark:bg-slate-800 group-hover:bg-white dark:group-hover:bg-slate-700 group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                            <div class="flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 group-hover:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <svg class="w-3.5 h-3.5 hidden group-hover:block text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11v6m-3-3h6" /></svg>
                                <span class="text-xs font-medium group-hover:text-indigo-600">Set Date</span>
                            </div>
                        </div>

                        <div id="task-date-filled-${t.id}" class="${dueDateStart || dueDateEnd ? '' : 'hidden'} flex items-center justify-between w-full py-1 px-2 rounded border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm">
                            <div class="flex items-center gap-1.5 text-slate-700 dark:text-slate-300">
                                <svg class="w-3.5 h-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <span id="task-date-text-${t.id}" class="text-xs font-bold truncate"></span>
                            </div>
                            <button type="button" onclick="clearTaskDate(event, '${taskDateInputId}')"
                                class="relative z-40 text-slate-400 hover:text-red-500 p-0.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><svg
                                    xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg></button>
                        </div>
                    </div>
                </div>
                `;

                // Render Row
                // FIX: Slider CSS updated to include a visual thumb and larger hit area
                const itemHTML = `
        <div class="task-row group border-b border-slate-100 dark:border-slate-800/50 last:border-0 ${isDone ? 'opacity-60' : ''}" id="task-row-${t.id}">
            <div class="flex items-center gap-3 p-3">
                <button onclick="cycleTaskStatus('${t.id}', this)" class="status-pill ${s.class} flex-shrink-0 w-28 justify-center" title="Click to cycle status">
                    <span>${s.icon}</span> ${s.label}
                </button>
                
                <div class="flex-1 min-w-0 relative">
                    <div class="flex items-center justify-between mb-1">
                        <input type="text" 
                            value="${escapeHtml(t.text)}" 
                            oninput="updateTaskTextMemory('${t.id}', this.value)" 
                            onblur="saveData()" 
                            onkeydown="handleTaskInputKey(event, '${t.id}')"
                            class="w-full bg-transparent border-none p-0 text-sm font-medium ${isDone ? 'line-through text-slate-400' : 'text-slate-700 dark:text-slate-200'} focus:ring-0 placeholder-slate-300" 
                            placeholder="Task name...">
                        <span class="text-[10px] font-mono text-slate-400 ml-2 progress-text">${t.progress}%</span>
                    </div>
                    
                    <!-- Mini Progress Slider (Single Input with Gradient) -->
                    <div class="relative flex items-center w-full h-5 mt-1">
                        <input type="range" min="0" max="100" step="5" value="${t.progress}" 
                            oninput="updateTaskProgress('${t.id}', this.value)"
                            class="custom-range-slider"
                            id="slider-${t.id}"
                            style="background: linear-gradient(to right, #6366f1 0%, #6366f1 ${t.progress}%, #e2e8f0 ${t.progress}%, #e2e8f0 100%);">
                    </div>
                </div>

                <div class="flex items-center">
                    ${metaHtml}
                </div>

                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="toggleProjectTaskNote('${t.id}')" class="p-1.5 ${t.notes ? 'text-slate-400 hover:text-hub-600' : 'text-slate-200 cursor-default'}" title="${t.notes ? 'View Notes' : 'No Notes'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </button>
                    <button onclick="toggleTaskDetails('${t.id}')" class="p-1.5 text-slate-400 hover:text-indigo-500 rounded hover:bg-indigo-50 dark:hover:bg-indigo-900/20" title="Edit Details">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                    </button>
                    <button onclick="pushTaskToDesk('${t.id}')" class="p-1.5 ${t.pushedToDesk ? 'text-green-500' : 'text-slate-300 hover:text-indigo-500'}" title="${t.pushedToDesk ? 'On Desk' : 'Push to My Desk'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    </button>
                    <button onclick="deleteProjectTask('${t.id}')" class="p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
            
            <!-- View Only Notes (Hidden by default) -->
            <div id="project-note-${t.id}" class="hidden bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg text-xs text-slate-600 dark:text-slate-400 mt-0 mb-3 mx-3 ml-[120px] border border-slate-100 dark:border-slate-700/50">
                ${renderNoteContent(t.notes)}
            </div>

            <div class="task-details px-3 pb-3" id="details-${t.id}">
                <div class="pl-[120px]">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Priority</label>
                            <select onchange="updateTaskMeta('${t.id}', 'priority', this.value)" class="w-full text-xs bg-slate-100 dark:bg-slate-700 border-none rounded px-2 py-1 mt-1 text-slate-700 dark:text-slate-200">
                                <option value="Normal" ${t.priority === 'Normal' ? 'selected' : ''}>Normal</option>
                                <option value="High" ${t.priority === 'High' ? 'selected' : ''}>High </option>
                                <option value="Low" ${t.priority === 'Low' ? 'selected' : ''}>Low</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Due Date</label>
                            <div class="relative group w-full mt-1">
                                <input type="text" id="task-detail-date-${t.id}" readonly
                                    class="absolute inset-0 w-full h-full opacity-0 z-30 cursor-pointer appearance-none"
                                    onclick="openPremiumCalendar(event, 'task-detail-date-${t.id}')"
                                    data-task-id="${t.id}"
                                    ${dueDateEnd ? `value="${dueDateEnd}"` : ''}
                                    ${dueDateStart && dueDateEnd ? `data-range-start="${dueDateStart}" data-range-end="${dueDateEnd}"` : ''}>

                                <div id="task-detail-date-empty-${t.id}" class="${dueDateStart || dueDateEnd ? 'hidden' : ''} flex items-center justify-center w-full py-1 px-2 rounded border border-dashed border-slate-300 text-slate-400 bg-slate-100 dark:bg-slate-700 group-hover:bg-white dark:group-hover:bg-slate-600 group-hover:border-slate-400 group-hover:text-slate-600 transition-all">
                                    <div class="flex items-center gap-1.5">
                                        <svg class="w-3 h-3 group-hover:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <svg class="w-3 h-3 hidden group-hover:block text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11v6m-3-3h6" /></svg>
                                        <span class="text-xs font-medium group-hover:text-indigo-600">Set Date</span>
                                    </div>
                                </div>

                                <div id="task-detail-date-filled-${t.id}" class="${dueDateStart || dueDateEnd ? '' : 'hidden'} flex items-center justify-between w-full py-1 px-2 rounded border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 shadow-sm">
                                    <div class="flex items-center gap-1.5 text-slate-700 dark:text-slate-300">
                                        <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        <span id="task-detail-date-text-${t.id}" class="text-xs font-bold"></span>
                                    </div>
                                    <button type="button" onclick="clearTaskDate(event, 'task-detail-date-${t.id}')"
                                        class="relative z-40 text-slate-400 hover:text-red-500 p-0.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><svg
                                            xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                                clip-rule="evenodd" />
                                        </svg></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <textarea onblur="updateTaskMeta('${t.id}', 'notes', this.value)" 
                        class="w-full text-xs bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 text-slate-600 dark:text-slate-300 resize-none h-20 focus:ring-1 focus:ring-indigo-500" 
                        placeholder="Add extra notes, links, or context...">${t.notes || ''}</textarea>
                </div>
            </div>
        </div>`;

                list.innerHTML += itemHTML;

                // Update task date displays after rendering
                const taskDateInput = document.getElementById(taskDateInputId);
                if (taskDateInput) {
                    updateTaskDateDisplay(taskDateInput);
                }
                const taskDetailDateInput = document.getElementById(`task-detail-date-${t.id}`);
                if (taskDetailDateInput) {
                    updateTaskDateDisplay(taskDetailDateInput);
                }
            });
        }

        // --- Task Date Helpers ---
        function updateTaskDateDisplay(input) {
            if (!input) return;
            const taskId = input.getAttribute('data-task-id');
            if (!taskId) return;

            // Handle both main task date display and detail date display
            const inputId = input.id;
            const isDetail = inputId && inputId.includes('task-detail-date');
            const prefix = isDetail ? 'task-detail-date' : 'task-date';

            const emptyState = document.getElementById(`${prefix}-empty-${taskId}`);
            const filledState = document.getElementById(`${prefix}-filled-${taskId}`);
            const textSpan = document.getElementById(`${prefix}-text-${taskId}`);

            if (!emptyState || !filledState || !textSpan) return;

            // Check for range dates
            const rangeStart = input.getAttribute('data-range-start');
            const rangeEnd = input.getAttribute('data-range-end');

            if (rangeStart && rangeEnd) {
                // Range date: use formatDateRange
                emptyState.classList.add('hidden');
                filledState.classList.remove('hidden');
                textSpan.textContent = formatDateRange(rangeStart, rangeEnd);
            } else if (input.value) {
                // Single date: format as before
                emptyState.classList.add('hidden');
                filledState.classList.remove('hidden');
                const d = new Date(input.value + 'T12:00:00');
                const m = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                textSpan.textContent = m;
            } else {
                emptyState.classList.remove('hidden');
                filledState.classList.add('hidden');
                textSpan.textContent = '';
            }
        }

        function clearTaskDate(e, inputId) {
            e.stopPropagation();
            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
                input.removeAttribute('data-range-start');
                input.removeAttribute('data-range-end');
                updateTaskDateDisplay(input);

                // Save cleared date to task
                const taskId = input.getAttribute('data-task-id');
                if (taskId && currentPlannerId) {
                    const p = appData.projects.find(x => x.id === currentPlannerId);
                    const t = p.tasks.find(x => x.id === taskId);
                    if (t) {
                        t.dueDateStart = null;
                        t.dueDateEnd = null;
                        // Clear legacy fields too
                        t.startDate = '';
                        t.dueDate = '';
                        saveData();
                    }
                }
            }
        }

        // FIX: New function to update memory instantly without render/save spam
        function updateTaskTextMemory(taskId, text) {
            const p = appData.projects.find(x => x.id === currentPlannerId);
            const t = p.tasks.find(x => x.id === taskId);
            if (t) {
                t.text = text;
                // We do NOT save or render here for performance. 
                // Save happens on blur.
            }
        }

        // FIX: Handle Enter key to save and create new task
        function handleTaskInputKey(e, taskId) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Stop newline
                e.target.blur();    // Trigger save via blur
                addProjectTask();   // Create new task
            }
        }

        function updateTaskProgress(taskId, value) {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            const t = p.tasks.find(x => x.id === taskId);
            if (t) {
                const val = parseInt(value);
                t.progress = val;

                // Logic: 100% -> Done
                if (val === 100 && t.status !== 'done') {
                    t.status = 'done';
                    renderPlannerTasks(); // Re-render to update status pill
                    return; // Render handles everything
                }

                // Logic: < 100% and Done -> Doing (or Todo if 0)
                if (val < 100 && t.status === 'done') {
                    t.status = val === 0 ? 'todo' : 'doing';
                    renderPlannerTasks(); // Re-render
                    return;
                }

                // Update the visual bar immediately (if no status change triggered render)
                const row = document.getElementById(`task-row-${taskId}`);
                if (row) {
                    const slider = document.getElementById(`slider-${taskId}`);
                    const text = row.querySelector('.progress-text');

                    if (slider) {
                        slider.style.background = `linear-gradient(to right, #6366f1 0%, #6366f1 ${value}%, #e2e8f0 ${value}%, #e2e8f0 100%)`;
                    }
                    if (text) text.textContent = `${value}%`;
                }
                saveData();
            }
        }

        function cycleTaskStatus(taskId, btnElement) {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            const t = p.tasks.find(x => x.id === taskId);
            if (t) {
                const statuses = ['todo', 'doing', 'blocked', 'done'];
                let idx = statuses.indexOf(t.status);
                if (idx === -1) idx = 0;

                const newStatus = statuses[(idx + 1) % statuses.length];
                t.status = newStatus;

                if (newStatus === 'done' && btnElement) {
                    triggerTaskCompletionConfetti(btnElement);
                }

                // Auto-update progress based on status change
                if (newStatus === 'done') {
                    t.progress = 100;
                } else if (newStatus === 'todo') {
                    t.progress = 0;
                } else if (newStatus === 'doing' && t.progress === 100) {
                    // If moving from Done -> Doing, reset to something logical like 50? 
                    // Or keep 100? User said "un-complete -> restore". 
                    // Since we don't track "previous", let's default to 50 to indicate "not done but active"
                    t.progress = 50;
                }
                // If 'blocked', keep current progress? Yes.

                saveData();
                renderPlannerTasks();
            }
        }

        function updateTaskMeta(taskId, field, value) {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            const t = p.tasks.find(x => x.id === taskId);
            if (t) {
                t[field] = value;
                saveData();
                renderPlannerTasks();
            }
        }

        // Global Date Picker Functions (Portal Strategy)
        let activeTaskId = null;

        window.openTaskDatePicker = function (taskId, triggerBtn, currentStart, currentDue) {
            activeTaskId = taskId;
            const popover = document.getElementById('global-task-date-popover');
            const startInput = document.getElementById('global-start-input');
            const dueInput = document.getElementById('global-due-input');
            const rangeToggle = document.getElementById('global-range-toggle');
            const startContainer = document.getElementById('global-start-container');
            const dueLabel = document.getElementById('global-due-label');

            // 1. Populate Data (show formatted but keep ISO for calendar)
            if (currentStart) {
                startInput.value = currentStart; // ISO format for calendar parsing
                startInput.setAttribute('data-date-value', currentStart);
                startInput.setAttribute('data-formatted', formatDateWithYear(currentStart));
                // Show formatted on blur
                if (document.activeElement !== startInput) {
                    startInput.value = formatDateWithYear(currentStart);
                }
            } else {
                startInput.value = '';
                startInput.removeAttribute('data-date-value');
                startInput.removeAttribute('data-formatted');
            }

            if (currentDue) {
                dueInput.value = currentDue; // ISO format for calendar parsing
                dueInput.setAttribute('data-date-value', currentDue);
                dueInput.setAttribute('data-formatted', formatDateWithYear(currentDue));
                // Show formatted on blur
                if (document.activeElement !== dueInput) {
                    dueInput.value = formatDateWithYear(currentDue);
                }
            } else {
                dueInput.value = '';
                dueInput.removeAttribute('data-date-value');
                dueInput.removeAttribute('data-formatted');
            }

            // Add focus/blur handlers to toggle between formatted and ISO display
            const handleFocus = (input) => {
                const isoDate = input.getAttribute('data-date-value');
                if (isoDate) input.value = isoDate; // Show ISO when focused
            };
            const handleBlur = (input) => {
                const formatted = input.getAttribute('data-formatted');
                if (formatted) input.value = formatted; // Show formatted when blurred
            };

            startInput.onfocus = () => handleFocus(startInput);
            startInput.onblur = () => handleBlur(startInput);
            dueInput.onfocus = () => handleFocus(dueInput);
            dueInput.onblur = () => handleBlur(dueInput);

            // 2. Set UI State (Range vs Single)
            if (currentStart) {
                startContainer.classList.remove('hidden');
                rangeToggle.textContent = '- Remove Start Date';
                dueLabel.textContent = 'Due Date';
            } else {
                startContainer.classList.add('hidden');
                rangeToggle.textContent = '+ Add Start Date';
                dueLabel.textContent = 'Deadline';
            }

            // 3. Setup Events
            // Toggle Logic
            rangeToggle.onclick = function () {
                const isHidden = startContainer.classList.contains('hidden');
                if (isHidden) {
                    startContainer.classList.remove('hidden');
                    this.textContent = '- Remove Start Date';
                    dueLabel.textContent = 'Due Date';
                } else {
                    startContainer.classList.add('hidden');
                    this.textContent = '+ Add Start Date';
                    dueLabel.textContent = 'Deadline';
                    startInput.value = ''; // Clear value
                    startInput.removeAttribute('data-date-value');
                }
            };

            // Save Logic
            document.getElementById('global-save-btn').onclick = function () {
                // Get raw date values (YYYY-MM-DD format) from data attributes
                const newStart = startContainer.classList.contains('hidden') ? null : (startInput.getAttribute('data-date-value') || '');
                const newDue = dueInput.getAttribute('data-date-value') || '';

                // Update task dates
                if (activeTaskId && currentPlannerId) {
                    const p = appData.projects.find(x => x.id === currentPlannerId);
                    const t = p.tasks.find(x => x.id === activeTaskId);
                    if (t) {
                        t.startDate = newStart || '';
                        t.dueDate = newDue || '';
                        saveData();
                        renderPlannerTasks();
                    }
                }

                closeGlobalDatePicker();
            };

            // 4. Position & Show
            popover.classList.remove('hidden');

            const rect = triggerBtn.getBoundingClientRect();
            let top = rect.bottom + 5;
            let left = rect.left;

            // Smart edge detection
            if (left + 260 > window.innerWidth) {
                left = window.innerWidth - 270;
            }
            if (top + 300 > window.innerHeight) {
                top = rect.top - 300; // Flip up if at bottom
            }

            popover.style.top = `${top}px`;
            popover.style.left = `${left}px`;
        };

        window.closeGlobalDatePicker = function () {
            document.getElementById('global-task-date-popover').classList.add('hidden');
            activeTaskId = null;
        };

        // Legacy function for compatibility (if needed elsewhere)
        window.updateTaskDate = function (taskId, type, value) {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            const t = p.tasks.find(x => x.id === taskId);
            if (t) {
                if (type === 'start') {
                    t.startDate = value || '';
                } else if (type === 'end') {
                    t.dueDate = value || '';
                }
                saveData();
                renderPlannerTasks();
            }
        };

        function toggleTaskDetails(taskId) {
            const row = document.getElementById(`task-row-${taskId}`);
            if (row) {
                row.classList.toggle('expanded');
            }
        }

        function deleteProjectTask(taskId) {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            if (p) {
                if (confirm("Are you sure you want to delete this task?")) {
                    p.tasks = p.tasks.filter(x => x.id !== taskId);
                    saveData();
                    renderPlannerTasks();
                    showToast("Task deleted", "success");
                }
            }
        }

        function pushTaskToDesk(taskId) {
            if (!currentPlannerId) return;
            const p = appData.projects.find(x => x.id === currentPlannerId);
            const t = p.tasks.find(x => x.id === taskId);

            if (t) {
                if (t.pushedToDesk) {
                    showToast("Already on My Desk", "info");
                    return;
                }

                // Copy range dates or single date (support both new and legacy formats)
                const taskDueDateStart = t.dueDateStart || (t.startDate ? t.startDate : '');
                const taskDueDateEnd = t.dueDateEnd || (t.dueDate ? t.dueDate : '');

                const deskTask = {
                    id: 'desk_' + Date.now(),
                    title: `[${p.title}] ${t.text}`,
                    category: 'Project',
                    status: 'OnTheTable',
                    notes: t.notes || '',
                    sourceId: t.id,
                    projectId: p.id
                };

                if (taskDueDateStart && taskDueDateEnd) {
                    deskTask.dueDateStart = taskDueDateStart;
                    deskTask.dueDateEnd = taskDueDateEnd;
                } else if (taskDueDateEnd) {
                    deskTask.dueDateStart = taskDueDateEnd;
                    deskTask.dueDateEnd = taskDueDateEnd;
                } else {
                    deskTask.dueDate = getTodayShort();
                }

                appData.myDesk.push(deskTask);

                t.pushedToDesk = true;
                saveData();
                renderPlannerTasks();
                showToast("Pushed to My Desk", "success");
            }
        }

        // Helper to render basic markdown in notes
        function renderNoteContent(text) {
            if (!text) return '';
            let html = escapeHtml(text);

            // Bold: **text**
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

            // Lists: * item or - item (must be at start of line)
            // We'll replace the line with a list item, then wrap the whole block in ul if needed
            // Simple approach: Replace lines starting with - or * with <li>
            html = html.replace(/^[\-\*]\s+(.*)$/gm, '<li>$1</li>');

            // Wrap <li>s in <ul> (naive but functional for simple notes)
            // If we see <li>, we assume it's part of a list. 
            // To do this cleanly, we can just replace newlines with <br> first, but lists need structure.
            // Let's do: Split by newlines. If line starts with <li>, it's a list item.

            const lines = html.split('\n');
            let inList = false;
            let result = '';

            lines.forEach(line => {
                if (line.startsWith('<li>')) {
                    if (!inList) {
                        result += '<ul class="list-disc pl-5 my-1">';
                        inList = true;
                    }
                    result += line;
                } else {
                    if (inList) {
                        result += '</ul>';
                        inList = false;
                    }
                    result += line + '<br>';
                }
            });
            if (inList) result += '</ul>';

            return result;
        }

        function toggleProjectTaskNote(taskId) {
            const noteDiv = document.getElementById(`project-note-${taskId}`);
            if (noteDiv) {
                noteDiv.classList.toggle('hidden');
            }
        }

        // ==========================================
        // GLOBAL ESC KEY HANDLER
        // ==========================================
        // (Handled in loadData function for proper hierarchy)




        // ==========================================
        // KEYBOARD NAVIGATION ENGINE
        // ==========================================

        const ACTION_HUB_TABS = [
            'tabMailbox',
            'tabMyDesk',
            'tabProjects',
            'tabPipeline',
            'tabLogbook',
            'tabBroadcast',
            'tabPerformance'
        ];

        const PULSE_CHECK_TABS = [
            'tabTeamInfo',
            'tabPulse',
            'tabTimesheets',
            'tabRollCall',
            'tabReliability',
            'tabCapacity',
            'tabQuickLinks'
        ];

        // ==========================================
        // MASTER KEYBOARD NAVIGATION ENGINE
        // ==========================================
        const NAV_ORDER = ['btn-mailbox', 'btn-today', 'btn-projects', 'btn-team', 'btn-performance', 'btn-library'];



        /* ---------------------------------------------------------
            UNIVERSAL KEYBOARD SHORTCUTS
           Place this at the bottom of your <script> tag
        --------------------------------------------------------- */
        document.addEventListener('keydown', (e) => {
            // 1. INPUT GUARD: Stop if user is typing in a field
            const target = e.target;
            const isInput = target.tagName === 'INPUT' ||
                target.tagName === 'TEXTAREA' ||
                target.tagName === 'SELECT' ||
                target.isContentEditable;

            if (isInput) {
                // Exception: Allow ESC to blur/exit the input
                if (e.key === 'Escape') target.blur();
                return;
            }

            // Task Context Menu ESC handling
            const taskContextMenu = document.getElementById('taskContextMenu');
            if (taskContextMenu && !taskContextMenu.classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    e.stopPropagation();
                    hideTaskContextMenu();
                    return;
                }
            }

            // 2. SPECIAL OVERLAYS HANDLING (Priority 1)
            const cmdPalette = document.getElementById('commandPalette');
            if (cmdPalette && !cmdPalette.classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof toggleCommandPalette === 'function') toggleCommandPalette();
                    return;
                }
                return;
            }

            const shortcutsModal = document.getElementById('shortcutsModal');
            if (shortcutsModal && !shortcutsModal.classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof toggleShortcutsModal === 'function') toggleShortcutsModal(false);
                    return;
                }
                // ALLOW other shortcuts to pass through (so user can test them while viewing list)
            }

            // 3. MODAL HANDLING (Priority 2)
            const activeModal = document.querySelector('.modal:not(.opacity-0):not(.hidden):not(.pointer-events-none)');
            if (activeModal) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof closeProjectPlanner === 'function' && activeModal.id === 'projectPlannerModal') {
                        closeProjectPlanner();
                    } else if (typeof toggleModal === 'function') {
                        toggleModal(activeModal.id);
                    } else {
                        activeModal.classList.add('opacity-0', 'pointer-events-none');
                    }
                    return;
                }
                // Allow Alt + D (dark mode toggle) to work even when modals are open
                if (e.altKey && (e.key === 'd' || e.key === 'D' || e.key === '')) {
                    e.preventDefault();
                    if (typeof toggleDarkMode === 'function') toggleDarkMode();
                    return;
                }
                return;
            }

            // 3.5. BRAIN DUMP PANEL HANDLING
            const brainDumpPanel = document.getElementById('brain-dump-panel');
            if (brainDumpPanel && brainDumpPanel.classList.contains('open')) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof toggleBrainDumpPanel === 'function') toggleBrainDumpPanel();
                    return;
                }
            }

            // 4. SHORTCUTS

            // Alt + C: Quick Capture
            if (e.altKey && (e.key === 'c' || e.key === 'C')) {
                e.preventDefault();
                if (typeof toggleQuickCapture === 'function') toggleQuickCapture();
                return;
            }

            // Alt + N: Brain Dump
            if (e.altKey && (e.key === 'n' || e.key === 'N')) {
                e.preventDefault();
                if (typeof toggleBrainDumpPanel === 'function') toggleBrainDumpPanel();
                return;
            }

            // Alt + 1: ActionHub (Mailbox)
            if (e.altKey && e.key === '1') {
                e.preventDefault();
                if (typeof switchTool === 'function') switchTool('ActionHub');
                if (typeof switchTab === 'function') switchTab('mailbox');
                return;
            }

            // Alt + 2: PulseCheck
            if (e.altKey && e.key === '2') {
                e.preventDefault();
                if (typeof switchTool === 'function') switchTool('PulseCheck');
                return;
            }

            // Note: Alt + D (dark mode toggle) is handled by the first keyboard event listener
            // around line 14594-14601, and also works when modals are open (see modal handling above)

            // Note: [ and ] bracket key navigation is handled by the first keyboard event listener
            // around line 14619-14630, which calls navigateTab() function

            // Global Command Palette (Cmd/Ctrl + K)
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                if (typeof toggleCommandPalette === 'function') toggleCommandPalette();
                return;
            }

            // Shortcuts Help (?)
            if (e.key === '?' && !isInput) {
                e.preventDefault();
                if (typeof toggleShortcutsModal === 'function') toggleShortcutsModal(true);
                return;
            }
        });

        function triggerTaskCompletionConfetti(element) {
            // Get position of the clicked element (checkbox)
            const rect = element.getBoundingClientRect();

            // Calculate normalized coordinates (0 to 1) for the library
            const x = (rect.left + rect.width / 2) / window.innerWidth;
            const y = (rect.top + rect.height / 2) / window.innerHeight;

            // Fire!
            confetti({
                particleCount: 40,
                spread: 70,
                origin: { x: x, y: y },
                colors: ['#7c3aed', '#a78bfa', '#ddd6fe'], // Violet theme colors
                disableForReducedMotion: true,
                zIndex: 10000, // Ensure it sits on top of modals
                gravity: 1.2,
                scalar: 0.7, // Smaller particles look more "premium"
                drift: 0,
            });
        }

        // Initialize Brain Dump on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadBrainDumpContent);
        } else {
            loadBrainDumpContent();
        }

        // Task Context Menu Event Delegation
        document.addEventListener('contextmenu', function (e) {
            const taskCard = e.target.closest('.task-card-container');
            if (taskCard) {
                e.preventDefault();
                currentContextMenuTaskId = taskCard.dataset.id;

                const menu = document.getElementById('taskContextMenu');
                if (menu) {
                    // Show/hide Clear Returned Status option
                    const task = appData.myDesk.find(t => t.id === currentContextMenuTaskId);
                    const clearBtn = document.getElementById('menuClearReturned');
                    if (clearBtn) {
                        if (task && task.isReturned) {
                            clearBtn.classList.remove('hidden');
                        } else {
                            clearBtn.classList.add('hidden');
                        }
                    }

                    menu.classList.remove('hidden');
                    menu.style.display = 'block';

                    // Position the menu
                    const menuWidth = 192;
                    const menuHeight = 160;

                    let x = e.clientX;
                    let y = e.clientY;

                    // Keep menu within viewport
                    if (x + menuWidth > window.innerWidth) x -= menuWidth;
                    if (y + menuHeight > window.innerHeight) y -= menuHeight;

                    menu.style.left = x + 'px';
                    menu.style.top = y + 'px';
                }
            } else {
                hideTaskContextMenu();
            }
        });

        // Global click listener to hide menu
        document.addEventListener('click', function (e) {
            if (!e.target.closest('#taskContextMenu')) {
                hideTaskContextMenu();
            }
        });
    </script>
    <!-- Global Task Date Picker (Portal Strategy) -->
    <div id="global-task-date-popover"
        class="hidden fixed z-[99999] bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-2xl rounded-lg p-3 w-64 font-sans">
        <div class="flex justify-between items-center mb-3">
            <span class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Date Settings</span>
            <button type="button" id="global-range-toggle"
                class="text-[10px] text-violet-600 hover:underline font-medium">
                + Add Start Date
            </button>
        </div>

        <div class="flex flex-col gap-3">
            <div id="global-start-container" class="hidden">
                <label class="text-[11px] text-slate-500 font-medium mb-1 block">Start Date</label>
                <div class="relative">
                    <input type="text" id="global-start-input" readonly
                        onclick="openPremiumCalendar(event, 'global-start-input')" placeholder="Select date..."
                        class="w-full text-xs bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded p-1.5 pl-8 focus:border-violet-500 outline-none cursor-pointer text-slate-700 dark:text-slate-200 font-medium">
                    <svg class="w-3.5 h-3.5 text-slate-400 absolute left-2.5 top-1/2 -translate-y-1/2 pointer-events-none"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
            </div>

            <div>
                <label id="global-due-label" class="text-[11px] text-slate-500 font-medium mb-1 block">Due Date</label>
                <div class="relative">
                    <input type="text" id="global-due-input" readonly
                        onclick="openPremiumCalendar(event, 'global-due-input')" placeholder="Select date..."
                        class="w-full text-xs bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded p-1.5 pl-8 focus:border-violet-500 outline-none cursor-pointer text-slate-700 dark:text-slate-200 font-medium">
                    <svg class="w-3.5 h-3.5 text-slate-400 absolute left-2.5 top-1/2 -translate-y-1/2 pointer-events-none"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
            </div>
        </div>

        <div class="mt-3 pt-2 border-t border-slate-100 dark:border-slate-700 flex justify-end">
            <button type="button" id="global-save-btn"
                class="bg-violet-600 hover:bg-violet-700 text-white text-xs font-medium px-3 py-1.5 rounded transition-colors shadow-sm">
                Done
            </button>
        </div>

        <div class="fixed inset-0 z-[-1]" onclick="closeGlobalDatePicker()"></div>
    </div>

    <!-- Task Context Menu (Right Click) -->
    <div id="taskContextMenu"
        class="hidden fixed z-[100001] bg-white dark:bg-slate-800 shadow-xl rounded-lg border border-slate-200 dark:border-slate-700 py-1 w-48 font-sans">
        <div
            class="px-3 py-1.5 text-[10px] font-bold uppercase text-slate-400 tracking-wider border-b border-slate-100 dark:border-slate-700 mb-1">
            Snooze Task</div>
        <button onclick="snoozeTask(currentContextMenuTaskId, 'tomorrow')"
            class="w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2">
            <span class="text-base"></span> Tomorrow Morning
        </button>
        <button onclick="snoozeTask(currentContextMenuTaskId, '2days')"
            class="w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2">
            <span class="text-base"></span> In 2 Days
        </button>
        <button onclick="snoozeTask(currentContextMenuTaskId, 'monday')"
            class="w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2">
            <span class="text-base"></span> Next Monday
        </button>
        <button onclick="openCustomSnoozeModal(currentContextMenuTaskId)"
            class="w-full text-left px-4 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-2 border-t border-slate-100 dark:border-slate-700">
            <span class="text-base"></span> Custom Date...
        </button>
        <button id="menuClearReturned" onclick="dismissReturnedStatus(currentContextMenuTaskId); hideTaskContextMenu();"
            class="hidden w-full text-left px-4 py-2 text-sm text-violet-700 dark:text-violet-400 hover:bg-violet-50 dark:hover:bg-violet-900/20 border-t border-slate-100 dark:border-slate-700 flex items-center gap-2">
            <span class="text-base"></span> Clear Returned Status
        </button>
    </div>

    <!-- Premium Calendar Widget -->
    <div id="premiumCalendar"
        class="hidden fixed z-[100000] bg-white border border-slate-200 shadow-xl rounded-xl p-4 w-72 font-sans select-none">
        <!-- Content rendered by JS -->
    </div>
    <div id="shortcutsModal"
        class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-200"
            id="shortcutsContent">

            <div
                class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-violet-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                    Keyboard Shortcuts
                </h3>
                <button onclick="toggleShortcutsModal(false)"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
                    <span class="text-xs font-bold bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded">ESC</span>
                </button>
            </div>

            <div class="p-8 grid grid-cols-2 gap-x-12 gap-y-6">

                <div class="space-y-4">
                    <h4 class="text-xs font-bold uppercase text-slate-400 tracking-wider mb-3">Navigation</h4>

                    <div class="flex justify-between items-center group">
                        <span class="text-sm text-slate-600 dark:text-slate-300">Move Left / Right</span>
                        <div class="flex gap-1">
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">[</kbd>
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">]</kbd>
                        </div>
                    </div>

                    <div class="flex justify-between items-center group">
                        <span class="text-sm text-slate-600 dark:text-slate-300">Action Hub</span>
                        <div class="flex gap-1">
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">Alt</kbd>
                            <span class="text-slate-300">+</span>
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">1</kbd>
                        </div>
                    </div>

                    <div class="flex justify-between items-center group">
                        <span class="text-sm text-slate-600 dark:text-slate-300">Pulse Check</span>
                        <div class="flex gap-1">
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">Alt</kbd>
                            <span class="text-slate-300">+</span>
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">2</kbd>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="text-xs font-bold uppercase text-slate-400 tracking-wider mb-3">Actions</h4>

                    <div class="flex justify-between items-center group">
                        <span class="text-sm text-slate-600 dark:text-slate-300">Toggle Dark Mode</span>
                        <div class="flex gap-1">
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">Alt</kbd>
                            <span class="text-slate-300">+</span>
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">D</kbd>
                        </div>
                    </div>

                    <div class="flex justify-between items-center group">
                        <span class="text-sm text-slate-600 dark:text-slate-300">Global Command</span>
                        <div class="flex gap-1">
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">Cmd</kbd>
                            <span class="text-slate-300">+</span>
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">K</kbd>
                        </div>
                    </div>

                    <div class="flex justify-between items-center group">
                        <span class="text-sm text-slate-600 dark:text-slate-300">Close Modal</span>
                        <kbd
                            class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">Esc</kbd>
                    </div>

                    <div class="flex justify-between items-center group">
                        <span class="text-sm text-slate-600 dark:text-slate-300">Quick Capture</span>
                        <div class="flex gap-1">
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">Alt</kbd>
                            <span class="text-slate-300">+</span>
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">C</kbd>
                        </div>
                    </div>

                    <div class="flex justify-between items-center group">
                        <span class="text-sm text-slate-600 dark:text-slate-300">Brain Dump</span>
                        <div class="flex gap-1">
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">Alt</kbd>
                            <span class="text-slate-300">+</span>
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">N</kbd>
                        </div>
                    </div>

                    <div class="flex justify-between items-center group">
                        <span class="text-sm text-slate-600 dark:text-slate-300">Email Drafter</span>
                        <div class="flex gap-1">
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">Alt</kbd>
                            <span class="text-slate-300">+</span>
                            <kbd
                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded text-xs font-mono text-slate-500 dark:text-slate-400 group-hover:border-violet-400 transition-colors">E</kbd>
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="px-6 py-3 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-800 text-center">
                <span class="text-[10px] text-slate-400">Press <kbd class="font-mono font-bold text-slate-500">?</kbd>
                    anytime to view this list</span>
            </div>
        </div>
    </div>

    <!-- Client Sync Modal -->
    <div id="client-sync-modal" class="fixed inset-0 z-[120] hidden bg-slate-900/50 backdrop-blur-sm">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                <!-- Header -->
                <div class="px-8 py-6 border-b border-slate-200 flex-none">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="p-3 bg-slate-800 rounded-xl text-white">
                                <i data-lucide="share-2" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-extrabold text-slate-900 tracking-tight">Client Sync Generator</h2>
                                <p class="text-sm text-slate-500 font-medium mt-0.5">Generate performance executive statements</p>
                            </div>
                        </div>
                        <button onclick="closeClientSyncModal()" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-200 transition-colors">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-8">
                    <!-- Step 1: Configuration -->
                    <div id="client-sync-config" class="space-y-6">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6">
                            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i data-lucide="settings" class="w-5 h-5 text-blue-600"></i>
                                Configuration
                            </h3>
                            
                            <div class="space-y-4">
                                <!-- Member Selection with Fuzzy Search -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Select Member</label>
                                    <div class="relative">
                                        <input type="text" id="client-sync-member-search" placeholder="Type to search team members..."
                                            oninput="filterClientSyncMembers(this.value)"
                                            onfocus="showClientSyncMemberDropdown()"
                                            class="w-full p-3 rounded-lg border border-slate-300 bg-white text-slate-900 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <input type="hidden" id="client-sync-member-id">
                                        
                                        <!-- Dropdown Results -->
                                        <div id="client-sync-member-dropdown" class="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden">
                                            <div id="client-sync-member-list" class="py-2">
                                                <!-- Members populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Date Range -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-2">Start Month</label>
                                        <select id="client-sync-start-month"
                                            class="w-full p-3 rounded-lg border border-slate-300 bg-white text-slate-900 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Select start...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-2">End Month</label>
                                        <select id="client-sync-end-month"
                                            class="w-full p-3 rounded-lg border border-slate-300 bg-white text-slate-900 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Select end...</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Generate Button -->
                                <button onclick="generateClientSyncStatement()" 
                                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg flex items-center justify-center gap-2">
                                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                                    Generate Statement
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Executive Card Preview -->
                    <div id="client-sync-preview" class="hidden space-y-6">
                        <!-- Executive Card -->
                        <div id="client-sync-card" class="bg-white border-2 border-slate-200 rounded-2xl overflow-hidden shadow-xl">
                            <!-- Card Header -->
                            <div class="bg-gradient-to-r from-pink-600 via-purple-600 to-blue-600 px-8 py-6 text-white">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <h3 id="card-member-name" class="text-3xl font-black tracking-tight">Member Name</h3>
                                        <p id="card-member-role" class="text-lg font-medium mt-1 text-white/90">Role Title</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-bold text-white/80 uppercase tracking-wider">Performance Period</p>
                                        <p id="card-date-range" class="text-xl font-bold mt-1">Jan '26 - Jun '26</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body -->
                            <div id="card-metrics-container" class="p-8 space-y-6">
                                <!-- Metrics will be dynamically inserted here -->
                            </div>

                            <!-- Card Footer -->
                            <div class="bg-slate-50 px-8 py-4 border-t border-slate-200">
                                <p class="text-xs text-slate-500 text-center font-medium">Generated via DCX Performance Cloud</p>
                            </div>
                        </div>

                        <!-- Email Template Section -->
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <i data-lucide="mail" class="w-5 h-5 text-green-600"></i>
                                    Client Email Template
                                </h3>
                                <button onclick="copyEmailTemplate()" 
                                    class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white text-sm font-bold rounded-lg hover:bg-green-700 transition-all">
                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                    Copy to Clipboard
                                </button>
                            </div>
                            <div id="email-template-text" class="bg-white border border-green-200 rounded-lg p-4 text-sm text-slate-700 leading-relaxed font-mono whitespace-pre-wrap">
                                <!-- Email template will be inserted here -->
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-3">
                            <button onclick="showClientSyncConfig()" 
                                class="flex-1 bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                                Back
                            </button>
                            <button onclick="previewClientSyncCard()" 
                                class="flex-1 bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:from-cyan-700 hover:to-blue-700 transition-all shadow-lg flex items-center justify-center gap-2">
                                <i data-lucide="eye" class="w-5 h-5"></i>
                                Preview Snapshot
                            </button>
                            <button onclick="downloadClientSyncCard()" 
                                class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg flex items-center justify-center gap-2">
                                <i data-lucide="download" class="w-5 h-5"></i>
                                Download Image
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Sync Preview Modal (Full-Screen Lightbox) -->
    <div id="client-sync-preview-modal" class="fixed inset-0 z-[130] hidden bg-slate-900/90 backdrop-blur-sm" onclick="closeClientSyncPreview()">
        <div class="flex items-center justify-center min-h-screen p-8">
            <!-- Close Button -->
            <button onclick="closeClientSyncPreview()" class="fixed top-6 right-6 p-3 bg-white/10 hover:bg-white/20 rounded-full text-white backdrop-blur-md transition-all z-10">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <!-- Screenshot Instruction -->
            <div class="fixed top-6 left-6 bg-white/10 backdrop-blur-md rounded-lg px-4 py-2 text-white text-sm font-medium z-10">
                <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                <span class="hidden md:inline">Press <kbd class="px-2 py-1 bg-white/20 rounded text-xs font-bold">Ctrl+Shift+S</kbd> to screenshot</span>
                <span class="md:hidden">Tap and hold to screenshot</span>
            </div>
            
            <!-- Card Preview Container -->
            <div id="client-sync-preview-container" class="relative max-w-4xl w-full" onclick="event.stopPropagation()">
                <!-- Card will be cloned here -->
            </div>
        </div>
    </div>

</body>

</html>